{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13108566","self":"https://issues.apache.org/jira/rest/api/2/issue/13108566","key":"HDFS-12638","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341106","id":"12341106","name":"2.8.3","archived":false,"released":true,"releaseDate":"2017-12-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341257","id":"12341257","description":"2.7.5 release","name":"2.7.5","archived":false,"released":true,"releaseDate":"2017-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341434","id":"12341434","description":"3.1.0 release","name":"3.1.0","archived":false,"released":true,"releaseDate":"2018-04-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341705","id":"12341705","description":"2.10.0 release","name":"2.10.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341761","id":"12341761","description":"2.9.1 release","name":"2.9.1","archived":false,"released":true,"releaseDate":"2018-05-03"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12342129","id":"12342129","name":"3.0.1","archived":false,"released":true,"releaseDate":"2018-03-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-10-11T14:26:37.225+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Dec 05 01:04:48 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_3_*:*_4304756328_*|*_5_*:*_1_*:*_0_*|*_10002_*:*_2_*:*_73271987","customfield_12312321":null,"resolutiondate":"2017-12-01T03:36:12.183+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12638/watchers","watchCount":22,"isWatching":false},"created":"2017-10-11T11:29:04.066+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340353","id":"12340353","name":"2.8.2","archived":false,"released":true,"releaseDate":"2017-10-24"}],"issuelinks":[{"id":"12524499","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12524499","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13131533","key":"HDFS-13027","self":"https://issues.apache.org/jira/rest/api/2/issue/13131533","fields":{"summary":"Handle possible NPEs due to deleted blocks in race condition","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12521472","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12521472","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13122657","key":"HDFS-12884","self":"https://issues.apache.org/jira/rest/api/2/issue/13122657","fields":{"summary":"BlockUnderConstructionFeature.truncateBlock should be of type BlockInfo","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12517648","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12517648","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12741140","key":"HDFS-7056","self":"https://issues.apache.org/jira/rest/api/2/issue/12741140","fields":{"summary":"Snapshot support for truncate","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}},{"id":"12517647","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12517647","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12827534","key":"HDFS-8330","self":"https://issues.apache.org/jira/rest/api/2/issue/12827534","fields":{"summary":"BlockInfoContiguous in blocksMap can have null BlockCollection","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12521253","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12521253","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13122047","key":"HDFS-12880","self":"https://issues.apache.org/jira/rest/api/2/issue/13122047","fields":{"summary":"Disallow abandoned blocks in the BlocksMap","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}},{"id":"12519638","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12519638","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"inwardIssue":{"id":"12936554","key":"HDFS-9754","self":"https://issues.apache.org/jira/rest/api/2/issue/12936554","fields":{"summary":"Avoid unnecessary getBlockCollection calls in BlockManager","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/7","id":"7","description":"The sub-task of the issue","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21146&avatarType=issuetype","name":"Sub-task","subtask":true,"avatarId":21146}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-01-17T17:07:35.745+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12329603","id":"12329603","name":"hdfs"}],"timeoriginalestimate":null,"description":"Active NamNode exit due to NPE, I can confirm that the BlockCollection passed in when creating ReplicationWork is null, but I do not know why BlockCollection is null, By view history I found [HDFS-9754|https://issues.apache.org/jira/browse/HDFS-9754] remove judging  whether  BlockCollection is null.\r\n\r\nNN logs are as following:\r\n{code:java}\r\n2017-10-11 16:29:06,161 ERROR [ReplicationMonitor] org.apache.hadoop.hdfs.server.blockmanagement.BlockManager: ReplicationMonitor thread received Runtime exception.\r\njava.lang.NullPointerException\r\n        at org.apache.hadoop.hdfs.server.blockmanagement.ReplicationWork.chooseTargets(ReplicationWork.java:55)\r\n        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.computeReplicationWorkForBlocks(BlockManager.java:1532)\r\n        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.computeReplicationWork(BlockManager.java:1491)\r\n        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.computeDatanodeWork(BlockManager.java:3792)\r\n        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager$ReplicationMonitor.run(BlockManager.java:3744)\r\n        at java.lang.Thread.run(Thread.java:834)\r\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341106","id":"12341106","name":"2.8.3","archived":false,"released":true,"releaseDate":"2017-12-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341433","id":"12341433","description":"3.0.0 GA release","name":"3.0.0","archived":false,"released":true,"releaseDate":"2017-12-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341761","id":"12341761","description":"2.9.1 release","name":"2.9.1","archived":false,"released":true,"releaseDate":"2018-05-03"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12894874","id":"12894874","filename":"HDFS-12638.002.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-30T23:50:34.262+0000","size":1854,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12894874/HDFS-12638.002.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12900072","id":"12900072","filename":"HDFS-12638.003.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-30T19:52:43.701+0000","size":4683,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12900072/HDFS-12638.003.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12900129","id":"12900129","filename":"HDFS-12638.004.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-12-01T02:04:38.465+0000","size":4705,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12900129/HDFS-12638.004.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12892363","id":"12892363","filename":"HDFS-12638-branch-2.8.2.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-16T11:14:18.080+0000","size":2409,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12892363/HDFS-12638-branch-2.8.2.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12893515","id":"12893515","filename":"OphanBlocksAfterTruncateDelete.jpg","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-10-23T11:50:41.872+0000","size":91360,"mimeType":"image/jpeg","content":"https://issues.apache.org/jira/secure/attachment/12893515/OphanBlocksAfterTruncateDelete.jpg"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Delete copy-on-truncate block along with the original block, when deleting a file being truncated","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16200361","id":"16200361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"We have also seen blocks with \"null\" bc staying in the replication queue. They were missing blocks so the replication monitor didn't even try to schedule them and didn't crash. But metaSave was listing them as orphaned (bc == null, deleted).  Other than failing over (force queue reinitialization),there was no way to clear them.\r\n\r\nIn your particular case, we can add a null check in {{scheduleReplication()}} in addition to the existing deletion check.  The missing block case is a bit trickier, since the replication monitor will not touch them and nothing will move it to a different priority level since the block is already deleted and invalidated on datanodes.  We should prevent it from getting added to the queue.\r\n\r\nIn any case, it is apparent that the new {{isDeleted()}} check cannot replace the bc null check 100%.  [~jingzhao] any thoughts?\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2017-10-11T14:26:37.225+0000","updated":"2017-10-11T14:26:37.225+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16200469","id":"16200469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"[~yangjiandan] do you have any further info you can share?  Did this involve snapshots?  Do you know if the problematic block belonged to a deleted file, or a truncated file, abandoned block, etc?\r\n\r\nThis case case appears to mirror ours (except we didn't crash).  The block has a \"valid\" (not the sentinel no collection id) block collection id for an inode not in the inode map.  The block also isn't in the blocksmap.  These are big problems.\r\n\r\nEither the replication monitor is working with copies of stored blocks, or values are being cleared in the wrong order.  Delete tries to unlink the blocks from the collection before removing from the blocks map, then clears the collection's block list before removing from the inode map.  Thus there should never be a block referencing a missing collection...\r\n\r\nMoving the block's bc from a reference to an id is highly likely to have exposed latent bugs if copies of stored blocks are not re-resolved via the blocks map.  Having a reference hid logic issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-11T15:37:40.217+0000","updated":"2017-10-11T15:37:40.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16201343","id":"16201343","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"body":"[~daryn] There is no snapshot directory in cluster, and we could not find block info in the log, and there are logs of truncate cmd in auditlog. In active NN  WebUI there are 2000+ missing blocks, but fsck result do not include missing replicas. And crashed NN become standby successfully by restart.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-12T02:20:14.303+0000","updated":"2017-10-12T02:21:09.784+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16201413","id":"16201413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"body":"We found missing blockId by metasave, and did fsck -blockId, NN also throw NPE, and the inode to which the block blongs was truncated after created.\r\n\r\ncreate log:\r\n{code:java}\r\nhadoop-hadoop-namenode-**.log.9:2017-10-09 19:19:16,370 INFO [IPC Server handler 902 on 8020] org.apache.hadoop.hdfs.StateChange: BLOCK* allocate blk_1084203820_11907141, replicas=11.251.153.26:50010, 11.251.153.29:50010, 11.227.70.75:50010 for /user/admin/xxx\r\n{code}\r\nbecause auditlog was overrided,  we can not found operation about this file\r\nfsck -blockId log:\r\n{code:java}\r\n2017-10-12 11:22:03,929 WARN [502920422@qtp-1473771722-3789] org.apache.hadoop.hdfs.server.namenode.NameNode: Error in looking up block\r\njava.lang.NullPointerException\r\n        at org.apache.hadoop.hdfs.server.namenode.NamenodeFsck.blockIdCK(NamenodeFsck.java:259)\r\n        at org.apache.hadoop.hdfs.server.namenode.NamenodeFsck.fsck(NamenodeFsck.java:323)\r\n        at org.apache.hadoop.hdfs.server.namenode.FsckServlet$1.run(FsckServlet.java:69)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at javax.security.auth.Subject.doAs(Subject.java:422)\r\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1804)\r\n        at org.apache.hadoop.hdfs.server.namenode.FsckServlet.doGet(FsckServlet.java:58)\r\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:707)\r\n        at javax.servlet.http.HttpServlet.service(HttpServlet.java:820)\r\n        at org.mortbay.jetty.servlet.ServletHolder.handle(ServletHolder.java:511)\r\n        at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1221)\r\n        at org.apache.hadoop.http.HttpServer2$QuotingInputFilter.doFilter(HttpServer2.java:1351)\r\n        at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\r\n        at org.apache.hadoop.http.NoCacheFilter.doFilter(NoCacheFilter.java:45)\r\n        at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\r\n        at org.apache.hadoop.http.NoCacheFilter.doFilter(NoCacheFilter.java:45)\r\n        at org.mortbay.jetty.servlet.ServletHandler$CachedChain.doFilter(ServletHandler.java:1212)\r\n        at org.mortbay.jetty.servlet.ServletHandler.handle(ServletHandler.java:399)\r\n        at org.mortbay.jetty.security.SecurityHandler.handle(SecurityHandler.java:216)\r\n        at org.mortbay.jetty.servlet.SessionHandler.handle(SessionHandler.java:182)\r\n        at org.mortbay.jetty.handler.ContextHandler.handle(ContextHandler.java:767)\r\n        at org.mortbay.jetty.webapp.WebAppContext.handle(WebAppContext.java:450)\r\n        at org.mortbay.jetty.handler.ContextHandlerCollection.handle(ContextHandlerCollection.java:230)\r\n        at org.mortbay.jetty.handler.HandlerWrapper.handle(HandlerWrapper.java:152)\r\n        at org.mortbay.jetty.Server.handle(Server.java:326)\r\n        at org.mortbay.jetty.HttpConnection.handleRequest(HttpConnection.java:542)\r\n        at org.mortbay.jetty.HttpConnection$RequestHandler.headerComplete(HttpConnection.java:928)\r\n        at org.mortbay.jetty.HttpParser.parseNext(HttpParser.java:549)\r\n        at org.mortbay.jetty.HttpParser.parseAvailable(HttpParser.java:212)\r\n        at org.mortbay.jetty.HttpConnection.handle(HttpConnection.java:404)\r\n        at org.mortbay.io.nio.SelectChannelEndPoint.run(SelectChannelEndPoint.java:410)\r\n        at org.mortbay.thread.QueuedThreadPool$PoolThread.run(QueuedThreadPool.java:582)\r\n{code}\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-12T04:15:53.622+0000","updated":"2017-10-12T04:15:53.622+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16201540","id":"16201540","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"body":"datanode revover failed because new blocksize is Long.MAX\r\n{code:java}\r\n2017-10-09 19:19:17,054 INFO [org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$1@437346ab] org.apache.hadoop.hdfs.server.datanode.DataNode: NameNode at nn_hostname/xx.xxx.xx.xxx:8020 calls recoverBlock(BP-1721125339-xx.xxx.xx.xxx-1505883414013:blk_1084203820_11907141, targets=[DatanodeInfoWithStorage[xx.xxx.xx.aaa:50010,null,null], DatanodeInfoWithStorage[xx.xxx.xx.bbb:50010,null,null], DatanodeInfoWithStorage[xx.xxx.xx.ccc:50010,null,null]], newGenerationStamp=11907145, newBlock=blk_1084203824_11907145)\r\n2017-10-09 19:19:17,055 INFO [org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$1@437346ab] org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.FsDatasetImpl: initReplicaRecovery: blk_1084203820_11907141, recoveryId=11907145, replica=FinalizedReplica, blk_1084203820_11907141, FINALIZED\r\n  getNumBytes()     = 7\r\n  getBytesOnDisk()  = 7\r\n  getVisibleLength()= 7\r\n  getVolume()       = /dump/10/dfs/data/current\r\n  getBlockFile()    = /dump/10/dfs/data/current/BP-1721125339-xx.xxx.xx.xxx-1505883414013/current/finalized/subdir31/subdir3/blk_1084203820\r\n2017-10-09 19:19:17,055 INFO [org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$1@437346ab] org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.FsDatasetImpl: initReplicaRecovery: changing replica state for blk_1084203820_11907141 from FINALIZED to RUR\r\n2017-10-09 19:19:17,058 WARN [org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$1@437346ab] org.apache.hadoop.hdfs.server.protocol.InterDatanodeProtocol: Failed to updateBlock (newblock=BP-1721125339-xx.xxx.xx.xxx-1505883414013:blk_1084203824_11907145, datanode=DatanodeInfoWithStorage[xx.xxx.xx.aaa:50010,null,null])\r\norg.apache.hadoop.ipc.RemoteException(java.io.IOException): rur.getNumBytes() < newlength = 9223372036854775807, rur=ReplicaUnderRecovery, blk_1084203820_11907141, RUR\r\n  getNumBytes()     = 7\r\n  getBytesOnDisk()  = 7\r\n  getVisibleLength()= 7\r\n  getVolume()       = /dump/9/dfs/data/current\r\n  getBlockFile()    = /dump/9/dfs/data/current/BP-1721125339-xx.xxx.xx.xxx-1505883414013/current/finalized/subdir31/subdir3/blk_1084203820\r\n  recoveryId=11907145\r\n  original=FinalizedReplica, blk_1084203820_11907141, FINALIZED\r\n  getNumBytes()     = 7\r\n  getBytesOnDisk()  = 7\r\n  getVisibleLength()= 7\r\n  getVolume()       = /dump/9/dfs/data/current\r\n  getBlockFile()    = /dump/9/dfs/data/current/BP-1721125339-xx.xxx.xx.xxx-1505883414013/current/finalized/subdir31/subdir3/blk_1084203820\r\n        at org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.FsDatasetImpl.updateReplicaUnderRecovery(FsDatasetImpl.java:2736)\r\n        at org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.FsDatasetImpl.updateReplicaUnderRecovery(FsDatasetImpl.java:2678)\r\n        at org.apache.hadoop.hdfs.server.datanode.DataNode.updateReplicaUnderRecovery(DataNode.java:2776)\r\n        at org.apache.hadoop.hdfs.protocolPB.InterDatanodeProtocolServerSideTranslatorPB.updateReplicaUnderRecovery(InterDatanodeProtocolServerSideTranslatorPB.java:78)\r\n        at org.apache.hadoop.hdfs.protocol.proto.InterDatanodeProtocolProtos$InterDatanodeProtocolService$2.callBlockingMethod(InterDatanodeProtocolProtos.java:3107)\r\n        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:447)\r\n        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:989)\r\n        at org.apache.hadoop.ipc.Server$RpcCall.run(Server.java:846)\r\n        at org.apache.hadoop.ipc.Server$RpcCall.run(Server.java:789)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at javax.security.auth.Subject.doAs(Subject.java:422)\r\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1804)\r\n        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2457)\r\n\r\n\r\n        at org.apache.hadoop.ipc.Client.getRpcResponse(Client.java:1483)\r\n        at org.apache.hadoop.ipc.Client.call(Client.java:1429)\r\n        at org.apache.hadoop.ipc.Client.call(Client.java:1339)\r\n        at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:227)\r\n        at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:116)\r\n        at com.sun.proxy.$Proxy22.updateReplicaUnderRecovery(Unknown Source)\r\n        at org.apache.hadoop.hdfs.protocolPB.InterDatanodeProtocolTranslatorPB.updateReplicaUnderRecovery(InterDatanodeProtocolTranslatorPB.java:112)\r\n        at org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$BlockRecord.updateReplicaUnderRecovery(BlockRecoveryWorker.java:77)\r\n        at org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$BlockRecord.access$600(BlockRecoveryWorker.java:60)\r\n        at org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$RecoveryTaskContiguous.syncBlock(BlockRecoveryWorker.java:283)\r\n        at org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$RecoveryTaskContiguous.recover(BlockRecoveryWorker.java:175)\r\n        at org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$1.run(BlockRecoveryWorker.java:382)\r\n        at java.lang.Thread.run(Thread.java:834)\r\n....\r\n....\r\n....\r\n2017-10-09 19:19:17,060 WARN [org.apache.hadoop.hdfs.server.datanode.BlockRecoveryWorker$1@437346ab] org.apache.hadoop.hdfs.server.datanode.DataNode: recoverBlocks FAILED: RecoveringBlock{BP-1721125339-xx.xxx.xx.xxx-1505883414013:blk_1084203820_11907141; getBlockSize()=7; corrupt=false; offset=-1; locs=[DatanodeInfoWithStorage[xx.xxx.xx.aaa:50010,null,null], DatanodeInfoWithStorage[xx.xxx.xx.bbb:50010,null,null], DatanodeInfoWithStorage[xx.xxx.xx.ccc:50010,null,null]]}\r\njava.io.IOException: Cannot recover BP-1721125339-xx.xxx.xx.xxx-1505883414013:blk_1084203820_11907141, the following 3 data-nodes failed {\r\n  DatanodeInfoWithStorage[xx.xxx.xx.aaa:50010,null,null]\r\n  DatanodeInfoWithStorage[xx.xxx.xx.bbb:50010,null,null]\r\n  DatanodeInfoWithStorage[xx.xxx.xx.ccc:50010,null,null]\r\n}\r\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-12T07:02:16.235+0000","updated":"2017-10-13T09:48:40.338+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16202079","id":"16202079","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"This is bad.  The fsck NPE means the block _is_ in the blocks map but the inode/collection it references _is not_ in the blocks map.  Last I knew, a size of Long.MAX_VALUE means the block is scheduled for a \"fire and forget\" invalidation because the file was deleted.\r\n\r\nbq. and there are logs of truncate cmd in auditlog\r\n\r\nTo double check, did you mean \"are\" or \"are not\"?\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-12T15:08:09.893+0000","updated":"2017-10-12T15:08:09.893+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16202092","id":"16202092","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"It does differ from our case but likely has the same root cause.  The block was in your blocks map, but not in ours.  The block existed on your DN, but not ours.  The commonality is the block referenced a non-existent inode/collection.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-12T15:18:57.984+0000","updated":"2017-10-12T15:18:57.984+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16202357","id":"16202357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"The issues actually appear unrelated.  In our case, there was only 1 replica, that node died, the block was deleted.  The block got stuck in the replication monitor's missing block queue.  Kihwal is filing a jira with additional details.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-12T18:03:14.805+0000","updated":"2017-10-12T18:03:14.805+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16203022","id":"16203022","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"body":"[~daryn] NN audit log lost some, and we did not find truncate operation about this file, but I think this file was truncated by viewing DN logs. In DN log the block was first finallized then do recover.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-13T03:47:28.622+0000","updated":"2017-10-13T03:47:28.622+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16203501","id":"16203501","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"body":"I find  another block with the same problem,  and the auditlogs about the file to which the block blongs are as following.\r\n{code:java}\r\n2017-10-13 03:26:59,198 INFO FSNamesystem.audit: allowed=true   ugi=admin (auth:SIMPLE) ip=/xx.xxx.xx.xxx       cmd=create      src=/user/admin/xxxxxx        dst=null        perm=admin:hadoop:rw-r--r--     proto=rpc\r\n2017-10-13 03:26:59,290 INFO FSNamesystem.audit: allowed=true   ugi=admin (auth:SIMPLE) ip=/xx.xxx.xx.xxx       cmd=truncate    src=/user/admin/xxxxxx        dst=null        perm=admin:hadoop:rw-r--r--     proto=rpc\r\n2017-10-13 03:26:59,293 INFO FSNamesystem.audit: allowed=true   ugi=admin (auth:SIMPLE) ip=/xx.xxx.xx.xxx       cmd=delete      src=/user/admin/xxxxxx        dst=null        perm=null       proto=rpc\r\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-13T12:38:22.193+0000","updated":"2017-10-13T12:39:10.682+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16203577","id":"16203577","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"There's 2 likely scenarios:\r\n* The block is added to the blocks map with an unlinked inode not in the inode map.  The only way to add a block to the map is via {{BlockManager#addBlockCollection}}.  Truncate, like add block, does this but it should not have been able to resolve the inode if it's unlinked and I don't immediately see locking issues.\r\n* The lease manager encountered an error and removed the inode but left the blocks intact.  Look for log warn of \"Removing lease with an invalid path\" because the lease manager catches IOEs and just removes the inode anyway which can leave the blocks map in an inconsistent state.  Very bad.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-13T13:44:28.575+0000","updated":"2017-10-13T13:44:28.575+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16203585","id":"16203585","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"[~shv], you worked on truncate, any further insights?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-13T13:49:35.782+0000","updated":"2017-10-13T13:49:35.782+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16205739","id":"16205739","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"body":"Doing truncate & delete files when cluster is RollingUpgrade leads to orphans blocks. I add an ut in patch to reproduce the problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yangjiandan","name":"yangjiandan","key":"yangjiandan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=yangjiandan&avatarId=32648","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=yangjiandan&avatarId=32648","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=yangjiandan&avatarId=32648","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=yangjiandan&avatarId=32648"},"displayName":"Jiandan Yang ","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-16T11:10:34.943+0000","updated":"2017-10-16T11:15:06.186+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16205861","id":"16205861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~yangjiandan]\r\n\r\nThanks for narrowing down the root cause and providing a test case. I believe as long as the truncate runs as *copy-on-truncate* schema. e.g under rolling upgrade, upgrade not finalized or in snapshot, it will have this problem. This code path creates a new block for truncation and at same time the old block is left over in blocks map. When the file gets deleted, the old block becomes to be an orphan block.\r\n\r\nFurther, I read quite a few JIRAs similar to this problem. Such as HDFS-7611, HDFS-8113, HDFS-4867. It looks like what we deal with such blocks (if  it is reasonably be an orphan block) is to simply add a check to avoid NPE. For example in {{BlockManager#dumpBlockMeta}}\r\n\r\n{code}\r\nif (block instanceof BlockInfo) {\r\n      BlockCollection bc = getBlockCollection((BlockInfo)block);\r\n      String fileName = (bc == null) ? \"[orphaned]\" : bc.getName();\r\n      out.print(fileName + \": \");\r\n}\r\n{code}\r\n\r\nmost places already handled the case like this. So I would suggest to use a similar fix to resolve this issue. A few suggestions\r\n\r\n# Add a check in {{BlockManager#scheduleReplication}} to avoid NPE\r\n# Review the call in {{BlockManager#chooseExcessReplicates}}, most likely it needs a check too\r\n# Add a check in {{NamenodeFsck}} to fix the NPE when run {{fsck -blockId}} agaist an orphan block\r\n# Add a javadoc to remind {{BlockManager#getBlockCollection}} might return a null\r\n\r\nPlease let me know if this makes sense, [~yangjiandan], [~kihwal], [~daryn].\r\n\r\n\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-10-16T13:12:47.058+0000","updated":"2017-10-16T13:12:47.058+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16206786","id":"16206786","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue} 11m 47s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |\r\n|| || || || {color:brown} branch-2.8.2 Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  9m 10s{color} | {color:green} branch-2.8.2 passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 43s{color} | {color:green} branch-2.8.2 passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 23s{color} | {color:green} branch-2.8.2 passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 52s{color} | {color:green} branch-2.8.2 passed {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 57s{color} | {color:green} branch-2.8.2 passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 59s{color} | {color:green} branch-2.8.2 passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 43s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 41s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 41s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 18s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 49s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m  4s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 57s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red}665m 50s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:red}-1{color} | {color:red} asflicense {color} | {color:red} 15m 10s{color} | {color:red} The patch generated 154 ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}714m 10s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Failed junit tests | hadoop.hdfs.server.datanode.TestDataNodeInitStorage |\r\n|   | hadoop.hdfs.server.blockmanagement.TestNodeCount |\r\n|   | hadoop.hdfs.security.TestDelegationTokenForProxyUser |\r\n|   | hadoop.hdfs.server.datanode.TestDataNodeUUID |\r\n|   | hadoop.hdfs.server.datanode.fsdataset.TestAvailableSpaceVolumeChoosingPolicy |\r\n| Timed out junit tests | org.apache.hadoop.hdfs.server.datanode.TestHSync |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestLazyPersistPolicy |\r\n|   | org.apache.hadoop.hdfs.TestModTime |\r\n|   | org.apache.hadoop.hdfs.TestEncryptionZones |\r\n|   | org.apache.hadoop.hdfs.TestLeaseRecovery2 |\r\n|   | org.apache.hadoop.hdfs.TestSmallBlock |\r\n|   | org.apache.hadoop.hdfs.server.namenode.TestAllowFormat |\r\n|   | org.apache.hadoop.hdfs.tools.TestDFSAdminWithHA |\r\n|   | org.apache.hadoop.hdfs.TestDFSStartupVersions |\r\n|   | org.apache.hadoop.hdfs.TestHdfsAdmin |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeVolumeFailureReporting |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDeleteBlockPool |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestNNHandlesBlockReportPerStorage |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestHeartbeatHandling |\r\n|   | org.apache.hadoop.hdfs.TestFileCreationEmpty |\r\n|   | org.apache.hadoop.hdfs.TestFileCreationClient |\r\n|   | org.apache.hadoop.hdfs.tools.offlineImageViewer.TestOfflineImageViewer |\r\n|   | org.apache.hadoop.hdfs.tools.offlineEditsViewer.TestOfflineEditsViewer |\r\n|   | org.apache.hadoop.hdfs.qjournal.client.TestQuorumJournalManager |\r\n|   | org.apache.hadoop.hdfs.TestDatanodeRegistration |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeMetrics |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeHotSwapVolumes |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestNNHandlesCombinedBlockReport |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestBlockManager |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeRollingUpgrade |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestBlockHasMultipleReplicasOnSameDN |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestReplicationPolicy |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeExit |\r\n|   | org.apache.hadoop.hdfs.TestDFSClientFailover |\r\n|   | org.apache.hadoop.hdfs.TestMultiThreadedHflush |\r\n|   | org.apache.hadoop.hdfs.TestSetrepDecreasing |\r\n|   | org.apache.hadoop.hdfs.TestReservedRawPaths |\r\n|   | org.apache.hadoop.hdfs.TestSetrepIncreasing |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestBlockReplacement |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestReplicationPolicyWithUpgradeDomain |\r\n|   | org.apache.hadoop.hdfs.TestAclsEndToEnd |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestReadOnlySharedStorage |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestRefreshNamenodes |\r\n|   | org.apache.hadoop.hdfs.TestFileCreation |\r\n|   | org.apache.hadoop.hdfs.TestQuota |\r\n|   | org.apache.hadoop.hdfs.qjournal.server.TestJournalNode |\r\n|   | org.apache.hadoop.hdfs.server.namenode.TestNameNodeAcl |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestBlockRecovery |\r\n|   | org.apache.hadoop.hdfs.TestReplication |\r\n|   | org.apache.hadoop.hdfs.TestDataTransferKeepalive |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestLazyWriter |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeLifeline |\r\n|   | org.apache.hadoop.hdfs.TestDatanodeDeath |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestTriggerBlockReport |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestFsDatasetImpl |\r\n|   | org.apache.hadoop.hdfs.TestFileLengthOnClusterRestart |\r\n|   | org.apache.hadoop.hdfs.TestPread |\r\n|   | org.apache.hadoop.hdfs.TestFileAppend |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestLargeBlockReport |\r\n|   | org.apache.hadoop.hdfs.TestSafeMode |\r\n|   | org.apache.hadoop.hdfs.TestDFSClientRetries |\r\n|   | org.apache.hadoop.hdfs.TestBlockMissingException |\r\n|   | org.apache.hadoop.hdfs.TestDFSFinalize |\r\n|   | org.apache.hadoop.hdfs.TestDFSStorageStateRecovery |\r\n|   | org.apache.hadoop.hdfs.TestFileAppend4 |\r\n|   | org.apache.hadoop.hdfs.TestFileAppend3 |\r\n|   | org.apache.hadoop.hdfs.server.namenode.TestNameNodeRespectsBindHostKeys |\r\n|   | org.apache.hadoop.hdfs.TestFileAppend2 |\r\n|   | org.apache.hadoop.hdfs.TestRead |\r\n|   | org.apache.hadoop.hdfs.qjournal.client.TestQJMWithFaults |\r\n|   | org.apache.hadoop.hdfs.TestDFSUpgradeFromImage |\r\n|   | org.apache.hadoop.hdfs.TestRollingUpgradeDowngrade |\r\n|   | org.apache.hadoop.hdfs.TestHDFSFileSystemContract |\r\n|   | org.apache.hadoop.hdfs.TestInjectionForSimulatedStorage |\r\n|   | org.apache.hadoop.hdfs.TestDFSPermission |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestBatchIbr |\r\n|   | org.apache.hadoop.hdfs.TestDecommission |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeTransferSocketSize |\r\n|   | org.apache.hadoop.hdfs.TestReadWhileWriting |\r\n|   | org.apache.hadoop.hdfs.security.TestDelegationToken |\r\n|   | org.apache.hadoop.hdfs.TestFileAppendRestart |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestUnderReplicatedBlocks |\r\n|   | org.apache.hadoop.hdfs.TestFileCorruption |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestOverReplicatedBlocks |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestBlocksWithNotEnoughRacks |\r\n|   | org.apache.hadoop.hdfs.client.impl.TestBlockReaderLocal |\r\n|   | org.apache.hadoop.hdfs.TestCrcCorruption |\r\n|   | org.apache.hadoop.hdfs.TestFileCreationDelete |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestWriteToReplica |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestInterDatanodeProtocol |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestBlockStatsMXBean |\r\n|   | org.apache.hadoop.hdfs.protocol.datatransfer.sasl.TestSaslDataTransfer |\r\n|   | org.apache.hadoop.hdfs.TestEncryptionZonesWithKMS |\r\n|   | org.apache.hadoop.hdfs.TestDFSAddressConfig |\r\n|   | org.apache.hadoop.hdfs.web.TestWebHdfsWithRestCsrfPreventionFilter |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestPendingInvalidateBlock |\r\n|   | org.apache.hadoop.hdfs.qjournal.TestSecureNNWithQJM |\r\n|   | org.apache.hadoop.hdfs.TestLeaseRecovery |\r\n|   | org.apache.hadoop.hdfs.TestBlockStoragePolicy |\r\n|   | org.apache.hadoop.hdfs.TestRollingUpgrade |\r\n|   | org.apache.hadoop.hdfs.TestSeekBug |\r\n|   | org.apache.hadoop.hdfs.server.namenode.web.resources.TestWebHdfsDataLocality |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestComputeInvalidateWork |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestScrLazyPersistFiles |\r\n|   | org.apache.hadoop.hdfs.server.namenode.TestProcessCorruptBlocks |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestLazyPersistLockedMemory |\r\n|   | org.apache.hadoop.hdfs.TestLocalDFS |\r\n|   | org.apache.hadoop.hdfs.TestDFSOutputStream |\r\n|   | org.apache.hadoop.hdfs.TestHDFSServerPorts |\r\n|   | org.apache.hadoop.hdfs.TestLease |\r\n|   | org.apache.hadoop.hdfs.TestDFSInputStream |\r\n|   | org.apache.hadoop.hdfs.TestDFSUpgrade |\r\n|   | org.apache.hadoop.hdfs.server.namenode.TestMetaSave |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestLazyPersistFiles |\r\n|   | org.apache.hadoop.hdfs.qjournal.TestNNWithQJM |\r\n|   | org.apache.hadoop.hdfs.web.TestWebHDFS |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeMXBean |\r\n|   | org.apache.hadoop.hdfs.tools.TestGetGroups |\r\n|   | org.apache.hadoop.hdfs.tools.TestDFSHAAdminMiniCluster |\r\n|   | org.apache.hadoop.hdfs.tools.TestStoragePolicyCommands |\r\n|   | org.apache.hadoop.hdfs.web.TestWebHDFSXAttr |\r\n|   | org.apache.hadoop.hdfs.TestRollingUpgradeRollback |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeMultipleRegistrations |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDiskError |\r\n|   | org.apache.hadoop.hdfs.client.impl.TestBlockReaderFactory |\r\n|   | org.apache.hadoop.hdfs.TestRestartDFS |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestSpaceReservation |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeVolumeFailureToleration |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDnRespectsBlockReportSplitThreshold |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestIncrementalBrVariations |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestFsDatasetCache |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestRBWBlockInvalidation |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestReplicationPolicyWithNodeGroup |\r\n|   | org.apache.hadoop.hdfs.TestRenameWhileOpen |\r\n|   | org.apache.hadoop.hdfs.shortcircuit.TestShortCircuitCache |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeMetricsLogger |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestTransferRbw |\r\n|   | org.apache.hadoop.hdfs.TestFileConcurrentReader |\r\n|   | org.apache.hadoop.hdfs.TestExtendedAcls |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDirectoryScanner |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestPendingReplication |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestReplicationPolicyConsiderLoad |\r\n|   | org.apache.hadoop.hdfs.TestFSOutputSummer |\r\n|   | org.apache.hadoop.hdfs.shortcircuit.TestShortCircuitLocalRead |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestLazyPersistReplicaPlacement |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestFsDatasetCacheRevocation |\r\n|   | org.apache.hadoop.hdfs.TestTrashWithSecureEncryptionZones |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestLazyPersistReplicaRecovery |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeReconfiguration |\r\n|   | org.apache.hadoop.hdfs.TestDFSRollback |\r\n|   | org.apache.hadoop.hdfs.TestMiniDFSCluster |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestBlockScanner |\r\n|   | org.apache.hadoop.hdfs.tools.TestDFSZKFailoverController |\r\n|   | org.apache.hadoop.hdfs.TestDistributedFileSystem |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestSequentialBlockId |\r\n|   | org.apache.hadoop.hdfs.TestHFlush |\r\n|   | org.apache.hadoop.hdfs.web.TestWebHDFSForHA |\r\n|   | org.apache.hadoop.hdfs.TestClientReportBadBlock |\r\n|   | org.apache.hadoop.hdfs.TestDFSClientExcludedNodes |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestNameNodePrunesMissingStorages |\r\n|   | org.apache.hadoop.hdfs.TestSetTimes |\r\n|   | org.apache.hadoop.hdfs.TestDFSShell |\r\n|   | org.apache.hadoop.hdfs.server.namenode.TestHostsFiles |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestBlockTokenWithDFS |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestCachingStrategy |\r\n|   | org.apache.hadoop.hdfs.server.blockmanagement.TestBlockReportRateLimiting |\r\n|   | org.apache.hadoop.hdfs.tools.TestDebugAdmin |\r\n|   | org.apache.hadoop.hdfs.server.datanode.fsdataset.impl.TestDatanodeRestart |\r\n|   | org.apache.hadoop.hdfs.TestDFSRename |\r\n|   | org.apache.hadoop.hdfs.tools.TestDFSAdmin |\r\n|   | org.apache.hadoop.hdfs.TestGetBlocks |\r\n|   | org.apache.hadoop.hdfs.server.datanode.TestDataNodeVolumeFailure |\r\n|   | org.apache.hadoop.hdfs.TestGetFileChecksum |\r\n|   | org.apache.hadoop.hdfs.TestAbandonBlock |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker |  Image:yetus/hadoop:d0a0f24 |\r\n| JIRA Issue | HDFS-12638 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12892363/HDFS-12638-branch-2.8.2.001.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux 876f1d3b7499 3.13.0-123-generic #172-Ubuntu SMP Mon Jun 26 18:04:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/hadoop/patchprocess/precommit/personality/provided.sh |\r\n| git revision | branch-2.8.2 / bc74d06 |\r\n| Default Java | 1.7.0_151 |\r\n| findbugs | v3.0.0 |\r\n| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/21711/artifact/patchprocess/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/21711/testReport/ |\r\n| asflicense | https://builds.apache.org/job/PreCommit-HDFS-Build/21711/artifact/patchprocess/patch-asflicense-problems.txt |\r\n| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/21711/console |\r\n| Powered by | Apache Yetus 0.6.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-16T23:45:00.606+0000","updated":"2017-10-16T23:45:00.606+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16206911","id":"16206911","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Was looking at the unit test attached. [~yangjiandan] I don't think your test case captches the problem. At least not directly. You are asserting the number of blocks after you delete the file, but the block deletion is not immediate.\r\nProbably we should look for blocks with no refenerence to the inode.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-17T02:02:24.818+0000","updated":"2017-10-17T02:02:24.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16206921","id":"16206921","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~shv], the actual deletion of those blocks are running in async mode at background, but the blocks map {{BlocksMap}} is immediately updated. I think [~yangjiandan]'s UT explained how this orphan block was created, which eventually caused the failure in the JIRA's description. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-10-17T02:31:19.674+0000","updated":"2017-10-17T02:31:19.674+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16208104","id":"16208104","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Hey [~cheersyang], blocks deletion from {{BlocksMap}} is not immediate.\r\nIf I step through the test case in debugger giving enough time for deletion to complete, I do not hit the assert.\r\nSo I understand the problem that there are blocks in the {{BlocksMap}} that do not belong to any file, which we should not allow, but I don't see the unit test capturing this bug.\r\nWhich branch are you testing this with? I am looking on trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-17T18:32:32.144+0000","updated":"2017-10-17T18:32:32.144+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16209604","id":"16209604","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"[~cheersyang], maybe I'm misinterpreting the proposal but it sounds like you want to avoid the symptom (NPE) rather than address the orphaned block (root cause)?\r\n\r\nI haven't really studied the truncate code.  For \"copy-on-truncate\" it sounds reasonable for both blocks to be in the map.  But both should be referenced somewhere.  Presumably this is just for snapshots, which means one of the blocks is in a diff.  If delete misses one of the blocks, that's the root cause we must fix.  Be warned the block reclamation code is not a fun place.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-18T16:09:44.246+0000","updated":"2017-10-18T16:09:44.246+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16210498","id":"16210498","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~daryn]\r\n\r\nbq. it sounds like you want to avoid the symptom (NPE) \r\n\r\nYes, I think our code should bear with such orphan blocks, instead of failing the NN with NPE like this. At least.\r\n\r\nbq. rather than address the orphaned block (root cause)?\r\n\r\nThe test case explains how these orphaned blocks come from\r\n\r\n||Step#||Step Operation||Explain||\r\n|1|Create a file| this creates a few blocks, e.g B1|\r\n|2|Run rolling upgrade (or create a snapshot)|this is the condition to trigger the copy-on-truncate behavior|\r\n|3|Truncate the file to a smaller size|\"copy-on-truncate\" schema is used, it creates a new block B2 and copy required bytes from B1 to B2, and inode reference updated to B2|\r\n|4|Delete this file|this will delete inode ref and remove B2 from blocks map, leaving B1 behind. So when we read snapshot again, it is able to find its original block B1.|\r\n\r\nPlease see also {{FSDirTtruncateOp#shouldCopyOnTruncate}}. I have read the truncate design doc, this seems to be the designed behavior. We cannot delete the old block otherwise snapshot won't be able to read it anymore. I assume when the snapshot gets deleted, these blocks will be also removed from the blocks map. But before that, we need to live with such orphaned blocks. Any thoughts on this?\r\n\r\nThanks\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-10-19T02:40:08.080+0000","updated":"2017-10-19T02:40:08.080+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16211413","id":"16211413","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"bq. Yes, I think our code should bear with such orphan blocks, instead of failing the NN with NPE like this. At least.\r\nSee below, they aren't really orphaned.  I think it's correct for the NN to crash if the namesystem data structures are corrupted.\r\n\r\nbq. I assume when the snapshot gets deleted, these blocks will be also removed from the blocks map. But before that, we need to live with such orphaned blocks\r\nTo the block manager, replication monitor, etc these copy-on-truncate blocks are not (supposed to be) special.  My prior point stated another way is the block is not orphaned if it's in a snapshot diff.  INodes are not orphaned when only referenced via a snapshot diff.  A block in the blocks map should not be referencing an inode not in the inodes map.  Direct namespace accessibility is irrelevant to the block/inode/map linkages being correct.\r\n\r\nWe need to fix the bug, not mask it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-19T17:42:42.620+0000","updated":"2017-10-19T17:42:42.620+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16214120","id":"16214120","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"It looks to me that the main problem here is that {{unprotectedDelete()}} while collecting blocks in {{INodeFile.destroyAndCollectBlocks()}} invalidates block collection {{bcid}}, but leaves the block in the {{BlocksMap}}. Then {{FSNamesystem.delete()}} releases the lock and reacquires it again for actual block removal in {{FSNamesystem.removeBlocks()}}. So if {{ReplicationMonitor}} or {{NamenodeFsck}} kick in after the lock is released, but before the blocks are deleted from {{BlocksMap}} they can hit NPE accessing invalid (id = -1) INode.\r\nIncremental block deletion was introduced in HDFS-6618, so all major versions should be affected.\r\n\r\nFor fixing this we should not invalidate {{bcid}} in {{NodeFile.destroyAndCollectBlocks()}}, but rather in {{BlockManager.removeBlockFromMap()}}, when the block is actually removed from {{BlocksMap}}.\r\nI agree with [~daryn] we should fix the bug (invalid blocks in the map), rather than mitigate its consequences (NPE).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-21T22:46:24.319+0000","updated":"2017-10-21T22:49:11.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16215008","id":"16215008","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~shv]\r\n\r\nI don't think what you suggested could fix this. Please see attachment [^OphanBlocksAfterTruncateDelete.jpg]. We are hinting the NPE because inode is removed but the block {{blk_1073741825}} was left over (created during copy-on-truncate), then if we look for INode by the block bcID {{16387}}, we get a {{null}}. What you suggested seems still be operating on deleted block {{blk_1073741826}}, I tried and it did not resolve this problem. Please take a look and let me know if I have any place wrong. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-10-23T11:57:20.170+0000","updated":"2017-10-23T11:57:20.170+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16217402","id":"16217402","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"Might want to investigate the lifecycle handling of {{BlockUnderConstructionFeature#truncateBlock}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-10-24T18:25:21.288+0000","updated":"2017-10-24T18:25:21.288+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16226012","id":"16226012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"You are right we are not collecting the copy-on-truncate blocks when we delete files. And therefore they keep hanging in the BlocksMap. Here is a preliminary patch, which should address the problem. LMK if it does.\r\n\r\nThe problem I was describing earlier still exists though. Don't know why nobody hit it yet. Should we fix it here or in a separate jira?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-30T23:58:28.214+0000","updated":"2017-10-30T23:58:28.214+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16226111","id":"16226111","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~shv]\r\n\r\nThanks for the new patch. One question though, in snapshot case,  the copy-on-truncate blocks are referred by the snapshot taken before the delete happens. If you remove these blocks during deleting the file, will read the snapshot fail?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-10-31T01:57:19.757+0000","updated":"2017-10-31T01:57:19.757+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16245134","id":"16245134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"[~wweic] {{addDeleteBlock()}} is supposed to be called, when the block is really intended to be deleted, that is it is not contained in any snapshots. I checked the code, there is a lot of logic around detecting which blocks belong or not to a snapshot, see e.g. {{INodeFile.collectBlocksBeyondSnapshot()}}. This makes it safe to delete the {{truncateBlock}}. Unless you have a test case as a counterexample. \r\n\r\nDid some digging and now understand why we don't see this in 2.7.4. The following line was introduced into {{addDeleteBlock()}} by HDFS-9754:\r\n{code}\r\n       assert toDelete != null : \"toDelete is null\";\r\n+      toDelete.delete();\r\n       toDeleteList.add(toDelete);\r\n{code}\r\nwhich sets {{Block.bcId = INVALID_INODE_ID}}. I think this was the wrong place to invalidate bcId, as [I mensioned earlier|https://issues.apache.org/jira/browse/HDFS-12638?focusedCommentId=16214120&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16214120].\r\n[~jingzhao] could you please take a look.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-09T02:51:27.535+0000","updated":"2017-11-09T02:51:27.535+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16245161","id":"16245161","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~shv]\r\n\r\nThanks, I see your point. I have increased the priority of this bug to critical, as it has a big risk to crash NN in a production cluster, with DN rolling update or creating some snapshots, this issue can be easily triggered. [~jingzhao], please share your thoughts on this. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cheersyang","name":"cheersyang","key":"cheersyang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cheersyang&avatarId=23772","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cheersyang&avatarId=23772","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cheersyang&avatarId=23772","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cheersyang&avatarId=23772"},"displayName":"Weiwei Yang","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-09T03:43:02.001+0000","updated":"2017-11-09T03:43:02.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16256293","id":"16256293","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"I think it's a blocker for all branches 2.8 and up. Even just removing that line {{toDelete.delete();}} would prevent crashing NameNode.\r\nOr reverting HDFS-9754 should also help.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-17T01:34:20.746+0000","updated":"2017-11-21T02:09:38.528+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16263522","id":"16263522","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"body":"[~jingzhao] and [~szetszwo], any comments on Konstantin's proposal above?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-22T23:04:45.929+0000","updated":"2017-11-22T23:04:45.929+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16263553","id":"16263553","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"body":"Since this is about NameNode failed by NullPointerException, I agree that it is a blocker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-22T23:35:49.991+0000","updated":"2017-11-22T23:35:49.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16263561","id":"16263561","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"I looked more closely through the changes introduced in HDFS-9754. It looks like a major refactoring with a goal which seems like a minor optimization, and with no test coverage. The main problem is that it violated the key invariant, which is mentioned in the [first comment|https://issues.apache.org/jira/browse/HDFS-9754?focusedCommentId=15131492&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15131492] of that jira, stating\r\n* *A block is always associated with a file when added to {{BlocksMap}}*\r\n\r\nI propose to revert HDFS-9754. I think the invariant is important and should be preserved.\r\nReverting is not trivial, since more refactoring accumulated on top of it, but possible.\r\n\r\nThe patch I posted here is still needed since we should remove the extra block in truncate case. It is not as critical though, since this is not the cause of NPE and the truncate block is eventually deleted, when DN finishes truncate or on the next block report. So to resolve this blocker for upcoming releases (2.8, 2.9, 3.0) we need to complete the revert.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-22T23:38:40.791+0000","updated":"2017-11-22T23:38:40.791+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16263649","id":"16263649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"body":"Should be a blocker for 2.9.1 and 3.0.0 as well. Add them into target version for tracking.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-23T01:22:35.405+0000","updated":"2017-11-23T01:22:35.405+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16269808","id":"16269808","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"body":"Ping... [~szetszwo] and [~jingzhao], do you agree with [~shv]'s proposal above that to revert HDFS-9754? Or you have some other proposal here? 2.8.3 release is pending on this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-11-29T00:25:54.379+0000","updated":"2017-11-29T00:25:54.379+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16272083","id":"16272083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"body":"I investigated this further and think that Konstantin's v002 patch should actually solve the problem. Actually, HDFS-9754 does not change the invariant that [~shv] mentioned. A few notes from the investigation:\r\n* After incremental block deletion was added, it was already true that a block which was not associated with a valid INode could be present in the blocksMap. In {{FSNamesystem#delete()}}, we first call {{FSDirDeleteOp#delete()}} within the write lock. Then release the write lock, then call {{BlockManager#removeBlock()}} (will remove the block from blocksMap) on each block later on. Within {{FSDirDeleteOp#delete()}}, all INodes being deleted are removed from the inodesMap (see {{FSDirDeleteOp#deleteInternal()}} which calls {{FSNamesystem#removeLeasesAndINodes()}}). \r\n* This scenario meant that places e.g. {{BlockManager#scheduleReconstruction()}} had to check if there was a BlockCollection associated with the block, which it previously did by checking {{FSNamesystem#getBlockCollection(blkInfo.getBlockCollectionId()) != null}}. Now, HDFS-9754 replaced this call with {{BlockInfo#isDeleted()}}, so this means whenever we remove an INode from the inodesMap, we need to call {{BlockInfo#delete()}} to indicate that it does not have a valid BlockCollection associated with it (this is currently done within {{INodeFile#clearFile()}}, called by {{INode#destroyAndCollectBlocks()}}, called by {{FSDirDeleteOp#unprotectedDelete()}}).\r\n* When HDFS-9754 was added, it did not properly mark copy-on-truncate blocks with {{BlockInfo#delete()}}, so the {{BlockInfo#isDeleted()}} check would fail, thus causing {{BlockManager#secheduleReconstruction()}} to throw NPE when it tries to use {{FSNamesystem#getBlockCollection(blkInfo)}} (since it assumes there is a valid block collection associated).\r\n* Konstantin's patch correctly invalidates copy-on-truncate blocks, so should fix this NPE, at least for the case of copy-on-truncate blocks.\r\n\r\nSo +1 from me (non-binding) on the logic of the v002 patch. We should also try to get some unit test in for this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-30T02:57:35.704+0000","updated":"2017-11-30T02:57:35.704+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16273296","id":"16273296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"We digged with Erik through a lot of code and history. I agree that 002 patch fixes the problem without reverting HDFS-9754. The culprit that caused the NPE is this change from HDFS-9754:\r\n{code}\r\n-    BlockCollection bc = getBlockCollection(block);\r\n-    if (bc == null\r\n-        || (bc.isUnderConstruction() && block.equals(bc.getLastBlock()))) {\r\n+    // skip abandoned block or block reopened for append\r\n+    if (block.isDeleted() || !block.isCompleteOrCommitted()) {\r\n{code}\r\nSince truncateBlock is not marked as deleted {{validateReconstructionWork()}} does not return inside if, but rather proceeds. It then hits the NPE as block collections is null since the corresponding INode was deleted.\r\n\r\nI am attaching new patch, which combines 002, and slightly modified test case from [~yangjiandan]'s 001 patch.\r\nPlease review.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-30T19:55:56.836+0000","updated":"2017-11-30T19:57:30.982+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16273614","id":"16273614","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Filed HDFS-12880 to restore the BlocksMap invariant.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-30T22:56:21.739+0000","updated":"2017-11-30T22:56:21.739+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16273621","id":"16273621","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhz","name":"zhz","key":"zhz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zhz&avatarId=20493","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zhz&avatarId=20493","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zhz&avatarId=20493","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zhz&avatarId=20493"},"displayName":"Zhe Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~shv]. +1 on the v3 patch (pretty clear fix to remove orphan copy-on-truncate block). Two minor comments:\r\n\r\n# Shouldn't {{BlockUnderConstructionFeature#truncateBlock}} be a {{BlockInfo}}? All its value assignments are from a BI. If you agree, I'm OK with addressing this in a separate JIRA.\r\n# The title doesn't really reflect the fix (I imagine ReplicationMonitor crashing is only one of the symptoms). Could you update it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhz","name":"zhz","key":"zhz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=zhz&avatarId=20493","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=zhz&avatarId=20493","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=zhz&avatarId=20493","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=zhz&avatarId=20493"},"displayName":"Zhe Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-11-30T23:00:21.833+0000","updated":"2017-11-30T23:00:21.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16273631","id":"16273631","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 20s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 14m 55s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 48s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 36s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 57s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 47s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 40s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 51s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 52s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 45s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 45s{color} | {color:green} the patch passed {color} |\r\n| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 32s{color} | {color:orange} hadoop-hdfs-project/hadoop-hdfs: The patch generated 2 new + 64 unchanged - 0 fixed = 66 total (was 64) {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 51s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m  9s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 45s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 47s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red}142m 50s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 18s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}189m 36s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Failed junit tests | hadoop.hdfs.server.blockmanagement.TestBlockTokenWithDFSStriped |\r\n|   | hadoop.hdfs.server.datanode.TestDataNodeVolumeFailure |\r\n|   | hadoop.hdfs.web.TestWebHdfsTimeouts |\r\n|   | hadoop.hdfs.server.blockmanagement.TestUnderReplicatedBlocks |\r\n|   | hadoop.hdfs.server.namenode.TestCheckpoint |\r\n|   | hadoop.hdfs.TestDFSStripedOutputStreamWithFailure |\r\n|   | hadoop.hdfs.server.datanode.TestDataNodeVolumeFailureReporting |\r\n|   | hadoop.hdfs.server.datanode.TestDataNodeUUID |\r\n|   | hadoop.hdfs.server.balancer.TestBalancerRPCDelay |\r\n|   | hadoop.hdfs.server.blockmanagement.TestReconstructStripedBlocksWithRackAwareness |\r\n|   | hadoop.hdfs.server.namenode.ha.TestBootstrapStandby |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:5b98639 |\r\n| JIRA Issue | HDFS-12638 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12900072/HDFS-12638.003.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux ab241a5c43d4 4.4.0-64-generic #85-Ubuntu SMP Mon Feb 20 11:50:30 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / 5cfaee2 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_151 |\r\n| findbugs | v3.1.0-RC1 |\r\n| checkstyle | https://builds.apache.org/job/PreCommit-HDFS-Build/22237/artifact/out/diff-checkstyle-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/22237/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/22237/testReport/ |\r\n| Max. process+thread count | 3448 (vs. ulimit of 5000) |\r\n| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/22237/console |\r\n| Powered by | Apache Yetus 0.7.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-30T23:10:37.616+0000","updated":"2017-11-30T23:10:37.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16273823","id":"16273823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the review, [~zhz]. I totally agree that truncateBlock should be BlockInfo rather than as currently Block. Intended to file a jira to change that.\r\nWill update the title.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-12-01T02:04:26.256+0000","updated":"2017-12-01T02:04:26.256+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16273824","id":"16273824","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Patch 004 adds only braces to 'if' statement per checkstyle warning. Won't bother waiting for another Jenkins run.\r\nAlso verified that all failed tests pass locally, except {{TestDataNodeVolumeFailureReporting}}, which is tracked in a series of jiras.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-12-01T02:07:54.411+0000","updated":"2017-12-01T02:15:31.282+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16273879","id":"16273879","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Just committed this into the following branches:\r\n{code}\r\n   3c57def..7998077  branch-2 -> branch-2\r\n   7252e18..85eb32b  branch-2.7 -> branch-2.7\r\n   eacccf1..19c18f7  branch-2.8 -> branch-2.8\r\n   5a8a1e6..0f5ec01  branch-2.9 -> branch-2.9\r\n   58d849b..def87db  branch-3.0 -> branch-3.0\r\n   a63d19d..60fd0d7  trunk -> trunk\r\n{code}\r\nThank you everybody for contributing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-12-01T03:36:12.350+0000","updated":"2017-12-01T03:36:12.350+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16273887","id":"16273887","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Jenkins build Hadoop-trunk-Commit #13302 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/13302/])\nHDFS-12638. Delete copy-on-truncate block along with the original block, (shv: rev 60fd0d7fd73198fd610e59d1a4cd007c5fcc7205)\n* (edit) hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestFileTruncate.java\n* (edit) hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/INode.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-01T03:43:48.736+0000","updated":"2017-12-01T03:43:48.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13108566/comment/16277838","id":"16277838","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"body":"Merge to branch-2.8.3 as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djp","name":"djp","key":"djp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=djp&avatarId=16954","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=djp&avatarId=16954","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=djp&avatarId=16954","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=djp&avatarId=16954"},"displayName":"Junping Du","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-12-05T01:04:48.647+0000","updated":"2017-12-05T01:04:48.647+0000"}],"maxResults":44,"total":44,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12638/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3l4nz:"}}