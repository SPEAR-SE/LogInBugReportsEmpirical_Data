{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13009019","self":"https://issues.apache.org/jira/rest/api/2/issue/13009019","key":"HDFS-10942","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2016-09-30 23:23:55.768","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-10942/watchers","watchCount":4,"isWatching":false},"created":"2016-09-30T23:23:55.768+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-09-30T23:46:18.388+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12329603","id":"12329603","name":"hdfs"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12330947","id":"12330947","name":"s"}],"timeoriginalestimate":null,"description":"We use EditsDoubleBuffer to handle edit logs:\n{code}\n/**\n * A double-buffer for edits. New edits are written into the first buffer\n * while the second is available to be flushed. Each time the double-buffer\n * is flushed, the two internal buffers are swapped. This allows edits\n * to progress concurrently to flushes without allocating new buffers each\n * time.\n */\n{code}\n\nWith the following code, that flush the ready buffer, it copy the ready buffer to a local copy, then flush.\n\n{code}\n\nQuarumOutputStream (buf in the code below is an instance of EditsDoubleBuffer):\n\n  @Override\n  protected void flushAndSync(boolean durable) throws IOException {\n    int numReadyBytes = buf.countReadyBytes();\n    if (numReadyBytes > 0) {\n      int numReadyTxns = buf.countReadyTxns();\n      long firstTxToFlush = buf.getFirstReadyTxId();\n\n      assert numReadyTxns > 0;\n\n      // Copy from our double-buffer into a new byte array. This is for\n      // two reasons:\n      // 1) The IPC code has no way of specifying to send only a slice of\n      //    a larger array.\n      // 2) because the calls to the underlying nodes are asynchronous, we\n      //    need a defensive copy to avoid accidentally mutating the buffer\n      //    before it is sent.\n      DataOutputBuffer bufToSend = new DataOutputBuffer(numReadyBytes);\n      buf.flushTo(bufToSend);\n      assert bufToSend.getLength() == numReadyBytes;\n      byte[] data = bufToSend.getData();\n      assert data.length == bufToSend.getLength();\n{code}\n\n The above call doesn't seem to prevent the orginal copy of the buffer inside buf from being swapped by  the following method. \n\n{code}\nEditsDoubleBuffer:\n\n public void setReadyToFlush() {\n    assert isFlushed() : \"previous data not flushed yet\";\n    TxnBuffer tmp = bufReady;\n    bufReady = bufCurrent;\n    bufCurrent = tmp;\n  }\n\n{code}\n\nThough we have some runtime assertion in the code, the assertion is not enabled in production, so the expected condition in the assert may be false at runtime. This would possibly cause a mess.  When any condition is not as expected by the assertion, it seems a real exception should be thrown instead.\n\nSo two issues in summary:\n- How we synchronize between the flush and the swap of the two buffers\n- Whether we should throw real exception instead of the assert that's disabled at runtime normally.\n\nA possible third issue:\n* If NN crashes for some reason, before the edits in bufCurrent gets to bufReady and flushed, these edits in will be lost. \n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Incorrect handling of flushing edit logs to JN","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-10942/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i34brz:"}}