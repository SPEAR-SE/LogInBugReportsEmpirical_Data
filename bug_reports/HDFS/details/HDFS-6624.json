{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12725124","self":"https://issues.apache.org/jira/rest/api/2/issue/12725124","key":"HDFS-6624","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-07-03T08:25:41.956+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 30 04:38:55 UTC 2015","customfield_12310420":"403307","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6624/watchers","watchCount":3,"isWatching":false},"created":"2014-07-02T22:57:42.815+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335732","id":"12335732","description":"3.0.0-alpha1 release","name":"3.0.0-alpha1","archived":false,"released":true,"releaseDate":"2016-09-03"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-01-06T22:06:20.214+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"On a recent test-patch.sh run, saw this error which did not repro locally:\n\n{noformat}\nError Message\n\nRebalancing expected avg utilization to become 0.2, but on datanode 127.0.0.1:57889 it remains at 0.08 after more than 40000 msec.\nStacktrace\n\njava.util.concurrent.TimeoutException: Rebalancing expected avg utilization to become 0.2, but on datanode 127.0.0.1:57889 it remains at 0.08 after more than 40000 msec.\n\tat org.apache.hadoop.hdfs.server.balancer.TestBalancer.waitForBalancer(TestBalancer.java:284)\n\tat org.apache.hadoop.hdfs.server.balancer.TestBalancer.runBalancer(TestBalancer.java:382)\n\tat org.apache.hadoop.hdfs.server.balancer.TestBalancer.doTest(TestBalancer.java:359)\n\tat org.apache.hadoop.hdfs.server.balancer.TestBalancer.oneNodeTest(TestBalancer.java:403)\n\tat org.apache.hadoop.hdfs.server.balancer.TestBalancer.integrationTest(TestBalancer.java:416)\n\tat org.apache.hadoop.hdfs.server.blockmanagement.TestBlockTokenWithDFS.testEnd2End(TestBlockTokenWithDFS.java:588)\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12653713","id":"12653713","filename":"PreCommit-HDFS-Build #7274 test - testEnd2End [Jenkins].html","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-02T22:59:42.878+0000","size":147961,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12653713/PreCommit-HDFS-Build+%237274+test+-+testEnd2End+%5BJenkins%5D.html"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"403359","customfield_12312823":null,"summary":"TestBlockTokenWithDFS#testEnd2End fails sometimes","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725124/comment/14050834","id":"14050834","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"Attaching the html from the jenkins run, which has the complete log","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-02T22:59:42.888+0000","updated":"2014-07-02T22:59:42.888+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725124/comment/14051183","id":"14051183","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xieliang007","name":"xieliang007","key":"xieliang007","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10434","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10434","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10434","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10434"},"displayName":"Liang Xie","active":true,"timeZone":"Asia/Shanghai"},"body":"It should be related with the chooseExcessReplicates behavior.\nFrom log:\n{code}\n2014-07-02 21:23:30,083 INFO  balancer.Balancer (Balancer.java:logNodes(969)) - 0 over-utilized: []\n2014-07-02 21:23:30,083 INFO  balancer.Balancer (Balancer.java:logNodes(969)) - 1 above-average: [Source[127.0.0.1:55922, utilization=28.0]]\n2014-07-02 21:23:30,083 INFO  balancer.Balancer (Balancer.java:logNodes(969)) - 1 below-average: [BalancerDatanode[127.0.0.1:57889, utilization=16.0]]\n2014-07-02 21:23:30,083 INFO  balancer.Balancer (Balancer.java:logNodes(969)) - 0 underutilized: []\nThe cluster is balanced. Exiting...\n{code}\nand \n{code}\n2014-07-02 21:23:35,413 INFO  hdfs.TestBalancer (TestBalancer.java:runBalancer(381)) - Rebalancing with default ctor.    <--- will call waitForBalancer immediately then.\n{code}\nwe can know that before it should be balanced already. because avgUtilization=0.2, so 0.28 - 0.2 < BALANCE_ALLOWED_VARIANCE which is 0.11, | 0.16 - 0.2 | < BALANCE_ALLOWED_VARIANCE.\nbut once gone to waitForBalancer, even retry getting a new DN report many times, the new added DN had a small nodeUtilization:0.08, since |0.08 - 02| > 0.11, so after retry then timeout then failed...\n\nFrom those log we know that node removed a couple of blocks after balancing:\n{code}\n2014-07-02 21:23:30,136 INFO  BlockStateChange (BlockManager.java:addToInvalidates(1074)) - BLOCK* addToInvalidates: blk_1073741840_1016 127.0.0.1:55922 127.0.0.1:57889 \n2014-07-02 21:23:30,136 INFO  BlockStateChange (BlockManager.java:addToInvalidates(1074)) - BLOCK* addToInvalidates: blk_1073741841_1017 127.0.0.1:57889 \n2014-07-02 21:23:30,136 INFO  BlockStateChange (BlockManager.java:addToInvalidates(1074)) - BLOCK* addToInvalidates: blk_1073741842_1018 127.0.0.1:57889 \n2014-07-02 21:23:34,305 INFO  BlockStateChange (BlockManager.java:invalidateWorkForOneNode(3262)) - BLOCK* BlockManager: ask 127.0.0.1:57889 to delete [blk_1073741840_1016, blk_1073741841_1017, blk_1073741842_1018]\n{code}\n\nso the root cause is after balancing, the added block ops will trigger excessReplicates checking, then the removing will change the used space statistic, then failed the testing.\n\nIs there any quick setting for testing could bypass that checking? :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xieliang007","name":"xieliang007","key":"xieliang007","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10434","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10434","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10434","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10434"},"displayName":"Liang Xie","active":true,"timeZone":"Asia/Shanghai"},"created":"2014-07-03T08:25:41.956+0000","updated":"2014-07-03T08:25:41.956+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12725124/comment/14607129","id":"14607129","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"body":"Moving bugs out of previously closed releases into the next minor release 2.8.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinodkv","name":"vinodkv","key":"vinodkv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinod Kumar Vavilapalli","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-06-30T04:38:55.044+0000","updated":"2015-06-30T04:38:55.044+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6624/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1xexr:"}}