{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12560467","self":"https://issues.apache.org/jira/rest/api/2/issue/12560467","key":"HDFS-3534","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2012-06-13T09:50:44.399+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Mar 27 03:03:49 UTC 2014","customfield_12310420":"252705","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_56310108057_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-03-27T03:03:49.779+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-3534/watchers","watchCount":7,"isWatching":false},"created":"2012-06-13T09:22:01.756+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314204","id":"12314204","description":"","name":"0.20.2","archived":false,"released":true,"releaseDate":"2010-02-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316392","id":"12316392","description":"Merge append/sync support with security","name":"0.20.205.0","archived":false,"released":true,"releaseDate":"2011-10-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-27T03:03:49.810+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"If a file (big_file.txt size=512MB) being created (or uploaded) on hdfs, and a rename (fs -mv) of that file is done. Then following exception occurs:-\n\n{noformat}\n12/06/13 08:56:42 WARN hdfs.DFSClient: DataStreamer Exception: org.apache.hadoop.ipc.RemoteException: org.apache.hadoop.hdfs.server.namenode.LeaseExpiredException: No lease on /user/mitesh/temp/big_file.txt File does not exist. [Lease.  Holder: DFSClient_-2105467303, pendingcreates: 1]\n        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.checkLease(FSNamesystem.java:1604)\n        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.checkLease(FSNamesystem.java:1595)\n        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getAdditionalBlock(FSNamesystem.java:1511)\n        at org.apache.hadoop.hdfs.server.namenode.NameNode.addBlock(NameNode.java:685)\n        at sun.reflect.GeneratedMethodAccessor20.invoke(Unknown Source)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:563)\n        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1388)\n        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:1384)\n        at java.security.AccessController.doPrivileged(Native Method)\n        at javax.security.auth.Subject.doAs(Subject.java:396)\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1082)\n        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:1382)\n\n        at org.apache.hadoop.ipc.Client.call(Client.java:1066)\n        at org.apache.hadoop.ipc.RPC$Invoker.invoke(RPC.java:225)\n        at $Proxy6.addBlock(Unknown Source)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n        at java.lang.reflect.Method.invoke(Method.java:597)\n        at org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:82)\n        at org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:59)\n        at $Proxy6.addBlock(Unknown Source)\n        at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.locateFollowingBlock(DFSClient.java:3324)\n        at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.nextBlockOutputStream(DFSClient.java:3188)\n        at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream.access$2300(DFSClient.java:2406)\n        at org.apache.hadoop.hdfs.DFSClient$DFSOutputStream$DataStreamer.run(DFSClient.java:2646)\n\n12/06/13 08:56:42 WARN hdfs.DFSClient: Error Recovery for block blk_-5525713112321593595_679317395 bad datanode[0] nodes == null\n12/06/13 08:56:42 WARN hdfs.DFSClient: Could not get block locations. Source file \"/user/mitesh/temp/big_file.txt\" - Aborting...\n...\n{noformat}\n\n\nWhereas this issue is not seen on *Hadoop 0.23*.\n\n\nI have used following shell script to simulate the issue.\n{code:title=run_parallely.sh}\n#!/bin/bash\nhadoop=\"hadoop\"\nfilename=big_file.txt\ndest=/user/mitesh/temp/$filename\ndest2=/user/mitesh/xyz/$filename\n\n## Clean up\nhadoop fs -rm -skipTrash $dest\nhadoop fs -rm -skipTrash $dest2\n\n## Copy big_file.txt onto hdfs\nhadoop fs -put $filename $dest > cmd1.log 2>&1 &\n\n## sleep until entry is created, hoping copying is not finished\nuntil $(hadoop fs -test -e $dest)\ndo\n    sleep 1\ndone\n\n## Now move\nhadoop fs -mv $dest $dest2 > cmd2.log 2>&1 &\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"74366","customfield_12312823":null,"summary":"LeaseExpiredException on NameNode if file is moved while being created.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miteshsjat","name":"miteshsjat","key":"miteshsjat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Singh Jat","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miteshsjat","name":"miteshsjat","key":"miteshsjat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Singh Jat","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12560467/comment/13294304","id":"13294304","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"This is current DFS behavior. We can mv, rename, delete the opened files.\nIf the older client still continue on that files, then they will suffer with this exception.\n\nEven in linux, you can move the file, while other thread writing it, file content will not be reflected in moved file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-06-13T09:50:44.399+0000","updated":"2012-06-13T09:50:44.399+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12560467/comment/13294327","id":"13294327","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miteshsjat","name":"miteshsjat","key":"miteshsjat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Singh Jat","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi Uma,\n\nThen, this issue should also come in hadoop 0.23 .\n\nRegards,\nMitesh","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miteshsjat","name":"miteshsjat","key":"miteshsjat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Singh Jat","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-06-13T10:32:38.957+0000","updated":"2012-06-13T10:32:38.957+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12560467/comment/13294503","id":"13294503","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miteshsjat","name":"miteshsjat","key":"miteshsjat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Singh Jat","active":true,"timeZone":"Asia/Kolkata"},"body":"On linux, if file is moved while being created, the contents are still added to the new moved location (same happened in hadoop 0.23).\n\n{noformat}\n$ ls -l temp xyz\ntemp:\ntotal 0K\n\nxyz:\ntotal 4K\n-rw-r--r-- 1 mitesh mitesh 64 Jun 13 20:10 big_file.txt\n$ ls -l temp xyz\ntemp:\ntotal 0K\n\nxyz:\ntotal 4K\n-rw-r--r-- 1 mitesh mitesh 72 Jun 13 20:10 big_file.txt\n{noformat}\n\nBut in hadoop 0.20.2xx the file is moved to new location with 0 bytes and creation program failed with LeaseExpiredException.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=miteshsjat","name":"miteshsjat","key":"miteshsjat","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mitesh Singh Jat","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-06-13T14:47:26.110+0000","updated":"2012-06-13T14:47:26.110+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12560467/comment/13295796","id":"13295796","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"0.23/2.0 is no different from 0.20.205/1.0.x on this. If you don't see it in your test case, that's because the timings are different.  I have seen the same thing happening on 0.23.\n\nThis is commonly seen when users forget to close the output streams of their task output. The temporary name of the parent directory will be renamed to the final one before the last block is completed in the shutdown hook in this case. Depending on the timing, there can be data loss as well.  Namenode will eventually notice the state of the final block and take care of it.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2012-06-15T17:52:25.155+0000","updated":"2012-06-15T17:52:25.155+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12560467/comment/13948819","id":"13948819","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"body":"As explained in above comments, this is expected behaviour. Resolving.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=qwertymaniac","name":"qwertymaniac","key":"qwertymaniac","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=qwertymaniac&avatarId=16780","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=qwertymaniac&avatarId=16780","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=qwertymaniac&avatarId=16780","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=qwertymaniac&avatarId=16780"},"displayName":"Harsh J","active":true,"timeZone":"Asia/Kolkata"},"created":"2014-03-27T03:03:49.806+0000","updated":"2014-03-27T03:03:49.806+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-3534/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0d3n3:"}}