{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13135020","self":"https://issues.apache.org/jira/rest/api/2/issue/13135020","key":"HDFS-13093","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-02-01T05:42:45.901+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 01 07:17:37 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13093/watchers","watchCount":4,"isWatching":false},"created":"2018-01-31T08:41:03.260+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":172800,"aggregatetimeoriginalestimate":172800,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341434","id":"12341434","description":"3.1.0 release","name":"3.1.0","archived":false,"released":true,"releaseDate":"2018-04-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-02-01T07:17:37.185+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":172800,"description":"test as following steps:\r\n 1. hdfs dfs -mkdir /hot\r\n 2. hdfs dfs -put 1G.img /hot/file1\r\n 3. hdfs dfsadmin -setSpaceQuota 6442450944 -storageType DISK /hot\r\n 4. hdfs storagepolicies -setStoragePolicy -path /hot -policy HOT\r\n 5. hdfs dfs -count -q -h -v -t DISK /hot\r\n{code:java}\r\nSSD_QUOTA REM_SSD_QUOTA DISK_QUOTA REM_DISK_QUOTA ARCHIVE_QUOTA REM_ARCHIVE_QUOTA PROVIDED_QUOTA REM_PROVIDED_QUOTA PATHNAME\r\n none inf 6 G 6 G none inf none inf /hot{code}\r\nIn step5 i speculation the remaining quota is 3G(quota - 1G*3 replicas )，but 6G actually.\r\n if i change the turn of step3 and step4, then the remaining quota equal to what I think 3G.","customfield_10010":null,"timetracking":{"originalEstimate":"48h","remainingEstimate":"48h","originalEstimateSeconds":172800,"remainingEstimateSeconds":172800},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":172800,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Quota set don't compute usage of unspecified storage policy content","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liaoyuxiangqin","name":"liaoyuxiangqin","key":"liaoyuxiangqin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liaoyuxiangqin","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liaoyuxiangqin","name":"liaoyuxiangqin","key":"liaoyuxiangqin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liaoyuxiangqin","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":172800,"percent":0},"customfield_12311024":null,"environment":"hdfs: hadoop-3.1.0-SNAPSHOT\r\n\r\nnode:1 namenode, 9 datanodes","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":172800,"percent":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13135020/comment/16348042","id":"16348042","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xyao","name":"xyao","key":"xyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xiaoyu Yao","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~liaoyuxiangqin] for reporting this. This could relate to HDFS-8898 which returns a cached quota usage with the new getQuotaUsage() API from INode directly without recursive traversal and recalculate like getContentSummary() API.\r\n\r\nBefore HDFS-8898, the \"hdfs dfs -count\" CLI uses getContentSummary(),  which is expensive because it always walks the whole sub-tree to recalculate quota and usage. This guarantees the correctness no matter the order of step 3 and 4.\r\n\r\nAfter HDFS-8898, we switch to use the getQuotaUsage() API for \"hdfs dfs count\" CLI, the cached INode quota usage for storage type will be 0 if you don't set storage policy before storage type quota.\r\n\r\nThis is because the storage type usage is strongly tied to the storage policy. If there is no storage policy set first, we will not be able to determine the quota usage for different storage type. As a result, 0 will be the default in this case.\r\n\r\nI believe this is a transient incorrectness that can be fixed by one of the following three options. \r\n\r\n1. This is a corner case. Document the procedure to set storage policy first before set storage type quota. Otherwise, getQuotaUsage() API and \"hdfs dfs count\" CLI will return an inconsistent result. No fix needed.\r\n\r\n2. The cached quota usage will be recalculated correctly any way upon next NN restart, no fix needed.\r\n\r\n3. If we really want to allow setting storage type quota before setting storage policy, we can provide an option for \"hdfs dfs count\" CLI to use getContentSummary() to report the accurate usage.\r\n\r\ncc: [~mingma], [~kihwal] for additional comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xyao","name":"xyao","key":"xyao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xiaoyu Yao","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-02-01T05:42:45.901+0000","updated":"2018-02-01T05:42:45.901+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13135020/comment/16348128","id":"16348128","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liaoyuxiangqin","name":"liaoyuxiangqin","key":"liaoyuxiangqin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liaoyuxiangqin","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~xyao] review this and give detail reason explanations and many solutions. As above you proposed three options which can resolve the problem of  \"hdfs dfs count\" CLI return an inconsistent result, but because the incorrect remaining quota can't limit client continue write data  to HDFS, so that the  \"hdfs dfs count\" CLI may be return negative number for  remaining quota  after NN restarted. \r\n{noformat}\r\n SSD_QUOTA REM_SSD_QUOTA DISK_QUOTA REM_DISK_QUOTA ARCHIVE_QUOTA REM_ARCHIVE_QUOTA PROVIDED_QUOTA REM_PROVIDED_QUOTA PATHNAME\r\n none inf 6 G -3 G none inf none inf /hot\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liaoyuxiangqin","name":"liaoyuxiangqin","key":"liaoyuxiangqin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liaoyuxiangqin","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-01T07:17:37.185+0000","updated":"2018-02-01T07:17:37.185+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13093/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3pl2f:"}}