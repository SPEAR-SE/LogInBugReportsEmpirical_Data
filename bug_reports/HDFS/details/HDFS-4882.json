{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12651089","self":"https://issues.apache.org/jira/rest/api/2/issue/12651089","key":"HDFS-4882","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329018","id":"12329018","description":"2.6.1 release","name":"2.6.1","archived":false,"released":true,"releaseDate":"2015-09-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12335732","id":"12335732","description":"3.0.0-alpha1 release","name":"3.0.0-alpha1","archived":false,"released":true,"releaseDate":"2016-09-03"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-06-06T11:52:44.043+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Oct 06 19:58:17 UTC 2015","customfield_12310420":"331415","customfield_12312320":null,"customfield_12310222":"10002_*:*_3_*:*_46270533996_*|*_1_*:*_3_*:*_153220871_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-11-24T18:56:36.268+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-4882/watchers","watchCount":28,"isWatching":false},"created":"2013-06-05T11:27:21.463+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["2.6.1-candidate"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"11.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12320353","id":"12320353","description":"hadoop-2.0.0-alpha release","name":"2.0.0-alpha","archived":false,"released":true,"releaseDate":"2012-05-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327746","id":"12327746","description":"2.5.1 release","name":"2.5.1","archived":false,"released":true,"releaseDate":"2014-09-05"}],"issuelinks":[{"id":"12401757","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12401757","type":{"id":"12310010","name":"Incorporates","inward":"is part of","outward":"incorporates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310010"},"outwardIssue":{"id":"12752623","key":"HDFS-7342","self":"https://issues.apache.org/jira/rest/api/2/issue/12752623","fields":{"summary":"Lease Recovery doesn't happen some times","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12400085","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12400085","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12751519","key":"HDFS-7307","self":"https://issues.apache.org/jira/rest/api/2/issue/12751519","fields":{"summary":"Need 'force close'","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12423919","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12423919","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12828061","key":"HDFS-8344","self":"https://issues.apache.org/jira/rest/api/2/issue/12828061","fields":{"summary":"NameNode doesn't recover lease for files with missing blocks","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-08-30T01:42:22.308+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312928","id":"12312928","name":"hdfs-client"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"Scenario:\n1. cluster with 4 DNs\n2. the size of the file to be written is a little more than one block\n3. write the first block to 3 DNs, DN1->DN2->DN3\n4. all the data packets of first block is successfully acked and the client sets the pipeline stage to PIPELINE_CLOSE, but the last packet isn't sent out\n5. DN2 and DN3 are down\n6. client recovers the pipeline, but no new DN is added to the pipeline because of the current pipeline stage is PIPELINE_CLOSE\n7. client continuously writes the last block, and try to close the file after written all the data\n8. NN finds that the penultimate block doesn't has enough replica(our dfs.namenode.replication.min=2), and the client's close runs into indefinite loop(HDFS-2936), and at the same time, NN makes the last block's state to COMPLETE\n9. shutdown the client\n10. the file's lease exceeds hard limit\n11. LeaseManager realizes that and begin to do lease recovery by call fsnamesystem.internalReleaseLease()\n12. but the last block's state is COMPLETE, and this triggers lease manager's infinite loop and prints massive logs like this:\n{noformat}\n2013-06-05,17:42:25,695 INFO org.apache.hadoop.hdfs.server.namenode.LeaseManager: Lease [Lease.  Holder: DFSClient_NONMAPREDUCE_-1252656407_1, pendingcreates: 1] has expired hard\n limit\n2013-06-05,17:42:25,695 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem: Recovering lease=[Lease.  Holder: DFSClient_NONMAPREDUCE_-1252656407_1, pendingcreates: 1], src=\n/user/h_wuzesheng/test.dat\n2013-06-05,17:42:25,695 WARN org.apache.hadoop.hdfs.StateChange: DIR* NameSystem.internalReleaseLease: File = /user/h_wuzesheng/test.dat, block blk_-7028017402720175688_1202597,\nlastBLockState=COMPLETE\n2013-06-05,17:42:25,695 INFO org.apache.hadoop.hdfs.server.namenode.LeaseManager: Started block recovery for file /user/h_wuzesheng/test.dat lease [Lease.  Holder: DFSClient_NONM\nAPREDUCE_-1252656407_1, pendingcreates: 1]\n{noformat}\n(the 3rd line log is a debug log added by us)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329018","id":"12329018","description":"2.6.1 release","name":"2.6.1","archived":false,"released":true,"releaseDate":"2015-09-23"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12586483","id":"12586483","filename":"4882.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-06-06T11:40:17.071+0000","size":3520,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12586483/4882.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12586700","id":"12586700","filename":"4882.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-06-07T11:30:11.636+0000","size":1043,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12586700/4882.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12586666","id":"12586666","filename":"4882.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-06-07T06:18:46.464+0000","size":1043,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12586666/4882.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12678992","id":"12678992","filename":"HDFS-4882.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-03T19:13:14.940+0000","size":5963,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12678992/HDFS-4882.1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12681116","id":"12681116","filename":"HDFS-4882.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-12T19:04:18.676+0000","size":8946,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12681116/HDFS-4882.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12681481","id":"12681481","filename":"HDFS-4882.3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-14T03:35:02.463+0000","size":8832,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12681481/HDFS-4882.3.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12681664","id":"12681664","filename":"HDFS-4882.4.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-15T00:21:26.336+0000","size":8909,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12681664/HDFS-4882.4.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12682699","id":"12682699","filename":"HDFS-4882.5.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T18:00:54.254+0000","size":9052,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12682699/HDFS-4882.5.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12682760","id":"12682760","filename":"HDFS-4882.6.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T22:12:02.674+0000","size":9073,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12682760/HDFS-4882.6.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12682913","id":"12682913","filename":"HDFS-4882.7.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-21T17:21:16.932+0000","size":9138,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12682913/HDFS-4882.7.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12678329","id":"12678329","filename":"HDFS-4882.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-10-30T22:20:39.150+0000","size":4588,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12678329/HDFS-4882.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"331747","customfield_12312823":null,"summary":"Prevent the Namenode's LeaseManager from looping forever in checkLeases","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13675817","id":"13675817","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"body":"Three major problems related to this issue:\n1. the client doesn't add new datanode during pipeline recovery when the pipeline stage is PIPELINE_CLOSE\n2. the client's close() runs into infinite loop(HDFS-2936)\n3. the namenode's checkLeases() runs into infinite loop","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-06-05T11:33:27.543+0000","updated":"2013-06-05T11:33:27.543+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13676928","id":"13676928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"body":"The initial version of the patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-06-06T11:40:17.074+0000","updated":"2013-06-06T11:40:17.074+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13676941","id":"13676941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12586483/4882.1.patch\n  against trunk revision .\n\n    {color:red}-1 patch{color}.  The patch command could not apply the patch.\n\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/4485//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-06-06T11:52:44.043+0000","updated":"2013-06-06T11:52:44.043+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13677848","id":"13677848","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"body":"The main consideration of the patch:\nWhen there's DN in the pipeline down and the pipeline stage is PIPELINE_CLOSE, the client triggers the data replication, do not wait the NN to do this(NN needs the file be finalized to do the replication, but finalized need all the blocks have at least dfs.namenode.replication.min(=2) replicas, these two conditions are contradicting).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-06-07T06:18:46.467+0000","updated":"2013-06-07T06:18:46.467+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13678330","id":"13678330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12586700/4882.patch\n  against trunk revision .\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  The javadoc tool did not generate any warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 1.3.9) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/4497//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/4497//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2013-06-07T19:18:41.659+0000","updated":"2013-06-07T19:18:41.659+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13697743","id":"13697743","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"body":"{quote}\nWhen there's DN in the pipeline down and the pipeline stage is PIPELINE_CLOSE, the client triggers the data replication, do not wait the NN to do this(NN needs the file be finalized to do the replication, but finalized need all the blocks have at least dfs.namenode.replication.min(=2) replicas, these two conditions are contradicting).\n{quote}\nWhat you mean by 'the client triggers the data replication'?\nFile will not be finalized until it reached at least min replication blocks. But block replication can be started once it is committed to DN.(here each DN will finalize its block and report NN). On reaching min replication NN will complete that block. If all Blocks in NN are in complete state then file can be closed normally.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=umamaheswararao","name":"umamaheswararao","key":"umamaheswararao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Uma Maheswara Rao G","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-07-02T12:47:38.463+0000","updated":"2013-07-02T12:47:38.463+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13697784","id":"13697784","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"body":"1. {quote}What you mean by 'the client triggers the data replication'?{quote}\nI mean let the client goto the following replica transfer process:\n{code}\n      //transfer replica\n      final DatanodeInfo src = d == 0? nodes[1]: nodes[d - 1];\n      final DatanodeInfo[] targets = {nodes[d]};\n      transfer(src, targets, lb.getBlockToken());\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-07-02T13:34:12.306+0000","updated":"2013-07-02T13:34:12.306+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13697787","id":"13697787","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"body":"{quote}\nFile will not be finalized until it reached at least min replication blocks. But block replication can be started once it is committed to DN.(here each DN will finalize its block and report NN). On reaching min replication NN will complete that block. If all Blocks in NN are in complete state then file can be closed normally.\n{quote}\nYes, I think you are right. But the block replication is not committed to DN, so is not started.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wuzesheng","name":"wuzesheng","key":"wuzesheng","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Zesheng Wu","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-07-02T13:40:55.588+0000","updated":"2013-07-02T13:40:55.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/13719847","id":"13719847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shrijeet","name":"shrijeet","key":"shrijeet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shrijeet Paliwal","active":true,"timeZone":"America/Los_Angeles"},"body":"Just wanted to report that we have been hit by this (or an issue that produces exactly same symptoms) twice in 3 days.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shrijeet","name":"shrijeet","key":"shrijeet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Shrijeet Paliwal","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-07-25T18:03:06.343+0000","updated":"2013-07-25T18:03:06.343+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14189396","id":"14189396","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12586700/4882.patch\n  against trunk revision d33e07d.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:red}-1 tests included{color}.  The patch doesn't appear to include any new or modified tests.\n                        Please justify why no new tests are needed for this patch.\n                        Also please list what manual steps were performed to verify this patch.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:\n\n                  org.apache.hadoop.hdfs.server.datanode.TestDataNodeHotSwapVolumes\n\n                                      The following test timeouts occurred in hadoop-hdfs-project/hadoop-hdfs:\n\norg.apache.hadoop.hdfs.server.namenode.TestDeleteRace\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8589//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8589//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-30T00:45:26.722+0000","updated":"2014-10-30T00:45:26.722+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14190944","id":"14190944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"We got bit by this bug. At the very least I think the Namenode should not enter an infinite loop trying to recover leases. Attaching a patch which tries to recover the limits which have exceeded the hard limit but only once for one invocation of checkLeases. Please note that https://issues.apache.org/jira/browse/HDFS-7307 has been filed to force close files.\nWe would need to file follow up JIRAs on why the leases weren't recovered once we have a better handle on that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-10-30T22:20:39.177+0000","updated":"2014-10-30T22:20:39.177+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14191183","id":"14191183","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12678329/HDFS-4882.patch\n  against trunk revision 5e3f428.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:\n\n                  org.apache.hadoop.hdfs.server.namenode.TestEditLog\n\n                                      The following test timeouts occurred in hadoop-hdfs-project/hadoop-hdfs:\n\norg.apache.hadoop.hdfs.TestDFSClientRetries\norg.apache.hadoop.hdfs.TestLeaseRecovery2\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8605//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8605//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-31T01:44:46.783+0000","updated":"2014-10-31T01:44:46.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14194915","id":"14194915","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"I had to make sortedLeases a ConcurrentSkipListSet because checkLeases is acitvely modifying it while iterating through it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-03T19:13:14.949+0000","updated":"2014-11-03T19:13:14.949+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14195227","id":"14195227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:green}+1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12678992/HDFS-4882.1.patch\n  against trunk revision 67f13b5.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8628//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8628//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-03T22:24:09.947+0000","updated":"2014-11-03T22:24:09.947+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14195675","id":"14195675","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Can someone please review and commit this JIRA?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-04T03:47:53.817+0000","updated":"2014-11-04T03:47:53.817+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14195678","id":"14195678","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"I've filed HDFS-7342 to investigate why the lease wasn't recovered. [~wuzesheng] and [~umamaheswararao] were you ever able to consistently produce the situation in which leases weren't recovered? Perhaps as a unit test?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-04T03:52:31.919+0000","updated":"2014-11-04T03:52:31.919+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14205138","id":"14205138","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"If I understand this correctly, the issue here is that there is an expired lease which is not getting removed from {{sortedLeases}}, causing {{LeaseManager#checkLeases}} to loop forever.  Maybe this is a dumb question, but shouldn't we fix the code so that this expired lease does get removed?  Is this patch really fixing the root issue?  It seems like if we let expired leases stick around forever we may have other problems.\n\nAlso, this patch seems to replace a {{SortedSet}} with a {{ConcurrentSkipListSet}}.  We don't need the overhead of a concurrent set here... the set is only modified while holding the lock.  If you want to modify while iterating, you can simply use an {{Iterator}} for this purpose.  Or, since the set is sorted, you can use {{SortedSet#tailSet}} to find the element after the previous element you were looking at.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-10T18:37:56.763+0000","updated":"2014-11-10T18:37:56.763+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14205669","id":"14205669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for your review Colin! Your understanding is correct. In this case, for a very strange reason which I have as yet not been able to uncover, the FSNamesystem wasn't able to recover the lease. I am investigating this root issue in HDFS-7342. In the meantime, however I'd argue that the Namenode should never enter an infinite loop for whatever reason, and instead of assuming that we have fixed all possible reasons why a lease couldn't be recovered, we should relinquish the lock regularly. We should display on the webUI how many files are open for writing and allow ops to forcibly close open files (HDFS-7307) . The way in which this error happens (NN suddenly stops working) is egregious.\n\nsortedLeases is being used externally in FSNamesystem.getCompleteBlocksTotal() as well . We were also actively modifying it in checkLeases. I'm sure we can move things around to keep using SortedSets, but I don't know if this Collection will ever really become too big for the performance difference to matter. What do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-11T00:32:32.206+0000","updated":"2014-11-11T00:32:32.206+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14206930","id":"14206930","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"I'll try to refactor the code to use SortedSet anyway.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-11T19:46:41.764+0000","updated":"2014-11-11T19:46:41.764+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14207202","id":"14207202","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. In this case, for a very strange reason which I have as yet not been able to uncover, the FSNamesystem wasn't able to recover the lease.\n\nAccording to [~wuzesheng]'s earlier analysis, this may happen when the penultimate block is in COMMITTED state while the last block is in COMPLETE state. The following code in FSNamesystem#internalReleaseLease may have some issue:\n{code}\n    switch(lastBlockState) {\n    case COMPLETE:\n      assert false : \"Already checked that the last block is incomplete\";\n      break;\n{code}\nSince it is possible that the penultimate block is in COMMITTED state while the last block is in COMPLETE state, the logic of the above code may be wrong. Instead, I think we can combine the COMPLETE and COMMITTED case in the switch expression, so that the current replication factor of both the last and the penultimate blocks are checked.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-11T22:27:14.969+0000","updated":"2014-11-11T22:27:14.969+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14207393","id":"14207393","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Jing! I was trying to create a unit test to replicate this failure. Please feel free to upload a patch on HDFS-7342 if you can. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-12T00:22:50.304+0000","updated":"2014-11-12T00:22:50.304+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14208477","id":"14208477","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"I tried using iterators, but then realized that FSNamesystem.internalReleaseLease() calls into renewLease, and to make those modifications were too unsightly.\nHere's a patch which uses SortedSet.tailSet. However I still like the earlier patch more (because its a genuine case of two threads accessing the same data-structure). With tailSet we are just trying to build our own synchronization mechanism (which is likely more inefficient than the ConcurrentinternalReleaseLease) .\nI'd vote for the earlier patch (HDFS-4882.1.patch) . I'd also request for this to make it into 2.6.0 because of this issue's severity.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-12T19:04:18.683+0000","updated":"2014-11-12T19:04:18.683+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14208478","id":"14208478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"s/ConcurrentinternalReleaseLease/ConcurrentSkipList/","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-12T19:05:01.046+0000","updated":"2014-11-12T19:05:01.046+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14208622","id":"14208622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12681116/HDFS-4882.2.patch\n  against trunk revision be7bf95.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-yarn-project/hadoop-yarn/hadoop-yarn-server/hadoop-yarn-server-resourcemanager:\n\n                  org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.TestCapacitySchedulerDynamicBehavior\n                  org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.TestCapacityScheduler\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8723//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8723//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-12T20:27:17.833+0000","updated":"2014-11-12T20:27:17.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14208657","id":"14208657","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"These unit tests failures are spurious and unrelated to the code changes in the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-12T20:49:47.424+0000","updated":"2014-11-12T20:49:47.424+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14211550","id":"14211550","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"The patch looks good.\n\nbq. Here's a patch which uses SortedSet.tailSet. However I still like the earlier patch more (because its a genuine case of two threads accessing the same data-structure). With tailSet we are just trying to build our own synchronization mechanism (which is likely more inefficient than the ConcurrentinternalReleaseLease) .\n\nI have to admit that I find the locking to be confusing in {{LeaseManager}}.  It seems like some methods which access the sets are synchronized, and some are not.  And we are exposing the sets to outside code, which accesses them without synchronization.  It's very inconsistent and we should file a follow-up JIRA to look into this.  I don't think there is necessarily a bug there, though... I think it's possible that the access is actually gated on the FSN lock.  If that's true, we should document it and remove the synchronized blocks in {{LeaseManager}} (since in that case they would not be doing anything useful).\n\nConcurrent sets are not a magic bullet since we still may have to deal with issues like Lease objects being deactivated while another caller holds on to them, etc.  If we dig too far into locking, this patch will get a lot bigger and a lot messier.  I think that we should keep this patch small and focused on the problem.\n\nIn your patch is that you are requiring the FSN lock to be held in {{LeaseManager#getNumUnderConstructionBlocks}}, but you don't document that anywhere.  Can you please add that to a JavaDoc or other comment for this method?\n\n{code}\n+    Lease leaseToCheck = null;\n+    try {\n+      leaseToCheck = sortedLeases.first();\n+    } catch(NoSuchElementException e) {}\n{code}\nYou can replace this with {{leaseToCheck = sortedLeases.pollFirst();}}\n\n{code}\n+      try {\n+        leaseToCheck = sortedLeases.tailSet(leaseToCheck, false).first();\n+      } catch(NoSuchElementException e) { \n+        leaseToCheck = null;\n       }\n{code}\nYou don't need this.  Just use {{leaseToCheck = sortedLeases.higher(leaseToCheck)}}.\n\nbq. I'd also request for this to make it into 2.6.0 because of this issue's severity.\n\nI'm fine with the second version going into 2.6.  [~acmurthy], others, what do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-14T00:13:56.488+0000","updated":"2014-11-14T00:13:56.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14211786","id":"14211786","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Colin! Thanks a lot for your review and great comments! I am coming around to your view that we may be able to avoid the ConcurrentSkiplist. Now that FSNamesystem will call into getNumUnderConstructionBlocks(), the Monitor thread just needs to be careful about accessing these data structures. I completely agree with you that this code could use some refactoring later on.\n\nHere's a patch with the changes you have suggested.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-14T03:35:02.469+0000","updated":"2014-11-14T03:35:02.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14211932","id":"14211932","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12681481/HDFS-4882.3.patch\n  against trunk revision d005404.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:red}-1 findbugs{color}.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:red}-1 core tests{color}.  The patch failed these unit tests in hadoop-hdfs-project/hadoop-hdfs:\n\n                  org.apache.hadoop.hdfs.server.namenode.TestCheckpoint\n                  org.apache.hadoop.hdfs.server.namenode.ha.TestRetryCacheWithHA\n                  org.apache.hadoop.hdfs.TestFileCreation\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8735//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/8735//artifact/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8735//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-14T06:58:24.751+0000","updated":"2014-11-14T06:58:24.751+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14213109","id":"14213109","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"These test errors are valid. They are happening because pollFirst() retrieved *and removes* the first element. Sorry for the oversight. Will upload a new patch soon","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-15T00:04:37.814+0000","updated":"2014-11-15T00:04:37.814+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14213139","id":"14213139","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Here's a patch which goes back to using sortedLeases.first() .","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-15T00:21:26.343+0000","updated":"2014-11-15T00:21:26.343+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14213324","id":"14213324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12681664/HDFS-4882.4.patch\n  against trunk revision 4fb96db.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:red}-1 findbugs{color}.  The patch appears to introduce 1 new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8745//testReport/\nFindbugs warnings: https://builds.apache.org/job/PreCommit-HDFS-Build/8745//artifact/patchprocess/newPatchFindbugsWarningshadoop-hdfs.html\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8745//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-15T03:33:00.264+0000","updated":"2014-11-15T03:33:00.264+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14213992","id":"14213992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"HI,\n\nThanks Zesheng for reporting the issue, Ravi for working on the solution and other folks for reviewing.\n\nI was looking into an infinite loop case when doing checkLeases myself, and figured out that the logic in FSNamesystem#internalReleaseLease\n{code}\n   switch(lastBlockState) {\n    case COMPLETE:\n      assert false : \"Already checked that the last block is incomplete\";\n      break;\n{code}\n\ndoesn't take care of the case that penultimate block is COMMITTED and final block is COMPLETE, thus caused the infinite loop. Looking at the history of this jira, I found [~jingzhao] suggested the same at https://issues.apache.org/jira/browse/HDFS-4882?focusedCommentId=14207202&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14207202\n\nI did some analysis to share here (sorry for a long post).\n\nWhen the final block is COMMITTED, the current implementation does the following:\n{code}\n    case COMMITTED:\n      // Close file if committed blocks are minimally replicated  <=================== senario#1\n      if(penultimateBlockMinReplication &&\n          blockManager.checkMinReplication(lastBlock)) {\n        finalizeINodeFileUnderConstruction(src, pendingFile,\n            iip.getLatestSnapshotId());\n        NameNode.stateChangeLog.warn(\"BLOCK*\"\n          + \" internalReleaseLease: Committed blocks are minimally replicated,\"\n          + \" lease removed, file closed.\");\n        return true;  // closed!\n      }\n      // Cannot close file right now, since some blocks   <======================== scenario#2\n      // are not yet minimally replicated.\n      // This may potentially cause infinite loop in lease recovery\n      // if there are no valid replicas on data-nodes.\n      String message = \"DIR* NameSystem.internalReleaseLease: \" +\n          \"Failed to release lease for file \" + src +\n          \". Committed blocks are waiting to be minimally replicated.\" +\n          \" Try again later.\";\n      NameNode.stateChangeLog.warn(message);\n      throw new AlreadyBeingCreatedException(message);\n{code}\n\nWhat it does:\n\n* For scenario#1, check minReplication for both penultimate and last block, if satisifed, finalize the block (recover lease, close file)\n\n* For scenario#2, throw AlreadyBeingCreatedException derived from IOException (the name of this exception appears to be a misnomer, maybe we should fix later). \n\nTo solve the case that penultimate block is COMMITTED and final block is COMPLETE, I'd suggest to make some changes on top of the submitted patch (for further discussion):\n\nFor scenario#1, we can do the same as when the last block is COMMITTED, as described above.\n\nFor scenario#2,   I think we have two options:\n\n# option A, drop the code in the existing code that handles scenario#2 (not to throw the exception), let checkLeases check back again (2 second is current internal), waiting for block report to finish to change the minimal replication situation then recover the lease. The infinite loop could still happen if the minimal replication never get satisfied. But this would be rare assuming the minimal replication can be satisfied eventually.\n# option B, do the similar logic as in the existing code (throwing AlreadyBeingCreatedException). There is an issue for this option too that I can see, and described below.\n\nWith option B, look at the caller side (LeaseManager#checkLeases, whenever an IOException is caught, it just go ahead removing the lease. So the possible infinite loop described in the scenario#2 comment will not happen because of the lease removal (lease recovered). \n\nBut the problem with option B is, after the lease removal, the file may still have blocks not satisfying minimal replication (scenario#2), which would be a potential issue. This situation exists in current implementation when handling the case that the last block is COMMITTED. I think we should we wait for minimal replication to be satisfied before recovering the lease. \n\nSo looks like option A is more preferable. But the original code tries to recover the lease immediately, I'm not sure whether there is any catch here. \n\nComments, thoughts?\n\nThanks again.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-16T18:19:22.684+0000","updated":"2014-11-16T18:19:22.684+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14213999","id":"14213999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"BTW, the scenario reported in the jira description is one special one. The infinite loop could happen whenever penultimate block is COMMITTED and final block is COMPLETE for other scenarios. That is, the LeaseManager#checkLeases method is holding FSNamesystem.writeLock() all the time because of the infinite loop, all the threads in NN that process block report will be blocked waiting for FSNamesystem.writeLock(). So even if a block report is ready to satisfy the minimal replication, it won't be processed.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-16T18:34:47.227+0000","updated":"2014-11-16T18:34:47.227+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14214398","id":"14214398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"[~yzhangal]: backing up a little bit, the overall problem here seems to be that we are unwilling to \"recover the lease\" for an overdue lease when the replication is too low.  Right?  And then we get in this infinite loop, because {{checkLeases}} assumes that all expired leases will be recovered rather than lingering around.\n\nIs there any reason we can't simply recover the lease anyway, even though the minimal replication has not been met?  There are a lot of cases where we just can't get to the minimum replication (i.e. 1-node cluster, etc.).  I don't see a lot of value in letting these leases linger forever.  Our lease expiry period is REALLY long, so if we can't replicate in that period, maybe it's time to throw in the towel.  Am I missing something here?  What do you guys think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T08:00:42.909+0000","updated":"2014-11-17T08:00:42.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14214879","id":"14214879","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~cmccabe],\n\nWhat I speculated was, if the last block does not have minimal replication (usually is 1), and if the lease is recovered, and then someone else try to append to the same file, where to append the data to?\n\nAs I commented earlier, I agree if we keep the lease and the minimal replication never got reached, then this is still going to be \"infinite loop\", that is,  checkLeases is run every 2 seconds, in each run, the same lease can not be recovered because the minimal replication is not reached. But this \"infinite loop\" is different than the infinite loop we are dealing with in this jira, which is a real infinite loop within one checkLeases call, which would take the FSNamesystem.writeLock() infinitely,  thus causing much bigger trouble (the former one is not a real infinite loop in this sense). \n\nFor case that minimal replication can never be reached when minimal replication is 1, it means data loss. Is this common?\n\nThanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T17:35:00.244+0000","updated":"2014-11-17T17:35:00.244+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14214910","id":"14214910","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for your investigation Yongjun! In scenario #2 (and in fact in every scenario I traced), shouldn't there be the warning message logged? I did NOT see this message. Please see the log excerpt I have posted on HDFS-7342. This makes me slightly suspicious that scenario #2 is the only failure case in which leases are not recovered.\nIn our instance the nodes with the penultimate block were decomissioned during the file write.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T17:59:29.086+0000","updated":"2014-11-17T17:59:29.086+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14214914","id":"14214914","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"{quote}\n the overall problem here seems to be that we are unwilling to \"recover the lease\" for an overdue lease when the replication is too low. Right? \n{quote}\nThe core problem of the infinite loop reported with this jira is that when penultimate block is COMMITTEED and last block is COMPLETE, infinite loop would  occur, because of the loop in {{LeaseManager#checkLeases}} does not move on to next entry, and {{FSNamesystem#internalReleaseLease}} does not release lease. \n\nThe reason that the penultimate is COMMITTED could be that minimal replication is not reached, but what could be even more likely here is: \n- the {{LeaseManager#checkLeases}} happens to be run first, it acquires  the FSnamesystem.writeLock in, \n- a block report that has already reached NN (or will reach NN shortly) would help satisfying the minimal replication if processed, but this block report won't be processed, because the block report processing thread is blocked, waiting for the writeLock.\n\nThis is the root cause of the problem here. I think once this is resolved, the block that didn't reach minimal replication will be replicated by the replication monitor. \n\nI wonder what are the general scenarios that minimal replication can not be satisfied, and how we deal with it in general, especially if min replication is 1.\n\nThanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T18:03:22.909+0000","updated":"2014-11-17T18:03:22.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14214952","id":"14214952","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ravi,\n\nJust saw you comment:\n{quote}\n In scenario #2 (and in fact in every scenario I traced), shouldn't there be the warning message logged? I did NOT see this message\n{quote}\nI described scenario#2 in my earlier comment for completeness.\n\nIn the infinite loop case reported here and the one I looked at, the root cause is described in my last comment. Hope that makes sense to you.\n\nThanks.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T18:28:57.227+0000","updated":"2014-11-17T18:28:57.227+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14214980","id":"14214980","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Yongjun! Do you see a case where FSNamesystem.internalReleaseLease() returns without logging a message other than {code}LOG.info(\"Recovering \" + lease + \", src=\" + src);{code}\nIf FSNamesystem.internalReleaseLease() had thrown an exception, then it too would have been logged in the LeaseManager {code}LOG.error(\"Cannot release the path \" + p + \" in the lease \" + oldest, e);{code}\nThis is contrary to the logs we found.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T18:52:32.789+0000","updated":"2014-11-17T18:52:32.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14215049","id":"14215049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ravi,\n\nIndeed the case I was looking at is like you described, that's because the code in {{ FSNamesystem#internalReleaseLease()}} doesn't handle the case where the penultimate block is COMMITTED, and the last block is COMPLETE, thus triggering the following code\n{code}\n   switch(lastBlockState) {\n    case COMPLETE:\n      assert false : \"Already checked that the last block is incomplete\";\n      break;\n{code}\nI think the logs reported in HDFS-4882 is very similar (except it has 3rd line addded by debugging, and 4th line with debug enabled). And after careful study of the code, I believe the root cause is the same.\n\nWould you please share the logs you observed? thanks.\n\n\n \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T19:36:31.758+0000","updated":"2014-11-17T19:36:31.758+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14215071","id":"14215071","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Aah! I see now. Because assertions are not enabled, I don't see the AssertionException. That makes sense. The log excerpt are here : https://issues.apache.org/jira/browse/HDFS-7342?focusedCommentId=14209022&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14209022","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T19:53:49.834+0000","updated":"2014-11-17T19:53:49.834+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14215089","id":"14215089","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Is there any reason we can't simply recover the lease anyway, even though the minimal replication has not been met? There are a lot of cases where we just can't get to the minimum replication (i.e. 1-node cluster, etc.). I don't see a lot of value in letting these leases linger forever.\n\nI agree with [~cmccabe] here. I do not think we should block anything just because the penultimate block cannot reach the minimum replication. To me this is similar with the scenario that one block of the file is missing/corrupted (even if the min replication is 1). For append case since we do not append data directly to the penultimate block thus I think  should be ok.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T20:04:18.209+0000","updated":"2014-11-17T20:04:57.092+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14215345","id":"14215345","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"HI Jing,\n\nThanks for your comments.\n\nThere are multiple issues here:\n\n1. The bug in the loop code of the checkLeases method that it doesn't move on to next entry\n2. The case when penultimate block is COMMITTED and last block is COMPLETE,\n3. The case when penultimate block is COMPLETE and the last block is COMMITTED,\n\nObservations about these issues:\n\nIssue 1 is addressed by the uploaded patch so far.\n\nIssue 3 is handled by existing code by throwing an exception (senario#2 in my earlier comments), and then the leaseManager goes ahead recover the lease right away, even if the last block may not have minimal replica. I raised a concern about this earlier: what happens if the minimal replica is 1, which means no replica for the last block, and another client acquires the lease and tries to APPEND to the file. I mean, where (datanode, replica position) the client should write to? \n\nIssue 2, we can move on and let the penultimate block to finish it self, if it finishes meeting the minimal replication requirement, that's nice, if not, it's considered a corrupted block. As Colin/Jing suggested.\n\nSo it boils down to issue 3, did I misunderstand it? is this a real issue? \n\nThanks.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T22:59:06.659+0000","updated":"2014-11-17T22:59:06.659+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14215445","id":"14215445","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"HI Ravi,\n\nI looked at the log you posted at https://issues.apache.org/jira/browse/HDFS-7342?focusedCommentId=14209022&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14209022, they appear to very much the same as I observed in the case I was looking at:\n\n{code}\n2014-10-28 02:28:17,568 INFO org.apache.hadoop.hdfs.server.namenode.LeaseManager: [Lease.  Holder: DFSClient_attempt_X_Y_r_T_U_V_W, pendingcreates: 1] has expired hard limit\n2014-10-28 02:28:17,569 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem: Recovering [Lease.  Holder: DFSClient_attempt_X_Y_r_T_U_V_W, pendingcreates: 1], src=<FILENAME>\n2014-10-28 02:28:17,569 INFO org.apache.hadoop.hdfs.server.namenode.LeaseManager: [Lease.  Holder: DFSClient_attempt_X_Y_r_T_U_V_W, pendingcreates: 1] has expired hard limit\n2014-10-28 02:28:17,569 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem: Recovering [Lease.  Holder: DFSClient_attempt_X_Y_r_T_U_V_W, pendingcreates: 1], src=<FILENAME>\n......\n{code}\n\nHI [~jingzhao],\n{quote}\n I do not think we should block anything just because the penultimate block cannot reach the minimum replication.\n{quote}\nFor the quoted statement from you above, I agree with you on that for penultimate block because no one is going to write to the penultimate block.  However, when I studied the implementation, I had the question about issue 3 in my last comment about the last block. Basically if the last block doesn't have a replica reported from DN yet, and the lease is recovered immediately, how do we handle a consequent APPEND write from another client to this file?  It seems to me that we should at least wait for some iterations for more block reports before recovering the lease, instead of just recovering the lease immediately. \n\nI'd appreciate if you could comment on that. \n\nThanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-17T23:58:53.777+0000","updated":"2014-11-17T23:58:53.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14215486","id":"14215486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"For the scenario 3 I think we can keep the current behavior when handling append. Currently our default \"replace-datanode-on-failure\" policy already considers the data durability while appending. Also the leaseManager in NN waits for the lease to expire before triggering the recovery.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-18T00:32:33.588+0000","updated":"2014-11-18T00:32:33.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14215540","id":"14215540","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Jing. \n\nSure, we can keep the old behaviour for scenario#3. However, I am just not sure where the data will be written to when the new client tries to append to the file whose last block doesn't even have one replica. That seems a bug to me. This is just my speculation. We could address this in a different jira though.\n\nThat said, for the current patch, we still need to fix here:\n\n{code}\n   switch(lastBlockState) {\n    case COMPLETE:\n      assert false : \"Already checked that the last block is incomplete\";\n      break;\n{code}\nThe above code does {{asser false  \"Already checked that the last block is incomplete\"}}, which is wrong, it should not assert false, because this is a valid case when penultimate block is COMMITTED and last block is COMPLETE. Right?\n\nThanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-18T01:14:44.336+0000","updated":"2014-11-18T01:14:44.336+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14215703","id":"14215703","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"HI Jing,\n\nI gave some more thoughts on the block of code I quoted in my last comment, I think some additional change is still needed to ensure the lease is recovered for the case  when penultimate block is COMMITTED and last block is COMPLETE (call it caseX below), in addition to the {{assert false}} I talked about in my last comment. Commented below.\n\nHi Ravi,\n\nI did a review of your latest patch (v4), and have the following comments. Most important one is, even though the infinite loop is removed by the patch, the lease for caseX is still not released, if the penultimate block stays in COMMITTED state. We should release the lease here.\n\n* The change in LeaseManager looks good to me. There is an option not to make this change it if we do below.\n* For caseX, to make sure the lease is released, we need to do something like below\n{code}\n   boolean penultimateBlockMinReplication = penultimateBlock == null ? true :\n        blockManager.checkMinReplication(penultimateBlock);\n   BlockUCState penultimateBlockState = penultimateBlock == null ?  BlockUCState.COMPLETE:\n        penultimateBlock.getBlockUCState();\n   String blockStateStr;\n   ......\n    case COMPLETE:\n    case COMMITTED:\n      blockStateStr =  + \"(penultimateBlockState=\" + penultimateBlockState + \" lastBlockState=\"+lastBlockState + \")\";\n      // Close file if committed blocks are minimally replicated\n      if(penultimateBlockMinReplication &&\n          blockManager.checkMinReplication(lastBlock)) {\n        finalizeINodeFileUnderConstruction(src, pendingFile,\n            iip.getLatestSnapshotId());\n        NameNode.stateChangeLog.warn(\"BLOCK*\"\n          + \" internalReleaseLease: Committed blocks are minimally replicated,\"\n          + \" lease removed, file closed \"\n          + blockStateStr);\n        return true;  // closed!\n      }\n      // Cannot close file right now, since some blocks \n      // are not yet minimally replicated.\n      // This may potentially cause infinite loop in lease recovery\n      // if there are no valid replicas on data-nodes.\n      String message = \"DIR* NameSystem.internalReleaseLease: \" +\n          \"Failed to release lease for file \" + src +\n          \". Committed blocks are waiting to be minimally replicated \" +\n          blockStateStr + \", Try again later.\";\n      NameNode.stateChangeLog.warn(message);\n      throw new AlreadyBeingCreatedException(message);\n{code}\n\nBasically I suggest to let the two cases to share the same code, and included both block's state in the message to distinguish, this handles the different scenarios like below.\n\n||  || BlockState || BlockState || BlockState ||BlockState || BlockState || BlockState ||\n|penultimateBlock | COMPLETE |COMMITTED|COMMITTED|COMPLETE |COMMITTED|COMMITTED|\n|lastBlock|COMMITTED|COMMITTED | COMPLETE|COMMITTED|COMMITTED | COMPLETE|\n|minReplicaSatisfied|Yes|Yes|Yes|No|No|No|\n| Solution|CloseFile+ReleaseLease|CloseFile+ReleaseLease|CloseFile+ReleaseLease|ReleaseLease|ReleaseLease|ReleaseLease|\n \nDo you and other folks think my proposal makes sense? Thanks a lot.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-18T04:42:48.242+0000","updated":"2014-11-18T04:42:48.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14216573","id":"14216573","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Yongjun!\n\nThanks for your detailed analysis. I am trying to create a unit test where the penultimate block would be COMMITTED and the last block COMPLETE. I intend to upload that patch to HDFS-7342. I think we should eliminate the possibility of the infinite loop in LeaseManager regardless. Which JIRAs we use is now irrelevant since this will likely not make 2.6.0 ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-18T18:42:44.820+0000","updated":"2014-11-18T18:42:44.820+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14216738","id":"14216738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ravi,\n\nI think it's ok to separate into two issues to solve here. The latest patch for HDFS-4882 does resolve the infinite loop one (except the lease may still be hanging there).\n\nWhen you work on HDFS-7342, if you can create a test case for \"penultimate block would be COMMITTED and the last block COMPLETE\", I would encourage you to also create some other cases for different state combination listed in the able in my last comment. Appreciate it very much! \n\nHi [~cmccabe],  thanks for reviewing Ravi's patch here, I think it's in good shape to solve the infinite loop. Would you please help looking at it and and committing it? Other folks welcome to comment.\n\nThanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-18T20:26:57.814+0000","updated":"2014-11-18T20:26:57.814+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14216811","id":"14216811","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Yongjun! That's a great suggestion. I'll do that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-18T21:22:21.505+0000","updated":"2014-11-18T21:22:21.505+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14217161","id":"14217161","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"I have uploaded a unit test on HDFS-7342. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-19T00:42:37.888+0000","updated":"2014-11-19T00:42:37.888+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14217198","id":"14217198","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Many thanks Ravi! I will try it out.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-19T01:14:20.798+0000","updated":"2014-11-19T01:14:20.798+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14217289","id":"14217289","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"HI Ravi,\n\nGreat work, I can see your test reproduced the issue! \n\nWhile I tried to see if my proposed fix at \nhttps://issues.apache.org/jira/browse/HDFS-4882?focusedCommentId=14215703&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14215703\nsolve the problem, I found that \n{code}\n finalizeINodeFileUnderConstruction(src, pendingFile,\n            iip.getLatestSnapshotId());\n{code}\ndoes a precondition check that all blocks should be complete. I wonder whether this branch of code has ever been exercised.\n\nWill poke a bit more.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-19T02:19:14.511+0000","updated":"2014-11-19T02:19:14.511+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14218090","id":"14218090","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"For other folks' info, since we are dedicating this jira to address the infinite loop issue, Ravi and I are continuing the discussion  about the solution for the lease recovery issue in HDFS-7342 now. Thanks.\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-19T16:30:41.486+0000","updated":"2014-11-19T16:30:41.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14219030","id":"14219030","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. For other folks' info, since we are dedicating this jira to address the infinite loop issue, Ravi and I are continuing the discussion about the solution for the lease recovery issue in HDFS-7342 now. Thanks.\n\nThat makes sense to me.\n\n{code}\n131\t    }\n132\t      LOG.info(\"Number of blocks under construction: \" + numUCBlocks);\n133\t      return numUCBlocks;\n{code}\nThe indentation is off here.\n\nCan we somehow issue a warning if these leases are lingering?  The current patch makes the {{LeaseManager}} silently accept the extra leases, which I don't think is quite what we want.  Perhaps right before {{return needSync}} we could insert a check that the lease we were last considering was the \"first\" lease by sort order, and {{LOG.warn}} a message if it wasn't.  This way we would know that something was messed up when leases lingered forever.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T05:38:21.848+0000","updated":"2014-11-20T05:38:21.848+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14219599","id":"14219599","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot [~cmccabe], good comments!\n\nHi [~raviprak], many thanks for your earlier work.\n\nWithout adding the warn message Colin suggested, there will still be a message reported every 2 seconds like \"Recovering lease...\" when the lease can't be released, but adding the warn message would help us identify a similar issue easier.\n\nThis is a quite urgent issue for the case I was looking at, I'd really appreciate that you could address Colin's comments at your earliest convenience. Thanks!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T17:17:48.111+0000","updated":"2014-11-20T17:17:48.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14219677","id":"14219677","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Colin and Yongjun! Thanks a lot for your reviews and comments. Here's a patch incorporating your suggestion.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T18:00:54.261+0000","updated":"2014-11-20T18:00:54.261+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14219746","id":"14219746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ravi,\n\nThanks for responding quickly!\n\nI looked at the change, a minor suggestion:\n{code}\n470\t        if(leaseToCheck != sortedLeases.first()) {\n471\t          LOG.warn(\"Unable to release the oldest lease: \" + sortedLeases.first());\n472\t        }\n{code}\nthe lease that can not be released may not be the oldest in the loop. Maybe we can change to \"Unable to release hard-limit expired lease: \" to be more accurate. On the other hand, all older leases are released already in this checkReleases() run, this un-released lease will be the oldest lease 2 seconds later:-) \n\nAnother thought is, in each checkLeases run, there might be multiple leases that can not be released, we only WARN one here with your latest change. If we replace the above code with a loop to check not only the first, but also the second, the third, until it hits leaseToCheck, then we are able to report all leases that are not released. Just a thought, not necessarily we have to do it in this jira, because having one is already a good indicator, and we do have the report every 2 second for all leases we attempt to release. \n\nHi Colin: further comments?\n\nThanks.\n\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T18:37:33.475+0000","updated":"2014-11-20T18:37:33.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14219919","id":"14219919","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Yongjun!\nsortedLeases is modified while iterating through the loop. So the sortedLease.first() is necessarily the oldest lease and if leaseToCheck != sortedLeases.first(), then it means we are looking to release a lease younger than the oldest.\nI thought about logging all the leases which couldn't be released, but considering that we expect this to be a rare occurrence, I didn't see the cost-benefit in that extra code which will probably never run","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T20:14:52.864+0000","updated":"2014-11-20T20:14:52.864+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14219936","id":"14219936","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"HI Ravi,\n\nI agree that we don't really need to WARN all the leases.\n\nWhat I meant by \"it may not be the oldest\" is, in each run of checkReleases (which happens every 2 seconds), the first (and the real oldest in this loop) lease examined in the loop can be released and removed from sortedLease, then we move on to next item in the sortedLease. In that sense, a un-released lease may not be the oldest among all the leases examined in this loop.\n\nThanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T20:22:01.544+0000","updated":"2014-11-20T20:22:01.544+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220013","id":"14220013","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:green}+1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12682699/HDFS-4882.5.patch\n  against trunk revision a9a0cc3.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8789//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8789//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-20T21:17:15.307+0000","updated":"2014-11-20T21:17:15.307+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220108","id":"14220108","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Yongjun! Thanks for your explanation. I see your point. Here's a patch with your suggested fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T22:12:02.684+0000","updated":"2014-11-20T22:12:02.684+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220198","id":"14220198","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ravi, many thanks for addressing Colin's and my comments quickly! \n\nHi [~cmccabe], the latest patch looks good to me. Would you please help taking a further look? thanks a lot.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-20T23:18:19.812+0000","updated":"2014-11-20T23:18:19.812+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220255","id":"14220255","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:red}-1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12682760/HDFS-4882.6.patch\n  against trunk revision eb4045e.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:red}-1 core tests{color}.  The test build failed in hadoop-hdfs-project/hadoop-hdfs \n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8796//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8796//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-20T23:53:10.266+0000","updated":"2014-11-20T23:53:10.266+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220438","id":"14220438","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Sorry Ravi, after thinking a bit more, I think there is still a hole here,\n\nIf the sortedLease has a single one, and it's not able to releaes, the the code below won't reach, and the WARN won't be printed out.\n{code}\n470\t        if(leaseToCheck != sortedLeases.first()) {\n471\t          LOG.warn(\"Unable to release hard-limit expired lease: \"\n472\t            + sortedLeases.first());\n473\t        }\n{code}\nI think we should move this code to the very bottom of the method, to before it returns:\n{code}\nif (leaseToCheck != sortedLeases.first()) {\n          LOG.warn(\"Unable to release hard-limit expired lease: \"\n\t            + sortedLeases.first());\n}\nreturn needSync;\n{code}\nIf sortedLease is empty, leaseToCheck would be null, so we are good;\nif sortedLeaes has only one item which can't be released, leaseCheck should be assigned to null at the end of the loop, we are good too.\nOthercases should be covered too.\n\nRight?\n\nThanks.\n\n\n\n\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-21T03:05:00.970+0000","updated":"2014-11-21T03:05:00.970+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220473","id":"14220473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"And replace the {{return needSync;}} inside the loop with {{break;}}.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-21T03:36:33.748+0000","updated":"2014-11-21T03:36:33.748+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220617","id":"14220617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"body":"Hi [~wuzesheng], [~raviprak] and [~yzhangal],\n\nAccording to description, Have you able to reproduce the infinite loop in checkLeases() ? either in real cluster or using debug points in test ?\n\n\nBecause, when I tried to reproduce, I was able to get the BlockStates, COMMITTED and COMPLETED for penultimate and last blocks respectively, But not infinite loop of checkLeases()\n\nAfter client shutdown, when the checkLeases() triggers, it will start block recovery for the last block. This last block recovery will indeed Succeed, but fails in {{commitBlockSynchronization()}} while closing the file due to illegal state of penultimate block. \n{noformat}java.lang.IllegalStateException: Failed to finalize INodeFile hardLeaseRecoveryFuzzy since blocks[0] is non-complete, where blocks=[blk_1073741825_1003{UCState=COMMITTED, primaryNodeIndex=-1, replicas=[ReplicaUC[[DISK]DS-099f5e9f-cc0b-4c63-a823-7640471d08e2:NORMAL:127.0.0.1:57247|RBW]]}, blk_1073741828_1007].\n\tat com.google.common.base.Preconditions.checkState(Preconditions.java:172)\n\tat org.apache.hadoop.hdfs.server.namenode.INodeFile.assertAllBlocksComplete(INodeFile.java:214)\n\tat org.apache.hadoop.hdfs.server.namenode.INodeFile.toCompleteFile(INodeFile.java:201)\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.finalizeINodeFileUnderConstruction(FSNamesystem.java:4650)\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.closeFileCommitBlocks(FSNamesystem.java:4865)\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.commitBlockSynchronization(FSNamesystem.java:4829)\n\tat org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.commitBlockSynchronization(NameNodeRpcServer.java:739){noformat}\n\nSince {{commitBlockSynchronization()}} call removes the lease  in {{finalizeINodeFileUnderConstruction()}} before trying to close the file, {{checkLeases()}} will not go into infinite loop. May be it will loop till  {{commitBlockSynchronization()}} call comes after recovery of last block.\n{code}  private void finalizeINodeFileUnderConstruction(String src,\n      INodeFile pendingFile, int latestSnapshot) throws IOException,\n      UnresolvedLinkException {\n    assert hasWriteLock();\n\n    FileUnderConstructionFeature uc = pendingFile.getFileUnderConstructionFeature();\n    Preconditions.checkArgument(uc != null);\n    leaseManager.removeLease(uc.getClientName(), src);{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"created":"2014-11-21T07:12:49.259+0000","updated":"2014-11-21T07:16:02.817+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220630","id":"14220630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"HI [~vinayrpet],\n\nThanks a lot for looking into. Ravi wrote a testcase in  HDFS-7342 that reproduce the infinite loop. I'm seeing the same kind of infinite loop in a case here too.\n\nFor your case, did you check whether you run exercised the code\n{code}\n   switch(lastBlockState) {\n    case COMPLETE:\n      assert false : \"Already checked that the last block is incomplete\";\n      break;\n{code}\nin  {{ FSNamesystem#internalReleaseLease()}}?\n\nIf LeaseManager found that the hard limit for the file lease expired, and when the above code is exercised (that means penultimateBlock is COMMITTED and lastBlock is COMPLETE), it causes an infinite loop in {{LeaseManager#checkLeases}}.\n\nThanks.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-21T07:41:46.931+0000","updated":"2014-11-21T07:41:46.931+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220680","id":"14220680","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"[~yzhangal]: I agree, we should fix the {{LOG.warn(\"Unable to release hard-limit expired lease ...}} code a bit.  I agree with the idea of replacing the {[return}} in the loop body with a {{break}}, and putting the LOG at the end.  One way of looking at this is that we're trying to enforce the invariant that if there are any leases left at the end of the function, they should be unexpired leases.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-21T08:43:26.370+0000","updated":"2014-11-21T08:43:26.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14220705","id":"14220705","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"body":"Test added in HDFS-7342 is not the real test. blocks states are set from the testcode itself.\nNot occured on operation. {{lm.setLeasePeriod(0, 0);}} is the one which will lead to infinite loop in that testcode.\n\nHere are the following sequence of operations happens on lease recovery on hard limit expiry.\n1. Last block will be in *UNDER_CONSTRUCTION or UNDER_RECOVERY* state initially, since the block is not full and also file is not closed yet.\n2. Check the block states, if last block is in UNDER_CONSTRUCTION/UNDER_RECOVERY state, then *re-assign* the lease with \"HDFS-Namenode\". Here original expired lease will be removed and Fresh \"HDFS-Namenode\" will be added. Note that *This lease is not expired*.\n3. Queues the block to be recovered in primary datanode.\n4. In LeaseManager, {{sortedLeases}} will have \"HDFS-Namenode\" lease instead of the original expired lease. *So checkLeases() will not enter infinite loop*\n5. Now {{commitBlockSynchronization()}} after recovery of the last block, *will make the last block COMPLETED,  removes the lease*, but fails to close the file because of not meeting min replication for penultimate block.\nSince the lease is removed already, checkLeases() will not enter infinite loop.\n\nInterestingly, I tried restart of Namenode after above steps, then while loading edits, all blocks except last block will be treated as COMPLETE.\nSo penultimate block was in COMPLETE state.\nHence Leaserecovery was successfull for the same file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"created":"2014-11-21T09:11:26.989+0000","updated":"2014-11-21T09:12:52.551+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14221046","id":"14221046","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~cmccabe]  and [~vinayrpet] for the review and further look.\n\nHI Vinayakumar, \n\nYes, the testcase Ravi created in HDFS-7342 is a bit artificial, but it helps to reproduce the infinite loop case we are dealing with here. Setting the leasePeriod  to 0 is just to trigger the lease recovery thus the infinite loop in this test.\n\nThe steps you described appear to be a different scenario than what we are addressing in this jira. The case here is that the lastBlock is already in COMPELTE state when the hard lease limit expires. Your case is that the last block is not yet in COMPLETE state. When the last block is in  *UNDER_CONSTRUCTION or UNDER_RECOVERY* state, it's handled differently in {{FSNamesystem#internalReleaseLease}}, as you described,  I believe that's why you don't see the infinitely loop.\n\nWhat you described is an interesting case too though. for the failure in step 5 you described, would you please create a different jira for your case? Thanks.\n \nHI [~raviprak], would you please help addressing my earlier comments that Colin agreed upon? thanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-21T15:40:18.865+0000","updated":"2014-11-21T15:40:18.865+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14221140","id":"14221140","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Great catch Yongjun! Thanks a lot for your reviews! Here's a patch with the fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-21T17:21:16.940+0000","updated":"2014-11-21T17:21:16.940+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14221393","id":"14221393","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"{color:green}+1 overall{color}.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12682913/HDFS-4882.7.patch\n  against trunk revision c298a9a.\n\n    {color:green}+1 @author{color}.  The patch does not contain any @author tags.\n\n    {color:green}+1 tests included{color}.  The patch appears to include 1 new or modified test files.\n\n    {color:green}+1 javac{color}.  The applied patch does not increase the total number of javac compiler warnings.\n\n    {color:green}+1 javadoc{color}.  There were no new javadoc warning messages.\n\n    {color:green}+1 eclipse:eclipse{color}.  The patch built with eclipse:eclipse.\n\n    {color:green}+1 findbugs{color}.  The patch does not introduce any new Findbugs (version 2.0.3) warnings.\n\n    {color:green}+1 release audit{color}.  The applied patch does not increase the total number of release audit warnings.\n\n    {color:green}+1 core tests{color}.  The patch passed unit tests in hadoop-hdfs-project/hadoop-hdfs.\n\n    {color:green}+1 contrib tests{color}.  The patch passed contrib unit tests.\n\nTest results: https://builds.apache.org/job/PreCommit-HDFS-Build/8801//testReport/\nConsole output: https://builds.apache.org/job/PreCommit-HDFS-Build/8801//console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-21T20:37:48.876+0000","updated":"2014-11-21T20:37:48.876+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14221458","id":"14221458","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Ravi, many thanks for the new rev!  It looks good to me. \n\n\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-21T21:28:18.069+0000","updated":"2014-11-21T21:28:18.069+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14222629","id":"14222629","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~vinayrpet],\n\nThis change makes the code more robust because it avoids going into an infinite loop in the case where the lease is not removed from {{LeaseManager#leases}} during the loop body.  The change doesn't harm anything... things are just as efficient as before, and in the unlikely case that we can't remove the lease, we log a warning message so we are aware of the problem.\n\nWhy don't we continue the discussion about the sequence of operations that could trigger this over on HDFS-7342?  And commit this in the meantime to fix the immediate problem for [~raviprak].  I am +1, any objections to committing this tomorrow?\n\nAlso, [~yzhangal], can you comment on whether you have also observed this bug?  Vinayakumar seems to be questioning whether this loop can occur, but I thought you had seen the LeaseManager thread loop in the field... I apologize if I'm putting words in your mouth, though.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-24T03:59:13.200+0000","updated":"2014-11-24T03:59:13.200+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14222680","id":"14222680","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"body":"bq. This change makes the code more robust because it avoids going into an infinite loop in the case where the lease is not removed from LeaseManager#leases during the loop body. The change doesn't harm anything... things are just as efficient as before, and in the unlikely case that we can't remove the lease, we log a warning message so we are aware of the problem\nYes, you are right. Even though I don't see the possibility of infinite loop by considering existing code in trunk, changes made in the patch looks pretty cool.\n\nI am +1 for the change.\n\n{quote}Why don't we continue the discussion about the sequence of operations that could trigger this over on HDFS-7342? And commit this in the meantime to fix the immediate problem for Ravi Prakash. I am +1, any objections to committing this tomorrow?\nAlso, Yongjun Zhang, can you comment on whether you have also observed this bug? Vinayakumar seems to be questioning whether this loop can occur, but I thought you had seen the LeaseManager thread loop in the field... I apologize if I'm putting words in your mouth, though.{quote}\nYes, lets continue this discussion in HDFS-7342","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vinayrpet","name":"vinayrpet","key":"vinayrpet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vinayakumar B","active":true,"timeZone":"Asia/Kolkata"},"created":"2014-11-24T05:26:15.471+0000","updated":"2014-11-24T05:26:15.471+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14222737","id":"14222737","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~cmccabe] and  [~vinayrpet],\n\nThanks for your comments.\n\n{quote}\n can you comment on whether you have also observed this bug?\n{quote}\nYes, I did observe a similar infinite loop, and by studying the code, I concluded that the case I was looking at has exactly the same root cause as the one reported here. Please see details described in my earlier comment at https://issues.apache.org/jira/browse/HDFS-4882?focusedCommentId=14213992&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-14213992, the several comments after that.\n\nIn short, when the penultimate block is COMMITTED and the last block is COMPLETE, the following block of code will be executed\n{code}\n   switch(lastBlockState) {\n    case COMPLETE:\n      assert false : \"Already checked that the last block is incomplete\";\n      break;\n{code}\nand return back to LeaseManager without releasing the corresponding lease, which stays as the first element in {{sortedLeases}}. The leaseManager keeps examining the first entry in sortedLease again and again, while holding the FSNamesystem#writeLock, thus causing the infinite loop.\n\n{quote}\nYes, you are right. Even though I don't see the possibility of infinite loop by considering existing code in trunk, changes made in the patch looks pretty cool.\n{quote}\nSee above for the explanation about infinite loop in the existing code.\n\n{quote}\nYes, lets continue this discussion in HDFS-7342\n{quote}\nIn HDFS-7342, Ravi worked out a testcase to demonstrate the problem and I suggested a solution. Thanks in advance for your review and comments there. Hope we can get to a converged solution soon. Since avoiding infinite loop is just part of the complete solution, and the other part is to get the lease released,  which is what HDFS-7342 tries to address.\n\nThanks.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-24T07:19:10.703+0000","updated":"2014-11-24T07:19:10.703+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14223297","id":"14223297","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"Committed to branch-2.7 and trunk.  Thanks, guys.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-24T18:56:36.303+0000","updated":"2014-11-24T18:56:36.303+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14223306","id":"14223306","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Hadoop-trunk-Commit #6593 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6593/])\nHDFS-4882. Prevent the Namenode's LeaseManager from looping forever in checkLeases (Ravi Prakash via Colin P. McCabe) (cmccabe: rev daacbc18d739d030822df0b75205eeb067f89850)\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/LeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestLeaseManager.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-24T19:02:22.475+0000","updated":"2014-11-24T19:02:22.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14223387","id":"14223387","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks a lot Colin, Yongjun and everyone else. Could we please put this in branch-2.6 as well so that if there is a 2.6.1, this patch makes it into there?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=raviprak","name":"raviprak","key":"raviprak","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=raviprak&avatarId=10113","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=raviprak&avatarId=10113","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=raviprak&avatarId=10113","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=raviprak&avatarId=10113"},"displayName":"Ravi Prakash","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-24T19:41:27.542+0000","updated":"2014-11-24T19:41:27.542+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14223399","id":"14223399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"Good idea.  Backported to 2.6.1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-24T19:45:20.948+0000","updated":"2014-11-24T19:45:20.948+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14223411","id":"14223411","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Hadoop-trunk-Commit #6595 (See [https://builds.apache.org/job/Hadoop-trunk-Commit/6595/])\nCHANGES.txt: add HDFS-4882 (cmccabe: rev 6970dbf3669b2906ea71c97acbc5a0dcdb715283)\n* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-24T19:51:21.803+0000","updated":"2014-11-24T19:51:21.803+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14223630","id":"14223630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Many thanks to Ravi for working on the solution, Colin and other folks for reviewing and committing the patch.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-11-24T22:16:15.530+0000","updated":"2014-11-24T22:16:15.530+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14224361","id":"14224361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Hadoop-Yarn-trunk #754 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk/754/])\nHDFS-4882. Prevent the Namenode's LeaseManager from looping forever in checkLeases (Ravi Prakash via Colin P. McCabe) (cmccabe: rev daacbc18d739d030822df0b75205eeb067f89850)\n* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestLeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/LeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java\nCHANGES.txt: add HDFS-4882 (cmccabe: rev 6970dbf3669b2906ea71c97acbc5a0dcdb715283)\n* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-25T10:42:15.821+0000","updated":"2014-11-25T10:42:15.821+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14224371","id":"14224371","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Hadoop-Yarn-trunk-Java8 #16 (See [https://builds.apache.org/job/Hadoop-Yarn-trunk-Java8/16/])\nHDFS-4882. Prevent the Namenode's LeaseManager from looping forever in checkLeases (Ravi Prakash via Colin P. McCabe) (cmccabe: rev daacbc18d739d030822df0b75205eeb067f89850)\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java\n* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestLeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/LeaseManager.java\nCHANGES.txt: add HDFS-4882 (cmccabe: rev 6970dbf3669b2906ea71c97acbc5a0dcdb715283)\n* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-25T10:43:01.303+0000","updated":"2014-11-25T10:43:01.303+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14224590","id":"14224590","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Hadoop-Hdfs-trunk #1944 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk/1944/])\nHDFS-4882. Prevent the Namenode's LeaseManager from looping forever in checkLeases (Ravi Prakash via Colin P. McCabe) (cmccabe: rev daacbc18d739d030822df0b75205eeb067f89850)\n* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestLeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/LeaseManager.java\nCHANGES.txt: add HDFS-4882 (cmccabe: rev 6970dbf3669b2906ea71c97acbc5a0dcdb715283)\n* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-25T14:21:21.487+0000","updated":"2014-11-25T14:21:21.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14224599","id":"14224599","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"SUCCESS: Integrated in Hadoop-Hdfs-trunk-Java8 #16 (See [https://builds.apache.org/job/Hadoop-Hdfs-trunk-Java8/16/])\nHDFS-4882. Prevent the Namenode's LeaseManager from looping forever in checkLeases (Ravi Prakash via Colin P. McCabe) (cmccabe: rev daacbc18d739d030822df0b75205eeb067f89850)\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/LeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java\n* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestLeaseManager.java\nCHANGES.txt: add HDFS-4882 (cmccabe: rev 6970dbf3669b2906ea71c97acbc5a0dcdb715283)\n* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-25T14:22:40.524+0000","updated":"2014-11-25T14:22:40.524+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14224691","id":"14224691","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Hadoop-Mapreduce-trunk-Java8 #16 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk-Java8/16/])\nHDFS-4882. Prevent the Namenode's LeaseManager from looping forever in checkLeases (Ravi Prakash via Colin P. McCabe) (cmccabe: rev daacbc18d739d030822df0b75205eeb067f89850)\n* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestLeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/LeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java\nCHANGES.txt: add HDFS-4882 (cmccabe: rev 6970dbf3669b2906ea71c97acbc5a0dcdb715283)\n* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-25T15:37:10.108+0000","updated":"2014-11-25T15:37:10.108+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14224704","id":"14224704","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"FAILURE: Integrated in Hadoop-Mapreduce-trunk #1968 (See [https://builds.apache.org/job/Hadoop-Mapreduce-trunk/1968/])\nHDFS-4882. Prevent the Namenode's LeaseManager from looping forever in checkLeases (Ravi Prakash via Colin P. McCabe) (cmccabe: rev daacbc18d739d030822df0b75205eeb067f89850)\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/FSNamesystem.java\n* hadoop-hdfs-project/hadoop-hdfs/src/test/java/org/apache/hadoop/hdfs/server/namenode/TestLeaseManager.java\n* hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/LeaseManager.java\nCHANGES.txt: add HDFS-4882 (cmccabe: rev 6970dbf3669b2906ea71c97acbc5a0dcdb715283)\n* hadoop-hdfs-project/hadoop-hdfs/CHANGES.txt\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-25T15:40:37.412+0000","updated":"2014-11-25T15:40:37.412+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12651089/comment/14945658","id":"14945658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vganji","name":"vganji","key":"vganji","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Venkata Ganji","active":true,"timeZone":"America/Los_Angeles"},"body":"Hello [~yzhangal], [~raviprak] ,Can you guys point me to a procedure for reproducing this issue at physical cluster level, please?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vganji","name":"vganji","key":"vganji","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Venkata Ganji","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-10-06T19:58:17.896+0000","updated":"2015-10-06T19:58:17.896+0000"}],"maxResults":90,"total":90,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-4882/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1l6b3:"}}