{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13031631","self":"https://issues.apache.org/jira/rest/api/2/issue/13031631","key":"HDFS-11285","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-01-03T17:45:03.001+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Mar 13 20:22:48 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-11285/watchers","watchCount":6,"isWatching":false},"created":"2017-01-03T10:46:01.885+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12331979","id":"12331979","description":"2.7.1 release","name":"2.7.1","archived":false,"released":true,"releaseDate":"2015-07-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-03-13T20:22:48.749+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"We have seen the use case of decommissioning DataNodes that are already dead or unresponsive, and not expected to rejoin the cluster. In a large cluster, we met more than 100 nodes were dead, decommissioning and their {{Under replicated blocks}} {{Blocks with no live replicas}} were all ZERO. Actually It has been fixed in [HDFS-7374|https://issues.apache.org/jira/browse/HDFS-7374]. After that, we can refreshNode twice to eliminate this case. But, seems this patch missed after refactor[HDFS-7411|https://issues.apache.org/jira/browse/HDFS-7411]. We are using a Hadoop version based 2.7.1 and only below operations can transition the status from {{Dead, DECOMMISSION_INPROGRESS}} to {{Dead, DECOMMISSIONED}}:\n# Retire it from hdfs-exclude\n# refreshNodes\n# Re-add it to hdfs-exclude\n# refreshNodes\n\nSo, why the code removed after refactor in the new DecommissionManager?\n{code:java}\nif (!node.isAlive) {\n  LOG.info(\"Dead node \" + node + \" is decommissioned immediately.\");\n  node.setDecommissioned();\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12845974","id":"12845974","filename":"DecomStatus.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-06T08:56:22.639+0000","size":52630,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12845974/DecomStatus.png"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Dead DataNodes keep a long time in (Dead, DECOMMISSION_INPROGRESS), and never transition to (Dead, DECOMMISSIONED)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15795630","id":"15795630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~cltlfcjin], that code wasn't removed by the HDFS-7411 refactor, it was moved into HeartbeatManager by HDFS-7725. There's also TestDecommissionStatus#testDecommissionDeadDN which tests this case.\n\nCould you provide a unit test that reproduces your issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-03T17:45:03.001+0000","updated":"2017-01-03T17:45:03.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15800224","id":"15800224","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks [~andrew.wang], I'm not sure whether or not our case is a common one. We have an upper layer application which trigger and monitor the decommissioning progress. When it finds the \"Blocks with no live replicas\" becoming 0 in the NN UI, it will shutdown the DN. Why not wait for being transited to decommissioned, because that sometimes we found decommissioning progress took very much time which there were only one or two \"Under replicated blocks\" left.\n\nSo, after none of  \"Blocks with no live replicas\", the DN is shutdown. And its status become [Dead, Decommissioning] forever. Therefore, I need to run the four steps mentioned above to retire them.\n\nIn the code of HeartbeatManager and DecommissionManager.\n{code}\nif (!node.isDecommissionInProgress() && !node.isDecommissioned()) {\n      // Update DN stats maintained by HeartbeatManager\n      hbManager.startDecommission(node);\n{code}\nOnly [Dead, Normal] status can be set [Dead, Decommissioned] directly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-05T03:58:30.285+0000","updated":"2017-01-05T03:58:30.285+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15802046","id":"15802046","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"Ah. So the issue is that there is a DN that still has a few blocks waiting for decom (probably RBW blocks from an open file), and it transitions from (Live, Decomming) to (Dead, Decomming), not (Dead, Decommed). We don't immediately transition to (Dead, Decommed) since that could lead to unintentional dataloss. If an operator wants to override this for a dead node, then they can run your procedure.\n\nQuestion, do these nodes truly *never* transition to (Dead, Decommed) ? Once the straggler blocks are closed and minimally replicated, (Dead, Decomming) should transition to (Dead, Decommed).\n\nOtherwise, I'm guessing the straggler blocks are caused by open-for-write files. Fixing that is more work; we could force the writing clients to do pipeline recovery to route off the decomming nodes to maintain minimal replication.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-05T17:58:52.848+0000","updated":"2017-01-05T17:58:52.848+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15804074","id":"15804074","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"I create a graph to illustrate !DecomStatus.png|thumbnail!  \nA normal process of decommission should be \"1->2->3->6\". My case is \"1->2->5\" and adding \"->4->6\" to fix it. So should the transition \"5->6\" directly be needed?  \n\nAnd your question, yes. And it appears frequently under the management of upper layer application in Version 2.7.1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-06T09:11:47.698+0000","updated":"2017-01-06T09:11:47.698+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15806306","id":"15806306","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for the diagram, that's something we should put as a code comment in DecommissionManager :)\n\nLike you say, it looks like we don't have a 5->6 transition. BlockManager#isNodeHealthyForDecommissionOrMaintenance requires the node to be alive, and actually will log a WARN with the procedure you've been running with 5->4->6. So at least it seems like this behavior is intentional.\n\nI'm betting though that the straggler blocks on the DN are caused by open-for-write files though, and I'd prefer to solve that problem rather than adding a 5->6 transition. Could you run {{hdfs fsck}} with {{-openforwrite}} and {{-files -blocks -locations}} to confirm? Also check in the NN logs since we should be printing information about what blocks are preventing decommissioning.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-07T00:41:35.770+0000","updated":"2017-01-07T00:41:35.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15810888","id":"15810888","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks [~andrew.wang], Sure, I will disable shutdown function in upper application to see if there are some open-for-write files in the result of fsck next time the decommissioning in process happening with a long time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-09T07:10:16.620+0000","updated":"2017-01-09T07:10:16.620+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15814361","id":"15814361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"Yes, you are right. The block is open for write. [~andrew.wang].\n{code}\n2017-01-10 01:43:09,906 DEBUG org.apache.hadoop.hdfs.server.blockmanagement.DecommissionManager: Processing decommission-in-progress node 10.103.58.19:50010\n2017-01-10 01:43:09,906 TRACE org.apache.hadoop.hdfs.server.blockmanagement.DecommissionManager: Block blk_4280405944_1106180180519{UCState=UNDER_CONSTRUCTION, truncateBlock=null, primaryNodeIndex=-1, replicas=[ReplicaUC[[DISK]DS-da139e63-aa77-4533-96a7-ba686d6b067d:NORMAL:10.103.58.30:50010|RBW], ReplicaUC[[DISK]DS-0b38c81f-1e3a-4e9b-acfb-97457c8ed6de:NORMAL:10.103.58.19:50010|RBW], ReplicaUC[[DISK]DS-be50263a-69d5-4efe-a70a-56585022a403:NORMAL:10.142.126.52:50010|RBW]]} numExpected=3, numLive=0\n2017-01-10 01:43:09,906 TRACE org.apache.hadoop.hdfs.server.blockmanagement.DecommissionManager: UC block blk_4280405944_1106180180519{UCState=UNDER_CONSTRUCTION, truncateBlock=null, primaryNodeIndex=-1, replicas=[ReplicaUC[[DISK]DS-da139e63-aa77-4533-96a7-ba686d6b067d:NORMAL:10.103.58.30:50010|RBW], ReplicaUC[[DISK]DS-0b38c81f-1e3a-4e9b-acfb-97457c8ed6de:NORMAL:10.103.58.19:50010|RBW], ReplicaUC[[DISK]DS-be50263a-69d5-4efe-a70a-56585022a403:NORMAL:10.142.126.52:50010|RBW]]} insufficiently-replicated since numLive (0) < minR (1)\n2017-01-10 01:43:09,906 INFO org.apache.hadoop.hdfs.server.blockmanagement.DecommissionManager: Block: blk_4280405944_1106180180519{UCState=UNDER_CONSTRUCTION, truncateBlock=null, primaryNodeIndex=-1, replicas=[ReplicaUC[[DISK]DS-da139e63-aa77-4533-96a7-ba686d6b067d:NORMAL:10.103.58.30:50010|RBW], ReplicaUC[[DISK]DS-0b38c81f-1e3a-4e9b-acfb-97457c8ed6de:NORMAL:10.103.58.19:50010|RBW], ReplicaUC[[DISK]DS-be50263a-69d5-4efe-a70a-56585022a403:NORMAL:10.142.126.52:50010|RBW]]}, Expected Replicas: 3, live replicas: 0, corrupt replicas: 0, decommissioned replicas: 0, decommissioning replicas: 1, excess replicas: 0, Is Open File: true, Datanodes having this block: 10.103.58.19:50010 , Current Datanode: 10.103.58.19:50010, Is current datanode decommissioning: true\n2017-01-10 01:43:09,906 DEBUG org.apache.hadoop.hdfs.server.blockmanagement.DecommissionManager: Node 10.103.58.19:50010 still has 1 blocks to replicate before it is a candidate to finish decommissioning.\n{code}\n\nBut why the block is under_construction within so long time?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-10T08:48:45.450+0000","updated":"2017-01-10T08:48:45.450+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15826934","id":"15826934","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"Yea, this has been a long standing issue in HDFS. This typically happens because some app is slowly writing data to an HDFS file, like Flume or HBase. In these apps, there's typically some way of closing the current file and write to a new one.\n\nBased on your output, the write pipeline has also been reduced to a single DN. We have some pipeline replacement policies that might help here, e.g. {{dfs.client.block.write.replace-datanode-on-failure.enable}} and {{dfs.client.block.write.replace-datanode-on-failure.policy}}.\n\nFinally, finding the app that is writing this file can be difficult. A heavy handed method is looking at fsck -files -blocks -locations. I remember Kihwal was also working on a patch to dump the leases on the NN.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-01-17T22:17:02.443+0000","updated":"2017-01-17T22:17:02.443+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15834363","id":"15834363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"Thank you, [~andrew.wang], the hint you given is very helpful. \nThe last thing I found was there were many \"three zero\" nodes listed in decommissioning in NN UI and could't be completed. And after I purged the old cannot be recovered missing blocks, they all suddenly became decommissioned at the same time. So I suspend that the missing blocks could impact the decommissioning process. That's the what I will follow up.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-01-23T12:15:26.597+0000","updated":"2017-01-23T12:15:26.597+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15907420","id":"15907420","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~andrew.wang], I found there are lots of logs in NameNode like below:\n{code}\n2017-03-13 03:59:52,620 INFO org.apache.hadoop.hdfs.server.blockmanagement.DecommissionManager: Block: blk_13651215184_1113964818077{UCState=COMMITTED, truncateBlock=null, primaryNodeIndex=2, replicas=[ReplicaUC[[DISK]DS-a74fff1e-dc86-4e60-8e69-9c9023a7fd3c:NORMAL:10.115.21.54:50010|RBW]]}, Expected Replicas: 3, live replicas: 0, corrupt replicas: 0, decommissioned replicas: 0, decommissioning replicas: 1, excess replicas: 0, Is Open File: true, Datanodes having this block: 10.115.21.54:50010 , Current Datanode: 10.115.21.54:50010, Is current datanode decommissioning: true\n{code}\n\nNotice the UCState=COMMITTED, and this will cause decommission_inprogress never completed. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cltlfcjin","name":"cltlfcjin","key":"cltlfcjin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cltlfcjin&avatarId=26058","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cltlfcjin&avatarId=26058","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cltlfcjin&avatarId=26058","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cltlfcjin&avatarId=26058"},"displayName":"Lantao Jin","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-03-13T13:09:27.088+0000","updated":"2017-03-13T13:16:53.284+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13031631/comment/15922869","id":"15922869","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"Interesting. Do you think this is possibly related to HDFS-11499? The block might be stuck in committed state since the only remaining replicas are D_I_P.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-03-13T20:22:48.749+0000","updated":"2017-03-13T20:22:48.749+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-11285/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3874n:"}}