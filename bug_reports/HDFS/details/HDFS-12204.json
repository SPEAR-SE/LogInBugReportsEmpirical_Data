{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13090442","self":"https://issues.apache.org/jira/rest/api/2/issue/13090442","key":"HDFS-12204","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-03-19T05:10:43.255+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Mar 19 05:10:43 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12204/watchers","watchCount":13,"isWatching":false},"created":"2017-07-27T07:13:48.167+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12333995","id":"12333995","description":"2.7.3 release","name":"2.7.3","archived":false,"released":true,"releaseDate":"2016-08-25"}],"issuelinks":[{"id":"12512902","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12512902","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13090191","key":"HBASE-18454","self":"https://issues.apache.org/jira/rest/api/2/issue/13090191","fields":{"summary":"RegionServer Do not close file descriptor when using shortcircuit","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/4","description":"This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/reopened.png","name":"Reopened","id":"4","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-19T05:10:43.255+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312928","id":"12312928","name":"hdfs-client"}],"timeoriginalestimate":null,"description":"\nI am a user using HDFS 2.7.3, HBASE 1.2.6, centOS 6.8.\nThe regionserver uses 11 hard disks(jbod) and uses the hbase short circuit.\nAt this time, when one disk fails in HDFS, I found a phenomenon that I did a hotswap but did not close file descriptor in hbase.\nAnd the fd path on the umount disk is changed to an incorrect path.\nIf I check /proc/regionserver_pid/fd, if I used /data1/volumn and umounted data1, the path changed to /volumn.\nAnd many file descriptors used in shortcircuit are in the delete state.\n\nexample ) \nls -al /proc/regionserver_pid/fd \n\nlr-x------ 1 dragonboy dragonboy 64 2017-07-26 20:54 946 -> /data8/volumn/hdfs/datanode/current/BP-199986352-10.114.243.73-1490077615453/current/finalized/subdir111/subdir21/blk_1215239490 (deleted)\nlr-x------ 1 dragonboy dragonboy 64 2017-07-26 20:54 947 -> /data8/volumn/hdfs/datanode/current/BP-199986352-10.114.243.73-1490077615453/current/finalized/subdir111/subdir21/blk_1215239490_141511919.meta (deleted)\nlr-x------ 1 dragonboy dragonboy 64 2017-07-26 20:54 948 -> /data7/volumn/hdfs/datanode/current/BP-199986352-10.114.243.73-1490077615453/current/finalized/subdir111/subdir27/blk_1215241080 (deleted)\nlr-x------ 1 dragonboy dragonboy 64 2017-07-26 20:54 949 -> /data7/volumn/hdfs/datanode/current/BP-199986352-10.114.243.73-1490077615453/current/finalized/subdir111/subdir27/blk_1215241080_141513509.meta (deleted)\nlr-x------ 1 dragonboy dragonboy 64 2017-07-26 20:54 *192 -> /volumn/hdfs/datanode/current/BP-199986352-10.114.243.73-1490077615453/current/finalized/subdir244/subdir160/blk_1257545757 (deleted)*\n                                                     .\n                                                     .\n                                                     .\n                                                     .\n                                                     \n\nwhen data4 fails, execute fuser)\n/sbin/fuser -cu /data4\n\nCannot stat file /proc/regionserver_pid/fd/*192*: input/output error\nCannot stat file /proc/regionserver_pid/fd/1282: input/output error\nCannot stat file /proc/regionserver_pid/fd/1283: input/output error\n                                                     .\n                                                     .\n                                                     .\n                                                     .\n                                                     .\n                                                     \n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12915089","id":"12915089","filename":"HDFS-12204.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dragonboy","name":"dragonboy","key":"dragonboy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10453","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10453","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10453","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10453"},"displayName":"HanRyong,Jung","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-19T04:59:02.914+0000","size":2864,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12915089/HDFS-12204.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Dfsclient Do not close file descriptor when using shortcircuit","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dragonboy","name":"dragonboy","key":"dragonboy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10453","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10453","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10453","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10453"},"displayName":"HanRyong,Jung","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dragonboy","name":"dragonboy","key":"dragonboy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10453","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10453","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10453","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10453"},"displayName":"HanRyong,Jung","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"\nHDFS 2.7.3, HBASE 1.2.6, centOS 6.8\n","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090442/comment/16145244","id":"16145244","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dragonboy","name":"dragonboy","key":"dragonboy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10453","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10453","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10453","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10453"},"displayName":"HanRyong,Jung","active":true,"timeZone":"Etc/UTC"},"body":"RefCount of Hdfs ShortCircuitReplica has an initial value of 2\nThat's because one is ShortCircuitCache, and one is HDFS BlockReaderLocal.\nThe problem I found here is that both hdfs and hbase need to be modified.\nFirst, the ShortCircuitCacheCleaner of hdfs-client reports only the expireTime to purge(delete) the cache\nHowever, ShortCircuitReplica has a Slot and I need the code to Pugrge (delete) it via Slot.\nSecondly, It is lazy to check the status of HDFS client BlockReaderLocal in hbase.\nSo even if you purged the cache in ShortCircuitCacheCleaner, the refCount of the hdfs client is fixed to 1 if there is no access to the hfile.\nI need to periodically check and close BlockReaderLocal on the HDFS client in Hbase.\n\nI have added the following code to ShortCircuitCacheCleaner to solve this problem.\nThis solution is only available in specific Application(hbase) and is a very temporary fix.\nThis is because the hbase client retries if there is an error.\n\n{code:java}\npublic class ShortCircuitCache implements Closeable {\n...\n\n\tprivate class CacheCleaner implements Runnable, Closeable {\n\t...\n\t\n\t\n\tpublic void run() {\n\t...\n\t\t\t\tif (LOG.isDebugEnabled()) {\n\t\t\t\t\tLOG.debug(this + \": cache cleaner running at \" + curMs);\n\t\t\t\t}\n\n\t\t\t\tpurgeStaleReplica();\n\n\t\t\t\tint numDemoted = demoteOldEvictableMmaped(curMs);\n\t...\n\t}\n\t\n\tprivate void purgeStaleReplica() {\n\n\t\t\tArrayList<Waitable<ShortCircuitReplicaInfo>> lists = Lists.newArrayList(replicaInfoMap.values());\n\n\t\t\tfor (Waitable<ShortCircuitReplicaInfo> i : lists) {\n\t\t\t\tShortCircuitReplica replica = i.getVal().getReplica();\n\n\t\t\t\tif (replica.isStale()) {\n\t\t\t\t\t\n\t\t\t\t\tpurge(replica);\n\t\t\t\t\t//In fact, BlockReaderLocal should be closed in Client, but in hbase, it works because hbase client retries.\n\t\t\t\t\twhile (replica.refCount > 0) {\n\t\t\t\t\t\tunref(replica);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t...\n\t}\n\t...\n}\n\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dragonboy","name":"dragonboy","key":"dragonboy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10453","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10453","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10453","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10453"},"displayName":"HanRyong,Jung","active":true,"timeZone":"Etc/UTC"},"created":"2017-08-29T13:02:30.110+0000","updated":"2017-08-29T13:02:30.110+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13090442/comment/16404386","id":"16404386","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m  0s{color} | {color:blue} Docker mode activated. {color} |\r\n| {color:red}-1{color} | {color:red} patch {color} | {color:red}  0m  6s{color} | {color:red} HDFS-12204 does not apply to trunk. Rebase required? Wrong Branch? See https://wiki.apache.org/hadoop/HowToContribute for help. {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| JIRA Issue | HDFS-12204 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12915089/HDFS-12204.1.patch |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/23536/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-19T05:10:43.255+0000","updated":"2018-03-19T05:10:43.255+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12204/votes","votes":4,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3i2s7:"}}