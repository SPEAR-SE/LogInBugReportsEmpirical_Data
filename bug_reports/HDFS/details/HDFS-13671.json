{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13165537","self":"https://issues.apache.org/jira/rest/api/2/issue/13165537","key":"HDFS-13671","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-06-13T04:48:47.001+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Aug 25 11:44:28 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13671/watchers","watchCount":27,"isWatching":false},"created":"2018-06-12T10:19:14.660+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341434","id":"12341434","description":"3.1.0 release","name":"3.1.0","archived":false,"released":true,"releaseDate":"2018-04-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12343020","id":"12343020","description":"3.0.3 release","name":"3.0.3","archived":false,"released":true,"releaseDate":"2018-06-08"}],"issuelinks":[{"id":"12536255","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12536255","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12905592","key":"HDFS-9260","self":"https://issues.apache.org/jira/rest/api/2/issue/12905592","fields":{"summary":"Improve the performance and GC friendliness of NameNode startup and full block reports","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-08-25T11:44:28.822+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"NameNode hung when deleting large files/blocks. The stack info:\r\n{code}\r\n\"IPC Server handler 4 on 8020\" #87 daemon prio=5 os_prio=0 tid=0x00007fb505b27800 nid=0x94c3 runnable [0x00007fa861361000]\r\n   java.lang.Thread.State: RUNNABLE\r\n\tat org.apache.hadoop.hdfs.util.FoldedTreeSet.compare(FoldedTreeSet.java:474)\r\n\tat org.apache.hadoop.hdfs.util.FoldedTreeSet.removeAndGet(FoldedTreeSet.java:849)\r\n\tat org.apache.hadoop.hdfs.util.FoldedTreeSet.remove(FoldedTreeSet.java:911)\r\n\tat org.apache.hadoop.hdfs.server.blockmanagement.DatanodeStorageInfo.removeBlock(DatanodeStorageInfo.java:252)\r\n\tat org.apache.hadoop.hdfs.server.blockmanagement.BlocksMap.removeBlock(BlocksMap.java:194)\r\n\tat org.apache.hadoop.hdfs.server.blockmanagement.BlocksMap.removeBlock(BlocksMap.java:108)\r\n\tat org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.removeBlockFromMap(BlockManager.java:3813)\r\n\tat org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.removeBlock(BlockManager.java:3617)\r\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.removeBlocks(FSNamesystem.java:4270)\r\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.deleteInternal(FSNamesystem.java:4244)\r\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.deleteInt(FSNamesystem.java:4180)\r\n\tat org.apache.hadoop.hdfs.server.namenode.FSNamesystem.delete(FSNamesystem.java:4164)\r\n\tat org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.delete(NameNodeRpcServer.java:871)\r\n\tat org.apache.hadoop.hdfs.server.namenode.AuthorizationProviderProxyClientProtocol.delete(AuthorizationProviderProxyClientProtocol.java:311)\r\n\tat org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.delete(ClientNamenodeProtocolServerSideTranslatorPB.java:625)\r\n\tat org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java)\r\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:617)\r\n{code}\r\nIn the current deletion logic in NameNode, there are mainly two steps:\r\n* Collect INodes and all blocks to be deleted, then delete INodes.\r\n* Remove blocks  chunk by chunk in a loop.\r\nActually the first step should be a more expensive operation and will takes more time. However, now we always see NN hangs during the remove block operation. \r\n\r\nLooking into this, we introduced a new structure {{FoldedTreeSet}} to have a better performance in dealing FBR/IBRs. But compared with early implementation in remove-block logic, {{FoldedTreeSet}} seems more slower since It will take additional time to balance tree node. When there are large block to be removed/deleted, it looks bad.\r\n\r\nFor the get type operations in {{DatanodeStorageInfo}}, we only provide the {{getBlockIterator}} to return blocks iterator and no other get operation with specified block. Still we need to use {{FoldedTreeSet}} in {{DatanodeStorageInfo}}? As we know {{FoldedTreeSet}} is benefit for Get not Update. Maybe we can revert this to the early implementation.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12342772","id":"12342772","description":"","name":"3.2.0","archived":false,"released":false}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Namenode deletes large dir slowly caused by FoldedTreeSet#removeAndGet","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16510617","id":"16510617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi [~linyiqun], thanks for reporting the issue.\r\n\r\nDo you have some specific numbers to share on the issue? e.g. deleting how many files/blocks, and how long was NN 'hung' on the stacktrace provided?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-13T04:48:47.001+0000","updated":"2018-06-13T04:48:47.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16510658","id":"16510658","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi [~xiaochen], the deletion behavior is invoked by trash mechanism. So this will happened very frequently in our cluster, Every time there are 12~14w files(blocks) being deleted, then we found NN hung around 3~5 minutes. And all the other RPC requests are blocked.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-06-13T05:54:31.858+0000","updated":"2018-06-13T05:54:31.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16511402","id":"16511402","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"I'm not surprised. I fully expected having to revert when we start scale testing 3.x.\r\n\r\nThe folded tree jira has micro-benchmarks demonstrating a 4x degradation in performance. Micro-benchmarks tend to exaggerate performance differences, so let's see how that measures up in the real world.\r\n\r\nBaseline is a large delete from last month on a 2.8 cluster:\r\n * 29.9M blocks; 87 seconds = 344k blocks/sec\r\n\r\nLet's analyze permutations of the reported numbers:\r\n * 14M blocks; 3 min = 78k blocks/sec = 4X slower\r\n * 12M blocks; 3 min = 67k blocks/sec = 5X slower\r\n * 14M blocks; 6 min = 39k blocks/sec = 9X slower\r\n\r\nIt appears it's _at least as bad_ as predicted by the micro-benchmarks.  The tree traversal, the internal node copies, and the rebalancing aren't cheap.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-06-13T16:37:03.492+0000","updated":"2018-06-13T16:37:03.492+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16513915","id":"16513915","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"One more (big) reason to revert HDFS-9260?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-06-15T14:46:54.917+0000","updated":"2018-06-15T14:46:54.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16514036","id":"16514036","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Looking into this today and probably discuss with [~andrew.wang]. Will get back soon","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-15T16:14:30.780+0000","updated":"2018-06-15T16:14:30.780+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16514115","id":"16514115","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm fine with reverting if we're seeing production issues. I wasn't that involved with HDFS-9260 except to try and answer Daryn's questions about real-world performance.\r\n\r\nGiven that there seems to be a lot more interest in maintaining the older version, I'm also inclined to revert for maintenance purposes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-15T17:18:11.564+0000","updated":"2018-06-15T17:18:11.564+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16514289","id":"16514289","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=misha%40cloudera.com","name":"misha@cloudera.com","key":"misha@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Misha Dmitriev","active":true,"timeZone":"America/Los_Angeles"},"body":"[~linyiqun] did you check how much time NN was spending in GC when it was hung? That is, it would be good to verify that the problem is indeed with the NN code running some suboptimal operations for long time, and not with the JVM itself that busily collects the heap. Of course, if you have a relatively small heap (up to 3..5GB), GC is unlikely to take much time anyway. But with bigger heaps, it may become a factor to consider.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=misha%40cloudera.com","name":"misha@cloudera.com","key":"misha@cloudera.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Misha Dmitriev","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-15T20:03:47.810+0000","updated":"2018-06-15T20:03:47.810+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16514638","id":"16514638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks for the comments, everyone!\r\n[~misha@cloudera.com], we  did the GC check and are sure there is no GC problem when NN hung. And we looked into the NN log, that explicitly indicated that NN was doing the remove block operation. It lasted around 6 minutes(from 15:01~15:07).\r\n{noformat}\r\n2018-06-06 15:00:59,873 INFO [IPC Server handler 163 on 8020] BlockStateChange: BLOCK* addToInvalidates: blk_1593304672_519567210 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010\r\n2018-06-06 15:00:59,875 INFO [IPC Server handler 163 on 8020] BlockStateChange: BLOCK* addToInvalidates: blk_1593304675_519567213 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010\r\n2018-06-06 15:00:59,879 INFO [IPC Server handler 163 on 8020] BlockStateChange: BLOCK* addToInvalidates: blk_1593304678_519567216 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010\r\n2018-06-06 15:00:59,882 INFO [IPC Server handler 163 on 8020] BlockStateChange: BLOCK* addToInvalidates: blk_1593304679_519567217 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010\r\n.....\r\n2018-06-06 15:07:00,004 INFO [IPC Server handler 163 on 8020] BlockStateChange: BLOCK* addToInvalidates: blk_1595774272_522036817 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010\r\n2018-06-06 15:07:00,005 INFO [IPC Server handler 163 on 8020] BlockStateChange: BLOCK* addToInvalidates: blk_1595774270_522036815 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010\r\n2018-06-06 15:07:00,007 INFO [IPC Server handler 163 on 8020] BlockStateChange: BLOCK* addToInvalidates: blk_1595774256_522036801 xx.xx.xx.xx:50010 xx.xx.xx.xx:50010 xx.xx.xx.xx:500\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-06-16T02:45:29.862+0000","updated":"2018-06-16T02:45:29.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16515541","id":"16515541","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"body":"The microbenchmarks given in [^HDFS Block and Replica Management 20151013.pdf], it also mentions that inserting/removing will takes 4x longer time.\r\n{quote}A concern with the patch is the increased cost of inserting and removing nodes from the DataNodeStorageInfo on the NN. A small microbenchmark using JMH shows that removing and re-adding 32k random entries from a DataNodeStorageInfo that contains 64k entries roughly takes 4x longer\r\n{quote}\r\nThere are some settings supported for controlling the compaction behavior of the tree. But this seems not a cheap way, it will hold FSN read/write block when do the scan and compaction in periodic runnable.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-06-18T09:44:20.466+0000","updated":"2018-06-18T09:44:20.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16516463","id":"16516463","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks all for the comments.\r\n\r\n\r\nI reviewed HDFS-9260's benchmark and did some minidfscluster with 20k files runs with and without HDFS-9260, which looks like:\r\n||version||create files one-by-one||delete altogether||delete ops/sec||\r\n|with|(189088+183722+182669) / 3 = 185159|(88 + 87 + 89) / 3 = 88|227k|\r\n|without|(197381+194467+183217) / 3 = 191688|(131+104+101) / 3 = 112|178k|\r\n\r\nConsidering with a real production, the removal will be more scattered resulting in more fragmentation / rebalancing, costing both cpu cycles and gc, I think the 4x slower microbenchmark number isn't very exaggerated. \r\n\r\n[~linyiqun], do you happen to know what 's the deletion rate in your cluster before HDFS-9260? (I doubt if it's at 344k blocks/sec :) )\r\n\r\nGiven that there seems to be more interest and existing work on the old implementation, reverting is fine by me. The reverting needs to be done compatibly though, and it seems to be compatible as long as the new field in {{DatanodeProtocol.proto}} is not removed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiaochen","name":"xiaochen","key":"xiaochen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xiaochen&avatarId=24893","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xiaochen&avatarId=24893","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xiaochen&avatarId=24893","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xiaochen&avatarId=24893"},"displayName":"Xiao Chen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-18T23:33:32.349+0000","updated":"2018-06-18T23:33:32.349+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16517057","id":"16517057","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"[~linyiqun] thanks for reporting the issue. It seems you've tried to attach a file (HDFS Block and Replica Management 20151013.pdf) but it doesn't uploaded. Would you please share this file again?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-06-19T13:18:34.306+0000","updated":"2018-06-19T13:18:34.306+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16517173","id":"16517173","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"body":"[~jojochuang], the link of FoldedTreeSet design doc:https://issues.apache.org/jira/secure/attachment/12767102/HDFS%20Block%20and%20Replica%20Management%2020151013.pdf\r\n{quote}Yiqun Lin, do you happen to know what 's the deletion rate in your cluster before HDFS-9260? (I doubt if it's at 344k blocks/sec )\r\n{quote}\r\n[~xiaochen], I haven't tested the case without the patch of  HDFS-9260. I can have a test if I have some free time, :).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-06-19T14:36:18.406+0000","updated":"2018-06-19T14:37:05.358+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16580028","id":"16580028","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"I think we all know the time complexity to update a large balanced binary tree cannot possibly compete with updating a small linked list (triplets) of n-many elements (replication factor).  It seems like we are in agreement to revert?  I'd do it but I've wrecked my local repo too many times to trust myself. :)\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2018-08-14T16:29:57.314+0000","updated":"2018-08-14T16:29:57.314+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16580032","id":"16580032","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"body":"Reverting seems to be the right answer. It will be non-trivial so we'll need a brave volunteer to work through the conflicts.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpitagarwal","name":"arpitagarwal","key":"arpitagarwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpit Agarwal","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-08-14T16:34:51.330+0000","updated":"2018-08-14T16:34:51.330+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16580660","id":"16580660","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"body":"Agree with [~arpitagarwal]'s comment. I have met the same problem in 2.6.0-cdh5.13.1 that also using the FoldedTreeSet structure.\r\n [~daryn], if you have already done the reverting work for this, feel free to attach your patch, :). I think we have reach the agreement now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linyiqun","name":"linyiqun","key":"linyiqun","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=linyiqun&avatarId=25258","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=linyiqun&avatarId=25258","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=linyiqun&avatarId=25258","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=linyiqun&avatarId=25258"},"displayName":"Yiqun Lin","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-08-15T03:10:08.500+0000","updated":"2018-08-15T03:10:08.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16581525","id":"16581525","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"I've started working on the revert. So far in BlockManager, I had to deal with the following:\r\n{panel}\r\nHDFS-11681 - retain the change in removeBlocksAssociatedTo()\r\nHDFS-10301 - retain the change in BlockManager.\r\nHDFS-10694 - retained logging changes. The change regarding sorted/unsorted was removed in processReport() as it is no longer relevant.\r\nHDFS-10858 - retain the change.\r\n{panel}\r\n\r\nI will post the revert patch and JIRAs involved in conflicts once everything is done.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-08-15T19:38:18.949+0000","updated":"2018-08-15T19:38:18.949+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13165537/comment/16592561","id":"16592561","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lindongdong","name":"lindongdong","key":"lindongdong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"lindongdong","active":true,"timeZone":"Asia/Shanghai"},"body":"Hi, [~kihwal], how is the revert work? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lindongdong","name":"lindongdong","key":"lindongdong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"lindongdong","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-08-25T11:44:28.822+0000","updated":"2018-08-25T11:44:28.822+0000"}],"maxResults":17,"total":17,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-13671/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3urjz:"}}