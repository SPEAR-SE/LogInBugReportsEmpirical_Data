{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12473344","self":"https://issues.apache.org/jira/rest/api/2/issue/12473344","key":"HDFS-1377","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314814","id":"12314814","description":"","name":"0.20.3","archived":true,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12316319","id":"12316319","description":"","name":"0.20.204.0","archived":false,"released":true,"releaseDate":"2011-09-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315271","id":"12315271","description":"","name":"0.21.1","archived":true,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315300","id":"12315300","description":"","name":"Federation Branch","archived":true,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314241","id":"12314241","description":"","name":"0.22.0","archived":false,"released":true,"releaseDate":"2011-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315571","id":"12315571","description":"","name":"0.23.0","archived":false,"released":true,"releaseDate":"2011-11-11"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-11-05T02:48:37.844+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 12 21:22:47 UTC 2011","customfield_12310420":"15590","customfield_12312320":null,"customfield_12310222":"10002_*:*_1_*:*_2706464223_*|*_1_*:*_1_*:*_5548604490_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-12-10T07:37:41.985+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-1377/watchers","watchCount":9,"isWatching":false},"created":"2010-09-05T18:33:13.272+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314048","id":"12314048","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314204","id":"12314204","description":"","name":"0.20.2","archived":false,"released":true,"releaseDate":"2010-02-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314046","id":"12314046","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314241","id":"12314241","description":"","name":"0.22.0","archived":false,"released":true,"releaseDate":"2011-12-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315571","id":"12315571","description":"","name":"0.23.0","archived":false,"released":true,"releaseDate":"2011-11-11"}],"issuelinks":[{"id":"12334598","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12334598","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12478967","key":"HDFS-1487","self":"https://issues.apache.org/jira/rest/api/2/issue/12478967","fields":{"summary":"FSDirectory.removeBlock() should update diskspace count of the block owner node","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12334844","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12334844","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12480634","key":"HDFS-1515","self":"https://issues.apache.org/jira/rest/api/2/issue/12480634","fields":{"summary":"Test append and quotas ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/6","id":"6","description":"A new unit, integration or system test.","iconUrl":"https://issues.apache.org/jira/images/icons/issuetypes/requirement.png","name":"Test","subtask":false}}}},{"id":"12349016","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12349016","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12545579","key":"HDFS-3061","self":"https://issues.apache.org/jira/rest/api/2/issue/12545579","fields":{"summary":"Backport HDFS-1487 to branch-1","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-03-08T02:10:13.403+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"There's a bug in the quota code that causes them not to be respected when a file is not an exact multiple of the block size. Here's an example:\n\n{code}\n$ hadoop fs -mkdir /test\n$ hadoop dfsadmin -setSpaceQuota 384M /test\n$ ls dir/ | wc -l   # dir contains 101 files\n101\n$ du -ms dir        # each is 3mb\n304\tdir\n$ hadoop fs -put dir /test\n$ hadoop fs -count -q /test\n        none             inf       402653184      -550502400            2          101          317718528 hdfs://haus01.sf.cloudera.com:10020/test\n$ hadoop fs -stat \"%o %r\" /test/dir/f30\n134217728 3    # three 128mb blocks\n{code}\n\nINodeDirectoryWithQuota caches the number of bytes consumed by it's children in {{diskspace}}. The quota adjustment code has a bug that causes {{diskspace}} to get updated incorrectly when a file is not an exact multiple of the block size (the value ends up being negative). \n\nThis causes the quota checking code to think that the files in the directory consumes less space than they actually do, so the verifyQuota does not throw a QuotaExceededException even when the directory is over quota. However the bug isn't visible to users because {{fs count -q}} reports the numbers generated by INode#getContentSummary which adds up the sizes of the blocks rather than use the cached INodeDirectoryWithQuota#diskspace value.\n\nIn FSDirectory#addBlock the disk space consumed is set conservatively to the full block size * the number of replicas:\n\n{code}\nupdateCount(inodes, inodes.length-1, 0,\n    fileNode.getPreferredBlockSize()*fileNode.getReplication(), true);\n{code}\n\nIn FSNameSystem#addStoredBlock we adjust for this conservative estimate by subtracting out the difference between the conservative estimate and what the number of bytes actually stored was:\n\n{code}\n//Updated space consumed if required.\nINodeFile file = (storedBlock != null) ? storedBlock.getINode() : null;\nlong diff = (file == null) ? 0 :\n    (file.getPreferredBlockSize() - storedBlock.getNumBytes());\n\nif (diff > 0 && file.isUnderConstruction() &&\n    cursize < storedBlock.getNumBytes()) {\n...\n    dir.updateSpaceConsumed(path, 0, -diff*file.getReplication());\n{code}\n\nWe do the same in FSDirectory#replaceNode when completing the file, but at a file granularity (I believe the intent here is to correct for the cases when there's a failure replicating blocks and recovery). Since oldnode is under construction INodeFile#diskspaceConsumed will use the preferred block size  (vs of Block#getNumBytes used by newnode) so we will again subtract out the difference between the full block size and what the number of bytes actually stored was:\n\n{code}\nlong dsOld = oldnode.diskspaceConsumed();\n...\n//check if disk space needs to be updated.\nlong dsNew = 0;\nif (updateDiskspace && (dsNew = newnode.diskspaceConsumed()) != dsOld) {\n  try {\n    updateSpaceConsumed(path, 0, dsNew-dsOld);\n...\n{code}\n\nSo in the above example we started with diskspace at 384mb (3 * 128mb) and then we subtract 375mb (to reflect only 9mb raw was actually used) twice so for each file the diskspace for the directory is - 366mb (384mb minus 2 * 375mb). Which is why the quota gets negative and yet we can still write more files.\n\nSo a directory with lots of single block files (if you have multiple blocks on the final partial block ends up subtracting from the diskspace used) ends up having a quota that's way off.\n\nI think the fix is to in FSDirectory#replaceNode not have the diskspaceConsumed calculations differ when the old and new INode have the same blocks. I'll work on a patch which also adds a quota test for blocks that are not multiples of the block size and warns in INodeDirectory#computeContentSummary if the computed size does not reflect the cached value.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12459111","id":"12459111","filename":"HDFS-1377.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhong","name":"zhong","key":"zhong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhong Wang","active":true,"timeZone":"America/New_York"},"created":"2010-11-08T23:49:34.926+0000","size":2278,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12459111/HDFS-1377.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460243","id":"12460243","filename":"hdfs-1377-1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-23T07:15:32.811+0000","size":10580,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12460243/hdfs-1377-1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12459853","id":"12459853","filename":"hdfs-1377-b20-1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-18T00:21:02.103+0000","size":10160,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12459853/hdfs-1377-b20-1.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12459947","id":"12459947","filename":"hdfs-1377-b20-2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-18T21:36:30.980+0000","size":9461,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12459947/hdfs-1377-b20-2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460242","id":"12460242","filename":"hdfs-1377-b20-3.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-23T07:09:24.037+0000","size":7767,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12460242/hdfs-1377-b20-3.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"13839","customfield_12312823":null,"summary":"Quota bug for partial blocks allows quotas to be violated ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12928455","id":"12928455","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhong","name":"zhong","key":"zhong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhong Wang","active":true,"timeZone":"America/New_York"},"body":"I made a link from HDFS-1487. I found the same problem when testing the issue. I think I can fix this soon and attach a patch. Any comments?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhong","name":"zhong","key":"zhong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhong Wang","active":true,"timeZone":"America/New_York"},"created":"2010-11-05T02:48:37.844+0000","updated":"2010-11-05T02:48:37.844+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12929828","id":"12929828","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhong","name":"zhong","key":"zhong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhong Wang","active":true,"timeZone":"America/New_York"},"body":"Patch attached and run hudson.\n\nI removed disk checking in FSDirectory.replaceNode(). It is duplicated with BlockManager.commitBlock(). All diskspace counting will be updated at a block level when writing (appending) a file, in addBlock(), commitBlock() and abandonBlock() (HDFS-1487).\n\nI also added a test case in TestQuota. The original tests hiding this issue because all file length is mutiple of 1024 while block size is 512. I create a file which is not an exact multiple of the block size to test this case.\n\nHadoop developers and committers, thanks for your time to review this patch and give me some suggestions! HDFS quota is very important to manage our clusters which is highly shareable with dozens of users and PBs storage.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhong","name":"zhong","key":"zhong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhong Wang","active":true,"timeZone":"America/New_York"},"created":"2010-11-08T23:49:35.034+0000","updated":"2010-11-08T23:49:35.034+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12929908","id":"12929908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=weichao","name":"weichao","key":"weichao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Weichao Ruan","active":true,"timeZone":"Etc/UTC"},"body":"So what is the original idea of the code to be removed in your patch?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=weichao","name":"weichao","key":"weichao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Weichao Ruan","active":true,"timeZone":"Etc/UTC"},"created":"2010-11-09T02:59:39.159+0000","updated":"2010-11-09T02:59:39.159+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12929914","id":"12929914","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhong","name":"zhong","key":"zhong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhong Wang","active":true,"timeZone":"America/New_York"},"body":"Weichao,\n\nThe reason is the same with the issue description from Eli Collins. When finalizing an uncompleted file, BlockManager reduce the pending block size in commitBlock() while FSDirecotry.replaceNode() do the same thing. Diskspace count will be reduced twice and less than the actual value, even more, the value maybe nagetive which is obviously unleagle.\n\nYou can reproduce the problem using the steps from Eli Collins. Or make a regression test using my test case.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zhong","name":"zhong","key":"zhong","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Zhong Wang","active":true,"timeZone":"America/New_York"},"created":"2010-11-09T03:14:07.909+0000","updated":"2010-11-09T03:14:07.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12929920","id":"12929920","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=weichao","name":"weichao","key":"weichao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Weichao Ruan","active":true,"timeZone":"Etc/UTC"},"body":"Zhong,\n\nThanks. In fact, i encountered the same problem in our cluster.\nAnd i also test your patch and it looks good.\n+1 for this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=weichao","name":"weichao","key":"weichao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Weichao Ruan","active":true,"timeZone":"Etc/UTC"},"created":"2010-11-09T03:25:10.105+0000","updated":"2010-11-09T03:25:10.105+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12933247","id":"12933247","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. So what is the original idea of the code to be removed in your patch?\n\nIf the oldnode and newnode arguments to replaceNode always have the same blocks then the disk updating space code in replaceNode is redundant. This code goes back to the original space quota addition (HADOOP-3938), and it looks like it was redundant as well there (note that the comment near the code even says \"Currently oldnode and newnode are assumed to contain the same blocks\" so perhaps they were trying to be conservative).\n\nSo the question becomes do oldnode and newnode ever have different blocks? On branch 20 I don't think that's the case. The only caller where it seems that it could potentially be the case is loadFilesUnderConstruction, in which case the under construction INode may have an extra block, but then wouldn't that have been accounted for via addStoredBlock already?\n\nI still need to look at the code for trunk more thoroughly, the latest code, particularly append, makes things less obvious. I do think we should remove this particular file-level accounting code in replaceNode, and always make quota adjustments at block granularity.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-18T00:13:19.958+0000","updated":"2010-11-18T00:13:19.958+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12933253","id":"12933253","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"Patch for branch 20 attached.  I think this bug is bad enough to fix on this branch.\n\nApologies, I thought I had posted this earlier.  \n* Adds TestQuotaViolations which covers these particular cases\n* Removes the account in replaceNode (which fixes these particular bugs), similar fix to the patch Zhong created \n* Adds a warning in INodeDirectory#computeContent summary to warn against future cases. I've run this patch on a cluster and not seen it warn, but it will catch cases like HDFS-1487.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-18T00:21:02.159+0000","updated":"2010-11-18T00:21:02.159+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12933576","id":"12933576","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"Right patch for branch 20 attached this time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-18T21:36:31.040+0000","updated":"2010-11-18T21:36:31.040+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12933651","id":"12933651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"\nI am still refreshing my memory of this NN internals...\n\nI think the patch is correct. I too am not sure if this causes problem else where. looks like it fixes more that it might break.\n\nThis patch fixes bug the case where replaceNode(oldINode, newINode) is called under normal close().. where though oldINode is a INodeUnderConstruction only by its Java type, but not logically (it is already been removed from the active leases etc). \n\nWhat about the other way around where newINode is an INodeUnderConstruction? as described by Eli below : \n\nbq. So the question becomes do oldnode and newnode ever have different blocks? On branch 20 I don't think that's the case. The only caller where it seems that it could potentially be the case is loadFilesUnderConstruction, in which case the under construction INode may have an extra block, but then wouldn't that have been accounted for via addStoredBlock already?\n\nNot sure how it manifests in real life, but here a file is going from INodeFile to INodeFIleUnderConstruction. So the actual space consumed should be rounded upwards to the block boundery. Add stored block is not called at this time. \n\nHow about calling replaceNode(..., updateDiskspace = false) in finalizeFileUnderconstruction(), since we know that oldNode is not under construction anymore?\n\nbtw, do we separate test file for this? TestQuota.java is already supposed to test violations (FWIW, it does test some violations).\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-19T01:50:32.616+0000","updated":"2010-11-19T01:50:32.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12934722","id":"12934722","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks for taking a look Raghu!\n\nbq. Not sure how it manifests in real life, but here a file is going from INodeFile to INodeFIleUnderConstruction. So the actual space consumed should be rounded upwards to the block boundery. Add stored block is not called at this time.\n\nThe sequence of events is:\n\n* A client starts appending to an existing file\n* dfsadmin -saveNamespace  (persists the INodeFileUnderConstruction)\n* The NN restarts, when loading the image we replace the old INode with the persisted INodeFileUnderConstruction.\n\nSince disk usage is not persisted in the image, is calculated as DNs report blocks on startup, I don't think this path should update disk usage. \n\nbq. How about calling replaceNode(..., updateDiskspace = false) in finalizeFileUnderconstruction(), since we know that oldNode is not under construction anymore?\n\nI think we can remove the disk updating code there entirely, even on trunk, and add tests to make sure the block-level accounting is working.\n\nbq. btw, do we separate test file for this? TestQuota.java is already supposed to test violations (FWIW, it does test some violations).\n\nI had the put them in a separate class so they could share setup and teardown (vs TestQuota which has setup/teardown code for each test). I'll update the patches to add the tests to TestQuota so they're all in one place.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-23T03:26:59.669+0000","updated":"2010-11-23T03:26:59.669+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12934729","id":"12934729","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"Removing the disk space updating code in replaceNode also looks safe in trunk, though I noticed we're missing coverage for quotas and append. Filed HDFS-1515.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-23T03:57:29.727+0000","updated":"2010-11-23T03:57:29.727+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12934757","id":"12934757","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"Patch for branch 20 attached.  Address Raghu's feedback.    All test pass modulo TestDU which is HADOOP-7045. Think patch is ready to be checked in. \n\n{noformat}\n     [exec] \n     [exec] -1 overall.  \n     [exec] \n     [exec]     +1 @author.  The patch does not contain any @author tags.\n     [exec] \n     [exec]     +1 tests included.  The patch appears to include 9 new or modified tests.\n     [exec] \n     [exec]     +1 javadoc.  The javadoc tool did not generate any warning messages.\n     [exec] \n     [exec]     +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n     [exec] \n     [exec]     +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n     [exec] \n     [exec]     -1 Eclipse classpath. The patch causes the Eclipse classpath to differ from the contents of the lib directories.\n     [exec] \n{noformat}\n\nNot sure what the eclipse classpath warning is about, this patch just edits some source files.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-23T07:09:24.081+0000","updated":"2010-11-23T07:09:24.081+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12934759","id":"12934759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"Patch for trunk attached.  Release audit warnings are a separate issue.  No change in test failures.\n\n{noformat}\n     [exec] \n     [exec] -1 overall.  \n     [exec] \n     [exec]     +1 @author.  The patch does not contain any @author tags.\n     [exec] \n     [exec]     +1 tests included.  The patch appears to include 9 new or modifi\ned tests.\n     [exec] \n     [exec]     +1 javadoc.  The javadoc tool did not generate any warning messa\nges.\n     [exec] \n     [exec]     +1 javac.  The applied patch does not increase the total number \nof javac compiler warnings.\n     [exec] \n     [exec]     +1 findbugs.  The patch does not introduce any new Findbugs (ver\nsion 1.3.9) warnings.\n     [exec] \n     [exec]     -1 release audit.  The applied patch generated 103 release audit\n warnings (more than the trunk's current 98 warnings).\n     [exec] \n     [exec]     +1 system test framework.  The patch passed system test framework compile.\n     [exec] \n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-23T07:15:32.856+0000","updated":"2010-11-23T07:15:32.856+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12965378","id":"12965378","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Eli. will review the patch tonight (tomorrow night at the latest).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-11-30T19:42:36.340+0000","updated":"2010-11-30T19:42:36.340+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12969857","id":"12969857","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"body":"+1.\n\nThanks Eli. The warning in contentSummary() is also useful.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rangadi","name":"rangadi","key":"rangadi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Raghu Angadi","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-12-09T18:38:58.939+0000","updated":"2010-12-09T18:38:58.939+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/12970096","id":"12970096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Raghu!   I've committed this to trunk, and the 22, 21, and 20 branches.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-12-10T07:37:41.904+0000","updated":"2010-12-10T07:37:41.904+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13001247","id":"13001247","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"body":"Committed also this to Federation Branch.  Thanks, Eli!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-03-02T01:49:40.842+0000","updated":"2011-03-02T01:49:40.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13022534","id":"13022534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-Hdfs-trunk #643 (See [https://builds.apache.org/hudson/job/Hadoop-Hdfs-trunk/643/])\n    ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-20T23:33:27.951+0000","updated":"2011-04-20T23:33:27.951+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13023025","id":"13023025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"body":"Integrated in Hadoop-Hdfs-22-branch #35 (See [https://builds.apache.org/hudson/job/Hadoop-Hdfs-22-branch/35/])\n    ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudson","name":"hudson","key":"hudson","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hudson","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-21T23:32:07.763+0000","updated":"2011-04-21T23:32:07.763+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13030075","id":"13030075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnvijoe","name":"johnvijoe","key":"johnvijoe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John George","active":true,"timeZone":"America/Los_Angeles"},"body":"Can someone (Nicholas?) commit the 20 patch in this JIRA to branch-0.20-security?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnvijoe","name":"johnvijoe","key":"johnvijoe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John George","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-06T18:33:50.603+0000","updated":"2011-05-06T18:33:50.603+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13030078","id":"13030078","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"It is already checked into branch-0.20-security and branch-0.20-security-204.  Updating the fix version to match. Would be great if this were done for the other jiras in the branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-06T18:38:57.964+0000","updated":"2011-05-06T18:38:57.964+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13030088","id":"13030088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnvijoe","name":"johnvijoe","key":"johnvijoe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John George","active":true,"timeZone":"America/Los_Angeles"},"body":"I am sure I am missing something here, but in my \"view\" or branch-20-security, I do not see the patch. I am looking at:\nhttp://svn.apache.org/repos/asf/hadoop/common/branches/branch-0.20-security","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnvijoe","name":"johnvijoe","key":"johnvijoe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John George","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-06T19:02:37.504+0000","updated":"2011-05-06T19:02:37.504+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13030091","id":"13030091","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"body":"I merged this to 0.20-security.\n\nEli, it is not yet in branch-0.20-security-204 but thanks for taking a look.\n\nJohn, could you test 0.20-security branch one more time?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-06T19:08:28.356+0000","updated":"2011-05-06T19:08:28.356+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13030106","id":"13030106","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnvijoe","name":"johnvijoe","key":"johnvijoe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John George","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Nicholas and Eli. The fix is now in branch-20-security. I ran the related tests and it passed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=johnvijoe","name":"johnvijoe","key":"johnvijoe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John George","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-06T19:43:15.574+0000","updated":"2011-05-06T19:43:15.574+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13030107","id":"13030107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"body":"Weird. You're right, this change is not checked into branch-0.20-security but according to the git mirror it is. The following is from before Nicholas' push:\n{noformat}\ncommon1 (branch-0.20-security-204)$ git log origin/branch-0.20-security-204 |grep HDFS-1377\n    HDFS-1377. Quota bug for partial blocks allows quotas to be violated. Contributed by Eli Collins\ncommon1 (branch-0.20-security-204)$  \n{noformat}\n\nIs this because the change was checked into branch-0.20 and the mirror things branch-0.20-security is based on branch-0.20?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=eli","name":"eli","key":"eli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eli Collins","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-06T19:46:57.145+0000","updated":"2011-05-06T19:46:57.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12473344/comment/13032690","id":"13032690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"body":"I have merged this to branch-0.20-security-204.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=szetszwo","name":"szetszwo","key":"szetszwo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=szetszwo&avatarId=23156","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=szetszwo&avatarId=23156","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=szetszwo&avatarId=23156","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=szetszwo&avatarId=23156"},"displayName":"Tsz Wo Nicholas Sze","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-12T21:22:47.612+0000","updated":"2011-05-12T21:22:47.612+0000"}],"maxResults":26,"total":26,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-1377/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02q5r:"}}