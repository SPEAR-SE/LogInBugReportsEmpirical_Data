{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12506189","self":"https://issues.apache.org/jira/rest/api/2/issue/12506189","key":"HDFS-1887","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 26 07:31:59 UTC 2011","customfield_12310420":"15458","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-1887/watchers","watchCount":4,"isWatching":false},"created":"2011-05-04T16:20:50.176+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314048","id":"12314048","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314046","id":"12314046","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315571","id":"12315571","description":"","name":"0.23.0","archived":false,"released":true,"releaseDate":"2011-11-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-05-26T07:31:59.611+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"}],"timeoriginalestimate":null,"description":"In the existing behavior we are checking whether datanode is formatted or not based on the version file existence. If version file is not present the storage directory will be formatted. In some cases if formatting got terminated abruptly there can be a scenario where storage file or version file will be created and the content may not be written. In such scenarios when Datanode is restarted it is just throwing an exception. Some one has to manually delete the storage directory and restart the datanode.\n\nThis is one scenario where storage file is created but the content is not written then I am getting this exception.\n\nThese are the corresponding logs:-\n2011-05-02 19:12:19,389 ERROR org.apache.hadoop.hdfs.server.datanode.DataNode: java.io.EOFException\nat java.io.RandomAccessFile.readInt(RandomAccessFile.java:725)\nat org.apache.hadoop.hdfs.server.datanode.DataStorage.isConversionNeeded(DataStorage.java:203)\nat org.apache.hadoop.hdfs.server.common.Storage.checkConversionNeeded(Storage.java:697)\nat org.apache.hadoop.hdfs.server.common.Storage.access$000(Storage.java:62)\nat org.apache.hadoop.hdfs.server.common.Storage$StorageDirectory.analyzeStorage(Storage.java:476)\nat org.apache.hadoop.hdfs.server.datanode.DataStorage.recoverTransitionRead(DataStorage.java:116)\nat org.apache.hadoop.hdfs.server.datanode.DataNode.startDataNode(DataNode.java:336)\nat org.apache.hadoop.hdfs.server.datanode.DataNode.<init>(DataNode.java:260)\nat org.apache.hadoop.hdfs.server.datanode.DataNode.<init>(DataNode.java:237)\nat org.apache.hadoop.hdfs.server.datanode.DataNode.makeInstance(DataNode.java:1440)\nat org.apache.hadoop.hdfs.server.datanode.DataNode.instantiateDataNode(DataNode.java:1393)\nat org.apache.hadoop.hdfs.server.datanode.DataNode.createDataNode(DataNode.java:1407)\nat org.apache.hadoop.hdfs.server.datanode.DataNode.main(DataNode.java:1552)\n\nOur Hadoop cluster is managed by a cluster management software which tries to eliminate any manual intervention in setting up & managing the cluster. But in the above mentioned scenario, it requires manual intervention to recover the DataNode.Though it is very rare there is a possibility for this\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"113717","customfield_12312823":null,"summary":"Facing problems while restarting the datanode if the datanode format is unsuccessful.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12506189/comment/13028811","id":"13028811","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"body":"As I know this problem may come while datanode is getting formatted or by corruption of storage file manually or through some program.Can anyone comment on any of my proposed solutions.\n1.Creating a new storage file when an EOFException is thrown in DataStorage.isConversionNeeded method while reading LAYOUT_VERSION from the storage file. OR\n2.Sending the storage state as NOT_FORMATTED when this problem comes but this will be a problem if it is corrupted manually or through some program then this solution will not be appropriate as this will format the datadir.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-04T16:26:58.695+0000","updated":"2011-05-04T16:26:58.695+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12506189/comment/13029357","id":"13029357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"body":"Solution:-I have fixed this in the corresponding way by catching the EOFException in the method DataStorage.isConversionNeeded and deleting the file and returning false.\nThen the data node will be started successfully and there wont be any data loss also.I have tested this this looks fine for me.I can provide the patch or am I missing any point anywhere?\n\nOne More Scenario:-This problem will also come under normal data node restarts and if the storage file is not present then it will try to recreate the file, so before writing the the LAYOUT_VERSION if data node is killed then further restarts will be failing in the similar fashion.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-05T15:05:15.635+0000","updated":"2011-05-05T15:05:15.635+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12506189/comment/13030449","id":"13030449","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"body":"Hi, Can anyone suggest how to handle the same problem in case of VERSION file","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-08T03:04:10.440+0000","updated":"2011-05-08T03:04:10.440+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12506189/comment/13039558","id":"13039558","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"body":"I want to propose this solution:-\n\nIn order to avoid manual intervention of deleting the storage directory we can check for a file say \"formatrequired\" file if the file is present we will format the storage directory\nThe file will be created while formatting a storage directory is started and deleted once the version file is written successfully. This will ensure formatting has been done successfully. Whenever datanode is started the first step of the analyzing the storage directory is to check the \"formatrequired\" file is present or not if the file is present then we will set the start up option to format then the storage directory will be formatted and the datanode will be started successfully.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sravankorumilli","name":"sravankorumilli","key":"sravankorumilli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"sravankorumilli","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-26T07:31:59.589+0000","updated":"2011-05-26T07:31:59.589+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-1887/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0jtjr:"}}