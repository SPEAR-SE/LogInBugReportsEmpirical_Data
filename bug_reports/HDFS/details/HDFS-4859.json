{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12649718","self":"https://issues.apache.org/jira/rest/api/2/issue/12649718","key":"HDFS-4859","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2013-05-28T17:02:02.002+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 30 02:20:14 UTC 2013","customfield_12310420":"330045","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-4859/watchers","watchCount":6,"isWatching":false},"created":"2013-05-28T14:49:10.878+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324136","id":"12324136","description":"2.0.4-alpha bug-fix release","name":"2.0.4-alpha","archived":false,"released":true,"releaseDate":"2013-04-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=robsparker","name":"robsparker","key":"robsparker","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=robsparker&avatarId=15639","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=robsparker&avatarId=15639","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=robsparker&avatarId=15639","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=robsparker&avatarId=15639"},"displayName":"Robert Parker","active":true,"timeZone":"America/Chicago"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-30T15:07:28.834+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12316609","id":"12316609","name":"ha","description":"High Availability"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"Due to absence of explicit timeout in FileJournalManager, error conditions that incur long delay (usually until driver timeout) can make namenode unresponsive for long time. This directly affects NN's failure detection latency, which is critical in HA.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"330380","customfield_12312823":null,"summary":"Add timeout in FileJournalManager","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13668447","id":"13668447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hey Kihwal. Are you planning on using NFS based HA? I'd highly recommend using QJM instead -- it has timeout features and has been much more reliable for us in production clusters.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2013-05-28T17:02:02.002+0000","updated":"2013-05-28T17:02:02.002+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13668529","id":"13668529","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"If the disk driver hangs on a synchronous {{write(2)}} or {{read(2)}}, it doesn't matter what the Java software did-- the operating system thread will be blocked.  This is why we recommended that people soft-mount the NFS directory when using NFS HA.\n\nTodd's suggestion is the best, though-- just use QJM.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-28T18:27:27.410+0000","updated":"2013-05-28T18:27:27.410+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13668534","id":"13668534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"We will certainly use one of the HA-enabled journal managers in the future, but many users I've talked to want NFS-based as a first step. Even if QJM is used for the shared edits directory, local or NFS may still be used for storing extra copy of edits (as non-required resource). In this case, lack of timeout in FJM can affect HA with manual failover. Can health checks used with ZKFC detect I/O hang?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2013-05-28T18:31:51.038+0000","updated":"2013-05-28T18:31:51.038+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13668555","id":"13668555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"If the NameNode hangs, ZKFC will detect it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-28T18:52:11.029+0000","updated":"2013-05-28T18:52:11.029+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13668772","id":"13668772","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"bq. If the NameNode hangs, ZKFC will detect it.\n\nI understand that ZKFC will detect the failures if NN does not respond to RPC calls or the internal resource check fails.  If all RPC handlers are waiting for a very long logSync() to finish, this may be detected as well. But if a couple of handlers are in trouble due to I/O hang and all others are happily serving reads, the error condition may not be detected in time. The situation will be different, of course, if the underlying journal flush can timeout.\n\nI think adding timeout will still be useful since users can run combination of a HA-JM and FJM. Ideally, NN should be able to detect and exclude failed storages with a predictable/configurable latency, regardless of underlying implementation. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2013-05-28T22:49:46.852+0000","updated":"2013-05-28T22:49:46.852+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13668900","id":"13668900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"The Linux kernel doesn't allow you to set a timeout on I/O operations, unless you use O_DIRECT and async I/O.  If operations with the local filesystem take longer than you would like, what are you going to have the NameNode do?  Kill itself?  It can't even kill itself if it is hung on a write, because the process will be in \"D state,\" otherwise known as uninterruptible sleep.\n\nIn this scenario, the NameNode worker thread will be blocked forever, probably while holding the FSImage lock.  There is nothing you can do.  You can't kill the thread, and even if you could, how would you get the mutex back?  There is nothing Java can do when the OS decides your thread cannot run.\n\nThe solution to your problem is that you can easily set a timeout on NFS operations by using a soft mount plus {{timeo=60}} (or whatever timeout you want).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-29T01:34:41.768+0000","updated":"2013-05-29T01:34:41.768+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13669820","id":"13669820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"bq. The Linux kernel doesn't allow you to set a timeout on I/O operations, unless you use O_DIRECT and async I/O. If operations with the local filesystem take longer than you would like, what are you going to have the NameNode do? Kill itself? It can't even kill itself if it is hung on a write, because the process will be in \"D state,\" otherwise known as uninterruptible sleep.\n\nThe thread who's calling fsync() will be in D state. It does not mean all other threads are also stuck. We can have another thread do this and the one who is doing logSync() can observe and timeout. The stuck thread can later determine whether it should terminate if it eventually returns. The failed EditLogOutputStream will be aborted and EditLogFileOutputStream must do this in non-blocking way. Any subsequent logSync() will avoid the troublesome edits directory.\n\nIf the failed one is \"required\", NN will try to exit, which will hang, but the failure will likely be noticed right away. This still provides a shorter failure detection latency and possibility of keeping service up in case the failed edits directory was not required and NN has no other dependency on it.\n\nThis is sort of like simplified user-space-only AIO. The main difference will be that there can only be one outstanding I/O per file descriptor, which doesn't limit our use case.\n\nbq. In this scenario, the NameNode worker thread will be blocked forever, probably while holding the FSImage lock.\n\nIn almost all cases I have seen, it was logSync() that first hit an I/O error condition, probably due to its call frequency. You may see what you mentioned if average fsync() interval is not much higher than checkpoint interval. This hasn't been the case in our production env.\n\nbq. There is nothing you can do. You can't kill the thread, and even if you could, how would you get the mutex back? There is nothing Java can do when the OS decides your thread cannot run.\n\nYou can't kill it, but you can certainly do other things. Otherwise I would call that MT implementation broken. You can certainly design things to work around this condition.\n\nbq. The solution to your problem is that you can easily set a timeout on NFS operations by using a soft mount plus timeo=60 (or whatever timeout you want).\n\nThat only works for NFS.\n\nI fully acknowledge that there are reasonable configurations that do not require this feature to do fast failure detection. But please understand they may be eventually, but are not immediately applicable to all use cases.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2013-05-29T22:34:42.773+0000","updated":"2013-05-29T22:34:42.773+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13669873","id":"13669873","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"Can you be more clear about why just using {{QuorumJournalManager}} plus {{ZKFC}} doesn't solve this problem?\n\nYou don't actually even need local storage directories any more; we only ever recommended them because QJM new and untested.\n\nIt's not just fsync that can block forever, but any write, any read, any fstat, really any blocking operation that touches the filesystem.  I  have seen ls go out to lunch forever on a corrupted filesystem.  Are you going  to add \"check if I timed out and kill myself if so\" recovery logic after every operation that touches the filesystem?  Every {{FileInputStream}} or {{FileOutputStream}} or {{FileChannel}} method?  Are you going to carefully monitor each new patch so that nobody adds back in a use of filechannel.size or whatever?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-29T23:20:41.309+0000","updated":"2013-05-29T23:20:41.309+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13669923","id":"13669923","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"bq. Can you be more clear about why just using QuorumJournalManager plus ZKFC doesn't solve this problem?\n\nAs you said: \"we only ever recommended them because QJM new and untested,\" it's all the additional moving parts that come with a full fledged HA setup, which is not specific to QJM. I originally thought about doing what you suggested plus extra name.dir for making more copies for images. But there are people who don't feel comfortable about getting all at one shot. Some are even opposed to having automatic failover in the initial setup.  I can't persuade them otherwise until everything is thoroughly checked out under our typical load and scale, which we will eventually do.\n\nLast time I checked, which is not very long ago, FJM was not prohibited from being used for shared.edits.dir and the manual failover was not deprecated. IIRC, CDH4 doc also states that this combination is supported.  I am sure that you are not implying improving it is a bad idea.  Please explain further. I seem to keep failing to understand your point.\n\nbq. It's not just fsync that can block forever, but any write, any read, any fstat, really any blocking operation that touches the filesystem. I have seen ls go out to lunch forever on a corrupted filesystem. Are you going to add \"check if I timed out and kill myself if so\" recovery logic after every operation that touches the filesystem? Every FileInputStream or FileOutputStream or FileChannel method? Are you going to carefully monitor each new patch so that nobody adds back in a use of filechannel.size or whatever?\n\nYou are right in that it's not just fsync() that will be hanging. But logSync() is invoked frequently enough to be considered as a reasonable place to check for I/O hang condition. As long as ipc handler threads are not blocked by other threads that are hanging through a different call path, the check will work regardless of which system call those hung threads called.  So, no, you don't have to add \"check if I timed out and kill myself if so\" recovery logic after every operation that touches the filesystem.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2013-05-30T00:31:32.783+0000","updated":"2013-05-30T00:31:32.783+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13669928","id":"13669928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"I just don't think it's worth adding a lot of complexity to FJM, to handle something that's better handled by HA.  Surely that's a reasonable position?\n\nIt's also kind of weird to hear the argument \"HA is too new to deploy, therefore we need to develop a bunch of new code to work around not having it.\"  Wha?\n\nBut I've talked enough, I'll let other people chime in with their opinions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-30T00:48:02.274+0000","updated":"2013-05-30T00:48:02.274+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13669946","id":"13669946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. Last time I checked, which is not very long ago, FJM was not prohibited from being used for shared.edits.dir and the manual failover was not deprecated. IIRC, CDH4 doc also states that this combination is supported. I am sure that you are not implying improving it is a bad idea. Please explain further. I seem to keep failing to understand your point.\n\nI guess I should clarify.  There's nothing wrong with using NFS HA, if you already have a substantial investment in NFS filers.  Keep in mind, though, if your NFS filer itself is not HA, you are just moving the single point of failure around, not eliminating it.  Some Hadoop users have invested quite a lot in highly available NFS filers, and are comfortable using them, which is one reason NFS HA is supported in Hadoop, and will probably continue to be so for a long time.  In some cases these filers were installed prior to Hadoop.  But supported != encouraged for all new installs.  In any case, NFS HA isn't the issue here, the issue is that using either kind of HA should solve your problem without requiring FJM changes.  Another simple thing that would solve the problem is using RAID on the local edit directories.  You would probably have to use hardware raid, though, since in my experience software RAID on Linux had the same issues with threads hitting really slow timeouts when reading from an array where 1 disk was failing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-30T01:18:44.663+0000","updated":"2013-05-30T01:18:44.663+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13669960","id":"13669960","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"[~cmccabe] Please stop preaching to the choir.\n\nKihwal has been contributing to hadoop and supporting many large clusters for a long time and understands the issues more than you give him credit for in these comments. If he wants to explore making FJM more robust, it is up to him. I also believe that not everyone may want to use QJM and that is e reason why these interfaces are plug gable. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-30T01:39:30.816+0000","updated":"2013-05-30T01:39:30.816+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13669982","id":"13669982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"Thank you for the clarification. Fortunately I have a little bit of experience in Linux kernel, storage and fault-tolerance, so I was able to digest what you have described so far. Although you do not recommend the NFS + manual failover, I now understand you are not against a FJM improvement that could benefit existing installations as part of continuing support. I don't believe addition of this feature will be interpreted as a promotion or encouragement, since QJM+ZKFC is clearly newer, more capable and users like your customers are happy with it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2013-05-30T02:11:39.132+0000","updated":"2013-05-30T02:11:39.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649718/comment/13669989","id":"13669989","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"body":"I have no objection to putting FJM operations in separate threads.  It would be a nice improvement.  I am +0 on the whole thing and was just trying to point out alternative approaches.\n\nI describe all this stuff in detail so that everyone can read it, even the people who don't have years of experience like Kihwal and yourself. :)  I also find that writing it down helps me think.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmccabe","name":"cmccabe","key":"cmccabe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cmccabe&avatarId=29060","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cmccabe&avatarId=29060","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cmccabe&avatarId=29060","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cmccabe&avatarId=29060"},"displayName":"Colin P. McCabe","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-30T02:20:14.326+0000","updated":"2013-05-30T02:20:14.326+0000"}],"maxResults":14,"total":14,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-4859/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1kxvr:"}}