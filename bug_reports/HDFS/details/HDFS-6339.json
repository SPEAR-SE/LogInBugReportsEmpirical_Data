{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12712194","self":"https://issues.apache.org/jira/rest/api/2/issue/12712194","key":"HDFS-6339","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/11","id":"11","description":"","name":"Done"},"customfield_12312322":null,"customfield_12310220":"2014-05-05T14:53:54.154+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon May 05 17:08:45 UTC 2014","customfield_12310420":"390513","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_81281975_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-05-05T14:54:40.835+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6339/watchers","watchCount":3,"isWatching":false},"created":"2014-05-04T16:19:58.897+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12325049","id":"12325049","description":"2.2.0 release","name":"2.2.0","archived":false,"released":true,"releaseDate":"2013-10-15"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-05-05T17:08:45.827+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319803","id":"12319803","name":"journal-node","description":"Journal Node for the QJM"}],"timeoriginalestimate":null,"description":"I tried rollback from 2.4.0 to 2.2.0 and noticed that DN, SNN and JN couldn't perform rollback.\n\nI started with a (NN) HA cluster on 2.2.0 and upgraded it to 2.4.0 with HA enabled. Then attempted a rollback to 2.2.0. I first configured my cluster to non-HA and started it on 2.2.0. I started NN & DN with the '-rollback' startup option. (There is no explicit startup option for SNN & JN like NN & DN). Only NN was able to rollback correctly.\n\nMy fixes:\nI fixed the DN rollback problem by cherry-picking the fix from HDFS-5526.\nI fixed the SNN rollback problem by starting it with '-format' option.\n\nI then proceeded to converting the non-HA cluster to a HA cluster. The first step after configuration change was to start the JNs. But they also couldn't rollback.\n\nMy fix:\nI fixed this by deleting the JN data directory. (deleting the 'current' directory and renaming 'previous' to 'current' didn't fix the rollback)\n\nMy purpose for filing this bug is to:\n1. Ask if these problems are known and intended to be fixed in any future releases. If yes, which one? DN rollback was fixed in 2.3.0 but what about 2.2.x series? JN rollback seems (not confirmed) to have been fixed in 2.4.0.\n2. Confirm that \"my fixes\" are correct. If not, please help me with an appropriate fix.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"390766","customfield_12312823":null,"summary":"DN, SNN & JN can't rollback data","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rahulsinghal.iitd","name":"rahulsinghal.iitd","key":"rahulsinghal.iitd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Singhal","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rahulsinghal.iitd","name":"rahulsinghal.iitd","key":"rahulsinghal.iitd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Singhal","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12712194/comment/13989578","id":"13989578","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"This is expected.\n\nUpgrade/rollback with HA was not supported until 2.4. So If you are rolling back from 2.4 HA to a previous version, some manual steps are needed.  In this case, rollback needs to be done with HA off. It means that the shared edits need to be copied to non-HA name.dir or edits.dir depending on your config. If the HA NN was configured to also store edits locally, it is a bit easier.  After successfully rolling back, HA can be re-enabled by initializing shared edits dir and bootstrapping standby.  2NN does not have to persist any state, so you can safely delete the temporary files.\n\nbq. I fixed this by deleting the JN data directory.\nI assume the NN had all edits locally. Otherwise there can be data loss.  Other than this, your procedure seems okay.\n\nIn the future, please use mailing lists for the inquiries of this kind.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2014-05-05T14:53:54.154+0000","updated":"2014-05-05T14:54:12.958+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12712194/comment/13989711","id":"13989711","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rahulsinghal.iitd","name":"rahulsinghal.iitd","key":"rahulsinghal.iitd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Singhal","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks a lot for your reply [~kihwal].\n\nI was testing both cases/paths:\n(non-HA, 2.2.0) -> (non-HA, 2.4.0) -> (non-HA 2.2.0)\n(HA, 2.2.0) -> (HA, 2.4.0) -> (non-HA, 2.2.0) -> (HA, 2.2.0)\n\nThe issue with 2NN was noticed in cases 1. I guess I was mainly confused by the fact that start-dfs.sh does not fromat the 2NN during rollback.\n\n\nThanks for confirming my procedure. And I will use the mailing list for future questions but since you have the context here, I was hoping you could answer one more questions. In what cases, will NN not have all edits locally? Should they be available at edits.dir?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rahulsinghal.iitd","name":"rahulsinghal.iitd","key":"rahulsinghal.iitd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Singhal","active":true,"timeZone":"Asia/Kolkata"},"created":"2014-05-05T17:08:45.827+0000","updated":"2014-05-05T17:08:45.827+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6339/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1v9kf:"}}