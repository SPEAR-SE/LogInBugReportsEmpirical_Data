{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13113214","self":"https://issues.apache.org/jira/rest/api/2/issue/13113214","key":"HDFS-12749","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-10-31T06:42:25.591+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat May 26 22:56:06 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12749/watchers","watchCount":13,"isWatching":false},"created":"2017-10-31T03:43:16.568+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12331979","id":"12331979","description":"2.7.1 release","name":"2.7.1","archived":false,"released":true,"releaseDate":"2015-07-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341106","id":"12341106","name":"2.8.3","archived":false,"released":true,"releaseDate":"2017-12-12"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341257","id":"12341257","description":"2.7.5 release","name":"2.7.5","archived":false,"released":true,"releaseDate":"2017-12-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341433","id":"12341433","description":"3.0.0 GA release","name":"3.0.0","archived":false,"released":true,"releaseDate":"2017-12-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341761","id":"12341761","description":"2.9.1 release","name":"2.9.1","archived":false,"released":true,"releaseDate":"2018-05-03"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-05-26T22:56:06.724+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/10002","description":"A patch for this issue has been uploaded to JIRA by a contributor.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/document.png","name":"Patch Available","id":"10002","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/4","id":4,"key":"indeterminate","colorName":"yellow","name":"In Progress"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"}],"timeoriginalestimate":null,"description":"Now our cluster have thousands of DN, millions of files and blocks. When NN restart, NN's load is very high.\r\nAfter NN restart，DN will call BPServiceActor#reRegister method to register. But register RPC will get a IOException since NN is busy dealing with Block Report.  The exception is caught at BPServiceActor#processCommand.\r\nNext is the caught IOException:\r\n{code:java}\r\nWARN org.apache.hadoop.hdfs.server.datanode.DataNode: Error processing datanode Command\r\njava.io.IOException: Failed on local exception: java.io.IOException: java.net.SocketTimeoutException: 60000 millis timeout while waiting for channel to be ready for read. ch : java.nio.channels.SocketChannel[connected local=/DataNode_IP:Port remote=NameNode_Host/IP:Port]; Host Details : local host is: \"DataNode_Host/Datanode_IP\"; destination host is: \"NameNode_Host\":Port;\r\n        at org.apache.hadoop.net.NetUtils.wrapException(NetUtils.java:773)\r\n        at org.apache.hadoop.ipc.Client.call(Client.java:1474)\r\n        at org.apache.hadoop.ipc.Client.call(Client.java:1407)\r\n        at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:229)\r\n        at com.sun.proxy.$Proxy13.registerDatanode(Unknown Source)\r\n        at org.apache.hadoop.hdfs.protocolPB.DatanodeProtocolClientSideTranslatorPB.registerDatanode(DatanodeProtocolClientSideTranslatorPB.java:126)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.register(BPServiceActor.java:793)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.reRegister(BPServiceActor.java:926)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPOfferService.processCommandFromActor(BPOfferService.java:604)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.processCommand(BPServiceActor.java:898)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.offerService(BPServiceActor.java:711)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.run(BPServiceActor.java:864)\r\n        at java.lang.Thread.run(Thread.java:745)\r\n{code}\r\n\r\nThe un-catched IOException breaks BPServiceActor#register, and the Block Report can not be sent immediately. \r\n{code}\r\n  /**\r\n   * Register one bp with the corresponding NameNode\r\n   * <p>\r\n   * The bpDatanode needs to register with the namenode on startup in order\r\n   * 1) to report which storage it is serving now and \r\n   * 2) to receive a registrationID\r\n   *  \r\n   * issued by the namenode to recognize registered datanodes.\r\n   * \r\n   * @param nsInfo current NamespaceInfo\r\n   * @see FSNamesystem#registerDatanode(DatanodeRegistration)\r\n   * @throws IOException\r\n   */\r\n  void register(NamespaceInfo nsInfo) throws IOException {\r\n    // The handshake() phase loaded the block pool storage\r\n    // off disk - so update the bpRegistration object from that info\r\n    DatanodeRegistration newBpRegistration = bpos.createRegistration();\r\n\r\n    LOG.info(this + \" beginning handshake with NN\");\r\n\r\n    while (shouldRun()) {\r\n      try {\r\n        // Use returned registration from namenode with updated fields\r\n        newBpRegistration = bpNamenode.registerDatanode(newBpRegistration);\r\n        newBpRegistration.setNamespaceInfo(nsInfo);\r\n        bpRegistration = newBpRegistration;\r\n        break;\r\n      } catch(EOFException e) {  // namenode might have just restarted\r\n        LOG.info(\"Problem connecting to server: \" + nnAddr + \" :\"\r\n            + e.getLocalizedMessage());\r\n        sleepAndLogInterrupts(1000, \"connecting to server\");\r\n      } catch(SocketTimeoutException e) {  // namenode is busy\r\n        LOG.info(\"Problem connecting to server: \" + nnAddr);\r\n        sleepAndLogInterrupts(1000, \"connecting to server\");\r\n      }\r\n    }\r\n    \r\n    LOG.info(\"Block pool \" + this + \" successfully registered with NN\");\r\n    bpos.registrationSucceeded(this, bpRegistration);\r\n\r\n    // random short delay - helps scatter the BR from all DNs\r\n    scheduler.scheduleBlockReport(dnConf.initialBlockReportDelay);\r\n  }\r\n{code}\r\nBut NameNode has processed registerDatanode successfully, so it won't ask DN to re-register again","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12895403","id":"12895403","filename":"HDFS-12749.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-02T13:10:50.231+0000","size":5655,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12895403/HDFS-12749.001.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12911516","id":"12911516","filename":"HDFS-12749-branch-2.7.002.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-22T09:30:59.894+0000","size":1308,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12911516/HDFS-12749-branch-2.7.002.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12911717","id":"12911717","filename":"HDFS-12749-trunk.003.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-23T12:42:14.837+0000","size":1383,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12911717/HDFS-12749-trunk.003.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12917385","id":"12917385","filename":"HDFS-12749-trunk.004.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-03T15:26:00.331+0000","size":2130,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12917385/HDFS-12749-trunk.004.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12925261","id":"12925261","filename":"HDFS-12749-trunk.005.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-05-26T20:03:44.824+0000","size":4746,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12925261/HDFS-12749-trunk.005.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"DN may not send block report to NN after NN restart","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16226339","id":"16226339","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"[~tanyuxin] could you attach some more troubleshoot or exception logs?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2017-10-31T06:42:25.591+0000","updated":"2017-10-31T06:42:25.591+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16226405","id":"16226405","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"body":"\r\n{code}\r\n// DN and NN log and timeline about DN re-register\r\n// DN start re-register:\r\n2017-10-26 12:59:35,134 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: DatanodeCommand action : DNA_REGISTER from Namenode_Host/IP:Port with standby state\r\n\r\n// DN SocketTimeoutException and retry to register\r\n2017-10-26 13:02:08,497 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Problem connecting to server: Namenode_Host/IP:Port\r\n2017-10-26 13:06:34,204 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Problem connecting to server: Namenode_Host/IP:Port\r\n\r\n// NN Successfully register the DN\r\n2017-10-26 13:07:24,325 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* registerDatanode: from DatanodeRegistration(DataNode_IP:Port, datanodeUuid=DataNodeUuid, infoPort=DataNode_port, infoSecurePort=0, ipcPort=IPCPort, storageInfo=lv=-57;cid=CID-;nsid=NSID;c=0) storage Storage_ID\r\n\r\n// DN get IOExecption:\r\n2017-10-26 13:07:35,265 WARN org.apache.hadoop.hdfs.server.datanode.DataNode: Error processing datanode Command\r\njava.io.IOException: Failed on local exception: java.io.IOException: java.net.SocketTimeoutException: 60000 millis timeout while waiting for channel to be ready for read. ch : java.nio.channels.SocketChannel[connected local=/DataNode_IP:Port remote=Namenode_Host/IP:Port]; Host Details : local host is: \"DataNode_Host/IP\"; destination host is: \"NameNode_Host\":Port;\r\n        at org.apache.hadoop.net.NetUtils.wrapException(NetUtils.java:773)\r\n        at org.apache.hadoop.ipc.Client.call(Client.java:1474)\r\n        at org.apache.hadoop.ipc.Client.call(Client.java:1407)\r\n        at org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:229)\r\n        at com.sun.proxy.$Proxy13.registerDatanode(Unknown Source)\r\n        at org.apache.hadoop.hdfs.protocolPB.DatanodeProtocolClientSideTranslatorPB.registerDatanode(DatanodeProtocolClientSideTranslatorPB.java:126)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.register(BPServiceActor.java:793)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.reRegister(BPServiceActor.java:926)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPOfferService.processCommandFromActor(BPOfferService.java:604)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.processCommand(BPServiceActor.java:898)\r\n        at org.apache.hadoop.hdfs.server.datanode.BPServiceActor.offerService(\r\n        ...\r\n{code}\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-31T07:37:29.253+0000","updated":"2017-10-31T07:37:29.253+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16227402","id":"16227402","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"The rpc calls are timing out because the NN is not able to serve them fast enough. Influx of full block reports can slow things down.  First of all, they can timeout but will be retried. I.e. datanodes will retransmit.  Also, make sure your NN is configured correctly. E.g. tcp listen queue size, # of handlers, etc.  are enough to absorb surges in requests.  If there are too many large block reports, it may not be possible to completely avoid timeout-retransmission. This also increases the amount/size of objects sitting in the heap and potentially promoted to the old gen prematurely, increasing chance of a full GC.   To lessen the memory pressure during the block report surges, config your cluster to break down full block report down to individual storage level. That way, each RPC will be smaller.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2017-10-31T19:52:28.968+0000","updated":"2017-10-31T19:52:28.968+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16235302","id":"16235302","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user yuxintan opened a pull request:\n\n    https://github.com/apache/hadoop/pull/288\n\n    HDFS-12749. Catch IOException to schedule BlockReport correctly when …\n\n    …DN re-register. (Contributed by TanYuxin)\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/yuxintan/hadoop HDFS-12749\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/hadoop/pull/288.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #288\n    \n----\ncommit 1a7a53d70c3f0e68fb37e3c953e0dea6d4662b70\nAuthor: tanyuxin <tanyuxin@meituan.com>\nDate:   2017-11-02T05:54:51Z\n\n    HDFS-12749. Catch IOException to schedule BlockReport correctly when DN re-register. (Contributed by TanYuxin)\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-02T07:15:33.899+0000","updated":"2017-11-02T07:15:33.899+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16235320","id":"16235320","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"body":"Thanks @kihwal very much for the comments. \r\nDN will retry RPC calls when timeout, but DN won't send BlockReport in BPserviceActor#register if it got an IOException.\r\nHere is the scene occurred in our cluseter.\r\n1. DN BlockReport Interval is set to 10 hours.\r\n2. Restart NN at 1 hours after DN sent last BR.\r\n3. DN re-register to NN, but DN get an IOException and won't send BR immediately. \r\n4. NN will receive DN's BR after 9 more hours later, which is too long.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-02T07:29:47.732+0000","updated":"2017-11-02T07:29:47.732+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16236348","id":"16236348","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue} 16m 35s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 17m 29s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 56s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 45s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  0s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 11m 30s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 58s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 49s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 59s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |\r\n| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 41s{color} | {color:orange} hadoop-hdfs-project/hadoop-hdfs: The patch generated 10 new + 469 unchanged - 0 fixed = 479 total (was 469) {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  1s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 11m  4s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m  7s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 48s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red}131m 46s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:red}-1{color} | {color:red} asflicense {color} | {color:red}  0m 46s{color} | {color:red} The patch generated 1 ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}200m 53s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Failed junit tests | hadoop.hdfs.TestDFSStripedOutputStreamWithRandomECPolicy |\r\n|   | hadoop.fs.contract.hdfs.TestHDFSContractRename |\r\n|   | hadoop.hdfs.TestDFSStripedOutputStreamWithFailure |\r\n|   | hadoop.hdfs.TestDFSStripedOutputStreamWithFailure060 |\r\n|   | hadoop.hdfs.TestDataTransferKeepalive |\r\n|   | hadoop.cli.TestXAttrCLI |\r\n|   | hadoop.hdfs.TestDFSStripedOutputStreamWithFailure020 |\r\n|   | hadoop.hdfs.TestReconstructStripedFile |\r\n|   | hadoop.hdfs.TestDFSStripedOutputStreamWithFailure130 |\r\n|   | hadoop.hdfs.TestDFSStripedOutputStreamWithFailure070 |\r\n|   | hadoop.hdfs.TestFileChecksum |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:5b98639 |\r\n| JIRA Issue | HDFS-12749 |\r\n| GITHUB PR | https://github.com/apache/hadoop/pull/288 |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux f6bf160befe5 3.13.0-119-generic #166-Ubuntu SMP Wed May 3 12:18:55 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / d00b6f7 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_131 |\r\n| findbugs | v3.1.0-RC1 |\r\n| checkstyle | https://builds.apache.org/job/PreCommit-HDFS-Build/21925/artifact/out/diff-checkstyle-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/21925/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/21925/testReport/ |\r\n| asflicense | https://builds.apache.org/job/PreCommit-HDFS-Build/21925/artifact/out/patch-asflicense-problems.txt |\r\n| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/21925/console |\r\n| Powered by | Apache Yetus 0.7.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2017-11-02T18:33:38.412+0000","updated":"2017-11-02T18:33:38.412+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16364280","id":"16364280","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"ping [~xkrogen]\r\nI also had seen this problems in our big production cluster, and I think this is a blocked issue.\r\nThe issue was original reported by my colleague [~tanyuxin] and we applied this patch to our production cluster based branch-2.7, the problems as mentioned above disappears.\r\n\r\nI think the description of this ticket may lead to little ambiguity. I would like to offer more information,\r\n\r\na) {{BPServiceActor#register}} only catch exception {{EOFException}} and {{SocketTimeoutException}} (both are subclass of IOException) when register to NameNode.\r\nb) when the request pass to under {{RPC}} layer, {{Client#call}} (line 1448) may throw many type exceptions, such as {{InterruptedIOException}}, {{IOException}}, etc. of course for different exception reasons.\r\nc) Load of NameNode may very high during restarting process, especially in big cluster. when datanode reregister to namenode at this time, {{RPC#Client}} may throw IOException (not subclass of IOException) to {{BPServiceActor#register}} as [~tanyuxin] describe above.\r\nd) The IOException will be catch by {{BPServiceActor#processCommand}} and print warn log {{`WARN org.apache.hadoop.hdfs.server.datanode.DataNode: Error processing datanode Command`}} but not reinit context of {{BlockPool}} when reregister and continue run, so {{BlockReport}} will not be scheduled immediately (when DataNode send {{BlockReport}} to restarting NameNode based on the last {{BlockReport}} time.)\r\ne) Actually, There are other subsequent problems besides NOT schedule {{BlockReport}} immediately. Such as block token secret keys not update correctly and client can not read {{Blocks}} from this DataNode even if hold the correct BlockToken.\r\n\r\nI have reviewed patch and one minor suggestion,\r\na) please rebase an active branch (such as branch-2.7) and offer new patch;\r\nb) it will be better if add new UnitTest for this fix.\r\n\r\nIf I am wrong please correct me. [~tanyuxin]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-14T15:33:31.498+0000","updated":"2018-02-14T15:33:31.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16364305","id":"16364305","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m  0s{color} | {color:blue} Docker mode activated. {color} |\r\n| {color:red}-1{color} | {color:red} patch {color} | {color:red}  0m  7s{color} | {color:red} HDFS-12749 does not apply to trunk. Rebase required? Wrong Branch? See https://wiki.apache.org/hadoop/HowToContribute for help. {color} |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| JIRA Issue | HDFS-12749 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12895403/HDFS-12749.001.patch |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/23067/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-14T15:50:52.964+0000","updated":"2018-02-14T15:50:52.964+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16364356","id":"16364356","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"body":"Hey [~hexiaoqiao], I have to admit I'm not familiar with this portion of the codebase. But it seems that the underlying issue is still a {{SocketTimeoutException}}, which we are trying to catch. Is this just an issue of an exception being over-wrapped? If it is over-wrapped in this case, is there any case where it won't be, i.e. is that catch statement actually useful as-is? {{NetUtils.wrapException}} will properly maintain the class of a {{SocketTimeoutException}}; I dug around a little and it was not immediately obvious to me why it received an {{IOException}} wrapped around a timeout rather than just a timeout.\r\n\r\nIt does seem that probably we want to catch all {{IOException}} here, but like I said I'm not familiar with this area and don't know if there is a good reason not to. Maybe re-ping [~kihwal] - I definitely agree that with proper tuning this issue shouldn't happen, but it does seem that the original complaint is valid and that this could be more robust. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-02-14T16:23:41.047+0000","updated":"2018-02-14T16:38:45.465+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16364508","id":"16364508","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"What was the command that failed when you saw \"Error processing datanode Command\"?  If the processing of DNA_REGISTER blew up with an IOException, the DN would have gotten the command again in the next hearbeat and retried. The block token secret is updated (DNA_ACCESSKEYUPDATE)  in the first heartbeat after registration. There can be other commands along with it, but failure of processing a command does not abort the whole processing, so that shouldn't matter.  We need to understand where exactly it went wrong.  More detailed exception/stack traces, thread name (so that we can tell which actor thread it came from), timing, etc. will be helpful.\r\n\r\n\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-02-14T17:52:40.735+0000","updated":"2018-02-14T17:52:40.735+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16364520","id":"16364520","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"body":"[~kihwal], IIUC, the problem is that the NN correctly processed the registration, but the DN timed out before receiving the response. Since from NN point of view the registration was complete, it did not send another DNA_REGISTER command. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-02-14T18:00:04.836+0000","updated":"2018-02-14T18:00:32.422+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16364731","id":"16364731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"I see. The old registration looks identical to the new one, so NN still accepts it.  About catching IOException: if the registration fails with a RemoteException that is not RetriableException, the actor may need to stop instead of retrying. Also, if we choose to blank something out before trying to re-register to re-trigger registration, we should avoid hitting something like HDFS-8995.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-02-14T20:34:00.240+0000","updated":"2018-02-14T20:34:00.240+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16365105","id":"16365105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"[~kihwal],[~xkrogen] Thanks for your comments.\r\n{quote}the problem is that the NN correctly processed the registration, but the DN timed out before receiving the response. Since from NN point of view the registration was complete, it did not send another DNA_REGISTER command.{quote}\r\nthanks for your additional comments [~xkrogen].\r\nSince NN considers DN register successfully but DN timeout before receiving response, and DN would not get DNA_REGISTER command from NN at next heartbeat intervel. If as except, DN should catch exception in {{BPServiceActor#register}} and retry until register successfully as catching {{SocketTimeoutException}} or {{EOFException}} currently. \r\n\r\nOne question is why underlying RPC not throw {{SocketTimeoutException}} but {{IOException}}, After trace invoke stack, I find {{NetUtils#wrapException}} who invoke by {{Client#call}} line 1474 may be the main reason.\r\n{code:java}\r\n      if (call.error != null) {\r\n        if (call.error instanceof RemoteException) {\r\n          call.error.fillInStackTrace();\r\n          throw call.error;\r\n        } else { // local exception\r\n          InetSocketAddress address = connection.getRemoteAddress();\r\n          throw NetUtils.wrapException(address.getHostName(),\r\n                  address.getPort(),\r\n                  NetUtils.getHostname(),\r\n                  0,\r\n                  call.error);\r\n        }\r\n{code}\r\nbut I am confused why {{call.error}} set IOException and throw upper lead to {{BPServiceActor#register}} not catch it. \r\nAfter reviewed HDFS-8995 I think it could not fix this issue.\r\n\r\nAnyway, I agree to fix ti with catching IOException in {{BPServiceActor#register}} and retry until register successfully.\r\n[~kihwal],[~xkrogen] do you mind having a look?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-15T03:36:05.286+0000","updated":"2018-02-15T03:36:05.286+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16372595","id":"16372595","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"ping [~kihwal], [~xkrogen]\r\nI upload new patch rebase branch-2.7, FYI. \r\n\r\nThe fundamental reason of this issue is {{BPServiceActor#register}} not catch {{IOException}}. \r\ntrigger conditions:\r\na. Restart {{NameNode}}, rather than restart {{DataNode}},\r\nb. high load of NameNode when restart, (it is easily reappeared in a large scale cluster)\r\n\r\nFor [~tanyuxin] reported case,\r\nwhen NameNode restart, all datanodes in cluster need to re-retrieve namespace info (#versionRequest) and re-register (#registerDatanode), but all RPC request from DataNode to NameNode may meet SocketTimeoutException or IOException due to high load of NameNode. while {{BPServiceActor#register}} meet IOException, it will continue to throw up until catch by {{BPServiceActor#processCommand}} and return true, however block report not be scheduled since meet exception before, so DataNode will wait for most {{blockReportInterval}} to send block report to {{NameNode}}.\r\n\r\nNOTE: {{BPServiceActor#retrieveNamespaceInfo}} catch IOException when invoke {{bpNamenode.versionRequest()}} for reference:\r\n{code:java}\r\n    while (shouldRun()) {\r\n      try {\r\n        nsInfo = bpNamenode.versionRequest();\r\n        LOG.debug(this + \" received versionRequest response: \" + nsInfo);\r\n        break;\r\n      } catch(SocketTimeoutException e) {  // namenode is busy\r\n        LOG.warn(\"Problem connecting to server: \" + nnAddr);\r\n      } catch(IOException e ) {  // namenode is not available\r\n        LOG.warn(\"Problem connecting to server: \" + nnAddr);\r\n      }\r\n      \r\n      // try again in a second\r\n      sleepAndLogInterrupts(5000, \"requesting version info from NN\");\r\n    }\r\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-22T09:29:53.855+0000","updated":"2018-02-22T09:29:53.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16372717","id":"16372717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue} 16m 39s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |\r\n|| || || || {color:brown} branch-2.7 Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  6m  0s{color} | {color:green} branch-2.7 passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m  1s{color} | {color:green} branch-2.7 passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 24s{color} | {color:green} branch-2.7 passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  0s{color} | {color:green} branch-2.7 passed {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m 57s{color} | {color:green} branch-2.7 passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 43s{color} | {color:green} branch-2.7 passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 55s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  1m  1s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  1m  1s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 21s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 58s{color} | {color:green} the patch passed {color} |\r\n| {color:red}-1{color} | {color:red} whitespace {color} | {color:red}  0m  0s{color} | {color:red} The patch has 60 line(s) that end in whitespace. Use git apply --whitespace=fix <<patch_file>>. Refer https://git-scm.com/docs/git-apply {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  3m  8s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  1m 42s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red} 94m 48s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  1m 12s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}135m 28s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Unreaped Processes | hadoop-hdfs:24 |\r\n| Failed junit tests | hadoop.hdfs.TestFileCreationEmpty |\r\n| Timed out junit tests | org.apache.hadoop.hdfs.TestDatanodeRegistration |\r\n|   | org.apache.hadoop.hdfs.TestDFSClientFailover |\r\n|   | org.apache.hadoop.hdfs.TestSetrepIncreasing |\r\n|   | org.apache.hadoop.hdfs.TestDatanodeDeath |\r\n|   | org.apache.hadoop.hdfs.TestDFSClientRetries |\r\n|   | org.apache.hadoop.hdfs.TestDFSFinalize |\r\n|   | org.apache.hadoop.hdfs.TestHDFSFileSystemContract |\r\n|   | org.apache.hadoop.hdfs.TestDatanodeStartupFixesLegacyStorageIDs |\r\n|   | org.apache.hadoop.hdfs.TestDecommission |\r\n|   | org.apache.hadoop.hdfs.TestSeekBug |\r\n|   | org.apache.hadoop.hdfs.TestDatanodeReport |\r\n|   | org.apache.hadoop.hdfs.web.TestWebHDFS |\r\n|   | org.apache.hadoop.hdfs.web.TestWebHDFSXAttr |\r\n|   | org.apache.hadoop.hdfs.TestDFSRollback |\r\n|   | org.apache.hadoop.hdfs.TestMiniDFSCluster |\r\n|   | org.apache.hadoop.hdfs.TestDistributedFileSystem |\r\n|   | org.apache.hadoop.hdfs.web.TestWebHDFSForHA |\r\n|   | org.apache.hadoop.hdfs.TestDFSClientExcludedNodes |\r\n|   | org.apache.hadoop.hdfs.TestBalancerBandwidth |\r\n|   | org.apache.hadoop.hdfs.TestSetTimes |\r\n|   | org.apache.hadoop.hdfs.TestDFSShell |\r\n|   | org.apache.hadoop.hdfs.TestDataTransferProtocol |\r\n|   | org.apache.hadoop.hdfs.web.TestWebHDFSAcl |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:ea57d10 |\r\n| JIRA Issue | HDFS-12749 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12911516/HDFS-12749-branch-2.7.002.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux bb5dee397f8e 3.13.0-135-generic #184-Ubuntu SMP Wed Oct 18 11:55:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | branch-2.7 / 1f2ab8b |\r\n| maven | version: Apache Maven 3.0.5 |\r\n| Default Java | 1.7.0_151 |\r\n| findbugs | v3.0.0 |\r\n| whitespace | https://builds.apache.org/job/PreCommit-HDFS-Build/23150/artifact/out/whitespace-eol.txt |\r\n| Unreaped Processes Log | https://builds.apache.org/job/PreCommit-HDFS-Build/23150/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs-reaper.txt |\r\n| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/23150/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/23150/testReport/ |\r\n| Max. process+thread count | 5397 (vs. ulimit of 5500) |\r\n| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/23150/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-22T11:56:07.058+0000","updated":"2018-02-22T11:56:07.058+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16372749","id":"16372749","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"check failed UT(#TestFileCreationEmpty) and test locally, it seems to work fine and might not relate to this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-22T12:27:22.086+0000","updated":"2018-02-22T12:27:22.086+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16373667","id":"16373667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"bq. About catching IOException: if the registration fails with a RemoteException that is not RetriableException, the actor may need to stop instead of retrying.\r\nIt seems okay to retry there, but it should not unconditionally retry on all {{IOException}}.   Take a look at the catch block in {{offerService()}}.   Also the initial patch should be submitted against trunk.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-02-22T23:23:05.127+0000","updated":"2018-02-22T23:23:05.127+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16374295","id":"16374295","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks to [~kihwal] for review and comments.\r\n{quote}It seems okay to retry there, but it should not unconditionally retry on all IOException{quote}\r\nV2 does not make sense when catch all {{IOException}} and retry, especially {{DataNode}} register at the first time when restart. I just submit V3 based trunk and separate to catch {{RemoteException}} and throw up. Thanks again [~kihwal]. Please correct me If there is something wrong.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-23T12:40:20.349+0000","updated":"2018-02-23T12:40:20.349+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16374515","id":"16374515","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 22s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 17m 36s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 55s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 40s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  0s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 11m 32s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 53s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 52s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 58s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 51s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 51s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 35s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 57s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 10m 54s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m  0s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 50s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red}120m 34s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 23s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}172m 39s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Failed junit tests | hadoop.hdfs.server.namenode.ha.TestRetryCacheWithHA |\r\n|   | hadoop.hdfs.server.datanode.TestDataNodeVolumeFailure |\r\n|   | hadoop.hdfs.server.namenode.TestReencryptionWithKMS |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:5b98639 |\r\n| JIRA Issue | HDFS-12749 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12911717/HDFS-12749-trunk.003.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux bd626db8f0c1 3.13.0-135-generic #184-Ubuntu SMP Wed Oct 18 11:55:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / d1cd573 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_151 |\r\n| findbugs | v3.1.0-RC1 |\r\n| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/23169/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/23169/testReport/ |\r\n| Max. process+thread count | 3002 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/23169/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-23T15:43:17.378+0000","updated":"2018-02-23T15:43:17.378+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16374858","id":"16374858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"body":"v003 patch LGTM! Thanks for pushing this [~hexiaoqiao] and sorry for the slow response.\r\n\r\nI wanted to dig deeper to understand why the {{SocketTimeoutException}} was over-wrapped in an extra {{IOException}}, which was also a cause of this problem. As far as I can tell, it comes from this code block within {{Client.Connection#setupIOStreams}}:\r\n{code}\r\n            try {\r\n              authMethod = ticket\r\n                  .doAs(new PrivilegedExceptionAction<AuthMethod>() {\r\n                    @Override\r\n                    public AuthMethod run()\r\n                        throws IOException, InterruptedException {\r\n                      return setupSaslConnection(ipcStreams);\r\n                    }\r\n                  });\r\n            } catch (IOException ex) {\r\n              if (saslRpcClient == null) {\r\n                // whatever happened -it can't be handled, so rethrow\r\n                throw ex;\r\n              }\r\n              // otherwise, assume a connection problem\r\n              authMethod = saslRpcClient.getAuthMethod();\r\n              if (rand == null) {\r\n                rand = new Random();\r\n              }\r\n              handleSaslConnectionFailure(numRetries++, maxRetriesOnSasl, ex,\r\n                  rand, ticket);\r\n              continue;\r\n            }\r\n{code}\r\nThe signature of {{handleSaslConnectionFailure}} accepts an {{Exception}} rather than {{IOException}} (even though this is its only usage), so it additionally wraps this in a new {{IOException}}:\r\n{code}\r\n    private synchronized void handleSaslConnectionFailure(\r\n        final int currRetries, final int maxRetries, final Exception ex,\r\n        final Random rand, final UserGroupInformation ugi) throws IOException,\r\n        InterruptedException {\r\n          ...\r\n          if (shouldAuthenticateOverKrb()) {\r\n            if (currRetries < maxRetries) {\r\n              ...\r\n              return null;\r\n            } else {\r\n              ...\r\n              throw (IOException) new IOException(msg).initCause(ex);\r\n            }\r\n          } else {\r\n            LOG.warn(\"Exception encountered while connecting to \"\r\n                + \"the server : \" + ex);\r\n          }\r\n          if (ex instanceof RemoteException)\r\n            throw (RemoteException) ex;\r\n          throw new IOException(ex);\r\n        }\r\n      });\r\n    }\r\n{code}\r\nIt looks like the case where it wraps with no additional message would only occur in an unkerberized cluster. Are you running without Kerberos? Do you see a relevant WARN statement from the log for {{ipc.Client}}? In any case I think we should modify {{handleSaslConnectionFailure}} to accept {{IOException}} and avoid the additional wrap.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-02-23T19:07:16.473+0000","updated":"2018-02-23T19:09:41.762+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16375299","id":"16375299","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"[~xkrogen] Thanks for your review and comments.\r\n{quote}Are you running without Kerberos? Do you see a relevant WARN statement from the log for ipc.Client?\r\n{quote}\r\na. This is security cluster with Kerberos,\r\n b. All relevant WARN or EXCEPTION depict as [~tanyuxin] mentioned above (description & second comment.)\r\n\r\nBased on the exception logs that [~tanyuxin] provided, I think {{SocketTimeoutException}} was over-wrapped in extra {{IOException}} by {{Client#cleanupCalls}}, the following notes based branch-2.7 (maybe I am wrong, if that please correct me.)\r\n a. Client#call (line:1448) throws {{IOException}} which wrapped {{SocketTimeoutException}} when {{call.error}} is not null and it is not instance of {{RemoteException}}, thus this exception is wrapped by {{NetUtils#wrapException}}:\r\n{code:java}\r\n  public Writable call(RPC.RpcKind rpcKind, Writable rpcRequest,\r\n      ConnectionId remoteId, int serviceClass,\r\n      AtomicBoolean fallbackToSimpleAuth) throws IOException {\r\n    final Call call = createCall(rpcKind, rpcRequest);\r\n    Connection connection = getConnection(remoteId, call, serviceClass,\r\n      fallbackToSimpleAuth);\r\n    try {\r\n      connection.sendRpcRequest(call);                 // send the rpc request\r\n    } catch (RejectedExecutionException e) {\r\n      throw new IOException(\"connection has been closed\", e);\r\n    } catch (InterruptedException e) {\r\n      Thread.currentThread().interrupt();\r\n      LOG.warn(\"interrupted waiting to send rpc request to server\", e);\r\n      throw new IOException(e);\r\n    }\r\n\r\n    synchronized (call) {\r\n      while (!call.done) {\r\n        try {\r\n          call.wait();                           // wait for the result\r\n        } catch (InterruptedException ie) {\r\n          Thread.currentThread().interrupt();\r\n          throw new InterruptedIOException(\"Call interrupted\");\r\n        }\r\n      }\r\n\r\n      if (call.error != null) {\r\n        if (call.error instanceof RemoteException) {\r\n          call.error.fillInStackTrace();\r\n          throw call.error;\r\n        } else { // local exception\r\n          InetSocketAddress address = connection.getRemoteAddress();\r\n          throw NetUtils.wrapException(address.getHostName(),\r\n                  address.getPort(),\r\n                  NetUtils.getHostname(),\r\n                  0,\r\n                  call.error);\r\n        }\r\n      } else {\r\n        return call.getRpcResponse();\r\n      }\r\n    }\r\n  }\r\n{code}\r\nb. {{NetUtils#wrapException}} can distinguish {{SocketTimeoutException}} if {{call.error}} is instance of, but not actually so logs `Failed on local exception: java.io.IOException: ...`\r\n c. {{call.error}} is set only by client#setException which invoked by {{Client#receiveRpcResponse}} and {{Client#cleanupCalls}}, however {{call.error}} is set RemoteException always in {{Client#receiveRpcResponse}}. Evidently, the only possibility is that {{SocketTimeoutException}} was over-wrapped in {{IOException}} by {{Client#cleanupCalls}}.\r\n d.The key point in {{Client#cleanupCalls}} is {{#closeException}} which is set by {{Client#markClosed}} invoked by {{Client#sendRpcRequest}} and it catch all {{IOException}} then set {{#closeException}} equal it.\r\n{code:java}\r\n    public void sendRpcRequest(final Call call)\r\n        throws InterruptedException, IOException {\r\n      ......\r\n      synchronized (sendRpcRequestLock) {\r\n        Future<?> senderFuture = sendParamsExecutor.submit(new Runnable() {\r\n          @Override\r\n          public void run() {\r\n            try {\r\n              ......\r\n            } catch (IOException e) {\r\n              // exception at this point would leave the connection in an\r\n              // unrecoverable state (eg half a call left on the wire).\r\n              // So, close the connection, killing any outstanding calls\r\n              markClosed(e);\r\n            } finally {\r\n              //the buffer is just an in-memory buffer, but it is still polite to\r\n              // close early\r\n              IOUtils.closeStream(d);\r\n            }\r\n          }\r\n        });\r\n        .....\r\n      }\r\n    }\r\n{code}\r\n[~xkrogen],[~kihwal] any suggestions? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-24T04:41:21.485+0000","updated":"2018-02-24T04:41:21.485+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16380179","id":"16380179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"ping [~xkrogen],[~kihwal] any suggestions or feedback for this issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-02-28T11:57:45.111+0000","updated":"2018-02-28T11:57:45.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16380482","id":"16380482","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"body":"I think the v003 patch is fine to resolve this issue. I am not a committer so cannot help you commit based on my review.\r\n\r\nI am not satisfied that we fully understand the over-wrapped exception, but that is not critical for this bug fix. Maybe let's open a new JIRA to discuss resolution.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xkrogen","name":"xkrogen","key":"xkrogen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=xkrogen&avatarId=34526","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=xkrogen&avatarId=34526","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=xkrogen&avatarId=34526","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=xkrogen&avatarId=34526"},"displayName":"Erik Krogen","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-02-28T15:37:17.503+0000","updated":"2018-02-28T15:37:17.503+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16382040","id":"16382040","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks [~xkrogen] for your review all the same.\r\n{quote}I am not satisfied that we fully understand the over-wrapped exception{quote}\r\n[~xkrogen] do you have any different opinions? look forwards to your share. thanks again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-03-01T14:13:13.676+0000","updated":"2018-03-01T14:13:13.676+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16383110","id":"16383110","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"body":"Thanks [~hexiaoqiao]  [~xkrogen] very much for reviewing and resolving the issue. I think v003 patch committed by [~hexiaoqiao] is more effective and simpler. \r\nAnyone mind having a review?  In our production cluster, the problem has been fixed for months by the proposed patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tanyuxin","name":"tanyuxin","key":"tanyuxin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"TanYuxin","active":true,"timeZone":"Etc/UTC"},"created":"2018-03-02T03:39:34.581+0000","updated":"2018-03-02T03:39:34.581+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16386430","id":"16386430","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"[~kihwal] could you help to review or give some suggestions?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-03-05T17:50:19.397+0000","updated":"2018-03-05T17:50:19.397+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16411417","id":"16411417","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"Sorry for the delay. I will review it in a couple of days.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-03-23T13:54:33.188+0000","updated":"2018-03-23T13:54:33.188+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16416048","id":"16416048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"The latest patch is a step in the right direction. Some of the exceptions thrown by namenode to datanode are fatal and terminal. I.e. retry will never work.  The catch block of {{offerService()}} takes this into account. Simply throwing one in {{register()}} will get ignored in {{BPServiceActor#processCommand()}}. {{shouldServiceRun}} needs to be set false in order to stop the actor thread.\r\n\r\n{code:java}\r\n     } catch(RemoteException re) {\r\n        String reClass = re.getClassName();\r\n        if (UnregisteredNodeException.class.getName().equals(reClass) ||\r\n            DisallowedDatanodeException.class.getName().equals(reClass) ||\r\n            IncorrectVersionException.class.getName().equals(reClass)) {\r\n          LOG.warn(this + \" is shutting down\", re);\r\n          shouldServiceRun = false;\r\n          return;\r\n        }\r\n        LOG.warn(\"RemoteException in offerService\", re);\r\n        sleepAfterException();\r\n      } catch (IOException e) {\r\n        LOG.warn(\"IOException in offerService\", e);\r\n        sleepAfterException();\r\n      }\r\n {code}\r\n\r\nYou can keep your change in {{register()}} and simply add the same logic to the {{processCommand()}}'s catch block. I.e. crack open the {{RemoteException}} and stop the actor thread if it is one of the terminal exceptions.\r\n\r\nI know it's hard, but it will be nice if you can add a test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-03-27T18:29:41.124+0000","updated":"2018-03-27T18:29:41.124+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16417802","id":"16417802","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"Thanks [~kihwal] for your detailed comment.\r\n{quote}You can keep your change in register() and simply add the same logic to the processCommand()'s catch block. I.e. crack open the RemoteException and stop the actor thread if it is one of the terminal exceptions.{quote}\r\nI think it may not be able to resolve this issue when catch and crack {{RemoteException}} for #processCommand, since #processCommand throws {{IOException}} which wrap {{SocketTimeoutException}} as [~tanyuxin] mentioned in description\r\n{quote}java.io.IOException: Failed on local exception: java.io.IOException: java.net.SocketTimeoutException: 60000 millis timeout while waiting for channel to be ready for read. ch : java.nio.channels.SocketChannel{quote}\r\nAccording to your suggestions, is it better to create new issue to push that stop the actor thread if it meet some fatal or terminal exceptions? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-03-28T17:29:15.763+0000","updated":"2018-03-28T17:29:15.763+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16420758","id":"16420758","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"The {{register()}} method is called from two different contexts. BP service actor loop and command processing (through {{reRegister()}}). The quoted code above is from the actor loop.  In the {{catch}} block of {{processCommand()}}, you can add an equivalent logic. \r\n\r\n{code}\r\n  boolean processCommand(DatanodeCommand[] cmds) {\r\n    if (cmds != null) {\r\n      for (DatanodeCommand cmd : cmds) {\r\n        try {\r\n          if (bpos.processCommandFromActor(cmd, this) == false) {\r\n            return false;\r\n          }\r\n        } catch(RemoteException re) {\r\n          String reClass = re.getClassName();\r\n          if (UnregisteredNodeException.class.getName().equals(reClass) ||\r\n              DisallowedDatanodeException.class.getName().equals(reClass) ||\r\n              IncorrectVersionException.class.getName().equals(reClass)) {\r\n            LOG.warn(this + \" is shutting down\", re);\r\n            shouldServiceRun = false;\r\n            return false;\r\n          }\r\n        } catch (IOException ioe) {\r\n          LOG.warn(\"Error processing datanode Command\", ioe);\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n{code}\r\n\r\nYour version of {{register()}} will retry on {{IOException}}, which includes IPC timeout. If the NN explicitly throws a {{RemoteException}}, this will be caught and rethrown in your updated {{register()}}.  This will bubble up to {{processCommand()}} above, which will stop the service actor if the condition is terminal.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-03-30T17:40:33.466+0000","updated":"2018-03-30T17:40:33.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16422668","id":"16422668","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"[~kihwal] Thanks for your feedback. I misunderstood your idea above. It is indeed to fix in the catch block of {{processCommand()}},  I will solve this issue in couple of days.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-02T16:01:24.099+0000","updated":"2018-04-02T16:01:24.099+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16424184","id":"16424184","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"update patch v4 and fix bug based comments and without testcase.\r\n[~kihwal], I don't find a grace way to test the scenario that NN correctly processed the registration, but the DN timed out before receiving the response, do you have a good idea?\r\nThanks again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-03T15:37:26.650+0000","updated":"2018-04-03T15:37:26.650+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16424402","id":"16424402","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue} 16m 31s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:red}-1{color} | {color:red} test4tests {color} | {color:red}  0m  0s{color} | {color:red} The patch doesn't appear to include any new or modified tests. Please justify why no new tests are needed for this patch. Also please list what manual steps were performed to verify this patch. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 22m 41s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 49s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 39s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 53s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green}  9m 49s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 38s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 39s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  0m 54s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 49s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 49s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 38s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  0m 53s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green}  9m 16s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 47s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 40s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red}105m 22s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 19s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}174m  3s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Failed junit tests | hadoop.hdfs.web.TestWebHdfsTimeouts |\r\n|   | hadoop.hdfs.server.datanode.TestDataNodeVolumeFailureReporting |\r\n|   | hadoop.hdfs.TestSafeModeWithStripedFileWithRandomECPolicy |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:8620d2b |\r\n| JIRA Issue | HDFS-12749 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12917385/HDFS-12749-trunk.004.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux 5cca398ec0d7 4.4.0-64-generic #85-Ubuntu SMP Mon Feb 20 11:50:30 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / 5a174f8 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_162 |\r\n| findbugs | v3.1.0-RC1 |\r\n| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/23763/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/23763/testReport/ |\r\n| Max. process+thread count | 3466 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/23763/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-03T18:30:10.886+0000","updated":"2018-04-03T18:30:10.886+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16442942","id":"16442942","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"ping [~kihwal],[~daryn],[~arpitagarwal],[~ajayydv] do you mind having a look?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-04-18T17:51:17.291+0000","updated":"2018-04-18T17:51:17.291+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16484503","id":"16484503","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"The patch looks good, but a test case would still be good. We can test whether the exception handling in non-startup registration is working. That is not directly testing the reported issue, but will check whether the new code is working.\r\n\r\nHere is what I think can be done.\r\n - Setup up a mini dfs cluster with an include host file. Refresh/reload if necessary\r\n - Remove a datanode from the include file.\r\n - Force re-registration of the datanode.\r\n - In detailedRpc metrics, {{DisallowedDatanodeExceptionNumOps}} should not go up. I.e. the BP actor thread should shutdown.\r\n The existing behavior is that the BP actor thread retries forever despite the exception. Your patch also fixes this issue by handling exceptions properly in DNA_REGISTER command processing.\r\n\r\nSee various existing test cases such as {{TestDatanodeRegistration#testForcedRegistration}} for hints. See test cases using {{HostsFileWriter}} for examples of include host file and refreshing it. Decommissioning tests use it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2018-05-22T20:21:08.412+0000","updated":"2018-05-22T20:21:08.412+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16491812","id":"16491812","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"body":"thanks [~kihwal], v005 patch is with test case following your suggestions, FYI. I looks forward to your feedback.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hexiaoqiao","name":"hexiaoqiao","key":"hexiaoqiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hexiaoqiao&avatarId=26980","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hexiaoqiao&avatarId=26980","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hexiaoqiao&avatarId=26980","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hexiaoqiao&avatarId=26980"},"displayName":"He Xiaoqiao","active":true,"timeZone":"Asia/Shanghai"},"created":"2018-05-26T20:07:32.306+0000","updated":"2018-05-26T20:07:32.306+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13113214/comment/16491844","id":"16491844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"body":"| (x) *{color:red}-1 overall{color}* |\r\n\\\\\r\n\\\\\r\n|| Vote || Subsystem || Runtime || Comment ||\r\n| {color:blue}0{color} | {color:blue} reexec {color} | {color:blue}  0m 37s{color} | {color:blue} Docker mode activated. {color} |\r\n|| || || || {color:brown} Prechecks {color} ||\r\n| {color:green}+1{color} | {color:green} @author {color} | {color:green}  0m  0s{color} | {color:green} The patch does not contain any @author tags. {color} |\r\n| {color:green}+1{color} | {color:green} test4tests {color} | {color:green}  0m  0s{color} | {color:green} The patch appears to include 1 new or modified test files. {color} |\r\n|| || || || {color:brown} trunk Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green} 26m 20s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 57s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} checkstyle {color} | {color:green}  0m 50s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  3s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 12m 10s{color} | {color:green} branch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  1m 53s{color} | {color:green} trunk passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 47s{color} | {color:green} trunk passed {color} |\r\n|| || || || {color:brown} Patch Compile Tests {color} ||\r\n| {color:green}+1{color} | {color:green} mvninstall {color} | {color:green}  1m  2s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} compile {color} | {color:green}  0m 55s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javac {color} | {color:green}  0m 55s{color} | {color:green} the patch passed {color} |\r\n| {color:orange}-0{color} | {color:orange} checkstyle {color} | {color:orange}  0m 47s{color} | {color:orange} hadoop-hdfs-project/hadoop-hdfs: The patch generated 2 new + 48 unchanged - 0 fixed = 50 total (was 48) {color} |\r\n| {color:green}+1{color} | {color:green} mvnsite {color} | {color:green}  1m  0s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} whitespace {color} | {color:green}  0m  0s{color} | {color:green} The patch has no whitespace issues. {color} |\r\n| {color:green}+1{color} | {color:green} shadedclient {color} | {color:green} 11m 29s{color} | {color:green} patch has no errors when building and testing our client artifacts. {color} |\r\n| {color:green}+1{color} | {color:green} findbugs {color} | {color:green}  2m  9s{color} | {color:green} the patch passed {color} |\r\n| {color:green}+1{color} | {color:green} javadoc {color} | {color:green}  0m 46s{color} | {color:green} the patch passed {color} |\r\n|| || || || {color:brown} Other Tests {color} ||\r\n| {color:red}-1{color} | {color:red} unit {color} | {color:red}102m 21s{color} | {color:red} hadoop-hdfs in the patch failed. {color} |\r\n| {color:green}+1{color} | {color:green} asflicense {color} | {color:green}  0m 26s{color} | {color:green} The patch does not generate ASF License warnings. {color} |\r\n| {color:black}{color} | {color:black} {color} | {color:black}165m 19s{color} | {color:black} {color} |\r\n\\\\\r\n\\\\\r\n|| Reason || Tests ||\r\n| Failed junit tests | hadoop.hdfs.TestSafeModeWithStripedFileWithRandomECPolicy |\r\n|   | hadoop.hdfs.server.datanode.TestDataNodeVolumeFailureReporting |\r\n\\\\\r\n\\\\\r\n|| Subsystem || Report/Notes ||\r\n| Docker | Client=17.05.0-ce Server=17.05.0-ce Image:yetus/hadoop:abb62dd |\r\n| JIRA Issue | HDFS-12749 |\r\n| JIRA Patch URL | https://issues.apache.org/jira/secure/attachment/12925261/HDFS-12749-trunk.005.patch |\r\n| Optional Tests |  asflicense  compile  javac  javadoc  mvninstall  mvnsite  unit  shadedclient  findbugs  checkstyle  |\r\n| uname | Linux fb7ad56ec141 3.13.0-143-generic #192-Ubuntu SMP Tue Feb 27 10:45:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux |\r\n| Build tool | maven |\r\n| Personality | /testptch/patchprocess/precommit/personality/provided.sh |\r\n| git revision | trunk / 0cf6e87 |\r\n| maven | version: Apache Maven 3.3.9 |\r\n| Default Java | 1.8.0_162 |\r\n| findbugs | v3.1.0-RC1 |\r\n| checkstyle | https://builds.apache.org/job/PreCommit-HDFS-Build/24308/artifact/out/diff-checkstyle-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n| unit | https://builds.apache.org/job/PreCommit-HDFS-Build/24308/artifact/out/patch-unit-hadoop-hdfs-project_hadoop-hdfs.txt |\r\n|  Test Results | https://builds.apache.org/job/PreCommit-HDFS-Build/24308/testReport/ |\r\n| Max. process+thread count | 3117 (vs. ulimit of 10000) |\r\n| modules | C: hadoop-hdfs-project/hadoop-hdfs U: hadoop-hdfs-project/hadoop-hdfs |\r\n| Console output | https://builds.apache.org/job/PreCommit-HDFS-Build/24308/console |\r\n| Powered by | Apache Yetus 0.8.0-SNAPSHOT   http://yetus.apache.org |\r\n\r\n\r\nThis message was automatically generated.\r\n\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=genericqa","name":"genericqa","key":"genericqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=genericqa&avatarId=33630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=genericqa&avatarId=33630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=genericqa&avatarId=33630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=genericqa&avatarId=33630"},"displayName":"genericqa","active":true,"timeZone":"Etc/UTC"},"created":"2018-05-26T22:56:06.724+0000","updated":"2018-05-26T22:56:06.724+0000"}],"maxResults":37,"total":37,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-12749/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3lwdb:"}}