{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13070861","self":"https://issues.apache.org/jira/rest/api/2/issue/13070861","key":"HDFS-11797","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2017-06-06T20:31:50.547+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Oct 13 17:18:41 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_13369655509_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-10-12T10:13:08.967+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-11797/watchers","watchCount":14,"isWatching":false},"created":"2017-05-10T16:25:33.530+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[{"id":"12517254","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12517254","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"13045520","key":"HDFS-11445","self":"https://issues.apache.org/jira/rest/api/2/issue/13045520","fields":{"summary":"FSCK shows overall health status as corrupt even one replica is corrupt","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-10-13T17:18:41.315+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"The calculation for {{numMachines}} can be too less (causing ArrayIndexOutOfBoundsException) or too many (causing NPE (HDFS-9958)) if data structures find inconsistent number of corrupt replicas. This was earlier found related to failed storages. This JIRA tracks a change that works for all possible cases of inconsistencies.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12871690","id":"12871690","filename":"HDFS-11797.001.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-06T21:20:51.694+0000","size":950,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12871690/HDFS-11797.001.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"BlockManager#createLocatedBlocks() can throw ArrayIndexOutofBoundsException when corrupt replicas are inconsistent","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16039577","id":"16039577","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"body":"We are also seeing a similar issue once in a while\n\n{code}\n org.apache.hadoop.hdfs.server.blockmanagement.BlockManager: Inconsistent number of corrupt replicas for blk_123456789_123456 blockMap has 0 but corrupt replicas map has 1\n org.apache.hadoop.ipc.Server: IPC Server handler 34 on 8020, call org.apache.hadoop.hdfs.protocol.ClientProtocol.getListing from xxx.xxx.xxx.xxx:xxxxx Call#91 Retry#0 java.lang.ArrayIndexOutOfBoundsException\n{code}\n\nThe issue shows up in 'getListing' operation from the client\n{code}\norg.apache.hadoop.ipc.RemoteException(java.lang.ArrayIndexOutOfBoundsException): java.lang.ArrayIndexOutOfBoundsException\n\n\tat org.apache.hadoop.ipc.Client.call(Client.java:1426)\n\tat org.apache.hadoop.ipc.Client.call(Client.java:1363)\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:229)\n\tat com.sun.proxy.$Proxy14.getListing(Unknown Source)\n\tat org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.getListing(ClientNamenodeProtocolTranslatorPB.java:587)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:497)\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:256)\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:104)\n\tat com.sun.proxy.$Proxy15.getListing(Unknown Source)\n\tat org.apache.hadoop.hdfs.DFSClient.listPaths(DFSClient.java:1801)\n\tat org.apache.hadoop.hdfs.DistributedFileSystem$DirListingIterator.hasNextNoFilter(DistributedFileSystem.java:1047)\n\tat org.apache.hadoop.hdfs.DistributedFileSystem$DirListingIterator.hasNext(DistributedFileSystem.java:1022)\n\tat org.apache.hadoop.mapreduce.lib.input.FileInputFormat.singleThreadedListStatus(FileInputFormat.java:304)\n\tat org.apache.hadoop.mapreduce.lib.input.FileInputFormat.listStatus(FileInputFormat.java:265)\n\tat org.apache.hadoop.mapreduce.lib.input.SequenceFileInputFormat.listStatus(SequenceFileInputFormat.java:59)\n\tat org.apache.hadoop.mapreduce.lib.input.FileInputFormat.getSplits(FileInputFormat.java:387)\n\tat org.apache.hadoop.mapreduce.JobSubmitter.writeNewSplits(JobSubmitter.java:301)\n\tat org.apache.hadoop.mapreduce.JobSubmitter.writeSplits(JobSubmitter.java:318)\n\tat org.apache.hadoop.mapreduce.JobSubmitter.submitJobInternal(JobSubmitter.java:196)\n\tat org.apache.hadoop.mapreduce.Job$10.run(Job.java:1290)\n\tat org.apache.hadoop.mapreduce.Job$10.run(Job.java:1287)\n        ...\n{code}\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-06T20:31:50.547+0000","updated":"2017-06-06T20:31:50.547+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16039585","id":"16039585","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"body":"Thank you [~jnp], the inconsistent data structures are a rare occurrence and have shown this behavior (whether in the form of NullPointerException or ArrayIndexOutofBoundsException) since at least 2.6. A little torn on whether this should be marked as critical or not. Thoughts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-06T20:36:09.620+0000","updated":"2017-06-06T20:36:09.620+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16039608","id":"16039608","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"We see this error occurring a few times in recent months. Do you have a patch? It's hard to reproduce and I have not yet figured out how exactly it happened. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-06T20:51:47.233+0000","updated":"2017-06-06T20:51:47.233+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16039613","id":"16039613","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"body":"This does cause client operations to fail, and causes some applications to fail as well. Once a file gets in this state, recovery path back to a consistent state is not clear.\nDo you have a test case or steps to reproduce this? Unfortunately, we don't have a corresponding exception trace at the Namenode.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jnp","name":"jnp","key":"jnp","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jitendra Nath Pandey","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-06T20:53:05.866+0000","updated":"2017-06-06T20:53:05.866+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16039629","id":"16039629","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"It causes fsck to fail as well, until the corrupt file is removed. The AIOOBE error was logged without stacktrace in NameNode for all occurrence for us though.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-06T21:00:07.755+0000","updated":"2017-06-06T21:00:07.755+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16039647","id":"16039647","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"bq. The AIOOBE error was logged without stacktrace in NameNode for all occurrence for us though.\nYou can get the stack trace, if you find the first occurrence of it. Apparently, jvm somehow omits the trace after first time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2017-06-06T21:13:46.730+0000","updated":"2017-06-06T21:13:46.730+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16039664","id":"16039664","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"body":"For HDFS-9958 case we did manage to find a stack trace after some searching which pointed to corrupt replica being on a failed volume. After that fix, the latest case is different since no failed volumes are involved and unlike last time I could not find a stack trace to support this exception. Clearly there are other scenarios where this inconsistency can happen. However, triggering a full block report from the nodes having the replica got rid of this bad state. [~jojochuang], since the cause of this is not known and the the one caused by volume failures has been addressed, my approach for this JIRA was to allocate the array to numNodes size and let the {{j < numMachines}} logic take care of truncating the array if needed in any rare case. \n\nThe patch does not have a test yet. Appreciate any thoughts on this approach to the fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-06T21:20:51.700+0000","updated":"2017-06-06T21:20:51.700+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16042052","id":"16042052","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"body":"I have not checked the details, but is it related to HDFS-11445 (more specifically, this [comment|https://issues.apache.org/jira/browse/HDFS-11445?focusedCommentId=15898236&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-15898236]) ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jingzhao","name":"jingzhao","key":"jingzhao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jing Zhao","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-08T01:27:41.148+0000","updated":"2017-06-08T01:29:13.328+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16042731","id":"16042731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"body":"The symptoms match exactly. Thanks [~jingzhao].  Will wait for [~jnp], [~jojochuang]'s comments before closing this as a duplicate.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kshukla","name":"kshukla","key":"kshukla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34050","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34050","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34050","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34050"},"displayName":"Kuhu Shukla","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-08T14:00:03.923+0000","updated":"2017-06-08T14:00:03.923+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16042960","id":"16042960","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"body":"A few months ago I knew at least one way the datastructures would lose sync, but I stack overflowed and can't remember exactly what it was other than maybe UC-related...\n\nI have a slightly refined patch that more gracefully handles the out-of-sync conditions, and optimizes the common case (no corruption) to not redundantly analyze the locations.  Will try to post this week.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daryn","name":"daryn","key":"daryn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daryn Sharp","active":true,"timeZone":"America/Chicago"},"created":"2017-06-08T16:25:24.548+0000","updated":"2017-06-08T16:25:24.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16043089","id":"16043089","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks Kuhu and Jing.\n\nQuickly reviewed the patch, it does look like it fixed the same issue. If I understand the fix correctly, there are certain cases where block manager fails to remove stale replicas when block replica information is updated, causing inconsistency of corrupt replica count between block manager and other data structures. However, I am not sure if there are other (unfixed) cases where this happens as well.\n\n[~brahmareddy] would you mind to take a look?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-08T17:33:24.562+0000","updated":"2017-06-08T17:33:24.562+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16047116","id":"16047116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks you all for looking into this issue. \n\nHi [~kshukla], thanks for reporting and working the issue, I assume the release you are running doesn't have HDFS-11445 fix.\n\nMy understanding of HDFS-11445 is, when we tried to remove a corrupt replica, we only removed it from blockMap, and we \"forgot\" to remove it from the corruptReplicaMap, thus caused the inconsistency.\n\nHi [~daryn], if my understanding is correct here, the fix you mentioned at \n\nhttps://issues.apache.org/jira/browse/HDFS-11797?focusedCommentId=16042960&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#comment-16042960\n\ncould be a follow-up jira. Do you agree?\n\nThanks.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yzhangal","name":"yzhangal","key":"yzhangal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yongjun Zhang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-12T21:48:30.352+0000","updated":"2017-06-12T21:48:30.352+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16047968","id":"16047968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brahmareddy","name":"brahmareddy","key":"brahmareddy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=brahmareddy&avatarId=24624","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brahmareddy&avatarId=24624","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brahmareddy&avatarId=24624","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brahmareddy&avatarId=24624"},"displayName":"Brahma Reddy Battula","active":true,"timeZone":"Asia/Kolkata"},"body":"Yes,it's almost hitting HDFS-11445 and  now {{BlockInfoContiguousUnderConstruction#setGenerationStampAndVerifyReplicas()}} and {{BlockInfoContiguousUnderConstruction#commitBlock()}} return the list of stale replicas and then removing these stored blockInfo in BlockManager..","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=brahmareddy","name":"brahmareddy","key":"brahmareddy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=brahmareddy&avatarId=24624","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=brahmareddy&avatarId=24624","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=brahmareddy&avatarId=24624","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=brahmareddy&avatarId=24624"},"displayName":"Brahma Reddy Battula","active":true,"timeZone":"Asia/Kolkata"},"created":"2017-06-13T14:31:58.192+0000","updated":"2017-06-13T14:31:58.192+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16048370","id":"16048370","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"Reviewed again. I believe this is resolved via HDFS-11445.\nAlso verified that for every place where a block is removed from BlocksMap, it is also removed from CorruptReplicasMaps. So I think we can close as a dup of HDFS-11445.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-06-13T20:35:44.581+0000","updated":"2017-06-13T20:35:44.581+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16201754","id":"16201754","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm going to close it as a dup of HDFS-11445. Feel free to reopen if this is not the case. Thanks [~kshukla]!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-12T10:13:09.029+0000","updated":"2017-10-12T10:13:09.029+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13070861/comment/16203894","id":"16203894","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"body":"For future reference, I can confirm an occurrence of this bug happened to a customer of us, and I was able to find the sequence of incidences leading to this bug, which is exactly what HDFS-11445 fixes.\r\n\r\n# A datanode was shutdown, making the replica stale.\r\n# NameNode detected the staleness, adding it to corruptReplicaMap. Because the replica was on a DataNode that was out of date, the replica was not invalidated. So the corruptReplicaMap had the replica, and blockMap had the replica as well.\r\n# The block was updated, causing the stale replica removed from blockMap. *but it was not removed from corruptReplicaMap*\r\n# a client calling getBlockLocations caused AIOOE because of the mismatch.\r\n{noformat}\r\n2017-10-10 14:48:10,664 WARN org.apache.hadoop.hdfs.server.blockmanagement.BlockManager: Inconsistent number of corrupt replicas for blk_1041920008_1133174794 blockMap has 0 but corrupt replicas map has 1\r\n2017-10-10 14:48:10,665 WARN org.apache.hadoop.ipc.Server: IPC Server handler 5 on 8020, call org.apache.hadoop.hdfs.protocol.ClientProtocol.getBlockLocations from 10.103.4.11:56487 Call#5239908 Retry#0\r\njava.lang.ArrayIndexOutOfBoundsException: 2\r\n        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.createLocatedBlock(BlockManager.java:982)\r\n        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.createLocatedBlock(BlockManager.java:929)\r\n        at org.apache.hadoop.hdfs.server.blockmanagement.BlockManager.createLocatedBlocks(BlockManager.java:1031)\r\n        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getBlockLocationsInt(FSNamesystem.java:2059)\r\n        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getBlockLocations(FSNamesystem.java:2008)\r\n        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.getBlockLocations(FSNamesystem.java:1921)\r\n        at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.getBlockLocations(NameNodeRpcServer.java:572)\r\n        at org.apache.hadoop.hdfs.server.namenode.AuthorizationProviderProxyClientProtocol.getBlockLocations(AuthorizationProviderProxyClientProtocol.java:89)\r\n        at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.getBlockLocations(ClientNamenodeProtocolServerSideTranslatorPB.java:365)\r\n        at org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamenodeProtocolProtos.java)\r\n        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:617)\r\n        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:1073)\r\n        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2217)\r\n        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2213)\r\n        at java.security.AccessController.doPrivileged(Native Method)\r\n        at javax.security.auth.Subject.doAs(Subject.java:422)\r\n        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1917)\r\n        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2211)\r\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jojochuang","name":"jojochuang","key":"jojochuang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jojochuang&avatarId=25508","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jojochuang&avatarId=25508","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jojochuang&avatarId=25508","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jojochuang&avatarId=25508"},"displayName":"Wei-Chiu Chuang","active":true,"timeZone":"America/Los_Angeles"},"created":"2017-10-13T17:18:41.315+0000","updated":"2017-10-13T17:18:41.315+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-11797/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3es7b:"}}