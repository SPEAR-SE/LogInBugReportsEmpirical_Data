{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12843996","self":"https://issues.apache.org/jira/rest/api/2/issue/12843996","key":"HDFS-8748","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2015-07-20T23:15:48.644+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 24 21:27:23 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1291756788_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-07-24T21:27:23.835+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-8748/watchers","watchCount":5,"isWatching":false},"created":"2015-07-09T22:38:07.117+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["acl","permission"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12331979","id":"12331979","description":"2.7.1 release","name":"2.7.1","archived":false,"released":true,"releaseDate":"2015-07-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-11-24T20:03:01.769+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313400","id":"12313400","name":"security"}],"timeoriginalestimate":null,"description":"In the ACL permission checking routine, the implemented named group section does not match the design document.\n\nIn the design document, its shown in the pseudo-code that if the requester is not the owner or a named user, then the applicable groups are unioned together to form effective permissions for the requester.\n\n\nInstead, the current implementation will search for the first group that grants access and will use that. It will not union the permissions together.\n\nHere is the design document's description of the desired behavior\n{quote}\nIf the user is a member of the file's group or at least one group for which there is a\nnamed group entry in the ACL, then effective permissions are calculated from groups.\nThis is the union of the file group permissions (if the user is a member of the file group)\nand all named group entries matching the user's groups. For example, consider a user\nthat is a member of 2 groups: sales and execs. The user is not the file owner, and the\nACL contains no named user entries. The ACL contains named group entries for both\ngroups as follows: group:sales:r­­\\-\\-, group:execs:\\-­w\\-­. In this case, the user's effective\npermissions are rw­-.\n{quote}\n\n ??https://issues.apache.org/jira/secure/attachment/12627729/HDFS-ACLs-Design-3.pdf page 10??\n\nThe design document's algorithm matches that description:\n\n*Design Document Algorithm*\n{code:title=DesignDocument}\nif (user == fileOwner) {\n    effectivePermissions = aclEntries.getOwnerPermissions()\n} else if (user ∈ aclEntries.getNamedUsers()) {\n    effectivePermissions = aclEntries.getNamedUserPermissions(user)\n} else if (userGroupsInAcl != ∅) {\n    effectivePermissions = ∅\n    if (fileGroup ∈ userGroupsInAcl) {\n        effectivePermissions = effectivePermissions ∪\n        aclEntries.getGroupPermissions()\n    }\n    for ({group | group ∈ userGroupsInAcl}) {\n        effectivePermissions = effectivePermissions ∪\n        aclEntries.getNamedGroupPermissions(group)\n    }\n} else {\n    effectivePermissions = aclEntries.getOthersPermissions()\n}\n{code}\n??https://issues.apache.org/jira/secure/attachment/12627729/HDFS-ACLs-Design-3.pdf page 9??\n\nThe current implementation does NOT match the description.\n*Current Trunk*\n{code:title=FSPermissionChecker.java}\n    // Use owner entry from permission bits if user is owner.\n    if (getUser().equals(inode.getUserName())) {\n      if (mode.getUserAction().implies(access)) {\n        return;\n      }\n      foundMatch = true;\n    }\n\n    // Check named user and group entries if user was not denied by owner entry.\n    if (!foundMatch) {\n      for (int pos = 0, entry; pos < aclFeature.getEntriesSize(); pos++) {\n        entry = aclFeature.getEntryAt(pos);\n        if (AclEntryStatusFormat.getScope(entry) == AclEntryScope.DEFAULT) {\n          break;\n        }\n        AclEntryType type = AclEntryStatusFormat.getType(entry);\n        String name = AclEntryStatusFormat.getName(entry);\n        if (type == AclEntryType.USER) {\n          // Use named user entry with mask from permission bits applied if user\n          // matches name.\n          if (getUser().equals(name)) {\n            FsAction masked = AclEntryStatusFormat.getPermission(entry).and(\n                mode.getGroupAction());\n            if (masked.implies(access)) {\n              return;\n            }\n            foundMatch = true;\n            break;\n          }\n        } else if (type == AclEntryType.GROUP) {\n          // Use group entry (unnamed or named) with mask from permission bits\n          // applied if user is a member and entry grants access.  If user is a\n          // member of multiple groups that have entries that grant access, then\n          // it doesn't matter which is chosen, so exit early after first match.\n          String group = name == null ? inode.getGroupName() : name;\n          if (getGroups().contains(group)) {\n            FsAction masked = AclEntryStatusFormat.getPermission(entry).and(\n                mode.getGroupAction());\n            if (masked.implies(access)) {\n              return;\n            }\n            foundMatch = true;\n          }\n        }\n      }\n    }\n{code}\n\nAs seen in the GROUP section, the permissions check will succeed if and only if a single group (either owning group or named group) has all of the requested permissions. The permissions check should instead succeed if the requested permissions can be obtained by unioning all of the groups permissions.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329057","id":"12329057","description":"2.8.0 release","name":"2.8.0","archived":false,"released":true,"releaseDate":"2017-03-22"}],"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746214","id":"12746214","filename":"HDFS_8748.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_o","name":"scott_o","key":"scott_o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Opell","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T23:41:29.559+0000","size":4839,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12746214/HDFS_8748.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ACL permission check does not union groups to determine effective permissions","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_o","name":"scott_o","key":"scott_o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Opell","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_o","name":"scott_o","key":"scott_o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Opell","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10430","value":"Patch","id":"10430"}],"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12843996/comment/14634241","id":"14634241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cnauroth","name":"cnauroth","key":"cnauroth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"},"displayName":"Chris Nauroth","active":true,"timeZone":"America/Los_Angeles"},"body":"Hello [~scott_o].  Thank you for reporting this.  I can confirm that this is a bug.  (The design doc is correct, and the current code has a bug.)\n\nTo confirm this, I ran a test case on an ext4 file system with ACLs enabled.  See below for a transcript of my test case.  Executing a file requires both read and execute permissions (r-x).  In my test case, I defined the read permission on one named group entry and the execute permission on a second named group entry.  My user was able to execute the file.  This proves that on ext4, permissions can be defined on separate named group ACL entries, and the permission checks will treat the union of those entries as the effective permissions.\n\nScott, are you interested in coding a patch?  If not, then I'll assign this to myself for the fix.\n\n{code}\n> whoami\ncnauroth\n\n> groups\ncnauroth sudo testgroup1\n\n> getfacl test_HDFS-8748 \n# file: test_HDFS-8748\n# owner: root\n# group: root\nuser::rwx\ngroup::---\ngroup:sudo:r--\ngroup:testgroup1:--x\nmask::r-x\nother::---\n\n> ./test_HDFS-8748 \n\n> echo $?\n0\n\n> sudo setfacl -m group:sudo:r--,group:testgroup1:--- test_HDFS-8748 \n\n> ./test_HDFS-8748 \n-bash: ./test_HDFS-8748: Permission denied\n\n> echo $?\n126\n\n> sudo setfacl -m group:sudo:---,group:testgroup1:--x test_HDFS-8748 \n\n> ./test_HDFS-8748 \nbash: ./test_HDFS-8748: Permission denied\n\n> echo $?\n126\n\n> sudo setfacl -m group:sudo:r--,group:testgroup1:--x test_HDFS-8748 \n\n> ./test_HDFS-8748 \n\n> echo $?\n0\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cnauroth","name":"cnauroth","key":"cnauroth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"},"displayName":"Chris Nauroth","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T23:15:48.644+0000","updated":"2015-07-20T23:15:48.644+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12843996/comment/14634276","id":"14634276","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_o","name":"scott_o","key":"scott_o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Opell","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Chris.\n\nI actually was just able to get my hadoop environment setup and got a patch together.\nHowever, in my explorations, I found that while the behavior outlined in the design document is mentioned in the POSIX spec, its not actually what they decided to go with. Check out page 272 of the pdf here for more details.\nhttp://users.suse.com/~agruen/acl/posix/Posix_1003.1e-990310.pdf\n\nSo basically, the code matches POSIX and the design document doesn't. \nI submitted my patch, which should work if the project decides to go with the non-posix behavior.\n\nI guess your OS doesn't fully comply with the 1003.1e draft.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scott_o","name":"scott_o","key":"scott_o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Opell","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T23:38:17.863+0000","updated":"2015-07-20T23:38:17.863+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12843996/comment/14634288","id":"14634288","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cnauroth","name":"cnauroth","key":"cnauroth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"},"displayName":"Chris Nauroth","active":true,"timeZone":"America/Los_Angeles"},"body":"Thank you for the pointer to 1003.1e.  That's a very interesting find.  The high-level goal always has been POSIX adherence, which makes me inclined to leave the current code as is.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cnauroth","name":"cnauroth","key":"cnauroth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"},"displayName":"Chris Nauroth","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T23:45:49.488+0000","updated":"2015-07-20T23:45:49.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12843996/comment/14641095","id":"14641095","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cnauroth","name":"cnauroth","key":"cnauroth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"},"displayName":"Chris Nauroth","active":true,"timeZone":"America/Los_Angeles"},"body":"As I stated in my last comment, the high level design goal of HDFS ACLs was to match POSIX semantics as closely as possible.  I'm going to resolve this as won't fix, because the current implemented behavior matches the latest quote from the POSIX spec, even though it doesn't match the HDFS-4685 design doc.\n\n[~scott_o], I really appreciate your diligence tracking down the relevant spec.  Thank you!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cnauroth","name":"cnauroth","key":"cnauroth","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cnauroth&avatarId=11432","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cnauroth&avatarId=11432","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cnauroth&avatarId=11432","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cnauroth&avatarId=11432"},"displayName":"Chris Nauroth","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-24T21:27:23.875+0000","updated":"2015-07-24T21:27:23.875+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-8748/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2h2ov:"}}