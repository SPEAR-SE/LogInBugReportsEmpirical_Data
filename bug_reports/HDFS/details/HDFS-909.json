{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12446120","self":"https://issues.apache.org/jira/rest/api/2/issue/12446120","key":"HDFS-909","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314814","id":"12314814","description":"","name":"0.20.3","archived":true,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314046","id":"12314046","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-01-20T18:58:31.741+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Apr 21 03:09:09 UTC 2010","customfield_12310420":"16766","customfield_12312320":null,"customfield_12310222":"10002_*:*_5_*:*_1654648686_*|*_1_*:*_5_*:*_6154028589_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-04-21T03:09:10.066+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-909/watchers","watchCount":14,"isWatching":false},"created":"2010-01-20T18:04:32.791+0000","customfield_12310192":null,"customfield_12310191":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10343","value":"Reviewed","id":"10343"}],"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"14.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12314048","id":"12314048","description":"","name":"0.20.1","archived":false,"released":true,"releaseDate":"2009-09-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314204","id":"12314204","description":"","name":"0.20.2","archived":false,"released":true,"releaseDate":"2010-02-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314046","id":"12314046","description":"","name":"0.21.0","archived":false,"released":true,"releaseDate":"2010-08-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12314241","id":"12314241","description":"","name":"0.22.0","archived":false,"released":true,"releaseDate":"2011-12-10"}],"issuelinks":[{"id":"12330285","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330285","type":{"id":"10032","name":"Blocker","inward":"is blocked by","outward":"blocks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10032"},"inwardIssue":{"id":"12455862","key":"HADOOP-6554","self":"https://issues.apache.org/jira/rest/api/2/issue/12455862","fields":{"summary":"DelegationTokenSecretManager lifecycle is inconsistent","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12330155","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330155","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12455702","key":"HDFS-955","self":"https://issues.apache.org/jira/rest/api/2/issue/12455702","fields":{"summary":"FSImage.saveFSImage can lose edits","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12330287","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330287","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12455705","key":"HDFS-956","self":"https://issues.apache.org/jira/rest/api/2/issue/12455705","fields":{"summary":"Improper synchronization in some FSNamesystem methods","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12330340","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330340","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12456712","key":"HDFS-988","self":"https://issues.apache.org/jira/rest/api/2/issue/12456712","fields":{"summary":"saveNamespace race can corrupt the edits log","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12330286","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12330286","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12456380","key":"HDFS-980","self":"https://issues.apache.org/jira/rest/api/2/issue/12456380","fields":{"summary":"Convert FSNamesystem lock to ReadWriteLock","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-08-24T20:51:06.740+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312926","id":"12312926","name":"namenode"}],"timeoriginalestimate":null,"description":"closing the edits log file can race with write to edits log file operation resulting in OP_INVALID end-of-file marker being initially overwritten by the concurrent (in setReadyToFlush) threads and then removed twice from the buffer, losing a good byte from edits log.\n\nExample:\n{code}\nFSNameSystem.rollEditLog() -> FSEditLog.divertFileStreams() -> FSEditLog.closeStream() -> EditLogOutputStream.setReadyToFlush()\nFSNameSystem.rollEditLog() -> FSEditLog.divertFileStreams() -> FSEditLog.closeStream() -> EditLogOutputStream.flush() -> EditLogFileOutputStream.flushAndSync()\nOR\nFSNameSystem.rollFSImage() -> FSIMage.rollFSImage() -> FSEditLog.purgeEditLog() -> FSEditLog.revertFileStreams() -> FSEditLog.closeStream() ->EditLogOutputStream.setReadyToFlush() \nFSNameSystem.rollFSImage() -> FSIMage.rollFSImage() -> FSEditLog.purgeEditLog() -> FSEditLog.revertFileStreams() -> FSEditLog.closeStream() ->EditLogOutputStream.flush() -> EditLogFileOutputStream.flushAndSync()\n\nVERSUS\n\nFSNameSystem.completeFile -> FSEditLog.logSync() -> EditLogOutputStream.setReadyToFlush()\nFSNameSystem.completeFile -> FSEditLog.logSync() -> EditLogOutputStream.flush() -> EditLogFileOutputStream.flushAndSync()\nOR \nAny FSEditLog.write\n{code}\n\nAccess on the edits flush operations is synchronized only in the FSEdits.logSync() method level. However at a lower level access to EditsLogOutputStream setReadyToFlush(), flush() or flushAndSync() is NOT synchronized. These can be called from concurrent threads like in the example above\n\nSo if a rollEditLog or rollFSIMage is happening at the same time with a write operation it can race for EditLogFileOutputStream.setReadyToFlush that will overwrite the the last byte (normally the FSEditsLog.OP_INVALID which is the \"end-of-file marker\") and then remove it twice (from each thread) in flushAndSync()! Hence there will be a valid byte missing from the edits log that leads to a SecondaryNameNode silent failure and a full HDFS failure upon cluster restart. \n\nWe got to this point after investigating a corrupted edits file that made HDFS unable to start with \n\n{code:title=namenode.log}\njava.io.IOException: Incorrect data format. logVersion is -20 but writables.length is 768. \n        at org.apache.hadoop.hdfs.server.namenode.FSEditLog.loadEditRecords(FSEditLog.java:450\n{code}\n\nEDIT: moved the logs to a comment to make this readable\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12441669","id":"12441669","filename":"ASF.LICENSE.NOT.GRANTED--hdfs-909.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-13T23:59:25.221+0000","size":25574,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12441669/ASF.LICENSE.NOT.GRANTED--hdfs-909.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12442028","id":"12442028","filename":"ASF.LICENSE.NOT.GRANTED--hdfs-909-branch-0.20.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-17T01:31:38.990+0000","size":25293,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12442028/ASF.LICENSE.NOT.GRANTED--hdfs-909-branch-0.20.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12440954","id":"12440954","filename":"hdfs-909.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-06T21:49:36.259+0000","size":25402,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12440954/hdfs-909.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12435924","id":"12435924","filename":"hdfs-909.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-16T02:01:50.562+0000","size":25203,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12435924/hdfs-909.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12434606","id":"12434606","filename":"hdfs-909.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-02T22:33:18.678+0000","size":12269,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12434606/hdfs-909.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12434498","id":"12434498","filename":"hdfs-909.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-02T04:00:21.035+0000","size":12269,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12434498/hdfs-909.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12431737","id":"12431737","filename":"hdfs-909.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-29T01:54:03.757+0000","size":11111,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12431737/hdfs-909.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12442350","id":"12442350","filename":"hdfs-909-ammendation.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-20T21:28:53.529+0000","size":7245,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12442350/hdfs-909-ammendation.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12442371","id":"12442371","filename":"hdfs-909-branch-0.20.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-21T00:12:27.263+0000","size":25215,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12442371/hdfs-909-branch-0.20.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12442357","id":"12442357","filename":"hdfs-909-branch-0.20.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-20T21:54:50.522+0000","size":25972,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12442357/hdfs-909-branch-0.20.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12442385","id":"12442385","filename":"hdfs-909-branch-0.21.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-21T03:06:20.442+0000","size":25703,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12442385/hdfs-909-branch-0.21.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12442243","id":"12442243","filename":"hdfs-909-branch-0.21.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-19T23:24:06.532+0000","size":24610,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12442243/hdfs-909-branch-0.21.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12442370","id":"12442370","filename":"hdfs-909-unified.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-21T00:12:27.159+0000","size":26999,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12442370/hdfs-909-unified.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12431731","id":"12431731","filename":"hdfs-909-unittest.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-29T01:00:17.051+0000","size":6504,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12431731/hdfs-909-unittest.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"14245","customfield_12312823":null,"summary":"Race condition between rollEditLog or rollFSImage ant FSEditsLog.write operations  corrupts edits log","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CentOS","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12802932","id":"12802932","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hi Cosmin,\n\nDoes this exist in branch-20 as well? or is it a regression in 20 when the edit log code was changed to support backupnode etc?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-20T18:58:31.741+0000","updated":"2010-01-20T18:58:31.741+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12802941","id":"12802941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Todd, \n\nI haven't check yet, so it's possible to be on 0.20 as well. I forgot to add that the issue particularly nasty because it will first fail silently. In our case, the log was corrupted on 17th of December but we only discovered it yesterday when we restarted HDFS. It can be detected early by monitoring the secondary-namenode.out log file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-01-20T19:10:29.894+0000","updated":"2010-01-20T19:10:29.894+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12803323","id":"12803323","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"body":"I looked briefly over 0.20 branch and it seems it's susceptible to the race condition (not exactly the same as here). To simplify things a bit from the initial description: \n\nin 0.21 FSEditLog methods logSync() and closeStream()  call the setReadyToFlush() freely\nin 0.20 FSEditLog.setReadyToFlush() is called by logSync() and close(). Apparently close() is synchronized and also checking if isSyncRunning is set. However it doesn't stop it to race for setReadyToFlush() against logSync(), but rather just attempting to wait a second if a sync is already in progress.\n\nI can see how these could be avoided with a shared lock in both 0.20 and 0.21+, however it might be better to get the code reviewed by someone that knows the adjacent parts as well too as it currently seems really fragile and prone to deadlock creation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-01-21T15:19:47.350+0000","updated":"2010-01-21T15:19:47.350+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12806124","id":"12806124","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I don't think I see this in 0.20. logSync is not itself a synchronized method, but there is a synchronized (this) block around the invocations of setReadyToFlush.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-28T21:56:41.663+0000","updated":"2010-01-28T21:56:41.663+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12806179","id":"12806179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here's a bit of an ugly unit test that I think shows this issue on trunk. I haven't reproduced exactly Cosmin's behavior, but I do manage to get it to throw an exception pretty quickly. The test starts up a bunch of threads which log actions, then alternates (a) roll edit log, (b) verify edits, (c) purge edits.\n\nOn my system it fails quickly with:\n\n{noformat}\n    [junit] java.io.IOException: Bad file descriptor\n    [junit]     at sun.nio.ch.FileChannelImpl.position0(Native Method)\n    [junit]     at sun.nio.ch.FileChannelImpl.position(FileChannelImpl.java:263)\n    [junit]     at org.apache.hadoop.hdfs.server.namenode.EditLogFileOutputStream.flushAndSync(EditLogFileOutputStream.java:145)\n    [junit]     at org.apache.hadoop.hdfs.server.namenode.EditLogOutputStream.flush(EditLogOutputStream.java:83)\n    [junit]     at org.apache.hadoop.hdfs.server.namenode.FSEditLog.logSync(FSEditLog.java:867)\n    [junit]     at org.apache.hadoop.hdfs.server.namenode.TestEditLogRace$Transactions.run(TestEditLogRace.java:76)\n    [junit]     at java.lang.Thread.run(Thread.java:619)\n{noformat}\n\nThis isn't the same behavior Cosmin reported, so I may actually have an error in my test logic (eg not synchronizing on something that a real FSNamesystem would)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-29T01:00:17.133+0000","updated":"2010-01-29T01:00:17.133+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12806189","id":"12806189","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here is a patch that fixes the issue.\n\nThe included unit test isn't optimal, though it does tend to fail on the unpatched code, and always passes on the patched code. Since this is a race condition, it's difficult to force.\n\nAfter this is reviewed, I will post a similar patch against 0.21. I'll also port back the unit test to 0.20 to make absolutely sure the issue doesn't occur there.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-29T01:54:03.859+0000","updated":"2010-01-29T01:54:03.859+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12806198","id":"12806198","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Backported the test to 0.20, it passes just fine since roll and purge both call close(), which waits for any running syncs to complete first.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-29T02:28:15.862+0000","updated":"2010-01-29T02:28:15.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12806240","id":"12806240","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12431737/hdfs-909.txt\n  against trunk revision 903906.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    +1 core tests.  The patch passed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/211/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/211/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/211/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/211/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-29T05:46:22.249+0000","updated":"2010-01-29T05:46:22.249+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12806245","id":"12806245","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Failing test is unrelated (been failing other patch builds, seems security related)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-01-29T06:09:08.575+0000","updated":"2010-01-29T06:09:08.575+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828394","id":"12828394","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Cosmin, thanks for reporting and investigating this. I want to clarify the problem.\nLooks like that {{rollFSImage()}} occurred exactly between two synchronized sections in {{FSEditLog.logSync()}}, when {{logSync()}} was flushing one of the streams.\n{{setReadyToFlush()}} is called by {{logSync()}} in the first synchronized section, so it cannot race with calls {{setReadyToFlush()}} originated in {{FSEditLog.divertFileStreams()}}, because the latter is also synchronized.\nSo the race condition in your case is between\n{code}\nFSNameSystem.rollFSImage() -> FSIMage.rollFSImage() -> FSEditLog.purgeEditLog() -> FSEditLog.revertFileStreams() -> FSEditLog.closeStream() ->EditLogOutputStream.setReadyToFlush() \nVERSUS\nFSNameSystem.completeFile -> FSEditLog.logSync() -> EditLogOutputStream.flush() -> EditLogFileOutputStream.flushAndSync()\n{code}\n\n{{setReadyToFlush()}} swaps the buffers {{bufCurrent}} and {{bufReady}}, and {{flushAndSync()}} writes {{bufReady}} into the edits file, and it could write inconsistent data if the buffer has been replaced while writing.\n\nTodd, it seems the exception you posted {{java.io.IOException: Bad file descriptor}} means that file has been closed before {{flush()}} could complete. Is it the same race or a different one.\nI haven't looked at the patch yet.\n\nAlso, usually the description of the issue should be short. Detailed explanations can be posted in the first comment after that. Is it possible to edit the description now and remove those unwrapped long lines?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-02T01:42:16.443+0000","updated":"2010-02-02T01:42:16.443+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828399","id":"12828399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Konstantin: I think it's pretty much the same race. The included unit test should shake out either one, and it passes now.\n\nThe patch is pretty simple - revertFileStreams and divertFileStreams simply need to wait for any thread that's in the unsynchronized middle part of logSync.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-02T01:58:32.162+0000","updated":"2010-02-02T01:58:32.162+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828426","id":"12828426","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd: I agree the patch fixes this particular race condition, when rollFSImage() is involved.\nI fear there is a similar race here, which it does not solve\n{code}\nFSNameSystem.saveNamespace() -> FSImage.saveFSImage( -> FSEditLog.createEditLogFile() -> EditLogFileOutputStream.create() -> EditLogFileOutputStream.setReadyToFlush() \nVERSUS\nFSNameSystem.completeFile -> FSEditLog.logSync() -> EditLogOutputStream.flush() -> EditLogFileOutputStream.flushAndSync()\n{code}\nYou can probably verify this with your test.\nI was thinking is there a universal way to avoid these type of errors.\nI mean somebody will write a new contravertFileStreams() method and will forget to waitForSyncToFinish(), then we will have to fix it again.\nMay be we should synchronize on the {{EditLogFileOutputStream}} level, then {{flushAndSync()}} and {{setReadyToFlush()}} will not intervene with each other?\nIn {{TestEditLogRace}} you call {{FSEditLog}} methods directly avoiding the {{FSNamesystem}} layer.\nWould it be better to involve the FSNamesystem lock into the picture?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-02T03:24:27.273+0000","updated":"2010-02-02T03:24:27.273+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828428","id":"12828428","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. May be we should synchronize on the EditLogFileOutputStream level, then flushAndSync() and setReadyToFlush() will not intervene with each other?\n\nIf we do that, isn't there a worry that each stream could flush at a slightly different point?\nIf we do HDFS-903 and add some kind of checksumming/verification to the edit logs (and we should)\nthen we rely on them rolling together. (Maybe I'm misunderstanding the locking you're suggesting?)\n\nbq. In TestEditLogRace you call FSEditLog methods directly avoiding the FSNamesystem layer. Would it be better to involve the FSNamesystem lock into the picture?\n\nI don't think the namesystem lock really matters, since all the write operations are separated into an internalFoo()\nwhich does the work while synchronized, followed by the logSync unsynchronized. I was trying to keep the test\nas close to a \"unit test\" as possible though I did have to use a minicluster anyway.\n\nbq. I fear there is a similar race here, which it does not solve...\n\nLet me add a unit test for this one as well and see what I come up with. I had forgotten about saveNamespace. Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-02T03:35:52.803+0000","updated":"2010-02-02T03:35:52.803+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828433","id":"12828433","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"This patch adds a unit test for saveNamespace concurrent with edit ops.\n\nThere is no race here because createEditLogFile is creating a new output stream, and thus won't race with any of the existing streams. The edit log isn't mutated until the image has been dumped and then the logs are rolled, so it's the same rollEditLogs fixed originally.\n\nAs for the danger of future changes missing the subtlety, I added a giant comment at the top of FSEditLog in the hopes that it will warn people. A different design with multiple locks (one protecting the buffers, one protecting sync and stream ops) might make it harder to make this mistake, but I think what we have isn't so bad as long as it's documented.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-02T04:00:21.152+0000","updated":"2010-02-02T04:00:21.152+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828498","id":"12828498","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12434498/hdfs-909.txt\n  against trunk revision 903906.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/110/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/110/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/110/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/110/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-02-02T06:33:44.144+0000","updated":"2010-02-02T06:33:44.144+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828499","id":"12828499","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Failing tests in test-patch are hudson BS per usual","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-02T06:37:42.091+0000","updated":"2010-02-02T06:37:42.091+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828530","id":"12828530","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"body":"\n\n{code:title=completeFile}\nFFFFFFEC0900000005003F2F68626173652F64656D6F5F5F75736572732F636F6D70616374696F6E2E646972\n2F3336343035313634362F38333238313438373139303730333137323739000133000D3132363130383236333\n1383335000D313236313038323632383039340008363731303838363400000003F6CBB87EF376E3E60000000\n0040000000000000000039665F9549DE069A5735E00000000040000000000000000039665ADCC71A050B16A\nBF00000000015A179A0000000000039665066861646F6F700A737570657267726F757001??\n{code}\nfollowed by a rename operation\n\n{code:Title=rename}\n0100000003003F2F68626173652F64656D6F5F5F75736572732F636F6D70616374696F6E2E6469722F3336343\n035313634362F3833323831343837313930373033313732373900352F68626173652F64656D6F5F5F757365727\n32F3336343035313634362F746573742F36393137333831323838333034343734333836000D313236313038323\n63331383639\n{code}\n\nThe first byte of the rename was instead read as part of the completeFile() operation. This resulted in reading the next operation as 0x00 (OP_ADD) followed by an int (length) which would have been 0x0000030 which is 768 that was read and failed in the following code\n\n{code:Title=FSEditLog.java}\n case OP_ADD:\n        case OP_CLOSE: {\n          // versions > 0 support per file replication\n          // get name and replication\n          int length = in.readInt();\n          if (-7 == logVersion && length != 3||\n              -17 < logVersion && logVersion < -7 && length != 4 ||\n              logVersion <= -17 && length != 5) {\n              throw new IOException(\"Incorrect data format.\"  +\n                                    \" logVersion is \" + logVersion +\n                                    \" but writables.length is \" +\n                                    length + \". \");\n{code}\n\nFilling the missing byte with a value resulted in correct interpretation of the 0x01 (OP_RENAME) and correct parsing for the rest of the edits file (>1MB)\n\nThis theory is also supported by the NameNode log file from the date the corruption took place:\n\n{code:title=namenode.log}\n2009-12-17 12:43:51,276 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem: Roll Edit Log from 10.72.17.162\n2009-12-17 12:43:51,338 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* NameSystem.addStoredBlock: blockMap updated: 10.72.17.165:50010 is added to blk_-480585673051114658_235109{blockUCState=UNDER_CONSTRUCTION, primaryNodeIndex=-1, replicas=[ReplicaUnderConstruction[10.72.17.166:50010|RBW], ReplicaUnderConstruction[10.72.17.165:50010|RBW], ReplicaUnderConstruction[10.72.17.167:50010|RBW]]} size 67108864\n2009-12-17 12:43:51,339 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* NameSystem.addStoredBlock: blockMap updated: 10.72.17.166:50010 is added to blk_-480585673051114658_235109{blockUCState=UNDER_CONSTRUCTION, primaryNodeIndex=-1, replicas=[ReplicaUnderConstruction[10.72.17.166:50010|RBW], ReplicaUnderConstruction[10.72.17.165:50010|RBW], ReplicaUnderConstruction[10.72.17.167:50010|RBW]]} size 67108864\n2009-12-17 12:43:51,342 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* NameSystem.allocateBlock: /hbase/demo__users/compaction.dir/364051646/8328148719070317279. blk_-5923234476536534337_235109{blockUCState=UNDER_CONSTRUCTION, primaryNodeIndex=-1, replicas=[ReplicaUnderConstruction[10.72.17.166:50010|RBW], ReplicaUnderConstruction[10.72.17.164:50010|RBW], ReplicaUnderConstruction[10.72.17.163:50010|RBW]]}\n2009-12-17 12:43:51,352 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* NameSystem.addStoredBlock: blockMap updated: 10.72.17.167:50010 is added to blk_-480585673051114658_235109{blockUCState=COMMITTED, primaryNodeIndex=-1, replicas=[ReplicaUnderConstruction[10.72.17.166:50010|RBW], ReplicaUnderConstruction[10.72.17.165:50010|RBW], ReplicaUnderConstruction[10.72.17.167:50010|RBW]]} size 67108864\n2009-12-17 12:43:51,833 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* NameSystem.addStoredBlock: blockMap updated: 10.72.17.163:50010 is added to blk_-5923234476536534337_235109{blockUCState=UNDER_CONSTRUCTION, primaryNodeIndex=-1, replicas=[ReplicaUnderConstruction[10.72.17.166:50010|RBW], ReplicaUnderConstruction[10.72.17.164:50010|RBW], ReplicaUnderConstruction[10.72.17.163:50010|RBW]]} size 22681498\n2009-12-17 12:43:51,834 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* NameSystem.addStoredBlock: blockMap updated: 10.72.17.164:50010 is added to blk_-5923234476536534337_235109{blockUCState=UNDER_CONSTRUCTION, primaryNodeIndex=-1, replicas=[ReplicaUnderConstruction[10.72.17.166:50010|RBW], ReplicaUnderConstruction[10.72.17.164:50010|RBW], ReplicaUnderConstruction[10.72.17.163:50010|RBW]]} size 22681498\n2009-12-17 12:43:51,834 INFO org.apache.hadoop.hdfs.StateChange: BLOCK* NameSystem.addStoredBlock: blockMap updated: 10.72.17.166:50010 is added to blk_-5923234476536534337_235109{blockUCState=UNDER_CONSTRUCTION, primaryNodeIndex=-1, replicas=[ReplicaUnderConstruction[10.72.17.166:50010|RBW], ReplicaUnderConstruction[10.72.17.164:50010|RBW], ReplicaUnderConstruction[10.72.17.163:50010|RBW]]} size 22681498\n\n\n\n\n\n2009-12-17 12:43:51,835 INFO org.apache.hadoop.hdfs.StateChange: DIR* NameSystem.completeFile: file /hbase/demo__users/compaction.dir/364051646/8328148719070317279 is closed by DFSClient_-1989779667\n2009-12-17 12:43:51,835 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem: Roll FSImage from 10.72.17.162\n2009-12-17 12:43:51,870 INFO org.apache.hadoop.hdfs.server.namenode.FSNamesystem.audit: ugi=hadoop,hadoop       ip=/10.72.17.166        cmd=rename      src=/hbase/demo__users/compaction.dir/364051646/8328148719070317279     dst=/hbase/demo__users/364051646/test/6917381288304474386       perm=hadoop:supergroup:rw-r--r--\n{code}\n\nThe last 3 entries show a completeFile operation followed by a rollFSIMage operation followed by a rename operation. This is where most probably the race condition took place.\nSynchronizing access to EditLogOutputStream could fix the problem, however other race or deadlocks may still occur. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-02T08:09:31.221+0000","updated":"2010-02-02T08:09:31.221+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828543","id":"12828543","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"body":"@Konstantin I moved the details to a comment and broke it on more lines but I missed the log entry that really messes up the layout. I can't edit the comment, unfortunately so if you can please break the log entry lines in my comment to have decent layout on this page. Sorry and thanks. \n\nPS I'll look at the code again to see the race issue you described. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-02T09:06:54.076+0000","updated":"2010-02-02T09:06:54.076+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828651","id":"12828651","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cos","name":"cos","key":"cos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cos&avatarId=16741","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cos&avatarId=16741","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cos&avatarId=16741","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cos&avatarId=16741"},"displayName":"Konstantin Boudnik","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. This patch adds a unit test for saveNamespace concurrent with edit ops. \nWould it be possible to make this test according to JUnit4 conventions?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cos","name":"cos","key":"cos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cos&avatarId=16741","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cos&avatarId=16741","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cos&avatarId=16741","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cos&avatarId=16741"},"displayName":"Konstantin Boudnik","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-02T15:54:34.106+0000","updated":"2010-02-02T15:54:34.106+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828800","id":"12828800","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"New patch in junit 4 style","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-02T22:33:18.715+0000","updated":"2010-02-02T22:33:18.715+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828853","id":"12828853","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd I checked the race with -saveNamespace and logSync is there.\n- I start the name-node in debugger. \n- I do -mkdir and stop the debugger in logSync() just before it does flush.\n- Then I enter safe mode with another client\n- I start saveNamepsace and stop the debugger in FSImage.saveFSImage() -> FSEditLog.createEditLogFile() -> EditLogFileOutputStream.create() -> after truncating the file but before writing LAYOUT_VERSION into it.\n- Then I let logSync() run.\n- Then I terminate the name-node.\n- After that the name-node wont start, since the edits file is broken.\n\nIn short the problem is that we get two file descriptors to the same file and modifying it simultaneously through two different threads. The results are expected to be unpredictable.\n\nCosmin, thanks for editing. Comments are not editable, so we will have to live with what we've got. It's ok now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-03T00:11:08.900+0000","updated":"2010-02-03T00:11:08.900+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828854","id":"12828854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Canceling patch while I look into this some more.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-03T00:12:46.569+0000","updated":"2010-02-03T00:12:46.569+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828861","id":"12828861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"> I added a giant comment at the top of FSEditLog \nMinor thing. Could you pls move the comment down to logSync(). I think it belongs to the implementation of this method rather than to the class itself. The comment is good.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-03T00:27:19.579+0000","updated":"2010-02-03T00:27:19.579+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12828879","id":"12828879","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12434606/hdfs-909.txt\n  against trunk revision 905760.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 2 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/217/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/217/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/217/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/217/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-02-03T01:29:51.479+0000","updated":"2010-02-03T01:29:51.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12829262","id":"12829262","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hi Konstantin. Thanks for the in depth exploration of that race.\n\nLet me ask a question - sorry if I'm being dense here :)\n\nIn FSImage.saveFSImage(boolean) (FSImage.java:1243) we create a new \"current\" edit log file before rolling the FSImage.\nThis seems to be related to the race, and I don't quite understand the design here. It seems to me that the correct operation\nof saveFSImage should be:\n\n1. Dump the image in IMAGE_NEW\n2. Create a new empty edit log in EDITS_NEW (while leaving EDITS alone)\n3. Call purgeEditLogs which rolls the new image/edits pair in.\n\nAnalyzing the failure cases:\n- During step 1, if the NN restarts, it can recover from the preexisting IMAGE/EDITS as if the saveFSImage never started\n- Between step 1 and 2, it can recover from either the preexisting IMAGE/EDITS or the IMAGE_NEW.\nIMAGE_NEW is consistent and up to date because saveFSImage is synchronized, and thus it represents the exact state\nof the namesystem.\n- The same goes for step 2 - the empty edit log is correct against the new log. If we decide to recover from current instead\nof NEW at this point it would also be correct.\n- We must assume that step 3 performs rolling in a way that allows recovery - this is what allows rolling to work in general\nsafely.\n\nIn the implementation as I understand it, step 2 is implemented differently such that it calls createEditLogFile on EDITS, not\njust EDITS_NEW. This truncates the edits, which means we can only recover from the NEW image at this point. This makes\nfor tricky recovery logic, since we have an old image with truncated edit log, plus a new image (which we don't have any great way\nof knowing is complete). Additionally, I don't think there's a guarantee that steps 1 and 2 happen in that order - the order of\nsaveFSImage is determined by the order of the storage directories in the directory iterator. It seems like edits _usually_\ncome last, but in the case of failed/recovered storage directories, I don't think it's always true. If the order of step 1 and 2 are\ninverted, it could truncate the current edits log before saving the new image, and thus end up losing all those edits if the\nNN failed in between.\n\nAm I misunderstanding something? The simple fix to the issue you suggested above is to add a waitForSyncToFinish in\ncreateEditLogFile, but I'm worried there may be more subtle issues as described above.\n\nThanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-03T21:10:51.889+0000","updated":"2010-02-03T21:10:51.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12829930","id":"12829930","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd, EDITS_NEW is created when the checkpoint starts. \nAfter that all new transactions will go into EDITS_NEW, while EDITS will remains untouched. \nSo if you empty EDITS_NEW in your step (2) you basically wipe out latest transactions in HDFS.\nDoes that make sense?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-05T02:53:08.816+0000","updated":"2010-02-05T02:53:08.816+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12830313","id":"12830313","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I think we're talking about different things. I'm discussing the saveFSImage that is called by\nFSNamesystem.saveNamespace, where you found the race above.\n\nFSImage.saveFSImage has this code:\n{noformat}\n1240       if (dirType.isOfType(NameNodeDirType.IMAGE))\n1241         saveFSImage(getImageFile(sd, NameNodeFile.IMAGE_NEW));\n1242       if (dirType.isOfType(NameNodeDirType.EDITS)) {\n1243         editLog.createEditLogFile(getImageFile(sd, NameNodeFile.EDITS));\n1244         File editsNew = getImageFile(sd, NameNodeFile.EDITS_NEW);\n1245         if (editsNew.exists())\n1246           editLog.createEditLogFile(editsNew);\n1247       }\n{noformat}\n\nOn line 1243 we truncate EDITS. Then if EDITS_NEW exists, we truncate it on 1246. All of this happens when\nthe NN is in safe mode, so there shouldn't be any new edits coming in in the first place.\n\nI'm contending that line 1243 and 1245 should both be deleted. We should always create the image as\nIMAGE_NEW (line 1241). Touching EDITS seems incorrect - what if the order of storage dirs is EDITS\nthen IMAGE, so we run line 1243, kill our current edit log, and then crash before saving the current image?\n\n(this is possibly orthogonal to the issue you raised - even though there are no edits, there can be an ongoing sync.\nI think the NN should call editLog.waitForSyncToFinish before entering safemode to avoid this issue)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-05T21:45:30.939+0000","updated":"2010-02-05T21:45:30.939+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12830399","id":"12830399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"> NN is in safe mode, so there shouldn't be any new edits coming in in the first place.\n\nTrue no new edits, but those started before entering safemode can still run.\n\n> what if the order of storage dirs is EDITS then IMAGE, so we kill our current edit log, and then crash before saving the current image?\n\nThis is a reasonable concern. \nHistorically fsimage and edits used to be always in the same directory, so we first saved the image \nin the directory and then reset the edits. Now the order may change, and this was not taken care of.\nWe should file a new jira for fixing this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-06T01:09:34.736+0000","updated":"2010-02-06T01:09:34.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12831115","id":"12831115","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I think next step is to write a unit test which tries to trigger the race you found above, and fix it with an additional\ncall to waitForSyncToFinish in an appropriate place. Should be able to get to that this week.\n\nI'll open another JIRA for the saveFSImage behavior described above.\n\nSound good?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-08T20:58:05.107+0000","updated":"2010-02-08T20:58:05.107+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12831130","id":"12831130","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Sounds good. I think we will need to call {{waitForSyncToFinish()}} both before entering safe mode and in {{createEditLogFile()}}.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-08T21:33:50.216+0000","updated":"2010-02-08T21:33:50.216+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12831200","id":"12831200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Unfortunately, I wasn't able to write a unit test that reproduces your race. This is because the race only\noccurs if the NN exits before rollEditLogs() is called at the end of FSImage.saveFSImage(boolean) --\nthe race induces corruiption in EDITS, but EDITS_NEW is a correct empty file. rollEditLogs thus fixes\nup the state of the file.\n\nI think we'll deal with this issue in the other JIRA regarding saveFSImage operation.\n\nbq. think we will need to call waitForSyncToFinish() both before entering safe mode\n\nI think it's actually impossible to be correct here. The issue with waitForSyncToFinish in enterSafeMode is that many\nof the FSNamesystem calls have a structure that looks like:\n{code}\n1 void someOperation() {\n2   synchronized (this) {\n3     if (!isInSafeMode()) { explode; }\n4     internalSomeOperation();\n5   }\n6   getEditLog().logSync();\n7 }\n{code}\n\nIf we call enterSafeMode between line 5 and 6, a waitForSyncToFinish would return immediately,\nsince the sync isn't running yet. Really this is the case for any of lines 3-6 since enterSafeMode\nis synchronized as well.\n\nI think we need an additional method with stronger guarantees than waitForSyncToFinish - something like\nsyncAllOutstandingOperations that waits until synctxid == txid.\n\nWhat do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-08T23:58:00.695+0000","updated":"2010-02-08T23:58:00.695+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12832142","id":"12832142","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"> Unfortunately, I wasn't able to write a unit test that reproduces your race. \n\nYes unit test is hard here. \nBut you can reproduce the problem manually, then fix it and verify the same sequence of steps does not corrupt the edits.\nThis is a perfectly acceptable way of doing things imo, and in line with practices in this community.\n\n> I think we need an additional method with stronger guarantees than waitForSyncToFinish\n\nWhat if we just call {{getEditLog().logSync();}} before entering safe mode. \nIf it is a synchronized call it should guarantee all syncs are complete when we enter safe mode.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-10T19:33:38.327+0000","updated":"2010-02-10T19:33:38.327+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12832145","id":"12832145","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"{quote}\nBut you can reproduce the problem manually, then fix it and verify the same sequence of steps does not corrupt the edits.\nThis is a perfectly acceptable way of doing things imo, and in line with practices in this community.\n{quote}\n\nFor less critical code paths, I agree, but for potential data loss I really would like to figure out an automatic test here.\nI'll take another swing at a unit test - I often find after a few days away a second try is a lot easier than the first.\n\nbq. What if we just call getEditLog().logSync(); before entering safe mode. \n\nThat won't work unless we also write something in the log so that the ThreadLocal transaction ID is updated, right?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-10T19:41:58.931+0000","updated":"2010-02-10T19:41:58.931+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12832153","id":"12832153","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cos","name":"cos","key":"cos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cos&avatarId=16741","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cos&avatarId=16741","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cos&avatarId=16741","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cos&avatarId=16741"},"displayName":"Konstantin Boudnik","active":true,"timeZone":"America/Los_Angeles"},"body":"bq. But you can reproduce the problem manually, then fix it and verify the same sequence of steps does not corrupt the edits.\nbq. This is a perfectly acceptable way of doing things imo, and in line with practices in this community.\n\nExcept that there won't be a regression test which might be very handy when a consequent change will affect the fix in question. And today's fix might deteriorate silently.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cos","name":"cos","key":"cos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=cos&avatarId=16741","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=cos&avatarId=16741","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=cos&avatarId=16741","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=cos&avatarId=16741"},"displayName":"Konstantin Boudnik","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-10T19:51:22.660+0000","updated":"2010-02-10T19:51:22.660+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12834044","id":"12834044","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here's a patch which fixes the problem and also includes some more unit tests. It depends on HADOOP-6554 to pass.\n\nOne thing I'd like review comments on:\n\nMost of the FSNamesystem calls have the general form:\n{code}\nvoid xxx() {\n  synchronized (this) {\n    doXXX(); // mutate state\n    getEditLog().logXXX(); // log edits\n  }\n  getEditLog().logSync();\n}\n{code}\n\nFSEditLog.waitForAllOngoingEdits() exists to wait for any threads that have written edits but not yet synced them. This ensures that once we enter safe mode, all edits are safely in the log and we can be sure that the log is no longer changing.\n\nHowever, iff there were an FSNamesystem call that looked like this:\n{code}\nvoid xxx() {\n  synchronized (this) {\n    getEditLog().logXXX();\n  }\n  ...\n  synchronized (this) {\n    getEditLog().logXXX();\n  }\n  logSync();\n}\n{code}\n\nthen we could deadlock if enterSafeMode() were called in between the two synchronized sections, since it would hold the FSN lock while waiting for the logSync(), meanwhile xxx() is waiting to get the lock.\n\nIs this likely to be a problem? Any ideas how to avoid it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-16T02:01:50.566+0000","updated":"2010-02-16T02:01:50.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12834051","id":"12834051","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"I agree with Todd's latest observation. i think we should break up the FSNameSystem lock into a read lock and a write lock. The FSNamesystem.getWriteLock() will presumably be exactly similar to the synchronized sections of the current code.\nThe above two pieces of code can then we modified as follows:\n\n{code}\nvoid xxx() {\n  getWriteLock();\n  try {\n    doXXX(); // mutate state\n    getEditLog().logXXX(); // log edits\n  } finally {\n    writeUnlock();\n  }\n  getEditLog().logSync();\n}\n{code}\n\nand the second piece via:\n\n{code}\nvoid xxx() {\n  getReadLock();\n    ....\n     getWriteLock()\n     ....\n     try {\n      getEditLog().l)ogXXX();\n    } finally {\n      writeUnlock()\n    }\n  ...\n     getWriteLock();\n      try  {\n      getEditLog().logXXX();\n    } finally {\n      writeUnlock();\n    }\n    ...\n    logSync();\n    readUnlock();\n}\n{code}\n\nIn short, if a thread is inside any method in FSNamesystem, it should keep the readlock. The readlock essentially counts the number of threads executing inside FSNamesystem.\n\nThe enterSafeMode() can be written as\n\n{code}\nenterSafeMode() {\n  getWriteLock();\n  try {\n   ....... set safemode flags\n   } finally {\n     writeUnlock()\n   }\n}\n\n{code}\n\nBreaking up  the FSNamesystem lock also has the advantage that it makes the NN code more mult-threaded. For example, if there are multiple requests to getFileStatus() or getRelicationFactor they can all execute in parallel.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-16T02:43:16.524+0000","updated":"2010-02-16T02:43:16.524+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12834073","id":"12834073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Dhruba: nice idea about switching to an RWLock here. However, I think that's likely to be a larger project\n(or at least out of scope for this issue, which I think we ought to fix for branch-0.20). Do you think there\nare any potential deadlocks in the current code, given the observation above? i.e is it unsafe to commit\nthis patch, and then later do the RWLock conversion to make it less error prone and get the other\nbenefits you noted?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-16T04:13:24.767+0000","updated":"2010-02-16T04:13:24.767+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12834077","id":"12834077","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"I agree that the RWlock idea is only for trunk.\n\nin 0.20, is there any code paths that does the following:\n\n{code}\nvoid xxx() {\n  synchronized (this) {\n    getEditLog().logXXX();\n  }\n  ...\n  synchronized (this) {\n    getEditLog().logXXX();\n  }\n  logSync();\n}\n{code}\n\nif there re no such code paths, then there is no chance of deadlock. Otherwise, we migth want a fix for 0.20","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-16T04:25:12.555+0000","updated":"2010-02-16T04:25:12.555+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12834096","id":"12834096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"I thought about this a bit more deeply over dinner :) I think the potential issue is not in fact a deadlock,\nsince waitForAllOngoingEdits is a bit misnamed. In fact, it just calls through to logSync, so in the\n\"bad code\" example above, what will happen is that we sync the first synchronized block's edit for it,\nand then enter safe mode before entering the second synchronized block.\n\nSo, to be correct, code just needs to make sure that it always checks isInSafeMode() each time it enters\nsynchronized (this) {...}, before making any edit. Dhruba, do you concur?\n\nSwitching to the ReadWriteLock would be nice since we could enforce the safemode check as part of\nthe lock acquisition. But that's definitely out of scope.\n\nSo, I think this is a certain improvement with no deadlock potential. The error case described above is\nno worse than what currently happens. So, I think the patch is good, and we'll use HDFS-956 to fix the\n\"always check safe mode after entering synchronized blocks\" problems.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-16T06:19:44.721+0000","updated":"2010-02-16T06:19:44.721+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12834158","id":"12834158","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"body":"@Todd what's the state of this patch? This happens more often than I initially thought. Just hit it again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-16T10:49:49.772+0000","updated":"2010-02-16T10:49:49.772+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12834259","id":"12834259","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hi Cosmin,\n\nI think the most recent patch is good, though it will need some munging to apply to branch-20.\nIf you can apply it and test it out for us, that would be great!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-16T15:37:11.002+0000","updated":"2010-02-16T15:37:11.002+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12834264","id":"12834264","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"body":"@Todd,\n\nThanks! We're using 0.21 :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clehene","name":"clehene","key":"clehene","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=clehene&avatarId=33348","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=clehene&avatarId=33348","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=clehene&avatarId=33348","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=clehene&avatarId=33348"},"displayName":"Cosmin Lehene","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-02-16T15:41:47.665+0000","updated":"2010-02-16T15:41:47.665+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12835168","id":"12835168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"I think this problem does not exist in 0.20. Both FSEditLog.close and FSEditLog.logSync invoke setReadyToFlush() within a synchronized section.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T11:02:20.144+0000","updated":"2010-02-18T11:02:20.144+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12835169","id":"12835169","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"One problem I can see in 0.20 is that isSyncRunning is not a volatile variable. Can this cause a problem?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T11:03:39.440+0000","updated":"2010-02-18T11:03:39.440+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12835284","id":"12835284","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. I think this problem does not exist in 0.20. Both FSEditLog.close and FSEditLog.logSync invoke setReadyToFlush() within a synchronized section. \n\nI also think we're safe from the issue Cosmin is seeing, since close() waits for the sync to complete before moving on. But we may be susceptible to Konstantin's race, since\nenterSafeMode doesn't have the right wait behavior.\n\nI hope to get a chance to backport my current set of tests to 20 and see what the minimal set of changes are to fix, if they expose issues.\n\nbq. One problem I can see in 0.20 is that isSyncRunning is not a volatile variable. Can this cause a problem? \n\nI don't think so, because in this case isSyncRunning is only accessed inside synchronized blocks. It may not need to be volatile even in trunk -\nI'll check that out too.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T16:46:13.179+0000","updated":"2010-02-18T16:46:13.179+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12835370","id":"12835370","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"I recently experienced the race condition between saveNamespace and logSync methods. The problem is that the last transaction is still in progress even though the namenode has entered safemode.\nThe last transaction in the edits log gets corrupted.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T19:53:49.218+0000","updated":"2010-02-18T19:53:49.218+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12835462","id":"12835462","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"OK. I will target a patch against branch-20 as well, then. Would you mind reviewing the top patch against trunk?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T23:03:22.295+0000","updated":"2010-02-18T23:03:22.295+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12835464","id":"12835464","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"I also posted a patch just fr the savenamespace-safemode race via HDFS-988. appreciate ur feedback on that one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-02-18T23:06:43.902+0000","updated":"2010-02-18T23:06:43.902+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12854210","id":"12854210","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Patch updated against trunk. Verified that without the patch, the unit test fails, and passes after patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-06T21:49:36.297+0000","updated":"2010-04-06T21:49:36.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12854289","id":"12854289","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"body":"-1 overall.  Here are the results of testing the latest attachment \n  http://issues.apache.org/jira/secure/attachment/12440954/hdfs-909.txt\n  against trunk revision 931338.\n\n    +1 @author.  The patch does not contain any @author tags.\n\n    +1 tests included.  The patch appears to include 7 new or modified tests.\n\n    +1 javadoc.  The javadoc tool did not generate any warning messages.\n\n    +1 javac.  The applied patch does not increase the total number of javac compiler warnings.\n\n    +1 findbugs.  The patch does not introduce any new Findbugs warnings.\n\n    +1 release audit.  The applied patch does not increase the total number of release audit warnings.\n\n    -1 core tests.  The patch failed core unit tests.\n\n    -1 contrib tests.  The patch failed contrib unit tests.\n\nTest results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/304/testReport/\nFindbugs warnings: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/304/artifact/trunk/build/test/findbugs/newPatchFindbugsWarnings.html\nCheckstyle results: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/304/artifact/trunk/build/test/checkstyle-errors.html\nConsole output: http://hudson.zones.apache.org/hudson/job/Hdfs-Patch-h5.grid.sp2.yahoo.net/304/console\n\nThis message is automatically generated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hadoopqa","name":"hadoopqa","key":"hadoopqa","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=hadoopqa&avatarId=10393","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=hadoopqa&avatarId=10393","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=hadoopqa&avatarId=10393","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=hadoopqa&avatarId=10393"},"displayName":"Hadoop QA","active":true,"timeZone":"Etc/UTC"},"created":"2010-04-07T01:01:24.108+0000","updated":"2010-04-07T01:01:24.108+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12854291","id":"12854291","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Looks like hudson's just being crazy -- failed tests are unrelated. Do we need to resubmit?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-07T01:14:31.120+0000","updated":"2010-04-07T01:14:31.120+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12856305","id":"12856305","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Can someone please take a look  at this blocker? I've verified it still applies against trunk.\nThe new tests fail when run against unpatched trunk and pass when I apply the rest\nof the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-13T05:16:04.899+0000","updated":"2010-04-13T05:16:04.899+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12856571","id":"12856571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"This patch has intersections with HDFS-988. Could you please clarify the dependency? \nAs it looks now we need both of them to get it right. \nDoes Dhruba plan to continue with HDFS-988 or does it make sense to incorporate them?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-13T19:25:46.280+0000","updated":"2010-04-13T19:25:46.280+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12856685","id":"12856685","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"The patch looks good. A few nits.\n# The giant comment should be a javadoc for logSync(). Right now it is attached to a private variable {{isSyncRunning}}.\n# {{waitForAllOngoingEdits()}} should not be public.\n# If I were to choose between names and {{logSyncAll()}} for the new method I'd prefer Dhurba's {{logSyncAll()}}.\n# Instead of increasing visibility of {{FSEditLog.editStreams}} I'd rather introduce getter or setter methods. You need only for tests, right?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-13T23:22:48.151+0000","updated":"2010-04-13T23:22:48.151+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12856687","id":"12856687","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Sorry, (3) should read:\n3. If I were to choose between names {{waitForAllOngoingEdits()}} and {{logSyncAll()}} for the new method I'd prefer Dhurba's {{logSyncAll()}}.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-13T23:25:04.952+0000","updated":"2010-04-13T23:25:04.952+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12856699","id":"12856699","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Thanks for the review. New patch addresses your comments.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-13T23:59:25.266+0000","updated":"2010-04-13T23:59:25.266+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12856718","id":"12856718","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"+1 for the patch.\nThe interconnection with HDFS-988 is still not clear, but this should not block committing this, imo.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-14T01:14:04.392+0000","updated":"2010-04-14T01:14:04.392+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12856720","id":"12856720","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"yep, I will update the patch at 988 once this is committed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-14T01:29:23.950+0000","updated":"2010-04-14T01:29:23.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12856751","id":"12856751","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"body":"> Does Dhruba plan to continue with HDFS-988 or does it make sense to incorporate them?\n\nTodd, if you have the time and energy, please feel free to reassign HDFS-988 to yourself. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dhruba","name":"dhruba","key":"dhruba","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=dhruba&avatarId=30636","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=dhruba&avatarId=30636","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=dhruba&avatarId=30636","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=dhruba&avatarId=30636"},"displayName":"dhruba borthakur","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-14T04:47:16.510+0000","updated":"2010-04-14T04:47:16.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12857563","id":"12857563","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"I see it passed Hudson\nhttp://hudson.zones.apache.org/hudson/view/Hdfs/job/Hdfs-Patch-h2.grid.sp2.yahoo.net/153/\nwith one failed test TestDiskError.testLocalDirs.\nWhen I run it on my box it does not fail, and it failed on Hudson in some other builds. \nI don't think this is related to the patch.\n\nTodd, this marked for committing to 0.21 and 0.20. \nCould you please compile the respective patches, and make sure they pass tests on their branches.\nI will commit it then.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-15T21:58:59.711+0000","updated":"2010-04-15T21:58:59.711+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12858066","id":"12858066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here is a patch against branch-0.20. All four tests pass. If I revert the fix but keep the test, 3/4 of them fail (one times out after an exception causes the edit log to get stuck in sync and the others fail outright)\n\nI am not planning on doing one for branch-0.21, since as I understand it we are abandoning that branch in favor of a release based on what's now trunk.\n\nOne question: the sync() in trunk has a nice fix that adds a finally clause to reset the isSyncRunning flag in case an exception got thrown. Should we backport this fix as well?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-17T01:31:39.024+0000","updated":"2010-04-17T01:31:39.024+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12858724","id":"12858724","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Not sure how much 0.21 is abandoned. I hear people use it with HBase. Here is the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-19T23:24:06.601+0000","updated":"2010-04-19T23:24:06.601+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12858731","id":"12858731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Todd, I tried to run TestEditLogRace with your 0.20 patch. It runs forever and finaly times out.\nFeels like it does a lot of transactions. Could you please verify.\nIn the trunk the same test runs 42 secs. \nAlso you have some debug printouts in the patch, like \"===== CLOSE DONE\", and you use FSnamesystem.LOG for logging in the test.\nThe latter is confising, as then you'd expect a message from FSNamesystem while it comes from the test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-20T00:15:34.048+0000","updated":"2010-04-20T00:15:34.048+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12858733","id":"12858733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"Some more:\nWhat {{org.apache.tools.ant.taskdefs.WaitFor}} is used for?\nAnd there is an blank line change at the end of FSEditLog.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-20T00:21:35.479+0000","updated":"2010-04-20T00:21:35.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859001","id":"12859001","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Hi Konstantin,\n\nThanks for the review. It does seem like the test for branch-20 occasionally fails - I had it passing here, but it's flaky and\ndoesn't pass every time. Let me dig into this and upload a new fixed patch.\n\nbq. What org.apache.tools.ant.taskdefs.WaitFor is used for?\n\nNo idea where this came from. I've been trying out Eclipse recently instead of my usual vim, and haven't gotten used to\nclean up after its \"smarts\" :) Will doublecheck the next patch for such cruft as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-20T18:17:07.640+0000","updated":"2010-04-20T18:17:07.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859069","id":"12859069","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"It turns out the test on trunk was flaky as well. The issue was that we were calling saveNamespace directly on the FSImage while also performing edits from the Transactions threads. This is exactly the behavior we're trying to avoid by forcing the NN into safemode first. Also, we were calling verifyEdits() on an edit log that was being simultaneously written to, which is likely to fail if it reads a partial edit.\n\nThis patch against trunk does the following:\n- Bumps up the number of rolls and saves to 30 instead of 10, since obviously 10 wasn't enough to have it fail reliably.\n- Replaces use of the FSN log with the test's own log\n- Changes the transaction threads to operate via FSN rather than logging directly to the edit log.\n- Any exceptions thrown by the edits will cause the test to properly fail\n\nTo verify this fix, I temporarily bumped the constants for number of rolls up to 200 and checked that it passed.\n\nThis failed sometimes for me without HADOOP-6717, a trivial patch which reduces the amount of log output from new security code.\n\nI'll separately amend the branch-20 patch with the same changes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-20T21:28:53.640+0000","updated":"2010-04-20T21:28:53.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859071","id":"12859071","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"FSEditLog,java imports org.apache.tools.ant.taskdefs.WaitFor in your patch for 0.20.\nAs you see I've already committed the other two branches. So it would be good to finish this sooner than later. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-20T21:30:34.303+0000","updated":"2010-04-20T21:30:34.303+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859083","id":"12859083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Updated branch-20 patch with same changes (plus cleanup of the changes I accidentally left in before)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-20T21:54:50.584+0000","updated":"2010-04-20T21:54:50.584+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859086","id":"12859086","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"bq. Not sure how much 0.21 is abandoned. I hear people use it with HBase. Here is the patch.\n\nThe plan for HBase 0.20.5 is to work against Tom's new 21 release or a 20 with HDFS-200 applied,\nnot the current 21 branch. I checked with Cosmin and he is OK moving to what's now trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-20T21:58:50.454+0000","updated":"2010-04-20T21:58:50.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859123","id":"12859123","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"What is hdfs-909-ammendation.txt for?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-20T23:26:14.483+0000","updated":"2010-04-20T23:26:14.483+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859125","id":"12859125","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"hdfs-909-ammendation.txt goes with this comment above:\n\nhttps://issues.apache.org/jira/browse/HDFS-909?focusedCommentId=12859069&page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#action_12859069\n\n(the test as committed in trunk is flaky as well, this is a patch against trunk that fixes it. The bug is just in the test, though, not the code itself)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-20T23:30:11.741+0000","updated":"2010-04-20T23:30:11.741+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859133","id":"12859133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"- The issue is not closed, so it would be better to have a unified patch, rather than doing 2 commits. I don't mind to recommit.\n- Test for 0.20 passes fine now. Found 2 (eclipse) warnings in TestEditLogRace:\n-- Method {{getFormattedFSImage()}} is not used anywhere.\n-- Static method {{setBufferCapacity()}} should be called in static manner, like {{FSEditLog.setBufferCapacity()}}\n- I understand Tom's plan for 0.21. It does not hurt to commit though.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-21T00:05:16.686+0000","updated":"2010-04-21T00:05:16.686+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859134","id":"12859134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"body":"Here's a unified patch for trunk (the one you committed to trunk plus the test case fixes)\nAlso branch 20 patch that addresses the two eclipse warnings you found.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlipcon","name":"tlipcon","key":"tlipcon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tlipcon&avatarId=26804","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tlipcon&avatarId=26804","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tlipcon&avatarId=26804","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tlipcon&avatarId=26804"},"displayName":"Todd Lipcon","active":true,"timeZone":"America/Tijuana"},"created":"2010-04-21T00:12:27.319+0000","updated":"2010-04-21T00:12:27.319+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12446120/comment/12859177","id":"12859177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"body":"I just committed this. Thank you Todd.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shv","name":"shv","key":"shv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Konstantin Shvachko","active":true,"timeZone":"America/Los_Angeles"},"created":"2010-04-21T03:09:09.955+0000","updated":"2010-04-21T03:09:09.955+0000"}],"maxResults":74,"total":74,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-909/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i02snz:"}}