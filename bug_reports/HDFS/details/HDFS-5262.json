{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12670585","self":"https://issues.apache.org/jira/rest/api/2/issue/12670585","key":"HDFS-5262","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2013-09-26T00:34:38.462+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 26 04:10:44 UTC 2013","customfield_12310420":"350414","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-5262/watchers","watchCount":8,"isWatching":false},"created":"2013-09-25T21:57:22.054+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324428","id":"12324428","description":"maintenance release on branch-2.0-alpha","name":"2.0.5-alpha","archived":false,"released":true,"releaseDate":"2013-06-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-09-26T04:10:44.079+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12312928","id":"12312928","name":"hdfs-client"}],"timeoriginalestimate":null,"description":"We noticed that when we set the value of 'dfs.client.socket-timeout' to 0, \nand start the HBase regionserver in the same node as the Datanode, we have a situation where the Datanode heap size just blows up in a very short span of time.\n\nA jmap histogram of the live objects in the datanode yields this :\n\n{noformat}\n~/hbase_debug]$ head jmap.histo\n\n num     #instances         #bytes  class name\n----------------------------------------------\n   1:      46054779     1842191160  org.apache.hadoop.hdfs.server.datanode.BlockReceiver$Packet\n   2:      46054878     1105317072  java.util.LinkedList$Entry\n....\n....\n{noformat}\n\nand again after a couple of seconds :\n\n{noformat}\n~/hbase_debug]$ head jmap2.histo\n\n num     #instances         #bytes  class name\n----------------------------------------------\n   1:      50504594     2020183760  org.apache.hadoop.hdfs.server.datanode.BlockReceiver$Packet\n   2:      50504693     1212112632  java.util.LinkedList$Entry\n....\n....\n{noformat}\n\nWe also see a very high rate of minor GCs happening and untimately, full GCs start with pause times of around 10 - 15 secs and this keeps increasing..\n\nIt looks like entries are being pushed into a linkedlist very rapidly and thus are not eligible for GC\n\nOn enabling debug logging for the DFS client and hadoop ipc on the HBase regionserver this is what we see :\n{noformat}\n2013-09-24 20:53:10,485 DEBUG org.apache.hadoop.ipc.HBaseServer: IPC Server handler 23 on 60020: has #26 from 192.168.0.67:33790\n2013-09-24 20:53:10,485 DEBUG org.apache.hadoop.ipc.HBaseServer: IPC Server handler 23 on 60020: call #26 executing as NULL principal\n2013-09-24 20:53:10,485 DEBUG org.apache.hadoop.ipc.HBaseServer.trace: Call #26; Served: HRegionInterface#get queueTime=0 processingTime=0 contents=1 Get, 9 bytes\n2013-09-24 20:53:10,486 DEBUG org.apache.hadoop.ipc.HBaseServer: IPC Server Responder: responding to #26 from 192.168.0.67:33790\n2013-09-24 20:53:10,486 DEBUG org.apache.hadoop.ipc.HBaseServer: IPC Server Responder: responding to #26 from 192.168.0.67:33790 Wrote 140 bytes.\n2013-09-24 20:53:10,523 DEBUG org.apache.hadoop.hdfs.DFSClient: DataStreamer block BP-295691219-192.168.0.58-1380070220243:blk_2084430581332674588_1018 sending packet packet seqno:0 offsetInBlock:0 lastPacketInBlock:false lastByteOffsetInBlock: 326\n2013-09-24 20:53:10,523 DEBUG org.apache.hadoop.hdfs.DFSClient: DataStreamer block BP-295691219-192.168.0.58-1380070220243:blk_2084430581332674588_1018 sending packet packet seqno:-1 offsetInBlock:0 lastPacketInBlock:false lastByteOffsetInBlock: 0\n2013-09-24 20:53:10,523 DEBUG org.apache.hadoop.hdfs.DFSClient: DataStreamer block BP-295691219-192.168.0.58-1380070220243:blk_2084430581332674588_1018 sending packet packet seqno:-1 offsetInBlock:0 lastPacketInBlock:false lastByteOffsetInBlock: 0\n2013-09-24 20:53:10,523 DEBUG org.apache.hadoop.hdfs.DFSClient: DataStreamer block BP-295691219-192.168.0.58-1380070220243:blk_2084430581332674588_1018 sending packet packet seqno:-1 offsetInBlock:0 lastPacketInBlock:false lastByteOffsetInBlock: 0\n2013-09-24 20:53:10,523 DEBUG org.apache.hadoop.hdfs.DFSClient: DataStreamer block BP-295691219-192.168.0.58-1380070220243:blk_2084430581332674588_1018 sending packet packet seqno:-1 offsetInBlock:0 lastPacketInBlock:false lastByteOffsetInBlock: 0\n2013-09-24 20:53:10,524 DEBUG org.apache.hadoop.hdfs.DFSClient: DataStreamer block BP-295691219-192.168.0.58-1380070220243:blk_2084430581332674588_1018 sending packet packet seqno:-1 offsetInBlock:0 lastPacketInBlock:false lastByteOffsetInBlock: 0\n2013-09-24 20:53:10,524 DEBUG org.apache.hadoop.hdfs.DFSClient: DataStreamer block BP-295691219-192.168.0.58-1380070220243:blk_2084430581332674588_1018 sending packet packet seqno:-1 offsetInBlock:0 lastPacketInBlock:false lastByteOffsetInBlock: 0\n....\n....\n....\n{noformat}\n\nThe last line keeps repeating.. and the LOG files run into 100s of MBs really fast..\n\nMy assumption was that the HBase region server creates an hlog file at startup.. which it keeps open by sending a heartbeat (-1 seqno) packet... But we were stumped as to why packets were sent at this alarming rate.\n\nLooking at the DFSOutputstream code, it looks like there is a section inside the DataStreamer class where the 'dfs.client.socket-timeout' is being used :\n\n{code}\n..\n....\n            while ((!streamerClosed && !hasError && dfsClient.clientRunning \n                && dataQueue.size() == 0 && \n                (stage != BlockConstructionStage.DATA_STREAMING || \n                 stage == BlockConstructionStage.DATA_STREAMING && \n                 now - lastPacket < dfsClient.getConf().socketTimeout/2)) || doSleep ) {\n              long timeout = dfsClient.getConf().socketTimeout/2 - (now-lastPacket);\n              timeout = timeout <= 0 ? 1000 : timeout;\n              timeout = (stage == BlockConstructionStage.DATA_STREAMING)?\n                 timeout : 1000;\n              try {\n                dataQueue.wait(timeout);\n              } catch (InterruptedException  e) {\n              }\n              doSleep = false;\n              now = Time.now();\n            }\n...\n..\n{code}\n\nWe see that this code path is never traversed and thus Datastreamer thread keeps sending packets without any delay...\n\nFurther more, on going thru the DataStreamer code, it looks like once the DataStreamer starts sending heartbeat packets, there is no code path that checks to see if there is any valid data in the dataQueue.. except the above piece... \n\nwhich implies that unless the absolute value of 'now - lastPacket' is less than 'dfs.client.socket-timeout', the client would hang...\n\nShouldnt there be a timed 'dataQueue.wait()' in each loop of the DataStreamer irrespective of the value of this parameter ?\n\nKindly do provide comments..\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"350707","customfield_12312823":null,"summary":"HDFS Datanode goes out of memory and HBase Regionserver hangs when dfs.client.socket-timeout=0","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CentOS 6.2","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12670585/comment/13778286","id":"13778286","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"[~asuresh], when creating a jira, please keep the description small. Typically this is done by adding a brief description with details in a follow up comment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-09-26T00:34:38.462+0000","updated":"2013-09-26T00:34:38.462+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12670585/comment/13778301","id":"13778301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"body":"I will take a look at the code and description shortly. I am curious, why are you setting dfs.client.socket-timeout to 0?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sureshms","name":"sureshms","key":"sureshms","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10450","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10450","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10450","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10450"},"displayName":"Suresh Srinivas","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-09-26T00:44:07.420+0000","updated":"2013-09-26T00:44:07.420+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12670585/comment/13778442","id":"13778442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"body":"Hello [~sureshms].. we actually use a C++ library based on HDFS protobuf compatible rpc, to talk to DFS. In the process of tuning, we had observed performance gains when we had set 'dfs.client.socket-timeout' to 0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asuresh","name":"asuresh","key":"asuresh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arun Suresh","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-09-26T04:10:44.079+0000","updated":"2013-09-26T04:10:44.079+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-5262/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1of3r:"}}