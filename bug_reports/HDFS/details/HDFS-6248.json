{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12708650","self":"https://issues.apache.org/jira/rest/api/2/issue/12708650","key":"HDFS-6248","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2014-04-16T13:48:51.603+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Apr 16 14:39:50 UTC 2014","customfield_12310420":"386973","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_50393323_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-04-16T13:48:51.576+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6248/watchers","watchCount":6,"isWatching":false},"created":"2014-04-15T23:48:58.311+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324811","id":"12324811","description":"2.0.6-alpha bug-fix release","name":"2.0.6-alpha","archived":false,"released":true,"releaseDate":"2013-08-22"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326143","id":"12326143","description":"2.4.0 release","name":"2.4.0","archived":false,"released":true,"releaseDate":"2014-04-07"}],"issuelinks":[{"id":"12386559","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12386559","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12706520","key":"HDFS-6191","self":"https://issues.apache.org/jira/rest/api/2/issue/12706520","fields":{"summary":"Disable quota checks when replaying edit log.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-04-16T14:39:50.134+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"description":"We are seeing cases when Secondary NameNode crashes without recovery when it tries to replay edit log of files which are part of directories which have exceeded Quota. While debugging we got stack trace but we are still trying to reproduce this and wanted to note this to see if anyone else had seen this issue already. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12640397","id":"12640397","filename":"HDFS-6248.1.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-16T06:37:25.742+0000","size":1431,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12640397/HDFS-6248.1.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"387236","customfield_12312823":null,"summary":"SNN crash during replay of FSEditLog of files inside directories having QuotaExceeded directories ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"NameNode HA setup with Active/Standby using QJM","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12708650/comment/13970218","id":"13970218","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"body":"Here is stack trace of SNN before crash.\n\n{noformat}\n\n2014-03-29 18:07:35,380 ERROR org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader: Encountered exception on operation AddOp [length=0, path=/user/foo/bar.txt, replication=3, mtime=1396116335071, atime=1396116335071, blockSize=536870912, blocks=[], permissions=foo:supergroup:rw-r--r--, clientName=DFSClient_attempt_1395346107078_146938_m_000041_1_1098354233_1, clientMachine=10.10.10.10, opCode=OP_ADD, txid=487688396]\njava.lang.NullPointerException\n     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.applyEditLogOp(FSEditLogLoader.java:281)\n     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.loadEditRecords(FSEditLogLoader.java:171)\n     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.loadFSEdits(FSEditLogLoader.java:90)\n     at org.apache.hadoop.hdfs.server.namenode.FSImage.loadEdits(FSImage.java:708)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer.doTailEdits(EditLogTailer.java:227)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.doWork(EditLogTailer.java:321)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.access$200(EditLogTailer.java:279)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread$1.run(EditLogTailer.java:296)\n     at org.apache.hadoop.security.SecurityUtil.doAsLoginUserOrFatal(SecurityUtil.java:456)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.run(EditLogTailer.java:292)\n2014-03-29 18:07:35,622 WARN org.apache.hadoop.hdfs.server.namenode.NameNode: Quota violation in image for //user/foo (Namespace quota : 1445052 consumed : 1304943) (Diskspace quota : 2199023255552000 consumed : 2199023483200164).\n2014-03-29 18:07:36,429 FATAL org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer: Unknown error encountered while tailing edits. Shutting down standby NN.\njava.io.IOException: Failed to apply edit log operation AddOp [length=0, path=/user/foo/bar.txt, replication=3, mtime=1396116335071, atime=1396116335071, blockSize=536870912, blocks=[], permissions=foo:supergroup:rw-r--r--, clientName=DFSClient_attempt_1395346107078_146938_m_000041_1_1098354233_1, clientMachine=10.10.10.10, opCode=OP_ADD, txid=487688396]: error null\n     at org.apache.hadoop.hdfs.server.namenode.MetaRecoveryContext.editLogLoaderPrompt(MetaRecoveryContext.java:94)\n     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.loadEditRecords(FSEditLogLoader.java:174)\n     at org.apache.hadoop.hdfs.server.namenode.FSEditLogLoader.loadFSEdits(FSEditLogLoader.java:90)\n     at org.apache.hadoop.hdfs.server.namenode.FSImage.loadEdits(FSImage.java:708)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer.doTailEdits(EditLogTailer.java:227)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.doWork(EditLogTailer.java:321)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.access$200(EditLogTailer.java:279)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread$1.run(EditLogTailer.java:296)\n     at org.apache.hadoop.security.SecurityUtil.doAsLoginUserOrFatal(SecurityUtil.java:456)\n     at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.run(EditLogTailer.java:292)\n2014-03-29 18:07:36,431 INFO org.apache.hadoop.util.ExitUtil: Exiting with status 1\n2014-03-29 18:07:36,433 INFO org.apache.hadoop.hdfs.server.namenode.NameNode: SHUTDOWN_MSG:\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-15T23:52:11.618+0000","updated":"2014-04-15T23:52:11.618+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12708650/comment/13970222","id":"13970222","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"body":"Looking at FSEditLogLoader::applyEditLogOp\n\n{code}\n        // add to the file tree\n        newFile = (INodeFile)fsDir.unprotectedAddFile(\n            addCloseOp.path, addCloseOp.permissions,\n            replication, addCloseOp.mtime,\n            addCloseOp.atime, addCloseOp.blockSize,\n            true, addCloseOp.clientName, addCloseOp.clientMachine);\n        fsNamesys.leaseManager.addLease(addCloseOp.clientName, addCloseOp.path);\n{code}\ncould return newFile as null because of QuotaExceededExcetion in uprotectedAddFile\n\nNPE exception happens further down in same function at\n\n{code}\n     // Update the salient file attributes.\n      newFile.setAccessTime(addCloseOp.atime);\n      newFile.setModificationTimeForce(addCloseOp.mtime);\n      updateBlocks(fsDir, addCloseOp, newFile);\n{code}\n\nEven though stack trace points to line number of 2.0.6 release, I could not find any changes in trunk source code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-15T23:55:21.261+0000","updated":"2014-04-15T23:55:21.261+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12708650/comment/13970372","id":"13970372","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"body":"One corner case I suspect is QuotaCheck done FSDirectory::addChild in active vs standby namenodes. When a file is created by active namenode and synced to edits, active NN's quota check might be close to its max, by the time standby NN replays this edit log space quota could have increased because of other files in a directory and valid edit log might hit QuotaExceededException. I feel when Standby namenode replays edits, it should ignore quota check since it is already controlled by Active Namenode anyways. This should solve the race condition and prevent Standby namenode from crashing. What do other think about this approach?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-16T02:49:16.012+0000","updated":"2014-04-16T02:49:16.012+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12708650/comment/13970497","id":"13970497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"body":"Not verifying Quota when in standby could be way to solve this. Attaching potential patch for inputs from others. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-16T06:37:25.746+0000","updated":"2014-04-16T06:37:25.746+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12708650/comment/13971412","id":"13971412","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"It is already fixed by HDFS-6191. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2014-04-16T13:48:51.603+0000","updated":"2014-04-16T13:48:51.603+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12708650/comment/13971484","id":"13971484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"body":"Thanks [~kihwal]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lohit","name":"lohit","key":"lohit","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lohit Vijayarenu","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-16T14:39:50.134+0000","updated":"2014-04-16T14:39:50.134+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6248/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1unvb:"}}