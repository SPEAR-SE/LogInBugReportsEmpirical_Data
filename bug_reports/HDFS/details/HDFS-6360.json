{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12713119","self":"https://issues.apache.org/jira/rest/api/2/issue/12713119","key":"HDFS-6360","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-05-16T01:36:28.664+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri May 16 01:36:28 UTC 2014","customfield_12310420":"391435","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6360/watchers","watchCount":8,"isWatching":false},"created":"2014-05-08T16:14:09.762+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-05-16T01:36:28.664+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"description":"As noted in HDFS-6329 and HDFS-5522, certain use cases of MiniDFSCluster can result in unexpected results and falsely failing or passing unit tests.\n\nSince a {{Configuration}} object is shared for all namenode startups, the modified conf object during a NN startup is passed to the next NN startup.  The effect of the modified conf propagation and subsequent modifications is different depending on whether it is a single NN cluster, HA cluster or federation cluster.\n\nIt also depends on what test cases are doing with the config. For example, MiniDFSCluster#getConfiguration(int) returns the saved conf for the specified NN, but that is not actually the conf object used by the NN. It just contained the same content one time in the past and it is not guaranteed to be that way.\n\nRestarting the same NN can also cause unexpected results. The new NN will switch to the conf that was cloned & saved AFTER the last startup.  The new NN will start with a changed config intentionally or unintentionally.  The config variables such as {{fs.defaultFs}}, {{dfs.namenode.rpc-address}} will be implicitly set differently than the initial condition.  Some test cases rely on this and others occasionally break because of this.\n\nIn summary,\n* MiniDFSCluster does not properly isolate configs.\n* Many test cases happen to work most of times. Correcting MiniDFSCluster causes mass breakages of test cases and requires fixing them.\n* Many test cases rely on broken behavior and might pass when they should have actually failed.\n\nWe need to\n* Make MiniDFSCluster behave in a consistent way\n* Provide proper methods and documentation for the correct usage of MiniDFSCluster\n* Fix the unit tests that will be broken after improving MiniDFSCluster.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"391649","customfield_12312823":null,"summary":"MiniDFSCluster can cause unexpected side effects due to sharing of config","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12713119/comment/13992915","id":"13992915","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"body":"Here is an example from HDFS-5522's precommit build, in which TestNameNodeRespectsBindHostKeys#testServiceRpcBindHostKey failed.\n\nThe test case starts up a MiniDFSCluster and does a check. Then it is shutdown and another one is started with a modified config variable and the test case does another check.\n\nDuring the first NN is startup, the NN internally sets {{fs.defaultFs}}, {{dfs.namenode.servicerpc-address}}, {{dfs.namenode.rpc-address}}, {{dfs.namenode.http-address}}, {{dfs.namenode.https-address}} with the port it actually bound to.  MiniDFSCluster#createNameNode() sets this again after NN startup mainly for HA/federation with nsid and nnid.\n\nThe next time MiniDFSCluster is started or just NN is restarted, the config will contain target binding addresses with a non-zero port number.  Certain configs like {{fs.defaultFs}} is reset by MiniDFSCluster in certain cases (not all the time!), but {{dfs.namenode.servicerpc-address}} is left with the real port.  During restart the NN tries to bind to the specific port for the service RPC server.\n\nIn the failed test case, port 48275 was initially used by the service RPC server. Next time, http server was started with 127.0.0.1:0 and happened to use the recently freed 48275.  Because this port is already taken, the service RPC server failed to start and MiniDFSCluster startup failed.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kihwal","name":"kihwal","key":"kihwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=kihwal&avatarId=34594","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=kihwal&avatarId=34594","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=kihwal&avatarId=34594","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=kihwal&avatarId=34594"},"displayName":"Kihwal Lee","active":true,"timeZone":"America/Chicago"},"created":"2014-05-08T16:53:50.571+0000","updated":"2014-05-08T16:53:50.571+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12713119/comment/13999515","id":"13999515","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"body":"This seems like a pretty serious bug. Kihwal, do you have a rough count of how many tests are broken? If it's really substantial, we might need to do the fixing on a branch to avoid a mega patch, and to help split up the work.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrew.wang","name":"andrew.wang","key":"andrew.wang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andrew.wang&avatarId=19230","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andrew.wang&avatarId=19230","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andrew.wang&avatarId=19230","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andrew.wang&avatarId=19230"},"displayName":"Andrew Wang","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-05-16T01:36:28.664+0000","updated":"2014-05-16T01:36:28.664+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-6360/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1vezz:"}}