{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12743478","self":"https://issues.apache.org/jira/rest/api/2/issue/12743478","key":"HDFS-7134","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12310942","id":"12310942","key":"HDFS","name":"Hadoop HDFS","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/10292","id":"10292","description":"Scalable Distributed Computing","name":"Hadoop"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-02-01T03:35:49.626+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 12 03:11:20 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-7134/watchers","watchCount":3,"isWatching":false},"created":"2014-09-23T08:55:50.232+0000","customfield_12310192":null,"customfield_12310191":null,"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["HDFS"],"customfield_12312333":null,"customfield_12310230":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324148","id":"12324148","description":"maintenance release on branch-1.2","name":"1.2.1","archived":false,"released":true,"releaseDate":"2013-08-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12327181","id":"12327181","description":"2.6.0 release","name":"2.6.0","archived":false,"released":true,"releaseDate":"2014-11-18"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12333995","id":"12333995","description":"2.7.3 release","name":"2.7.3","archived":false,"released":true,"releaseDate":"2016-08-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-06-12T03:11:20.050+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12312927","id":"12312927","name":"datanode"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12329603","id":"12329603","name":"hdfs"}],"timeoriginalestimate":null,"description":"The count for the number of replica's for a block should not change till the blocks have settled on the datanodes.\n\nTest Case:\n\nHadoop Cluster with 1 namenode and 3 datanodes.\nnn1.cluster1.com(192.168.1.70)\ndn1.cluster1.com(192.168.1.72)\ndn2.cluster1.com(192.168.1.73)\ndn3.cluster1.com(192.168.1.74)\n\nCluster up and running fine with replication set to \"1\" for parameter \"dfs.replication on all nodes\"\n\n<property>\n<name>dfs.replication</name>\n<value>1</value>\n</property>\n\nTo reduce the wait time, have reduced the dfs.heartbeat and recheck parameters.\n\non datanode2 (192.168.1.72)\n\n[hadoop@dn2 ~]$ hadoop fs -Ddfs.replication=2 -put from_dn2 /\n\n[hadoop@dn2 ~]$ hadoop fs -ls /from_dn2\nFound 1 items\n-rw-r--r--   2 hadoop supergroup         17 2014-09-23 13:33 /from_dn2\n\nOn Namenode\n===========\nAs expected, copy was done from datanode2, one copy will go locally.\n\n[hadoop@nn1 conf]$ hadoop fsck /from_dn2 -files -blocks -locations\nFSCK started by hadoop from /192.168.1.70 for path /from_dn2 at Tue Sep 23 13:53:16 IST 2014\n/from_dn2 17 bytes, 1 block(s):  OK\n0. blk_8132629811771280764_1175 len=17 repl=2 [192.168.1.74:50010, 192.168.1.73:50010]\n\nCan see the blocks on the data nodes disks as well under the \"current\" directory.\n\nNow, shutdown datanode2(192.168.1.73) and as expected block moves to another datanode to maintain a replication of 2\n\n[hadoop@nn1 conf]$ hadoop fsck /from_dn2 -files -blocks -locations\nFSCK started by hadoop from /192.168.1.70 for path /from_dn2 at Tue Sep 23 13:54:21 IST 2014\n/from_dn2 17 bytes, 1 block(s):  OK\n0. blk_8132629811771280764_1175 len=17 repl=2 [192.168.1.74:50010, 192.168.1.72:50010]\n\nBut, now if i bring back the datanode2, and although the namenode see that this block is at 3 places now and fires a invalidate command for datanode1(192.168.1.72) but the replication on the namenode is bumped to 3 immediately.\n\n[hadoop@nn1 conf]$ hadoop fsck /from_dn2 -files -blocks -locations\nFSCK started by hadoop from /192.168.1.70 for path /from_dn2 at Tue Sep 23 13:56:12 IST 2014\n/from_dn2 17 bytes, 1 block(s):  OK\n0. blk_8132629811771280764_1175 len=17 repl=3 [192.168.1.74:50010, 192.168.1.72:50010, 192.168.1.73:50010]\n\non Datanode1 - The invalidate command has been fired immediately and the block deleted.\n=============\n2014-09-23 13:54:17,483 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Receiving blk_8132629811771280764_1175 src: /192.168.1.74:38099 dest: /192.168.1.72:50010\n2014-09-23 13:54:17,502 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Received blk_8132629811771280764_1175 src: /192.168.1.74:38099 dest: /192.168.1.72:50010 size 17\n2014-09-23 13:55:28,720 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Scheduling blk_8132629811771280764_1175 file /space/disk1/current/blk_8132629811771280764 for deletion\n2014-09-23 13:55:28,721 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Deleted blk_8132629811771280764_1175 at file /space/disk1/current/blk_8132629811771280764\n\nThe namenode still shows 3 replica's. even if one has been deleted, even after more then 30 mins.\n\n[hadoop@nn1 conf]$ hadoop fsck /from_dn2 -files -blocks -locations\nFSCK started by hadoop from /192.168.1.70 for path /from_dn2 at Tue Sep 23 14:21:27 IST 2014\n/from_dn2 17 bytes, 1 block(s):  OK\n0. blk_8132629811771280764_1175 len=17 repl=3 [192.168.1.74:50010, 192.168.1.72:50010, 192.168.1.73:50010]\n\nThis could be a dangerous, if someone remove or other 2 datanodes fail.\n\nOn Datanode 1\n=============\nBefore, the datanode1 is brought back\n\n[hadoop@dn1 conf]$ ls -l /space/disk*/current\n/space/disk1/current:\ntotal 28\n-rw-rw-r-- 1 hadoop hadoop   13 Sep 21 09:09 blk_2278001646987517832\n-rw-rw-r-- 1 hadoop hadoop   11 Sep 21 09:09 blk_2278001646987517832_1171.meta\n-rw-rw-r-- 1 hadoop hadoop   17 Sep 23 13:54 blk_8132629811771280764\n-rw-rw-r-- 1 hadoop hadoop   11 Sep 23 13:54 blk_8132629811771280764_1175.meta\n-rw-rw-r-- 1 hadoop hadoop 5299 Sep 21 10:04 dncp_block_verification.log.curr\n-rw-rw-r-- 1 hadoop hadoop  157 Sep 23 13:51 VERSION\n\nAfter, starting datanode daemon\n\n[hadoop@dn1 conf]$ ls -l /space/disk*/current\n/space/disk1/current:\ntotal 20\n-rw-rw-r-- 1 hadoop hadoop   13 Sep 21 09:09 blk_2278001646987517832\n-rw-rw-r-- 1 hadoop hadoop   11 Sep 21 09:09 blk_2278001646987517832_1171.meta\n-rw-rw-r-- 1 hadoop hadoop 5299 Sep 21 10:04 dncp_block_verification.log.curr\n-rw-rw-r-- 1 hadoop hadoop  157 Sep 23 13:51 VERSION\n\nAs expected the block is deleted as seen in the logs as well, but namenode does not update it.\n\nrc: /192.168.1.74:38099 dest: /192.168.1.72:50010 size 17\n2014-09-23 13:55:28,720 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Scheduling blk_8132629811771280764_1175 file /space/disk1/current/blk_8132629811771280764 for deletion\n2014-09-23 13:55:28,721 INFO org.apache.hadoop.hdfs.server.datanode.DataNode: Deleted blk_8132629811771280764_1175 at file /space/disk1/current/blk_8132629811771280764\n\nThanks","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12310320":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Replication count for a block should not update till the blocks have settled on Datanodes","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gurmukhd","name":"gurmukhd","key":"gurmukhd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"gurmukh singh","active":true,"timeZone":"Australia/Sydney"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gurmukhd","name":"gurmukhd","key":"gurmukhd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"gurmukh singh","active":true,"timeZone":"Australia/Sydney"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux nn1.cluster1.com 2.6.32-431.20.3.el6.x86_64 #1 SMP Thu Jun 19 21:14:45 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux\n\n[hadoop@nn1 conf]$ cat /etc/redhat-release\nCentOS release 6.5 (Final)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743478/comment/14581757","id":"14581757","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gurmukhd","name":"gurmukhd","key":"gurmukhd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"gurmukh singh","active":true,"timeZone":"Australia/Sydney"},"body":"Any update on this behavior. I see this in 2.6.0 as well","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gurmukhd","name":"gurmukhd","key":"gurmukhd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"gurmukh singh","active":true,"timeZone":"Australia/Sydney"},"created":"2015-06-11T10:03:51.916+0000","updated":"2015-06-11T10:03:51.916+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743478/comment/16020441","id":"16020441","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gurmukhd","name":"gurmukhd","key":"gurmukhd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"gurmukh singh","active":true,"timeZone":"Australia/Sydney"},"body":"This behavior is still seen in hadoop 2.7.3. Can someone look into this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gurmukhd","name":"gurmukhd","key":"gurmukhd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"gurmukh singh","active":true,"timeZone":"Australia/Sydney"},"created":"2017-05-23T00:10:10.015+0000","updated":"2017-05-23T00:10:10.015+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743478/comment/16347959","id":"16347959","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liaoyuxiangqin","name":"liaoyuxiangqin","key":"liaoyuxiangqin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liaoyuxiangqin","active":true,"timeZone":"Etc/UTC"},"body":"[~gurmukhd] I have test in hadoop 3.1.0, this issue no longer appear.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=liaoyuxiangqin","name":"liaoyuxiangqin","key":"liaoyuxiangqin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"liaoyuxiangqin","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-01T03:35:49.626+0000","updated":"2018-02-01T03:35:49.626+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12743478/comment/16509113","id":"16509113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gurmukhd","name":"gurmukhd","key":"gurmukhd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"gurmukh singh","active":true,"timeZone":"Australia/Sydney"},"body":"[~liaoyuxiangqin] - Thanks. But, we have gone though so many releases without addressing this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gurmukhd","name":"gurmukhd","key":"gurmukhd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"gurmukh singh","active":true,"timeZone":"Australia/Sydney"},"created":"2018-06-12T03:11:20.050+0000","updated":"2018-06-12T03:11:20.050+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/HDFS-7134/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i000mf:"}}