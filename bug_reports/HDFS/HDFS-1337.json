{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": null,
        "components": [{
            "id": "12312927",
            "name": "datanode",
            "self": "https://issues.apache.org/jira/rest/api/2/component/12312927"
        }],
        "created": "2010-08-09T21:25:23.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thanhdo&avatarId=22565",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thanhdo&avatarId=22565",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thanhdo&avatarId=22565",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=thanhdo&avatarId=22565"
            },
            "displayName": "Thanh Do",
            "key": "thanhdo",
            "name": "thanhdo",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=thanhdo",
            "timeZone": "Etc/UTC"
        },
        "customfield_10010": null,
        "customfield_12310191": null,
        "customfield_12310192": null,
        "customfield_12310220": null,
        "customfield_12310222": null,
        "customfield_12310230": null,
        "customfield_12310250": null,
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "0.0",
        "customfield_12310320": null,
        "customfield_12310420": "15662",
        "customfield_12310920": "113469",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i0js0n:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "2010-08-09 21:25:23.0",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "- Component: data node\n \n- Version: 0.20-append\n \n- Setup:\n1) # disks / datanode = 3\n2) # failures = 2\n3) failure type = crash\n4) When/where failure happens = (see below)\n \n- Details:\nClient writes to dn1-dn2-dn3. Write succeeds. We have blk_X_1001 in all dns.\nNow client tries to append. It first calls dn1.recoverBlock().\nThis recoverBlock succeeds.  We have blk_X_1002 in all dns.\nSuppose the pipeline is dn3-dn2-dn1. Client sends packet to dn3.\ndn3 forwards the packet to dn2 and writes to its disk (i.e dn3's disk).\nNow, *dn2 crashes*, so that dn1 has not received this packet yet.\nClient calls dn1.recoverBlock() again, this time with dn3-dn1 in the pipeline.\ndn1 then calls dn3.startBlockRecovery() which terminates writer thread in dn3,\nget the *in memory* metadata info (i.e 512 byte length), and verifies that info with\nthe real file on disk (i.e 1024 byte length), hence the Exception.\n(in this case, the block at dn3 is not finalized yet, and the FSDataset.setVisibleLength\nhas not been called, hence its visible in-memory length\nis 512 byte, although its on-disk length is 1024.)\nTherefore, from dn1's view, dn3 has some problem.\nNow dn1 calls its own startBlockRecovery() successfully (because the on-disk\nfile length and memory file length match, both are 512 byte).\nNow,\n     + at dn1: blk_X_1003 (length 512)\n     + at dn2: blk_X_1002 (length 512)     \n     + at dn3: blk_X_1002 (length 1024)\n \ndn1 also calls NN.commitSync (blk_X_1003, [dn1]), i.e only dn1 has a good replica.\nAfter all:\n- From NN point of view: dn1 is candidate for leaseRecovery\n- From the client's view, dn1 is the only healthy node in the pipeline.\n(it knows that by the result returned from recoverBlock).\nClient starts sending a packet to dn1, now *dn1 crashes*, hence append fails.\n\n- RE-READ: FAIL\nWhy? after all, dn1 and dn2 crashes. Only dn3 contains the block with GS 1002.\nBut NN sees blk_X_1003, because dn1 has successfully called commitBlockSync(blk_X_1003).\nHence, when reader asks to read the file, NN gives blk_X_1003,\nand no alive dn contains that block with GS 1003.\n \n- RE-APPEND with different client: FAIL\n     + The file is under construction, and its holder is A1.\n \n- NN.leaseRecovery(): FAIL\n     + no alive target (i.e dn1, not dn3)\n     + hence, as long as dn1 is not alive and the lease is not recovered, the file is unable to be appended\n     + worse, even dn3 sends blockReport to NN and becomes target for lease recovery, \n     Lease recovery fails because:\n          1) dn3 has block blk_X_1002 which has smaller GS\n               than the block NN asks for,\n          2) dn3 cannot contact dn1 which crashed\n\nThis bug was found by our Failure Testing Service framework:\nhttp://www.eecs.berkeley.edu/Pubs/TechRpts/2010/EECS-2010-98.html\nFor questions, please email us: Thanh Do (thanhdo@cs.wisc.edu) and \nHaryadi Gunawi (haryadi@eecs.berkeley.edu)",
        "duedate": null,
        "environment": null,
        "fixVersions": [],
        "issuelinks": [],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "id": "3",
            "name": "Major",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12310942&avatarId=10094",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12310942&avatarId=10094",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12310942&avatarId=10094",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12310942&avatarId=10094"
            },
            "id": "12310942",
            "key": "HDFS",
            "name": "Hadoop HDFS",
            "projectCategory": {
                "description": "Scalable Distributed Computing",
                "id": "10292",
                "name": "Hadoop",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/10292"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12310942"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thanhdo&avatarId=22565",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thanhdo&avatarId=22565",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thanhdo&avatarId=22565",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=thanhdo&avatarId=22565"
            },
            "displayName": "Thanh Do",
            "key": "thanhdo",
            "name": "thanhdo",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=thanhdo",
            "timeZone": "Etc/UTC"
        },
        "resolution": null,
        "resolutiondate": null,
        "status": {
            "description": "The issue is open and ready for the assignee to start work on it.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/open.png",
            "id": "1",
            "name": "Open",
            "self": "https://issues.apache.org/jira/rest/api/2/status/1",
            "statusCategory": {
                "colorName": "blue-gray",
                "id": 2,
                "key": "new",
                "name": "To Do",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/2"
            }
        },
        "subtasks": [],
        "summary": "Unmatched file length makes append fail. Should we retry if a startBlockRecovery() fails?",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2010-08-09T21:27:01.000+0000",
        "versions": [{
            "archived": true,
            "description": "Append/sync support for Hadoop 0.20",
            "id": "12315103",
            "name": "0.20-append",
            "released": false,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12315103"
        }],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HDFS-1337/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/HDFS-1337/watchers",
            "watchCount": 1
        },
        "workratio": -1
    },
    "id": "12471145",
    "key": "HDFS-1337",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/12471145"
}