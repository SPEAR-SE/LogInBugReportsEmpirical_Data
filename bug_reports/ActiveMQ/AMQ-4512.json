{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249"
            },
            "displayName": "Timothy Bish",
            "key": "tabish121",
            "name": "tabish121",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=tabish121",
            "timeZone": "America/Havana"
        },
        "components": [{
            "id": "12313892",
            "name": "Broker",
            "self": "https://issues.apache.org/jira/rest/api/2/component/12313892"
        }],
        "created": "2013-05-06T22:14:09.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Sam hendley",
            "key": "shendley",
            "name": "shendley",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=shendley",
            "timeZone": "Etc/UTC"
        },
        "customfield_10010": null,
        "customfield_12310041": null,
        "customfield_12310080": null,
        "customfield_12310220": "2013-05-07T13:35:00.218+0000",
        "customfield_12310222": "1_*:*_1_*:*_327608908_*|*_5_*:*_1_*:*_0",
        "customfield_12310250": null,
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "6.0",
        "customfield_12310420": "326673",
        "customfield_12310920": "327018",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i1kcvj:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "Wed Oct 14 16:14:42 UTC 2015",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "There is a race condition in MemoryUsage which makes it possible for it to be left in an inconsistent state and thereby hang any clients in waitForSpace().\n\nThe core issue is in the following block of code:\n{code:java}\n    public void decreaseUsage(long value) {\n        if (value == 0) {\n            return;\n        }\n        int percentUsage;\n        synchronized (usageMutex) {\n            usage -= value;\n            percentUsage = caclPercentUsage();\n        }\n        setPercentUsage(percentUsage);\n        if (parent != null) {\n            parent.decreaseUsage(value);\n        }\n    }\n{code}\n\nThe bug occurs when multiple threads are calling increment/decrement at same time. Since the field \"usage\" is protected with the usageMutex each writer/reader will see the correct and current value for usage and calculate the right value for percentUsage at that instant. \"setPercentUsage\" is also   protected by the same usageMutex so we resyncronize on usageMutex to set the percentUsage field as well. The issue is that threads may enter the setPercentUsage synchronized block in a different order than they entered the percentUsage \"calculating\" block. Since percentUsage is carried between the two blocks, a reordering of threads can allow the wrong final percentUsage value to be set. \n\nPossible threading (imagine usage starts at 0 and limit is 100).\nThread #1 - usage += 150; percentUsage = 150;\nThread #1 - suspended before called setPercentUsage\nThread #2 - usage -= 150; percentUsage = 0;\nThread #2 - setPercentUsage(0);\nThread #1 - resumed, can now call setPercentUsage\nThread #1 - setPercentUsage(150);\n\nFinal value = 150\n\nThis same pattern of synchronizing to calculate the percentUsage and then setting the value later is repeated in all of the Usage objects I looked at. My guess it was written this way to avoid holding locks while making calls out to \"untrusted code\" but it is a very dangerous way to do the calculations. The most surprising thing is the locks are still being explicitly held while calling fireEvent anyways.\n\nI have attached two screenshots taken using a debugger of two threads that have both been stalled for multiple minutes on \"waitForSpace\" trying to publish to the same queue. Notice they both have a \"usage\" of 0 but a \"percentUsage\" > 100, this should be impossible. To get the system into this state I was using JmsTemplate and a CachingConnectionFactory to publish on 8 threads and a single DefaultMessageListenerContainer who is pulling the messages off as fast as possible. The test publishes 100000 measurements and around ~75% of the time atleast a few producers end up stalled in waitForSpace() even though the queue is ready for more messages. I can also reproduce these results using JmsTemplate and PooledConnectionFactory so I don't believe it's an issue in the pooling implementations.",
        "duedate": null,
        "environment": null,
        "fixVersions": [{
            "archived": false,
            "id": "12323932",
            "name": "5.9.0",
            "releaseDate": "2013-10-21",
            "released": true,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12323932"
        }],
        "issuelinks": [],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "id": "3",
            "name": "Major",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011"
            },
            "id": "12311210",
            "key": "AMQ",
            "name": "ActiveMQ",
            "projectCategory": {
                "description": "ActiveMQ",
                "id": "11160",
                "name": "ActiveMQ",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/11160"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12311210"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Sam hendley",
            "key": "shendley",
            "name": "shendley",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=shendley",
            "timeZone": "Etc/UTC"
        },
        "resolution": {
            "description": "A fix for this issue is checked into the tree and tested.",
            "id": "1",
            "name": "Fixed",
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1"
        },
        "resolutiondate": "2013-05-10T17:14:18.000+0000",
        "status": {
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "id": "5",
            "name": "Resolved",
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "statusCategory": {
                "colorName": "green",
                "id": 3,
                "key": "done",
                "name": "Done",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
            }
        },
        "subtasks": [],
        "summary": "MemoryUsage waitForSpace in inconsistent state",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2015-10-14T16:14:42.000+0000",
        "versions": [
            {
                "archived": false,
                "description": "Next v5 maintenance release",
                "id": "12317974",
                "name": "5.6.0",
                "releaseDate": "2012-05-07",
                "released": true,
                "self": "https://issues.apache.org/jira/rest/api/2/version/12317974"
            },
            {
                "archived": false,
                "description": "Next v5 maintenance release",
                "id": "12321258",
                "name": "5.7.0",
                "releaseDate": "2012-10-08",
                "released": true,
                "self": "https://issues.apache.org/jira/rest/api/2/version/12321258"
            }
        ],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/AMQ-4512/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/AMQ-4512/watchers",
            "watchCount": 4
        },
        "workratio": -1
    },
    "id": "12646315",
    "key": "AMQ-4512",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/12646315"
}