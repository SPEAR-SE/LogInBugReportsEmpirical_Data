[Unit test for the failure., Fixed the issues in the provided test (transacted producers didn't have a session.commit) and ran against trunk, all tests pass.]