[If you commit after the close, the test will work as expected and the first consumer is shutdown., prefetch=0 works around this. but the problem is that a new transaction is created on the session by the second send, and the close is deferred till that commits (the close registers a synchroniztion if there is a transaction).
With prefetch=0, the consumer has no pending messages so the effect of the deferred close is invisible., So using preftech=0 is just a work-around. It should also work for any preftech value.
IMO, as long as the consumer has not acked any of the prefetched messages, it should not consider itself as being part of the transaction.
, fix in http://svn.apache.org/r1471673]