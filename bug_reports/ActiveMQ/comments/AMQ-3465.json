[I am experiencing similar issue as described in this JIRA bug report and in the nabble link., Fix and new unit test added to trunk., The patch, provided by Timothy Bish, seems to be incorrect. Here is declaration of ENDED_XA_TRANSACTION_CONTEXTS:

private final static ConcurrentHashMap<TransactionId, List<TransactionContext>> ENDED_XA_TRANSACTION_CONTEXTS = ...

So the type of map values is List<TransactionContext>. And here is the patched code:

public boolean isInXATransaction() {
    return (transactionId != null && transactionId.isXATransaction()) || (!ENDED_XA_TRANSACTION_CONTEXTS.isEmpty() && ENDED_XA_TRANSACTION_CONTEXTS.containsValue(this));
}

It is clear, the last condition ENDED_XA_TRANSACTION_CONTEXTS.containsValue(this) never holds just because the map contains lists of TransactionContext but not Transaction context itself., Fix applied in trunk.]