[I tested this against the 5.7 release and this is not happening, the code doesn't encode headers until after the CONNECTED frame is sent and the protocol version is set.  Reopen if you can provide a JUnit test case that reproduces this., Apologies, but my report of this was inaccurate and incomplete.

It only happens with: stomp+nio

, Looks like the fix for AMQ-3823 is setting the Stomp version to eagerly in the NIO case which is the problem.  , Fixed in trunk]