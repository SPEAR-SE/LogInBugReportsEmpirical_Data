[A solution might be to register a PooledSessionEventListener in XA synchronisation which does the ignore and xa flagging onSessionClosed., I think this issue was fixed in 5.9. Can you confirm it's an issue in the newer versions because or provide a test case because I'm not seeing the issue currently., Since this problem is not deterministic its quite hard to deliver a test case. But if you look at the code you can see that this problem does still exist in trunk code.
Look at XaConnectionPool line 106 where the close operation on the PooledSession object is invoked which returns itself back into the pool in line 152. But the Synchronization object of XaConnectionPool does still change values after that in line 107 and 108 while the pool object might be used again in another thread. So it is obvious that a collition can occured!, Any feedback on my comment?, Patch suggestion, Nice idea, patch looks good, applied to trunk. ]