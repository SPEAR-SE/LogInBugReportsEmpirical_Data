[For a test case, you may find something useful in org.apache.activemq.transport.failover.FailoverTransactionTest - a variant of a broker plugin used can kill off the broker before/after a prepare, Attaching junit test that illustrates the problem.

Note that if you uncomment xaRes.commit(), the message will not be redelivered and the test will succeed as expected.  However, if the xaRes is only prepared but not committed, the message is redelivered., fixed via https://issues.apache.org/jira/browse/AMQ-3305, link to issue that fixes]