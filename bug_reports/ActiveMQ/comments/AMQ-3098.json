[I also see the same issue on 5.4.2

Horace, Do you have a way to reproduce?, Hi, 

Another user had this same strack trace. He reproduced the issue by simulating by hot mounting / unmounting his NFS file system on which you have KahaDb datas. I don't have NFS handy to test with, however, his broker didn't shut down in this situation as he had an exceptionHandler configured to ignoreAllErrors. As such, the broker continued on but the database was gone / corrupt. A restart is required and a re-build of the indexes.  

I don't know if this helps you or not Loc, but I thought I'd post it. 

Susan, Hi Susan,

If you are saying restarting the AMQ fix this, yes it really does but this happens too often that we'd have to restart AMQ everyday but thanks for the point out anyways., In our case we can't restart AMQ, it just keeps failing with the same exception on start up. We have to rm -f * the kahDB message store in order to start it back up again. 

Does this exception mean that the journal is corrupted? Do you think that setting checkForCurrptJournalFiles may help, it says that it will attempt to recover them if they are corrupt., We are experience the same problem. I had to delete all KahaDB log files in order to get ActiveMQ to start consuming messages. We lost over 100K of messages. The activemq.log file is full of this:


2011-08-03 10:04:37,312 | ERROR | Failed to fill batch | org.apache.activemq.broker.region.cursors.AbstractStoreCursor | Queue:queue/productionEvents
java.io.IOException: Invalid location: 3276:20560465, : java.lang.NegativeArraySizeException
        at org.apache.kahadb.journal.DataFileAccessor.readRecord(DataFileAccessor.java:94)
        at org.apache.kahadb.journal.Journal.read(Journal.java:596)
        at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:786)
        at org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:956)
        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore$5.execute(KahaDBStore.java:494)
        at org.apache.kahadb.page.Transaction.execute(Transaction.java:728)
, The same problem happened to me. The most pity part is that activemq did not help to diagnose broken database and proceed to work like if the messages are simply enqueued w/o consumer. , can you try a current 5.5.1 release or 5.6-SNAPSHOT. There have been lots of improvements to kahaDB over the past months. , Database corruption in my case seems to be caused by lack of disk space. In some moment of time the disk was 100% full and activemq failed to dump sync db with disk., The http://activemq.apache.org/configurable-ioexception-handling.html should help in that case., No further reports on this one.  Lacks a test case or other notes on how to reproduce.  Much improvement in this area in 5.6-SNAPSHOT, recommend trying that out., This same problem was reported independently by a user of our software. This version of the software uses ActiveMQ 5.6.0:

https://projects.puppetlabs.com/issues/19066, Actually, my last comment was a lie. It was seen in ActiveMQ 5.5.1, not ActiveMQ 5.6.0., I am experience the same problem. Version is 5.7.0.  

 I had to delete the queue  in order to get ActiveMQ to start consuming messages.

2014-03-05 11:27:41,230 | ERROR | org.apache.activemq.broker.region.cursors.QueueStorePrefetch@19f0b0a6:queue.psu.product.update,batchResetNeeded=false,storeHasMessages=true,size=935106,cacheEnabled=false,maxBatchSize:200 - Failed to fill batch | org.apache.activemq.broker.region.cursors.AbstractStoreCursor | ActiveMQ BrokerService[slave] Task-176
java.io.IOException: Invalid location: 965:1286, : java.lang.NegativeArraySizeException
        at org.apache.kahadb.journal.DataFileAccessor.readRecord(DataFileAccessor.java:92)
        at org.apache.kahadb.journal.Journal.read(Journal.java:604)
        at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:879)
        at org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:1030)
        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore$4.execute(KahaDBStore.java:558)
        at org.apache.kahadb.page.Transaction.execute(Transaction.java:769)
        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.recoverNextMessages(KahaDBStore.java:547)
        at org.apache.activemq.store.ProxyMessageStore.recoverNextMessages(ProxyMessageStore.java:106)
        at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:97)
        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:274)
        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.reset(AbstractStoreCursor.java:110)
        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.reset(StoreQueueCursor.java:157)
        at org.apache.activemq.broker.region.Queue.doPageInForDispatch(Queue.java:1765)
        at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1993)
        at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1486)
        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)
        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)
        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)
        at java.lang.Thread.run(Thread.java:662)
2014-03-05 11:27:41,230 | ERROR | org.apache.activemq.broker.region.cursors.QueueStorePrefetch@19f0b0a6:queue.psu.product.update,batchResetNeeded=false,storeHasMessages=true,size=935106,cacheEnabled=false,maxBatchSize:200 - Failed to fill batch | org.apache.activemq.broker.region.cursors.AbstractStoreCursor | ActiveMQ BrokerService[slave] Task-176
java.lang.RuntimeException: java.io.IOException: Invalid location: 965:1286, : java.lang.NegativeArraySizeException
        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:277)
        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.reset(AbstractStoreCursor.java:110)
        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.reset(StoreQueueCursor.java:157)
        at org.apache.activemq.broker.region.Queue.doPageInForDispatch(Queue.java:1765)
        at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1993)
        at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1486)
        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129), We were seeing this with 5.8 and have upgraded to 5.9 and still experience the issue., can you provide some more information? Is it possible to reproduce?, Accidentally ran into this issue when a disk filled up and kahadb generated an IOException. The annoying part is that it is not able to recover. ActiveMQ version 5.9, We are also facing this issue with 5.9.0, Hi,

I am also facing the same issue, have any one find any solution of this without removing kahadb logs

BR]