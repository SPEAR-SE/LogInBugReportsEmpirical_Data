[your suggestions look bang on. Any chance you have something that would work as a unit test that you could submit with a patch?

There is an optimization in https://issues.apache.org/jira/browse/AMQ-5277 that will avoid this issue I think, but your suggestion is still valid., I've attached a diff file (the only reasonable thing I could generate after studying git tutorial 1/2 h ago ;) ) showing how I fixed my AMQ instance.
I've tested it on v5.9 and it works fine., variant of path applied with thanks in http://git-wip-us.apache.org/repos/asf/activemq/commit/ad770ea7]