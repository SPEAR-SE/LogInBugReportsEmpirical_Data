[[~tabish121],

I looked at this briefly and it seems like in the [onWebSocketClose|https://github.com/apache/activemq/blob/activemq-5.13.3/activemq-http/src/main/java/org/apache/activemq/transport/ws/jetty9/MQTTSocket.java#L81] method of MQTTSocket we should be checking if a disconnect frame has been received already prior to close and if not then call getProtocolConverter().onTransportError() which should take care of LWT.  Right now that method just sends a disconnect frame again so LWT will never work if the connection was just closed prior to receiving disconnect., Seems plausible, a unit test might be a good idea to try it out ;),     @Override
    public void onWebSocketClose(int statusCode, String reason) {
        LOG.debug("onWebSocketClose() - statusCode: {}, reason: {}", statusCode, reason);
        try {
            if (statusCode == StatusCode.NO_CLOSE) {
                getProtocolConverter().onTransportError();
            } else {
                getProtocolConverter().onMQTTCommand(new DISCONNECT().encode());
            }
        } catch (Exception e) {
            LOG.debug("Failed to close MQTT WebSocket cleanly", e);
        }
    }

may fixes the issue?, after some tests, it's not sufficient., Commit bd442a3388b0f127c8f8b9fad5e4888b77bb42c3 in activemq's branch refs/heads/master from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bd442a3 ]

https://issues.apache.org/jira/browse/AMQ-6343

On MQTT Websocket close, a LWT message will be properly sent if
configured and a disconnect packet was not received
, This should be fixed.  The LWT message will be sent if on websocket close a disconnect packet was never received., Commit fda982dccb12098a84e3de9cd951108be1a8167f in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=fda982d ]

https://issues.apache.org/jira/browse/AMQ-6343

On MQTT Websocket close, a LWT message will be properly sent if
configured and a disconnect packet was not received

(cherry picked from commit bd442a3388b0f127c8f8b9fad5e4888b77bb42c3)
]