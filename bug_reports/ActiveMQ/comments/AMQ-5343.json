[A unit test to reproduce this will help anyone that investigates it., I _think_ we hit something similar, see attached thread dump file (threaddump.13574.txt)

The background here is that we have a process that is a consuming client of ActiveMQ 5.10.0.  This process regularly shuts itself down and starts up (cleaning up some leaky resources from another area unrelated).  This application which processes several thousand items and then shutsdown, to be started again by an external process has worked really well for weeks in production handling thousands of messages, but today one of these consumers hung on the attempt to shutdown cleanly.

Given this shutdown happens in an orderly fashion, the message is processed, a certain count of messages processed is checked and if exceeded goes through the shutdown process, I can't see why this wouldn't just work, but perhaps there's a timing issue in there somewhere.]