[Commit b9f9f03829a65efa2956c347d2cafa41905313c6 in activemq's branch refs/heads/master from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b9f9f03 ]

https://issues.apache.org/jira/browse/AMQ-6256

Calling beforeMarshall on messages when they async stored before the
store task is run and before consumer dispatch to prevent two threads
from trying to mutate the message state at the same time.
, Commit dc3c5a719b47fc40b5affce8412390ead67ce8ef in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=dc3c5a7 ]

https://issues.apache.org/jira/browse/AMQ-6256

Calling beforeMarshall on messages when they async stored before the
store task is run and before consumer dispatch to prevent two threads
from trying to mutate the message state at the same time.

(cherry picked from commit b9f9f03829a65efa2956c347d2cafa41905313c6)
, afaik the format is not used by before marshall, I think beforeMarshall can done in Queue with an null format, just  before a call to asyncAdd.
there is a beforeMarshall in this way before stomp dispatch to the broker to ensure properties are accounted for.
see: https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blobdiff;f=activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/ProtocolConverter.java;h=b25860bf6895240c33a8643b6fcc731af126d32e;hp=8539b59ee046e54c5ec82c73edc6f591da0c9148;hb=57264bf;hpb=521c4fd8c31a88575f80659e9b84f016b22087ea, Thanks for pointing that out, i can move it to the Queue., Commit b9b98a45cee484b112dadeffa2d9a874c4ffe280 in activemq's branch refs/heads/master from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=b9b98a4 ]

https://issues.apache.org/jira/browse/AMQ-6256

Moving beforeMarshall call out of the store and into the actual
destination
, Commit 32913408a68ec92e3d202f5dcc3923d5c7d7588a in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=3291340 ]

https://issues.apache.org/jira/browse/AMQ-6256

Moving beforeMarshall call out of the store and into the actual
destination

(cherry picked from commit b9b98a45cee484b112dadeffa2d9a874c4ffe280)
, Commit 1ffac14f6ed3b2f2d30b5de1b759f16a29a0c099 in activemq's branch refs/heads/master from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1ffac14 ]

https://issues.apache.org/jira/browse/AMQ-6256

cleanup imports
, [~gtully],  This patch has the side effect that it ends up calling beforeMarshall for all stores, including the memory store.  I believe this is causing the tests failures in AMQ2103Test here: 

https://builds.apache.org/view/A-D/view/ActiveMQ/job/ActiveMQ-Java8/652/testReport/

I'm assuming we don't really want to marshall data for the memory store, so do you think we should move the beforeMarshall call back to the store implementations?

Edit: Looks like it caused this failure as well org.apache.activemq.usecases.ObjectMessageNotSerializableTest.testSendNotSerializeableObjectMessage, darn, yea, that is the only option. Your original fix is perfect then, just doing the work in the stores that actually do async bits.
For the memory store and pure invm dispatch, bypassing serialisation altogether is valid. Win for the test suite., Ok, sounds good, easy enough to revert back to the original fix :) , Commit 11622b3af32fe9518df06f026e6c0fb65de4aa26 in activemq's branch refs/heads/master from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=11622b3 ]

https://issues.apache.org/jira/browse/AMQ-6256

Moving beforeMarshall back to the store implementations because we don't
want all store implementations to marshall (such as memory store)

This reverts commit b9b98a45cee484b112dadeffa2d9a874c4ffe280.
, Commit 840583df090bdca6ef1a709d1a2e7701aaeda637 in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=840583d ]

https://issues.apache.org/jira/browse/AMQ-6256

Moving beforeMarshall back to the store implementations because we don't
want all store implementations to marshall (such as memory store)

This reverts commit 32913408a68ec92e3d202f5dcc3923d5c7d7588a.
]