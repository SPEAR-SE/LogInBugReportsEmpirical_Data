[Recommend you create a proper JUnit test case and a patch with your fix for use to review.  , patch for bug AMQ-4887, Still needs a unit test., unit test for bug AMQ-4887, This is a slightly modified version of the original patch.  Tim, can you review this?

I have also added a test, AMQ4887Test.java to activemq-unit-tests
, I'll review in a bit, The fix seems reasonable but I think there's still a problem here if the content is stored compressed.  If you simply rewrite the contents into the output stream and message compression is enabled you'd be writing compressed data with an output stream that's doing compression again so that's not good, plus you be adding new data onto already compressed content if you use any of the write methods so you are doubly corrupted.  , I'm also going to guess that the StreamMessage implementation suffers from the same problem and the test should be expanded to check that message too, as well as the compressed case.  , [~kearls] Updated the test case to show the other bits that are broken.  I patched the bytes message and started Stream Message.  Thought you might want to take a crack at addressing the compressed case in StreamMessage and seeing if there's anything else needed., Updated patch that fixes bytes message and the uncompressed case in stream message., Wrapped this one up as I was afraid I might be seeing this in some AMQP dispatch scenarios.  ]