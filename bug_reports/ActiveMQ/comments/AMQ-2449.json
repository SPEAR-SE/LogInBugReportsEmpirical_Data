[Patch w/unit test attached that should fix the problem (cut from trunk)

Also includes some cleanup fixes to the stomp unit tests., Fix applied in SVN revision 825008]