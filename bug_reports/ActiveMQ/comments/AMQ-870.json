[There's a comment in AMQ-776 ( https://issues.apache.org/activemq/browse/AMQ-776#action_36535 ) about this scenario too., I've tried the same test-case with 4.0.2 RC3, which fails too, but in a very different way. With 4.0.2 RC3 there is some other problem with the restart, which causes the test to hang instead of failing.
, Hi Jonas - this should be fixed in the latest - can you confirm ?, Ran the test case on trunk rev:  557391  and it passed. 

Just need to modify the test case a bit to remove the failover  option as it's no longer supported in the latest version. ]