[A test to demonstrate the problem and a proposed patch., thanks for the test and the patch. 
I wonder does your test work with the jdbc or kahadb store? If it does that would help validate the changes, It seems the patch is only for kaha store.
I use the jdbc store and have not found any solution yet.
So I have to give up using the message selector.

, Is there any plan to resolve this issue? This is a causing us problems too., please vote for this issue so we can gauge interest. I will try to get to this for 5.4, resolved in 967134 - patch was great, test case was great, thanks. completed the impl for JDBC and kahaDB]