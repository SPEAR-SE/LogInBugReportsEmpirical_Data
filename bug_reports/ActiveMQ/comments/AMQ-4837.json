[Attached the ActiveMQ configuration and the logs of the 3 nodes. 
WRK01 is first elected as Master, then WRK02, then WRK03 (fails).
, Note that the problem also occurs when the replication sync parameter is set to quorum_disk and quorum_mem.
, Looking into it..., I failed to reproduce using the procedure outlined.  I was testing on 3 Fedora Core 18 VMs.

I was pushing messages using the example in: examples/openwire/swissarmy
and running: ant producer -Durl='failover:(tcp://demo01:61616,tcp://demo02:61616,tcp://demo03:61616)' -Ddurable=true -Dtopic=false -Dmax=10

I was just browsing the queue using the new hawtio web console.  Not really drilling into each of the messages.

Guillaume, could you add more details on how you you've been reproducing.  How you adding the messages?  Perhaps the number and size of the messages makes a difference.
, Hi Hiram,
I was using the activemq web console to send messages (destination: default foo.bar, default content and Persistent option ticked), to view the queue summary and to display the list of messages.
I have performed a couple of tests using the swissarmy example. I cannot reproduce the issue with 10 messages. However I managed to reproduce the problem when sending 1 message at the time (other parameter similar to yours). I am using the default activemq UI to view the queue summary and looking the queue content - which triggers the error at step 7.
, Ok. thx. I was able to reproduce.. looking into the root cause now., unit test for this issue can be found at: 

https://github.com/apache/activemq/blob/trunk/activemq-leveldb-store/src/test/java/org/apache/activemq/leveldb/test/ReplicatedLevelDBBrokerTest.java

It was intermittently failing for me., Hi Guillaume,

I think I've fixed this issue now.  If you get a chance could you verify against the following build:
https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131031.171656-11-bin.tar.gz, Ah.. hold off.. I'm still seeing the issue.  Need better unit test., Hi Guillaume,

Ok. I think I got it this time.  Could you check this build for me?

https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131101.162431-14-bin.tar.gz, Hi Hiram, unfortunately I reproduced the issue with this build - using the army swiss example and sending 1 message at the time., Weird.  I can't reproduce anymore with the latest build.  Perhaps the build I linked to in the issue did not have the fix.  Here's a link to a fresh build:

https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131106.134045-17-bin.tar.gz

Could you double check again?, I, we have exectly the same error but in a non clustered environment.

We're using AMQ 5.9 with level db basic configuration.

We can reproduce it whis about 280 messages per second in a durable topic with one consumer.
The dispatched queue is around 0 to 150 messages.

The error occurs after 1h 50 min processing.

Erros :
2013-11-18 11:52:07,279 | INFO  | Stopping BrokerService[localhost] due to exception, java.io.IOException | org.apache.activemq.util.DefaultIOExceptionHandler | LevelDB IOException handler.
java.io.IOException
	at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:39)
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:543)
	at org.apache.activemq.leveldb.LevelDBClient.might_fail_using_index(LevelDBClient.scala:974)
	at org.apache.activemq.leveldb.LevelDBClient.collectionCursor(LevelDBClient.scala:1270)
	at org.apache.activemq.leveldb.LevelDBClient.queueCursor(LevelDBClient.scala:1194)
	at org.apache.activemq.leveldb.DBManager.cursorMessages(DBManager.scala:708)
	at org.apache.activemq.leveldb.LevelDBStore$LevelDBMessageStore.recover(LevelDBStore.scala:733)
	at org.apache.activemq.broker.region.Topic.doBrowse(Topic.java:588)
	at org.apache.activemq.broker.region.Topic.access$100(Topic.java:65)
	at org.apache.activemq.broker.region.Topic$6.run(Topic.java:721)
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)
	at java.util.TimerThread.mainLoop(Unknown Source)
	at java.util.TimerThread.run(Unknown Source)
Caused by: java.lang.NullPointerException
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1198)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1194)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1272)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1271)
	at org.apache.activemq.leveldb.LevelDBClient$RichDB.check$4(LevelDBClient.scala:315)
	at org.apache.activemq.leveldb.LevelDBClient$RichDB.cursorRange(LevelDBClient.scala:317)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply$mcV$sp(LevelDBClient.scala:1271)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)
	at org.apache.activemq.leveldb.LevelDBClient.usingIndex(LevelDBClient.scala:968)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$might_fail_using_index$1.apply(LevelDBClient.scala:974)
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:540)
	... 11 more
2013-11-18 11:52:07,308 | INFO  | Apache ActiveMQ 5.9.0 (localhost, ID:SERVER-50960-1384765393652-0:1) is shutting down | org.apache.activemq.broker.BrokerService | IOExceptionHandler: stopping BrokerService[localhost]
2013-11-18 11:52:07,370 | WARN  | Failed to browse Topic: CHANGE_TOPIC | org.apache.activemq.broker.region.Topic | ActiveMQ Broker[localhost] Scheduler
org.apache.activemq.broker.SuppressReplyException: ShutdownBrokerInitiated
	at org.apache.activemq.util.DefaultIOExceptionHandler.handle(DefaultIOExceptionHandler.java:134)
	at org.apache.activemq.broker.BrokerService.handleIOException(BrokerService.java:2526)
	at org.apache.activemq.leveldb.LevelDBClient$$anon$2.run(LevelDBClient.scala:521)
Caused by: java.io.IOException
	at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:39)
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:543)
	at org.apache.activemq.leveldb.LevelDBClient.might_fail_using_index(LevelDBClient.scala:974)
	at org.apache.activemq.leveldb.LevelDBClient.collectionCursor(LevelDBClient.scala:1270)
	at org.apache.activemq.leveldb.LevelDBClient.queueCursor(LevelDBClient.scala:1194)
	at org.apache.activemq.leveldb.DBManager.cursorMessages(DBManager.scala:708)
	at org.apache.activemq.leveldb.LevelDBStore$LevelDBMessageStore.recover(LevelDBStore.scala:733)
	at org.apache.activemq.broker.region.Topic.doBrowse(Topic.java:588)
	at org.apache.activemq.broker.region.Topic.access$100(Topic.java:65)
	at org.apache.activemq.broker.region.Topic$6.run(Topic.java:721)
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)
	at java.util.TimerThread.mainLoop(Unknown Source)
	at java.util.TimerThread.run(Unknown Source)
Caused by: java.lang.NullPointerException
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1198)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1194)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1272)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1$$anonfun$apply$mcV$sp$12.apply(LevelDBClient.scala:1271)
	at org.apache.activemq.leveldb.LevelDBClient$RichDB.check$4(LevelDBClient.scala:315)
	at org.apache.activemq.leveldb.LevelDBClient$RichDB.cursorRange(LevelDBClient.scala:317)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply$mcV$sp(LevelDBClient.scala:1271)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$collectionCursor$1.apply(LevelDBClient.scala:1271)
	at org.apache.activemq.leveldb.LevelDBClient.usingIndex(LevelDBClient.scala:968)
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$might_fail_using_index$1.apply(LevelDBClient.scala:974)
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:540)
	... 11 more
2013-11-18 11:52:07,470 | INFO  | Stopped LevelDB[C:\TEST\apache-activemq-5.9.0\bin\..\data\LevelDB] | org.apache.activemq.leveldb.LevelDBStore | LevelDB IOException handler.
2013-11-18 11:52:13,821 | INFO  | The connection to 'tcp://127.0.0.1:59574' is taking a long time to shutdown. | org.apache.activemq.broker.TransportConnection | IOExceptionHandler: stopping BrokerService[localhost]
2013-11-18 11:52:18,823 | INFO  | The connection to 'tcp://127.0.0.1:59574' is taking a long time to shutdown. | org.apache.activemq.broker.TransportConnection | IOExceptionHandler: stopping BrokerService[localhost]
2013-11-18 11:52:23,854 | INFO  | The connection to 'tcp://127.0.0.1:59574' is taking a long time to shutdown. | org.apache.activemq.broker.TransportConnection | IOExceptionHandler: stopping BrokerService[localhost]
, Tenzin,

Does it also happen with a fresh SNAPSHOT build?

http://repository.apache.org/service/local/artifact/maven/redirect?r=snapshots&g=org.apache.activemq&a=apache-activemq&v=5.10-SNAPSHOT&e=tar.gz&c=bin, I've reproduce one more time the error so i'm trying with the snapshot but i'm on Windows server so the snapshot that i'm testing is this one :
https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131115.231503-20-bin.zip

Thanks., Hi,
the broker stopped 3 times this night after about 6h50min, then 6h50 min then 50min.
The error sounds to be the saùme (except the line number in class) but the broker restart automaticly with the snapshot. 

2013-11-19 05:27:43,671 | INFO  | Stopping BrokerService[localhost] due to exception, java.io.IOException | org.apache.activemq.util.DefaultIOExceptionHandler | LevelDB IOException handler.
java.io.IOException
	at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:39)
	at org.apache.activemq.leveldb.LevelDBClient.might_fail(LevelDBClient.scala:554)
	at org.apache.activemq.leveldb.LevelDBClient.might_fail_using_index(LevelDBClient.scala:1021)
	at org.apache.activemq.leveldb.LevelDBClient.collectionCursor(LevelDBClient.scala:1320)
	at org.apache.activemq.leveldb.LevelDBClient.queueCursor(LevelDBClient.scala:1244)
	at org.apache.activemq.leveldb.DBManager.cursorMessages(DBManager.scala:708)
	at org.apache.activemq.leveldb.LevelDBStore$LevelDBMessageStore.recover(LevelDBStore.scala:747)
	at org.apache.activemq.broker.region.Topic.doBrowse(Topic.java:588)
	at org.apache.activemq.broker.region.Topic.access$100(Topic.java:65)
	at org.apache.activemq.broker.region.Topic$6.run(Topic.java:721)
	at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)
	at java.util.TimerThread.mainLoop(Unknown Source)
	at java.util.TimerThread.run(Unknown Source)
Caused by: java.lang.NullPointerException
	at org.apache.activemq.leveldb.LevelDBClient$$anonfun$queueCursor$1.apply(LevelDBClient.scala:1248)

It's not easy to reproduce. It's better with the snapshot but i can't say that no messages are lost with leveldb., Ok.. so right now it just seems like the master is rebooting due to an error that a new slave seems to recover from right?, I'm not in a clustered environment, so there is on one node (that's the difference with Guillaume)., I've try this night with AMQ 5.9 levelDb (no cluster) in case of 30 messages / s and there is no error or reboot (about 17h processing).

So the error appends only with a minimum of messages per second (200 or more)., Hiram, Sorry for the delay in testing the fix. I will try to come back to you at the beginning of next week., Hi,
some news ! my AMQ is processing 50 messages / s (1 producer/1 consumer, 1 persistent topic) since 3 days and it has failed 9 times, then reboot each time. 
The messages are not lost, but each time it failed, the producer is waiting and it's not the best for us.
The best should be to solve the problem.

The environment is NT and no cluster.
Maybe we could change the item title to "LevelDB corrupted in AMQ (Cluster or Not)" and the environment., Hi Tenzin,

Yeah if your setup is non-replicated, I'd open a new issue to track the problem since this issue was originally opened on a problem that only affected replicated setups.

Also it does not seem like the store gets 'corrupted' since you don't loose messages after a restart., Ok, sounds great, just give us the new issue number when it'll be done.
I'm agree to test new snapshot if you need.
Thanks., Hi, bad news...
After 12 errors and automatic reboot, AMQ seems to be very very slow and accept only one messages/second from the producer.
Performances are OK after a manual restart.

So, i stopped the AMQ and i had a lot of warning about "Timer already cancelled".
, https://issues.apache.org/jira/browse/AMQ-4882

is the unclustered version of this problem. I can reproduce this by 100% just by starting some client that processes and enqueues messages while starting/stopping AMQ. After some restarts AMQ won't start anymore and the log contains the exception posted by others in this issue., Hi Remo,

Thanks.  Tenzin, does AMQ-4882 seem like your issue?, Hi Hiram,
the stack is the same, but the environment and the test procedure are not the same.

I can reproduce it in a NON clustered/replicated environment.
The test procedure is easy : i send about 200 messages / second in a persiatant durable TOPIC. Messages are consume by only one consumer on real time.
A few time per day, AMQ FAILED with the same error as i ever posted (the same as Remo) and REBOOT automaticly (AMQ 5.9.0 FAILED and only try to stop).

My second problem is that after maybe 10 automatic reboot (after failure), AMQ is very slow and accept only a few messages per second from the producer., Tenzin, how big are the messages and are you using transactions?, Not shure, but i can remember that the average was probably about 4 000 bytes in my use case., Tenzin, since your issue seems different I opened a new issue under AMQ-4917.  It seems specifically related to durable subs., Hiram, I can confirm that the problem raised in this ticket is resolved in the most recent build I could pick - apache-activemq-5.10-20131214.063224-32-bin.zip . 
Thanks for this. Guillaume
, is this resolved?, Marking issue as resolved since the fix was confirmed by Guillaume. Thx!]