[Unit test that demonstrates the deadlock.  Since the test is based on a race condition, it is unlikely to fail unless TopicSubscription.acknowledge(...) is artifically delayed (see comments in ticket and attached TopicSubscription.java), Includes some logging statements on TopicSubscription.add and an artificial delay on TopicSubscription.acknowledge, This is the output I get when I run the test case with the delayed TopicSubscription:

2012-10-26 14:53:24,868 [main           ] - INFO  AutoFailTestSupport            - Starting auto fail thread...
2012-10-26 14:53:24,869 [main           ] - INFO  AutoFailTestSupport            - Starting auto fail thread...
2012-10-26 14:53:25,264 [main           ] - INFO  BrokerService                  - Using Persistence Adapter: MemoryPersistenceAdapter
2012-10-26 14:53:25,285 [JMX connector  ] - INFO  ManagementContext              - JMX consoles can connect to service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi
2012-10-26 14:53:25,332 [main           ] - INFO  BrokerService                  - Apache ActiveMQ ${project.version} (broker2, ID:schow-PC-55149-1351288404982-2:1) is starting
2012-10-26 14:53:25,341 [main           ] - INFO  TransportConnector             - Connector vm://broker2 Started
2012-10-26 14:53:25,343 [main           ] - INFO  BrokerService                  - Apache ActiveMQ ${project.version} (broker2, ID:schow-PC-55149-1351288404982-2:1) started
2012-10-26 14:53:25,343 [main           ] - INFO  BrokerService                  - For help or more information please see: http://activemq.apache.org
2012-10-26 14:53:25,361 [main           ] - INFO  BrokerService                  - Using Persistence Adapter: MemoryPersistenceAdapter
2012-10-26 14:53:25,362 [main           ] - INFO  BrokerService                  - Apache ActiveMQ ${project.version} (broker1, ID:schow-PC-55149-1351288404982-2:2) is starting
2012-10-26 14:53:25,363 [main           ] - INFO  TransportConnector             - Connector vm://broker1 Started
2012-10-26 14:53:25,363 [main           ] - INFO  BrokerService                  - Apache ActiveMQ ${project.version} (broker1, ID:schow-PC-55149-1351288404982-2:2) started
2012-10-26 14:53:25,363 [main           ] - INFO  BrokerService                  - For help or more information please see: http://activemq.apache.org
2012-10-26 14:53:25,365 [JMX connector  ] - WARN  ManagementContext              - Failed to start jmx connector: Cannot bind to URL [rmi://localhost:1099/jmxrmi]: javax.naming.NameAlreadyBoundException: jmxrmi [Root exception is java.rmi.AlreadyBoundException: jmxrmi]. Will restart management to re-create jmx connector, trying to remedy this issue.
2012-10-26 14:53:30,381 [main           ] - INFO  NetworkConnector               - Network Connector DiscoveryNetworkConnector:to-broker2:BrokerService[broker1] Started
2012-10-26 14:53:30,382 [main           ] - INFO  NetworkConnector               - Network Connector DiscoveryNetworkConnector:to-broker1:BrokerService[broker2] Started
2012-10-26 14:53:30,382 [ActiveMQ Task-1] - INFO  DiscoveryNetworkConnector      - Establishing network connection from vm://broker1?network=true to vm://broker2
2012-10-26 14:53:30,382 [ActiveMQ Task-1] - INFO  DiscoveryNetworkConnector      - Establishing network connection from vm://broker2?network=true to vm://broker1
2012-10-26 14:53:30,463 [=vm://broker2#4] - INFO  DemandForwardingBridgeSupport  - Network connection between vm://broker2#4 and vm://broker1#1(broker1) has been established.
2012-10-26 14:53:30,464 [=vm://broker1#6] - INFO  DemandForwardingBridgeSupport  - Network connection between vm://broker1#6 and vm://broker2#0(broker2) has been established.
2012-10-26 14:53:31,384 [main           ] - INFO  JmsMultipleBrokersTestSupport  - found bridge[org.apache.activemq.network.DemandForwardingBridge@4155b] to broker1 on broker :broker2
2012-10-26 14:53:31,384 [main           ] - INFO  JmsMultipleBrokersTestSupport  - found bridge[org.apache.activemq.network.DemandForwardingBridge@1615ae] to broker2 on broker :broker1
2012-10-26 14:53:32,017 [m://broker2#2-2] - INFO  TopicSubscription              - Acknowledge subscription to ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:32,024 [m://broker1#3-2] - INFO  TopicSubscription              - Acknowledge subscription to ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,018 [m://broker2#2-2] - INFO  TopicSubscription              - Acknowledge subscription to ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,020 [m://broker1#7-1] - INFO  TopicSubscription              - TopicSubscription: consumer=ID:schow-PC-55149-1351288404982-5:1:1:1, destinations=1, dispatched=1, delivered=0, matched=0, discarded=0: Pending message cursor [org.apache.activemq.broker.region.cursors.VMPendingMessageCursor@1071445] is full, temp usage (0%) or memory usage (111588%) limit reached, blocking message add() pending the release of resources.
2012-10-26 14:53:33,020 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,040 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,060 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,080 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,100 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,120 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,140 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,160 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,180 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,200 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,220 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,240 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,260 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,280 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,300 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,320 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,340 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,360 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,380 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,400 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,420 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,440 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,460 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,480 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,500 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,520 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,540 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,560 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,580 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,600 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue
2012-10-26 14:53:33,620 [m://broker1#7-1] - WARN  TopicSubscription              - Waiting for space to add to subscription ActiveMQ.Advisory.Consumer.Queue.test.queue

The "Waiting for space..." messages are from the thread deadlocking the bridge.]