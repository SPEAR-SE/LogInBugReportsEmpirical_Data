[Hi

I have found almost exactly the same  deadlock it happens when a client sends messages quickly and gets their responses almost immediately. I'm using ActiveMQ 5.1.0
I get this dump:

INFO   | jvm 1    | 2008/08/08 17:38:45 | Found one Java-level deadlock:
INFO   | jvm 1    | 2008/08/08 17:38:45 | =============================
INFO   | jvm 1    | 2008/08/08 17:38:45 | "ActiveMQ Connection Dispatcher: /127.0.0.1:43864":
INFO   | jvm 1    | 2008/08/08 17:38:45 |   waiting to lock monitor 0x0a66d3e4 (object 0xb2635ba8, a java.lang.Object),
INFO   | jvm 1    | 2008/08/08 17:38:45 |   which is held by "ActiveMQ Transport: tcp:///127.0.0.1:43864"
INFO   | jvm 1    | 2008/08/08 17:38:45 | "ActiveMQ Transport: tcp:///127.0.0.1:43864":
INFO   | jvm 1    | 2008/08/08 17:38:45 |   waiting to lock monitor 0x0a480f84 (object 0xb2635bc8, a java.lang.Object),
INFO   | jvm 1    | 2008/08/08 17:38:45 |   which is held by "ActiveMQ Connection Dispatcher: /127.0.0.1:43864"
INFO   | jvm 1    | 2008/08/08 17:38:45 |
INFO   | jvm 1    | 2008/08/08 17:38:45 | Java stack information for the threads listed above:
INFO   | jvm 1    | 2008/08/08 17:38:45 | ===================================================
INFO   | jvm 1    | 2008/08/08 17:38:45 | "ActiveMQ Connection Dispatcher: /127.0.0.1:43864":
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:80)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       - waiting to lock <0xb2635ba8> (a java.lang.Object)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.StompSubscription.onMessageDispatch(StompSubscription.java:71)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.ProtocolConverter.onActiveMQCommad(ProtocolConverter.java:552)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.StompTransportFilter.oneway(StompTransportFilter.java:59)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       - locked <0xb2635bc8> (a java.lang.Object)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1228)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:816)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:853)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)
INFO   | jvm 1    | 2008/08/08 17:38:45 | "ActiveMQ Transport: tcp:///127.0.0.1:43864":
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       - waiting to lock <0xb2635bc8> (a java.lang.Object)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1228)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:816)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.broker.TransportConnection.dispatchSync(TransportConnection.java:775)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:183)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:80)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       - locked <0xb2635ba8> (a java.lang.Object)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.ProtocolConverter.sendToActiveMQ(ProtocolConverter.java:134)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.ProtocolConverter.onStompSend(ProtocolConverter.java:245)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommad(ProtocolConverter.java:172)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:70)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:196)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:183)
INFO   | jvm 1    | 2008/08/08 17:38:45 |       at java.lang.Thread.run(Thread.java:619)
INFO   | jvm 1    | 2008/08/08 17:38:45 |
INFO   | jvm 1    | 2008/08/08 17:38:45 | Found 1 deadlock.
INFO   | jvm 1    | 2008/08/08 17:38:45 |
INFO   | jvm 1    | 2008/08/08 17:38:45 | Heap
INFO   | jvm 1    | 2008/08/08 17:38:45 |  PSYoungGen      total 80448K, used 22996K [0xadca0000, 0xb42c0000, 0xb4e60000)
INFO   | jvm 1    | 2008/08/08 17:38:45 |   eden space 74880K, 24% used [0xadca0000,0xaee95950,0xb25c0000)
INFO   | jvm 1    | 2008/08/08 17:38:45 |   from space 5568K, 82% used [0xb25c0000,0xb2a3f7b0,0xb2b30000)
INFO   | jvm 1    | 2008/08/08 17:38:45 |   to   space 6144K, 0% used [0xb3cc0000,0xb3cc0000,0xb42c0000)
INFO   | jvm 1    | 2008/08/08 17:38:45 |  PSOldGen        total 18368K, used 9935K [0x74e60000, 0x76050000, 0xadca0000)
INFO   | jvm 1    | 2008/08/08 17:38:45 |   object space 18368K, 54% used [0x74e60000,0x75813fe0,0x76050000)
INFO   | jvm 1    | 2008/08/08 17:38:45 |  PSPermGen       total 54656K, used 33288K [0x70e60000, 0x743c0000, 0x74e60000)
, I can confirm that this bug reappears on AMQ 5.1.0. It appears when one thread acquires MutexTransport.oneway which acquires writeMutex and then StompTransportFilter.sendtToActiveMQ which acquires sendToActiveMQMutex, this happens when sending an acknowledgment in AUTO_ACK mode. 

At the same time other thread sends a message which first calls StompTransportFilter.sendToActiveMQ  which acquires sendToActiveMQMutex. This will inturn call MutexTransport,oneway and will produce a deadlock.

, Fixed by SVN revision 698103]