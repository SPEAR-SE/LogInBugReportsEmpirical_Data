[Are you mixing old versions of clients with newer broker versions ?, Yes. We have a very large environment with > 200 applications where we are not in the situation to be able to update client and broker setups always together (all openwire).

According to Hiram this mixing should be ok and from my understanding the openwire protocol should at least make sure the communication is fine. But exactly here is the point where it breaks.
As  I wrote, we're still trying to find out why the broker reads something buggy from the wire from the client.

Did I mention that the client and broker come into a CON/DISCON loop ? The client-side failover receives a invalid magic back and closes the connection, and reconnects, and so on ....


The workaround of course is to remove this option, which I strongly consider. Independently from this, the presented code should be looked at to prevent this allocation. What do you think?


, We are having similar issues as described above.  The clients are running the 5.10 library and the broker is also 5.10.  We see the client subscriber reconnecting every 30 seconds.  The difference is that we have the default setting for tightEncodingEnabled=true.  As a test we set this to false on our client and the reconnecting issue went away.  Our concern now is that we will experience the OutOfMemory issue as described above.  It would be great if we could get some guidance on this issue.  , In case this is of interest for you: I have removed this option from the URL and was able to upgrade slowly the brokers. 
I haven't really found a solution for this problem. , Broker version 5.10.0
Client version 5.10.0

activemq.xml:- 
 <transportConnector  uri="nio://localhost:61616?keepAlive=true&amp;wireFormat.maxFrameSize=104857600"/> 

Client broker url:- 
 failover:(nio:// 127.0.0.1:61616?keepAlive=true&wireFormat.maxFrameSize=104857600)?jms.blobTransferPolicy.defaultUploadUrl=http://127.0.0.1:8161/fileserver/&initialReconnectDelay=10000&useExponentialBackOff=false&randomize=false

I have the above setting and experiencing following error:-
nio protocol:-
---------------
2014-12-29 11:52:43,145 | DEBUG | Sending: WireFormatInfo { version=10, properties={MaxFrameSize=9223372036854775807, CacheSize=1024, CacheEnabled=true, SizePrefixDisabled=false, MaxInactivityDurationInitalDelay=10000, TcpNoDelayEnabled=true, MaxInactivityDuration=30000, TightEncodingEnabled=true, StackTraceEnabled=true}, magic=[A,c,t,i,v,e,M,Q]} | org.apache.activemq.transport.WireFormatNegotiator | ActiveMQ BrokerService[localhost] Task-4
2014-12-29 11:52:43,591 | DEBUG | Transport Connection to: tcp://127.0.0.1:51048 failed: java.io.IOException: Java heap space | org.apache.activemq.broker.TransportConnection.Transport | ActiveMQ NIO Worker 5
java.io.IOException: Java heap space
        at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:39)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.transport.nio.NIOTransport.serviceRead(NIOTransport.java:151)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.transport.nio.NIOTransport$1.onSelect(NIOTransport.java:69)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.transport.nio.SelectorSelection.onSelect(SelectorSelection.java:94)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.transport.nio.SelectorWorker$1.run(SelectorWorker.java:119)[activemq-client-5.10.0.jar:5.10.0]
        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)[:1.7.0_40]
        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)[:1.7.0_40]
        at java.lang.Thread.run(Thread.java:724)[:1.7.0_40]
2014-12-29 11:52:43,592 | DEBUG | Unregistering MBean org.apache.activemq:type=Broker,brokerName=localhost,connector=clientConnectors,connectorName=nio_//localhost_61616&qe;transport.keepAlive&amp;true&transport.wireFormat.maxFrameSize&amp;104857600,connectionViewType=remoteAddress,connectionName=tcp_//127.0.0.1_51048 | org.apache.activemq.broker.jmx.ManagementContext | ActiveMQ NIO Worker 5
2014-12-29 11:52:43,605 | DEBUG | Stopping connection: tcp://127.0.0.1:51048 | org.apache.activemq.broker.TransportConnection | ActiveMQ BrokerService[localhost] Task-5
2014-12-29 11:52:43,609 | DEBUG | Stopping transport tcp:///127.0.0.1:51048@61616 | org.apache.activemq.transport.tcp.TcpTransport | ActiveMQ BrokerService[localhost] Task-5
2014-12-29 11:52:43,609 | DEBUG | Initialized TaskRunnerFactory[ActiveMQ Task] using ExecutorService: null | org.apache.activemq.thread.TaskRunnerFactory | ActiveMQ BrokerService[localhost] Task-5
2014-12-29 11:52:43,614 | DEBUG | Closed socket Socket[unconnected] | org.apache.activemq.transport.tcp.TcpTransport | ActiveMQ Task-1
2014-12-29 11:52:43,614 | DEBUG | Stopped transport: null | org.apache.activemq.broker.TransportConnection | ActiveMQ BrokerService[localhost] Task-5
2014-12-29 11:52:43,614 | DEBUG | Connection Stopped: null | org.apache.activemq.broker.TransportConnection | ActiveMQ BrokerService[localhost] Task-5

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

With tcp protocol:-
---------------------
ityDurationInitalDelay=10000, TcpNoDelayEnabled=true, MaxInactivityDuration=30000, TightEncodingEnabled=true, StackTraceEnabled=true}, magic=[A,c,t,i,v,e,M,Q]} | org.apache.activemq.transport.WireFormatNegotiator | ActiveMQ BrokerService[localhost] Task-8
2014-12-29 11:22:42,797 | DEBUG | Transport Connection to: tcp://127.0.0.1:39382 failed: java.io.IOException: Unknown data type: 13 | org.apache.activemq.broker.TransportConnection.Transport | ActiveMQ Transport: tcp:///127.0.0.1:39382@61616
java.io.IOException: Unknown data type: 13
        at org.apache.activemq.openwire.OpenWireFormat.looseUnmarshalNestedObject(OpenWireFormat.java:460)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.openwire.v10.BaseDataStreamMarshaller.looseUnmarsalNestedObject(BaseDataStreamMarshaller.java:466)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.openwire.v10.DataResponseMarshaller.looseUnmarshal(DataResponseMarshaller.java:113)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.openwire.OpenWireFormat.doUnmarshal(OpenWireFormat.java:356)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.openwire.OpenWireFormat.unmarshal(OpenWireFormat.java:268)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.transport.tcp.TcpTransport.readCommand(TcpTransport.java:221)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:213)[activemq-client-5.10.0.jar:5.10.0]
        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)[activemq-client-5.10.0.jar:5.10.0]
        at java.lang.Thread.run(Thread.java:724)[:1.7.0_40]
2014-12-29 11:22:42,799 | DEBUG | Unregistering MBean org.apache.activemq:type=Broker,brokerName=localhost,connector=clientConnectors,connectorName=tcp_//localhost_61616&qe;transport.keepAlive&amp;true&transport.wireFormat.maxFrameSize&amp;104857600,connectionViewType=remoteAddress,connectionName=tcp_//127.0.0.1_39382 | org.apache.activemq.broker.jmx.ManagementContext | ActiveMQ Transport: tcp:///127.0.0.1:39382@61616
2014-12-29 11:22:42,804 | DEBUG | Stopping connection: tcp://127.0.0.1:39382 | org.apache.activemq.broker.TransportConnection | ActiveMQ BrokerService[localhost] Task-9
2014-12-29 11:22:42,805 | DEBUG | Stopping transport tcp:///127.0.0.1:39382@61616 | org.apache.activemq.transport.tcp.TcpTransport | ActiveMQ BrokerService[localhost] Task-9
2014-12-29 11:22:42,805 | DEBUG | Initialized TaskRunnerFactory[ActiveMQ Task] using ExecutorService: null | org.apache.activemq.thread.TaskRunnerFactory | ActiveMQ BrokerService[localhost] Task-9
2014-12-29 11:22:42,807 | DEBUG | Closed socket Socket[addr=/127.0.0.1,port=39382,localport=61616] | org.apache.activemq.transport.tcp.TcpTransport | ActiveMQ Task-1
2014-12-29 11:22:42,808 | DEBUG | Stopped transport: tcp://127.0.0.1:39382 | org.apache.activemq.broker.TransportConnection | ActiveMQ BrokerService[localhost] Task-9
2014-12-29 11:22:42,809 | DEBUG | Connection Stopped: tcp://127.0.0.1:39382 | org.apache.activemq.broker.TransportConnection | ActiveMQ BrokerService[localhost] Task-9, Btw I can see that you are victim of a different bug AMQ-6248. 
In the original description there is log message:
{{ActiveMQ Transport: tcp:///*123.123.123.123*:60156@61616] DEBUG Transport  Transport Connection to: tcp://*124.124.124.124*:60156 failed}}
Notice that failure from one transport actually causes failure of another transport. This is exactly what AMQ-6248 is about.
The problem with memory can be related or can be completely orthogonal..., Would need some tests that can demonstrate that there is an issue.  One recent fix in AMQ-6248 adds some additional stability to failover bits.  ]