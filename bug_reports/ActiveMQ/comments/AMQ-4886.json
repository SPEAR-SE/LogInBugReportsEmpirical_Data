[I see a scenario where the broker fails to stop and hence is not restarted. the problem lies in leveldb deadlock in stop.
waiting on the executor completion with in the sync block stopps the inprogress tasks from completing. the wait must be outside the sync.
Thread dump is  {code}
Send blocked Thread[Timer-0,5,main]
     sun.misc.Unsafe.park(Native Method)
     java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:196)
     java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2025)
     java.util.concurrent.ThreadPoolExecutor.awaitTermination(ThreadPoolExecutor.java:1261)
     org.apache.activemq.leveldb.LevelDBClient.stop(LevelDBClient.scala:985)
     org.apache.activemq.leveldb.DBManager.stop(DBManager.scala:640)
     org.apache.activemq.leveldb.LevelDBStore.doStop(LevelDBStore.scala:276)
     org.apache.activemq.util.ServiceSupport.stop(ServiceSupport.java:71)
     org.apache.activemq.broker.TransactionBroker.stop(TransactionBroker.java:197)
     org.apache.activemq.broker.BrokerService$5.stop(BrokerService.java:2169)
     org.apache.activemq.util.ServiceStopper.stop(ServiceStopper.java:41)
     org.apache.activemq.broker.BrokerService.stop(BrokerService.java:762)
     org.apache.activemq.bugs.AMQ2149Test$1RestartTask.run(AMQ2149Test.java:467)
     java.util.TimerThread.mainLoop(Timer.java:512)
     java.util.TimerThread.run(Timer.java:462)
Send blocked Thread[Thread-14,5,main]
     org.apache.activemq.leveldb.LevelDBClient.wal_append_position(LevelDBClient.scala:967)
     org.apache.activemq.leveldb.LevelDBClient.nextIndexSnapshotPos(LevelDBClient.scala:1052)
     org.apache.activemq.leveldb.LevelDBClient.copyDirtyIndexToSnapshot(LevelDBClient.scala:1055)
     org.apache.activemq.leveldb.LevelDBClient.snapshotIndex(LevelDBClient.scala:1098)
     org.apache.activemq.leveldb.LevelDBClient$$anonfun$post_log_rotate$1.apply$mcV$sp(LevelDBClient.scala:643)
     org.fusesource.hawtdispatch.package$$anon$4.run(hawtdispatch.scala:357)
     java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)
     java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)
     java.lang.Thread.run(Thread.java:695)
{code}, the deadlock on shutdown is resolved in http://git-wip-us.apache.org/repos/asf/activemq/commit/cb6941ee
lets see how this fares before closing - to ensure there are no other issues., LevelDB has been deprecated and is no longer supported.]