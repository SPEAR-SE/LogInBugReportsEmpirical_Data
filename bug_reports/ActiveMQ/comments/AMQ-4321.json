[Added patches to add unit test and bug fix., Something about that code was bothering me last time, looks like you found it.  I think we can just move the call to data.remaining() to the end of the while instead of have it in two places and be done with it.  , Fixed in trunk, thanks!]