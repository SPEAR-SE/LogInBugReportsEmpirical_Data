[looks like the inner if needs to be pulled up to the same level as the outer if., Fix applied along with new tests for this case.]