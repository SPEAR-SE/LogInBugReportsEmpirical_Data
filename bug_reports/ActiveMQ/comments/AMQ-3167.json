[fix in r1064660

URL: http://svn.apache.org/viewvc?rev=1064660&view=rev, Test use case which reproduces the problem consistently by using a small memory limit and short time delay between production and consumption.

A license header as been included; feel free to replace it as-needed., In the process of creating a bug report for the test case attached above, this bug report appeared to capture the problem.  Trying to backport this fix to 5.4.2, there appears to be a number of changes on which this patch depends.  Any guidance on a shorter workaround until we can upgrade to 5.5 would be appreciated.

The test case attached represents a use pattern we need to support, but has been narrowed down to detect a lost message in the timeframe it takes to trigger this issue., Patch against 5.4.2 that resolves this issue, created from a subset of the changes made on the trunk for this bug report., committed your test case so we can protect your use case it into the future. thanks.]