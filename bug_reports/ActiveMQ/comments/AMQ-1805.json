[From the above 5.1 source code, it seems like allocateLocation should actually make sure that there is enough disk space for the particular message. However, it actually only create the File handle without actually allocating any disk space So to fix this problem, we added

nextWriteFile.closeRandomAccessFile(nextWriteFile.openRandomAccessFile(true));

in the AsyncDataManager.allocateLocation method to try and pre allocate the disk space. We believe that this will not have much impact on the performance as data file is 32MB default, but please feel free to advice otherwise as this is our first time looking at ActiveMQ source code. , The patch for InactivityMonitor.java  provided by Tom Vijlbrief seems to be missing in ActiveMQ 5.1, which causes a thread leak when the client does not close the connection properly., Fixed by SVN revision 669519]