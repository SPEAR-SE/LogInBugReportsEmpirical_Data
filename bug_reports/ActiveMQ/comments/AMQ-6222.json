[Commit 75990ef14a092b629bf8d2127bc4786e51b31684 in activemq's branch refs/heads/master from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=75990ef ]

https://issues.apache.org/jira/browse/AMQ-6222

Moving clearedMarshalledState execution to the async listener on an
async add to the message store.  This is necessary to make sure this
logic doens't execute until after the message is marshalled for the
store.
, Commit 7f5c09f2d77c77f87a47fb738870c5ee5bc78c27 in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7f5c09f ]

https://issues.apache.org/jira/browse/AMQ-6222

Moving clearedMarshalledState execution to the async listener on an
async add to the message store.  This is necessary to make sure this
logic doens't execute until after the message is marshalled for the
store.

(cherry picked from commit 75990ef14a092b629bf8d2127bc4786e51b31684)
, [~cshannon] I think this is another candidate for revert following
https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blobdiff;f=activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java;h=9540a9336da22f0a63f01d21404e49cec69db32c;hp=786640e8b7723b08c8f9074bbdf1d58a3d11bcca;hb=3291340;hpb=dc3c5a719b47fc40b5affce8412390ead67ce8ef

the beforeMarshal is now always called before the async call.

https://issues.apache.org/jira/browse/AMQ-6256, Agreed, this should no longer be needed anymore so I will back out the change to Queue., Commit 9c8bd3360faf89c8fb054b02040458027782f48f in activemq's branch refs/heads/master from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9c8bd33 ]

https://issues.apache.org/jira/browse/AMQ-6222

Reverting the change to move clearMarshalledState into the callback
listener as beforeMarshall is now called before the async message add

Revert 75990ef14a092b629bf8d2127bc4786e51b31684
, Commit 9d545cf11f2ed999d68da7b5a16e46adee095a08 in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9d545cf ]

https://issues.apache.org/jira/browse/AMQ-6222

Reverting the change to move clearMarshalledState into the callback
listener as beforeMarshall is now called before the async message add

Revert 7f5c09f2d77c77f87a47fb738870c5ee5bc78c27
]