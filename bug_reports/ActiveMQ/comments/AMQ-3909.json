[Fixed and tests added in trunk]