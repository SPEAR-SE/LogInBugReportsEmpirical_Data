[The complete stack :

{noformat}
2016-04-28 11:13:48,457 | ERROR | ctivemq.server]) | configadmin                      | 7 - org.apache.felix.configadmin - 1.8.8 | [org.osgi.service.cm.ManagedServiceFactory, id=170, bundle=96/mvn:org.apache.activemq/activemq-osgi/5.13.2]: Updating configuration org.apache.activemq.server.45b6e092-14bf-4c6a-bb0e-0574f812ac52 caused a problem: Cannot start the broker
org.osgi.service.cm.ConfigurationException: null : Cannot start the broker
	at org.apache.activemq.osgi.ActiveMQServiceFactory.updated(ActiveMQServiceFactory.java:120)[96:org.apache.activemq.activemq-osgi:5.13.2]
	at org.apache.felix.cm.impl.helper.ManagedServiceFactoryTracker.updated(ManagedServiceFactoryTracker.java:159)[7:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.helper.ManagedServiceFactoryTracker.provideConfiguration(ManagedServiceFactoryTracker.java:93)[7:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.ConfigurationManager$ManagedServiceFactoryUpdate.provide(ConfigurationManager.java:1602)[7:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.ConfigurationManager$ManagedServiceFactoryUpdate.run(ConfigurationManager.java:1545)[7:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.UpdateThread.run0(UpdateThread.java:143)[7:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:110)[7:org.apache.felix.configadmin:1.8.8]
	at java.lang.Thread.run(Thread.java:745)[:1.8.0_92]
Caused by: org.springframework.beans.factory.BeanDefinitionStoreException: Unexpected exception parsing XML document from OSGi resource[file:/home/acs/softs/apache-karaf-4.0.5/etc/activemq.xml|bnd.id=96|bnd.sym=org.apache.activemq.activemq-osgi]; nested exception is org.springframework.beans.FatalBeanException: NamespaceHandler class [org.apache.xbean.spring.context.v2.XBeanNamespaceHandler] for namespace [http://activemq.apache.org/schema/core] not found; nested exception is java.lang.ClassNotFoundException: org.apache.xbean.spring.context.v2.XBeanNamespaceHandler not found from bundle [org.apache.activemq.activemq-osgi]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadBeanDefinitions(XmlBeanDefinitionReader.java:413)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader.java:335)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader.java:303)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:174)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:209)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:180)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.osgi.context.support.OsgiBundleXmlApplicationContext.loadBeanDefinitions(OsgiBundleXmlApplicationContext.java:164)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.osgi.context.support.OsgiBundleXmlApplicationContext.loadBeanDefinitions(OsgiBundleXmlApplicationContext.java:136)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.context.support.AbstractRefreshableApplicationContext.refreshBeanFactory(AbstractRefreshableApplicationContext.java:130)[120:org.apache.servicemix.bundles.spring-context:3.2.14.RELEASE_1]
	at org.springframework.context.support.AbstractApplicationContext.obtainFreshBeanFactory(AbstractApplicationContext.java:539)[120:org.apache.servicemix.bundles.spring-context:3.2.14.RELEASE_1]
	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:451)[120:org.apache.servicemix.bundles.spring-context:3.2.14.RELEASE_1]
	at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext.access$301(AbstractDelegatedExecutionApplicationContext.java:69)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext$1.run(AbstractDelegatedExecutionApplicationContext.java:186)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.osgi.util.internal.PrivilegedUtils.executeWithCustomTCCL(PrivilegedUtils.java:85)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext.normalRefresh(AbstractDelegatedExecutionApplicationContext.java:182)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext$NoDependenciesWaitRefreshExecutor.refresh(AbstractDelegatedExecutionApplicationContext.java:89)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.osgi.context.support.AbstractDelegatedExecutionApplicationContext.refresh(AbstractDelegatedExecutionApplicationContext.java:175)[145:org.springframework.osgi.core:1.2.1]
	at org.apache.activemq.osgi.ActiveMQServiceFactory.updated(ActiveMQServiceFactory.java:102)[96:org.apache.activemq.activemq-osgi:5.13.2]
	... 7 more
Caused by: org.springframework.beans.FatalBeanException: NamespaceHandler class [org.apache.xbean.spring.context.v2.XBeanNamespaceHandler] for namespace [http://activemq.apache.org/schema/core] not found; nested exception is java.lang.ClassNotFoundException: org.apache.xbean.spring.context.v2.XBeanNamespaceHandler not found from bundle [org.apache.activemq.activemq-osgi]
	at org.springframework.beans.factory.xml.DefaultNamespaceHandlerResolver.resolve(DefaultNamespaceHandlerResolver.java:135)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.osgi.context.support.DelegatedNamespaceHandlerResolver.resolve(DelegatedNamespaceHandlerResolver.java:56)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.beans.factory.xml.BeanDefinitionParserDelegate.parseCustomElement(BeanDefinitionParserDelegate.java:1427)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.BeanDefinitionParserDelegate.parseCustomElement(BeanDefinitionParserDelegate.java:1422)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader.parseBeanDefinitions(DefaultBeanDefinitionDocumentReader.java:187)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader.doRegisterBeanDefinitions(DefaultBeanDefinitionDocumentReader.java:147)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader.registerBeanDefinitions(DefaultBeanDefinitionDocumentReader.java:101)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.registerBeanDefinitions(XmlBeanDefinitionReader.java:495)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadBeanDefinitions(XmlBeanDefinitionReader.java:391)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	... 24 more
Caused by: java.lang.ClassNotFoundException: org.apache.xbean.spring.context.v2.XBeanNamespaceHandler not found from bundle [org.apache.activemq.activemq-osgi]
	at org.springframework.osgi.util.BundleDelegatingClassLoader.findClass(BundleDelegatingClassLoader.java:103)[145:org.springframework.osgi.core:1.2.1]
	at org.springframework.osgi.util.BundleDelegatingClassLoader.loadClass(BundleDelegatingClassLoader.java:156)[145:org.springframework.osgi.core:1.2.1]
	at java.lang.ClassLoader.loadClass(ClassLoader.java:357)[:1.8.0_92]
	at org.springframework.util.ClassUtils.forName(ClassUtils.java:265)[126:org.apache.servicemix.bundles.spring-core:3.2.14.RELEASE_1]
	at org.springframework.beans.factory.xml.DefaultNamespaceHandlerResolver.resolve(DefaultNamespaceHandlerResolver.java:124)[117:org.apache.servicemix.bundles.spring-beans:3.2.14.RELEASE_1]
	... 32 more
Caused by: java.lang.ClassNotFoundException: org.apache.xbean.spring.context.v2.XBeanNamespaceHandler not found by org.apache.activemq.activemq-osgi [96]
	at org.apache.felix.framework.BundleWiringImpl.findClassOrResourceByDelegation(BundleWiringImpl.java:1574)[org.apache.felix.framework-5.4.0.jar:]
	at org.apache.felix.framework.BundleWiringImpl.access$400(BundleWiringImpl.java:79)[org.apache.felix.framework-5.4.0.jar:]
	at org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:2018)[org.apache.felix.framework-5.4.0.jar:]
	at java.lang.ClassLoader.loadClass(ClassLoader.java:357)[:1.8.0_92]
	at org.apache.felix.framework.Felix.loadBundleClass(Felix.java:1925)[org.apache.felix.framework-5.4.0.jar:]
	at org.apache.felix.framework.BundleImpl.loadClass(BundleImpl.java:978)[org.apache.felix.framework-5.4.0.jar:]
	at org.springframework.osgi.util.BundleDelegatingClassLoader.findClass(BundleDelegatingClassLoader.java:99)[145:org.springframework.osgi.core:1.2.1]
	... 36 more
{noformat}, https://issues.apache.org/jira/browse/CAMEL-9922, [~davsclaus],

It looks like the xbean-spring-3.18 dependency has an OSGI import for Spring 3.x and not Spring 4.x.  I believe Camel uses this dependency as well, how did you get around that when using Spring 4.x ?  There probably needs to be a new release done for xbean-spring but that project looks like there isn't much activity going on., No camel does not use xbean. Its only ActiveMQ., Well that's going to be an issue for upgrading then because this dependency won't work with Spring 4.x and OSGi but ActiveMQ uses it., I ran into the same issue and was able to reproduce it without camel at all! In fact, the error always happens in case when the container has both spring 3.x and 4.x feature installed

Here is a sample karaf assembly configuration:
{code}
                     <plugin>
                        <groupId>org.apache.karaf.tooling</groupId>
                        <artifactId>karaf-maven-plugin</artifactId>
                        <version>${karaf.version}</version>
                        <extensions>true</extensions>
                        <configuration>
                            <installedFeatures>
                                <feature>wrapper</feature>
                            </installedFeatures>
                            <startupFeatures>
                                <feature>standard</feature>
                            </startupFeatures>
                            <bootFeatures>
                                <feature>activemq-broker</feature>
                                <feature>hawtio-offline</feature>
                                <feature>spring/4.2.5.RELEASE_1</feature>
                            </bootFeatures>

                        </configuration>
                    </plugin>
{code}

I believe the root cause of the issue is:

* the xbean library manifest restricts spring version range to [3.2,4)
* the activemq feature also restricts spring version range to [3.2,4) (correct)
* the activemq-osgi module manifest specifies spring version range as [3.2, 5) (incorrect?!)

This causes class org.apache.activemq.osgi.ActiveMQServiceFactory to be wired to the bundle classloader for the latest allowed spring version installed (which is now 4.x), and consequently it then fails to load xbean classes which are restricted to spring 3.x

Stack trace with bundle versions:

{code}
2016-12-28 13:52:04,178 | INFO  | ctivemq.server]) | ActiveMQServiceFactory           | 65 - org.apache.activemq.activemq-osgi - 5.14.3 | Starting broker amq-broker
2016-12-28 13:52:04,254 | INFO  | ctivemq.server]) | ClassPathXmlApplicationContext   | 91 - org.apache.servicemix.bundles.spring-context - 4.2.5.RELEASE_1 | Refreshing org.springframework.context.support.ClassPathXmlApplicationContext@7af27377: startup date [Wed Dec 28 13:52:04 EST 2016]; root of context hierarchy
2016-12-28 13:52:04,703 | INFO  | ctivemq.server]) | XmlBeanDefinitionReader          | 89 - org.apache.servicemix.bundles.spring-beans - 4.2.5.RELEASE_1 | Loading XML bean definitions from URL [file:/C:/Work/Java/otc-trade-service-fuse/karaf/target/assembly/etc/activemq.xml]
2016-12-28 13:52:04,794 | ERROR | ctivemq.server]) | configadmin                      | 5 - org.apache.felix.configadmin - 1.8.8 | [org.osgi.service.cm.ManagedServiceFactory, id=393, bundle=65/mvn:org.apache.activemq/activemq-osgi/5.14.3]: Updating configuration org.apache.activemq.server.adbfe35b-d95f-4102-9ba4-8ba299636be2 caused a problem: Cannot start the broker
org.osgi.service.cm.ConfigurationException: null : Cannot start the broker
	at org.apache.activemq.osgi.ActiveMQServiceFactory.updated(ActiveMQServiceFactory.java:144)[65:org.apache.activemq.activemq-osgi:5.14.3]
	at org.apache.felix.cm.impl.helper.ManagedServiceFactoryTracker.updated(ManagedServiceFactoryTracker.java:159)[5:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.helper.ManagedServiceFactoryTracker.provideConfiguration(ManagedServiceFactoryTracker.java:93)[5:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.ConfigurationManager$ManagedServiceFactoryUpdate.provide(ConfigurationManager.java:1602)[5:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.ConfigurationManager$ManagedServiceFactoryUpdate.run(ConfigurationManager.java:1545)[5:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.UpdateThread.run0(UpdateThread.java:143)[5:org.apache.felix.configadmin:1.8.8]
	at org.apache.felix.cm.impl.UpdateThread.run(UpdateThread.java:110)[5:org.apache.felix.configadmin:1.8.8]
	at java.lang.Thread.run(Thread.java:745)[:1.8.0_20]
Caused by: org.springframework.beans.factory.BeanDefinitionStoreException: Unexpected exception parsing XML document from URL [file:/C:/Work/Java/otc-trade-service-fuse/karaf/target/assembly/etc/activemq.xml]; nested exception is org.springframework.beans.FatalBeanException: NamespaceHandler class [org.apache.xbean.spring.context.v2.XBeanNamespaceHandler] for namespace [http://activemq.apache.org/schema/core] not found; nested exception is java.lang.ClassNotFoundException: org.apache.xbean.spring.context.v2.XBeanNamespaceHandler not found by org.apache.activemq.activemq-osgi [65]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadBeanDefinitions(XmlBeanDefinitionReader.java:414)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader.java:336)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.loadBeanDefinitions(XmlBeanDefinitionReader.java:304)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:181)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:217)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:188)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.support.AbstractBeanDefinitionReader.loadBeanDefinitions(AbstractBeanDefinitionReader.java:252)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.context.support.AbstractXmlApplicationContext.loadBeanDefinitions(AbstractXmlApplicationContext.java:127)[91:org.apache.servicemix.bundles.spring-context:4.2.5.RELEASE_1]
	at org.springframework.context.support.AbstractXmlApplicationContext.loadBeanDefinitions(AbstractXmlApplicationContext.java:93)[91:org.apache.servicemix.bundles.spring-context:4.2.5.RELEASE_1]
	at org.springframework.context.support.AbstractRefreshableApplicationContext.refreshBeanFactory(AbstractRefreshableApplicationContext.java:129)[91:org.apache.servicemix.bundles.spring-context:4.2.5.RELEASE_1]
	at org.springframework.context.support.AbstractApplicationContext.obtainFreshBeanFactory(AbstractApplicationContext.java:609)[91:org.apache.servicemix.bundles.spring-context:4.2.5.RELEASE_1]
	at org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:510)[91:org.apache.servicemix.bundles.spring-context:4.2.5.RELEASE_1]
	at org.apache.activemq.osgi.ActiveMQServiceFactory.updated(ActiveMQServiceFactory.java:126)[65:org.apache.activemq.activemq-osgi:5.14.3]
	... 7 more
Caused by: org.springframework.beans.FatalBeanException: NamespaceHandler class [org.apache.xbean.spring.context.v2.XBeanNamespaceHandler] for namespace [http://activemq.apache.org/schema/core] not found; nested exception is java.lang.ClassNotFoundException: org.apache.xbean.spring.context.v2.XBeanNamespaceHandler not found by org.apache.activemq.activemq-osgi [65]
	at org.springframework.beans.factory.xml.DefaultNamespaceHandlerResolver.resolve(DefaultNamespaceHandlerResolver.java:136)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.BeanDefinitionParserDelegate.parseCustomElement(BeanDefinitionParserDelegate.java:1406)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.BeanDefinitionParserDelegate.parseCustomElement(BeanDefinitionParserDelegate.java:1401)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader.parseBeanDefinitions(DefaultBeanDefinitionDocumentReader.java:168)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader.doRegisterBeanDefinitions(DefaultBeanDefinitionDocumentReader.java:138)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.DefaultBeanDefinitionDocumentReader.registerBeanDefinitions(DefaultBeanDefinitionDocumentReader.java:94)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.registerBeanDefinitions(XmlBeanDefinitionReader.java:508)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.XmlBeanDefinitionReader.doLoadBeanDefinitions(XmlBeanDefinitionReader.java:392)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	... 19 more
Caused by: java.lang.ClassNotFoundException: org.apache.xbean.spring.context.v2.XBeanNamespaceHandler not found by org.apache.activemq.activemq-osgi [65]
	at org.apache.felix.framework.BundleWiringImpl.findClassOrResourceByDelegation(BundleWiringImpl.java:1574)[org.apache.felix.framework-5.4.0.jar:]
	at org.apache.felix.framework.BundleWiringImpl.access$400(BundleWiringImpl.java:79)[org.apache.felix.framework-5.4.0.jar:]
	at org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:2018)[org.apache.felix.framework-5.4.0.jar:]
	at java.lang.ClassLoader.loadClass(ClassLoader.java:357)[:1.8.0_20]
	at org.springframework.util.ClassUtils.forName(ClassUtils.java:250)[95:org.apache.servicemix.bundles.spring-core:4.2.5.RELEASE_1]
	at org.springframework.beans.factory.xml.DefaultNamespaceHandlerResolver.resolve(DefaultNamespaceHandlerResolver.java:125)[89:org.apache.servicemix.bundles.spring-beans:4.2.5.RELEASE_1]
	... 26 more
{code}


The only workaround for now seems to be to revert to camel 2.16 and blacklist spring 4.x from the container complete for the time being]