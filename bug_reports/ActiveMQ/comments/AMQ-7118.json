[GitHub user heathkesler opened a pull request:

    https://github.com/apache/activemq/pull/326

    AMQ-7118: fix issue with the unchanged acknowledgement map.

    If the kahadb ack message file map has not changed, then there is no reason to write it again.  So all the kahadb store tests and activemq unit test suite pass. 

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/heathkesler/activemq AMQ7118-ack

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/activemq/pull/326.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #326
    
----
commit 7dfecde307e61420b179ed54540953132371d278
Author: hkesler <hkesler@...>
Date:   2018-12-02T03:34:31Z

    AMQ-7118: fix the issue with the unchanged ack continues to get written to the data files

commit 5f4fc0793cec914b8990a567f5fdc48fd2aeb9c8
Author: hkesler <hkesler@...>
Date:   2018-12-02T03:36:04Z

    remove merge file

----
, Yeah, I noticed the same thing, the ackMessageFileMapLocation gets written on every checkpoint, even if it hasnt changed.  I think it should only be written when the file map has changed.  I have attached a PR that does just that and it seems to work great.  It has a unit test and I have run all the unit tests and they pass.  Please let me know what you think or if I should change anything.

 , To close the loop from IRC chat:

Heath, this looks good, but I would use AtomicBoolen with lazySet may be a bit cleaner for this., GitHub user heathkesler opened a pull request:

    https://github.com/apache/activemq/pull/327

    AMQ-7118: fix issue where the ackMessageFileMapLocation gets written on every checkpoint

     fix issue where the ackMessageFileMapLocation gets written on every checkpoint, even if it hasnt changed and include the use of the Atomic boolean.  

You can merge this pull request into a Git repository by running:

    $ git pull https://github.com/heathkesler/activemq AMQ7118-map

Alternatively you can review and apply these changes as the patch at:

    https://github.com/apache/activemq/pull/327.patch

To close this pull request, make a commit to your master/trunk branch
with (at least) the following in the commit message:

    This closes #327
    
----
commit 5c08df663de650870d4e4b3f940d7838af96d188
Author: hkesler <hkesler@...>
Date:   2018-12-02T16:17:40Z

    AMQ-7118: fix issue where the ackMessageFileMapLocation gets written on every checkpoint, even if it hasnt changed and include the use of the Atomic boolean

----
, Thanks Jamie for the feedback, I updated the code accordingly. , Thanks Heath!  This looks really great.  [~gtully], can you take a gander as well?, [~heathkesler] verify that the logic around https://github.com/apache/activemq/blob/master/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/MessageDatabase.java#L1916 still holds. 
That code is tracking modifications to trigger a checkpoint that expects that map to be unconditionally stored.

small note; very often the xml config is not necessary (the broker can be programmatically configure)  and the use of 61616 port can be avoided in favour of the vm transport. It makes the unit test tidier and more self contained and could lead to them being run in parallel. 
In any event, it is great to see a matching test that will protect this change.
., Hi [~gtully], 

Thanks for the feedback.  I did indeed verify by breakpoint that it hits the mandatory write on 1948 and the flag is set.  The test reads out all the messages… it hits that code in checkpoint pass #4 in my test.  Are you seeing anything different?, Commit d816b738af33ac2b94e2ef6ba0d3085c7eb32728 in activemq's branch refs/heads/activemq-5.15.x from jgoodyear
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=d816b73 ]

AMQ-7118 This closes #327 - with thanks to Heath Kesler
, Commit 612d4aeeb4025d62f75a301a655112b6e53c7170 in activemq's branch refs/heads/master from jgoodyear
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=612d4ae ]

AMQ-7118 This closes #327 - with thanks to Heath Kesler
, Github user asfgit closed the pull request at:

    https://github.com/apache/activemq/pull/327
, Thank you [~heathkesler] for the patch., The Unit test `testCompaction` seems to be failing on master., {{I've pulled latest on Master and built locally:}}

{{-------------------------------------------------------}}
 {{ T E S T S}}
 {{-------------------------------------------------------}}
 {{Running org.apache.activemq.bugs.AMQ7118Test}}
 {{Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 22.474 sec - in org.apache.activemq.bugs.AMQ7118Test}}

{{Results :}}

{{Tests run: 1, Failures: 0, Errors: 0, Skipped: 0}}

{{Can you please supply more information on your environment? }}

{{I've also run the kahadb store tests as well:}}

{{Results :}}

{{Tests run: 140, Failures: 0, Errors: 0, Skipped: 1}}, I think I just found the problem...

The test is relying in the size of the hostname of your host...

Ex (long hostname):

sudo hostname hostnamehostnamehostname

Running org.apache.activemq.bugs.AMQ7118Test
 Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 2.483 sec <<< FAILURE! - in org.apache.activemq.bugs.AMQ7118Test
 testCompaction(org.apache.activemq.bugs.AMQ7118Test) Time elapsed: 2.094 sec <<< FAILURE!
 java.lang.AssertionError: expected:<21> but was:<22>
 at org.junit.Assert.fail(Assert.java:88)
 at org.junit.Assert.failNotEquals(Assert.java:834)
 at org.junit.Assert.assertEquals(Assert.java:645)
 at org.junit.Assert.assertEquals(Assert.java:631)
 at org.apache.activemq.bugs.AMQ7118Test.checkFiles(AMQ7118Test.java:193)
 at org.apache.activemq.bugs.AMQ7118Test.testCompaction(AMQ7118Test.java:116)

 

Ex (short hostname):

sudo hostname hostname

Running org.apache.activemq.bugs.AMQ7118Test
 Tests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 15.718 sec <<< FAILURE! - in org.apache.activemq.bugs.AMQ7118Test
 testCompaction(org.apache.activemq.bugs.AMQ7118Test) Time elapsed: 15.372 sec <<< FAILURE!
 org.junit.ComparisonFailure: expected:<db-3[3].log> but was:<db-3[0].log>
 at org.junit.Assert.assertEquals(Assert.java:115)
 at org.junit.Assert.assertEquals(Assert.java:144)
 at org.apache.activemq.bugs.AMQ7118Test.checkFiles(AMQ7118Test.java:194)
 at org.apache.activemq.bugs.AMQ7118Test.testCompaction(AMQ7118Test.java:135)

 

But the test runs successfully if the hostname is set to "hostnamehostname"

sudo hostname hostnamehostname

-------------------------------------------------------
 T E S T S
 -------------------------------------------------------
 Running org.apache.activemq.bugs.AMQ7118Test
 Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 23.281 sec - in org.apache.activemq.bugs.AMQ7118Test

Results :

Tests run: 1, Failures: 0, Errors: 0, Skipped: 0

 

 , Just to clarify, the hostname is changing the message ID and so, changing the number of journal files..

 

CommandType: KAHA_ADD_MESSAGE_COMMAND - TOPIC (DestId: 1:test), MsgId: ID:hostnamehostname-61683-1546886442069-4:2:1:1:1.

 , Commit a2dccbf8431b881fc95f63a41ce4deb4ae476304 in activemq's branch refs/heads/activemq-5.15.x from Jeff Genender
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a2dccbf ]

AMQ-7118 - Override hostname for naming to allow tests to apss on all
platforms
, Commit 273afef47c9fef5258cc297ae7353b705db3efb6 in activemq's branch refs/heads/master from Jeff Genender
[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=273afef ]

AMQ-7118 - Override hostname for naming to allow tests to apss on all
platforms
]