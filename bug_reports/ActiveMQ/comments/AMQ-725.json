[Lets try to get this fix for the next release., I have tested this with the new 4.01 release of ActiveMQ using the default configuration file and I am still having the problem.

After performing a TCP connections to the Broker on the listener defined as tcp://wrpkmnb:61613?wireFormat=stomp:

I transmit the connection message:

CONNECT\010login:billm\010passcode:billm\010client-id:webProcessor\010\010\000

After which I receive the message:

CONNECTED\010session:webProcessor\010\010\000\010

I then try to subscribe to a queue:

SUBSCRIBE\010destination:/queue/WebRequest\010id:webProcessorconsumer:2\010ack:client\010activemq.prefetchSize:1\010\010\000

And no response is returned from the Broker but the log shows the following message.

Exception in thread "ActiveMQ Connection Dispatcher: 28939486" java.lang.NullPointerException
    at java.util.Hashtable.put(Unknown Source)
    at java.util.Hashtable.putAll(Unknown Source)
    at org.apache.activemq.transport.stomp.FrameBuilder.addHeaders(FrameBuilder.java:65)
    at org.apache.activemq.transport.stomp.Subscription.receive(Subscription.java:76)
    at org.apache.activemq.transport.stomp.StompWireFormat.writeCommand(StompWireFormat.java:154)
    at org.apache.activemq.transport.stomp.StompWireFormat.marshal(StompWireFormat.java:305)
    at org.apache.activemq.transport.tcp.TcpTransport.oneway(TcpTransport.java:124)
    at org.apache.activemq.transport.InactivityMonitor.oneway(InactivityMonitor.java:141)
    at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:44)
    at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)
    at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:211)
    at org.apache.activemq.broker.AbstractConnection.processDispatch(AbstractConnection.java:581)
    at org.apache.activemq.broker.AbstractConnection.iterate(AbstractConnection.java:597)
    at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:87)
    at org.apache.activemq.thread.DedicatedTaskRunner.access$000(DedicatedTaskRunner.java:24)
    at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:38)

For readability I have replaced the linefeeds with \010 and the nulls with \000 representations., I just tested against 4.1-SNAPSHOT and this is working., 
   [[ Old comment, sent by email on Tue, 20 Jun 2006 19:17:14 +0000 ]]

Hiram,

Sorry for the delay in responding, I have been out of the country.

I will put together a test case, in the next day or so, showing the data 
transmitted to and from the broker as I am not using the standard Stomp 
clients, I have implemented a Stomp client in the Progress 4GL programming 
language.

William MacDonald
Ontario, Canada

, 
   [[ Old comment, sent by email on Sat, 01 Jul 2006 20:53:00 -0400 ]]

I have tested this with the new 4.01 release of ActiveMQ using the
default configuration file and I am still having the problem.

After performing a TCP connections to the Broker on the listener defined
as tcp://wrpkmnb:61613?wireFormat=stomp:

I transmit the connection message:

*CONNECT\010login:billm\010passcode:billm\010client-id:webProcessor\010\010\000*

After which I receive the message:
*
CONNECTED\010session:webProcessor\010\010\000\010*

I then try to subscribe to a queue:

*SUBSCRIBE\010destination:/queue/WebRequest\010id:webProcessorconsumer:2\010ack:client\010activemq.prefetchSize:1\010\010\000*

And no response is returned from the Broker but the log shows the
following message.

*Exception in thread "ActiveMQ Connection Dispatcher: 28939486"
java.lang.NullPointerException
    at java.util.Hashtable.put(Unknown Source)
    at java.util.Hashtable.putAll(Unknown Source)
    at
org.apache.activemq.transport.stomp.FrameBuilder.addHeaders(FrameBuilder.java:65)
    at
org.apache.activemq.transport.stomp.Subscription.receive(Subscription.java:76)
    at
org.apache.activemq.transport.stomp.StompWireFormat.writeCommand(StompWireFormat.java:154)
    at
org.apache.activemq.transport.stomp.StompWireFormat.marshal(StompWireFormat.java:305)
    at
org.apache.activemq.transport.tcp.TcpTransport.oneway(TcpTransport.java:124)
    at
org.apache.activemq.transport.InactivityMonitor.oneway(InactivityMonitor.java:141)
    at
org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:44)
    at
org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)
    at
org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:211)
    at
org.apache.activemq.broker.AbstractConnection.processDispatch(AbstractConnection.java:581)
    at
org.apache.activemq.broker.AbstractConnection.iterate(AbstractConnection.java:597)
    at
org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:87)
    at
org.apache.activemq.thread.DedicatedTaskRunner.access$000(DedicatedTaskRunner.java:24)
    at
org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:38)*

For readability I have replaced the linefeeds with \010 and the nulls
with \000 representations.

William


]