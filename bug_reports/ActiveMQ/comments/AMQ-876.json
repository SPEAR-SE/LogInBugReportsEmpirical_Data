[Sorry, but I still get this problem

ERROR MapContainerImpl               - Failed to get value for offset=357, key=(-1, -1, 0), value=(-1, -1, 0), previousItem=-1, nextItem=765

java.io.IOException: Could not locate data file queue-data-1

	at org.apache.activemq.kaha.impl.data.DataManager.getDataFile(DataManager.java:118)

	at org.apache.activemq.kaha.impl.data.StoreDataReader.readItem(StoreDataReader.java:62)

	at org.apache.activemq.kaha.impl.data.DataManager.readItem(DataManager.java:122)

	at org.apache.activemq.kaha.impl.container.MapContainerImpl.getValue(MapContainerImpl.java:344)

	at org.apache.activemq.kaha.impl.container.MapContainerImpl.remove(MapContainerImpl.java:272)

	at org.apache.activemq.store.kahadaptor.KahaMessageStore.removeMessage(KahaMessageStore.java:68)

	at org.apache.activemq.store.kahadaptor.KahaTransaction.commit(KahaTransaction.java:92)

	at org.apache.activemq.store.kahadaptor.KahaTransactionStore.commit(KahaTransactionStore.java:95)

	at org.apache.activemq.transaction.LocalTransaction.commit(LocalTransaction.java:68)

	at org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:154)

	at org.apache.activemq.broker.BrokerFilter.commitTransaction(BrokerFilter.java:93)

	at org.apache.activemq.broker.BrokerFilter.commitTransaction(BrokerFilter.java:93)

	at org.apache.activemq.broker.MutableBrokerFilter.commitTransaction(MutableBrokerFilter.java:103)

	at org.apache.activemq.broker.MutableBrokerFilter.commitTransaction(MutableBrokerFilter.java:103)

	at org.apache.activemq.broker.AbstractConnection.processCommitTransactionOnePhase(AbstractConnection.java:330)

	at org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:99)

	at org.apache.activemq.broker.AbstractConnection.service(AbstractConnection.java:228)

	at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:63)

	at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:92)

	at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)

	at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:124)

	at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:123)

	at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:88)

	at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:129)

, 
Hi Rob,

I have been trying to understand what is going on there. Here is what I found out so far. The exception happens in DataManager.getDataFile(DataItem) method. In this method the 2nd line is fileMap.get(key); and the key is -1 when the exception occurs. 

The key is from getFile() method of the DataItem. If you scroll down the stack trace to MapContainerImpl.getValue(), the DataItem's file field is set from IndexItem's valueFile member. This value is set "incorrectly" to -1 in MapContainerImpl.remove. 

In this method you find the following lines:

// ensure we have the upto date item
item=indexList.getEntry(item);

The IndexItem item is set from a HashMap in this method and the valueFile field on this object is "correct" (i.e. != -1). However after this line, the value that is read from the file system has the -1 in it, which results in error.

Quite frankly, I do not yet understand the Kaha code well enough. Can you please guide me to through this, so I can help you with resolving and testing this issue? By the way can you reproduce this JIRA?  

Regards,

Vadim
, Hi Vadim,

I couldn't reproduce this - and as I'd fixed something like this a few weeks ago - I'd assumed it was fixed.
Could you try and produce a test case for this ?

cheers,

Rob, Rob,

Unfortunately it is not easy to reproduce this bug. It happens all the time when I run my test, but not on the same iteration of the test. Sometimes it happens right away, other times I have to wait longer. My test sends 1500 messages but the error happens only once, but every time.
, Hi Rob,

I just send the test code to help reproduce this problem to you Gmail account. Please let me know if you got it and was able to reproduce the problem. Thanks., I am not sure if you got my message or not. Since I am going to be away starting on Monday I am attaching the test and my e-mail.

"I was unable to write a simple unit test to recreate the problem, so I am attaching simulation test along with some utility classes. I am using IntelliJ Idea and JDK 1.5.2 installed. I am not sure if there is any 1.5 syntax. To run the test just start the broker (with kaha persistence) and execute DailyUpdateSimulationJmsTest JUnit class from Idea (Idea project file included). Sometimes it takes awhile before the error occurs (up to 5 minutes), but most of the time it happens very quickly. To check if error happened "grep" the AMQ log for "Could not locate data file" string. Thanks.", Hi Rob,

Is there any chance you can give me heads up on when you may have time to take a look at this? Thanks., Hi Vadim,

would you mind trying the latest code ? I've done some bug fixes in the kaha area today - unfortunately one of the bug fixes means it's no longer backwards compatible

cheers,

Rob, Hi Rob,

Yes looks like you got it. Thanks a lot., this seems to be fixed]