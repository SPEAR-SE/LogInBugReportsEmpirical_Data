{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": null,
        "components": [],
        "created": "2014-11-06T01:10:09.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Pete Bertrand",
            "key": "pbertrand",
            "name": "pbertrand",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=pbertrand",
            "timeZone": "Etc/UTC"
        },
        "customfield_10010": null,
        "customfield_12310041": null,
        "customfield_12310080": null,
        "customfield_12310220": "2015-02-05T14:33:04.682+0000",
        "customfield_12310222": "1_*:*_1_*:*_33058522585_*|*_6_*:*_1_*:*_0",
        "customfield_12310250": null,
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "2.0",
        "customfield_12310420": "9223372036854775807",
        "customfield_12310920": "9223372036854775807",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i221af:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "Mon Nov 23 16:05:31 UTC 2015",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "In a network of 2 brokers (A and B) with durable queued messages \ngoing from A to B over a duplex NetworkConnector,\nif A is stopped and restarted while messages are in-flight, \nand if replayed messages from A are recognized as duplicates on B,\nthen 30 seconds after B goes idle, B's CPU goes to 100%.\n\nI have attached the thread dump to the ticket.\n\nFrom what I have been able to figure out, the dequeue counter does not count\nmoving the duplicate into the DLQ. The counters show a pending message when\nthere is none in the persisted queue. So when the scheduler kicks in 30 seconds\nafter the broker goes idle, it says \"I have a pending message, fetch it from the DB\"\nbut the fetch returns 0 messages. Immediately the scheduler still sees pending\nmessages and does a DB fetch, with no results. This is where the CPU is spinning.\n\nSee the attached thread dump.\n\nSo, in detail:\nIt appears that after A is restarted and it replays messages that have not been ACKed,\nB receives duplicate messages and sends them to the DLQ. Here is the warning from the log:\n{noformat}\n  WARN | duplicate message from store ID:host-lnx-59946-1415221396197-1:1:1:1:468, redirecting for dlq processing | org.apache.activemq.broker.region.Queue | ActiveMQ VMTransport: vm://broker1#11-1\n{noformat}\nAfter all messages are delivered and the brokers are idle for 30 seconds and the CPU on B is now 100%, if you use the WebConsole and look at the queues on B you see the following:\n{noformat}\n              Number Of                \t\n   Queue      Pending     Number Of  Messages  Messages\n   Name       Messages    Consumers  Enqueued  Dequeued\nActiveMQ.DLQ     1            0         1         0\nTEST.FOO         1            1        469       468\n{noformat}\n\nOn this test run, only one message was a duplicate. It was moved to the DLQ, but the TEST.FOO counters show it as pending. The counters are out of sync with actual messages in the persisted queue, because the duplicate message is now in the DLQ and not in the TEST.FOO queue.\n\nAt this point if you purge TEST.FOO, CPU on B goes back to normal because this clears the pending message counter.\n\n+*Steps to reproduce*+\n\nSet up 2 brokers as follows:\n\n  *producer* ==> *broker-A*  <==  duplex network connection  ==>  *broker-B* ==>  *consumer*\n\n1) Download the binary distribution of AMQ 5.10.0 and extract apache-activemq-5.10.0-bin.tar.gz\n\n2) Create two brokers\n{noformat}\n $ ACTIVEMQ_HOME/bin/activemq create /path/to/brokers/broker-a\n $ ACTIVEMQ_HOME/bin/activemq create /path/to/brokers/broker-b\n{noformat}\n\n3) Update broker-a to connect to broker-b with a duplex connection.\n   _You can use the attached *activemq.xml*_. It does the following:\n- Sets transport for broker-a to port 61610\n- Sets up networkConnector to connect to broker-b on 61616\n- Does not start jetty web console on broker-a to avoid port conflict\n\nbroker-b is un-modified and defaults to port 61616\n\n4) Start the brokers\n{noformat}\n $ broker-a/bin/broker-a start\n $ broker-b/bin/broker-b start\n{noformat}\n\n5) Start consumer connected to broker-b and producer connected to broker-a\n{noformat}\n $ ant consumer -Durl=tcp://localhost:61616 -Ddurable=true\n $ ant producer -Durl=tcp://localhost:61610 -Ddurable=true\n{noformat}\n\n6) Stop broker-a before producer is finished sending messages, then restart\n{noformat}\n $ broker-a/bin/broker-a stop\n $ broker-a/bin/broker-a start\n{noformat}\n\n7) Look at broker-b logs for duplicates, look at broker-b web console for pending messages\n http://localhost:8161/admin/queues.jsp\n\n8) 30 seconds after going idle, broker-b CPU will goto 100%\n\n9) Purge TEST.FOO on broker-b, pending messages will reset and CPU will go back to normal.\n",
        "duedate": null,
        "environment": null,
        "fixVersions": [{
            "archived": false,
            "description": "Issues that need to be reviewed - do we keep 'em or do we kick 'em? ",
            "id": "12315630",
            "name": "NEEDS_REVIEW",
            "released": false,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12315630"
        }],
        "issuelinks": [{
            "id": "12401383",
            "outwardIssue": {
                "fields": {
                    "issuetype": {
                        "avatarId": 21133,
                        "description": "A problem which impairs or prevents the functions of the product.",
                        "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
                        "id": "1",
                        "name": "Bug",
                        "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
                        "subtask": false
                    },
                    "priority": {
                        "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
                        "id": "3",
                        "name": "Major",
                        "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
                    },
                    "status": {
                        "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.",
                        "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png",
                        "id": "6",
                        "name": "Closed",
                        "self": "https://issues.apache.org/jira/rest/api/2/status/6",
                        "statusCategory": {
                            "colorName": "green",
                            "id": 3,
                            "key": "done",
                            "name": "Done",
                            "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
                        }
                    },
                    "summary": "Selector Worker thread consumes significant CPU when broker is idle"
                },
                "id": "12706473",
                "key": "AMQ-5133",
                "self": "https://issues.apache.org/jira/rest/api/2/issue/12706473"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/issueLink/12401383",
            "type": {
                "id": "10030",
                "inward": "is related to",
                "name": "Reference",
                "outward": "relates to",
                "self": "https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"
            }
        }],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "id": "3",
            "name": "Major",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011"
            },
            "id": "12311210",
            "key": "AMQ",
            "name": "ActiveMQ",
            "projectCategory": {
                "description": "ActiveMQ",
                "id": "11160",
                "name": "ActiveMQ",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/11160"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12311210"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Pete Bertrand",
            "key": "pbertrand",
            "name": "pbertrand",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=pbertrand",
            "timeZone": "Etc/UTC"
        },
        "resolution": {
            "description": "All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.",
            "id": "5",
            "name": "Cannot Reproduce",
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/5"
        },
        "resolutiondate": "2015-11-23T16:05:31.000+0000",
        "status": {
            "description": "The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/closed.png",
            "id": "6",
            "name": "Closed",
            "self": "https://issues.apache.org/jira/rest/api/2/status/6",
            "statusCategory": {
                "colorName": "green",
                "id": 3,
                "key": "done",
                "name": "Done",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
            }
        },
        "subtasks": [],
        "summary": "Broker at 100% CPU when idle after Network Connection reconnect with duplicates sent",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2015-11-23T16:05:31.000+0000",
        "versions": [{
            "archived": false,
            "id": "12324950",
            "name": "5.10.0",
            "releaseDate": "2014-06-10",
            "released": true,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12324950"
        }],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/AMQ-5424/votes",
            "votes": 1
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/AMQ-5424/watchers",
            "watchCount": 5
        },
        "workratio": -1
    },
    "id": "12753265",
    "key": "AMQ-5424",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/12753265"
}