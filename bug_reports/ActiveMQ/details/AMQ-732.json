{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481606","self":"https://issues.apache.org/jira/rest/api/2/issue/12481606","key":"AMQ-732","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315629","id":"12315629","description":"","name":"4.0.3","archived":true,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2006-06-05T22:32:13.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jul 11 21:49:40 UTC 2006","customfield_12310420":"84345","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1027584000_*|*_5_*:*_3_*:*_676001000_*|*_4_*:*_2_*:*_57093653719","customfield_12312321":null,"resolutiondate":"2008-04-10T17:42:25.719+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-732/watchers","watchCount":0,"isWatching":false},"created":"2006-05-31T05:08:27.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315610","id":"12315610","name":"4.0","archived":false,"released":true}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-04-10T17:42:25.717+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The simplest way to reproduce the problem:\n1. Remove storage directory. \n2. Start broker using the following code:\n\n\n public static void main(String[] args)  throws Exception {\n           BrokerService broker = new BrokerService();\n           broker.setPersistent(true);\n           DefaultPersistenceAdapterFactory pFactory = new DefaultPersistenceAdapterFactory();\n           pFactory.setJournalLogFiles(1);\n           pFactory.setJournalLogFileSize(2048);\n           broker.setPersistenceFactory(pFactory);\n           broker.setUseJmx(false);\n           broker.addConnector(\"tcp://localhost:61616\");\n           broker.start();\n           Thread.sleep(1000000000000l);\n   }\n3. Shutdown the broker.\n4. Start broker.\nIt enters infinite loop\n\n[                          main] BrokerService                  INFO  ActiveMQ null JMS Message Broker (localhost) is starting\n[                          main] BrokerService                  INFO  For help or more information please see: http://incubator.apache.org/activemq/\n[                          main] JDBCPersistenceAdapter         INFO  Database driver recognized: [apache_derby_embedded_jdbc_driver]\n[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE TABLE ACTIVEMQ_MSGS(ID INTEGER NOT NULL, CONTAINER VARCHAR(250), MSGID_PROD VARCHAR(250), MSGID_SEQ INTEGER, EXPIRATION BIGINT, MSG BLOB, PRIMARY KEY ( ID ) )\n[                          main] DefaultJDBCAdapter             DEBUG Could not create JDBC tables; The message table already existed. Failure was: CREATE TABLE ACTIVEMQ_MSGS(ID INTEGER NOT NULL, CONTAINER VARCHAR(250), MSGID_PROD VARCHAR(250), MSGID_SEQ INTEGER, EXPIRATION BIGINT, MSG BLOB, PRIMARY KEY ( ID ) ) Message: Table/View 'ACTIVEMQ_MSGS' already exists in Schema 'APP'. SQLState: X0Y32 Vendor code: 20000\n[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE INDEX ACTIVEMQ_MSGS_MIDX ON ACTIVEMQ_MSGS (MSGID_PROD,MSGID_SEQ)\n[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE INDEX ACTIVEMQ_MSGS_CIDX ON ACTIVEMQ_MSGS (CONTAINER)\n[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE INDEX ACTIVEMQ_MSGS_EIDX ON ACTIVEMQ_MSGS (EXPIRATION)\n[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: CREATE TABLE ACTIVEMQ_ACKS(CONTAINER VARCHAR(250) NOT NULL, CLIENT_ID VARCHAR(250) NOT NULL, SUB_NAME VARCHAR(250) NOT NULL, SELECTOR VARCHAR(250), LAST_ACKED_ID INTEGER, PRIMARY KEY ( CONTAINER, CLIENT_ID, SUB_NAME))\n[                          main] DefaultJDBCAdapter             DEBUG Could not create JDBC tables; The message table already existed. Failure was: CREATE TABLE ACTIVEMQ_ACKS(CONTAINER VARCHAR(250) NOT NULL, CLIENT_ID VARCHAR(250) NOT NULL, SUB_NAME VARCHAR(250) NOT NULL, SELECTOR VARCHAR(250), LAST_ACKED_ID INTEGER, PRIMARY KEY ( CONTAINER, CLIENT_ID, SUB_NAME)) Message: Table/View 'ACTIVEMQ_ACKS' already exists in Schema 'APP'. SQLState: X0Y32 Vendor code: 20000\n[                          main] JDBCPersistenceAdapter         DEBUG Cleaning up old messages.\n[                          main] DefaultJDBCAdapter             DEBUG Executing SQL: DELETE FROM ACTIVEMQ_MSGS WHERE ( EXPIRATION<>0 AND EXPIRATION<?) OR ID <= ( SELECT min(ACTIVEMQ_ACKS.LAST_ACKED_ID) FROM ACTIVEMQ_ACKS WHERE ACTIVEMQ_ACKS.CONTAINER=ACTIVEMQ_MSGS.CONTAINER)\n[                          main] DefaultJDBCAdapter             DEBUG Deleted 0 old message(s).\n[                          main] JDBCPersistenceAdapter         DEBUG Cleanup done.\n[                          main] JournalPersistenceAdapter      INFO  Journal Recovery Started from: Active Journal: using 1 x 0.001953125 Megs at: /workplace/fateev/install/activemq-4.0-SNAPSHOT/activemq-core/activemq-data/journal\n[                          main] JournalPersistenceAdapter      DEBUG TRACE Entry: RECOVERED\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=53\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=97\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=0\n[                          main] JournalPersistenceAdapter      DEBUG TRACE Entry: RECOVERED\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=53\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=97\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=0\n[                          main] JournalPersistenceAdapter      DEBUG TRACE Entry: RECOVERED\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=53\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation offset=97\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=0\n\nThe log entry from getNextDataRecordLocation is coming from log statement I've added to LogFileManager.getNextDataRecordLocation:\n\n   public Location getNextDataRecordLocation(Location lastLocation) throws IOException, InvalidRecordLocationException {\n        RecordInfo ri = readRecordInfo(lastLocation);\n        while (true) {\n\n            int logFileId = ri.getLocation().getLogFileId();\n            int offset = ri.getNextLocation();\n            log.debug(\"getNextDataRecordLocation offset=\" + offset);\n            // Are we overflowing into next logFile?\n            if (offset >= ri.getLogFileState().getAppendOffset()) {\n                LogFileNode nextActive = ri.getLogFileState().getNextActive();\n                log.debug(\"getNextDataRecordLocation overflowing into next logFile=\" + (nextActive == null ? \"null\"  : String.valueOf(nextActive.getId())));\n                if (nextActive == null) {\n                    return null;\n                }\n                logFileId = nextActive.getId();\n                offset = 0;\n            }\n\n            try {\n                ri = readRecordInfo(new Location(logFileId, offset));\n            } catch (InvalidRecordLocationException e) {\n                return null;\n            }\n\n            // Is the next record the right record type?\n            if (ri.getHeader().getRecordType() == DATA_RECORD_TYPE) {\n                return ri.getLocation();\n            }\n            // No? go onto the next record.\n        }\n    }\n\nIt looks like recovery doesn't take into account that journaling storage file should have some end at some point. \n\nSimilar problem happens if multiple files of bigger size are used. It happens every time one of the log files grows bigger then size specified in pFactory.setJournalLogFileSize(...) call.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460681","id":"12460681","filename":"activemq-data-1-journal.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-09T03:45:29.000+0000","size":84287,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12460681/activemq-data-1-journal.tar.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460824","id":"12460824","filename":"activemq-data-2-journal.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-09T03:47:07.000+0000","size":722518,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12460824/activemq-data-2-journal.tar.gz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161558","customfield_12312823":null,"summary":"Infinite recovery loop.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux RHEL 3","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937943","id":"12937943","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"I was able to reproduce problem with default journal configuration. \n1. Remove content of storage directory.\n2. Start broker. \n3. Enqueue 30000 messages.\n4. Stop broker.\n5. Start broker.\n6. Dequeue 30000 messages.\n7. Stop broker.\n8. Start broker.\n9. Enqueue 30000 messages.\n10. Stop broker.\n11. Recovery never ends looping through log files:\n\nfateev@fateev:/workplace/fateev/install/activemq-4.0-SNAPSHOT/activemq-core/activemq-data> grep overflowing server.log\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=4\n57352 [Journal Writer] DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=4\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=3\n73287 [Journal Writer] DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=3\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=4\n118821 [Journal Writer] DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=4\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=3\n122112 [Journal Writer] DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=3\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=4\n164157 [Journal Writer] DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=4\n[                Journal Writer] LogFileManager                 DEBUG getNextDataRecordLocation overflowing into next logFile=3\n166746 [Journal Writer] DEBUG org.apache.activeio.journal.active.LogFileManager  - getNextDataRecordLocation overflowing into next logFile=3\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-01T01:53:34.000+0000","updated":"2006-06-01T01:53:34.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12938025","id":"12938025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"How big were the messages?  Can the shiped example producer and consumer in the examples directory reproduce the issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-06-05T22:32:13.000+0000","updated":"2006-06-05T22:32:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12938079","id":"12938079","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"I don't know message size as I use shipped producer and consumer. Here are commands used to enqueue and dequeue messages:\n\nactivemq/assembly/target/activemq-4.0-SNAPSHOT/bin/activemq-4.0-SNAPSHOT/example> ant producer -Ddurable=true -Dmax=10000\nactivemq/assembly/target/activemq-4.0-SNAPSHOT/bin/activemq-4.0-SNAPSHOT/example> ant consumer -Ddurable=true -Dmax=10000\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-07T02:15:10.000+0000","updated":"2006-06-07T02:15:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937887","id":"12937887","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"Also note that my first entry shows how to reproduce the problem without ANY consumers and producers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-07T02:17:13.000+0000","updated":"2006-06-07T02:17:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12938086","id":"12938086","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"One possible clue is that I'm running broker from eclipse. And eclipse kills processes without running their shutdown handlers. So it might be that to reproduce you'll need to kill broker with kill -9.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-08T01:32:31.000+0000","updated":"2006-06-08T01:32:31.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12938102","id":"12938102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"After more testing it looks like the root cause is not executing usual shutdown sequence of a broker. When I stop broker in normal way I cannot reproduce the problem. When I stop it through \"kill -9\" or through eclipse it fails in the way described in contact. \n\nFor me it looks like Journal design issue. It has to tolerate catastrofic shutdown but by design shutdown code has to be executed to leave journal in consistent state. Is any way to force journal into consistent state after every modification?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-08T05:34:56.000+0000","updated":"2006-06-08T05:34:56.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937757","id":"12937757","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"Great investigation Maxim; sounds like you are on to something.\n\nIn an ideal world we'd have an automated system test which did a kill -9 on a running broker and tested it recovers fine and so forth.\n\nIn the meantime, I wonder if you could give us a tarball of the journal files created after a kill -9 and we can use recovery of those files as an automated test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-08T17:47:21.000+0000","updated":"2006-06-08T17:47:21.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937717","id":"12937717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"BTW you should be able to attach a zipped up tarball of the activemq-data directory for a broker which can't recover and we can get it working","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-08T17:51:08.000+0000","updated":"2006-06-08T17:51:08.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937813","id":"12937813","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"storage of first failure case when single log file is used an no messages where published.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-09T03:45:29.000+0000","updated":"2006-06-09T03:45:29.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12936200","id":"12936200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"Storage that reproduces infinite recovery loop with two files configured through the following code:\n\n            DefaultPersistenceAdapterFactory pFactory = new DefaultPersistenceAdapterFactory();\n            pFactory.setJournalLogFiles(2);\n            pFactory.setJournalLogFileSize(10240);\n            broker.setPersistenceFactory(pFactory);","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-09T03:47:07.000+0000","updated":"2006-06-09T03:47:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937959","id":"12937959","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"I've attached storatge files. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-09T03:48:36.000+0000","updated":"2006-06-09T03:48:36.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937915","id":"12937915","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Thanks Maxim,\n\nThose journal files helped me reproduce and fix the problem!  I've committed the fix against the 4.1 and 4.0 branch.  A subsequent nighly snapshot should include the fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-06-12T02:34:51.000+0000","updated":"2006-06-12T02:34:51.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937905","id":"12937905","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for quick fix. \nCould you provide more info on the root cause? It would be nice to include such information as well as check in number every time you close an issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mfateev","name":"mfateev","key":"mfateev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maxim Fateev","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-12T23:38:56.000+0000","updated":"2006-06-12T23:38:56.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12937928","id":"12937928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Here's the diff:\n\nhttp://svn.apache.org/viewvc/incubator/activemq/trunk/activeio/activeio-core/src/main/java/org/apache/activeio/journal/active/LogFileManager.java?view=diff&r1=413520&r2=413521&pathrev=413521\n\nWe were iterating though all the records in the journal, when we got to the last record, and ask for the subsequent record, instead of getting null, we would get the first record in the journal again.  This only happened when all the files in the journal were 'active', they held records that were recorded after the mark.  Fixed the logic so that we don't go past the last record.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-06-13T00:41:25.000+0000","updated":"2006-06-13T00:41:25.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12938027","id":"12938027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"ah.. just noticed that 4.0.1 did not build a new activeio and ship with the new version.  I guess this will make it into 4.0.2 then.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-06-19T23:24:01.000+0000","updated":"2006-06-19T23:24:01.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481606/comment/12938020","id":"12938020","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"We need to build activeio beta-4 and ship with that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-07-11T21:49:40.000+0000","updated":"2006-07-11T21:49:40.000+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-732/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s0i7:"}}