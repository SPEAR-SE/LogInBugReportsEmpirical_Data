{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482357","self":"https://issues.apache.org/jira/rest/api/2/issue/12482357","key":"AMQ-1956","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-10-02T11:50:04.533+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 02 11:50:04 UTC 2008","customfield_12310420":"75157","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_497579776_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-10-02T11:50:04.556+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1956/watchers","watchCount":0,"isWatching":false},"created":"2008-09-26T17:37:04.780+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-10-08T08:49:55.035+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Steps:\n\n1. Create a broker with the persistence adapter set to not use database locking (useDatabaseLock=\"false\")\n2. Start broker\n3. Stop broker (but keep the process running, as in a servlet container)\n\nResult:\n\nIn the logs, I see the following error every 30 seconds:\n\n2008/09/25 15:23:55.506 INFO [org.apache.activemq.store.jdbc.JDBCPersistenceAdapter] No longer able to keep the exclusive lock so giving up being a master\n2008/09/25 15:23:55.506 WARN [org.apache.activemq.store.jdbc.JDBCPersistenceAdapter] Failed to stop broker\n2008/09/25 15:24:25.504 ERROR [org.apache.activemq.store.jdbc.DefaultDatabaseLocker] Failed to update database lock: java.lang.NullPointerException\njava.lang.NullPointerException\n        at org.apache.activemq.store.jdbc.DefaultDatabaseLocker.keepAlive(DefaultDatabaseLocker.java:102)\n        at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.databaseLockKeepAlive(JDBCPersistenceAdapter.java:458)\n        at org.apache.activemq.store.jdbc.JDBCPersistenceAdapter$3.run(JDBCPersistenceAdapter.java:260)\n        at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:417)\n        at java.util.concurrent.FutureTask$Sync.innerRunAndReset(FutureTask.java:280)\n        at java.util.concurrent.FutureTask.runAndReset(FutureTask.java:135)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$101(ScheduledThreadPoolExecutor.java:65)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.runPeriodic(ScheduledThreadPoolExecutor.java:142)\n        at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:166)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)\n        at java.lang.Thread.run(Thread.java:613)\n\n\nAnalysis:\n\nDuring startup, JDBCPersistenceAdapter only initializes the database locker if useDatabaseLock if true. This is done through lazy initialization by calling getDatabaseLocker (at ~ line 172):\n\n        if (isUseDatabaseLock()) {\n            DatabaseLocker service = getDatabaseLocker();\n            if (service == null) {\n                LOG.warn(\"No databaseLocker configured for the JDBC Persistence Adapter\");\n            } else {\n                service.start();\n            }\n        }\n\nDuring shutdown, JDBCPersistenceAdapter calls getDatabaseLocker() to shut it down, but it does not check if isUseDatabaseLock() is true in this case:\n\n    public synchronized void stop() throws Exception {\n        if (clockTicket != null) {\n            clockTicket.cancel(true);\n            clockTicket = null;\n        }\n        if (clockDaemon != null) {\n            clockDaemon.shutdown();\n            clockDaemon = null;\n        }\n        DatabaseLocker service = getDatabaseLocker();\n        if (service != null) {\n            service.stop();\n        }\n    }\n\nThis actually causes database locker to be initialized and it subsequently lazy-initializes an executor to run a task which calls keepAlive(...). The executor threads are set as daemon threads which prevents this issue from showing up when the lifetime of the process is the same as the broker. When the broker is deployed in an app server which can outlive the broker then the above error is logged every 30 seconds.\n\nI'm attaching one way to solve this problem without having to check everywhere if useDatabaseLock=\"false\".\n\nAttached:\n\nBrokerStopFailure.java - sample program that reproduces this bug\nNoLockerJDBCPersistenceAdapter.java - sample extension to JDBCPersistenceAdapter that fixes this bug","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461220","id":"12461220","filename":"ASF.LICENSE.NOT.GRANTED--BrokerStopFailure.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpettitt","name":"cpettitt","key":"cpettitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Pettitt","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-26T17:37:04.812+0000","size":1385,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461220/ASF.LICENSE.NOT.GRANTED--BrokerStopFailure.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461111","id":"12461111","filename":"ASF.LICENSE.NOT.GRANTED--NoLockerJDBCPersistenceAdapter.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpettitt","name":"cpettitt","key":"cpettitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Pettitt","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-26T17:37:04.814+0000","size":800,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461111/ASF.LICENSE.NOT.GRANTED--NoLockerJDBCPersistenceAdapter.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"233342","customfield_12312823":null,"summary":"NPE during broker shutdown when useDatabaseLock=\"false\"","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpettitt","name":"cpettitt","key":"cpettitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Pettitt","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpettitt","name":"cpettitt","key":"cpettitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Pettitt","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482357/comment/12940279","id":"12940279","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Committed revision 701088.\n\nthanks for the analysis Chris. Since the users of getDatabaseLocker already check for null i simply return null if a lock is not to be used.\nnote for future reference: ensure you check the \"grant ASF License\" check box when you submit a patch or enhancement, otherwise your contribution cannot be used. thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-02T11:50:04.533+0000","updated":"2008-10-02T11:50:04.533+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1956/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14blj:"}}