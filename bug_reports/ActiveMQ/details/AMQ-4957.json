{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12686466","self":"https://issues.apache.org/jira/rest/api/2/issue/12686466","key":"AMQ-4957","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-01-22T02:12:51.820+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Feb 11 05:04:46 UTC 2015","customfield_12310420":"365457","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4957/watchers","watchCount":3,"isWatching":false},"created":"2013-12-26T20:59:14.763+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-02-11T05:04:46.628+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313893","id":"12313893","name":"Connector"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When using the LDAP discovery agent, if a non-failover URI containing a port number is specified in the ldapNetworkConnector for example:\n\n<networkConnectors>\n<ldapNetworkConnector uri=\"ldap://172.31.67.192:389\"\n                                        base=\"dc=tmts,dc=net\"\n                                        anonymousAuthentication=\"true\"\n                                        searchFilter=\"(!(cn=esb1))\"\n                                        searchScope=\"SUBTREE_SCOPE\"\n                                        dynamicOnly=\"true\"\n                                        networkTTL=\"2\"\n                                        prefetchSize=\"1\"\n                                        conduitSubscriptions=\"true\"\n                                        decreaseNetworkConsumerPriority=\"false\"\n                                         />\n</networkConnectors>\n\n\nThe following Java exception is seen in the log on startup and the broker never initialises:\n\n2013-12-26 13:40:40,919 | INFO  | Refreshing org.apache.activemq.xbean.XBeanBrokerFactory$1@2919c2af: startup date [Thu Dec 26 13:40:40 UTC 2013]; root of context hierarchy | org.apache.activemq.xbean.XBeanBrokerFactory$1 | main\n2013-12-26 13:40:44,231 | ERROR | Failed to load: class path resource [activemq.xml], reason: Error creating bean with name 'org.apache.activemq.xbean.XBeanBrokerService#0' defined in class path resource [activemq.xml]: Cannot create inner bean 'ldapNetworkConnector#4e2cb9f0' of type [org.apache.activemq.network.LdapNetworkConnector] while setting bean property 'networkConnectors' with key [0]; nested exception is org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'ldapNetworkConnector#4e2cb9f0' defined in class path resource [activemq.xml]: Error setting property values; nested exception is org.springframework.beans.PropertyBatchUpdateException; nested PropertyAccessExceptions (1) are:\nPropertyAccessException 1: org.springframework.beans.MethodInvocationException: Property 'uri' threw exception; nested exception is java.net.URISyntaxException: Illegal character in scheme name at index 0: 172.31.67.192:389 | org.apache.activemq.xbean.XBeanBrokerFactory | main\n\nIf the URI is changed to remove the port number the broker works fine. If the URI containing a port number is used in a failover transport specification, the broker also works fine.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"365758","customfield_12312823":null,"summary":"LDAP Network Connector does not allow port number in uri","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpwestern","name":"mpwestern","key":"mpwestern","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Western","active":true,"timeZone":"Asia/Baku"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpwestern","name":"mpwestern","key":"mpwestern","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Western","active":true,"timeZone":"Asia/Baku"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Centos 6.4, OpenLDAP 2.4","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12686466/comment/14286794","id":"14286794","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmfrazier","name":"mmfrazier","key":"mmfrazier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Frazier","active":true,"timeZone":"Etc/UTC"},"body":"I've been able to get a test case to work if the url is modified to \"static://ldap://<ip>:<port>\", and I think this is what was intended. The  code definitely assumes that there is a broker protocol to be stripped off in front of the ldap protocol (or any other for that matter).\n\nIt could be the documentation just needs to be update to show this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmfrazier","name":"mmfrazier","key":"mmfrazier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Frazier","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-22T02:12:51.820+0000","updated":"2015-01-22T02:12:51.820+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12686466/comment/14286999","id":"14286999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpwestern","name":"mpwestern","key":"mpwestern","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Western","active":true,"timeZone":"Asia/Baku"},"body":"Hi Mark\n\nMany thanks for your response.\n\nI tried using a broker protocol scheme of static in the LDAP URI (AMQ 5.9.0) as you mentioned in your comment and a \"malformed URL\" exception was logged by the broker:\n\n2015-01-22 09:49:25,062 | INFO  | connecting... | org.apache.activemq.network.LdapNetworkConnector | NetworkConnector Start Thread-0\n2015-01-22 09:49:25,062 | ERROR | Async start of network connector: org.apache.activemq.network.LdapNetworkConnectorNC[static://ldap://172.31.67.192:389] failed | org.apache.activemq.broker.BrokerService | NetworkConnector Start Thread-0\njavax.naming.NamingException: Cannot parse url: static://ldap://172.31.67.192:389 [Root exception is java.net.MalformedURLException: Not an LDAP URL: static://ldap://172.31.67.192:389]\n\tat com.sun.jndi.ldap.LdapURL.<init>(Unknown Source)\n\tat com.sun.jndi.ldap.LdapCtxFactory.getUsingURL(Unknown Source)\n\tat com.sun.jndi.ldap.LdapCtxFactory.getUsingURLs(Unknown Source)\n\tat com.sun.jndi.ldap.LdapCtxFactory.getLdapCtxInstance(Unknown Source)\n\tat com.sun.jndi.ldap.LdapCtxFactory.getInitialContext(Unknown Source)\n\tat javax.naming.spi.NamingManager.getInitialContext(Unknown Source)\n\tat javax.naming.InitialContext.getDefaultInitCtx(Unknown Source)\n\tat javax.naming.InitialContext.init(Unknown Source)\n\tat javax.naming.InitialContext.<init>(Unknown Source)\n\tat javax.naming.directory.InitialDirContext.<init>(Unknown Source)\n\tat org.apache.activemq.network.LdapNetworkConnector.start(LdapNetworkConnector.java:219)\n\tat org.apache.activemq.broker.BrokerService$8.run(BrokerService.java:2461)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: java.net.MalformedURLException: Not an LDAP URL: static://ldap://172.31.67.192:389\n\nMy LDAP configuration in the above test is:\n\n       <networkConnectors>\n            <ldapNetworkConnector uri=\"static://ldap://172.31.67.192:389\"\n                            base=\"dc=tmts,dc=net\"\n                            anonymousAuthentication=\"true\"\n                            searchFilter=\"(!(cn=esb1))\"\n                            searchScope=\"SUBTREE_SCOPE\"\n                            dynamicOnly=\"true\"\n                            networkTTL=\"2\"\n                            prefetchSize=\"1\"\n                            conduitSubscriptions=\"true\"\n                            decreaseNetworkConsumerPriority=\"false\"\n                            />       \n        </networkConnectors>\n\nPerhaps you were testing on a later version of AMQ? \n\nIrrespective of the above, logically if the code was written to intend the broker protocol scheme name to be mandatory as you state then the URI form:\n\nldap://<ip> should also be rejected with an error by the code along with ldap://<ip>:<port>. \n\nHowever, currently the form ldap://<ip> is accepted. This seems a bit odd given thrust of your explanation.\n\nSo either way from my perspective there is a deficiency in the code such that the error checking of the broker protocol scheme name is either not applied consistently or not applied correctly. It does not look like just a documentation issue to me.\n\nIn my own case I was using the failover protocol in production code, so the issue did not actually affect us - it was just something we discovered during testing of various configurations that we thought the Apache ActiveMQ team might want to be aware of.\n\nMany thanks for your help with this.\n\nMatthew\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpwestern","name":"mpwestern","key":"mpwestern","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Western","active":true,"timeZone":"Asia/Baku"},"created":"2015-01-22T05:59:21.384+0000","updated":"2015-01-22T05:59:21.384+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12686466/comment/14315573","id":"14315573","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmfrazier","name":"mmfrazier","key":"mmfrazier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Frazier","active":true,"timeZone":"Etc/UTC"},"body":"I agree, it doesn't seem consistent. I'll try to find what was actually intended and maybe fix the code.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mmfrazier","name":"mmfrazier","key":"mmfrazier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Frazier","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-11T05:04:46.628+0000","updated":"2015-02-11T05:04:46.628+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4957/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1qzpb:"}}