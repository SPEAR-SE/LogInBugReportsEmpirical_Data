{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483832","self":"https://issues.apache.org/jira/rest/api/2/issue/12483832","key":"AMQ-2584","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315625","id":"12315625","description":"","name":"5.4.2","archived":false,"released":true,"releaseDate":"2010-12-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-01-27T12:25:34.875+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Aug 23 19:11:38 UTC 2011","customfield_12310420":"14533","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_17455508567_*|*_5_*:*_3_*:*_5470794170_*|*_4_*:*_2_*:*_662719399","customfield_12312321":null,"resolutiondate":"2010-10-27T12:04:05.200+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2584/watchers","watchCount":3,"isWatching":false},"created":"2010-01-27T11:33:43.064+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315621","id":"12315621","description":"","name":"5.3.1","archived":false,"released":true,"releaseDate":"2010-03-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-08-23T19:11:38.798+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Hi,\n\ni am using activemq 5.3 (resp. 5.4 snapshot , 5.3.1 snapshot) with kahadb in following use-case:\n- 3 durable topic subscriber, each refuses message using session.recover(), 1 delivery attempts\n- ActiveMQ.DLQ consumer\n- persistent message topic producer\n\nIn such case deadletter consumer should consume every message sent, as soon as number of delivery attempts is reached and mmessage is sent to ActiveMQ.DLQ. Result is ok but kahadb data directory at the end contains all log files with names db-<number>.log ever created. They aren't deleted even after some time.\n\nI can also see following massege in console:\n\nWARN | Duplicate message add attempt rejected. Message id: ID:sk1d069c-3826-1264006781626\n-0:0:1:1:13425\n\nIf use-case is altered to use queue instead of topic log files are periodically deleted without WARN messages in console.\n\nSame behaviour (data files not cleaned) if amqPersistenceAdapter is used except of WARN messages.\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461601","id":"12461601","filename":"2584_test.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=durokuruc","name":"durokuruc","key":"durokuruc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juraj Kuruc","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-27T14:31:02.672+0000","size":10195,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461601/2584_test.zip"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461799","id":"12461799","filename":"AMQ2584Test.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"created":"2010-08-17T14:28:39.616+0000","size":8278,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461799/AMQ2584Test.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461797","id":"12461797","filename":"AMQ2584Test.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-16T16:54:51.359+0000","size":8089,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461797/AMQ2584Test.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461814","id":"12461814","filename":"UpdatedTestCase.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"created":"2010-10-20T20:25:00.332+0000","size":9162,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461814/UpdatedTestCase.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"63670","customfield_12312823":null,"summary":"Massege store is not cleaned when durable topic subscribers are refusing messages ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=durokuruc","name":"durokuruc","key":"durokuruc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juraj Kuruc","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=durokuruc","name":"durokuruc","key":"durokuruc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juraj Kuruc","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"WinXP,\njava version \"1.6.0_05\"\nJava(TM) SE Runtime Environment (build 1.6.0_05-b13)\nJava HotSpot(TM) Client VM (build 10.0-b19, mixed mode, sharing)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12942079","id":"12942079","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"\nCould you attach a test case to this?\n\nI have just tracked down the cause of the:\n WARN | Duplicate message add attempt rejected. Message id: ID:sk1d069c-3826-1264006781626-0:0:1:1:13425\nbut I don't think this could result in dangling references to files in the store. \nSo i suspect the there is another reason for the data files not being cleaned up. At simple test case would help a lot.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-27T12:25:34.875+0000","updated":"2010-01-27T12:25:34.875+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12942080","id":"12942080","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=durokuruc","name":"durokuruc","key":"durokuruc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juraj Kuruc","active":true,"timeZone":"Etc/UTC"},"body":"Find attached java files, sample message and configuration file activemq.xml  for  reproducing this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=durokuruc","name":"durokuruc","key":"durokuruc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Juraj Kuruc","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-27T14:31:02.736+0000","updated":"2010-01-27T14:31:02.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12938684","id":"12938684","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"junit test case based on submitted test but borrowing from the junit test case attached to https://issues.apache.org/activemq/browse/AMQ-2870\n\nThis test case works fine on trunk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-16T16:54:51.410+0000","updated":"2010-08-16T16:54:51.410+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12938717","id":"12938717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The difference may be the use of a small journal data file length such that the files are quickly reclaimed when the contain unreferenced data. With a large file all the messages can exist in one or two data files.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-16T16:56:26.842+0000","updated":"2010-08-16T16:56:26.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12938313","id":"12938313","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Try the new test case, if you can make that fail, please reopen","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-17T12:18:51.574+0000","updated":"2010-08-17T12:18:51.574+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12938125","id":"12938125","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"body":"Hey Gary, I modified the test case to use multiple consumers, I think that's when this seems to break, what do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"created":"2010-08-17T14:28:39.667+0000","updated":"2010-08-17T14:28:39.667+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12938424","id":"12938424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"need to look at it in some detail.. guess you should reopen this pending that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-17T14:52:20.211+0000","updated":"2010-08-17T14:52:20.211+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12938225","id":"12938225","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"body":"Yup, sure thing Gary.  Haven't had time to look at it other than updating the test case, but I think it's still an issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"created":"2010-08-17T14:58:24.438+0000","updated":"2010-08-17T14:58:24.438+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12938498","id":"12938498","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"got to the bottom of this. Both stores left dangling references to data files when a journal add was suppressed as a duplicate by the index or reference store.\nIn the AMQ case, the bug was a little subtler as it only occurred if a batched write to the journal was pending when the duplicate occurs.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-18T15:24:57.917+0000","updated":"2010-08-18T15:24:57.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12943082","id":"12943082","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"body":"Looks like there's still a case this issue can occur, namely if the consumers and DLQ consumer consumes messages concurrently.  Here's a patch that updates the existing test which will then show this other case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"created":"2010-10-20T20:25:00.389+0000","updated":"2010-10-20T20:25:00.389+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12943139","id":"12943139","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"A workaround for this issue, where the DLQ can receive duplicates, is to disable the cursor message audit for the DLQ.\n{code}<policyEntry queue=ActiveMQ.DLQ\" enableAudit=\"false\" />{code}\n\nAn enhancement, to allow a DLQ per durable subscription would make it possible to track which durable subscription rejected a message on an individual basis:\nhttps://issues.apache.org/activemq/browse/AMQ-3003","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-27T12:04:05.104+0000","updated":"2010-10-27T12:04:05.104+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12943154","id":"12943154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"additionally, {code}concurrentStoreAndDispatchQueues=false{code} must be added to the kahaDB persistence adapter to allow it to correctly ack the duplicates that ensue. Otherwise there can be the occasional missed ack. This needs more investigation to see if it can be made work reliably with the default value.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-28T12:40:22.007+0000","updated":"2010-10-28T12:40:22.007+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/12943165","id":"12943165","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Final resolution is to suppress duplicate dispatch to the DLQ at source, in the DeadLetterStrategy implementation by having it keep an audit. In this way, only one copy of a message is dispatched to the DLQ, irrespective of how many durable consumers reject the message. AMQ-3003 will help with that.\nMost duplicates are trapped by the store, but when the store has already acked the original, it can get through, the potential problem is the pending cursor of messages to dispatch. When concurrent with store, this can result in a missed dispatch and a subsequent missing ack leaving a dangling message.\nSuppressing the duplicate send in the deadletter strategy removes this possibility.\nFix in r1030013","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-11-02T13:07:01.295+0000","updated":"2010-11-02T13:07:01.295+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/13062371","id":"13062371","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larhvi","name":"larhvi","key":"larhvi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hvile","active":true,"timeZone":"Etc/UTC"},"body":"I'm having a problem where messages fails to enter the DLQ. My scenario is:\n\n1. some message fails during processing and ends up on the DLQ\n2. it's moved back to its original queue, but fails again\n3. message not sent back to the DLQ\n\nAfter some googling I found this issue, and I suspect you may have introduced a bug in AbstractDeadLetterStrategy by adding the duplication-checks. (http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/broker/region/policy/AbstractDeadLetterStrategy.java?r1=1030013&r2=1030012&pathrev=1030013).\n\nI'm seeing the debug log-entry when messages are lost..\n2011-07-09 14:59:07,177 | DEBUG | rollback: TX:ID:ubuntu-48335-1310214645889-0:1:18 syncCount: 2 | org.apache.activemq.transaction.LocalTransaction | ActiveMQ Transport: tcp:///127.0.0.1:59188\n2011-07-09 14:59:07,178 | DEBUG | Not adding duplicate to DLQ: ID:ubuntu-58129-1310214649907-0:1:9:1:5, dest: queue://xxxx | org.apache.activemq.broker.region.policy.AbstractDeadLetterStrategy | ActiveMQ Transport: tcp:///127.0.0.1:59188\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larhvi","name":"larhvi","key":"larhvi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hvile","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-09T13:09:06.055+0000","updated":"2011-07-09T13:09:06.055+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/13063234","id":"13063234","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Lars, yes, the audit should be configurable, such that is it possible to disable. I will expose the option on the default DLQ strategy.\n\nbtw: How do you achieve 2), is it a manual process or do you use a camel route or something else? Any chance you have a test case?\n\nThe addition of https://issues.apache.org/jira/browse/AMQ-3003 provides an alternative way of avoiding duplicate submission to the DLQ in the scenario described in this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-11T09:13:10.266+0000","updated":"2011-07-11T09:18:58.472+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/13063248","id":"13063248","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"new DeadLetterStrategy enableAudit attribute introduced in http://svn.apache.org/viewvc?rev=1145092&view=rev","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-11T09:50:47.963+0000","updated":"2011-07-11T09:50:47.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/13063310","id":"13063310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larhvi","name":"larhvi","key":"larhvi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hvile","active":true,"timeZone":"Etc/UTC"},"body":"I moved the messages using the admin interface (conf/jetty.xml).\n\n>> Any chance you have a test case?\nThis happens almost every time a message is moved back to the DLQ the 2nd time. Seems a little bit random though..\n\nUsing the new setting in #1145092 we can avoid message loss now, but shouldn't that be the default? I mean, if people are bothered by dups in the DLQ wouldn't it be better for them to enable the audit?\n\nBtw, when will this fix be released?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larhvi","name":"larhvi","key":"larhvi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Hvile","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-11T12:36:15.983+0000","updated":"2011-07-11T12:39:37.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/13089642","id":"13089642","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=carfey","name":"carfey","key":"carfey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Carey Flichel","active":true,"timeZone":"Etc/UTC"},"body":">> new DeadLetterStrategy enableAudit attribute introduced in http://svn.apache.org/viewvc?rev=1145092&view=rev\n\nGary, will this be configurable on the individualDeadLetterStrategy/sharedDeadLetterStrategy element or will it be derived from a policyEntry setting? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=carfey","name":"carfey","key":"carfey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Carey Flichel","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-23T18:23:41.661+0000","updated":"2011-08-23T18:23:41.661+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483832/comment/13089671","id":"13089671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"on a dead letter strategy, eg: {code}<policyEntry ..\">\n            <deadLetterStrategy>\n              <individualDeadLetterStrategy queuePrefix=\"Test.DLQ.\" processNonPersistent=\"true\" enableAudit=\"false\" />\n            </deadLetterStrategy>{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-23T19:11:38.758+0000","updated":"2011-08-23T19:11:38.758+0000"}],"maxResults":19,"total":19,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2584/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0b9m7:"}}