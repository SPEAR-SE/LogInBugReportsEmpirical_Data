{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13162383","self":"https://issues.apache.org/jira/rest/api/2/issue/13162383","key":"AMQ-6976","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341947","id":"12341947","name":"5.15.3","archived":false,"released":true,"releaseDate":"2018-02-01"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/10005","id":"10005","description":"Workaround","name":"Workaround"},"customfield_12312322":null,"customfield_12310220":"2018-05-29T11:18:54.995+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jul 16 12:27:29 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_4234933694_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-07-16T12:28:37.115+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6976/watchers","watchCount":2,"isWatching":false},"created":"2018-05-28T12:06:23.458+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341947","id":"12341947","name":"5.15.3","archived":false,"released":true,"releaseDate":"2018-02-01"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-16T12:28:37.143+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We are running a so called \"Shared Nothing\" setup with several Wildfly 8.2.1 instances (10) on several host machines (4)- all connected to one standalone Activemq installation - Normally we have  600-700 connections in total to our broker.\r\n\r\nThe Activemq installation is configured to use 8GB RAM.\r\n{code:java}\r\n<broker xmlns=\"http://activemq.apache.org/schema/core\" brokerName=\"dcdng\" id=\"dcdng\" useJmx=\"true\" useShutdownHook=\"false\"\r\nschedulerSupport=\"false\" dataDirectory=\"C:/activemq/data\" advisorySupport=\"false\">\r\n\r\n<managementContext>\r\n<managementContext createConnector=\"true\" connectorPort=\"61610\" suppressMBean=\"endpoint=dynamicProducer,endpoint=Consumer,connectionName=*,destinationName=ActiveMQ.Advisory.*\"/>\r\n</managementContext>\r\n <!-- ... -->\r\n</broker>{code}\r\nThe memory usage is set to 500mb which is sufficient since our messages are relative small. (MaxMessageSize: 41442)\r\n\r\n \r\n\r\nThe system performs great until we put it under high load. Then the heap usage grows and it seems the memory cannot get cleaned up properly. \r\n\r\n !image-2018-05-28-16-23-36-564.png! \r\n\r\nAt the end I took a heap dump and the MAT prints the following:\r\n\r\n!image-2018-05-28-13-54-21-048.png!\r\n\r\nSo why are there so many TransportConnectionState objects left an not cleaned up properly. When the system performs under \"normal\" load, everything seems to be fine.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12925406","id":"12925406","filename":"image-2018-05-28-13-54-21-048.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lemarkus","name":"lemarkus","key":"lemarkus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34045","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"},"displayName":"Markus L.","active":true,"timeZone":"Europe/Berlin"},"created":"2018-05-28T11:54:25.802+0000","size":119663,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12925406/image-2018-05-28-13-54-21-048.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12925439","id":"12925439","filename":"image-2018-05-28-16-23-36-564.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lemarkus","name":"lemarkus","key":"lemarkus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34045","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"},"displayName":"Markus L.","active":true,"timeZone":"Europe/Berlin"},"created":"2018-05-28T14:23:37.608+0000","size":203089,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12925439/image-2018-05-28-16-23-36-564.png"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"GC goes crazy under load. Heap is filled up with TransportConnectionState objects","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lemarkus","name":"lemarkus","key":"lemarkus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34045","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"},"displayName":"Markus L.","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lemarkus","name":"lemarkus","key":"lemarkus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34045","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"},"displayName":"Markus L.","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows Server 2012 R2 - 64bit\r\n230 GB RAM\r\nSSD HD","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162383/comment/16493392","id":"16493392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"The TransportConnectionState objects are added with a new connection and then removed when the connection is removed inside the TransportConnection class.  Are you creating a lot of new connections and then not closing them properly?  You will probably need to do some more debugging to see why there are so many connection state objects being created and not removed.  I would start with https://github.com/apache/activemq/blob/activemq-5.15.3/activemq-broker/src/main/java/org/apache/activemq/broker/TransportConnection.java\r\n\r\nIt might also help to look at a thread dump to make sure nothing is stuck.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-05-29T11:18:54.995+0000","updated":"2018-05-29T11:18:54.995+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162383/comment/16493417","id":"16493417","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lemarkus","name":"lemarkus","key":"lemarkus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34045","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"},"displayName":"Markus L.","active":true,"timeZone":"Europe/Berlin"},"body":"We are using the RAR Connection Pool approach and therefore the connections will stay open \"forever\" and are reused by several processes. May this be a problem? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lemarkus","name":"lemarkus","key":"lemarkus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34045","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"},"displayName":"Markus L.","active":true,"timeZone":"Europe/Berlin"},"created":"2018-05-29T11:34:44.174+0000","updated":"2018-05-29T11:34:44.174+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162383/comment/16493628","id":"16493628","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"It could be something to do with that but I personally haven't looked too much at how the RAR pool was designed or setup.  I would take a closer look at how the RAR stuff is configured and see if you can tune it to not create so many connections or to maybe identify a bug somewhere with the connections not being properly removed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-05-29T14:46:35.203+0000","updated":"2018-05-29T14:46:35.203+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13162383/comment/16545142","id":"16545142","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lemarkus","name":"lemarkus","key":"lemarkus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34045","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"},"displayName":"Markus L.","active":true,"timeZone":"Europe/Berlin"},"body":"We figured out that we were using several connection factories for different queues/topics together with the \"is-same-rm-override\" flag NOT set.\r\nIf we enable this flag by setting it to false, everything works fine. \r\nAnother solution would be to use the same connection factory for all queues and topics.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lemarkus","name":"lemarkus","key":"lemarkus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34045","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34045","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34045","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34045"},"displayName":"Markus L.","active":true,"timeZone":"Europe/Berlin"},"created":"2018-07-16T12:27:29.375+0000","updated":"2018-07-16T12:27:29.375+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6976/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3u847:"}}