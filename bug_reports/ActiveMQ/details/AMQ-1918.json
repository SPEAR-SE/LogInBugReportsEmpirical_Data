{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482815","self":"https://issues.apache.org/jira/rest/api/2/issue/12482815","key":"AMQ-1918","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-09-04T14:34:24.767+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue May 26 08:50:28 UTC 2009","customfield_12310420":"75173","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_605128911_*|*_5_*:*_3_*:*_1468068812_*|*_4_*:*_2_*:*_21320895219","customfield_12312321":null,"resolutiondate":"2009-05-26T08:50:28.827+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1918/watchers","watchCount":3,"isWatching":false},"created":"2008-08-28T14:28:55.885+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-05-26T08:50:28.826+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"In version 5.1.0, we are seeing our queue consumers stop consuming for no reason.\nWe have a staged queue environment and we occasionally see one queue display negative pending message counts that hang around -x, rise to -x+n gradually and then fall back to -x abruptly. The messages are building up and being processed in bunches but its not easy to see because the counts are negative. We see this behavior in the messages coming out of the system. Outbound messages come out in bunches and are synchronized with the queue pending count dropping to -x.\n\nThis issue does not happen ALL of the time. It happens about once a week and the only way to fix it is to bounce the broker. It doesn't happen to the same queue everytime, so it is not our consuming code.\n\nAlthough we don't have a reproducible scenario, we have been able to debug the issue in our test environment.\nWe traced the problem to the cached store size in the AbstractStoreCursor.\nThis value becomes 0 or negative and prevents the AbstractStoreCursor from retrieving more messages from the store. (see AbstractStoreCursor.fillBatch() )\nWe have seen size value go lower than -1000.\nWe have also forced it to fix itself by sending in n+1 messages. Once the size goes above zero, the cached value is refreshed and things work ok again.\nUnfortunately, during low volume times, it could be hours before n+1 messages are received, so our message latency can rise during low volume times.... :(\n\nI have attached our broker config.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461185","id":"12461185","filename":"ASF.LICENSE.NOT.GRANTED--activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-28T14:28:55.948+0000","size":5819,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12461185/ASF.LICENSE.NOT.GRANTED--activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461461","id":"12461461","filename":"NegativeQueueCursorSupport.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-30T16:58:03.703+0000","size":14966,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461461/NegativeQueueCursorSupport.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461199","id":"12461199","filename":"testAMQMessageStore.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-28T22:16:46.028+0000","size":4735369,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461199/testAMQMessageStore.zip"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461112","id":"12461112","filename":"testdata.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nic.tanase","name":"nic.tanase","key":"nic.tanase","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nicusor Tanase","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-24T10:59:24.652+0000","size":160185,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461112/testdata.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161470","customfield_12312823":null,"summary":"AbstractStoreCursor.size gets out of synch with Store size and blocks consumers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940110","id":"12940110","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"I have a reproducible scenario for this issue.\nI cannot guarantee that this is how it always happens, but AbstractStoreCursor.size does go negative everytime I follow this procedure.\nI am sorry I could not make it into a nice little test case. I tried to break it down as best I could.\n\nI wrapped up my eclipse project. It has 2 consumers, and 2 producers.\nproducer_flood sends a larger number of messages to test.queue.1 every 3 seconds\nproducer_steady sends a small number of messages to test.queue.1 every 3 seconds\nconsumer1 consumes messages off test.queue.1 and forwards them to test.queue.2\nconsumer2 consumes messages off test.queue.2 and prints text to system.out\nMy broker config file is included in the amq_broker_config dir. It sets the memory limits low so that they can be reached faster.\nThe queues are setup for 1MB each and the broker is setup for 3MB.\n\nHere is the script:\n1) Start a clean broker\n2) Start consumer1 and consumer2\n3) Start producer_flood - this will push messages in faster than consumer1 can handle. \nLet the queue size build up to 1000 messages. This should be 100% of the 1MB allowed for that queue.\n4) Stop consumer2 - this will allow messages to build up in queue2. \nIf you watch this queue in a jconsole, you will notice that the percent memory used does not rise, even after you pass the memory limit.\nLet the queue2 size grow to around 2000.\nThis will put you near the memory limit for the broker.\n5) Start consumer2 - if you look at jconsole now, the percent memory used is updated and > 100%.\n6) Wait for queue2 to fall below 1000 messages and stop the producer. Let the messages drain and one or both of the queues should now have negative counts. \n7) If you start the producer_steady now you'll notice that messages do not reach consumer2 at the rate that they go in.\n\tIf you debug the broker now and look at AbstractStoreCursor.size, it will be negative. \n\t\nPlease let me know if you need more info.\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-28T22:13:06.051+0000","updated":"2008-08-28T22:13:06.051+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940114","id":"12940114","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"eclipse project with test files","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-28T22:16:46.112+0000","updated":"2008-08-28T22:16:46.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940133","id":"12940133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Thanks Richard - I can't reproduce on Trunk - so I'm going to mark it fixed in 5.2 - if its still a problem - reopen and I'll investigate further","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-04T14:34:24.767+0000","updated":"2008-09-04T14:34:24.767+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940121","id":"12940121","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"I tested with apache-activemq-5.2-20080903.231704-53 and was able to reproduce problem.\nIs there much code difference between yesterday's snapshot on trunk?\nI'll try the snapshot tomorrow to be sure.\n\nDid you happen to try the scenario against 5.1? If so, were you able to reproduce?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-04T15:11:03.137+0000","updated":"2008-09-04T15:11:03.137+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940177","id":"12940177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"I tested the same scenario against activemq-5.2-SNAPSHOT-20080904.231544-55.\nI was able to reproduce the error.\nIs it possible the code you test on trunk was different than what is in the snapshots?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-05T15:55:37.100+0000","updated":"2008-09-05T15:55:37.100+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940231","id":"12940231","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"This is a timing issue - so its been difficult for me to reproduce on any version. I'll try get a slower box","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-23T05:34:40.803+0000","updated":"2008-09-23T05:34:40.803+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940248","id":"12940248","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nic.tanase","name":"nic.tanase","key":"nic.tanase","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nicusor Tanase","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nYou can use the test cases from the attached archive to reproduce the problem.\njmeterjms_nic-1.0.jar - modified version of the existing JMS sampler from JMeter project\nJMS Request Only.jmx - test plan for sender\nJMS Receive Only.jmx - test plan for receiver.\nYou need to use version 2.3.3 of Jmeter and replace ApacheJMeter_jms.jar with the modified one.\n\nSampler code is not closing the connections, so you need to restart Jmeter clients between tests.\nI hope the JMS sampler will make testing easier.\n\nI consistently get the following problem, using the attached test cases (actual figures may vary).\nThe broker is configured to use Oracle10 for persistence. I have created a trigger that copies the records deleted from ACTIVEMQ_MSGS into ACTIVEMQ_HISTORY table so I can see what has been produced and consumed at the persistence layer.\n\n\n1. Start Jmeter with 3 producer threads each sending 3333 messages\n2. Start Jmeter with a consumer thread.\n3. Let the producers finish (9999 messages sent to the broker)\n4. Wait for consumer to fetch all 9999 messages.\n5. Consumer stops receiving after 9860 messages (as reported by Jmeter Summary Report).\n6. Table ACTIVEMQ_MSGS contains 304 messages.\n7. Table ACTIVEMQ_HISTORY contains 9695 messages.\n8. JMX statistics show that the queue contains 139 messages.\n9. Trying to browse the queue via JConsole does not return any messages.\n\nNic\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nic.tanase","name":"nic.tanase","key":"nic.tanase","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nicusor Tanase","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-24T10:59:24.704+0000","updated":"2008-09-24T10:59:24.704+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940278","id":"12940278","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nic.tanase","name":"nic.tanase","key":"nic.tanase","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nicusor Tanase","active":true,"timeZone":"Etc/UTC"},"body":"I found a way to work around this issue, by changing the way messages are loaded from the database.\nI ran tests with several queues, producers and consumers and did not get any undelivered messages anymore.\n\nDefaultJDBCAdapter.doRecoverNextMessages() recovers the messages with ID higher then the last recovered messages.\nThe SQL statement is:\n{code:title=org.apache.activemq.store.jdbc.Statements.java|borderStyle=solid}\nfindNextMessagesStatement = \"SELECT ID, MSG FROM \" + getFullMessageTableName()\n                                        + \" WHERE CONTAINER=? AND ID > ? ORDER BY ID\";\n{code}\nHowever, it can happen that messages with lower id are inserted into the DB after messages with higher IDs. \nSuch messages do not get recovered from DB.\n\nI have changed on my local copy the DefaultJDBCAdapter to act retroactive, looking back {{maxReturned}} rows for any missed messages.\nAnyway, I am not familiar with ActiveMQ code, so you might want to have a look at the modified DefaultJDBCAdapter.doRecoverNextMessages() bellow:\n\n{code:title=org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.java|borderStyle=solid}\n   public class DefaultJDBCAdapter implements JDBCAdapter {\n\n   private Set<Long> lastRecoveredMessagesIds = new TreeSet<Long>();\n   -------------------------------------------------------\n\n    public void doRecoverNextMessages(TransactionContext c, ActiveMQDestination destination, long nextSeq,\n                                      int maxReturned, JDBCMessageRecoveryListener listener) throws Exception {\n        PreparedStatement s = null;\n        ResultSet rs = null;\n        long id = 0;\n        List<Long> cleanupIds = new ArrayList<Long>();\n        int index = 0;\n        try {\n            s = c.getConnection().prepareStatement(statements.getFindNextMessagesStatement());\n            s.setMaxRows(maxReturned*2);\n            s.setString(1, destination.getQualifiedName());\n            s.setLong(2, nextSeq - maxReturned);\n            rs = s.executeQuery();\n            int count = 0;\n            if (statements.isUseExternalMessageReferences()) {\n                while (rs.next() && count < maxReturned) {\n                \tid = rs.getLong(1);\n                \tif ( lastRecoveredMessagesIds.contains(id) ) {\n                \t\t// this message was already recovered\n                \t\tcleanupIds.add(id);\n                \t\tcontinue;\n                \t}                \t\n                    if (listener.recoverMessageReference(rs.getString(1))) {\n                        count++;\n                        lastRecoveredMessagesIds.add(id);\n                    } else {\n                        LOG.debug(\"Stopped recover next messages\");\n                    }\n                }\n            } else {\n                while (rs.next() && count < maxReturned) {\n                \tid = rs.getLong(1);\n                \tif ( lastRecoveredMessagesIds.contains(id) ) {\n                \t\t// this message was already recovered\n                \t\tcleanupIds.add(id);\n                \t\tcontinue;\n                \t}\n                    if (listener.recoverMessage(rs.getLong(1), getBinaryData(rs, 2))) {\n                        count++;\n                        lastRecoveredMessagesIds.add(id);\n                    } else {\n                        LOG.debug(\"Stopped recover next messages\");\n                    }\n                }\n            }\n            \n            //not cleanup the list of recovered messages\n            index = 0;\n            Iterator<Long> it = cleanupIds.iterator();\n            while (it.hasNext() && index < count) {\n            \tlastRecoveredMessagesIds.remove(it.next());\n            }\n            \n            \n        } catch (Exception e) {\n            e.printStackTrace();\n        } finally {\n            close(rs);\n            close(s);\n        }\n    }\n\n}\n{code}\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nic.tanase","name":"nic.tanase","key":"nic.tanase","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nicusor Tanase","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-26T11:05:56.305+0000","updated":"2008-09-26T11:05:56.305+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940414","id":"12940414","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The following fix may be relevant, the root cause was the cursor and store being out of sync like you describe in the description.\nhttps://issues.apache.org/activemq/browse/AMQ-1984","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-03T17:44:06.924+0000","updated":"2008-11-03T17:44:06.924+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940619","id":"12940619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Fixed by SVN revision 729803","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-28T23:13:57.818+0000","updated":"2008-12-28T23:13:57.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940657","id":"12940657","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"I applied my test scenario to apache-activemq-5.3-20090113.084327-5.\nIt was actually worse.\nI still got a negative queue.\nAnd I was unable to consume from or produce to queue1. \nThe queue was left with 131 messages that consumer1 will not consume, even after I stop and restart the consumer.\nI ran my producers and no messages are added to queue1.\n\nI restarted the broker and the 131 messages were consumed.\nThe following error was in the log:\nERROR Service                        - Async error occurred: javax.jms.JMSException: Unmatched acknowledege: MessageAck {comm\nandId = 839, responseRequired = false, ackType = 2, consumerId = ID:vibes-richyarger-1501-1231882347001-0:0:2:1, firstMessage\nId = null, lastMessageId = ID:vibes-richyarger-3948-1231881217090-0:5200:1:1:1, destination = queue://test.queue.1, transacti\nonId = TX:ID:vibes-richyarger-1501-1231882347001-0:0:138, messageCount = 1}; Could not find Message-ID ID:vibes-richyarger-39\n48-1231881217090-0:5200:1:1:1 in dispatched-list (end of ack)\njavax.jms.JMSException: Unmatched acknowledege: MessageAck {commandId = 839, responseRequired = false, ackType = 2, consumerI\nd = ID:vibes-richyarger-1501-1231882347001-0:0:2:1, firstMessageId = null, lastMessageId = ID:vibes-richyarger-3948-123188121\n7090-0:5200:1:1:1, destination = queue://test.queue.1, transactionId = TX:ID:vibes-richyarger-1501-1231882347001-0:0:138, mes\nsageCount = 1}; Could not find Message-ID ID:vibes-richyarger-3948-1231881217090-0:5200:1:1:1 in dispatched-list (end of ack)\n\n        at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:439)\n        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:192)\n        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:377)\n        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)\n        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)\n        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)\n        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)\n        at java.lang.Thread.run(Thread.java:595)\n\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-13T21:40:34.317+0000","updated":"2009-01-13T21:40:34.317+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12940668","id":"12940668","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"I also have the following errors during startup:\nERROR Service                        - Async error occurred: javax.jms.JMSException: Transaction 'TX:ID:vibes-richyarger-1501\n-1231882347001-0:0:1' has not been started.\njavax.jms.JMSException: Transaction 'TX:ID:vibes-richyarger-1501-1231882347001-0:0:1' has not been started.\n        at org.apache.activemq.broker.TransactionBroker.getTransaction(TransactionBroker.java:270)\n        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:190)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)\n        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)\n        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)\n        at java.lang.Thread.run(Thread.java:595)\nERROR Service                        - Async error occurred: javax.jms.JMSException: Could not correlate acknowledgment with\ndispatched message: MessageAck {commandId = 25, responseRequired = false, ackType = 3, consumerId = ID:vibes-richyarger-1501-\n1231882347001-0:0:1:1, firstMessageId = null, lastMessageId = ID:vibes-richyarger-3948-1231881217090-0:5298:1:1:1, destinatio\nn = queue://test.queue.1, transactionId = null, messageCount = 1}\njavax.jms.JMSException: Could not correlate acknowledgment with dispatched message: MessageAck {commandId = 25, responseRequi\nred = false, ackType = 3, consumerId = ID:vibes-richyarger-1501-1231882347001-0:0:1:1, firstMessageId = null, lastMessageId =\n ID:vibes-richyarger-3948-1231881217090-0:5298:1:1:1, destination = queue://test.queue.1, transactionId = null, messageCount\n= 1}\n        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:330)\n        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:377)\n        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)\n        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)\n        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)\n        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)\n        at java.lang.Thread.run(Thread.java:595)\nINFO  WebConsoleStarter              - ActiveMQ WebConsole initialized.\nERROR Service                        - Async error occurred: javax.jms.JMSException: Unmatched acknowledege: MessageAck {comm\nandId = 49, responseRequired = false, ackType = 2, consumerId = ID:vibes-richyarger-1501-1231882347001-0:0:2:1, firstMessageI\nd = null, lastMessageId = ID:vibes-richyarger-3948-1231881217090-0:4731:1:1:1, destination = queue://test.queue.1, transactio\nnId = TX:ID:vibes-richyarger-1501-1231882347001-0:0:7, messageCount = 1}; Could not find Message-ID ID:vibes-richyarger-3948-\n1231881217090-0:4731:1:1:1 in dispatched-list (end of ack)\njavax.jms.JMSException: Unmatched acknowledege: MessageAck {commandId = 49, responseRequired = false, ackType = 2, consumerId\n = ID:vibes-richyarger-1501-1231882347001-0:0:2:1, firstMessageId = null, lastMessageId = ID:vibes-richyarger-3948-1231881217\n090-0:4731:1:1:1, destination = queue://test.queue.1, transactionId = TX:ID:vibes-richyarger-1501-1231882347001-0:0:7, messag\neCount = 1}; Could not find Message-ID ID:vibes-richyarger-3948-1231881217090-0:4731:1:1:1 in dispatched-list (end of ack)\n        at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:439)\n        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:192)\n        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:377)\n        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)\n        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)\n        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)\n        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)\n        at java.lang.Thread.run(Thread.java:595)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-13T21:42:52.539+0000","updated":"2009-01-13T21:42:52.539+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12941084","id":"12941084","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"I have created a unit test that can reproduce the issue.\nIt takes around 5 min to complete.\n\nI modeled the test off of the CursorSupport test case.\nI just added a second queue and more specific memory settings.\nI also included tests with different prefetch values.\nLowering prefetch seems to have a direct impact on the issue.\n\ntestWithDefaultPrefetch() and testWithDefaultPrefetchFiveConsumers()\nare usually the ones to fail.\n \nI am reproducing the issue quite easily with this test case.\nSo let me know if you cannot.\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-30T16:58:03.770+0000","updated":"2009-03-30T16:58:03.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12941081","id":"12941081","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"I also noticed another ticket that is most likely related to this issue: AMQ-1940.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-30T17:00:44.398+0000","updated":"2009-03-30T17:00:44.398+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12941088","id":"12941088","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=npfistner","name":"npfistner","key":"npfistner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Norbert Pfistner","active":true,"timeZone":"Etc/UTC"},"body":"Maybe also our problem concerning hanging persistent JDBC Messages is related to this. Please see https://issues.apache.org/activemq/browse/AMQ-2184 for details.\nWe have to restart our Broker in our productive environment at least once every 24 h.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=npfistner","name":"npfistner","key":"npfistner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Norbert Pfistner","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-31T07:08:04.991+0000","updated":"2009-03-31T07:08:04.991+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12941117","id":"12941117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"body":"I should have mentioned that this test case has been written against tag 5.1.0.\nI have been debugging the code and I have some concerns about whether the unit test is producing the same issue that we are seeing in our production environment.\n\nWhile the unit test decrements the pending message count extra times and it goes negative,  it does not cause a cursor size to go negative.\n\nThe unit test is producing a negative queue because duplicate messages are being dispatched to the consumer from the RecoveryDispatch.\nPagedInMessages are cached in a RecoveryDispatch when a new subscriber is added.\nI was able to resolve the issue by adding a lock check to the Queue.iterate() method.\nWhich I thought was great until I saw that the RecoveryDispatch had been removed in later versions.\n\nI am going to run the unit test in trunk.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ryarger","name":"ryarger","key":"ryarger","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Richard Yarger","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-02T14:53:00.128+0000","updated":"2009-04-02T14:53:00.128+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482815/comment/12941374","id":"12941374","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Added test case in SVN revision 778622.\nLooks fixed with trunk on 26th May 2009","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-26T08:50:28.804+0000","updated":"2009-05-26T08:50:28.804+0000"}],"maxResults":17,"total":17,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1918/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rzyn:"}}