{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13147421","self":"https://issues.apache.org/jira/rest/api/2/issue/13147421","key":"AMQ-6937","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-04-17T15:24:02.707+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Apr 18 06:43:21 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6937/watchers","watchCount":2,"isWatching":false},"created":"2018-03-23T10:13:38.578+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341947","id":"12341947","name":"5.15.3","archived":false,"released":true,"releaseDate":"2018-02-01"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-04-18T06:43:21.154+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The ActiveMQ transport servers (e.g. TcpTransportServer) run the socket accept (java.net.ServerSocket#accept) in an infinite loop. The accept call can repeatedly fail with an exception spinning the CPU at full speed an filling up logs quickly.\r\n\r\nHere is an example of an exception that gets repeated indefinitely:\r\n\r\njava.net.SocketException: EDC5122I Input/output error. (Accept failed)\r\n    at java.net.ServerSocket.implAccept(ServerSocket.java:623)\r\n    at java.net.ServerSocket.accept(ServerSocket.java:582)\r\n    at org.apache.activemq.transport.tcp.TcpTransportServer.run(TcpTransportServer.java:351)\r\n    at java.lang.Thread.run(Thread.java:785)\r\n\r\nThis is a common problem on z/OS because the pattern of running accept in a loop is used in many open source projects. For example, here is the same issue in Derby:\r\n\r\nhttps://issues.apache.org/jira/browse/DERBY-5347\r\n\r\nAnd here in Jetty:\r\n\r\n[https://github.com/eclipse/jetty.project/issues/283]\r\n\r\nWhenever the problem appears the socket becomes unusable. Would it be possible for ActiveMQ to allow to insert a custom org.apache.activemq.transport.TransportAcceptListener that would detect the problem and do a re-bind on the socket?\r\n\r\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12919419","id":"12919419","filename":"AMQ-6937-cpu-spin-prevention.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpavelka","name":"tpavelka","key":"tpavelka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Tomas Pavelka","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-17T13:40:05.244+0000","size":9564,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12919419/AMQ-6937-cpu-spin-prevention.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Recycling TCP/IP stack on z/OS causes an infinite error loop in transport server","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpavelka","name":"tpavelka","key":"tpavelka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Tomas Pavelka","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpavelka","name":"tpavelka","key":"tpavelka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Tomas Pavelka","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13147421/comment/16440868","id":"16440868","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpavelka","name":"tpavelka","key":"tpavelka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Tomas Pavelka","active":true,"timeZone":"Etc/UTC"},"body":"I have discovered that the CPU spin loop can happen even on Linux: whenever the process runs out of file descriptors the accept enters a loop that spins the CPU at 100%. I have attached a patch that slows down exception handling in such case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpavelka","name":"tpavelka","key":"tpavelka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Tomas Pavelka","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-17T13:45:32.916+0000","updated":"2018-04-17T13:45:32.916+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13147421/comment/16441007","id":"16441007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"I'm not sure this is the best way to handle it.  For linux the best thing to do is set resource limits. You can set a max connection count below the configured file descriptors for the OS.  This will prevent that from happening.\r\n\r\nI'm not very familiar with z/OS so maybe someone else can comment on this issue for that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-04-17T15:24:02.707+0000","updated":"2018-04-17T15:24:02.707+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13147421/comment/16441979","id":"16441979","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpavelka","name":"tpavelka","key":"tpavelka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Tomas Pavelka","active":true,"timeZone":"Etc/UTC"},"body":"Thanks, I see it now. The number of open sockets will be capped by the code in org.apache.activemq.transport.tcp.TcpTransportServer#doHandleSocket so on Linux you are unlikely to run into the spin loop and even if you do it can be fixed by correctly setting up limits.\r\n\r\nThat would make this a z/OS only problem. In our installation the problem is quite common as people recycle the TCPIP stack often to make configuration changes which causes the infinite spin loop.\r\n\r\nUnfortunately I can't think of any other way to handle this and if I don't get the fix in mainline ActiveMQ I would have to run with a forked version which is something I would very much like to avoid...\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpavelka","name":"tpavelka","key":"tpavelka","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10445","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10445","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10445","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10445"},"displayName":"Tomas Pavelka","active":true,"timeZone":"Etc/UTC"},"created":"2018-04-18T06:43:21.154+0000","updated":"2018-04-18T06:43:21.154+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6937/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3rp13:"}}