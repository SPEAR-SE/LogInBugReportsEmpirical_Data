{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13076830","self":"https://issues.apache.org/jira/rest/api/2/issue/13076830","key":"AMQ-6697","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338054","id":"12338054","name":"5.15.0","archived":false,"released":true,"releaseDate":"2017-07-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12340366","id":"12340366","name":"5.14.6","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-06-02T15:47:48.558+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jun 05 07:05:48 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_12503566_*|*_4_*:*_1_*:*_8194010_*|*_5_*:*_1_*:*_0_*|*_6_*:*_1_*:*_943629","customfield_12312321":null,"resolutiondate":"2017-06-02T18:23:30.173+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6697/watchers","watchCount":4,"isWatching":false},"created":"2017-06-02T12:22:49.015+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12339772","id":"12339772","name":"5.14.5","archived":false,"released":true,"releaseDate":"2017-04-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-06-05T07:05:48.236+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12315706","id":"12315706","name":"stomp"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Reproducing the problem:\n* Receive a message via STOMP (+EDIT: on a subscription with ack:client-individual+)\n* Start a transaction\n* ACK -(or NACK)- the message within the transaction\n* Abort the transaction\n* ACK (or NACK) the message\n\nExpected behaviour:\n* The message is according to step #5 either ACKed or NACKed.\n\nObserved behaviour:\n* The message is neither ACKed nor NACKed, but stays in unacknowledged state\n* An exception is raised:\n org.apache.activemq.transport.stomp.ProtocolException: Unexpected ACK received for message-id [ID:(...)]\n        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompAck(ProtocolConverter.java:475)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:250)\n        at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:85)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215)\n        at java.lang.Thread.run(Thread.java:745)\n* an ERROR message is sent to the client\n\nAs far as I can tell this is caused by code in both onStompAck() and onStompNack():\nhttps://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blob;f=activemq-stomp/src/main/java/org/apache/activemq/transport/stomp/ProtocolConverter.java;h=b25860bf6895240c33a8643b6fcc731af126d32e;hb=refs/heads/master#l440\n\nWith a STOMP 1.1 ACK/NACK, ackId == null, so the message entry is taken out of this.pedingAcks (sic!).\nWhen the transaction is aborted the message entry is then not put back into this.pedingAcks, so any subsequent ACK/NACK will find pendingAck==null, therefore acked==false, raising an exception.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Aborting a STOMP 1.1 transaction after ACK/NACK leads to invalid state","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16034908","id":"16034908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This test seems to indicate that all is working as designed.\n\n{code}\n    @Test(timeout = 60000)\n    public void testTransactionRollback() throws Exception {\n        MessageProducer producer = session.createProducer(queue);\n        producer.send(session.createTextMessage(\"Hello\"));\n        producer.close();\n\n        String frame = \"STOMP\\n\" + \"login:system\\n\" + \"passcode:manager\\n\" +\n            \"accept-version:1.1\\n\" + \"host:localhost\\n\" + \"client-id:test\\n\" + \"\\n\" + Stomp.NULL;\n        stompConnection.sendFrame(frame);\n\n        String f = stompConnection.receiveFrame();\n        assertTrue(f.startsWith(\"CONNECTED\"));\n\n        QueueViewMBean queueView = getProxyToQueue(getQueueName());\n        assertEquals(1, queueView.getQueueSize());\n\n        frame = \"BEGIN\\n\" + \"transaction: tx1\\n\" + \"\\n\\n\" + Stomp.NULL;\n        stompConnection.sendFrame(frame);\n\n        frame = \"SUBSCRIBE\\n\" + \"destination:/queue/\" + getQueueName() + \"\\n\" +\n            \"id:12345\\n\" + \"ack:client\\n\\n\" + Stomp.NULL;\n        stompConnection.sendFrame(frame);\n\n        StompFrame received = stompConnection.receive();\n        assertTrue(received.getAction().equals(\"MESSAGE\"));\n\n        // ack it\n        frame = \"ACK\\n\" + \"transaction: tx1\\n\" + \"subscription:12345\\n\" + \"message-id:\" +\n                received.getHeaders().get(\"message-id\") + \"\\n\\n\" + Stomp.NULL;\n        stompConnection.sendFrame(frame);\n\n        // rollback first message\n        frame = \"ABORT\\n\" + \"transaction: tx1\\n\" + \"\\n\\n\" + Stomp.NULL;\n        stompConnection.sendFrame(frame);\n\n        assertEquals(1, queueView.getQueueSize());\n\n        // ack it\n        frame = \"ACK\\n\" + \"subscription:12345\\n\" + \"message-id:\" +\n                received.getHeaders().get(\"message-id\") + \"\\n\\n\" + Stomp.NULL;\n        stompConnection.sendFrame(frame);\n\n        assertTrue(\"Message not ack'd\", Wait.waitFor(new Wait.Condition() {\n\n            @Override\n            public boolean isSatisified() throws Exception {\n                return queueView.getQueueSize() == 0;\n            }\n        }));\n\n        String unsub = \"UNSUBSCRIBE\\n\" + \"destination:/queue/\" + getQueueName() + \"\\n\" +\n            \"receipt:1\\n\" + \"id:12345\\n\\n\" + Stomp.NULL;\n        stompConnection.sendFrame(unsub);\n\n        String receipt = stompConnection.receiveFrame();\n        assertTrue(receipt.contains(\"RECEIPT\"));\n    }\n{code}\n\nThe first thing I see wrong here is that you cannot NACK a message in a TX so that will definitely fail if you try and do it a second time as you've already NACK'd the message.  My guess is that your first ACK is not including the TXID in the ACK an thereby just ACK'ing the message outside the TX.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-06-02T15:47:48.558+0000","updated":"2017-06-02T15:47:48.558+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16034910","id":"16034910","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit bd8661796b190ef605458cdd7a0d90d9af4f51a0 in activemq's branch refs/heads/master from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bd86617 ]\n\nAMQ-6697 Adds a test to show that the described case works\n\nCorrectly ACK inside a TX and then Abort and then ACK again outside a TX\nto show that the broker will then mark the message as consumed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-02T15:50:32.177+0000","updated":"2017-06-02T15:50:32.177+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16034952","id":"16034952","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"body":"snipped the TCP traffic:\n\n => STOMP\n => accept-version:1.1\n => login:admin\n => passcode:password\n => \n<=  CONNECTED\n<=  server:ActiveMQ/5.14.5\n<=  heart-beat:0,0\n<=  session:ID:internal.ac.uk-46456-1496419320010-3:1\n<=  version:1.1\n<=  \n<=  \n => SEND\n => content-length:26\n => destination:/queue/some.queue\n => \n => 2017-06-02 17:02:15.192632SUBSCRIBE\n => ack:client-individual\n => destination:/queue/some.queue\n => id:1\n => \n<=  MESSAGE\n<=  content-length:26\n<=  expires:0\n<=  destination:/queue/some.queue\n<=  subscription:1\n<=  priority:4\n<=  message-id:ID\\cinternal.ac.uk-46456-1496419320010-3\\c1\\c-1\\c1\\c1\n<=  timestamp:1496419335195\n<=  \n<=  2017-06-02 17:02:15.192632\n => BEGIN\n => transaction:1\n => \n => ACK\n => message-id:ID\\cinternal.ac.uk-46456-1496419320010-3\\c1\\c-1\\c1\\c1\n => subscription:1\n => transaction:1\n => \n => ABORT\n => transaction:1\n => \n => ACK\n => message-id:ID\\cinternal.ac.uk-46456-1496419320010-3\\c1\\c-1\\c1\\c1\n => subscription:1\n => \n<=  ERROR\n<=  content-type:text/plain\n<=  message:Unexpected ACK received for message-id [ID\\cinternal.ac.uk-46456-1496419320010-3\\c1\\c-1\\c1\\c1]\n<=  \n<=  org.apache.activemq.transport.stomp.ProtocolException: Unexpected ACK received for message-id [ID:internal.ac.uk-46456-1496419320010-3:1:-1:1:1]\n<=  \tat org.apache.activemq.transport.stomp.ProtocolConverter.onStompAck(ProtocolConverter.java:475)\n<=  \tat org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:250)\n<=  \tat org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:85)\n<=  \tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n<=  \tat org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233)\n<=  \tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215)\n<=  \tat java.lang.Thread.run(Thread.java:748)\n<=  \n => ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"created":"2017-06-02T16:04:00.515+0000","updated":"2017-06-02T16:04:00.515+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16034955","id":"16034955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"body":"According to the spec both ACK and NACK can be used in transactions, so I wonder why you think otherwise. http://stomp.github.io/stomp-specification-1.1.html#NACK\nNot relevant to the problem at hand though.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"created":"2017-06-02T16:06:44.230+0000","updated":"2017-06-02T16:06:44.230+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16034972","id":"16034972","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Yes, it can be optionally, I should have been more clear, it can't be used in a TX in ActiveMQ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-06-02T16:16:07.812+0000","updated":"2017-06-02T16:16:07.812+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16034976","id":"16034976","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"You will need to create a unit test that shows an issue, testing on the broker shows it works as expected.  I can think of a couple client's that would have issues if it didn't as they rely on this.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-06-02T16:18:37.361+0000","updated":"2017-06-02T16:18:37.361+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16034989","id":"16034989","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"body":"Working on this now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"created":"2017-06-02T16:23:32.382+0000","updated":"2017-06-02T16:23:32.382+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16035010","id":"16035010","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"body":"Got it.\n\n{code}\ndiff --git a/activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/Stomp11Test.java b/activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/Stomp11Test.java\nindex f61c899..f4ce712 100644\n--- a/activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/Stomp11Test.java\n+++ b/activemq-stomp/src/test/java/org/apache/activemq/transport/stomp/Stomp11Test.java\n@@ -1150,7 +1150,7 @@ public class Stomp11Test extends StompTestSupport {\n         stompConnection.sendFrame(frame);\n \n         frame = \"SUBSCRIBE\\n\" + \"destination:/queue/\" + getQueueName() + \"\\n\" +\n-            \"id:12345\\n\" + \"ack:client\\n\\n\" + Stomp.NULL;\n+            \"id:12345\\n\" + \"ack:client-individual\\n\\n\" + Stomp.NULL;\n         stompConnection.sendFrame(frame);\n \n         StompFrame received = stompConnection.receive();\n{code}\n\nleads to\n\n{quote}\nTests run: 28, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 90.347 sec <<< FAILURE! - in org.apache.activemq.transport.stomp.Stomp11NIOSSLTest\ntestTransactionRollbackAllowsSecondAckOutsideTX(org.apache.activemq.transport.stomp.Stomp11NIOSSLTest)  Time elapsed: 30.193 sec  <<< FAILURE!\njava.lang.AssertionError: Message not ack'd\n\tat org.junit.Assert.fail(Assert.java:88)\n\tat org.junit.Assert.assertTrue(Assert.java:41)\n\tat org.apache.activemq.transport.stomp.Stomp11Test.testTransactionRollbackAllowsSecondAckOutsideTX(Stomp11Test.java:1175)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:498)\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n\tat org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:298)\n\tat org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:292)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:266)\n\tat java.lang.Thread.run(Thread.java:745)\n{quote}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"created":"2017-06-02T16:36:05.638+0000","updated":"2017-06-02T16:36:22.477+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16035011","id":"16035011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"body":"thanks for your clarification regarding NACK+TX","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"created":"2017-06-02T16:37:46.972+0000","updated":"2017-06-02T16:37:46.972+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16035179","id":"16035179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit e83bb6dc38ed793ead919e5d7d6d9146816c66a5 in activemq's branch refs/heads/master from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e83bb6d ]\n\nAMQ-6697 Preserve dispatched state on client-individual tx ack\n\nNeed to preserve the messages in the dispatched list when a\nclient-individual ack comes in so that on abort the state remains\ndispatched and the message can still be ack'd","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-02T18:19:57.987+0000","updated":"2017-06-02T18:19:57.987+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16035181","id":"16035181","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 8417ce537b2cb96965827ebfb793f31814ba1ddd in activemq's branch refs/heads/master from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8417ce5 ]\n\nAMQ-6697 Make the MBean explicitly final for java 7 support\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-02T18:21:02.319+0000","updated":"2017-06-02T18:21:02.319+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16035183","id":"16035183","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1c141eae409f87f5a2d8ffe1a5d8821882a614a0 in activemq's branch refs/heads/activemq-5.14.x from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1c141ea ]\n\nAMQ-6697 Adds a test to show that the described case works\n\nCorrectly ACK inside a TX and then Abort and then ACK again outside a TX\nto show that the broker will then mark the message as consumed.\n(cherry picked from commit bd8661796b190ef605458cdd7a0d90d9af4f51a0)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-02T18:22:16.273+0000","updated":"2017-06-02T18:22:16.273+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16035184","id":"16035184","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 0be8b63fde120aff68248cf0b10869c83ae7d21c in activemq's branch refs/heads/activemq-5.14.x from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=0be8b63 ]\n\nAMQ-6697 Preserve dispatched state on client-individual tx ack\n\nNeed to preserve the messages in the dispatched list when a\nclient-individual ack comes in so that on abort the state remains\ndispatched and the message can still be ack'd\n(cherry picked from commit e83bb6dc38ed793ead919e5d7d6d9146816c66a5)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-02T18:22:22.033+0000","updated":"2017-06-02T18:22:22.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16035185","id":"16035185","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit e38ac94a27347c89dddcd30c7a3e6063a69308dd in activemq's branch refs/heads/activemq-5.14.x from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e38ac94 ]\n\nAMQ-6697 Make the MBean explicitly final for java 7 support\n\n(cherry picked from commit 8417ce537b2cb96965827ebfb793f31814ba1ddd)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-02T18:22:28.139+0000","updated":"2017-06-02T18:22:28.139+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16035188","id":"16035188","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Fixed the individual ack case to not remove the dispatched message if it was in a TX when it was ack'd to preserve state on TX abort ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-06-02T18:23:30.208+0000","updated":"2017-06-02T18:23:30.208+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13076830/comment/16036616","id":"16036616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"body":"Confirmed that this fixes my problems. Thank you very much ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgerstel","name":"mgerstel","key":"mgerstel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=mgerstel&avatarId=32519","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=mgerstel&avatarId=32519","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=mgerstel&avatarId=32519","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=mgerstel&avatarId=32519"},"displayName":"Markus Gerstel","active":true,"timeZone":"Europe/London"},"created":"2017-06-05T07:05:48.215+0000","updated":"2017-06-05T07:05:48.215+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6697/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3ft07:"}}