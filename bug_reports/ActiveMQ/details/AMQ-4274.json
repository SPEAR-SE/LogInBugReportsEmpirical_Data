{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12629148","self":"https://issues.apache.org/jira/rest/api/2/issue/12629148","key":"AMQ-4274","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jan 24 21:38:49 UTC 2013","customfield_12310420":"308987","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2166194_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-01-24T21:38:49.770+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4274/watchers","watchCount":1,"isWatching":false},"created":"2013-01-24T21:02:43.607+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-01-24T21:38:49.794+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Its possible for an operation that's doing a send via oneway in FailoverTransport to deadlock with a Keep Alive write in the Inactivity Monitor.  \n\n{code}\nFound one Java-level deadlock:\n=============================\n\"U.GeoCodingIncBuilder.1\":\n  waiting for ownable synchronizer 0x00002aaac04e29e8, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),\n  which is held by \"ActiveMQ Session Task-42904\"\n\"ActiveMQ Session Task-42904\":\n  waiting for ownable synchronizer 0x00002ab3797e7348, (a java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync),\n  which is held by \"ActiveMQ InactivityMonitor Worker\"\n\"ActiveMQ InactivityMonitor Worker\":\n  waiting to lock monitor 0x00002ab729f36a70 (object 0x00002aaac04f11d8, a java.lang.Object),\n  which is held by \"ActiveMQ Session Task-42904\"\n\nJava stack information for the threads listed above:\n===================================================\n\"U.GeoCodingIncBuilder.1\":\n\tat sun.misc.Unsafe.park(Native Method)\n\t- parking to wait for  <0x00002aaac04e29e8> (a java.util.concurrent.locks.ReentrantLock$NonfairSync)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:747)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:778)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1114)\n\tat java.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:186)\n\tat java.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:262)\n\tat org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:66)\n\tat org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)\n\tat org.apache.activemq.ActiveMQConnection.doAsyncSendPacket(ActiveMQConnection.java:1290)\n\tat org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1284)\n\tat org.apache.activemq.ActiveMQSession.<init>(ActiveMQSession.java:252)\n\tat org.apache.activemq.ActiveMQConnection.createSession(ActiveMQConnection.java:332)\n\tat linqmap.ipc.impl.jms.SingleJmsFactory.createSession(SingleJmsFactory.java:492)\n\tat linqmap.ipc.impl.jms.SingleJmsFactory.createSendSession(SingleJmsFactory.java:318)\n\tat linqmap.ipc.impl.jms.JmsQueue.send(JmsQueue.java:117)\n\tat linqmap.ipc.queues.wrappers.AsyncSender$2.run(AsyncSender.java:81)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)\n\tat java.lang.Thread.run(Thread.java:619)\n\"ActiveMQ Session Task-42904\":\n\tat sun.misc.Unsafe.park(Native Method)\n\t- parking to wait for  <0x00002ab3797e7348> (a java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:747)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireShared(AbstractQueuedSynchronizer.java:877)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireShared(AbstractQueuedSynchronizer.java:1197)\n\tat java.util.concurrent.locks.ReentrantReadWriteLock$ReadLock.lock(ReentrantReadWriteLock.java:594)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor.oneway(AbstractInactivityMonitor.java:268)\n\tat org.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:85)\n\tat org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:104)\n\tat org.apache.activemq.transport.failover.FailoverTransport.oneway(FailoverTransport.java:640)\n\t- locked <0x00002aaac04f11d8> (a java.lang.Object)\n\tat org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)\n\tat org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)\n\tat org.apache.activemq.ActiveMQConnection.doAsyncSendPacket(ActiveMQConnection.java:1290)\n\tat org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1284)\n\tat org.apache.activemq.ActiveMQSession.asyncSendPacket(ActiveMQSession.java:1898)\n\tat org.apache.activemq.ActiveMQSession.sendAck(ActiveMQSession.java:2064)\n\tat org.apache.activemq.ActiveMQSession.sendAck(ActiveMQSession.java:2059)\n\tat org.apache.activemq.ActiveMQMessageConsumer.acknowledge(ActiveMQMessageConsumer.java:1061)\n\t- locked <0x00002aaac06c7280> (a java.util.LinkedList)\n\tat org.apache.activemq.ActiveMQSession.acknowledge(ActiveMQSession.java:1604)\n\tat org.apache.activemq.ActiveMQMessageConsumer$1.execute(ActiveMQMessageConsumer.java:552)\n\tat org.apache.activemq.command.ActiveMQMessage.acknowledge(ActiveMQMessage.java:97)\n\tat linqmap.ipc.impl.jms.JmsQueue.onMessage(JmsQueue.java:262)\n\tat org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1321)\n\t- locked <0x00002aaac06c0b70> (a java.lang.Object)\n\tat org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)\n\tat org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:202)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)\n\tat java.lang.Thread.run(Thread.java:619)\n\"ActiveMQ InactivityMonitor Worker\":\n\tat org.apache.activemq.transport.failover.FailoverTransport.handleTransportFailure(FailoverTransport.java:252)\n\t- waiting to lock <0x00002aaac04f11d8> (a java.lang.Object)\n\tat org.apache.activemq.transport.failover.FailoverTransport$3.onException(FailoverTransport.java:209)\n\tat org.apache.activemq.transport.TransportFilter.onException(TransportFilter.java:101)\n\tat org.apache.activemq.transport.WireFormatNegotiator.onException(WireFormatNegotiator.java:160)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor.onException(AbstractInactivityMonitor.java:295)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor$3.run(AbstractInactivityMonitor.java:168)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)\n\tat java.lang.Thread.run(Thread.java:619)\n\nFound 1 deadlock.\n\n{code}\n\nThe deadlock occurs when the write check task detects a failure and calls the onException method while holding the write lock side of the RW lock in the monitor.  Since the FailoverTransport holds its reconnect lock for the duration of the oneway call and the onException method of failover transport tries to lock that same mutex things can lock if the oneway call was waiting on the read lock side of the monitors R/W lock. \n\nThe solution is to ensure that we always unlock the writelock before we call the next transports onException method but after we've set the failed flag so that any waiting oneway calls will fail and throw their IOException indicating the transport has already failed.  This will free the failover transport up to do its normal failure recovery processing.  ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"289546","customfield_12312823":null,"summary":"Potential deadlock between FailoverTransport and AbstractInactivityMonitor","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12629148/comment/13562012","id":"13562012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"fixed on trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-01-24T21:38:49.786+0000","updated":"2013-01-24T21:38:49.786+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4274/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1dxmv:"}}