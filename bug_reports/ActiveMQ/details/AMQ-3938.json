{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12599291","self":"https://issues.apache.org/jira/rest/api/2/issue/12599291","key":"AMQ-3938","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2012-07-19T14:21:15.378+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 02 22:44:36 UTC 2012","customfield_12310420":"293806","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_79118811_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-07-19T14:21:15.314+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3938/watchers","watchCount":3,"isWatching":false},"created":"2012-07-18T16:22:36.593+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-08-02T22:44:36.423+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313904","id":"12313904","name":"JMX","description":"The JMX support in ActiveMQ"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I'm seeing a slow memory leak in our broker process which appears to be related to temporary queues and JMX. We had major memory leak problems before, but the 5.6.0 release fixed the majority of them. This leak seems to take about 2 weeks to fill 512MB heap but ultimately it will bring down the JVM.\n \nThe process which eventually runs out of memory simply runs an embeded broker which other clients connected to it via TCP. There are a couple static Camel routes, but nothing major in this process. Other clients (connected via TCP) make heavy use of pooled connections, Apache Camel, and temporary queues for request/reply messaging.\n \nI'm still looking into the issue but I've attached a MAT memory analysis to see if anyone else has seen a related problem. It looks like the temporary queues are getting registered in JMX and never removed but I'm just guessing right now.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12537015","id":"12537015","filename":"Eclipse Memory Analyzer_2012-07-18_11-46-58.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"created":"2012-07-18T16:25:07.012+0000","size":93515,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12537015/Eclipse+Memory+Analyzer_2012-07-18_11-46-58.png"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172385","customfield_12312823":null,"summary":"Memory Leak w/Temporary Queues and JMX","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Java 6\nActiveMQ 5.6.0\nApache Camel 2.10.0\nNetwork of brokers (2 nodes)\nSolaris","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13417220","id":"13417220","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"body":"Attached screenshot of MAT leak suspects.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"created":"2012-07-18T16:25:07.173+0000","updated":"2012-07-18T16:25:07.173+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13417224","id":"13417224","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"body":"The memory dump is too large to attach so I've compressed it and posted it here:\n\nhttps://dl.dropbox.com/u/3337852/grand-central.wl2-prod.2012-07-09_16-41-37.hprof.zip\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"created":"2012-07-18T16:28:35.714+0000","updated":"2012-07-18T16:28:35.714+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13417627","id":"13417627","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"body":"Looking at the JMX info via JConsole, I can see that under org.apache.activemq->Broker Name->Producer->TempQueue there are hundreds or thousands of entries. Way more than what is under org.apache.activemq->Broker Name->TempQueue which contains about 45 entries. This is after running the broker for 8 days, about half of the expected life before exhausting memory.\n\nWhat puts entries under Producer and does it ever clean them up?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"created":"2012-07-18T20:00:40.675+0000","updated":"2012-07-18T20:02:01.301+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13417675","id":"13417675","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"body":"After some more digging I'm wondering if this is related to the clients to the broker using Apache Camel for request/reply messages. We're using Spring's CachingConnectionFactory in the clients and it looks like Camel use Spring's JmsTemplate to send a reply on a request reply. It may be possible that JmsTemplate is creating a new MessageProducer for the reply which is getting cached in the CachingConnectionFactory. Because the reply queues are temporary and may change over time, the cached producers are never getting reused or released. I'll have to look at the Spring source to see if they have any maximum to the number of cached producers and see if I can setup some kind of test case. It still seems odd that this could generate thousands of producers/JMX entries, but not out of the question.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"created":"2012-07-18T21:00:46.100+0000","updated":"2012-07-18T21:00:46.100+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13418315","id":"13418315","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"body":"After some more testing I was able to determine that indeed this was user error. The Spring CachingConnectionFactory defaults to caching an unlimited number of producers. This causes problems when a new producer is request to send a reply message on a temporary queue because a new producer is created and cached for each reply message (assuming the same temporary queue isn't reused).\n\nSo the lesson is, disable producer caching when using:\n- Spring's CachingConnectionFactory\n- Apache Camel\n- Request/Reply messages on temporary queues\n\nYou can reject/close this defect. Sorry for the trouble.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpilone","name":"mpilone","key":"mpilone","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Pilone","active":true,"timeZone":"America/New_York"},"created":"2012-07-19T14:15:15.090+0000","updated":"2012-07-19T14:15:15.090+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13418318","id":"13418318","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"User indicates this is a non-issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-07-19T14:21:15.378+0000","updated":"2012-07-19T14:21:15.378+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13424006","id":"13424006","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rschettini","name":"rschettini","key":"rschettini","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Schettini","active":true,"timeZone":"Etc/UTC"},"body":"We are experiencing a very similar issue.  We create a lot of temporary queues and JMX is turned on, we consume all of PermGen very quickly.  When JMX is off, we can \"run forever\".  Running the code below, I can observer the permgen space using jvisualvm:\n\nActiveMQConnectionFactory cf = new ActiveMQConnctionFactory(new URI(\"<my borker>\"));\nConnection c = cf.createConnection();\nSession s = c.createSession(false, Session.AUTO_ACKNOWLEDGE);\nfor (int i=0; i<10000; i++)\n{\nTemporaryQueue q = s.createTemporaryQueue();\nq.delete();\n}\ns.close();\nc.close();","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rschettini","name":"rschettini","key":"rschettini","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Schettini","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-27T17:49:56.631+0000","updated":"2012-07-27T17:49:56.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13426814","id":"13426814","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Have you enabled the cleanup of inactive destinations?  See:\nhttp://activemq.apache.org/delete-inactive-destinations.html ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-08-01T18:50:11.402+0000","updated":"2012-08-01T18:50:11.402+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599291/comment/13427690","id":"13427690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rschettini","name":"rschettini","key":"rschettini","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Schettini","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the suggestion.  I tried it but it did not help.  The new clue I discovered today is that the PermGen space can be reclaimed if ALL connections to ActiveMQ are closed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rschettini","name":"rschettini","key":"rschettini","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Schettini","active":true,"timeZone":"Etc/UTC"},"created":"2012-08-02T22:44:36.363+0000","updated":"2012-08-02T22:44:36.363+0000"}],"maxResults":9,"total":9,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3938/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tvbz:"}}