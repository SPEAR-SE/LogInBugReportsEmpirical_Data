{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13134777","self":"https://issues.apache.org/jira/rest/api/2/issue/13134777","key":"AMQ-6894","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-01-31T15:30:33.546+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Feb 07 18:28:24 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6894/watchers","watchCount":4,"isWatching":false},"created":"2018-01-30T14:53:45.658+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12339772","id":"12339772","name":"5.14.5","archived":false,"released":true,"releaseDate":"2017-04-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofré","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-02-07T18:28:24.657+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"My clients connect to AMQ with this connection string:\r\n\r\n(tcp://amq1:61616,tcp://amq2:61616)?randomize=false&priorityBackup=true\r\n\r\n It works - for some time. But sooner or later my AMQ server becomes unresponsive because the host it runs on runs out of resources (threads).\r\n\r\nSuddenly AMQ Server log explodes with the messages like:\r\n\r\n{code}\r\n2018-01-26 09:26:16,909 | WARN  | Failed to register MBean org.apache.activemq :type=Broker,brokerName=activemq-vm-primary,connector=clientConnectors,connect\r\n\r\norName=default,connectionViewType=clientId,connectionName=ID_ca8f70e115d0-3708\r\n\r\n7-1516883370639-0_22 | org.apache.activemq.broker.jmx.ManagedTransportConnecti\r\n\r\non | ActiveMQ Transport: tcp:///172.10.7.56:55548@61616\r\n\r\n2018-01-26 09:26:21,375 | WARN  | Ignoring ack received before dispatch; result of failover with an outstanding ack. Acked messages will be replayed if present on this broker. Ignored ack: MessageAck \\{commandId = 157, responseRequired = false, ackType = 2, consumerId = ID:ca8f70e115d0-37087-1516883370639-1:22:10:1, firstMessageId = ID:a95345a9c0df-33771-1516883685728-1:17:5:1:23, lastMessageId = ID:a95345a9c0df-33771-1516883685728-1:17:5:1:23, destination = queue://MY_QUEUE_OUT, transactionId = null, messageCount = 1, poisonCause = null} | org.apache.activemq.broker.region.PrefetchSubscription | ActiveMQ Transport: tcp:///172.16.6.56:55464@61616\r\n\r\n2018-01-26 09:26:39,211 | WARN  | Transport Connection to: tcp://172.10.6.56:55860 failed: java.net.SocketException: Connection reset | org.apache.activemq.broker.TransportConnection.Transport | ActiveMQ InactivityMonitor Worker\r\n\r\n2018-01-26 09:26:47,175 | WARN  | Transport Connection to: tcp://172.10.6.56:57012 failed: java.net.SocketException: Broken pipe (Write failed) | org.apache.activemq.broker.TransportConnection.Transport | ActiveMQ InactivityMonitor Worker\r\n{code}\r\n\r\nAfter short period of time AMQ server comes out of resources with \"java.lang.OutOfMemoryError: unable to create new native thread\" error. The AMQ service process in this case has a huge number of threads (some thousands)\r\n\r\n \r\n\r\nThe client side log contains a lot of reconnection attempts messages like:\r\n\r\n{code}\r\n2018-01-26 00:10:31,387 WARN    [\\{{bundle.name,org.apache.activemq.activemq-osgi}{bundle.version,5.14.1}\\{bundle.id,181}}]     [null]  org.apache.activemq.transport.failover.FailoverTransport      Failed to connect to [tcp://activemq-vm-primary:61616, tcp://activemq-vm-secondary:61616] after: 810 attempt(s) continuing to retry.\r\n{code}\r\n\r\nIt seems that client creates a huge number of connections by failover retry and after some time kills the server.\r\n\r\nIssue looks very similar to described in https://issues.apache.org/jira/browse/AMQ-6603, however server isn't configured with access control settings.\r\n\r\nI found the description of similar problem into [http://activemq.2283324.n4.nabble.com/ActiveMQ-5-2-OutOfMemoryError-unable-to-create-new-native-thread-td2366585.html],  but without concrete suggestion.\r\n\r\n \r\n\r\nPart of server log is attached","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12908346","id":"12908346","filename":"activemq-part.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashakirin","name":"ashakirin","key":"ashakirin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ashakirin&avatarId=13541","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ashakirin&avatarId=13541","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ashakirin&avatarId=13541","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ashakirin&avatarId=13541"},"displayName":"Andrei Shakirin","active":true,"timeZone":"Europe/Berlin"},"created":"2018-01-30T14:56:05.029+0000","size":18786,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12908346/activemq-part.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Excessive number of connections by failover transport with priorityBackup","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashakirin","name":"ashakirin","key":"ashakirin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ashakirin&avatarId=13541","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ashakirin&avatarId=13541","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ashakirin&avatarId=13541","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ashakirin&avatarId=13541"},"displayName":"Andrei Shakirin","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashakirin","name":"ashakirin","key":"ashakirin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ashakirin&avatarId=13541","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ashakirin&avatarId=13541","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ashakirin&avatarId=13541","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ashakirin&avatarId=13541"},"displayName":"Andrei Shakirin","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13134777/comment/16347015","id":"16347015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofré","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks, gonna take a look.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofré","active":true,"timeZone":"Europe/Berlin"},"created":"2018-01-31T15:30:33.546+0000","updated":"2018-01-31T15:30:33.546+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13134777/comment/16347076","id":"16347076","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashakirin","name":"ashakirin","key":"ashakirin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ashakirin&avatarId=13541","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ashakirin&avatarId=13541","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ashakirin&avatarId=13541","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ashakirin&avatarId=13541"},"displayName":"Andrei Shakirin","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks JB,\r\n\r\nI have one more founding on client side.\r\nThere is an exception:\r\n{code}\r\norg.apache.activemq.transport.failover.FailoverTransport\tTransport (tcp://activemq-vm-primary:61616) failed , attempting to automatically reconnect: java.io.IOException: Encountered a String value that is too long to encode.\r\n{code}\r\n\r\nIt could be the case that client tries to inject long binary property into JMS message, receives IOException and trying to reconnect. After some time, unlimited re-connections kills the server.\r\n\r\nI am not 100% sure that is the cause, but perhaps it helps to your analyse","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashakirin","name":"ashakirin","key":"ashakirin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ashakirin&avatarId=13541","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ashakirin&avatarId=13541","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ashakirin&avatarId=13541","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ashakirin&avatarId=13541"},"displayName":"Andrei Shakirin","active":true,"timeZone":"Europe/Berlin"},"created":"2018-01-31T16:16:01.959+0000","updated":"2018-01-31T16:16:01.959+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13134777/comment/16351765","id":"16351765","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashakirin","name":"ashakirin","key":"ashakirin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ashakirin&avatarId=13541","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ashakirin&avatarId=13541","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ashakirin&avatarId=13541","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ashakirin&avatarId=13541"},"displayName":"Andrei Shakirin","active":true,"timeZone":"Europe/Berlin"},"body":"The following client code configured with failover transport will kill the server after some time:\r\n\r\n{code}\r\npublic void onMessage(Message message) {\r\n...\r\n StringBuffer bigBuffer = new StringBuffer(Short.MAX_VALUE);\r\n for(int i = 1; i < Short.MAX_VALUE; i++) { \r\n   bigBuffer.append(\"1\"); \r\n }\r\n throw new RuntimeException(bigBuffer.toString());\r\n}\r\n{code}\r\n\r\nI see two AMQ problems here:\r\n1) Exception message have to be controlled and limited before set in dlqDeliveryFailureCause: some exceptions coming from thirdparty and not under client handler control. Following code in ActiveMQMessageConsumer.rollback() have to be fixed:\r\n{code}\r\n  ack.setPoisonCause(new Throwable(\"Exceeded redelivery policy limit:\" + redeliveryPolicy\r\n      + \", cause:\" + lastMd.getRollbackCause(), lastMd.getRollbackCause()));\r\n{code}\r\nIt is necessary to check length of lastMd.getRollbackCause().toString() and cut to reasonable length\r\n\r\n\r\n2) Failover reconnection by EVERY IOException is IMO very dangerous","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ashakirin","name":"ashakirin","key":"ashakirin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ashakirin&avatarId=13541","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ashakirin&avatarId=13541","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ashakirin&avatarId=13541","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ashakirin&avatarId=13541"},"displayName":"Andrei Shakirin","active":true,"timeZone":"Europe/Berlin"},"created":"2018-02-04T12:33:22.757+0000","updated":"2018-02-04T12:33:22.757+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13134777/comment/16355856","id":"16355856","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user ashakirin opened a pull request:\n\n    https://github.com/apache/activemq/pull/274\n\n    AMQ-6894: limit poison exception message to 1024\n\n    AMQ-6894: Limit poison exception message to 1024 to avoid IOException be encoding\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/ashakirin/activemq master\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/activemq/pull/274.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #274\n    \n----\ncommit d0dab2e88b44702d26dd0883c9940b97ee03fdeb\nAuthor: Andrei Shakirin <andrei.shakirin@...>\nDate:   2018-02-07T18:28:55Z\n\n    AMQ-6894: limit poison exception message to 1024\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2018-02-07T18:28:24.657+0000","updated":"2018-02-07T18:28:24.657+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6894/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3pjkn:"}}