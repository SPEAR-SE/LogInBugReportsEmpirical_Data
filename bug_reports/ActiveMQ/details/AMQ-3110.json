{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12494319","self":"https://issues.apache.org/jira/rest/api/2/issue/12494319","key":"AMQ-3110","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2011-01-11T10:38:56.764+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jul 20 18:42:08 UTC 2011","customfield_12310420":"67333","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_17448991469_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-07-20T18:42:08.755+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3110/watchers","watchCount":0,"isWatching":false},"created":"2010-12-30T19:45:37.360+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-07-20T18:42:08.825+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have a queue which has 1 asynchronous consumer. Underlying connection has a redelivery policy where max retries is set to -1 (Indefinite).\nWhen a bad message is stopping the rest of the messages in the queue, I use webconsole/jconsole to move the message to an exception queue. However, the same bad message is being resent to the consumer. \n\nThe problem goes away only when I restart the broker. This is not an acceptable solution. \n\nI have attached a junit test so you can understand this scenario better. \n\nThanks,\nAshwini Kuntamukkala","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12467182","id":"12467182","filename":"FailingMessageRedeliveredDespiteBeingMovedToExceptionQueue.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"created":"2010-12-30T20:08:23.763+0000","size":5132,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12467182/FailingMessageRedeliveredDespiteBeingMovedToExceptionQueue.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172295","customfield_12312823":null,"summary":"Same message redelivered again even though moved to a different queue using web console","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows XP \nJava 1.6","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494319/comment/12976102","id":"12976102","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"body":"Output from the test when executed....\n\nTwo queues: \n1. test.queue (message redelivery policy is indefinite, i.e., -1)\n2. test.exception.queue\n\nBoth has a message each. \n\ntest.queue has an asynchronous consumer which throws exception causing rollback. \n\nMessage is moved from test.queue to test.exception.queue. The new message count is \ntest.queue has zero messages\ntest.exception.queue has 2 message (1 from earlier, 1 that was just moved)\n\nBug:\nThe consumer on test.queue continues to receive the message that was moved out to test.exception.queue!!\n\n----------------------------------------------\n\n\n2010-12-30 14:00:51,674 INFO  (BrokerService) - Using Persistence Adapter: MemoryPersistenceAdapter\n2010-12-30 14:00:51,674 INFO  (BrokerService) - ActiveMQ 5.3.0 JMS Message Broker (localhost) is starting\n2010-12-30 14:00:51,674 INFO  (BrokerService) - For help or more information please see: http://activemq.apache.org/\n16 [JMX connector] INFO org.mortbay.log - Logging to org.slf4j.impl.SimpleLogger(org.mortbay.log) via org.mortbay.log.Slf4jLog\n2010-12-30 14:00:52,096 INFO  (BrokerService) - ActiveMQ JMS Message Broker (localhost, ID:akuntamukkala-4986-1293739251721-0:0) started\n2010-12-30 14:00:52,127 INFO  (ManagementContext) - JMX consoles can connect to service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi\n2010-12-30 14:00:52,143 INFO  (TransportConnector) - Connector vm://localhost Started\nThu Dec 30 14:00:52 CST 2010 : Number of messages in test.exception.queue =  1\nThu Dec 30 14:00:52 CST 2010 : Number of messages in test.queue = 1\nThu Dec 30 14:00:52 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:00:52 CST 2010 : Number of messages in test.queue after MOVE = 0\nThu Dec 30 14:00:52 CST 2010 : Number of messages in test.exception.queue after MOVE =  2\nThu Dec 30 14:00:52 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:00:53 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:00:54 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:00:55 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:00:56 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:00:57 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:00:58 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:00:59 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:01:00 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\nThu Dec 30 14:01:01 CST 2010 - Message received by consumer = ID:akuntamukkala-4986-1293739251721-2:0:1:2:1\n2010-12-30 14:01:02,486 INFO  (BrokerService) - ActiveMQ Message Broker (localhost, ID:akuntamukkala-4986-1293739251721-0:0) is shutting down\n2010-12-30 14:01:02,486 INFO  (TransportConnector) - Connector vm://localhost Stopped\n2010-12-30 14:01:02,502 INFO  (BrokerService) - ActiveMQ JMS Message Broker (localhost, ID:akuntamukkala-4986-1293739251721-0:0) stopped\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"created":"2010-12-30T20:05:34.986+0000","updated":"2010-12-30T20:05:34.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494319/comment/12976103","id":"12976103","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"body":"This is a junit test that shows how an asynchronous consumer continues to receive the message that was moved out to a different queue manually because it was failing constantly thus blocking the queue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"created":"2010-12-30T20:08:23.818+0000","updated":"2010-12-30T20:08:23.818+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494319/comment/12980049","id":"12980049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=seime","name":"seime","key":"seime","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arne Seime","active":true,"timeZone":"Etc/UTC"},"body":"I see this also, running v5.4.1.\n\n-First i moved the message to another queue; message still redelivered on original queue\n-Then I tried to restart the consumer; still redelivered\n-Stopped the consumer, deleted the queue, started the consumer again; message finally not redelivered.\n\nUsing persistent delivery. Message was attempted redelivered maybe 10 times before I acted. Also -1 as maxRetries in the redeliverypolicy.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=seime","name":"seime","key":"seime","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arne Seime","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-11T10:38:56.764+0000","updated":"2011-01-11T10:38:56.764+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494319/comment/12980128","id":"12980128","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"body":"Arne:\n\nLook at my unit test on AMQ-3111. I use JMX to get around this problem by verifying if a message is being redelivered,   {using JMX MBean Server}, if the message really exists on the queue or not {Phantom message redelivered even though it is deleted or moved to another queue}. This lead to bad counts but at least the subsequent messages from the queue got processed. \n\nLet me know if you found any other work around. \nThanks,\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"created":"2011-01-11T14:52:47.573+0000","updated":"2011-01-11T14:52:47.573+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494319/comment/12980140","id":"12980140","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"note that redelivery in activemq is implemented on the client side, by the message consumer. It is only when the redelivery count is exceeded that a posion ack is sent to the broker.\nIf during redelivery, the consumer dies or the broker is restarted, the message will get redispatched by the broker as it has not been acknowledged.\nIf the message has been removed, then it should not get redelivered in the above cases.\nI think there is a bug in the queue.removeSubscription where it deals with inflight messages. There it needs to check to ensure the message is not acknowledged such that it won't be dispatched if it was inflight when the subscription goes away. A remove, done as part of a move, will mark the message as acknowledged.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-01-11T15:19:19.107+0000","updated":"2011-01-11T15:19:19.107+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12494319/comment/13068550","id":"13068550","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"The test case provided sets redelivery on the client as unlimited so the fact that the messages is being redelivered is expected as re-deliveries are done locally so a JMX move would not affect the client.  Modifying the test case such that the message is prefetched but the transaction is not committed and then a new consumer is attached to the same queue result in no redelivery of the moved message.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-07-20T18:42:08.777+0000","updated":"2011-07-20T18:42:08.777+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3110/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0turz:"}}