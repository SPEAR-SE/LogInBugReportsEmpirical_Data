{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12716030","self":"https://issues.apache.org/jira/rest/api/2/issue/12716030","key":"AMQ-5198","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326456","id":"12326456","name":"5.10.1","archived":false,"released":true,"releaseDate":"2015-01-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-05-22T15:25:52.474+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Sep 25 19:15:23 UTC 2015","customfield_12310420":"394234","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_4942086786_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-07-18T14:13:02.059+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5198/watchers","watchCount":3,"isWatching":false},"created":"2014-05-22T09:24:55.333+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-09-25T19:15:23.345+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We currently have an object that acts both as a consumer and as a producer over the same queue.\n\nLazy initialization of the scheduler is not 100% thread safe when a consumer and a producer are created sharing the same connection.\n\n\nWe encountered the following sporadic NPE when a rollback() is invoked:\nCaused by: java.lang.NullPointerException\n        at org.apache.activemq.thread.Scheduler.executeAfterDelay(Scheduler.java:64)\n        at org.apache.activemq.ActiveMQMessageConsumer.rollback(ActiveMQMessageConsumer.java:1278)\n        at org.apache.activemq.ActiveMQMessageConsumer$5.afterRollback(ActiveMQMessageConsumer.java:1054)\n        at org.apache.activemq.TransactionContext.afterRollback(TransactionContext.java:157)\n        ... 11 more\n\n\n\nWe believe that the lazy initialized getScheduler() is open for a race condition when a publish and rollback are happening concurrently.\n\ntry {\n                        result = scheduler = new Scheduler(\"ActiveMQConnection[\"+info.getConnectionId().getValue()+\"] Scheduler\");\n                        scheduler.start();\n                    } catch(Exception e) {\n                        throw JMSExceptionSupport.create(e);\n                    }\n\nThe suggested fix is to simply invoke the start within the constructor of the Scheduler class.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12646480","id":"12646480","filename":"ActiveMq.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-23T09:17:03.857+0000","size":22496,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12646480/ActiveMq.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"394372","customfield_12312823":null,"summary":"MessageConsumer and Producer are not thread safe","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14006011","id":"14006011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Do you have a test case that can reproduce this ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-05-22T15:25:52.474+0000","updated":"2014-05-22T15:25:52.474+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14006965","id":"14006965","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"body":"Hi Timothy,\n\nunfortunately, as you might understand, it's pretty hard to trigger a race condition reliably. \nPlease let me know if you need anyway a small test set up anyway.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-23T08:23:41.811+0000","updated":"2014-05-23T08:23:41.811+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14006996","id":"14006996","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"body":"Hi Timothy,\n\nI've attached a testcase that successfully hits the NPE when the scheduler.start() method is delayed.\n\nThe first consumer enters the block and while it still has to perform the start() the second will find the first if condition if (result == null) false, hence it won't have the Timer object initialised and an exception is thrown.\n\nI hope this explanation is clear enough","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-23T09:17:03.861+0000","updated":"2014-05-23T09:21:21.223+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14015236","id":"14015236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"body":"Hi Timothy,\n\nany update on this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"created":"2014-06-02T07:56:14.460+0000","updated":"2014-06-02T07:56:14.460+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14017707","id":"14017707","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Haven't had time to investigate as the test is quite large.  A simpler JUnit test case would be quicker to investigate otherwise this will have to wait.  In JMS land the Session is meant to be a single threaded resource to you can probably work around any issue here by giving each it's own Session instance. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-06-04T13:48:31.934+0000","updated":"2014-06-04T13:48:31.934+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14041896","id":"14041896","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"body":"Hi Timothy,\n\nAs I mentioned the problem is not related to the Session, but the Connection itself not being thread safe. We currently make use of a single Session per thread.\n\nWe both agree that an 'in frequently triggered' race condition doesnt exactly lend itself to a simple junit, but I believe that the test case I provided you with the actual patch should be quite straight-forward to test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"created":"2014-06-24T09:06:02.600+0000","updated":"2014-06-24T09:06:02.600+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14066162","id":"14066162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nis there any update on this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Malli","name":"Malli","key":"malli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Enrico Musuruana","active":true,"timeZone":"Etc/UTC"},"created":"2014-07-18T08:28:36.561+0000","updated":"2014-07-18T08:28:36.561+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14066381","id":"14066381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Fixed the assignment of the member variable to occur after the created scheduler is initialized so that the initialization doesn't allow the instance to escape the synchronized block.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-07-18T14:13:02.097+0000","updated":"2014-07-18T14:13:02.097+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12716030/comment/14908544","id":"14908544","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"body":"[~tabish121] - just came across this bug and looked at the fix.  This isn't actually correctly thread-safe at this point.  The new code is using the broken version of double-checked locking.  In order for this to be fixed correctly, the scheduler reference must be made volatile.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"created":"2015-09-25T19:15:23.345+0000","updated":"2015-09-25T19:15:23.345+0000"}],"maxResults":9,"total":9,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5198/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1vvon:"}}