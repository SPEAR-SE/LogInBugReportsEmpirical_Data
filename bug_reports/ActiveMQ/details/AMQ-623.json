{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481586","self":"https://issues.apache.org/jira/rest/api/2/issue/12481586","key":"AMQ-623","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315608","id":"12315608","description":"","name":"4.0 RC2","archived":false,"released":true,"releaseDate":"2006-04-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2006-03-17T13:27:54.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Mar 17 13:27:54 UTC 2006","customfield_12310420":"49257","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_717953000_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2006-03-17T13:27:54.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-623/watchers","watchCount":0,"isWatching":false},"created":"2006-03-09T06:02:01.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315607","id":"12315607","description":"Milestone 4","name":"4.0 M4","archived":false,"released":true,"releaseDate":"2006-01-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-03-17T13:27:54.000+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I got exceptions from time to time when I close connections,\n\n---------------------------------------------------------------------------------------------------------------------------------------------\n2006-3-9 11:42:11 org.apache.activemq.ActiveMQConnection transportFailed\nWarn: Cleanup failed\njavax.jms.JMSException: Cannot write to the stream any more it has already been closed\n\tat org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:57)\n\tat org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1043)\n\tat org.apache.activemq.ActiveMQConnection.cleanup(ActiveMQConnection.java:1191)\n\tat org.apache.activemq.ActiveMQConnection.transportFailed(ActiveMQConnection.java:1585)\n\tat org.apache.activemq.ActiveMQConnection.onException(ActiveMQConnection.java:1338)\n\tat org.apache.activemq.transport.TransportFilter.onException(TransportFilter.java:102)\n\tat org.apache.activemq.transport.TransportFilter.onException(TransportFilter.java:102)\n\tat org.apache.activemq.transport.TransportFilter.onException(TransportFilter.java:102)\n\tat org.apache.activemq.transport.TransportSupport.onException(TransportSupport.java:90)\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:149)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: java.io.EOFException: Cannot write to the stream any more it has already been closed\n\tat org.apache.activemq.transport.tcp.TcpBufferedOutputStream.checkClosed(TcpBufferedOutputStream.java:131)\n\tat org.apache.activemq.transport.tcp.TcpBufferedOutputStream.write(TcpBufferedOutputStream.java:69)\n\tat java.io.DataOutputStream.writeInt(Unknown Source)\n\tat org.apache.activemq.openwire.OpenWireFormat.marshal(OpenWireFormat.java:169)\n\tat org.apache.activemq.transport.tcp.TcpTransport.oneway(TcpTransport.java:117)\n\tat org.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:90)\n\tat org.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:65)\n\tat org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:44)\n\tat org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:54)\n\tat org.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1041)\n\t... 9 more\n---------------------------------------------------------------------------------------------------------------------------------------------\n\nIt seems that things happened in this order:\n\n1. On client, in user thread, connection.close() is called.\n\n2. On server, shutdown info is received  and socket is closed.\n\n3. On client, in consumer thread, TcpTransport got an EOFException because socket is closed before TcpTransport.closed is set to true.\n\n4. On client, ActiveMQConnection.cleanup() is called becauseof EOFException happend in 3. But isConnectionInfoSentToBroker is still true, another Exception is raised when sending packet to broker through the already closed socket.\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"254721","customfield_12312823":null,"summary":"Cleanup Failed When ActiveMQConnection.close() is called","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cloudor","name":"cloudor","key":"cloudor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Cloudor Pu","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cloudor","name":"cloudor","key":"cloudor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Cloudor Pu","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481586/comment/12937637","id":"12937637","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"I've just patched SVN HEAD to fix this issue AFAIK - any chance you could try out tomorrows SNAPSHOT build (or the latest in subversion) to see if this fixes your issue please?\n\nIf not let us know and we'll reopen this issue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2006-03-17T13:27:54.000+0000","updated":"2006-03-17T13:27:54.000+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-623/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i17zhz:"}}