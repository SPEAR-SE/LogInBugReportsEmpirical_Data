{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482767","self":"https://issues.apache.org/jira/rest/api/2/issue/12482767","key":"AMQ-2823","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"parent":{"id":"12482602","key":"AMQ-2828","self":"https://issues.apache.org/jira/rest/api/2/issue/12482602","fields":{"summary":"Broker connection string does not allow both failover and compression","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2010-07-12T16:48:46.313+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 17 22:50:28 UTC 2011","customfield_12310420":"74783","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_19031246604_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-02-17T22:50:27.991+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2823/watchers","watchCount":0,"isWatching":false},"created":"2010-07-12T16:23:01.405+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-02-17T22:50:28.005+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Symptoms\n\nthe following URI \"patterns\" cause unexpected behaviour:\n\n1) failover://(tcp://host:port)?connectionParameter=value\n\n2) failover://(tcp://host:port?tcpParameter=value1)?failoverParameter=value3\n\n3) failover://(tcp://host:port?tcpParameter=value1)?connectionParamater=value2&failoverParameter=value3\n\n1) A failover URL is not parsed correctly in ActiveMQ version 5.2.0. When there are parameters for the connection (e.g.: prefetch policy parameters -\"jms.prefetchSize.all\", etc-) This issue has to do with the invalid parsing of the URI.\nThe issue was found when trying to append connection parameters to a failover URI. The problem with this is basically that the failover URI is not a \"generic URI\" (see RFC 2396 for more details), that is, it is not of the form:\n\n<scheme>://<authority><path>?<query>\n\nAlthough the URI is composed of\n\n<scheme>:<scheme-specific-part>\n\nand is thus a valid URI according to the RFC.\n\nThe method \n\nURISupport.createURIWithQuery(URI, String)\n\nreturn and incorrect URI for a failover URI, because of the scheme of this URI. This is the content of the method:\n\n<<< CODE\n\nURISupport.createURIWithQuery(URI, String){\n\treturn new URI(uri.getScheme(), uri.getUserInfo(), uri.getHost(), uri.getPort(), uri.getPath(), query, uri.getFragment());\n}\n\n<<< /CODE\n\nWhen parsing the URI in ActiveMQConnectionFactory.createURI(String) with:\n\nnew java.util.URI(String)\n\nThe resulting URI has some missing or \"invalid\" values. For instance, with the following URL:\n\n\"failover://(tcp://host:port)?jms.prefetchSize.all=30\"\n\nthe resulting URI has the following values set:\n\nhost=null\nport=-1\nauthority=\"(tcp:\"\npath=\"//host:port)\"\nquery=\"connectionParameter=value\"\n\nthe path gets its value because of the \"/\" after \"(tcp:\".\n\nThe result is that when \n\nActiveMQConnectionFacotry.setBrokerURL(String) Line 343:\n\n<<< CODE\n\nthis.brokerURL = URISupport.createRemainingURI(this.brokerURL, map);\n\n<<< /CODE\n\nis excecuted, an exeption is thrown (message=\"Illegal character in port number\"), because of the invalid por number.\nThis is silently ignored in the ActiveMQConnectionFactory.setBroker(Strin) method and the values of the brokerURL are not updated without the connection parameters.\nConsecuently, when the connection is created, the following exception is thrown:\n\njava.lang.IllegalArgumentException \"Invalid connect parameters: ...\"\n\nBecause of the connectionParameter that was not removed from the brokerURL.\n\n2) The second URI pattern causes failover paramters to be ignored but the tcp transport gets the correct parameters.\n\nThe resulting URI in ActiveMQConnectionFactory contains the following invalid values:\n\nhost=null\nport=-1\nauthority=\"(tcp:\"\npath=\"//host:port\"\nquery=\"tcpParameter=value)?failoverParamater=value\"\n\nthis is because of the extra ? in the \"nested\" URI.\nThis URI works correctly, but if a connection parameter is the first parameter in the composite URI as in (3):\n\n\tfailover://(tcp://host:port?tcpParameter=value1)?connectionParamater=value2&failoverParameter=value3\n\nthat parameter would be omited, and the failover transport would fail when connecting because of an invalid connection parameter being set for the failover transport.\n\n\nConclusion:\n\nA modification of the parsing in \n\nActiveMQConnectionFactory.setBrokerURL(String)\n\nshould solve the query parameter problems.\nThe parameter parsing should consider the nested URIs, and the call to \n\nURISupport.createRemainingURI(URI, Map);\n\nshould create a \"nested\" URI (composite) if required.\nSome other modification could also be required.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172311","customfield_12312823":null,"summary":"ActiveMQ URI: parsing errors for failover URI (composite URI)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier.michelson%40hotmail.com","name":"javier.michelson@hotmail.com","key":"javier.michelson@hotmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Javier Michelson","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier.michelson%40hotmail.com","name":"javier.michelson@hotmail.com","key":"javier.michelson@hotmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Javier Michelson","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482767/comment/12941170","id":"12941170","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"could you validate against trunk or add your variants to http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/transport/failover/FailoverUriTest.java?view=markup\nthere have been some improvements in this area for 5.4","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-12T16:48:46.313+0000","updated":"2010-07-12T16:48:46.313+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482767/comment/12996139","id":"12996139","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"A valid test case is required the given URIs seem to work fine against trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-02-17T22:50:28.002+0000","updated":"2011-02-17T22:50:28.002+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2823/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tuvj:"}}