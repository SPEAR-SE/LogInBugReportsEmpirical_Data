{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481277","self":"https://issues.apache.org/jira/rest/api/2/issue/12481277","key":"AMQ-662","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315606","id":"12315606","description":"","name":"3.2.4","archived":false,"released":true,"releaseDate":"2006-06-15"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315609","id":"12315609","description":"","name":"4.0 RC3","archived":false,"released":true}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2006-04-07T23:10:44.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Apr 07 23:10:44 UTC 2006","customfield_12310420":"49289","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_948407000_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2006-04-07T23:10:45.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-662/watchers","watchCount":1,"isWatching":false},"created":"2006-03-27T23:43:58.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315608","id":"12315608","description":"","name":"4.0 RC2","archived":false,"released":true,"releaseDate":"2006-04-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-04-07T23:10:45.000+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"when a runtime exception in onMessage the messages are getting rolledback/resent as expected, however AMQ appears to go into an infinite loop at this point taking up 100% of the CPU. Turning debug on shows the following repeated:\n...\n[DEBUG] 2006-03-21 16:55:37,586 - org.apache.activemq.ra.ServerSessionImpl:1 (ServerSessionImpl.java:159)- run loop start\n[DEBUG] 2006-03-21 16:55:37,586 - org.apache.activemq.ra.ServerSessionImpl:3 (ServerSessionImpl.java:172)- run loop end\n[DEBUG] 2006-03-21 16:55:37,586 - org.apache.activemq.ra.ServerSessionImpl:22 (ServerSessionImpl.java:172)- run loop end\n[DEBUG] 2006-03-21 16:55:37,586 - org.apache.activemq.ra.ServerSessionImpl:11 (ServerSessionImpl.java:159)- run loop start\n[DEBUG] 2006-03-21 16:55:37,586 - org.apache.activemq.ra.ServerSessionImpl:0 (ServerSessionImpl.java:172)- run loop end\n[DEBUG] 2006-03-21 16:55:37,586 - org.apache.activemq.ra.ServerSessionImpl:17 (ServerSessionImpl.java:172)- run loop end\n[DEBUG] 2006-03-21 16:55:37,586 - org.apache.activemq.ra.ServerSessionImpl:1 (ServerSessionImpl.java:172)- run loop end \n\nThe resend (and resulting infinte loop) was triggered by throwing a RuntimeException in the onMessage method of the POJO MDB.\n\nThis is being used alongside Spring 1.2.7, Jencks 1.1.1 in a POJO message driven bean setup. Attached are the configurations producing the error. \n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460785","id":"12460785","filename":"ASF.LICENSE.NOT.GRANTED--activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpederzolli","name":"jpederzolli","key":"jpederzolli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Titor","active":true,"timeZone":"Australia/Perth"},"created":"2006-03-27T23:43:58.000+0000","size":419,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12460785/ASF.LICENSE.NOT.GRANTED--activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460721","id":"12460721","filename":"ASF.LICENSE.NOT.GRANTED--applicationContext.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpederzolli","name":"jpederzolli","key":"jpederzolli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Titor","active":true,"timeZone":"Australia/Perth"},"created":"2006-03-27T23:43:58.000+0000","size":2406,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12460721/ASF.LICENSE.NOT.GRANTED--applicationContext.xml"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161477","customfield_12312823":null,"summary":"Infinite Loop after message resend","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpederzolli","name":"jpederzolli","key":"jpederzolli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Titor","active":true,"timeZone":"Australia/Perth"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpederzolli","name":"jpederzolli","key":"jpederzolli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Titor","active":true,"timeZone":"Australia/Perth"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"JDK 1.5","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481277/comment/12937615","id":"12937615","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpederzolli","name":"jpederzolli","key":"jpederzolli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Titor","active":true,"timeZone":"Australia/Perth"},"body":"I've been looking into this further and it appears to be a synchronization issue in or related to ServerSessionImpl.java. If I individually send messages which are then forced to resend, everything works fine. This infinite loop only occurs when I send several messages in a row. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpederzolli","name":"jpederzolli","key":"jpederzolli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Titor","active":true,"timeZone":"Australia/Perth"},"created":"2006-03-30T11:45:40.000+0000","updated":"2006-03-30T11:45:40.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481277/comment/12937747","id":"12937747","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpederzolli","name":"jpederzolli","key":"jpederzolli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Titor","active":true,"timeZone":"Australia/Perth"},"body":"\nI found what seems to be the source of the infinite loop - in MessageDispatchChannel.java, in the method dequeueNoWait (line 91):\n\n    public MessageDispatch dequeueNoWait() {\n        synchronized (mutex) {\n            if (closed || !running || list.isEmpty()) {\n                return null;\n            }\n            return (MessageDispatch) list.removeFirst();\n        }\n    }\n\nThe thread that keeps on spinning has values of closed=false, running=false, and a nonEmpty list. With those values, a null is returned up to the run() method of ActiveMqSession.java (line 640), causing it do do nothing and then finally up to ServerSessionImpl.java's run() method (line 156) where in the finally block the following code that is responsible for breaking out of the while loop (line 170):\n\n            finally {\n                InboundContextSupport.unregister(this);                \n                log.debug(\"run loop end\");            \n                synchronized (runControlMutex) {\n                    // This endpoint may have gone stale due to error\n                    if( stale) {\n                        runningFlag = false;\n                        pool.removeFromPool(this);\n                        break;\n                    }\n                    if( !session.hasUncomsumedMessages() ) {\n                        runningFlag = false;\n                        pool.returnToPool(this);\n                        break;\n                    }                \n                }\n\nNeither break statement is hit since the endpoint is not stale and it has unconsumed messages - and the infinite loop begins. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpederzolli","name":"jpederzolli","key":"jpederzolli","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Titor","active":true,"timeZone":"Australia/Perth"},"created":"2006-04-05T00:25:38.000+0000","updated":"2006-04-05T00:25:38.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481277/comment/12936338","id":"12936338","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-04-07T23:10:44.000+0000","updated":"2006-04-07T23:10:44.000+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-662/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s007:"}}