{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13039809","self":"https://issues.apache.org/jira/rest/api/2/issue/13039809","key":"AMQ-6590","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338054","id":"12338054","name":"5.15.0","archived":false,"released":true,"releaseDate":"2017-07-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12338909","id":"12338909","name":"5.14.4","archived":false,"released":true,"releaseDate":"2017-03-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341032","id":"12341032","name":"5.16.0","archived":false,"released":false},{"self":"https://issues.apache.org/jira/rest/api/2/version/12344049","id":"12344049","description":"","name":"5.15.7","archived":false,"released":true,"releaseDate":"2018-10-27"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-02-02T12:06:39.737+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun Oct 21 17:29:22 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_463810_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-02-02T12:09:00.920+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6590/watchers","watchCount":8,"isWatching":false},"created":"2017-02-02T12:01:17.180+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338822","id":"12338822","name":"5.14.3","archived":false,"released":true,"releaseDate":"2016-12-22"}],"issuelinks":[{"id":"12546123","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12546123","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"13192835","key":"AMQ-7082","self":"https://issues.apache.org/jira/rest/api/2/issue/13192835","fields":{"summary":"KahaDB index, recover free pages in parallel with start","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-10-21T17:29:22.373+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have discovered an issue with the KahaDB index recovery after an unclean shutdown (OOM error, kill -9, etc) that leads to excessive disk space usage. \n\nNormally on clean shutdown the index stores the known set of free pages to db.free and reads that in on start up to know which pages can be re-used.  On an unclean shutdown this is not written to disk so on start up the index is supposed to scan the page file to figure out all of the free pages.\n\nUnfortunately it turns out that this scan of the page file is being done before the total page count value has been set so when the iterator is created it always thinks there are 0 pages to scan.\n\nThe end result is that every time an unclean shutdown occurs all known free pages are lost and no longer tracked.  This of course means new free pages have to be allocated and all of the existing space is now lost which will lead to excessive index file growth over time.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"KahaDB index loses track of free pages on unclean shutdown","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/15849839","id":"15849839","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 38d85be476a06fe9a1f60b4f38232d64a6d0398a in activemq's branch refs/heads/master from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=38d85be ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6590\n\nFix KahaDB index free page recovery on unclean shutdown so that existing\nfree pages will be tracked and not lost.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-02T12:06:39.737+0000","updated":"2017-02-02T12:06:39.737+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/15849841","id":"15849841","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 6a87e13eb3d6f819b0d05ee8d16f6d955442425e in activemq's branch refs/heads/activemq-5.14.x from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=6a87e13 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6590\n\nFix KahaDB index free page recovery on unclean shutdown so that existing\nfree pages will be tracked and not lost.\n\n(cherry picked from commit 38d85be476a06fe9a1f60b4f38232d64a6d0398a)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-02T12:07:56.877+0000","updated":"2017-02-02T12:07:56.877+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/15849844","id":"15849844","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 83511c96e5cf91f348a81ecc3c4439aa345548dd in activemq's branch refs/heads/master from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=83511c9 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6590\n\nRemoving un-needed imports\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-02T12:10:32.759+0000","updated":"2017-02-02T12:10:32.759+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/15849845","id":"15849845","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit cc28f5dc3905e411b3e5ce39240baf21ccedb0af in activemq's branch refs/heads/activemq-5.14.x from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=cc28f5d ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6590\n\nRemoving un-needed imports\n\n(cherry picked from commit 83511c96e5cf91f348a81ecc3c4439aa345548dd)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-02T12:10:53.733+0000","updated":"2017-02-02T12:10:53.733+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/15849847","id":"15849847","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~gtully], Can you do a quick sanity check on this?  I believe this is the correct fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-02-02T12:13:41.886+0000","updated":"2017-02-02T12:13:41.886+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/15850004","id":"15850004","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"[~cshannon] sure. that fix does look correct and is a great catch. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-02T14:50:06.005+0000","updated":"2017-02-02T14:50:06.005+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/15850043","id":"15850043","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Thanks for taking a look.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-02-02T15:25:07.368+0000","updated":"2017-02-02T15:25:07.368+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653349","id":"16653349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"It turns out that this change, while good, means that we take a hit on start in the normal failover case where the primary dies uncleanly.\r\n\r\nThere have been reports of more than 2mins to start and the threads are stuck in sequence.set add. AMQ-7055 helps a good bit, but the problem is we are trading off availability for disk usage and taking the hit during restart.\r\n\r\nI am thinking it may be better to do a checkpoint of the feeList when we do gc, the cleanup phase, and accept that information on restart. \r\n\r\nIf the restart is unclean, we remember that and do a freeList recovery when we next do an orderly shutdown. In that way, we can still restart fast, lose some disk space to some missed free pages and gracefully recover when we are stopping.\r\n\r\n[~cshannon] I wonder if that will hold together? The other approach is do have the option to do this offline, offline work has always been on the todo.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-17T10:43:32.388+0000","updated":"2018-10-17T10:43:32.388+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653357","id":"16653357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The checkpoint won't help, it will not be possible to work with a stale free list b/c one of those may now be occupied, hense the index file will have to grow, however we can still do the full and necessary free recovery on shutdown rather than on start. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-17T10:53:58.637+0000","updated":"2018-10-17T10:53:58.637+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653395","id":"16653395","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 5d3a3fcca7fbc04e60a146e42fb1f65b94e4ea7b in activemq's branch refs/heads/master from gtully\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=5d3a3fc ]\n\nAMQ-6590 - rework fix to take the recovery hit on clean shutdown rather than on restart, trade off availability for short term disk usage\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-17T11:32:32.381+0000","updated":"2018-10-17T11:32:32.381+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653398","id":"16653398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"[~cshannon] I have moved this fix to the shutdown phase b/c the recovery work can be significant on very large stores. The down side is temporary disk space usage by the index which is a better trade off IMHO. \r\n\r\nI also added an info log message to indicate that the some recovery is going on.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-17T11:35:16.815+0000","updated":"2018-10-17T11:40:18.146+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653549","id":"16653549","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgoodyear","name":"jgoodyear","key":"jgoodyear","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jgoodyear&avatarId=10107","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jgoodyear&avatarId=10107","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jgoodyear&avatarId=10107","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jgoodyear&avatarId=10107"},"displayName":"Jamie goodyear","active":true,"timeZone":"America/St_Johns"},"body":"Can we back port this change to the 5.15.x line as well?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgoodyear","name":"jgoodyear","key":"jgoodyear","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jgoodyear&avatarId=10107","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jgoodyear&avatarId=10107","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jgoodyear&avatarId=10107","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jgoodyear&avatarId=10107"},"displayName":"Jamie goodyear","active":true,"timeZone":"America/St_Johns"},"created":"2018-10-17T13:29:25.767+0000","updated":"2018-10-17T13:29:25.767+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653622","id":"16653622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit cee7f014fa4afca04681066946e5a2b6811141af in activemq's branch refs/heads/activemq-5.15.x from gtully\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=cee7f01 ]\n\nAMQ-6590 - rework fix to take the recovery hit on clean shutdown rather than on restart, trade off availability for short term disk usage\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-17T14:22:04.197+0000","updated":"2018-10-17T14:22:04.197+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653629","id":"16653629","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"body":"Nice [~gtully].  I pushed this to 5.15.x (5.15.7) as this was supposed to be in the 5.15 line as well.  Probably should have been a new improvement JIRA.  Updated the versions above as well.  Thank you!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"created":"2018-10-17T14:24:50.171+0000","updated":"2018-10-17T14:25:18.002+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653818","id":"16653818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Nice catch [~gtully] , I agree that it is fine to temporarily take the space hit as it will get cleaned up on the next clean shutdown.\n\nMy only question is will there now be a large delay on shutdown instead? So are we just moving the 2 minute lag time to having to wait on shutdown instead of startup? In that case it doesn’t seem to be much different on a restart case as you have to wait the 2 minutes either way","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-10-17T16:42:02.365+0000","updated":"2018-10-17T16:42:02.365+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653831","id":"16653831","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"body":"[~cshannon], I think the criticality of this is restart on a failed broker.  It could cause slowness in failover that delays startup of the broker.  In a clean shut down, yes the delay moved to the back, but its a known delay when you are shutting it down in a clean fashion.  Thus you can plan it.  This makes sense as during a failover, you likely need availability immediately since that generally is not planned.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"created":"2018-10-17T16:48:28.272+0000","updated":"2018-10-17T16:48:28.272+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653872","id":"16653872","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~jgenender] , ah yeah that makes sense, on the failover case on a shared store you want to resume as fast as possible \r\n\r\nSo yeah for sure this is a good change as it helps that failover case and then you can plan later when to take that hit on a clean restart or shutdown.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-10-17T17:06:20.961+0000","updated":"2018-10-17T17:07:46.042+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16653873","id":"16653873","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"[~cshannon] sure, the recovery penalty needs to be taken at some stage.\r\n\r\nThe ~2mins is not ideal, AMQ-7055  helps, but also for the really large index cases, being able to set the index page size may help. That is currently not exposed in kahadb and defaults to 4k, which means loads of small seek/reads of the index file. Exposing that may help.\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-17T17:07:33.341+0000","updated":"2018-10-17T17:07:33.341+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16654661","id":"16654661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"body":"Hum....\r\n\r\nI dont really think that this is solving the all problem.... Of course in the case of a crash (unclean shutdown) the fail over will be faster....\r\n\r\nBut after that, let's imagine that we wanna do a normal restart. Well the broker will have a long shutdown and while doing that it will still hold the lock making the failover slow the same way.\r\n\r\nAnd maybe now is worst... Imagine that the shutdown is taking 2 minutes and the ACTIVEMQ_KILL_MAXSECONDS is set to 30 secs...\r\n\r\nIn this case all the shutdown will be unclean (so lots of dangling free pages - larger index file on each restart) until we delete the index file and perform a full recovery.\r\n\r\nWhy don't we save the free page in every checkpoint + keep track of it's hash or fingerPrint (SequenceSetHash) in the metadata (the page size is already saved there).\r\n\r\n[https://github.com/apache/activemq/blob/5d3a3fcca7fbc04e60a146e42fb1f65b94e4ea7b/activemq-kahadb-store/src/main/java/org/apache/activemq/store/kahadb/disk/page/PageFile.java#L468]\r\n\r\nNow, in the load method, we can check if the fingerprint of the metadata is equal to the saved free list... if it's equal we can load this list, if it's not, we can recover it (read the whole index file as before).\r\n\r\nSo in each checkpoint we should:\r\n\r\nCalculate freeList hash (or this can be pre calculated changing it every time that this list is modified) \r\n Save the free list \r\n Save this information in the metadata\r\n\r\nNow, on the load we can check if the hash of the loaded free list is the equal to the metadata... if it is we are good.\r\n\r\nThis is a rough draft of what I meant and seems to be working.\r\n\r\n[https://github.com/alanprot/activemq/commit/18036ef7214ef0eaa25c8650f40644dd8b4632a5]\r\n\r\nIs important to note that in the Pagefile#load method we need to rebuild the index in the same way it was in the checkpoint (the recovery will be performed after to replay the time btw the checkpoint and the crash)\r\n\r\nSo...\r\n\r\nImagine the timeline:\r\n\r\nT0 -> P1, P2 and P3 are free.\r\n\r\nT1 -> Checkpoint\r\n\r\nT2 -> P1 got occupied.\r\n\r\nT3 -> Crash\r\n\r\nIn the current scenario after the  Pagefile#load the P1 will be free and then the replay will mark P1 as occupied...\r\n\r\nMy change only make sure that db.data and db.free are in sync and showing the reality in T1 (checkpoint), If they are in sync i can use the db.free.\r\n\r\n In this case we will only perform a full read if the crash is btw saving the db.free and db.data... This is very unlikely \r\n\r\n[~gtully] [~jgenender] [~cshannon] Does this make sense?\r\n\r\nIf you think that this makes sense i can create a Jira to try to implement this..\r\n\r\n \r\n\r\n \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-18T05:30:37.616+0000","updated":"2018-10-18T05:46:27.644+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16654671","id":"16654671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"body":"Actually this fixed the failover speed, but my proposal I just makes it more streamlined","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-18T05:38:37.893+0000","updated":"2018-10-18T05:38:37.893+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16654678","id":"16654678","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"body":"Hi Alan... that's awesome!  That would totally work in cutting down the potential for the recovery. May I suggest that you open a new Jira to track this since this one is resolved.  Right now parts of this are in multiple releases, so its own Jira may help ensure we know what release it would be a part of.   Your code looks pretty clear and I think it deserves its own JIRA  Please reference this one in the new JIRA.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"created":"2018-10-18T05:48:54.483+0000","updated":"2018-10-18T05:48:54.483+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16655236","id":"16655236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"body":"One more small comment, I would change from using Random as the fingerprint and perhaps use a time stamp or something.  The Random could potentially have a clash and possibly could have a collision which would cause corruption.  Perhaps use a Time function or time based UUID as your finger print.  Since this will not be doing 2 checkpoints in under a millisecond, I think that would be the safest.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"created":"2018-10-18T13:37:33.227+0000","updated":"2018-10-18T13:37:33.227+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16655260","id":"16655260","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"body":"Yep...\r\n\r\nOr we can change the fingerprint for freePageTxId or something like that and be a single increment (freePageTxId++) on every time i save db.free","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-18T14:05:30.926+0000","updated":"2018-10-18T14:05:30.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16655414","id":"16655414","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"body":"Also, add a unit test.  The unit test can show a normal checkpoint, and you can also exercise the failure by force calling brokerService.getPersistenceAdapter().checkpoint() and then changing the db.data or db.free fingerprint with some file I/O using the File object, then restarting and testing that it did a full recovery.  Should be straight forward. Open a new Jira on this :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgenender","name":"jgenender","key":"jgenender","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Genender","active":true,"timeZone":"America/Denver"},"created":"2018-10-18T15:20:55.596+0000","updated":"2018-10-18T15:20:55.596+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16655503","id":"16655503","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"The ACTIVEMQ_KILL_MAXSECONDS actually occurred to me as well a bit after I responded to this. I use a custom start up script but still have something similar where if the broker hangs it will be killed which obviously breaks in this case.  So that case needs to be handled.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-10-18T16:12:23.026+0000","updated":"2018-10-18T16:12:23.026+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16655537","id":"16655537","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"body":"[~cshannon] What about saving the free pages in the check point? Do you think that make sense?\r\n\r\nI was talking other guys and the only concern seems to be that we will increase the Checkpoint timings (as we are writing one more file)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-18T16:29:16.614+0000","updated":"2018-10-18T16:29:16.614+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16655547","id":"16655547","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"I'm good with the checkpoint but want to see what [~gtully] thinks as he brought up some concerns about checkpointing the free list.  As Jeff said we can continue the conversation against the PR in a new jira.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-10-18T16:38:11.475+0000","updated":"2018-10-18T16:38:11.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16655742","id":"16655742","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"body":"Thanks!\r\n\r\n \r\n\r\nJust created a new Jira for that: https://issues.apache.org/jira/browse/AMQ-7080","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alanprot","name":"alanprot","key":"alanprot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alanprot&avatarId=36437","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alanprot&avatarId=36437","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alanprot&avatarId=36437","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alanprot&avatarId=36437"},"displayName":"Alan Protasio","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-18T18:51:13.399+0000","updated":"2018-10-18T18:51:13.399+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16656900","id":"16656900","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 79c74998dc1efb72b05d32f920052a1df4b6dd8e in activemq's branch refs/heads/master from gtully\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=79c7499 ]\n\nAMQ-7082 - recover index free pages in parallel with start, merge in flush, clean shutdown if complete. follow up on AMQ-6590\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-19T15:00:39.814+0000","updated":"2018-10-19T15:00:39.814+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13039809/comment/16658305","id":"16658305","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit c6103415b9a185776ebc16343c6574f7ff884806 in activemq's branch refs/heads/activemq-5.15.x from gtully\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=c610341 ]\n\nAMQ-7082 - recover index free pages in parallel with start, merge in flush, clean shutdown if complete. follow up on AMQ-6590\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2018-10-21T17:29:22.373+0000","updated":"2018-10-21T17:29:22.373+0000"}],"maxResults":30,"total":30,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6590/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i39ivz:"}}