{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12607848","self":"https://issues.apache.org/jira/rest/api/2/issue/12607848","key":"AMQ-4052","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-09-17T03:42:06.535+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Sep 21 08:05:04 UTC 2012","customfield_12310420":"249737","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_362496611_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-09-21T08:05:04.965+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4052/watchers","watchCount":3,"isWatching":false},"created":"2012-09-17T03:23:28.366+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-09-21T08:05:04.975+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The phenomenon of the bug:\nWhen consumers was killed and restarted frequently, some messages could not be consumed by consumer but they were still in pending messages.\n\nReason:\nWhen consumer consumes messages in transaction, it sends ack command and transaction commit command separately, if the consumer was killed between ack command and transaction commit command, in other words the Broker only received the ack command but did not receive the transaction commit command, this lead to the message in PrefetchSubscription’s dispatched list was set ack true, but was not removed from dispatched list. When the consumer was killed, Queue#removeSubscription() was called, in this method, PrefetchSubscription#remove() was called to put PrefetchSubscription’s pending list and dispatched list to Queue’s redeliveredWaitingDispatch list. After that, when Queue#doDispatch() was called, the redeliveredWaitingDispatch list was transferred to Queue#doActualDispatch () method to dispatch the messages to consumer again. In Queue#doActualDispatch () method, if all consumers isFull() method returns true, the target is null and the expression “interestCount > 0” become the only condition to judge if the message should be put back to the  redeliveredWaitingDispatch, but now the message’s isAcked() method returns true, this lead to interestCount is 0, and then the message was not put back to redeliveredWaitingDispatch, but it was not consumed and was still in pagedInMessages. \n\nSolution:\nIn PrefetchSubscription#remove() method, set ack status to false for all messages in dispatched list. The code as follows:\n\n{code}\n\n    public List<MessageReference> remove(ConnectionContext context, Destination destination) throws Exception {\n        List<MessageReference> resultList = new ArrayList<MessageReference>();\n        synchronized(pendingLock) {\n            super.remove(context, destination);\n            // Here is a potential problem concerning Inflight stat:\n            // Messages not already committed or rolled back may not be removed from dispatched list at the moment\n            // Except if each commit or rollback callback action comes before remove of subscriber.\n            resultList.addAll(pending.remove(context, destination));\n\n            // Synchronized to DispatchLock\n            synchronized(dispatchLock) {\n                ArrayList<MessageReference> references = new ArrayList<MessageReference>();\n                for (MessageReference msgRef : dispatched) {\n                    if( msgRef.getRegionDestination() == destination) {\n                        references.add(msgRef);\n                        if (msgRef instanceof QueueMessageReference) {\n                        \tQueueMessageReference ref = (QueueMessageReference) msgRef;\n                        \tref.setAcked(false);\n                        }\n                    }\n                }\n                resultList.addAll(references);\n                destination.getDestinationStatistics().getDispatched().subtract(references.size());\n                destination.getDestinationStatistics().getInflight().subtract(references.size());\n                dispatched.removeAll(references);\n            }\n        }\n        \n        return resultList;\n    }\n{code}\n\nThe solution can solve the problem, I want to know if the solution can lead to other problems.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59058","customfield_12312823":null,"summary":"When consumers was killed and restarted frequently, some messages could not be consumed by consumer but they were still in pending messages.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivian58659","name":"vivian58659","key":"vivian58659","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wei Wei","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivian58659","name":"vivian58659","key":"vivian58659","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wei Wei","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"CentOS release 5.6 (Final) java version \"1.6.0_30\"","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12607848/comment/13456743","id":"13456743","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Before any patch can be applied we need unit tests to verify the problem and ensure it stays fixed.  Also there were some fixes in this area since v5.6.0 are you testing against the 5.7-SNAPSHOT code and builds?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-09-17T03:42:06.535+0000","updated":"2012-09-17T03:42:06.535+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12607848/comment/13458554","id":"13458554","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivian58659","name":"vivian58659","key":"vivian58659","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wei Wei","active":true,"timeZone":"Asia/Shanghai"},"body":"I tested against the apache-activemq-5.7-fuse-20120912.001718-11 code and builds in these two days and found that the problem still exists.\n\nReason:\nIn method PrefetchSubscription#dispatchPending(), pending.remove() made the message removed from the pending, but if canDispatch(node) returns false, the method PrefetchSubscription#dispatch(node) was not called and the message could not put to dispatched list, so the message was not sent to client and can not put back to Queue#redeliveredWaitingDispatch. \nWhen canDispatch(node) return false? If the server received the acknowledge commmand but did not received the transaction commit command, node.isAcked() returns true and node.isDropped() returns false, the result is false.\n\norg.apache.activemq.broker.region.QueueSubscription\n  protected boolean canDispatch(MessageReference n) throws IOException {\n    boolean result = true;\n    QueueMessageReference node = (QueueMessageReference)n;\n    if ((node.isAcked()) || (node.isDropped())) {\n      result = false;\n    }\n    result = (result) && ((isBrowser()) || (node.lock(this)));\n    return result;\n  }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivian58659","name":"vivian58659","key":"vivian58659","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wei Wei","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-19T10:43:28.755+0000","updated":"2012-09-19T10:43:28.755+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12607848/comment/13458556","id":"13458556","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"We need a JUnit test case to show that the issue exists.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-09-19T10:45:56.135+0000","updated":"2012-09-19T10:45:56.135+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12607848/comment/13460307","id":"13460307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivian58659","name":"vivian58659","key":"vivian58659","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wei Wei","active":true,"timeZone":"Asia/Shanghai"},"body":"If the consumer was killed, the broker will rollback the transaction. In rollback method, broker will set the acked status to false of the message of which the broker had received the ack command but hadn't received the commit command from consumer. But before the rollback method was called, the dispatch thread was still running, if there is new consumers, the message whose acked status is true will still be dispatched.\n\nAt first, I thought the bug still exists in version5.7,  because I only noticed the change:\nfrom\nif (!node.isDropped() && !((QueueMessageReference) node).isAcked() && (!node.isDropped() || s.getConsumerInfo().isBrowser()))\nto\nif (!node.isDropped()),\n\nbut didn't notice the change:\nfrom\nif (dispatchSelector.canSelect(s, node) && assignMessageGroup(s, (QueueMessageReference)node))\nto\nif (dispatchSelector.canSelect(s, node) && assignMessageGroup(s, (QueueMessageReference)node) && !((QueueMessageReference) node).isAcked() ).\n\nThe appended condition \"!((QueueMessageReference) node).isAcked()\" will prevent the message whose acked status is true from being dispatched. So the bug was fixed in version 5.7. \n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vivian58659","name":"vivian58659","key":"vivian58659","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wei Wei","active":true,"timeZone":"Asia/Shanghai"},"created":"2012-09-21T07:12:57.337+0000","updated":"2012-09-21T07:12:57.337+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12607848/comment/13460336","id":"13460336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Fixed in 5.7, thanks for closing the loop on this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-09-21T08:05:04.974+0000","updated":"2012-09-21T08:05:04.974+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4052/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ah6v:"}}