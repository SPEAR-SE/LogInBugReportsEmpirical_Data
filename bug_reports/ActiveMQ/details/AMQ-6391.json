{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12995948","self":"https://issues.apache.org/jira/rest/api/2/issue/12995948","key":"AMQ-6391","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-08-09T13:30:01.924+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Aug 10 13:19:35 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6391/watchers","watchCount":5,"isWatching":false},"created":"2016-08-09T13:06:32.134+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-08-10T13:19:35.746+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We observe memory leak in {{FailoverTransport.stateTracker.connectionStates.transactions}} when using XA Transactions in activemq-rar, sending message within same transaction and not using {{useInboundSession}}.\n\nIn such constellation there are two connections enlisted within same transaction. During commit the transaction manager will execute commit on one of the resources, per JTA 1.2 section 3.3.1 (\"(TransactionManager) ensures that the same resource manager only receives one set of prepare-commit calls for completing the target global transaction \".) [TransactionContext|https://github.com/apache/activemq/blob/a65f5e7c2077e048a2664339f6425d73948d71ce/activemq-client/src/main/java/org/apache/activemq/TransactionContext.java#L478] will propagate the afterCommit to all contexts participating in same transaction. However, this is not enough for {{ConnectionStateTracker}}, which only reacts to [TransactionInfo command|https://github.com/apache/activemq/blob/a65f5e7c2077e048a2664339f6425d73948d71ce/activemq-client/src/main/java/org/apache/activemq/TransactionContext.java#L469]. In effect, when two connection are enlisted in same transaction, just commands of one of them is cleared upon commit, leading to memory leak.\n\nSince I presume the {{TransactionInfo}} should be sent only once for commit of single transaction, {{ConnectionStateTracker}} needs to clear state for the acknowledged transactions regardless of connection id in the transaction command.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12822812","id":"12822812","filename":"0001-AMQ-6391-test.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"created":"2016-08-09T14:46:35.816+0000","size":9584,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12822812/0001-AMQ-6391-test.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Memory leak with FailoverTransport when sending TX messages from MDB","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12995948/comment/15413512","id":"15413512","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"\nThis is a little problematic. N connections in a tx need some coordination and avoiding the N using useInboundSession is the simplest approach.\nAn alternative approach is to force 2pc using connection url param rmIdFromConnectionId=true.\n\nIn that way, each connection gets an xa-end and can force an sync with the broker. The end/sync is important to be sure that all work is visible to the broker before the prepare/commit call (on one of the connections).\n\nWithout that, for an ack, there is no way to know that the broker has got the command before the commit/prepare\nFor sends, there is alwaysSyncSend, which should work (I think) but for acks there is no such option at the moment.\n\nThis all points to the need to do transaction completion on each connection, which would avoid this leak.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-09T13:30:01.924+0000","updated":"2016-08-09T13:30:01.924+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12995948/comment/15413541","id":"15413541","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks Gary,\n\nyes, moving to {{useInboundSession}} is indeed what we are going to do in the meantime. \n\nThe connections are getting xa-end, just the commit is reaching only the topmost one. If it is OK for broker to receive commit command for single transaction from multiple connections, then the solution appears to be easy - [afterCommit|https://github.com/apache/activemq/blob/a65f5e7c2077e048a2664339f6425d73948d71ce/activemq-client/src/main/java/org/apache/activemq/TransactionContext.java#L596] is fired for all participating transaction contexts already, they just need to send the transaction info if they already didn't.\n\nI'll see if I can build a testcase for this, and can try this approach.\n\nAnd for reference, I originally asked this on user mailing list: http://activemq.2283324.n4.nabble.com/Messages-piling-up-in-FailoverTranport-td4715072.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"created":"2016-08-09T13:56:01.876+0000","updated":"2016-08-09T13:56:01.876+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12995948/comment/15413642","id":"15413642","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"body":"This test reproduces the issue. I'll try modifying TransactionContext and submitting a PR.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"created":"2016-08-09T14:46:35.821+0000","updated":"2016-08-09T14:46:35.821+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12995948/comment/15413721","id":"15413721","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"body":"Apparently sending multiple commit {{TransactionInfo}} commands is not an option. This is what the other transaction context will get:\n{code}\nactivemq.TransactionContext: ignoring exception from after completion on ended transaction: javax.jms.JMSException: Transaction 'XID:[86,globalId=0000003ffffffd6,branchId=0000003ffffffd6]' has not been started. xaErrorCode:-4\njavax.jms.JMSException: Transaction 'XID:[86,globalId=0000003ffffffd6,branchId=0000003ffffffd6]' has not been started. xaErrorCode:-4\n\tat org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:54)\n\tat org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1399)\n\tat org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1428)\n\tat org.apache.activemq.TransactionContext.sendXaCommitInfo(TransactionContext.java:630)\n\tat org.apache.activemq.TransactionContext.commit(TransactionContext.java:595)\n\tat org.apache.activemq.bugs.AMQ6391Test.commit(AMQ6391Test.java:195)\n\tat org.apache.activemq.bugs.AMQ6391Test.access$200(AMQ6391Test.java:64)\n\tat org.apache.activemq.bugs.AMQ6391Test$1.onMessage(AMQ6391Test.java:116)\n\tat org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1401)\n\tat org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)\n\tat org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:202)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\nCaused by: javax.transaction.xa.XAException: Transaction 'XID:[86,globalId=0000003ffffffd6,branchId=0000003ffffffd6]' has not been started. xaErrorCode:-4\n\tat org.apache.activemq.transaction.Transaction.newXAException(Transaction.java:212)\n\tat org.apache.activemq.broker.TransactionBroker.getTransaction(TransactionBroker.java:351)\n\tat org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:251)\n\tat org.apache.activemq.broker.MutableBrokerFilter.commitTransaction(MutableBrokerFilter.java:118)\n\tat org.apache.activemq.broker.TransportConnection.processCommitTransactionOnePhase(TransportConnection.java:535)\n\tat org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:100)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:333)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:197)\n\tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)\n\tat org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\n\tat org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:273)\n\t... 5 more\n{code}\n\nThe code can be seen at https://github.com/pdudits/activemq/commit/98985af1d4e5800e550562d68a2879697a5051ea","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"created":"2016-08-09T15:26:37.563+0000","updated":"2016-08-09T15:26:55.694+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12995948/comment/15413739","id":"15413739","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"[~pdudits] having a unit test is a great start :-)\nThis use case make me thing that tracking transactions by the failover transport is not such a good idea. Maybe an alternative approach is to allow that option to be disabled. It is is always on at the moment, see: https://github.com/apache/activemq/blob/31c55f75108b06020eb6206c52361b04f49656a9/activemq-client/src/main/java/org/apache/activemq/transport/failover/FailoverTransport.java#L134\n\nIf the connection/transaction dies, the mdb can rollback the onMessage.\n\nIf you are using failover just for discovery or loadbalancing, and use something like maxReconnectAttempts=0, there would be no recovery of the failover transport and it would not make any sense to track transactions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-09T15:35:32.403+0000","updated":"2016-08-09T15:35:32.403+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12995948/comment/15413778","id":"15413778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"body":"I use it for failover during upgrades, but it's not a master - slave setup, the brokers are just networked, so I assume that transaction tracking would really not help here anyway. \n\nBut I think that this can be solved by ConnectionStateTracker having static multi map from transactions to connections. Since all of these connections are managed by same resource adapter, they are in same class loader. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"created":"2016-08-09T16:03:54.297+0000","updated":"2016-08-09T16:03:54.297+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12995948/comment/15413911","id":"15413911","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Statics may not work as well in karaf/osgi","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-09T17:52:48.469+0000","updated":"2016-08-09T17:52:48.469+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12995948/comment/15415261","id":"15415261","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user pdudits opened a pull request:\n\n    https://github.com/apache/activemq/pull/197\n\n    https://issues.apache.org/jira/browse/AMQ-6391\n\n    Test case for multiple connections participating in one phase commit,\n    causing leak in ConnectionStateTracker.\n    \n    Keep all the connections participating in an transaction in a static multimap\n    similar to the one in TransactionContext.\n    \n    Even though Garry  says that static fields may cause issues in OSGi, I am offering this as a solution. This static map has same lifecycle, classloading and  source bundle as the one already present in TransactionContext, therefore I assume it cannot really make things worse.\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/pdudits/activemq amq-6391\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/activemq/pull/197.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #197\n    \n----\ncommit 1c36bac35f7ad9ccb4b7dd9f981dc915e78947ea\nAuthor: Patrik Dudits <patrik@dudits.net>\nDate:   2016-08-09T14:41:46Z\n\n    https://issues.apache.org/jira/browse/AMQ-6391\n    \n    Test case for multiple connections participating in one phase commit,\n    causing leak in ConnectionStateTracker.\n    \n    Keep all the connections participating in an transaction in a static multimap\n    similar to the one in TransactionContext.\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2016-08-10T13:19:35.746+0000","updated":"2016-08-10T13:19:35.746+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6391/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3237b:"}}