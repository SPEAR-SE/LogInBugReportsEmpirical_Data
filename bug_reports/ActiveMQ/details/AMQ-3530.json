{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12526332","self":"https://issues.apache.org/jira/rest/api/2/issue/12526332","key":"AMQ-3530","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2011-10-09T16:31:31.651+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Feb 24 16:01:27 UTC 2012","customfield_12310420":"50602","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_12005404676_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-02-24T16:01:27.704+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3530/watchers","watchCount":1,"isWatching":false},"created":"2011-10-08T17:11:23.130+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["activemq","nonPersistent","storeCursor","virtualTopic"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"9.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"issuelinks":[{"id":"12344053","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12344053","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12491692","key":"AMQ-3061","self":"https://issues.apache.org/jira/rest/api/2/issue/12491692","fields":{"summary":"Broker Deadlock when limiting size of temp store, and using VirtualTopics","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-02-24T16:01:27.801+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When using Virtual Topics and attempting to limit the Temp Table space the broker will dead lock.\n\nI have created a test case the demonstrates the above issue.  The test case has the following scenario:\n\n- 1 Producer Thread (own connection) writing to VirtualTopic.FooTwo\n-- writes 10000 messages\n- 2 Consumer Threads (each own connection) consuming from Consumer.X.VirtualTopic.FooTwo\n-- consumes message (auto ack - but message ack for good measure - delay of 10ms between consumption)\n\n\nThe dead lock occurs when using the either the KahaDB or ActiveMQPersistence persistence store is used, and seems more related to the KahaDB implementation used for the Temp storage area.\n\nI shall attach the test case (maven project), which when built (mvn clean package -DskipTests=true) will create an executable jar (target/5.5.0-deadlock-jar-with-dependencies.jar), from which the issue can be replicated:\n\nThe tests can be run as follows:\n\n{noformat}\njava -classpath target/5.5.0-deadlock-jar-with-dependencies.jar bbc.forge.domt.activemq.investigation.KahaDBTempStorageDeadlockReplication55\n{noformat}\n\nor \n\n{noformat}\njava -classpath target/5.5.0-deadlock-jar-with-dependencies.jar bbc.forge.domt.activemq.investigation.TempStorageDeadlockReplication55\n{noformat}\n\nThese classes are also Unit Test Cases, and output the following log files:\n\n- Producer logs to target/producer.log\n- Consumes log to target/consumer.log\n- A Monitor thread just run in the background that detail the number of messages sent and consumed... logs to target/monitor.log\n- tests write to the dir *{{target/activemq-data}}*\n\nThe target/monitor.log can be tailed, upon which you can see the dead lock occur; where the consumer stops consumering and  the producer stops sending; something like the following:\n\n{noformat}\nDominic-Tootells-MacBook-Pro-2:trunk dominict$ tail -f monitor.log\n[2011.10.08 17:15:09] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):0\n[2011.10.08 17:15:09] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:0\n[2011.10.08 17:15:10] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:10] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:35\n[2011.10.08 17:15:11] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:11] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:74\n[2011.10.08 17:15:12] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:12] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:114\n[2011.10.08 17:15:13] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:13] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:152\n[2011.10.08 17:15:14] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:14] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:192\n[2011.10.08 17:15:15] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:15] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:232\n[2011.10.08 17:15:16] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:16] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:248\n[2011.10.08 17:15:17] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:17] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:248\n[2011.10.08 17:15:18] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:18] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:248\n[2011.10.08 17:15:19] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Sent(Produced):248\n[2011.10.08 17:15:19] [Thread-14] INFO  MonitorConsumerAndProducedThread -  No of Message Consumed:248\n{noformat}\n\nTo disable limiting the temp storage add the System property *{{limit.temp=false}}*; and you see that the deadlock no longer occurs:\n\n{noformat}\njava -Dlimit.temp=false -classpath target/5.5.0-deadlock-jar-with-dependencies.jar bbc.forge.domt.activemq.investigation.KahaDBTempStorageDeadlockReplication55\n{noformat}\n\n\n----\n\nThe tests can be run as maven tests directly:\n\n{noformat}\nmvn clean test -Dtest=KahaDBTempStorageDeadlockReplication55Test -Dlimit.temp=true\n{noformat}\n\n----\n\n\nThis seems to be a different/additional issue to AMQ-2475\n\n----\n\nThe reason why this issue affects our ActiveMQ environment/installation so much, is that we use a shared infrastructure model.  Meaning that we provision many activemq instances on the same physcial hardware for different projects/clients.  We limit the disk space assigned to each broker so that no one application goes wild and consumes all the disk space on the hardware; and as a result impacts other projects/clients.  Although it theory running more than one instance of ActiveMQ on a server might seem counter intutitive (with regards to performance - disk seeking); this is a business model by which we can get the most money out of out physical hardware and provide a MOM for most projects; for which maximum throughput is a secondary concern.\n\nApologies that this issue is a duplicate of AMQ-3061.  However, the reason I'm opening an additional ticket is the hope that I can actually provide you a patch in here (if possible) that is coded against the 5.5 apache activemq version.  As in AMQ-3061 I accidentally:\n\na) provided a faulty patch\nb) gave you a patch against a 5.4.1 version of fuse's activemq.\n\nBig appologies for that.  \n\n\nthanks in advance, let me know if you need any more information.\n/dom\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12498320","id":"12498320","filename":"deadlock.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-08T17:14:10.142+0000","size":6875785,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12498320/deadlock.tar.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12498352","id":"12498352","filename":"FilePendingMessageCursor.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-09T14:52:28.714+0000","size":18046,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12498352/FilePendingMessageCursor.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12498353","id":"12498353","filename":"FilePendingMessageCursor.patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-09T14:52:28.724+0000","size":2479,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12498353/FilePendingMessageCursor.patch.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12498350","id":"12498350","filename":"Queue.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-09T14:52:28.692+0000","size":87529,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12498350/Queue.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12498351","id":"12498351","filename":"Queue.patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-09T14:52:28.704+0000","size":2431,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12498351/Queue.patch.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511442","id":"12511442","filename":"StoreQueueCursor.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-22T20:24:29.985+0000","size":11004,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12511442/StoreQueueCursor.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12498349","id":"12498349","filename":"StoreQueueCursor.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-09T14:52:28.681+0000","size":10702,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12498349/StoreQueueCursor.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511443","id":"12511443","filename":"StoreQueueCursor.patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-22T20:24:29.995+0000","size":2154,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12511443/StoreQueueCursor.patch.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12498354","id":"12498354","filename":"StoreQueueCursor.patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-09T14:52:28.734+0000","size":1639,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12498354/StoreQueueCursor.patch.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"81668","customfield_12312823":null,"summary":"Broker (5.5) Deadlock when limiting size of temp store, and using VirtualTopics","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"10.8.0 Darwin Kernel Version 10.8.0: Tue Jun  7 16:33:36 PDT 2011; root:xnu-1504.15.3~1/RELEASE_I386 i386","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13123534","id":"13123534","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"deadlock.tar.gz contains the mvn project that demonstrates the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-08T17:14:10.202+0000","updated":"2011-10-08T17:14:10.202+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13123700","id":"13123700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nHere's my attempt at providing a patch for the issue we are encountering (this is based on the 5.5.0 source - https://svn.apache.org/repos/asf/activemq/tags/activemq-5.5.0/).  I have run mvn test across the activemq 5.5.0 code base; with the patch applied; and I get the same test results as when running the test suite without the patches applied.\n\nPlease let me know if there is more information you require.\n\nThanks\n/dom","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-09T14:52:28.859+0000","updated":"2011-10-09T14:52:28.859+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13123723","id":"13123723","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Have you tried the trunk code?  The next release will come from there so any patches would need to be applicable to that code and there's been a lot of changes since 5.5 was released.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-10-09T16:31:31.651+0000","updated":"2011-10-09T16:31:31.651+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13123753","id":"13123753","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"Hi there,\n\n- I checked out trunk\n- build trunk\n- ran the deadlock code.\n\nI'm still seeing the deadlock occur with trunk.  I'll see if I can apply the patches provided to trunk locally and run the deadlock replication again and report back.\n\ncheers\n/dom","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-09T18:57:46.121+0000","updated":"2011-10-09T18:57:46.121+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13123975","id":"13123975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nI applied the patches to trunk locally (the same patches as detailed in the *.patch.txt(s) attached); and ran the deadlock replication code.  With the patches applied I do not see the deadlock.  I'm currently running the unit test suite locally, to see if there's any regression caused due to this patch (not that this is a 100% guarantee).  \n\nAs the unit test suite takes a rather long time to execute; I'll report back later on.\n\ncheers\n/dom","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-10T09:33:41.819+0000","updated":"2011-10-10T09:33:41.819+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13124975","id":"13124975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"Hi there,\n\nSorry for the delay in getting back (takes a while to run the suites).  I ran the unit tests for:\n\n- vanilla trunk (no patches)\n- patched trunk\n\nThe 3 tests that consistently failed in both the vanilla and patched version are:\n\n- org.apache.activemq.bugs.AMQ2983Test \n- org.apache.activemq.transport.stomp.StompNIOSSLTest  \n- org.apache.activemq.transport.vm.VmTransportNetworkBrokerTest\n\n----\n\nAll tests that passed in vanilla passed in the patched version.  Obviously this is not a 100% guarantee that the patches don't break anything; but some way there.  I'll leave you to look them over.\n\nPlease get back to me if you have any questions\nthanks\n/dom","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-11T12:29:18.471+0000","updated":"2011-10-11T12:29:18.471+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13128983","id":"13128983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"I noticed that the patch to FilePendingMessageCursor as attached is irrelevant; so it can be ignored.  I tested without that patch to FilePendingMessageCursor applied, and the deadlock doesn't occur (The other two patches are required in order to avoid the deadlock).  \n\n(FilePendingMessageCursor is irrelevant as the patch is for non deadlocking of the <storeCursor/> when using non persistent messages to a virtual topic, whilst restricting temp disk space.  The deadlocking of <fileQueueCursor/> still occurs with the same scenario and the applied patches; and I have no found a valid solution to this.  However, having one cursor free from deadlock is workable for our current use of AMQ)\n\ncheers,\n/dom\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2011-10-17T16:30:02.943+0000","updated":"2011-10-18T09:19:13.312+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13184178","id":"13184178","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"Any news on this?\nThanks\n/dom","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-11T16:32:23.752+0000","updated":"2012-01-11T16:32:23.752+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13190765","id":"13190765","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"Updated StoreQueueCursor patch (StoreQueueCursor.java and StoreQueueCursor.patch.txt), so that the pendingCount is reduced if a ResourceAllocationException is thrown, otherwise it is updated; and not reduced if the error is throw.\n\n(deadlock still occurs on trunk, tested on 5.5.1 (fuse distro 551-fuse-01-20))\n\nthanks\n/dom","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-22T20:27:23.111+0000","updated":"2012-01-22T20:27:23.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12526332/comment/13215709","id":"13215709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nSorry, just noticed I've been a Muppet, and noticed that the problem is exactly as described in the following:\n\nhttp://tmielke.blogspot.com/2011/02/observations-on-activemqs-temp-storage.html\n\nWhere the temp limit should never be set lower than the journal file size; due to the fact that the 1st temp file doesn't get removed.\n\nThe unit tests provided had exactly this issue, and didn't set the max journal size:\n{noformat}\n        tempStore.setJournalMaxFileLength((1024*1024)*2);\n{noformat}\n\nAnd as a result the default 32mb, and the temp store was 10mb; resulting in the issue as described.\n\nUpon setting the journal length to 2mb in the test; all worked as expect; no issues at all.\n\nApologies\n/dom","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dominict","name":"dominict","key":"dominict","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominic Tootell","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-24T16:01:27.765+0000","updated":"2012-02-24T16:01:27.765+0000"}],"maxResults":10,"total":10,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3530/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ebrj:"}}