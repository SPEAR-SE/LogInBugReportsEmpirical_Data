{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12776907","self":"https://issues.apache.org/jira/rest/api/2/issue/12776907","key":"AMQ-5609","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Feb 23 20:37:11 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5609/watchers","watchCount":1,"isWatching":false},"created":"2015-02-23T18:44:07.359+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326456","id":"12326456","name":"5.10.1","archived":false,"released":true,"releaseDate":"2015-01-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-02-23T20:37:11.141+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"ActiveMQ supports a feature where it can GC a queue that is inactive. IE now messages and no consumers.\n\nHowever, there’s a bug where \n\npurgeInactiveDestinations \n\nin \n\norg.apache.activemq.broker.region.RegionBroker\n\ncreates a read/write lock (inactiveDestinationsPurgeLock) which is held during the entire queue GC.\n\neach individual queue GC takes about 100ms with a disk backed queue and 10ms with a memory backed (non-persistent) queue. If you have thousands of them to GC at once the inactiveDestinationsPurgeLock lock is held the entire time which can last from 60 seconds to 5 minutes (and essentially unbounded).\n\nA read lock is also held for this in addConsumer addProducer so that when a new consumer or produce tries to connect, they’re blocked until queue GC completes.\n\nExisting producers/consumers work JUST fine.  \n\nThe lock MUST be held on each queue because if it isn’t there’s a race where a queue is flagged to be GCd , then a producer comes in and writes a new message, then the background thread deletes the queue which it marked as GCable but it had the newly produced message.  This would result in data loss.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ActiveMQ locks out new consumers/producers during queue GC","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776907/comment/14333650","id":"14333650","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"body":"I've implemented a fix for this and will release it today.\n\nMy fix was per discussion on the list.\n\nThe design takes RegionBroker and the inactiveDestinationsPurgeLock and breaks it up by granularity based on the ActiveMQDestination.\n\nThis way two destinations with the same physical name don't acquire the same lock.  This makes purge WAY more concurrent.\n\nI've implemented a ChunkedGranularReentrantReadWriteLock which internally uses 1024 ReentrantReadWriteLocks so there's a 1/1024 chance that a given queue will use the same lock as another queue.  \n\nThis isn't perfect but in practice this should be MORE than enough concurrency to solve the 80% solution.\n\nA more correct model would be to acquire a lock per queue name but this opens up some complex concurrency issues regarding cleaning up ReentrantReadWriteLocks for queues as they disappear.  For now we're using a simple interface so if someone wants to improve upon this in the future they can just change the implementation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-23T18:50:33.697+0000","updated":"2015-02-23T18:50:33.697+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776907/comment/14333652","id":"14333652","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"body":"My changes are here:\n\nhttps://github.com/spinn3r/activemq\n\nthe branch is burton-concurrent-destination-gc \n\n... it's testing now but I'll post the results here when the tests pass.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-23T18:51:48.895+0000","updated":"2015-02-23T18:51:48.895+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776907/comment/14333688","id":"14333688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"body":"Additional unit tests here:\n\nhttps://github.com/spinn3r/activemq-gc-purge-lockup\n\nWhich I can contribute as well. It's showing that maximum createConsumer latency went down from about 60000ms to about 2ms.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-23T19:21:58.646+0000","updated":"2015-02-23T19:21:58.646+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12776907/comment/14333778","id":"14333778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"body":"My branch fails testing but so does activemq-5.11.x.  My isolated tests show that I've fixed the bug but now I want to get it to test before I can submit a patch. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-23T20:37:11.141+0000","updated":"2015-02-23T20:37:11.141+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5609/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i25xon:"}}