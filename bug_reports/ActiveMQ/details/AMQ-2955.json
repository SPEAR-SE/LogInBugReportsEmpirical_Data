{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483849","self":"https://issues.apache.org/jira/rest/api/2/issue/12483849","key":"AMQ-2955","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-10-12T10:41:17.854+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Apr 19 12:49:08 UTC 2011","customfield_12310420":"14832","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_17265735608_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-04-19T12:49:08.543+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2955/watchers","watchCount":7,"isWatching":false},"created":"2010-10-01T16:46:53.066+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315624","id":"12315624","description":"Maintenance release for 5.4.0","name":"5.4.1","archived":false,"released":true,"releaseDate":"2010-09-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-04-19T12:49:08.601+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Using the following test client, we see a single message getting stuck on the queue. This then prevents the KahaDB files from being cleaned up. Once this message gets stuck, we need to restart the broker before it can be consumed. This is a total show stopper for us, as when this occurs in our system the large number of messages that we produce and consume each second causes the disk to run out of space within the space of an hour. We also see the same behaviour using synchronous sending and without failover.\n\nThis doesn't happen every time with the test client - the most reliable way I have found to reproduce it is to start the broker and wait for the first MessageDatabase checkpoint to finish before starting the test client. \n\n{code:title=Test Client}\nimport java.io.BufferedWriter;\nimport java.io.FileWriter;\nimport java.util.Random;\n\nimport javax.jms.Connection;\nimport javax.jms.Message;\nimport javax.jms.MessageConsumer;\nimport javax.jms.MessageListener;\nimport javax.jms.MessageProducer;\nimport javax.jms.Queue;\nimport javax.jms.Session;\nimport javax.jms.ConnectionFactory;\n\nimport org.apache.activemq.ActiveMQConnectionFactory;\n\npublic class Test {\n        public static final void main(String[] args) throws Exception {\n                ConnectionFactory cf = new ActiveMQConnectionFactory(\"failover:(tcp://localhost:61616)?jms.useAsyncSend=true&trackMessages=true\");\n                final Connection producerConn = cf.createConnection();\n                final Connection consumerConn = cf.createConnection();\n\n                final BufferedWriter producerLog = new BufferedWriter(new FileWriter(\"produced.log\"));\n                final BufferedWriter consumerLog = new BufferedWriter(new FileWriter(\"consumed.log\"));\n\n                new Thread(new Runnable() {\n                        public void run() {\n                                try {\n                                        producerConn.start();\n                                        Session session = producerConn.createSession(false, Session.CLIENT_ACKNOWLEDGE);\n                                        Queue queue = session.createQueue(\"TEST_QUEUE\");\n                                        MessageProducer producer = session.createProducer(queue);\n                                        Random random = new Random();\n                                        byte[] messageBytes = new byte[1024];\n\n                                        for (int i = 0; i < 100000; i++) {\n                                        //while (true) {\n                                                random.nextBytes(messageBytes);\n                                                Message message = session.createObjectMessage(messageBytes);\n                                                producer.send(message);\n                                                producerLog.write(message.getJMSMessageID());\n                                                producerLog.newLine();\n                                                producerLog.flush();\n                                        }\n                                        System.out.println(\"Produced 100000 messages...\");\n                                        producerLog.close();\n                                }\n                                catch (Exception e) {\n                                        e.printStackTrace();\n                                }\n                        }\n                }).start();\n\n                System.out.println(\"Started producer...\");\n\n                new Thread(new Runnable() {\n                        public void run() {\n                                try {\n                                        consumerConn.start();\n                                        Session session = consumerConn.createSession(false, Session.CLIENT_ACKNOWLEDGE);\n                                        Queue queue = session.createQueue(\"TEST_QUEUE\");\n                                        MessageConsumer consumer = session.createConsumer(queue);\n                                        consumer.setMessageListener(new MessageListener() {\n                                                public void onMessage(Message message) {\n                                                        try {\n                                                                message.acknowledge();\n                                                                consumerLog.write(message.getJMSMessageID());\n                                                                consumerLog.newLine();\n                                                                consumerLog.flush();\n                                                        }\n                                                        catch (Exception e) {\n                                                                e.printStackTrace();\n                                                        }\n                                                }\n                                        });\n                                }\n                                catch (Exception e) {\n                                        e.printStackTrace();\n                                }\n                        }\n                }).start();\n\n                System.out.println(\"Started consumer...\");\n        }\n}\n{code}\n\nAfter the 100,000 messages have been produced, we can see the following difference in the log files:\n\n{noformat}\n[pblackburn@xxxx test]$ diff produced.log consumed.log\n10394d10393\n< ID:xxxx-35451-1285948546531-0:0:1:1:10394\n[pblackburn@xxxx test]$\n{noformat}\n\nLooking in the activemq log file, at around this point we see:\n\n{noformat}\n2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 205, pagedInMessages.size 349, enqueueSize: 10390\n2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 205, pagedInMessages.size 350, enqueueSize: 10391\n2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 205, pagedInMessages.size 351, enqueueSize: 10392\n2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 205, pagedInMessages.size 352, enqueueSize: 10393\n2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 69% of available memory, to: 70% of available memory\n2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 70% of available memory, to: 69% of available memory\n2010-10-01 15:55:51 AbstractStoreCursor [DEBUG] TEST_QUEUE disabling cache on size:0, lastCachedIdSeq: 10398 current node seqId: 10399\n2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 69% of available memory, to: 70% of available memory\n2010-10-01 15:55:51 Queue [DEBUG] TEST_QUEUE toPageIn: 2, Inflight: 353, pagedInMessages.size 353, enqueueSize: 10395\n2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 70% of available memory, to: 69% of available memory\n2010-10-01 15:55:51 Usage [DEBUG] Main:memory:queue://TEST_QUEUE:memory: usage change from: 69% of available memory, to: 70% of available memory\n{noformat}\n\nAt the end of the log file, where we have a single message stuck on the queue, we see:\n\n{noformat}\n2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000\n2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000\n2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000\n2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000\n2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000\n2010-10-01 15:56:10 Queue [DEBUG] TEST_QUEUE toPageIn: 1, Inflight: 0, pagedInMessages.size 0, enqueueSize: 100000\n{noformat}\n\nWe can see the checkpoint failing to clean up the log files:\n\n{noformat}\n2010-10-01 15:56:36 MessageDatabase [DEBUG] Checkpoint started.\n2010-10-01 15:56:36 MessageDatabase [DEBUG] not removing data file: 2 as contained ack(s) refer to referenced file: [1, 2]\n2010-10-01 15:56:36 MessageDatabase [DEBUG] not removing data file: 3 as contained ack(s) refer to referenced file: [2, 3]\n2010-10-01 15:56:36 MessageDatabase [DEBUG] not removing data file: 4 as contained ack(s) refer to referenced file: [3, 4]\n2010-10-01 15:56:36 MessageDatabase [DEBUG] not removing data file: 5 as contained ack(s) refer to referenced file: [4, 5]\n2010-10-01 15:56:36 MessageDatabase [DEBUG] Checkpoint done.\n{noformat}\n\nAt this point our consumer had consumed all of the messages except the single stuck message.\n\nWe are using a clean out of the box set up - we have made no changes to the default activemq.xml file,\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461837","id":"12461837","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-13T12:58:15.172+0000","size":5601,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12461837/activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461810","id":"12461810","filename":"TrackedMessageDequeuer.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-12T12:50:56.786+0000","size":3109,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461810/TrackedMessageDequeuer.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461809","id":"12461809","filename":"TrackedMessageEnqueuer.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-12T12:50:56.738+0000","size":3224,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461809/TrackedMessageEnqueuer.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59571","customfield_12312823":null,"summary":"Message getting stuck on queue, leading to KahaDB log files not being deleted and disk running out of space","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Red Hat Enterprise Linux 5","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483849/comment/12943043","id":"12943043","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"body":"With a different test harness, we can get this failure to occur at the same point every time (for 1K message size always happens at  the 286th message sent, for 10K message size  at the 45th message sent nd for 100K message size at the 5th message sent).\n\nFurther investigation shows that when this occurs, the following conditions hold:\n\nIn class {{Queue}}, method {{doPageIn}}, the following loop body does not get executed as {{messages.hasNext()}} is returning false:\n\n{code}\nwhile (messages.hasNext() && count < toPageIn) {\n    MessageReference node = messages.next();\n    messages.remove();\n// snipped for brevity\n{code}\n\nAt this point, {{count=0}}, {{toPageIn=1}} and {{messages.size()=1}}.\n\nFollowing the code through to the {{BTreeNode}} class, we find that the leaf node contains a single key with value 44.  When the {{BTreeNode.BTreeIterator}} class is instantiated, it is being passed in a value of 535 for the value of the default cursor position as the {{batchResetNeeded}} flag is false. This causes the loop body in the {{findNextPage}} method to exit before it sets the {{nextEntry}} field, leaving it null.\n\nIf we stick a quick hack into the {{doPageIn}} method in class {{Queue}} then the problem seems to go away, but we still don't know what the underlying cause was and we are wary of changing code that we don't fully understand:\n\n{code}\nif (messages.size() > 0 && !messages.hasNext()) {\n    store.resetBatching();\n}\n\nwhile (messages.hasNext() && count < toPageIn) {\n    MessageReference node = messages.next();\n    messages.remove();\n// snipped for brevity\n{code}\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-11T17:07:17.036+0000","updated":"2010-10-11T17:07:17.036+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483849/comment/12943036","id":"12943036","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"My suspicion is the operation of the setBatch method, disabling the cache will help pinpoint (policy entry useCache=false).\n\nOne thing that looks odd is in org.apache.activemq.store.kahadb.KahaDBStore.KahaDBMessageStore#resetBatching,\nthat does not obtain the indexLock, it should be comparable to org.apache.activemq.store.kahadb.KahaDBStore.KahaDBMessageStore#setBatch in this regard. It looks like this could be related to your problem, if an batch rest was missed from contention.\n\nbtw: What is the difference between your test case above and the other test harness?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-12T10:41:17.854+0000","updated":"2010-10-12T10:41:17.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483849/comment/12943049","id":"12943049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"body":"Attached test harness. \n\nCompile with following:\n\n{noformat}\njavac -cp .activemq-core-5.4.1.jar:geronimo-j2ee-management_1.1_spec-1.0.1.jar:log4j-1.2.15.jar:commons-logging.jar:jms.jar *.java\n{noformat}\n\nWhen producing the error, we restart the activemq server and wait until we see the MessageDatabase \"Checkpoint done\" message in the log, then kick off the enquer as follows:\n\n{noformat}\njava -cp .:jms.jar:activemq-core-5.4.1.jar:geronimo-j2ee-management_1.1_spec-1.0.1.jar:log4j-1.2.15.jar:commons-logging.jar jms.TrackedMessageEnqueuer 'tcp://localhost:61616' 1 10 0\n{noformat}\n\nand then immediately kick off the dequeuer as follows:\n\n{noformat}\njava -cp .:jms.jar:lib/activemq-core-5.4.1.jar:geronimo-j2ee-management_1.1_spec-1.0.1.jar:log4j-1.2.15.jar:commons-logging.jar jms.TrackedMessageDequeuer 'tcp://localhost:61616'\n{noformat}\n\nWe don't always get the error, but when it occurs it is always on the 45th message sent, using the 10K message size as shown.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-12T12:50:56.872+0000","updated":"2010-10-12T12:57:29.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483849/comment/12942848","id":"12942848","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for that Gary, I added some additional debug - the method {{KahaDBStore.KahaDMMessageStore#resetBatching}} is called once as the broker starts up and is not called again during my test run (I removed my hack from the {{Queue}} class).\n\nI then tried the following three variations of this method:\n# Added call to {{indexLock.readLock().lock()}}\n# Added call to {{lockAsyncJobQueue}} and {{indexLock.readLock().lock()}}\n# Added call to {{indexLock.writeLock().lock()}}\n\nThe stuck message is still observed with each variation.\n\nI'll keep digging.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-12T15:18:03.397+0000","updated":"2010-10-12T15:18:03.397+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483849/comment/12943060","id":"12943060","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"body":"As suggested, I tried adding {{useCache=\"false\"}} to the queues' {{policyEntry}} element in {{activemq.xml}}. After doing this I have been unable to reproduce the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-13T09:41:50.231+0000","updated":"2010-10-13T09:42:23.902+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483849/comment/12943066","id":"12943066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"that is good, in that it points to org.apache.activemq.store.kahadb.KahaDBStore.KahaDBMessageStore#setBatch and the cursor and store being out of sync. The intention is that when the cache is full and eventually exhausted, reading from the store can commence from the point in the store that corresponds to the last entry in the cache. \ncan you attach your activemq.xml?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-13T12:07:26.777+0000","updated":"2010-10-13T12:07:26.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483849/comment/12943017","id":"12943017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"body":"Attached {{activemq.xml}} file used.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pblackburn","name":"pblackburn","key":"pblackburn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Blackburn","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-13T12:58:15.246+0000","updated":"2010-10-13T12:58:15.246+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483849/comment/13021566","id":"13021566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"I cannot reproduce this problem in 5.5.0 version (while it is easily reproduced in 5.4.1 and 5.4.2). There was some work in this area for 5.5.0 release, so it seems that this has been fixed as well.\n\nCan you please retest and reopen the issue if you still experience problems.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2011-04-19T12:49:08.573+0000","updated":"2011-04-19T12:49:08.573+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2955/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0akcv:"}}