{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13195794","self":"https://issues.apache.org/jira/rest/api/2/issue/13195794","key":"AMQ-7089","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/10004","id":"10004","description":"Not A Bug","name":"Not A Bug"},"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Nov 05 01:35:52 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_261124718_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-11-05T01:35:52.796+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-7089/watchers","watchCount":1,"isWatching":false},"created":"2018-11-02T01:03:48.132+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12344049","id":"12344049","description":"","name":"5.15.7","archived":false,"released":true,"releaseDate":"2018-10-27"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-11-05T01:35:52.847+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"On my Linux machine I have been running ActiveMQ on a filesystem setup like this:\r\n{noformat}\r\nFilesystem Size Used Avail Use% Mounted on\r\n/dev/nvme0n1p1 407G 299G 88G 78% /\r\n...\r\n/dev/nvme1n1p2 477G 443G 35G 93% /media/sits/DATA\r\n{noformat}\r\nWhen I call broker.setDataDirectoryFile(\"/media/sits/DATA/activemq') after broker initialisation it reports the amount of free temp space usage is the free space on '/', not on '/media/sits/DATA'.\r\n\r\nThe culprit is BrokerService.checkTmpStorageUsageLimits() calls checkUsageLimit(tmpDir, usage.getTempUsage(), usage.getTempUsage().getPercentLimit()) which ultimately calls this code:\r\n{code}\r\n    protected void checkUsageLimit(File dir, Usage<?> storeUsage, int percentLimit) throws ConfigurationException {\r\n        if (dir != null) {\r\n            dir = StoreUtil.findParentDirectory(dir);\r\n            String storeName = storeUsage instanceof StoreUsage ? \"Store\" : \"Temporary Store\";\r\n            long storeLimit = storeUsage.getLimit();\r\n            long storeCurrent = storeUsage.getUsage();\r\n            long totalSpace = dir.getTotalSpace();\r\n{code}\r\nThe problem is StoreUtil is broken on Linux (and probably other OS's) since you can mount a filesystems in non-root locations.  Even on Windows this is possible.\r\n{code}\r\n    public static File findParentDirectory(File dir) {\r\n        if (dir != null) {\r\n            String dirPath = dir.getAbsolutePath();\r\n            if (!dir.isAbsolute()) {\r\n                dir = new File(dirPath);\r\n            }\r\n\r\n            while (dir != null && !dir.isDirectory()) {\r\n                dir = dir.getParentFile();\r\n            }\r\n        }\r\n        return dir;\r\n    }\r\n{code}\r\nOn Linux this will always go to '/' and use that for reporting free space which is clearly wrong.\r\n\r\nThere are only a few usages of this method.  My proposal is to nuke this method and instead update the clients to just call Files.getFileStore(Path path) and then FileStore.getTotalSpace() and FileStore.getUsableSpace.\r\n\r\nI'm happy to submit a PR if people are happy with the approach?\r\n\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"StoreUtil.findParentDirectory does not work correctly on Linux","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13195794/comment/16674579","id":"16674579","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"My apologies.. my wires were crossed with my initial report in AMQ-7085 and the comment to findParentDirectory which said \"Utility method to help find the root directory of the store\".  The comment is completely out of sync with the code, which returns the first directory which exists.\r\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2018-11-05T01:35:52.836+0000","updated":"2018-11-05T01:35:52.836+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-7089/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|s001r4:"}}