{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13042895","self":"https://issues.apache.org/jira/rest/api/2/issue/13042895","key":"AMQ-6599","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338054","id":"12338054","name":"5.15.0","archived":false,"released":true,"releaseDate":"2017-07-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12338909","id":"12338909","name":"5.14.4","archived":false,"released":true,"releaseDate":"2017-03-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-02-17T13:04:48.873+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Feb 17 23:23:10 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_268864722_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-02-17T13:07:37.351+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6599/watchers","watchCount":3,"isWatching":false},"created":"2017-02-14T10:26:32.683+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338822","id":"12338822","name":"5.14.3","archived":false,"released":true,"releaseDate":"2016-12-22"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-02-17T23:23:10.111+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Currently I have trouble with many established TCP connections and threads hanging in the NIO+SSL handshake step. The hardware devices I use often have problems during SSL handshake and do not respond any more. So I thought configuring a transport.soTimeout value should solve the problem of hanging connections, because something like the MQTT  transport.defaultKeepAlive check is not applicable in this step yet. But setting transport.soTimeout=30000 had no effect.\nI made a remote debug session to the ActiveMQ broker and saw lots of threads waiting at NIOSSLTransport.java Line 430:\n\n    int keyCount = selector.select(this.getSoTimeout());\n    if (keyCount == 0 && this.getSoTimeout() > 0 && ((System.currentTimeMillis() - now) >= this.getSoTimeout())) {\n        throw new SocketTimeoutException(\"Timeout during handshake\");\n    }\n\nAt this point this.getSoTimeout returns always 0, which results in infinite timeout.\nI tried to figure out why the soTimeout setting works not as configured and found the code where the NIOSSLTransport object is created: TcpTransportServer.java function doHandleSocket(Socket socket). Here in line 580:\n\n    options.putAll(transportOptions);\n\nThe soTimeout value is already removed from the transportOptions but it was apperantly not applied to the relevant object.\n\nTo solve my problem for now I tried if the transport.soTimeout configuration works in a MQTT+SSL Stack (without using NIO) and it worked.\n\nMay you please be so kind and solve this issue, so that the transport.soTimeout configurations works during SSL handshake and payload transfer as well for NIO.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"MQTT+NIO+SSL transport: transport.soTimeout is not applied during SSL handshake","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomas.winterhalder","name":"thomas.winterhalder","key":"thomas.winterhalder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomas.winterhalder&avatarId=30662","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomas.winterhalder&avatarId=30662","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomas.winterhalder&avatarId=30662","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomas.winterhalder&avatarId=30662"},"displayName":"Thomas Winterhalder","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomas.winterhalder","name":"thomas.winterhalder","key":"thomas.winterhalder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomas.winterhalder&avatarId=30662","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomas.winterhalder&avatarId=30662","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomas.winterhalder&avatarId=30662","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomas.winterhalder&avatarId=30662"},"displayName":"Thomas Winterhalder","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Ubuntu 16.04\nopenjdk version \"1.8.0_121\"\nOpenJDK Runtime Environment (build 1.8.0_121-8u121-b13-0ubuntu1.16.04.2-b13)\nOpenJDK 64-Bit Server VM (build 25.121-b13, mixed mode)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13042895/comment/15871820","id":"15871820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit f6bf823dedba54dea40b597f1762ac6d7308ffa6 in activemq's branch refs/heads/master from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=f6bf823 ]\n\nAMQ-6599 - Properly apply soTimeout value to TcpTransport\n\nhttps://issues.apache.org/jira/browse/AMQ-6599\n\nThe soTimeout value needs to be applied to the TcpTransport as well as\nthe socket because the NIO transports use the value later on when\nestablishing a connection\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-17T13:04:48.873+0000","updated":"2017-02-17T13:04:48.873+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13042895/comment/15871821","id":"15871821","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit f6bf823dedba54dea40b597f1762ac6d7308ffa6 in activemq's branch refs/heads/master from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=f6bf823 ]\n\nAMQ-6599 - Properly apply soTimeout value to TcpTransport\n\nhttps://issues.apache.org/jira/browse/AMQ-6599\n\nThe soTimeout value needs to be applied to the TcpTransport as well as\nthe socket because the NIO transports use the value later on when\nestablishing a connection\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-17T13:04:52.228+0000","updated":"2017-02-17T13:04:52.228+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13042895/comment/15871823","id":"15871823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 7c84aca59f89523c20daeced2b5f849d0fac0740 in activemq's branch refs/heads/activemq-5.14.x from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=7c84aca ]\n\nAMQ-6599 - Properly apply soTimeout value to TcpTransport\n\nThe soTimeout value needs to be applied to the TcpTransport as well as\nthe socket because the NIO transports use the value later on when\nestablishing a connection\n\n(cherry picked from commit f6bf823dedba54dea40b597f1762ac6d7308ffa6)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-02-17T13:05:42.250+0000","updated":"2017-02-17T13:05:42.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13042895/comment/15871825","id":"15871825","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"The issue was the soTimeout value was being remove from the options map after being applied to the Socket so it was not applied on the TcpTransport itself.  For normal transports this is not a problem but for the NIO transports this causes the soTimeout value to always be 0 later on when it is used on selector.select(soTimeout) as you found.  I'm planning on working on the 5.14.4 release next week so the fix should be out soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-02-17T13:07:25.555+0000","updated":"2017-02-17T13:07:25.555+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13042895/comment/15872724","id":"15872724","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomas.winterhalder","name":"thomas.winterhalder","key":"thomas.winterhalder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomas.winterhalder&avatarId=30662","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomas.winterhalder&avatarId=30662","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomas.winterhalder&avatarId=30662","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomas.winterhalder&avatarId=30662"},"displayName":"Thomas Winterhalder","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks for fixing this issue so fast!\n:-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomas.winterhalder","name":"thomas.winterhalder","key":"thomas.winterhalder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=thomas.winterhalder&avatarId=30662","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=thomas.winterhalder&avatarId=30662","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=thomas.winterhalder&avatarId=30662","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=thomas.winterhalder&avatarId=30662"},"displayName":"Thomas Winterhalder","active":true,"timeZone":"Europe/Berlin"},"created":"2017-02-17T23:23:10.111+0000","updated":"2017-02-17T23:23:10.111+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6599/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3a1un:"}}