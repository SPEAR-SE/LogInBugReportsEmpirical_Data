{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13056214","self":"https://issues.apache.org/jira/rest/api/2/issue/13056214","key":"AMQ-6627","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2017-03-15 08:25:48.326","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6627/watchers","watchCount":2,"isWatching":false},"created":"2017-03-15T08:25:48.326+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338329","id":"12338329","name":"5.14.2","archived":false,"released":true,"releaseDate":"2016-12-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-03-15T08:25:48.326+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325101","id":"12325101","name":"networkbridge"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Hi,\nwe have 6 ActiveMQ (5.14.2) brokers running on Apache Karaf:\n- amq1 (prod and dr) - master/slave\n- amq2 (prod and dr) - master/slave\n- amq3 (prod and dr) - master/slave\n\nThese brokers are connnected with network configured via mq-fabric.\n\nProducer and consumers connect to amq1, amq2 or amq3 via load balancer using round robin algorithm.\n\nProducers connects to each broker and send messages without problems.\n\nConsumers are long-lived and connects to each queue and listen.\n\nProblem is when, for example, amq2prod goes down for a moment and switches to amq2dr. Network is established after switch, producers sends messages to, for example, queue error.history.in on each broker (including amq2), but no consumers are created for this queue on amq2. All real consumers for this queue are connected to amq1 or amq3, but amq2 do not forward messages to them.\n\nI hope this is configuration problem of our network. What we are doing wrong?\n\n============================================\n\nOur Configuration\n\nBroker configuration is common and properties are filled by mq-fabric:\n\n{code}\n<beans\n  xmlns=\"http://www.springframework.org/schema/beans\"\n  xmlns:amq=\"http://activemq.apache.org/schema/core\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd\n\t\t\t\t\t  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd\"\n>\n\n    <!-- Allows us to use system properties and fabric as variables in this configuration file -->\n    <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\">\n        <property name=\"properties\">\n            <bean class=\"io.fabric8.mq.fabric.ConfigurationProperties\" />\n        </property>\n    </bean>\n\n    <broker xmlns=\"http://activemq.apache.org/schema/core\"\n            xmlns:b=\"http://www.springframework.org/schema/beans\"\n      brokerName=\"${broker-name}\"\n      dataDirectory=\"${data}\"\n      useJmx=\"true\"\n      enableStatistics=\"true\"\n      advisorySupport=\"true\"\n      persistent=\"true\"\n      schedulerSupport=\"true\"\n      start=\"false\"\n      restartAllowed=\"false\"\n    >\n\n        <managementContext>\n            <managementContext createConnector=\"false\" />\n        </managementContext>\n\n        <persistenceAdapter>\n            <jdbcPersistenceAdapter dataSource=\"#amqDataSource\">\n              <statements>\n                <statements tablePrefix=\"AMQ4_\" />\n              </statements>\n            </jdbcPersistenceAdapter>\n        </persistenceAdapter>\n\n        <plugins>\n            <jaasAuthenticationPlugin configuration=\"karaf\" />\n            <runtimeConfigurationPlugin checkPeriod=\"30000\" />\n        </plugins>\n\n    \t<!-- system usage omitted -->\n\n        <transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://0.0.0.0:61696?transport.closeAsync=false\" />\n        </transportConnectors>\n\n    </broker>\n\n    <!-- amqDataSource configuration omitted -->\n\n</beans>\n{code}\n\nConfiguration is similar for each broker io.fabric8.mq.fabric.server-<brokername> - different is only ds-sid, ds-username and ds-password:\n\n{code}\nconfig=profile\\:broker.xml\nconfig.checksum=${checksum:profile\\:broker.xml}\n\nbroker-name=amq1\ndata=${runtime.data}/amq\nds-sid=AMQ1\nds-username=${profile:amq.ds.${containerEnv}/amq1Username}\nds-password=${profile:amq.ds.${containerEnv}/amq1Password}\n\nconnectors=openwire\n\ngroup=AMQ4\nkind=MasterSlave\nstandby.pool=AMQ4\n\nnetwork=AMQ4\nnetwork.userName=amq\nnetwork.password=${profile:amq.ds.${containerEnv}/amqNetworkPassword}\nnetwork.messageTTL=-1\nnetwork.consumerTTL=1\nnetwork.networkConnectorStartAsync=true\nnetwork.suppressDuplicateQueueSubscriptions=true\nnetwork.suppressDuplicateTopicSubscriptions=true\n{code}\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Network configured via mq-fabric do not create consumers after master/slave switch","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alien11689","name":"alien11689","key":"alien11689","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alien11689&avatarId=27150","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alien11689&avatarId=27150","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alien11689&avatarId=27150","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alien11689&avatarId=27150"},"displayName":"Dominik Przybysz","active":true,"timeZone":"Europe/Warsaw"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alien11689","name":"alien11689","key":"alien11689","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=alien11689&avatarId=27150","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=alien11689&avatarId=27150","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=alien11689&avatarId=27150","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=alien11689&avatarId=27150"},"displayName":"Dominik Przybysz","active":true,"timeZone":"Europe/Warsaw"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6627/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3cah3:"}}