{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483568","self":"https://issues.apache.org/jira/rest/api/2/issue/12483568","key":"AMQ-2683","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-07-14T01:29:30.489+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Dec 27 12:34:46 UTC 2010","customfield_12310420":"14785","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_23206339431_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-12-27T12:34:46.281+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2683/watchers","watchCount":4,"isWatching":false},"created":"2010-04-02T22:22:26.850+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315621","id":"12315621","description":"","name":"5.3.1","archived":false,"released":true,"releaseDate":"2010-03-23"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-12-27T12:34:46.264+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have multiple producers posting messages to queues and adding statistical information to a topic.  I have one consumer of that topic subscribing and taking those messages and monitors for problems.  The consumer is slower than publishing to the topic.  I have flow control enabled and I expected that once the memory limit of the Consumers dispatch queue was reached it would throttle the publishers to the topic, but instead it seems to lock everything up.\n\nThe message producers are putting messages to each queue and the topic on separate sessions.  The broker basically stops once it posts the message that it's going to throttle producers.  The topic messages are messages with text attributes, they are non persistent and posted non-transactional using the AUTO_ACKNOWLEDGE mode.\n\nAll the producers and consumers use the same Connection factory with with these attributes set.\n\nActiveMQConnectionFactory factory = new ActiveMQConnectionFactory(brokerURI);\nfactory.setProducerWindowSize(1024 * 1024);\nfactory.getPrefetchPolicy().setTopicPrefetch(10);\n\n\nMy activemq config is as follows:\n\n    <broker xmlns=\"http://activemq.apache.org/schema/core\" brokerName=\"localhost\" dataDirectory=\"${activemq.base}/data\" destroyApplicationContextOnStop=\"true\">\n \n        <!--\n\t\t\tFor better performances use VM cursor and small memory limit.\n\t\t\tFor more information, see:\n            \n            http://activemq.apache.org/message-cursors.html\n            \n            Also, if your producer is \"hanging\", it's probably due to producer flow control.\n            For more information, see:\n            http://activemq.apache.org/producer-flow-control.html\n        -->\n              \n        <destinationPolicy>\n            <policyMap>\n              <policyEntries>\n                <policyEntry topic=\">\" producerFlowControl=\"true\" memoryLimit=\"15mb\">\n                  <pendingSubscriberPolicy>\n                    <vmCursor />\n                  </pendingSubscriberPolicy>\n                </policyEntry>\n                <policyEntry queue=\">\" producerFlowControl=\"true\" memoryLimit=\"15mb\">\n                  <!-- Use VM cursor for better latency\n                       For more information, see:\n                       \n                       http://activemq.apache.org/message-cursors.html\n                       \n                  <pendingQueuePolicy>\n                    <vmQueueCursor/>\n                  </pendingQueuePolicy>\n                  -->\n                </policyEntry>\n              </policyEntries>\n            </policyMap>\n        </destinationPolicy> \n \n        \n        <!-- \n            The managementContext is used to configure how ActiveMQ is exposed in \n            JMX. By default, ActiveMQ uses the MBean server that is started by \n            the JVM. For more information, see: \n            \n            http://activemq.apache.org/jmx.html \n        -->\n        <managementContext>\n            <managementContext createConnector=\"false\"/>\n        </managementContext>\n\n        <!-- \n            Configure message persistence for the broker. The default persistence\n            mechanism is the KahaDB store (identified by the kahaDB tag). \n            For more information, see: \n            \n            http://activemq.apache.org/persistence.html \n        -->\n        <persistenceAdapter>\n            <kahaDB directory=\"${activemq.base}/data/kahadb\" journalMaxFileLength=\"5 mb\"/>\n        </persistenceAdapter>\n        \n        \n        <!--\n            The systemUsage controls the maximum amount of space the broker will \n            use before slowing down producers. For more information, see:\n            \n            http://activemq.apache.org/producer-flow-control.html\n        -->     \n        <systemUsage>\n            <systemUsage>\n                <memoryUsage>\n                    <memoryUsage limit=\"200 mb\"/>\n                </memoryUsage>\n                <storeUsage>\n                    <storeUsage limit=\"50 gb\"/>\n                </storeUsage>\n                <tempUsage>\n                    <tempUsage limit=\"100 mb\"/>\n                </tempUsage>\n            </systemUsage>\n        </systemUsage>\n\t\n\t\t  \n        <!-- \n            The transport connectors expose ActiveMQ over a given protocol to\n            clients and other brokers. For more information, see: \n            \n            http://activemq.apache.org/configuring-transports.html \n        -->\n        <transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://0.0.0.0:61616\"/>\n        </transportConnectors>\n\n    </broker>\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59591","customfield_12312823":null,"summary":"Producer Flow Control Does Not Seem to Work with Topics","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=odysseyfx","name":"odysseyfx","key":"odysseyfx","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brad Willard","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=odysseyfx","name":"odysseyfx","key":"odysseyfx","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brad Willard","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows 2008 Server, Sun Java 6. ","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483568/comment/12940889","id":"12940889","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srpietrowicz","name":"srpietrowicz","key":"srpietrowicz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Pietrowicz","active":true,"timeZone":"Etc/UTC"},"body":"I'm seeing this same issue, same results.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=srpietrowicz","name":"srpietrowicz","key":"srpietrowicz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Steve Pietrowicz","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-14T01:29:30.489+0000","updated":"2010-07-14T01:29:30.489+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483568/comment/12942456","id":"12942456","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"could you build a test case that can demonstrate, possibly a topic version of http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/ProducerFlowControlTest.java?view=markup","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-14T09:40:41.768+0000","updated":"2010-07-14T09:40:41.768+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483568/comment/12974642","id":"12974642","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdirkse","name":"mdirkse","key":"mdirkse","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maarten Dirkse","active":true,"timeZone":"Europe/Berlin"},"body":"Well, it's not a topic version of the PFC test in the AMQ source, but I'm pretty confident it does demonstrate that PFC doesn't work for topics.\nIf you run the code you'll see the producer halt when PFC kicks in, and never start up again, even when the consumer has consumed all outstanding messages. If you change the Destination from a topic to a queue, PFC does work as expected. \n\n{code}\nimport java.util.Arrays;\nimport java.util.concurrent.atomic.AtomicLong;\n\nimport javax.jms.Connection;\nimport javax.jms.Destination;\nimport javax.jms.Message;\nimport javax.jms.MessageListener;\nimport javax.jms.MessageProducer;\nimport javax.jms.Session;\n\nimport org.apache.activemq.ActiveMQConnectionFactory;\nimport org.apache.activemq.broker.BrokerService;\nimport org.apache.activemq.broker.region.policy.PolicyEntry;\nimport org.apache.activemq.broker.region.policy.PolicyMap;\nimport org.apache.activemq.command.ActiveMQTopic;\nimport org.apache.commons.logging.Log;\nimport org.apache.commons.logging.LogFactory;\n\npublic class BrokerTest implements MessageListener {\n  private static final Log log = LogFactory.getLog(BrokerTest.class);\n  private static final String brokerName = \"testBroker\";\n  private static final String brokerUrl = \"vm://\" + brokerName;\n  private static final int destinationMemLimit = 2097152; // 2MB\n  private static final AtomicLong produced = new AtomicLong();\n  private static final AtomicLong consumed = new AtomicLong();\n\n  public static void main(String[] args) throws Exception {\n    // Setup and start the broker\n    BrokerService broker = new BrokerService();\n    broker.setBrokerName(brokerName);\n    broker.setPersistent(false);\n    broker.setSchedulerSupport(false);\n    broker.setUseJmx(false);\n    broker.setUseShutdownHook(false);\n    broker.addConnector(brokerUrl);\n\n    // Setup the destination policy\n    PolicyMap pm = new PolicyMap();\n\n    // Setup the topic destination policy\n    PolicyEntry tpe = new PolicyEntry();\n    tpe.setTopic(\">\");\n    tpe.setMemoryLimit(destinationMemLimit);\n    tpe.setProducerFlowControl(true);\n\n    // Setup the topic destination policy\n    PolicyEntry qpe = new PolicyEntry();\n    qpe.setQueue(\">\");\n    qpe.setMemoryLimit(destinationMemLimit);\n    qpe.setProducerFlowControl(true);\n    qpe.setQueuePrefetch(1);\n\n    pm.setPolicyEntries(Arrays.asList(new PolicyEntry[] { tpe, qpe }));\n\n    broker.setDestinationPolicy(pm);\n\n    // Start the broker\n    broker.start();\n\n    Destination destination = new ActiveMQTopic(\"test\");\n    //Destination destination = new ActiveMQQueue(\"test\");\n\n    // Create the connection factory\n    ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(brokerUrl);\n    connectionFactory.setAlwaysSyncSend(true);\n    connectionFactory.setProducerWindowSize(1024);\n\n    // Start the test destination listener\n    Connection c = connectionFactory.createConnection();\n    c.start();\n    c.createSession(false, 1).createConsumer(destination).setMessageListener(new BrokerTest());\n\n    // Start producing the test messages\n    Session s = connectionFactory.createConnection().createSession(false, Session.AUTO_ACKNOWLEDGE);\n    MessageProducer p = s.createProducer(destination);\n\n    for (long i = 0; i < 2000000L; i++) {\n      p.send(s.createTextMessage(\"test\"));\n\n      long count = produced.incrementAndGet();\n      if (count % 1000 == 0) {\n        log.debug(\"Produced \" + count / 1000 + \"k messages\");\n      }\n    }\n  }\n\n  @Override\n  public void onMessage(Message arg0) {\n    try {\n      Thread.sleep(1);\n    } catch (InterruptedException e) {\n      e.printStackTrace();\n    }\n\n    long count = consumed.incrementAndGet();\n    if (count % 1000 == 0) {\n      log.debug(\"\\tConsumed \" + count / 1000 + \"k messages\");\n    }\n  }\n}\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdirkse","name":"mdirkse","key":"mdirkse","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maarten Dirkse","active":true,"timeZone":"Europe/Berlin"},"created":"2010-12-23T15:42:28.787+0000","updated":"2010-12-23T15:48:40.715+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483568/comment/12974660","id":"12974660","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdirkse","name":"mdirkse","key":"mdirkse","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maarten Dirkse","active":true,"timeZone":"Europe/Berlin"},"body":"The testcase does not work as expected (ie PFC doesn't work for topics) for both 5.4.2 and 5.5-snapshot.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdirkse","name":"mdirkse","key":"mdirkse","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Maarten Dirkse","active":true,"timeZone":"Europe/Berlin"},"created":"2010-12-23T16:39:52.879+0000","updated":"2010-12-23T16:39:52.879+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483568/comment/12975241","id":"12975241","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Fixed with svn revision 1053055. The test based on the one Maarten provided is included as well. Thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2010-12-27T12:34:46.177+0000","updated":"2010-12-27T12:34:46.177+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2683/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0akhb:"}}