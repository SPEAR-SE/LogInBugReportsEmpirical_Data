{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481228","self":"https://issues.apache.org/jira/rest/api/2/issue/12481228","key":"AMQ-129","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315594","id":"12315594","name":"1.2","archived":false,"released":true}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2004-11-09T19:17:44.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Nov 19 18:57:00 UTC 2004","customfield_12310420":"48866","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_917064000_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2004-11-19T18:57:00.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-129/watchers","watchCount":1,"isWatching":false},"created":"2004-11-09T04:12:36.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315594","id":"12315594","name":"1.2","archived":false,"released":true}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2004-11-19T18:57:00.000+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I'm working on integrating ActiveMQ with JBoss and I'm running into some problems with message delivery to an MDB.  I'm not sure if the bug is in JBoss or in the ActiveMQ connector but I'm hitting a wall so I'm hoping someone can help.  Here is the scenario:\n\n1.  ActiveMQ broker running on local machine but outside of JBoss. \n2.  Deploy ActiveMQ connector (activemq.rar) as standalone connector - successful\n3.  Deploy ejb-jar file containing an MDB and a jboss.xml file that hooks the MDB to an ActiveMQ queue - successful\n4.  Client places first message on queue and exits - successful \n5.  MDB receives first message - partially-successful (see below)\n6.  Client places second message on queue and exits - successful\n7.  MDB receives second message - failure - The following exception is thrown: javax.transaction.xa.XAException: Transaction '< a JBoss xid number>' has not been started.\n\nThe other interesting thing is that if I shutdown JBoss, then restart it, both messages reappear in the queue and delivery is attempted again, which is why I listed #5 above as only 'partially-successful'.  \n\nI'll add sample code with instructions on how to reproduce this shortly.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"160127","customfield_12312823":null,"summary":"JBoss Integration: XA transactions not working","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"JBoss 4.0.1 RC1","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481228/comment/12936818","id":"12936818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"body":"To reproduce this you'll need the following:\n\n1.  Latest ActiveMQ source code from cvs\n2.  JBoss 4.0.1RC1\n3.  Sample code in the attached zip file.\n\nSetup: \n1.  Build the ActiveMQ source code\n2.  Download and install JBoss 4.0.1RC1\n3.  Unzip the attached zip file and run 'maven default' on it.\n\nRunning the test (for windows):\n1.  Run <activemq_cvs_home>\\modules\\assembly\\target\\activemq-1.2-SNAPSHOT\\bin\\activemq.bat \n2.  Run <jboss-4.0.1RC1_home>\\bin\\run.bat\n3.  Copy <activemq_cvs_home>\\modules\\ra\\target\\activemq-ra-1.2-SNAPSHOT.rar to <jboss-4.0.1RC1_home>\\server\\default\\deploy\n4.  Wait a second or two for JBoss to complete the rar file deployment\n5.  Copy <mdb_test_home>\\target\\mdb-test-1.0.jar to <jboss-4.0.1RC1_home>\\server\\default\\deploy\n6.  Open a command window at <mdb_test_home>\n7.  Run 'maven send-message' \n8.  Run 'maven send-message' again\n\nI'll add a log file that traces many of the method calls from the above shortly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"created":"2004-11-09T04:16:13.000+0000","updated":"2004-11-09T04:16:13.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481228/comment/12937098","id":"12937098","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"body":"To help debug this, I created an aspectj module that logged every method call plus the parameters passed into the method and every method exit.  If you look in the attached file 'trace.log' you can see the calls being made in the connector.  I only logged method calls within classes in the following packages:\n  -org.codehaus.activemq.ra \n  -org.codehaus.activemq\n  -org.codehaus.activemq.broker \n  -org.codehaus.activemq.broker.impl \n  -org.codehaus.activemq.store.vm\n\nThe log file has five columns as follows:\nColumn 1: timestamp\nColumn 2: thread\nColumn 3: log4j NDC (set by JBoss)\nColumn 4: method entry/exit and call stack depth indicator\nColumn 5: class and method name with method parameters listed on method entry\n\nColumn 4 indicates method entry with an arrow like this: --> and method exit with an arrow like this <-- .  A dash is added or removed to indicate depth within the call stack.\n\nHere are a couple of key moments within the log file:\nLine 24 - the rar file finishes deployment\nLine 232 - the ejb jar file finishes deployment\nLine 428 - processing of message one finishes\nLine 723 - processing of message two finishes\nLine 1018 - processing of message three finishes\nLine 1105 - JBoss finishes shutdown (last entry)\n\nIf you look at the processing of the first message, it appears to me that JBoss is following the JCA inflow XA protocol for a one phase commit.  You can see the following calls in the log file: \n  -start (lines 346-357)\n  -message delivery (lines 358-367)\n  -end (lines 368-375)\n  -commit (lines 376-383)\n\nI also noticed that after the XA commit is called, the ActiveMQSession.messageDelivered gets called (lines 389-412) and within that call, a local transaction is started by the ActiveMQRASession.doStartTransaction method (lines 394-405) but it appears that it is never committed.  That seems odd to me.  Is that the correct behavior?  Does this have anything to do with the exception being thrown when delivery of the second message is attempted? \n\nAside from the local transaction question above, I still can't figure out why the XA transaction commit call does not result in the removal of the message from queue.  Is that the correct behavior?\n\nThis is all of the analysis I've been able to do up till now.  I'm finding it difficult to go much further because I don't yet understand how the broker works to support XA transactions.  Any help on this would be greatly appreciated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"created":"2004-11-09T04:18:56.000+0000","updated":"2004-11-09T04:18:56.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481228/comment/12936947","id":"12936947","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Just want to say great bug report!  I will they were all this detailed!    MDB have not been working in Geronimo either.  Starting to dig into this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2004-11-09T19:17:44.000+0000","updated":"2004-11-09T19:17:44.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481228/comment/12937035","id":"12937035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"body":"Thanks!  Please let me know if I can help.  I'm still learning my way around the code base, so any pointers on which direction to look would be great.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"created":"2004-11-09T19:33:56.000+0000","updated":"2004-11-09T19:33:56.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481228/comment/12936597","id":"12936597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"body":"I've been doing a ton of work on this issue for the last two days.  Lots of learning about the system and transactions (great stuff!).  Do you mind if I take over as the assignee?  I know you have lots on your plate and I would hate for us to be duplicating effort.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"created":"2004-11-11T18:40:55.000+0000","updated":"2004-11-11T18:40:55.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481228/comment/12936925","id":"12936925","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"Michael, if you wanna be able to assign stuff to yourself, mail me your email address you used to register with JIRA and I can grant you karma.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2004-11-12T10:34:14.000+0000","updated":"2004-11-12T10:34:14.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481228/comment/12936887","id":"12936887","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"body":"Hiram's changes of the ServerSessionImpl class to use the MessageEndpoint's beforeDelivery(..) and afterDelivery() methods resolved this issue.  Thanks Hiram!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgaffney","name":"mgaffney","key":"mgaffney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gaffney","active":true,"timeZone":"America/New_York"},"created":"2004-11-19T18:57:00.000+0000","updated":"2004-11-19T18:57:00.000+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-129/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rro7:"}}