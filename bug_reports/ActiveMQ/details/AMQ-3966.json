{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12602422","self":"https://issues.apache.org/jira/rest/api/2/issue/12602422","key":"AMQ-3966","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Aug 13 10:59:00 UTC 2012","customfield_12310420":"253876","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3966/watchers","watchCount":4,"isWatching":false},"created":"2012-08-09T08:37:20.287+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12318549","id":"12318549","name":"5.5.1","archived":false,"released":true,"releaseDate":"2011-10-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-08-13T10:59:00.201+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The broker is using the jdbc-persistence-adapter and persists to an oracle database. We have so far been unable to reproduce this issue reliably, but it appears both in our testing and production environments with some regularity. \n\nThe issue we are having is superficially very similar to [this description|http://activemq.2283324.n4.nabble.com/Messages-stuck-in-queue-td3244342.html]. Retrieving the queue message count with jmx or inspecting the activemq database with a {code}SELECT COUNT(*) FROM ACTIVEMQ_MSGS WHERE CONTAINER LIKE '%DeadLetterQueue%'{code} results in a number that is larger than the amount of messages which can actually be retrieved using a QueueBrowser or a QueueViewMBean. This difference grows over time, as no messages that are sent to the queue after this problem occurs are retrievable. We have also observed this problem happening on queues with normal JMS consumers, where the queue will grow without the consumer receiving any messages.\n\nA broker restart can sometimes resolve this issue. Our current workaround is to use a program that fetches the rows for the queue from the database, unmarshals them and sends them to a temporary queue. The queue with the stuck messages does not work (does not deliver any messages to consumers or browsers) until after it has been purged. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12540005","id":"12540005","filename":"brokerlog.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"created":"2012-08-09T10:52:03.153+0000","size":131090,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12540005/brokerlog.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"81410","customfield_12312823":null,"summary":"Messages get stuck in queue","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"java version \"1.6.0_32\"\nJava(TM) SE Runtime Environment (build 1.6.0_32-b05)\nJava HotSpot(TM) 64-Bit Server VM (build 20.7-b02, mixed mode)\n\nLinux ****** 2.6.18-308.4.1.el5 #1 SMP Tue Apr 17 17:08:00 EDT 2012 x86_64 x86_64 x86_64 GNU/Linux\n\nCentOS release 5.8 (Final)\nKernel \\r on an \\m\n","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12602422/comment/13431732","id":"13431732","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"body":"This is the brokers log with level=\"DEBUG\" for 10:57 to 11:13 today. We managed to reproduce the bug in error.queue at approximately 11:12 when we moved 29 messages from the queue foo.bar to error.queue. At the time, error.queue had 2 messages. These are still reachable. The other 29 are in the database, but not reachable. Neither foo.bar or error.queue has consumers, both are viewed only through the use of QueueViewMBeans.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"created":"2012-08-09T10:52:03.361+0000","updated":"2012-08-09T10:52:03.361+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12602422/comment/13431743","id":"13431743","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"body":"Moving the retrievable messages to a different queue seemed to resolve the problem in this case - once the retrievable messages were moved, the missing messages became visible on the queue. Could this be related to caching in some way? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"created":"2012-08-09T11:23:51.106+0000","updated":"2012-08-09T11:50:26.029+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12602422/comment/13433059","id":"13433059","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"body":"This seems to be manifesting in two different ways. I was able to create a situtation in which a queue reported to having -219 messages. I did this by starting 3 jobs simultaneously that tried to move the same 400 messages from one queue to another by calling QueueViewMBean.moveMessageTo. All 400 messages were moved, but afterwards the queue had very different enqueuecount and dequeuecount. Neither queue had consumers aside from these jobs. Sending messages to the broken queue resulted in the amount of messages in the queue increasing, but they were not visible through the use of QueueViewMBean.browse. Using QueueViewMBean.getMessage, I was able to obtain the messages by JMSMessageID. After sending 13 messages to the queue, I found a log entry saying toPageIn=13 for this queue.\n\nThinking I had a workaround for the issue by fetching the message ids from the broker database, I did a quick experiment with another broken queue. I was not able to extract messages from this one, using the same method. In this case, both dequeuecount and enqueuecount were 0. toPageIn=200 for this queue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kaaveland","name":"kaaveland","key":"kaaveland","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robin Kåveland Hansen","active":true,"timeZone":"Europe/Oslo"},"created":"2012-08-13T10:59:00.199+0000","updated":"2012-08-13T10:59:00.199+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3966/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ea67:"}}