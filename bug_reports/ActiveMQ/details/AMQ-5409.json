{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12750323","self":"https://issues.apache.org/jira/rest/api/2/issue/12750323","key":"AMQ-5409","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-08-18T13:49:54.065+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Aug 26 10:07:41 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_26439848589_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-08-26T10:08:46.754+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5409/watchers","watchCount":4,"isWatching":false},"created":"2014-10-24T09:44:38.359+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-08-26T10:08:46.939+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When prefetch is set to 0, the shutdown of a Spring Default Message Listener never ends. We think there is a deadlock.\n\nThis does not occur when prefetch is 1 or when we set a TransactionManager in the Spring Default Message Listener.\n\nDeadLock :\n\n\"jmsContainer-4@2020\" prio=5 tid=0x14 nid=NA waiting\n  java.lang.Thread.State: WAITING\n\t  at java.lang.Object.wait(Object.java:-1)\n\t  at java.lang.Object.wait(Object.java:485)\n\t  at org.apache.activemq.SimplePriorityMessageDispatchChannel.dequeue(SimplePriorityMessageDispatchChannel.java:90)\n\t  at org.apache.activemq.ActiveMQMessageConsumer.dequeue(ActiveMQMessageConsumer.java:478)\n\t  at org.apache.activemq.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:629)\n\t  at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.receiveMessage(AbstractPollingMessageListenerContainer.java:430)\n\t  at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.doReceiveAndExecute(AbstractPollingMessageListenerContainer.java:310)\n\t  at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.receiveAndExecute(AbstractPollingMessageListenerContainer.java:263)\n\t  at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.invokeListener(DefaultMessageListenerContainer.java:1102)\n\t  at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:996)\n\t  at java.lang.Thread.run(Thread.java:662)\n\n\n\"Thread-0@594\" prio=5 tid=0xb nid=NA waiting\n  java.lang.Thread.State: WAITING\n\t  at java.lang.Object.wait(Object.java:-1)\n\t  at java.lang.Object.wait(Object.java:485)\n\t  at org.springframework.jms.listener.DefaultMessageListenerContainer.doShutdown(DefaultMessageListenerContainer.java:543)\n\t  at org.springframework.jms.listener.AbstractJmsListeningContainer.shutdown(AbstractJmsListeningContainer.java:237)\n\t  at com.testprefetch.PrefetchTest.startAndStopContainer(PrefetchTest.java:43)\n\t  at com.testprefetch.PrefetchTest.testStopDMLCPrefetch0(PrefetchTest.java:15)\n\t  at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-1)\n\t  at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\t  at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\t  at java.lang.reflect.Method.invoke(Method.java:597)\n\t  at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:47)\n\t  at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n\t  at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:44)\n\t  at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n\t  at org.junit.internal.runners.statements.FailOnTimeout$StatementThread.run(FailOnTimeout.java:74)\n\nThis could be related with method org.apache.activemq.ActiveMQMessageConsumer#receive(long) :\n\n            if (info.getPrefetchSize() == 0) {\n                md = dequeue(-1); // We let the broker let us know when we timeout.\n            } else {\n                md = dequeue(timeout);\n            }\n\n\nIssue present in versions : \n\tActiveMQ 5.9.1, 5.10.0\n\tSpringframework 3.2.8.RELEASE, 4.0.5.RELEASE\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12676893","id":"12676893","filename":"PrefetchTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-24T12:17:48.148+0000","size":2048,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12676893/PrefetchTest.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12676894","id":"12676894","filename":"SimpleMessageListener.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-24T12:17:48.152+0000","size":256,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12676894/SimpleMessageListener.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12676895","id":"12676895","filename":"testPrefetch_0_Deadlock.appctx.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-24T12:17:48.156+0000","size":1672,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12676895/testPrefetch_0_Deadlock.appctx.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12676896","id":"12676896","filename":"testPrefetch_0_WithTransactionManager.appctx.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-24T12:17:48.160+0000","size":1935,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12676896/testPrefetch_0_WithTransactionManager.appctx.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12676892","id":"12676892","filename":"testPrefetch_1.appctx.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-24T12:17:48.143+0000","size":1672,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12676892/testPrefetch_1.appctx.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12751037","id":"12751037","filename":"testprefetch.tgz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shpelda2","name":"shpelda2","key":"shpelda2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"shpelda2","active":true,"timeZone":"Etc/UTC"},"created":"2015-08-18T13:49:54.061+0000","size":2926,"mimeType":"application/x-compressed-tar","content":"https://issues.apache.org/jira/secure/attachment/12751037/testprefetch.tgz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"With prefetch 0, Spring Default Message Listener Shutdown never ends","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Ubuntu 13.10 64Bits","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750323/comment/14701272","id":"14701272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shpelda2","name":"shpelda2","key":"shpelda2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"shpelda2","active":true,"timeZone":"Etc/UTC"},"body":"Struggling with problem with same symptoms, successfuly reproduced the problem with the testcase. \nRe-attaching testcase packed nicely into maven project, with enabled logging to just unpack and execute.\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shpelda2","name":"shpelda2","key":"shpelda2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"shpelda2","active":true,"timeZone":"Etc/UTC"},"created":"2015-08-18T13:49:54.065+0000","updated":"2015-08-18T13:49:54.065+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750323/comment/14702733","id":"14702733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"this is by design. onMessage and prefetch=0 are not friends. why do you need prefetch 0 and not 1?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-08-19T09:04:15.219+0000","updated":"2015-08-19T09:04:15.219+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750323/comment/14708989","id":"14708989","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shpelda2","name":"shpelda2","key":"shpelda2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"shpelda2","active":true,"timeZone":"Etc/UTC"},"body":"In my usecase i do use the queue to distribute the work across the cluster. There is low amount of messages that take long time to process. So i want them to be processed in maximum paraleism. So i do not want individual consumers to cache message while processing other one (prefetch=1) from queue as this causes other threads to lack for work.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=shpelda2","name":"shpelda2","key":"shpelda2","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"shpelda2","active":true,"timeZone":"Etc/UTC"},"created":"2015-08-24T09:03:48.112+0000","updated":"2015-08-24T09:03:48.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750323/comment/14709069","id":"14709069","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I think you have another option, use a client transaction (so  a transacted session) and use destination policy entry usePrefetchExtension=false on the broker for the destination in question. In this way you can have a prefetch of 1, and only one message will get dispatched till the consuming transaction commits.\nWith the default usePrefetchExtension=true, when the first message is delivered to the consumer another gets queued up.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-08-24T10:19:39.595+0000","updated":"2015-08-24T10:19:39.595+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750323/comment/14712875","id":"14712875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"body":"This option suits our needs, I close the JIRA","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Wawan","name":"Wawan","key":"wawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wawan","active":true,"timeZone":"Etc/UTC"},"created":"2015-08-26T10:07:41.801+0000","updated":"2015-08-26T10:07:41.801+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5409/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i21jfz:"}}