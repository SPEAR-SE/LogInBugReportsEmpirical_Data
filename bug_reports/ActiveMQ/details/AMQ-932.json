{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481823","self":"https://issues.apache.org/jira/rest/api/2/issue/12481823","key":"AMQ-932","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315613","id":"12315613","description":"","name":"4.1.0","archived":false,"released":true,"releaseDate":"2006-11-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2006-09-23T17:52:00.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 25 11:23:13 UTC 2006","customfield_12310420":"84442","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_360214000_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2006-09-25T11:23:13.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-932/watchers","watchCount":0,"isWatching":false},"created":"2006-09-21T07:19:39.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315612","id":"12315612","description":"","name":"4.0.2","archived":false,"released":true,"releaseDate":"2006-07-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-09-25T11:23:13.000+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Connections to the openwire port that are pathologically broken (for example any http request) or that die in some other way extremely quickly will lead to memory losses of aout 64Kb each time. This happens because many services are stop()ed directly in the middle of start(), and then never stopped for real, or stopped again but on an object tree with an inconsistent state. This is usually also accompanied by the JMX message:\n\nWARN  ManagedTransportConnection     - Failed to unregister mbean: org.apache.activemq:BrokerName=localhost,Type=Connection,ConnectorName=default,Connection=25\n\nBut that is a cosmetic symptom and not critical (and this has otherwise nothing to do with JMX).\n\nMy patch is a band-aid that is functional but I'm not very happy with it. The patch changes some service logic so that if stop is called in the middle of start, the stop is instead queued and called at the end of start. There will still be multiple stops, and you'll still see the cosmetic JMX error from the second ineffectual stop, but the first stop cleans up correctly so there are no leaks.\n\nI think there's probably a better solution, but it was tough to see what. I'd appreciate better ideas. Possibly something involving moving the dangerous operations (wire format negotiation etc) out of start?\n\nI am working on a unit test, but I can't promise I will have something to submit. I'm having to play JVM games to detect the problem in a unit test and that might not fly for general purpose use.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460554","id":"12460554","filename":"ASF.LICENSE.NOT.GRANTED--73.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jheitmann","name":"jheitmann","key":"jheitmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Heitmann","active":true,"timeZone":"Etc/UTC"},"created":"2006-09-21T07:19:39.000+0000","size":3419,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12460554/ASF.LICENSE.NOT.GRANTED--73.diff"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"235745","customfield_12312823":null,"summary":"Quickly broken client connections lead to memory leaks","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jheitmann","name":"jheitmann","key":"jheitmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Heitmann","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jheitmann","name":"jheitmann","key":"jheitmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Heitmann","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481823/comment/12938381","id":"12938381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyc","name":"kellyc","key":"kellyc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kelly Campbell","active":true,"timeZone":"Etc/UTC"},"body":"I ran into a similar issue but I don't think it was due to broken connections. I've got a heap dump from the broker (jdk1.6), and it looks like the OpenWireFormat marshalCache is the root cause of the one I'm working on. Each DataStructure[] marshalCache is roughly 64K because of the MARSHAL_CACHE_SIZE. There's 738 DataStructure[] arrays in my heap, taking up 48 Mbytes. Most of these only have one element used. \n\nI think issues 914 and 937 might be related or the same. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=kellyc","name":"kellyc","key":"kellyc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kelly Campbell","active":true,"timeZone":"Etc/UTC"},"created":"2006-09-23T17:52:00.000+0000","updated":"2006-09-23T17:52:00.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481823/comment/12938244","id":"12938244","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jheitmann","name":"jheitmann","key":"jheitmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Heitmann","active":true,"timeZone":"Etc/UTC"},"body":"Those are the exact symptoms that occur as a result of the problem I saw. For every bad connection there was a bunch of individual object leakage (one each of the major transport filters, a couple different mbeans, a connection object etc), but by far the most serious leakage were the empty pre-allocated marshaler cache arrays. This looks like a common symptom of anything that would leak transports/connections, so it might not be the same root cause.\n\nIf you can reproduce it and want help I'd be happy to take a look.\n\nIf you can't find the problem one thing that could really help mitigate the severity of these kinds of leaks is to make the initialization of the marshaling caches conditional on the wireFormat.cacheEnabled flag. This would give a lot more leak headroom.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jheitmann","name":"jheitmann","key":"jheitmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Heitmann","active":true,"timeZone":"Etc/UTC"},"created":"2006-09-24T07:50:18.000+0000","updated":"2006-09-24T07:50:18.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481823/comment/12938398","id":"12938398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"Patch applied John with thanks - could you double check I've applied it correctly please?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2006-09-25T11:23:13.000+0000","updated":"2006-09-25T11:23:13.000+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-932/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14qf3:"}}