{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13003041","self":"https://issues.apache.org/jira/rest/api/2/issue/13003041","key":"AMQ-6419","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Sep 06 20:31:02 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6419/watchers","watchCount":2,"isWatching":false},"created":"2016-09-06T20:29:34.025+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-09-06T20:31:02.400+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We are using ActiveMQ, using Network of Brokers in Hub-Spoke topology.\nActive MQ is deployed in Karaf Container\n\nSoftware Stack Used\nActive MQ Version 5.10.0\nContainer - Karaf 3.0.3\nCamel 2.14.1\n\nHub is having 2 brokers- Master Active MQ and Slave Active MQ, configured using shared file system (GFS) and Kaha DB Data Store. Operate as failover. Spokes or Site connect to Hub using network connectors configuration below-\n\n<networkConnectors>\n<networkConnector\n  name=\"T:broker1->broker2\"\n  uri=\"masterslave:(tcp://masterbroker.com:61616,tcp://slavebroker.com:61616)\n  duplex=\"true\"\n  decreaseNetworkConsumerPriority=\"true\"\n  networkTTL=\"2\"\n  dynamicOnly=\"true\">\n</networkConnector>\n\n<networkConnector\n  name=\"Q:broker1->broker2\"\n  uri=\"masterslave:(tcp://masterbroker.com:61616,tcp://slavebroker.com:61616)\n  duplex=\"true\"\n  decreaseNetworkConsumerPriority=\"true\"\n  networkTTL=\"2\"\n  dynamicOnly=\"true\">\n</networkConnector>\n</networkConnectors>\n\nIssue\n\n\nWe have topic on HUB AMQ broker called Shop.Canonical.WorkOrder.Notify, and the producers are at the spoke level. The producers write to the local topic Shop.Canonical.WorkOrder.Notify (This is the same topic AMQ creates when using network of brokers).\n\nWe have Durable Topic Subscribers on Central (HUB ) broker, camel client routes subscribed to this topic.\nApparently due to network connections lost or force shutdowns of servers hosting these karaf containers at spoke level, we are ending up having offline durable subscribers.\n\nIt looks like we had network outage and network failover tried to stop the network bridge and at the same time active mq tried to start another connection causing deadlock. I see the following exception from log file. Also the details of the threads causing deadlock towards the end of this message.\n\n\n\njavax.jms.InvalidClientIDException: Broker: taxxx-amq-broker - Client: T:broker1->broker2_central-amq-broker_inbound_taxxx-amq-broker already connected from vm://taxxx-amq-broker#4548\n        at org.apache.activemq.broker.region.RegionBroker.addConnection(RegionBroker.java:246)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.jmx.ManagedRegionBroker.addConnection(ManagedRegionBroker.java:231)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:92)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.advisory.AdvisoryBroker.addConnection(AdvisoryBroker.java:89)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:92)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:92)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:92)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.security.JaasAuthenticationBroker.addConnection(JaasAuthenticationBroker.java:87)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.MutableBrokerFilter.addConnection(MutableBrokerFilter.java:97)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.TransportConnection.processAddConnection(TransportConnection.java:764)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.command.ConnectionInfo.visit(ConnectionInfo.java:139)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:294)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:148)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.transport.vm.VMTransport.doDispatch(VMTransport.java:138)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.transport.vm.VMTransport.dispatch(VMTransport.java:130)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:107)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.transport.ResponseCorrelator.asyncRequest(ResponseCorrelator.java:81)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.transport.ResponseCorrelator.request(ResponseCorrelator.java:86)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.network.DemandForwardingBridgeSupport.startLocalBridge(DemandForwardingBridgeSupport.java:453)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.network.DemandForwardingBridgeSupport.doStartLocalAndRemoteBridges(DemandForwardingBridgeSupport.java:420)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.network.DemandForwardingBridgeSupport.access$500(DemandForwardingBridgeSupport.java:105)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at org.apache.activemq.network.DemandForwardingBridgeSupport$5.run(DemandForwardingBridgeSupport.java:335)[83:org.apache.activemq.activemq-osgi:5.10.0]\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)[:1.7.0_75]\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)[:1.7.0_75]\n        at java.lang.Thread.run(Thread.java:745)[:1.7.0_75]\n\n\n\n\nAbove scenario also creates a dead lock condition - 3 threads\n\nThread 1 - Name: ActiveMQ BrokerService[taxxx-amq-broker] Task-17676\nState: WAITING on java.util.concurrent.locks.ReentrantLock$NonfairSync@138f39e owned by: ActiveMQ Transport: tcp://shopesb1-prd-sl/10.98.1.92:61616@54480\nTotal blocked: 5  Total waited: 10\n\nStack trace:\nsun.misc.Unsafe.park(Native Method)\njava.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:867)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1197)\njava.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:214)\njava.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:290)\norg.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:66)\norg.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)\norg.apache.activemq.network.DemandForwardingBridgeSupport.serviceLocalCommand(DemandForwardingBridgeSupport.java:970)\norg.apache.activemq.network.DemandForwardingBridgeSupport$2.onCommand(DemandForwardingBridgeSupport.java:206)\norg.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)\norg.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\norg.apache.activemq.transport.vm.VMTransport.doDispatch(VMTransport.java:138)\norg.apache.activemq.transport.vm.VMTransport.dispatch(VMTransport.java:130)\n   - locked java.util.concurrent.atomic.AtomicBoolean@1e5f8fb\norg.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:107)\norg.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)\norg.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)\norg.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1370)\norg.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:889)\norg.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:935)\norg.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)\norg.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\njava.lang.Thread.run(Thread.java:745)\n\n Thread 2 -\nName: ActiveMQ Transport: tcp://shopesb1-prd-sl/10.98.1.92:61616@54480\nState: WAITING on java.util.concurrent.locks.ReentrantLock$NonfairSync@1c83e84 owned by: ActiveMQ BrokerService[taxxx-amq-broker] Task-17676\nTotal blocked: 0  Total waited: 2\n\nStack trace:\nsun.misc.Unsafe.park(Native Method)\njava.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:867)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1197)\njava.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:214)\njava.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:290)\norg.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:66)\norg.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)\norg.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1370)\norg.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:889)\norg.apache.activemq.broker.TransportConnection.dispatchSync(TransportConnection.java:849)\norg.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:150)\norg.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)\norg.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\norg.apache.activemq.transport.vm.VMTransport.doDispatch(VMTransport.java:138)\norg.apache.activemq.transport.vm.VMTransport.dispatch(VMTransport.java:130)\n   - locked java.util.concurrent.atomic.AtomicBoolean@12796af\norg.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:107)\norg.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68)\norg.apache.activemq.transport.ResponseCorrelator.asyncRequest(ResponseCorrelator.java:81)\norg.apache.activemq.transport.ResponseCorrelator.request(ResponseCorrelator.java:86)\norg.apache.activemq.network.DemandForwardingBridgeSupport.addSubscription(DemandForwardingBridgeSupport.java:905)\norg.apache.activemq.network.DemandForwardingBridgeSupport.addConsumerInfo(DemandForwardingBridgeSupport.java:1178)\norg.apache.activemq.network.DemandForwardingBridgeSupport.serviceRemoteConsumerAdvisory(DemandForwardingBridgeSupport.java:763)\n   - locked java.net.URI@15e6d6\norg.apache.activemq.network.DemandForwardingBridgeSupport.serviceRemoteCommand(DemandForwardingBridgeSupport.java:614)\norg.apache.activemq.network.DemandForwardingBridgeSupport$3.onCommand(DemandForwardingBridgeSupport.java:224)\norg.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)\norg.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\norg.apache.activemq.transport.failover.FailoverTransport$3.onCommand(FailoverTransport.java:208)\norg.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\norg.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)\norg.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\norg.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)\norg.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)\njava.lang.Thread.run(Thread.java:745)\n\n\n\nThread 3 - Name: ActiveMQ BrokerService[taxxx-amq-broker] Task-18436\nState: WAITING on java.util.concurrent.locks.ReentrantLock$NonfairSync@138f39e owned by: ActiveMQ Transport: tcp://shopesb1-prd-sl/10.98.1.92:61616@54480\nTotal blocked: 0  Total waited: 44\n\nStack trace:\nsun.misc.Unsafe.park(Native Method)\njava.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:867)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1197)\njava.util.concurrent.locks.ReentrantLock$NonfairSync.lock(ReentrantLock.java:214)\njava.util.concurrent.locks.ReentrantLock.lock(ReentrantLock.java:290)\norg.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:66)\norg.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)\norg.apache.activemq.network.DemandForwardingBridgeSupport$4.run(DemandForwardingBridgeSupport.java:288)\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\njava.lang.Thread.run(Thread.java:745) ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Durable Subscribers going offline - Deadlock - Network Of Brokers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranjit.nethi%40gmail.com","name":"ranjit.nethi@gmail.com","key":"ranjit.nethi@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranjit Nethi","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranjit.nethi%40gmail.com","name":"ranjit.nethi@gmail.com","key":"ranjit.nethi@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranjit Nethi","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux - Centos 5.8\nActive MQ Version 5.10.0\nContainer - Karaf 3.0.3\nCamel 2.14.1","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13003041/comment/15468458","id":"15468458","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranjit.nethi%40gmail.com","name":"ranjit.nethi@gmail.com","key":"ranjit.nethi@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranjit Nethi","active":true,"timeZone":"Etc/UTC"},"body":"Saw a similar JIRA AMQ 4328, please advise.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ranjit.nethi%40gmail.com","name":"ranjit.nethi@gmail.com","key":"ranjit.nethi@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ranjit Nethi","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-06T20:31:02.034+0000","updated":"2016-09-06T20:31:02.034+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6419/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i33axj:"}}