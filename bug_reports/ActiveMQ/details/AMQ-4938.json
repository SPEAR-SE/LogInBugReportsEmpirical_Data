{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12684816","self":"https://issues.apache.org/jira/rest/api/2/issue/12684816","key":"AMQ-4938","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-01-11T05:59:15.536+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jan 17 03:51:17 UTC 2014","customfield_12310420":"363888","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2762409782_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-01-16T15:20:45.449+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4938/watchers","watchCount":3,"isWatching":false},"created":"2013-12-15T16:00:35.699+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-04-02T22:06:53.147+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have been trying to send/receive messages via a Queue using the [REST API|http://activemq.apache.org/rest.html]. While testing I found that some messages got lost after a consuming request times out when no message is available.\n\nHere is a transcript of the test case I used:\n\n{code}\n#\n# OK: send first, consume later\n#\n$ curl -d \"body=message\" \"http://localhost:8161/api/message/TEST?type=queue\"\nMessage sent\n\n$ wget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID&readTimeout=1000\"\nmessage\n\n#\n# OK: start consuming, then send (within timeout)\n#\n$ wget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID&readTimeout=5000\"&\n[1] 5172\n\n$ curl -d \"body=message\" \"http://localhost:8161/api/message/TEST?type=queue\"\nmessageMessage sent[1]+  Fertig                  wget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID&readTimeout=5000\"\n\n#\n# NOK: start consuming, wait for timeout, then send and consume again\n#\n$ wget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID&readTimeout=5000\"\n\n$ curl -d \"body=message\" \"http://localhost:8161/api/message/TEST?type=queue\"\nMessage sent\n\n$ wget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID&readTimeout=5000\"\n{code}\n\nThe last *wget* returns after the given read timeout without any message. When looking at the managament console, the message has been consumed.\n\nI tested this with 5.8.0 on linux as well as with 5.8.0, 5.9.0 and a freshly built 5.10.0 on windows.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12622526","id":"12622526","filename":"AMQ-4938.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-12T03:33:59.136+0000","size":2343,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12622526/AMQ-4938.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12622894","id":"12622894","filename":"AMQ-4938B.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-14T17:33:59.215+0000","size":10916,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12622894/AMQ-4938B.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"364194","customfield_12312823":null,"summary":"Queue Messages lost after read timeout on REST API.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Win32, Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13851021","id":"13851021","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"body":"After enabling DEBUG logging, I found the following output after \n* starting the server clean\n* wget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID&readTimeout=1000\"\n* curl -d \"body=message\" \"http://localhost:8161/api/message/TEST?type=queue\"\n\n{code}\n2013-12-17 23:28:52,121 | DEBUG | Async client internal exception occurred with no exception listener registered: java.lang.IllegalStateException: IDLE,initial | org.apache.activemq.ActiveMQConnection | ActiveMQ Session Task-1\njava.lang.IllegalStateException: IDLE,initial\n        at org.eclipse.jetty.server.AsyncContinuation.dispatch(AsyncContinuation.java:408)\n        at org.eclipse.jetty.server.AsyncContinuation.resume(AsyncContinuation.java:815)\n        at org.apache.activemq.web.MessageServlet$Listener.onMessageAvailable(MessageServlet.java:395)\n        at org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1383)\n        at org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)\n        at org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:202)\n        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)\n        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:724)\n2013-12-17 23:28:52,121 | DEBUG | Sent! to destination: queue://TEST message: ActiveMQTextMessage {commandId = 0, responseRequired = false, messageId = ID:turtle-52404-1387319318754-3:2:1:1:1, originalDestination = null, originalTransactionId = null, producerId = null, destination = queue://TEST, transactionId = null, expiration = 0, timestamp = 1387319332114, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 5, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = f\n{code}\n\nLooks to me that the consuming session from the first wget is still there, in IDLE state -- but still is able to consume the message. Hope this helps -- I can't do any further testing or even debugging without a deeper understanding of ActiveMQ's internal workings.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-17T22:38:51.039+0000","updated":"2013-12-17T22:38:51.039+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13851033","id":"13851033","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"body":"Another thing: Setting the prefetch size to 1 as suggested in [Apache ActiveMQ â„¢ -- REST|http://activemq.apache.org/rest.html] didn't help. There's just one consumer here anyway, I guess.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-17T22:46:20.866+0000","updated":"2013-12-17T22:46:20.866+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13868673","id":"13868673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"It also seems that sending multiple messages after the timed-out consumption, only the first of those messages is lost.\n\nHere's debug output from the rest servlet (org.apache.activemq.web.MessageServlet).\n\n*get with no messages on queue*\n{noformat}\nDEBUG | Getting local client [GETID]\nDEBUG | Receiving message(s) from: queue://TEST with timeout: 1000\nDEBUG | Received 0 message(s)\nDEBUG | Getting local client [GETID]\nDEBUG | Receiving message(s) from: queue://TEST with timeout: 1000\n{noformat}\n\n*send 3 messages, get 3 times*\n{noformat}\nDEBUG | Sending message to: queue://TEST with text: message\nDEBUG | Sending message to: queue://TEST with text: message\nDEBUG | Sending message to: queue://TEST with text: message\nDEBUG | Getting local client [GETID]\nDEBUG | Receiving message(s) from: queue://TEST with timeout: 1000\nDEBUG | Received 1 message(s)\nDEBUG | Getting local client [GETID]\nDEBUG | Receiving message(s) from: queue://TEST with timeout: 1000\nDEBUG | Received 1 message(s)\nDEBUG | Getting local client [GETID]\nDEBUG | Receiving message(s) from: queue://TEST with timeout: 1000\nDEBUG | Received 0 message(s)\nDEBUG | Getting local client [GETID]\nDEBUG | Receiving message(s) from: queue://TEST with timeout: 1000\n{noformat}\n\nNote only 2 messages were received.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-11T05:59:15.536+0000","updated":"2014-01-11T05:59:15.536+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13868674","id":"13868674","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Watching the stats using the web console, the stats update as follows:\n\n|| stat || on normal send || on send after get timed out ||\n| Dequeue Counter | no change | +1 |\n| Message count waiting acknowledge | +1 | no change |\n| Dispatched Counter | +1 | +1 |\n| Enqueue Counter | +1 | +1 |\n\nSo, it appears the consumer is acknowledging the message immediately.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-11T06:08:40.596+0000","updated":"2014-01-11T06:08:40.596+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13868939","id":"13868939","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Attached is a patch that eliminates the erroneous consumption; the problem is that the continuation defined for the web request times out, but the availableMessageListener for the consumer is never updated with that fact.  So, when the next message comes in, the listener consumes it with the intent that the continuation of the web request will receive it.\n\nI'm going to review this code more carefully for race conditions.  I'm convinced there are races on the use of MessageConsumer's if more than one web request comes in for the same consumer (e.g. using the same clientId).  There may be more, including in this patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-12T03:33:59.142+0000","updated":"2014-01-12T03:33:59.142+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13869116","id":"13869116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"body":"Thank you very much for the fix, I can confirm it works with the above test case. With just one client, no messages are lost.\n\nHere's another test case involving two distinct client IDs, but no actual race:\n{code}\n#\n# Two clients with IDs \"GETID-1\" and \"GETID-2\"... both timeout since there are no messages yet\n#\nwget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID-1&readTimeout=1000\"\nwget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID-2&readTimeout=1000\"\n\n# Send a message:\ncurl -d \"body=$((++i))\" http://localhost:8161/api/message/TEST?type=queue; echo \": $i\"\nMessage sent\n\n#\n# Receive using first client ID, OK\n#\nwget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID-1&readTimeout=1000\"\n1\n\n#\n# Send a message again:\n#\ncurl -d \"body=$((++i))\" http://localhost:8161/api/message/TEST?type=queue; echo \": $i\"\nMessage sent\n\n#\n# Receive using first client ID, no response, not OK\n#\nwget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID-1&readTimeout=1000\"\n\n# ... but with client ID 2:\nwget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID-2&readTimeout=1000\"\n2\n{code}\n\nSeems like round-robin still happens even after a client disconnected because of the read timeout. Hope this helps.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"created":"2014-01-12T19:03:18.661+0000","updated":"2014-01-12T19:03:18.661+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13869180","id":"13869180","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"That's what I would expect with a prefecth > 0 because even prefetch = 1 means a single message will be dispatched, or pushed, to the client \"proactively\" - i.e. without any call to the receive method.\n\nLet me look at how prefetch works in the REST client.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-12T23:10:01.648+0000","updated":"2014-01-12T23:10:01.648+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13869194","id":"13869194","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"OK, so bad news - prefetch = 0 leads to web requests that don't appear to timeout.\n\nPrefetch = 1 works as I expected - one of the two clients gets a single message preloaded.  Also tested with prefeth = 2 and it works as expected.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-12T23:34:53.933+0000","updated":"2014-01-12T23:34:53.933+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13869912","id":"13869912","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"body":"So each new client ID creates a new subscription, which remains even after the client disconnects or timeouts and will be dispatched messages if prefetch > 0. Tested this with 3 clients (and without readTimeout), and all messages were distributed equally. Nice.\n\nUnfortunatelly, it's still pretty easy to provoke message loss when using an (admitedly unreasonable) low read Timeout. But what may happen, timing-wise, in an artifical test scenario may eventually happen in production even with natural timeouts. And avoiding message loss is paramount, IMHO.\n\nSo here's another one:\n{code}\n#\n# start receiving messages in background with readTimeout=1, clientId \"GETID-1\"\n#\nwhile true; do wget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID-1&readTimeout=1\"; done&\n[1] 6040\n\n#\n# send some messages -- output is done by background receiver -- no message loss\n#\nfor ((i=1; i<100; i++)); do curl -d \"body=$i.\" http://localhost:8161/api/message/TEST?type=queue; done\n1.2.3.4.5.6.7.8.9.10.11.12.13.14.15.16.17.18.19.20.21.22.23.24.25.26.27.28.29.30.31.32.33.34.35.36.37.38.39.40.41.42.43.44.45.46.47.48.49.50.51.52.53.54.55.56.57.58.59.60.61.62.63.64.65.66.67.68.69.70.71.72.73.74.75.76.77.78.79.80.81.82.83.84.85.86.87.88.89.90.91.92.93.94.95.96.97.98.99.\n\n#\n# create another subscription with clientId \"GETID-2\" (no messages read)\n#\nwget --no-http-keep-alive -q -O - \"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID-2&readTimeout=1\"\n\n#\n# try sending messages again -- expect to see every other message, but lots of message loss\n#\nfor ((i=1; i<100; i++)); do curl -d \"body=$i.\" http://localhost:8161/api/message/TEST?type=queue -so /dev/null; done\n1.3.7.11.15.23.27.33.39.45.49.53.57.59.61.65.69.75.83.87.89.91.93.97.\n\n# don't forget to stop background job\nkill %1\n{code}\n\nMaybe it's just some timing issue which just becomes critical when there are two instead of just one subscription. But still, with a server-side timeout, the server should be able to tell if a message was completely delivered to a client or not, despite the timeout.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"created":"2014-01-13T20:10:28.134+0000","updated":"2014-01-13T20:10:28.134+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13870271","id":"13870271","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"There are several possible desirable outcomes with REST and JMS.  Unfortunately, they are vastly different in their methodology - REST is based on synchronous request/reply and JMS is based on asynchronous passing of messages to consumers.\n\nConsider load balancing in a scenario mixing REST and JMS clients.  The current model, using prefetch to push messages, provides semantics that are more \"fair\" to the REST client by allowing messages to cache in the internal consumer for that client, just as they do for JMS clients.\n\nWith that said, there is no analogous REST scenario for automatically releasing messages when the connection closes because REST always closes the connection after a single message while JMS holds it open indefinitely.\n\nFor more advanced use-cases, perhaps camel would be a good tool to intelligently bridge the REST/JMS gap.\n\nBTW, the messages stored in the consumer for REST clients aren't truly lost.  They will sit indefinitely, but once the broker restarts, they will be returned to the broker.  This is actually bad for many reasons since it really means an idle consumer - very bad for JMS in general and activemq in particular.\n\nPerhaps we need a REST call that will force close a consumer, or a REST call that intentionally performs a one-shot message receive (i.e. automatically closes the consumer after the call).  Honestly, I'd prefer to put my effort elsewhere since, as mentioned above, REST for JMS is not a great fit.\n\nHope this helps.  Let me know your thoughts.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-14T01:37:23.802+0000","updated":"2014-01-14T01:37:23.802+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13870368","id":"13870368","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"That's a great test case.  There is a race condition when a request takes more than 10ms (the minimum timeout) to complete.  It races with the availability of the message.\n\nI'm working on a fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-14T04:12:47.149+0000","updated":"2014-01-14T04:12:47.149+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13870940","id":"13870940","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Attaching a more complete patch that:\n\n* eliminates a race condition in which the servlet receives a message during a continuation at the same time the continuation times-out leading to a lost message\n* eliminates another race condition in which a client may block longer than necessary when a message arrives immediately after the initial receive call fails to return a message\n* prevents concurrent use of a consumer by throwing an exception on a request to use a consumer when that consumer is already active in another request.\n\nThere is still a possible message-loss scenario that can't be fixed without a rework of the protocol with the client.  Once the servlet receives the message and attempts to send it back to the client, if the client loses the connection to the server, that message is lost.  The only 100% reliable solution to that is to push message acknowledgement down to the client, which opens more potential issues.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-14T17:33:59.220+0000","updated":"2014-01-14T17:33:59.220+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13871119","id":"13871119","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"That patch also adds a URL-encoded parameter, oneShot, that when true, will close the consumer on completion of the request.  Like this:\n\n{noformat}\ncurl --no-keepalive -o message \\\n\t\"http://localhost:8161/api/message/TEST?type=queue&clientId=GETID1&readTimeout=1000&oneShot=true\"\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-14T20:42:37.410+0000","updated":"2014-01-14T20:42:37.410+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13871194","id":"13871194","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"body":"Thank you for your explanations. I'm content with the prefetch scenario, as long as every message can be reliably consumed using a known set of subscriptions. With the oneShot parameter, semantics are more intuitive though, as there are no lingering subscriptions.\n\nBack to testing: With the second patch, the \"low-timeout multiple receivers\" testcase as well as the original testcase work perfectly. Even with prefetch=0 there is no message loss. With two concurrent receivers and no prefetch, messages are not distributed equally, but that is as expected. \"oneShot\" works, too -- even with multiple aggressively polling receivers.\n\nGreat work, thank you very much!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=psedi","name":"psedi","key":"psedi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Europe/Berlin"},"created":"2014-01-14T21:18:14.551+0000","updated":"2014-01-14T21:18:14.551+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13873487","id":"13873487","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Patch applied with some minor code cleanup.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-01-16T15:20:45.474+0000","updated":"2014-01-16T15:20:45.474+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12684816/comment/13874391","id":"13874391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Great!  Thanks Timothy.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-17T03:51:17.836+0000","updated":"2014-01-17T03:51:17.836+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4938/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1qq2f:"}}