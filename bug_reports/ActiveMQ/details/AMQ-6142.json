{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12933814","self":"https://issues.apache.org/jira/rest/api/2/issue/12933814","key":"AMQ-6142","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334251","id":"12334251","name":"5.13.1","archived":false,"released":true,"releaseDate":"2016-02-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334188","id":"12334188","name":"5.14.0","archived":false,"released":true,"releaseDate":"2016-08-05"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2016-02-01T17:37:41.894+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 11 13:35:29 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_618194708_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-02-01T17:44:31.958+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6142/watchers","watchCount":5,"isWatching":false},"created":"2016-01-25T14:01:17.314+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329390","id":"12329390","name":"5.10.2","archived":false,"released":true,"releaseDate":"2015-02-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12333269","id":"12333269","name":"5.12.1","archived":false,"released":true,"releaseDate":"2015-10-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12333254","id":"12333254","name":"5.11.3","archived":false,"released":true,"releaseDate":"2015-11-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329848","id":"12329848","name":"5.13.0","archived":false,"released":true,"releaseDate":"2015-12-03"}],"issuelinks":[{"id":"12455469","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12455469","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12679335","key":"AMQ-4887","self":"https://issues.apache.org/jira/rest/api/2/issue/12679335","fields":{"summary":"ActiveMQBytesMessage will lost content if message's property was set before copy ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-04-11T13:35:29.923+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"In our environment we use an embedded broker. On one topic where compression is enabled, the server is also listening in on the messages. From ActiveMQ 5.10.0 up to 5.13.0, we encounter DataFormatException: incorrect header check exceptions on the tcp clients due to corruption of the payload. Attached are a test server and client. At some point, the client will exit due to mentioned exception. Increase chances by running multiple clients. This scenario works with 5.8.0 and 5.9.1.\n\nIf the server has multiple consumers on the same topic, they will encounter corruption as well, but this has other side-effects.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12797284","id":"12797284","filename":"amq-6142.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-06T11:35:53.427+0000","size":2503,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12797284/amq-6142.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12784155","id":"12784155","filename":"Client.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"created":"2016-01-25T14:03:04.600+0000","size":796,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12784155/Client.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12784156","id":"12784156","filename":"MessageListener.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"created":"2016-01-25T14:03:04.603+0000","size":352,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12784156/MessageListener.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12784158","id":"12784158","filename":"pom.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"created":"2016-01-25T14:03:04.609+0000","size":923,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12784158/pom.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12784157","id":"12784157","filename":"Server.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"created":"2016-01-25T14:03:04.606+0000","size":1833,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12784157/Server.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ActiveMQBytesMessage decompress throws DataFormatException incorrect header check","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15115226","id":"15115226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"body":"Stack trace:\n{noformat}\njavax.jms.JMSException: java.util.zip.DataFormatException: incorrect header check\n\tat org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:72)\n\tat org.apache.activemq.command.ActiveMQBytesMessage.initializeReading(ActiveMQBytesMessage.java:884)\n\tat org.apache.activemq.command.ActiveMQBytesMessage.getBodyLength(ActiveMQBytesMessage.java:198)\n\tat com.foo.bar.activemqtest.MessageListener.onMessage(MessageListener.java:11)\n\tat org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1393)\n\tat org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)\n\tat org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:202)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\nCaused by: java.io.IOException: java.util.zip.DataFormatException: incorrect header check\n\tat org.apache.activemq.command.ActiveMQBytesMessage.decompress(ActiveMQBytesMessage.java:902)\n\tat org.apache.activemq.command.ActiveMQBytesMessage.initializeReading(ActiveMQBytesMessage.java:876)\n\t... 10 more\nCaused by: java.util.zip.DataFormatException: incorrect header check\n\tat java.util.zip.Inflater.inflateBytes(Native Method)\n\tat java.util.zip.Inflater.inflate(Inflater.java:259)\n\tat java.util.zip.Inflater.inflate(Inflater.java:280)\n\tat org.apache.activemq.command.ActiveMQBytesMessage.decompress(ActiveMQBytesMessage.java:898)\n\t... 11 more\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"created":"2016-01-25T14:01:49.237+0000","updated":"2016-01-25T14:02:09.132+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15115228","id":"15115228","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"body":"Prior thread on activemq-users: http://activemq.2283324.n4.nabble.com/ActiveMQBytesMessage-decompress-throws-DataFormatException-incorrect-header-check-tp4706292.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"created":"2016-01-25T14:03:38.909+0000","updated":"2016-01-25T14:03:38.909+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15121768","id":"15121768","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"body":"{noformat}\npackage com.foo.bar.activemqtest;\n\nimport javax.jms.*;\nimport javax.jms.Connection;\nimport javax.jms.Message;\n\nimport org.apache.activemq.*;\nimport org.apache.activemq.broker.*;\nimport org.junit.*;\n\npublic class ActiveMQBytesMessageCorruptionTest\n{\n    private volatile AssertionError assertionError;\n\n    @Test\n    public void bytesMessageCorruption() throws Exception\n    {\n        BrokerService brokerService = new BrokerService();\n        brokerService.setBrokerName(\"embedded\");\n        brokerService.setPersistent(false);\n        brokerService.start();\n\n        ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(\"vm://embedded\");\n        connectionFactory.setUseCompression(true);\n\n        Connection connection = connectionFactory.createConnection();\n        connection.start();\n\n        for (int i = 0; i < 10; i++)\n        {\n            Session mySession = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);\n            mySession.createConsumer(mySession.createTopic(\"foo.bar\")).setMessageListener(this::onMessage);\n        }\n\n        Session producerSession = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);\n        MessageProducer messageProducer = producerSession.createProducer(producerSession.createTopic(\"foo.bar\"));\n\n        for (int i = 0; i < 1000; i++)\n        {\n            BytesMessage bytesMessage = producerSession.createBytesMessage();\n            bytesMessage.writeBytes(new byte[0]);\n            messageProducer.send(bytesMessage);\n\n            if (assertionError != null)\n            {\n                throw assertionError;\n            }\n        }\n\n    }\n\n    private void onMessage(Message message)\n    {\n        try\n        {\n            ((BytesMessage) message).getBodyLength();\n        }\n        catch (JMSException | Error e)\n        {\n            assertionError = new AssertionError(\"Exception in thread\", e);\n        }\n    }\n}\n{noformat}\nUnit test will fail most of the time with:\n{noformat}\njava.lang.AssertionError: Exception in thread\n\tat com.foo.bar.activemqtest.ActiveMQBytesMessageCorruptionTest.onMessage(ActiveMQBytesMessageCorruptionTest.java:60)\n\tat org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1393)\n\tat org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:131)\n\tat org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:202)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n\tat java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.OutOfMemoryError: Java heap space\n\tat org.apache.activemq.command.ActiveMQBytesMessage.decompress(ActiveMQBytesMessage.java:897)\n\tat org.apache.activemq.command.ActiveMQBytesMessage.initializeReading(ActiveMQBytesMessage.java:876)\n\tat org.apache.activemq.command.ActiveMQBytesMessage.getBodyLength(ActiveMQBytesMessage.java:198)\n\tat com.foo.bar.activemqtest.ActiveMQBytesMessageCorruptionTest.onMessage(ActiveMQBytesMessageCorruptionTest.java:56)\n\tat com.foo.bar.activemqtest.ActiveMQBytesMessageCorruptionTest$$Lambda$3/665188480.onMessage(Unknown Source)\n\t... 8 more\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tagliola","name":"tagliola","key":"tagliola","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Tagliola","active":true,"timeZone":"Europe/Amsterdam"},"created":"2016-01-28T15:56:07.751+0000","updated":"2016-01-28T15:56:25.707+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15126614","id":"15126614","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit aaa2fdd5418098b98595f9f85be8248da32aff7b in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=aaa2fdd ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6142\n\nFixing a race condition that exists in the decompress method of\nActiveMQBytesMessage that can cause an invalid length to be read.\n\n(cherry picked from commit 5f7a81f9280fb65b8a3c1f85c4570a18d87fafd9)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-02-01T17:37:41.894+0000","updated":"2016-02-01T17:37:41.894+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15126621","id":"15126621","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Thanks for the test cases.  There was a race condition in the decompress method of ActiveMQBytesMessage.  I applied a fix and include a variation of one of your tests to make sure to catch this problem if it comes back in the future.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-02-01T17:44:31.999+0000","updated":"2016-02-01T17:44:31.999+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15228135","id":"15228135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"[~cshannon] sorry for the late input. I was peeking at this change and some of the sync from https://issues.apache.org/jira/browse/AMQ-6218 etc.\n\nMessage intentionally has no sync, the intent is that copy is called if mods will be made. There is one before dispatch to a consumer that should sort this issue.\nHowever, the copy seems broken.\nFor this bytesMessage case, it looks like the root cause is in message.copy where the content ByteSequence is referenced rather than copied in error.\n\nFor AMQ-6218 - if all of those issues relate to concurrentStoreAndDispatch, it may be that we need to take a message.copy for the async store case.\n\nLet me attach a diff to see if this makes sense to you.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-06T11:34:04.333+0000","updated":"2016-04-06T11:34:04.333+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15228136","id":"15228136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"amq-6142.diff - file attach. Show the problem with message.copy that seems to be the root cause cc [~cshannon]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-06T11:35:53.431+0000","updated":"2016-04-06T11:35:53.431+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15228163","id":"15228163","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~gtully], This diff makes sense to fix the copy which is the root of the issue.  My commit had a test so if this diff is applied as a new commit CI can check that everything is still good.\n\nFor AMQ-6218, yes the entire problem comes down to concurrentStoreAndDispatch.  I talked to [~tabish121] about it a little and the problem shows up when using the VM transport because of the same message reference but two different threads accessing it.  There are other messages that could be fixed but the text message is the main issue because of the fix from AMQ-5857 where we clear out the text after converting to bytes so that the data isn't stored twice but only counted once.  So you can get into this weird state where both bytes and text end up being null.   \n\nCopying the message before doing the async store would fix this issue for sure and would allow the sync that I added to be backed out.  We could also back out the fix from AMQ-5857 as it was only applied to text messages (but other messages have the same issue i think) which would fix the issue as well.  I think that backing out the sync and copying the message before the async store makes the most sense but I didn't do that originally because I was concerned about the extra memory usage for large messages and for the memory usage counter to not take that into account.  But the copy is probably the right thing to do to prevent future problems with the async store case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-04-06T12:10:49.193+0000","updated":"2016-04-06T12:10:49.193+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15228254","id":"15228254","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Also if we go the copy route we would need to take a look at the async listener that runs after completion.  I recently committed a fix to move the clearMarshalledState() call into the listener (if reduce memory footprint is on) and I think that might still need to run on the original message, not the copy since the copy should be GC's anyways after it's written.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-04-06T13:39:33.759+0000","updated":"2016-04-06T13:39:33.759+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15228298","id":"15228298","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"good point, but thinking some more, the copy may be problematic because the concurrentStore stuff is coordinated through state in the messageId which is also copied. Will need to do some more root cause analysis on the concurrentStoreAndDisptch cases.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-06T14:06:31.089+0000","updated":"2016-04-06T14:06:31.089+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15228649","id":"15228649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~gtully], Seems like this same issue reported in AMQ-6218 that caused me to add synchronization has also come up before in AMQ-2966.  What do you think about rolling back the fix I added from AMQ-5857 that clears out the text field after marshalling?  That was the start of all of these issues since state is now mutated and before it wasn't.  The downside is that the data would once again be stored twice leading to possible OOM issues, including for clients which is why originally AMQ-5857 was submitted.  So it would be nice to be able to clear it out but not if other concurrent issues keep popping up.\n\nAlso, on a related note having to do with changing message state during dispatch, as I was digging back through some of this stuff I was looking at the reduceMemoryFootPrint flag and wondering if it could be applied to topics.  I'm guessing it caused issues before so it wasn't applied (maybe with concurrent store and dispatch for topics) but it would be useful to be able to turn it on, especially if concurrent store and dispatch is off, which is the default.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-04-06T17:02:06.470+0000","updated":"2016-04-06T17:02:35.232+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15230280","id":"15230280","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"there is some more context in https://issues.apache.org/jira/browse/AMQ-2103","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-07T14:04:58.498+0000","updated":"2016-04-07T14:04:58.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15230472","id":"15230472","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"[~cshannon] I think rolling back the sync is best, then thinking of mutation being ok on your own copy which implies maybe doing more copies and those not sharing mutable state. Client side there is typically a copy per consumer. \nBroker side there is a single copy of the message at the moment and the reduceMemoryFootPrint policy can control whacking the duplicate state on send/store for a queue. concurrentStoreAndDispatch muddies that a bit.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-07T16:04:54.343+0000","updated":"2016-04-07T18:35:31.278+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15232035","id":"15232035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Yep agreed, lets roll back the sync I added.  I think the Jira reported for AMQ-5857 was about client side and not the broker side (since reduceMemoryFootprint exists to clear the duplicate state, at least for queues).  I would say we either need to roll that commit back as well or maybe figure out a way so that the client can clear out the state but the broker won't clear it out until it is safe to do so.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-04-08T11:14:11.317+0000","updated":"2016-04-08T11:14:32.774+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15234993","id":"15234993","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit e69c2cbad6611fa355bd9eb592f03bd3b8f90abb in activemq's branch refs/heads/master from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e69c2cb ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6142\n\nMoving the bytes copy to the parent Message class to solve this this\nissue for all message types as that is the root cause\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-11T12:32:54.084+0000","updated":"2016-04-11T12:32:54.084+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15234994","id":"15234994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 20e84d63e045d3d26627e204c808677a8fe77dc4 in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=20e84d6 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6142\n\nMoving the bytes copy to the parent Message class to solve this this\nissue for all message types as that is the root cause\n\n(cherry picked from commit e69c2cbad6611fa355bd9eb592f03bd3b8f90abb)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-11T12:33:14.429+0000","updated":"2016-04-11T12:33:14.429+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15235015","id":"15235015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~gtully], I applied your new patch as it makes sense to move the bytes copy to that root Message class.  I also rolled back the sync as we discussed. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-04-11T12:39:05.387+0000","updated":"2016-04-11T12:39:05.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15235034","id":"15235034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"[~cshannon] great. I recall many times thinking message needed some sync and then finding a missing copy or a copy in the wrong place :-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-11T12:43:09.363+0000","updated":"2016-04-11T12:43:09.363+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15235090","id":"15235090","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Yep, makes sense now :) I think what's left to do would be to call beforeMarshall on the message before async store to prevent the concurrent modifications on dispatch with the vm transport and also hopefully apply reduceMemoryFootprint flag for the topic case.  These can be done in new Jiras for a 5.14.0 release.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-04-11T13:31:59.541+0000","updated":"2016-04-11T13:31:59.541+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12933814/comment/15235098","id":"15235098","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"agree","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-11T13:35:29.923+0000","updated":"2016-04-11T13:35:29.923+0000"}],"maxResults":20,"total":20,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6142/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2rxbb:"}}