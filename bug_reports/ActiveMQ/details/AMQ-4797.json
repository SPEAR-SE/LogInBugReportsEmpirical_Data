{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12673284","self":"https://issues.apache.org/jira/rest/api/2/issue/12673284","key":"AMQ-4797","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2013-10-10T21:55:13.058+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 26 21:47:18 UTC 2014","customfield_12310420":"352907","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4797/watchers","watchCount":4,"isWatching":false},"created":"2013-10-10T18:32:07.070+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["addlistener","ajax","web"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-26T21:47:18.851+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I'm using ExtJS to create two separate panels which run in one browser tab.  After loading jquery, amq_jquery_adapter.js and amq.js I call amq_init (only once).  Then each panel calls addlistener like so: \n\nPanel 1 code: \n{code}amq.addListener('testconnection1', topic://MyApp/IOIs/Simulator', myHandler1.rcvMessage);{code}\n\nPanel 2 code: \n{code}amq.addListener('testconnection2', 'topic://MyApp/IOIs/Simulator', myHandler2.rcvMessage);{code}\n\nNote that both are subscribing to the same topic.  This is because Panel 1 shows the data in a different format than Panel 2. \n\n*The Problem:*\nIf I start Panel 1 alone, it receives data from the topic without problems. But then I start Panel 2 and as soon as it executes the addlistener, Panel 2 starts receiving data but Panel 1 stops!   \n\nSo I started tracing into the network traffic and all looks fine, i.e, I can see each addlistener trigger a 'listen' request with the proper id and topic.  And I see the amq server return data to testconnection1, then stop suddenly when the 'listen' for testconnection2 is sent.  So I turned my attention to the backend code and enabled a detailed trace.  Here's what I found: \n\nWhen the Panel 1 'listen' is received, the trace shows: \n{quote}2013-10-10 09:10:09,701 | DEBUG | 0 destination=topic://MyApp/IOIs/Simulator message=testconnection1 type=listen | org.apache.activemq.web.MessageListenerServlet | qtp2088898587-51 - /demo/amq\n2013-10-10 09:10:09,701 | DEBUG | topic://MyApp/IOIs/Simulator is a org.apache.activemq.command.ActiveMQTopic | org.apache.activemq.web.MessageListenerServlet | qtp2088898587-51 - /demo/amq\n2013-10-10 09:10:09,701 | DEBUG | amq-broker adding consumer: ID:MYAPPDATA-7392-1381410590247-5:1:1:1 for destination: topic://MyApp/IOIs/Simulator | org.apache.activemq.broker.region.AbstractRegion | ActiveMQ VMTransport: vm://localhost#1-2\n2013-10-10 09:10:09,701 | DEBUG | amq-broker adding destination: topic://ActiveMQ.Advisory.Consumer.Topic.MyApp/IOIs/Simulator | org.apache.activemq.broker.region.AbstractRegion | ActiveMQ VMTransport: vm://localhost#1-2\n2013-10-10 09:10:09,717 | DEBUG | Initialized TaskRunnerFactory[ActiveMQ Session Task] using ExecutorService: java.util.concurrent.ThreadPoolExecutor@2e2667db[Running, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0] | org.apache.activemq.thread.TaskRunnerFactory | qtp2088898587-51 - /demo/amq\n2013-10-10 09:10:09,717 | DEBUG | Subscribed: ActiveMQMessageConsumer { value=ID:MYAPPDATA-7392-1381410590247-5:1:1:1, started=true } to topic://MyApp/IOIs/Simulator id=testconnection1 | org.apache.activemq.web.MessageListenerServlet | qtp2088898587-51 - /demo/amq{quote}\n\nWhen the Panel 2 'listen' is received, I see this trace: \n{quote}2013-10-10 09:10:09,888 | DEBUG | 0 destination=topic://MyApp/IOIs/Simulator message=testconnection2 type=listen | org.apache.activemq.web.MessageListenerServlet | qtp2088898587-53 - /demo/amq\n2013-10-10 09:10:09,888 | DEBUG | topic://MyApp/IOIs/Simulator is a org.apache.activemq.command.ActiveMQTopic | org.apache.activemq.web.MessageListenerServlet | qtp2088898587-53 - /demo/amq\n2013-10-10 09:10:09,888 | DEBUG | remove: ID:MYAPPDATA-7392-1381410590247-5:1:1:1, lastDeliveredSequenceId:0 | org.apache.activemq.ActiveMQMessageConsumer | qtp2088898587-53 - /demo/amq\n2013-10-10 09:10:09,888 | DEBUG | Unregistering MBean org.apache.activemq:type=Broker,brokerName=amq-broker,destinationType=Topic,destinationName=MyApp/IOIs/Simulator,endpoint=Consumer,clientId=ID_MYAPPDATA-7392-1381410590247-4_1,consumerId=ID_MYAPPDATA-7392-1381410590247-5_1_1_1 | org.apache.activemq.broker.jmx.ManagementContext | ActiveMQ VMTransport: vm://localhost#1-2\n2013-10-10 09:10:09,888 | DEBUG | amq-broker removing consumer: ID:MYAPPDATA-7392-1381410590247-5:1:1:1 for destination: topic://MyApp/IOIs/Simulator | org.apache.activemq.broker.region.AbstractRegion | ActiveMQ VMTransport: vm://localhost#1-2\n2013-10-10 09:10:09,888 | DEBUG | amq-broker adding consumer: ID:MYAPPDATA-7392-1381410590247-5:1:1:2 for destination: topic://MyApp/IOIs/Simulator | org.apache.activemq.broker.region.AbstractRegion | ActiveMQ VMTransport: vm://localhost#1-2\n2013-10-10 09:10:09,904 | DEBUG | Subscribed: ActiveMQMessageConsumer { value=ID:MYAPPDATA-7392-1381410590247-5:1:1:2, started=true } to topic://MyApp/IOIs/Simulator id=testconnection2 | org.apache.activemq.web.MessageListenerServlet | qtp2088898587-53 - /demo/amq{quote}\n\nWhat is happening is that in MessageListenerServlet.js, function doPost, line 165 is dropping any previous consumer to the same destination: \n{code}client.closeConsumer(destination); // drop any existing consumer.{code}\n\nBut why?  There doesn't seem to be a good reason for doing this--maybe it was originally put there for cleanup purposes?.  Or if there is a good reason, maybe the behavior should be to not do it if the id of the new destination (in this case 'testconnection2') is different than the id of the existing destination ('testconnection1'). \n\nI believe this can be fixed by simply removing line 165 from MessageListenerServlet.js but I'm not sure if this will break something else.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"353194","customfield_12312823":null,"summary":"Unable to add multiple AJAX listeners for the same topic in the same browser window","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ptrader98","name":"ptrader98","key":"ptrader98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bill Harts","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ptrader98","name":"ptrader98","key":"ptrader98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bill Harts","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows Server 2008 R2 on Dell server boxes","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12673284/comment/13792019","id":"13792019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ptrader98","name":"ptrader98","key":"ptrader98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bill Harts","active":true,"timeZone":"America/New_York"},"body":"I just tried deleting line 165 and it still doesn't work.  It may be a problem with looking up the consumer by the connection, but that's a guess.  \n\nAppreciate any help with this!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ptrader98","name":"ptrader98","key":"ptrader98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bill Harts","active":true,"timeZone":"America/New_York"},"created":"2013-10-10T21:43:06.294+0000","updated":"2013-10-10T21:43:06.294+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12673284/comment/13792029","id":"13792029","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Try with a recent 5.9-SNAPSHOT, there's lots of fixes in there and this might already be covered.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-10-10T21:55:13.058+0000","updated":"2013-10-10T21:55:13.058+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12673284/comment/13792891","id":"13792891","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ptrader98","name":"ptrader98","key":"ptrader98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bill Harts","active":true,"timeZone":"America/New_York"},"body":"Thanks, Tim.  I just tried the latest apache-activemq-5.9-20131010.203434-114-bin snapshot and it still exhibits the same behavior.\n\nFYI, I have downloaded all the sources and removed what I thought was the offending line 165 in MessageListenerServlet.js but it still fails.  So much for my first foray into the guts of ActiveMQ.\n\nBill","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ptrader98","name":"ptrader98","key":"ptrader98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bill Harts","active":true,"timeZone":"America/New_York"},"created":"2013-10-11T18:07:19.873+0000","updated":"2013-10-11T18:07:19.873+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12673284/comment/13948267","id":"13948267","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=igough","name":"igough","key":"igough","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ian Gough","active":true,"timeZone":"America/New_York"},"body":"The ability to have multiple listeners is important if you want to use multiple selectors.\n\nImagine you have a system with a single Topic, to which multiple different message types are published. In order to reduce the messaging traffic to the AMQ servlet from the AMQ server, you set up selectors in the JS code. This has the effect of restricting the messages you need to react to and allows you to have separate handlers for each message type in which you are interested. This pattern currently works very well in Java, but not in the AJAX implementation due to this bug.\n\ni.e. this pattern does not work.\n\nthis.amq.addListener( id1, topic, handler1, selector1 );\nthis.amq.addListener( id2, topic, handler2, selector2 );\nthis.amq.addListener( id3, topic, handler3, selector3 );\n\nThe bug causes only the last listener (handler3) to be registered as a listener.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=igough","name":"igough","key":"igough","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ian Gough","active":true,"timeZone":"America/New_York"},"created":"2014-03-26T18:25:20.161+0000","updated":"2014-03-26T18:25:20.161+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12673284/comment/13948525","id":"13948525","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prgtrdr","name":"prgtrdr","key":"prgtrdr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bill Harts","active":true,"timeZone":"America/Havana"},"body":"Ian,\n\nYes, everything you wrote is sadly correct.\n\nI have a very fragile workaround which is to load 5 separate copies of the amq.js module, and reference each through a private member variable.  It's a terrible way to accomplish this, wastes memory, and occasionally fails (I haven't figured out why).\n\nI am hoping someone can track down the bug.  I took a stab at it as you can see in my previous posts.  What is happening is that in MessageListenerServlet.js, function doPost, line 165 is dropping any previous consumer to the same destination, but deleting that statement did not fix the problem.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=prgtrdr","name":"prgtrdr","key":"prgtrdr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bill Harts","active":true,"timeZone":"America/Havana"},"created":"2014-03-26T21:47:18.851+0000","updated":"2014-03-26T21:47:18.851+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4797/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1ouef:"}}