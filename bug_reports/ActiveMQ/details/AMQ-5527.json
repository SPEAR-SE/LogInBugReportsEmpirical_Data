{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12768547","self":"https://issues.apache.org/jira/rest/api/2/issue/12768547","key":"AMQ-5527","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2016-02-13T13:14:42.548+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Feb 13 13:14:42 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_33663019543_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-02-13T13:14:42.480+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5527/watchers","watchCount":3,"isWatching":false},"created":"2015-01-19T22:24:23.115+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":["performance"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[{"id":"12457237","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12457237","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12916709","key":"AMQ-6066","self":"https://issues.apache.org/jira/rest/api/2/issue/12916709","fields":{"summary":"Performance issue in OrderedPendingList","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-02-13T13:14:42.611+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313904","id":"12313904","name":"JMX","description":"The JMX support in ActiveMQ"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"On large, persistent queues, (100,000+ messages), we're noticing huge performance issues with Queue.removeMessage().  (It takes 8-20 minutes to remove a single message).  \n\nThread dump while running showed this:\n\"RMI TCP Connection(5)-192.168.1.10\" daemon prio=5 tid=0x00007f8491954800 nid=0x9807 runnable [0x000000011bfd7000]\n   java.lang.Thread.State: RUNNABLE\n\tat org.apache.activemq.broker.region.cursors.OrderedPendingList.contains(OrderedPendingList.java:144)\n\tat org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1913)\n\tat org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1901)\n\tat org.apache.activemq.broker.region.Queue.removeMatchingMessages(Queue.java:1374)\n\tat org.apache.activemq.broker.region.Queue.removeMessage(Queue.java:1341)\n\tat org.apache.activemq.broker.jmx.QueueView.removeMessage(QueueView.java:60)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:57)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:606)\n\tat sun.reflect.misc.Trampoline.invoke(MethodUtil.java:75)\n\tat sun.reflect.GeneratedMethodAccessor3.invoke(Unknown Source)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n\tat java.lang.reflect.Method.invoke(Method.java:606)\n\tat sun.reflect.misc.MethodUtil.invoke(MethodUtil.java:279)\n\tat com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:112)\n\tat com.sun.jmx.mbeanserver.StandardMBeanIntrospector.invokeM2(StandardMBeanIntrospector.java:46)\n\tat com.sun.jmx.mbeanserver.MBeanIntrospector.invokeM(MBeanIntrospector.java:237)\n\tat com.sun.jmx.mbeanserver.PerInterface.invoke(PerInterface.java:138)\n\tat com.sun.jmx.mbeanserver.MBeanSupport.invoke(MBeanSupport.java:252)\n\tat javax.management.StandardMBean.invoke(StandardMBean.java:405)\n\tat org.apache.activemq.broker.jmx.AnnotatedMBean.invoke(AnnotatedMBean.java:198)\n\nStrangely, the web admin console is completely responsive and attempting a delete through the web console is highly performant even on large queues.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Performance issues for org.apache.activemq.broker.jmx.QueueView.removeMessage","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rimovm","name":"rimovm","key":"rimovm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Rimov","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rimovm","name":"rimovm","key":"rimovm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Rimov","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Mac/Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12768547/comment/14288083","id":"14288083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rimovm","name":"rimovm","key":"rimovm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Rimov","active":true,"timeZone":"Etc/UTC"},"body":"I think my initial report was inaccurate and it didn't have to do with size.  Relevant setup:\n{code}\n\n  <broker brokerName=\"testBroker\" xmlns=\"http://activemq.apache.org/schema/core\" advisorySupport=\"true\" useJmx=\"true\" offlineDurableSubscriberTimeout=\"10000\" >\n      <destinationPolicy>\n        <policyMap>\n          <policyEntries>\n            <policyEntry queue=\">\" optimizedDispatch=\"true\" producerFlowControl=\"false\" memoryLimit=\"128mb\" expireMessagesPeriod=\"300\">\n              <deadLetterStrategy>\n                <individualDeadLetterStrategy queuePrefix=\"DLQ.\" useQueueForQueueMessages=\"true\"/>\n              </deadLetterStrategy>\n            </policyEntry>\n          </policyEntries>\n        </policyMap>\n      </destinationPolicy>\n\n      <persistenceAdapter>\n        <jdbcPersistenceAdapter dataDirectory=\"${activemq.base}/data\" dataSource=\"#mysql-ds\" lockKeepAlivePeriod=\"5000\">\n        \t<locker>\n\t            <lease-database-locker lockAcquireSleepInterval=\"10000\" leaseHolderId=\"testBroker\"/>\n          </locker>\n        </jdbcPersistenceAdapter>\n      </persistenceAdapter>\n\n      <transportConnectors>\n        <transportConnector name=\"nio\" uri=\"nio://0.0.0.0:55540\"/>\n        <transportConnector name=\"stomp+nio\" uri=\"stomp+nio://0.0.0.0:61613\"/>\n      </transportConnectors>\n    </broker>\n    <!-- MySql DataSource Setup -->\n    <bean id=\"mysql-ds\" class=\"org.apache.commons.dbcp.BasicDataSource\">\n      <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n      <property name=\"url\" value=\"${jms.jdbc.url}\"/>\n      <property name=\"username\" value=\"${jms.jdbc.username}\"/>\n      <property name=\"password\" value=\"${jms.jdbc.password}\"/>\n      <property name=\"maxActive\" value=\"50\"/>\n      <property name=\"poolPreparedStatements\" value=\"false\"/>\n    </bean>\n{code}\n\nIf I was running the following test: (Disclaimer:Code was admittedly snagged from AMQ5212, it may not always make sense :) )\n\n{code}\nimport javax.jms.JMSException;\nimport javax.jms.Session;\n\nimport org.apache.activemq.ActiveMQConnection;\nimport org.apache.activemq.ActiveMQConnectionFactory;\nimport org.apache.activemq.ActiveMQMessageProducer;\nimport org.apache.activemq.ActiveMQSession;\nimport org.apache.activemq.command.ActiveMQQueue;\nimport org.apache.activemq.command.ActiveMQTextMessage;\nimport org.junit.Test;\n\npublic class AMQ5527Test {\n\t    \n\t    @Test\n\t    public void testSendMultipleMessagesToDLQ() throws JMSException {\n\t    \t//Whatever your local server is.\n\t    \tfinal ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(\"nio://localhost:55540\");\n\t        connectionFactory.setCopyMessageOnSend(false);\n\t        connectionFactory.setWatchTopicAdvisories(false);\n\t        ActiveMQConnection activeMQConnection = (ActiveMQConnection) connectionFactory.createConnection();\n\t        activeMQConnection.start();\n\t        \n\t        //Create it as transacted so I can browse it afterwards in JConsole\n\t        ActiveMQSession activeMQSession = (ActiveMQSession) activeMQConnection.createSession(true, Session.CLIENT_ACKNOWLEDGE);\n\n\t        try {\n\t\t        ActiveMQQueue dest = new ActiveMQQueue(\"test-queue-\" \n\t\t                + getClass().getSimpleName());\n\t\t        ActiveMQMessageProducer activeMQMessageProducer = (ActiveMQMessageProducer) activeMQSession.createProducer(dest);\n\t\t        // create demand so page in will happen\n\t\t        activeMQSession.createConsumer(dest);\n\t\t        ActiveMQTextMessage message = new ActiveMQTextMessage();\n\t\t        message.setDestination(dest);\n\t\t        activeMQMessageProducer.send(message, null);\n\t\t\n\t\t        // send a duplicate\n\t\t        activeMQConnection.syncSendPacket(message);\n\t\t  \n\t\t        //Do it again.\n\t\t        activeMQConnection.syncSendPacket(message);\n\t        } finally {\n\t        \tactiveMQSession.commit();\n\t        }\n\t        activeMQConnection.close();\n\t    \t\n\t    }\n\n}\n{code}\n\nand then go to the console.  Select the main test queue.   Go to OperationsPage and click \"browseAsTable\"\n\nCPU core usage immediately shot up to 170% usage (as reported by Mac Activity Monitor)  and it hasn't come out of it yet as I'm writing this report. \n\nI hope this is more helpful.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rimovm","name":"rimovm","key":"rimovm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Rimov","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-22T19:38:06.862+0000","updated":"2015-01-22T19:38:06.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12768547/comment/15145973","id":"15145973","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"I believe this issue was fixed in AMQ-6066, I recommend re-testing to see if a newer version that contains that fix indeed helps in this case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-02-13T13:14:42.548+0000","updated":"2016-02-13T13:14:42.548+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5527/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i24jhb:"}}