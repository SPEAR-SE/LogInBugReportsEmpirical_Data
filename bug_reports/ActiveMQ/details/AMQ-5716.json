{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12819732","self":"https://issues.apache.org/jira/rest/api/2/issue/12819732","key":"AMQ-5716","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-04-09T21:34:23.514+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jun 24 13:30:58 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5716/watchers","watchCount":2,"isWatching":false},"created":"2015-04-09T16:36:51.228+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329390","id":"12329390","name":"5.10.2","archived":false,"released":true,"releaseDate":"2015-02-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329382","id":"12329382","name":"5.11.1","archived":false,"released":true,"releaseDate":"2015-02-17"}],"issuelinks":[{"id":"12420893","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12420893","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12506741","key":"AMQ-3314","self":"https://issues.apache.org/jira/rest/api/2/issue/12506741","fields":{"summary":"FilePendingMessageCursor isFull reports full in error when temp store is full, even if not needing the temp store","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-06-24T13:30:58.207+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I might be wrong, but I think that there is a mistake in {{FilePendingMessageCursor}} in method {{isFull}}.\nThe logic implemented in code is:\n -- isFull returns true when any of \"memory usage is full\" or \"temp usage is full\".\nFrom my point of view this is a mistake and logic should be:\n -- isFull returns true only when both of \"memory usage\" and \"temp usage\" are full.\n\nThe reason why should this be fixed lies in the impact that this mistake caused us in our project:\nTopicSubscription got into endless loop in method {{add(MessageReference)}} when sending message into topic and memory limit reached 100% (it passed 100% in our case, but this is complete different story). Following conditions were fulfilled:\n * the dispatched queue reached consumer prefetch size,\n * producer flow control was disabled,\n * and finally related pending message cursor was full (because of memory usage).\nThe temporary storage remained at 0%, it wasn't created at all.\n\nI understand what is the loop good for, it waits until there is a space in pending message cursor. This is a correct behavior. Anyway, when topic uses {{FilePendingMessageCursor}}, it loops for no good reason, because the cursor itself can handle the situation when memory limit is reached/full. It dumps all messages from memory list into disk list into temporary storage.\n\nI am providing a patch file for this fix and very basic JUnit test for it, if this is acknowledged as bug and its solution.\nThird file is a JUnit test is not considered to be part of commit (it never ends without any fix provided), but shows as simple as possible the topic subscription stuck scenario.\n\nIf the cursor would return isFull as false, it would solve described situation. It is sure that I cannot know or even guess that this implementation of {{FilePendingMessageCursor}} is there for some other reason, so please take this only as my personal recommendation after some time spent on analysis of problem in our project.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12724259","id":"12724259","filename":"fix_amq_5716.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"created":"2015-04-09T16:40:53.370+0000","size":501,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12724259/fix_amq_5716.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12724260","id":"12724260","filename":"junit_amq_5716.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"created":"2015-04-09T16:40:53.374+0000","size":2083,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12724260/junit_amq_5716.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12724261","id":"12724261","filename":"TopicSubscriptionTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"created":"2015-04-09T16:40:53.383+0000","size":4563,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12724261/TopicSubscriptionTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"TopicSubscription gets into endless loop when memory limit reached","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"JDK-1.6.0_38","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10430","value":"Patch","id":"10430"}],"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12819732/comment/14488325","id":"14488325","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Some work in this area already for related issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-04-09T21:34:23.514+0000","updated":"2015-04-09T21:34:23.514+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12819732/comment/14488328","id":"14488328","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This seems valid to me after review.  It'd be nice to have [~gtully] take a look as there could be unforeseen consequences.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-04-09T21:35:38.071+0000","updated":"2015-04-09T21:35:38.071+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12819732/comment/14489134","id":"14489134","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Timothy, thanks for the related issue, after brief review it seems to me that related issue AMQ-3314 might have not been fixed correctly.\nI have another proposal to fix this issue which would be also a valid fix for AMQ-3314:\n{noformat}\n    @Override\n    public synchronized boolean isFull() {\n        return super.isFull() && systemUsage != null && systemUsage.getTempUsage().isFull();  // removed checking \"!isDiskListEmpty()\"\n    }\n{noformat}\nThe condition would express that memory and temp storage are both full, so there is no space to add the message.\nThe additional \"!isDiskListEmpty()\" seems to me as redundant check which breaks the things in case that we don't have space in memory or temp storage and disk list has not been initialized for the current FilePendingMessageCursor.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"created":"2015-04-10T08:05:35.240+0000","updated":"2015-04-10T08:05:35.240+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12819732/comment/14489898","id":"14489898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"I was thinking more along the lines of this:\n\n{noformat}\n    @Override\n    public synchronized boolean isFull() {\n        return super.isFull() && (systemUsage == null || systemUsage.getTempUsage().isFull();\n    }\n\n{noformat}\n\nGiven that if there is no systemUsage then super.isFull() should decide.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-04-10T16:37:50.459+0000","updated":"2015-04-10T16:38:21.439+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12819732/comment/14599406","id":"14599406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"body":"I agree with your proposal, it is better for sure.\n\nIs there any progress with review or resolving the issue?\nI would appreciate it very much. Fix would be motivation to upgrade to newer version.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"created":"2015-06-24T13:30:58.207+0000","updated":"2015-06-24T13:30:58.207+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5716/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2d1jr:"}}