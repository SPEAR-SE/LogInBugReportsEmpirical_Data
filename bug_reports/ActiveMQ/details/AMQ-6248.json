{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12958845","self":"https://issues.apache.org/jira/rest/api/2/issue/12958845","key":"AMQ-6248","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335045","id":"12335045","name":"5.13.3","archived":false,"released":true,"releaseDate":"2016-05-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334188","id":"12334188","name":"5.14.0","archived":false,"released":true,"releaseDate":"2016-08-05"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2016-04-18T13:46:04.731+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 18 13:54:10 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_346561808_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-04-18T13:55:43.892+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6248/watchers","watchCount":2,"isWatching":false},"created":"2016-04-14T13:39:42.125+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["failover","race-condition"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-04-18T13:55:43.919+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"There is a bug in the  {{FailoverTransport}} which is triggered by a race condition. The client log contains message:\n{{WARN | ActiveMQ Transport: *URI1* \\[FailoverTransport] Transport (*URI2*) failed, attempting to automatically reconnect}}\n\nThe exact impact on client failover differs with each setup and environment. In our case this forced client to infinitely switch between two available brokers.\n\nAssume client is configured to use broker URL in form\n{{failover:(URI1,URI2)?randomize=false}}.\nAssume that broker with URI1 is down and the other broker URI2 is running fine. This is normal master/slave setup. \n\nClient tries to establish connection and the following happens:\n1. URI1 is tried, it fails because this broker is not reachable (down or waiting slave)\n2. URI2 is tried, it succeeds because this broker is currently the 'master'\n3. Exception from thread of transport to URI1 causes failure in transport to URI2\n4. Try another transport in the list. Oh wait, its URI1 -> go to 1.\n\nImpact for different configurations might not be that severe. But unfortunately in our case we were not able to avoid this bug no matter the configuration. For example {{randomize=true}} helped a little, but still the inifinite loop happens 1/2 of the time.\n\nThe bug is caused by a single shared instance {{myTransportListener}} of {{TransportListener}} in {{FailoverTransport}} class. {{doReconnect()}} tries to start transport to URI1 and registers the listener on it. Transport fails to start and the next transport to URI2 is tried. But the listener is not unregistered from the failed transport URI1. Failures that happen on transport URI1 may call in its own thread the listener method {{onException()}}. This call will get to {{handleTransportFailure()}} where it waits for the {{reconnectMutex}}. The reconnect task thread continues, establishes Transport URI2, sets it to {{connectedTransport}}=URI2, releases the reconnectMutex. The thread of transport URI1 unblocks in handleTransportFailure() and destroys the connectedTransport=URI2.\n\nI have created a patch against version 5.11 that deals specifically with this problem.\nThe change is that instead of the single shared myTrasnportListener instance there is a new listener created for each new transport.\nEach new listener keeps reference to the transport it was assigned to. The listener will cause failover only if the exception is coming from the transport which is currently connected.\nI didn't care about the other methods of the listener, but these probably need the same restriction.\n\nThis bug is present in all versions from version 4.0 (I didn't go deeper). The idea in the patch should be applicable for all versions.\n\nBtw. log message mentioned in AMQ-4986 contains the same URI1 vs URI2 problem.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12798740","id":"12798740","filename":"AMQ-6248.patch.svndiff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pjanata","name":"pjanata","key":"pjanata","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petr Janata","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-14T14:14:39.284+0000","size":9212,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12798740/AMQ-6248.patch.svndiff"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Failover - transport connected to one broker fails due to error in connection to another broker","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pjanata","name":"pjanata","key":"pjanata","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petr Janata","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pjanata","name":"pjanata","key":"pjanata","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petr Janata","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10430","value":"Patch","id":"10430"}],"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12958845/comment/15241223","id":"15241223","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pjanata","name":"pjanata","key":"pjanata","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petr Janata","active":true,"timeZone":"Etc/UTC"},"body":"Here is the patch. It is an output from svn diff command.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pjanata","name":"pjanata","key":"pjanata","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petr Janata","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-14T14:14:39.289+0000","updated":"2016-04-14T14:14:39.289+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12958845/comment/15245674","id":"15245674","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 23a5beb86c3dac151ae3ed242ce506aa0048bd03 in activemq's branch refs/heads/master from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=23a5beb ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6248\n\nPrevent conccurent calls to handleTransportFailure from closing an\nalready reconnected transport instance.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-18T13:46:04.731+0000","updated":"2016-04-18T13:46:04.731+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12958845/comment/15245691","id":"15245691","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 46dadf986666170638f8c8c6e1cb29346f4a86b5 in activemq's branch refs/heads/activemq-5.13.x from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=46dadf9 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6248\n\nPrevent conccurent calls to handleTransportFailure from closing an\nalready reconnected transport instance.  \n(cherry picked from commit 23a5beb86c3dac151ae3ed242ce506aa0048bd03)\n\nConflicts:\n\tactivemq-client/src/main/java/org/apache/activemq/transport/failover/FailoverTransport.java\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-18T13:53:14.832+0000","updated":"2016-04-18T13:53:14.832+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12958845/comment/15245693","id":"15245693","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 3560d9123dbeecc97f075a6812f15b2484836275 in activemq's branch refs/heads/master from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=3560d91 ]\n\nAMQ-6248 fix logging statement to use the connected URI.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-04-18T13:54:10.529+0000","updated":"2016-04-18T13:54:10.529+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6248/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2w4gf:"}}