{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482766","self":"https://issues.apache.org/jira/rest/api/2/issue/12482766","key":"AMQ-2305","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-06-25T14:11:52.198+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jun 26 18:14:31 UTC 2009","customfield_12310420":"38769","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_106216816_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-06-26T18:14:31.701+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2305/watchers","watchCount":0,"isWatching":false},"created":"2009-06-25T12:44:14.885+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-06-26T18:14:31.681+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"In a pure Master/Slave configuration, when the slave fails the TransportConnection invokes the MasterBroker's stop() method without taking into consideration the shutdownOnSlaveFailure boolean, which by default is set to false.  So even if shutdownOnSlaveFailure  is set to false, all my plugin brokers' stop methods get invoked when the slave fails.  ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461550","id":"12461550","filename":"TransportConnection.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"created":"2009-06-25T12:46:55.080+0000","size":959,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461550/TransportConnection.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"233551","customfield_12312823":null,"summary":"TransportConnection Ignores isShutdownOnSlaveFailure","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"ActiveMQ 5.2, Java 5, Windoze XP Pro ","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482766/comment/12941619","id":"12941619","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"body":"attached patch","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"created":"2009-06-25T12:46:55.155+0000","updated":"2009-06-25T12:46:55.155+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482766/comment/12941628","id":"12941628","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"joe, do u have a stack trace to the stop call. I see serviceTransportException has the check, I am wondering what the other path to stop is?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-06-25T14:11:52.198+0000","updated":"2009-06-25T14:11:52.198+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482766/comment/12941635","id":"12941635","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"body":"gary, i don't have a stack trace but below is some debug output\n\nnote my embedded notes, which i've pointed out with  '<----'\n\nthe cfg files for the master and slave follow the debug output; both brokers wrote to the same log file \n\n2009-06-25 21:09:33,718 [/127.0.0.1:3457] INFO  TransportConnection            - Slave Broker slave is attached\n2009-06-25 21:09:39,078 [Thread-4       ] INFO  BrokerService                  - ActiveMQ Message Broker (slave, ID:DIEGO-3454-1245978572796-1:0) is shutting down\n2009-06-25 21:09:39,078 [Thread-4       ] DEBUG BrokerService                  - Caught exception, must be shutting down: java.lang.IllegalStateException: Shutdown in progress\n2009-06-25 21:09:39,093 [Thread-4       ] DEBUG VMTransportFactory             - Shutting down VM connectors for broker: slave\n2009-06-25 21:09:39,093 [r: vm://slave#0] DEBUG TransportConnection            - Stopping connection: vm://slave#0\n2009-06-25 21:09:39,093 [r: vm://slave#0] DEBUG TransportConnection            - Stopped transport: vm://slave#0\n2009-06-25 21:09:39,093 [r: vm://slave#0] DEBUG TransportConnection            - Cleaning up connection resources: vm://slave#0\n2009-06-25 21:09:39,093 [r: vm://slave#0] DEBUG TransportConnection            - Connection Stopped: vm://slave#0\n2009-06-25 21:09:39,093 [Thread-4       ] INFO  TransportConnector             - Connector vm://slave Stopped\n2009-06-25 21:09:39,109 [Thread-4       ] DEBUG TcpTransport                   - Stopping transport tcp://localhost/127.0.0.1:61616\n2009-06-25 21:09:39,109 [/127.0.0.1:3457] DEBUG TransportConnection            - Stopping connection: /127.0.0.1:3457\n\n2009-06-25 21:09:39,109 [/127.0.0.1:3457] DEBUG JoeBroker                  - stop: Entered <---- this is my Broker plugin's stop method getting called\n\n2009-06-25 21:09:39,109 [Thread-4       ] INFO  TransportConnector             - Connector tcp://localhost:61617 Stopped\n2009-06-25 21:09:39,125 [Thread-4       ] INFO  BrokerService                  - ActiveMQ JMS Message Broker (slave, ID:DIEGO-3454-1245978572796-1:0) stopped\norg.apache.activemq:BrokerName=master,Type=XXXXX, XXXX=ActiveMQ XXXXX\n2009-06-25 21:09:39,156 [/127.0.0.1:3457] DEBUG TcpTransport                   - Stopping transport tcp:///127.0.0.1:3457\n2009-06-25 21:09:39,156 [/127.0.0.1:3457] DEBUG TransportConnection            - Stopped transport: /127.0.0.1:3457\n2009-06-25 21:09:39,156 [/127.0.0.1:3457] DEBUG TransportConnection            - Connection Stopped: /127.0.0.1:3457\n2009-06-25 21:09:43,437 [MQ ShutdownHook] INFO  BrokerService                  - ActiveMQ Message Broker (master, ID:DIEGO-3450-1245978553937-0:0) is shutting down\n2009-06-25 21:09:43,437 [MQ ShutdownHook] DEBUG BrokerService                  - Caught exception, must be shutting down: java.lang.IllegalStateException: Shutdown in progress\n2009-06-25 21:09:45,359 [MQ ShutdownHook] INFO  TransportConnector             - Connector tcp://localhost:61616 Stopped\n\n2009-06-25 21:09:45,375 [MQ ShutdownHook] DEBUG JoeBroker                  - stop: Entered <---- This is my plugin's stop method getting called a second time\n2009-06-25 21:09:45,375 [MQ ShutdownHook] DEBUG JoeBroker                  - stop: JoeBroker has already been stopped\n\n2009-06-25 21:09:45,375 [MQ ShutdownHook] INFO  BrokerService                  - ActiveMQ JMS Message Broker (master, ID:DIEGO-3450-1245978553937-0:0) stopped\n\n\nThis is the slave's  cfg file\n\n<beans\n  xmlns=\"http://www.springframework.org/schema/beans\"\n  xmlns:amq=\"http://activemq.org/config/1.0\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n  http://activemq.org/config/1.0 http://activemq.apache.org/schema/activemq-core.xsd\n  http://activemq.apache.org/camel/schema/spring http://activemq.apache.org/camel/schema/spring/camel-spring.xsd\">\n\n  <!-- Allows us to use system properties as variables in this configuration file -->\n  <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"/>\n  \n  <broker xmlns=\"http://activemq.org/config/1.0\" brokerName=\"slave\" masterConnectorURI=\"tcp://localhost:61616\" deleteAllMessagesOnStartup=\"true\" persistent=\"false\">\n  \n    <!-- The transport connectors ActiveMQ will listen to -->\n    <transportConnectors>\n       <transportConnector uri=\"tcp://localhost:61617\" />\n    </transportConnectors>\n\n  </broker>\n\n</beans>\n\n\nThis is the master's cfg file \n\n<beans\n  xmlns=\"http://www.springframework.org/schema/beans\"\n  xmlns:amq=\"http://activemq.org/config/1.0\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n  http://activemq.org/config/1.0 http://activemq.apache.org/schema/activemq-core.xsd\n  http://activemq.apache.org/camel/schema/spring http://activemq.apache.org/camel/schema/spring/camel-spring.xsd\">\n\n  <!-- Allows us to use system properties as variables in this configuration file -->\n  <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"/>\n  \n  <broker xmlns=\"http://activemq.org/config/1.0\" brokerName=\"master\" persistent=\"false\" deleteAllMessagesOnStartup=\"true\" plugins=\"#joe\">\n  \n    <!-- The transport connectors ActiveMQ will listen to -->\n    <transportConnectors>\n       <transportConnector uri=\"tcp://localhost:61616\" />      \n    </transportConnectors>\n\n  </broker>\n  \n  <bean id=\"joe\" class=\"com.ttm.activemq.joe.JoePlugin\"/>\t\n\n</beans>\n\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"created":"2009-06-26T01:27:13.972+0000","updated":"2009-06-26T01:27:13.972+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482766/comment/12941646","id":"12941646","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Joe, it did not commit your patch as is, but changed the MasterBroker filter to not propagate the stop request and just remove it's self. I think this is the correct thing to do in this scenario as not stopping the MasterBroker filter will just ensure that it fails to sync with the slave. The test case shows that this fix stops a plugin getting a stop request.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-06-26T18:14:31.647+0000","updated":"2009-06-26T18:14:31.647+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2305/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14cvz:"}}