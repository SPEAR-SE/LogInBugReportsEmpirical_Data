{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12519109","self":"https://issues.apache.org/jira/rest/api/2/issue/12519109","key":"AMQ-3457","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-08-17T13:29:58.082+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jan 25 00:48:22 UTC 2012","customfield_12310420":"14534","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1129251_*|*_5_*:*_2_*:*_4247023096_*|*_4_*:*_1_*:*_241681","customfield_12312321":null,"resolutiondate":"2011-10-05T17:17:42.836+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3457/watchers","watchCount":3,"isWatching":false},"created":"2011-08-17T13:11:08.838+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316331","id":"12316331","description":"Next unplanned v5 maintenance release","name":"5.x","archived":false,"released":false}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-01-25T00:48:22.880+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"AMQ-2349 added some code to clean up temp destinations once close() is called on a pooled connection. This caused pretty much all the JMS request-reply tests to fail in Camel with \"javax.jms.InvalidDestinationException: Cannot publish to a deleted Destination\" :) \n\nThe problem is that with a pooled connection, multiple users can be using a Connection at the same time (a reference count is kept of how many there are) so if once calls close() the temp destinations of several others could be deleted while they are still using them. I think the correct behavior would be to only delete the temp destinations when all connection users call close() (i.e. when the reference count becomes zero).\n\nAttaching a proposed fix for this shortly for review.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12490646","id":"12490646","filename":"amqpool.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"created":"2011-08-17T13:11:39.688+0000","size":3360,"mimeType":"text/x-patch","content":"https://issues.apache.org/jira/secure/attachment/12490646/amqpool.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511150","id":"12511150","filename":"pooledConnCleanupOwnTemps.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T18:12:25.064+0000","size":7597,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12511150/pooledConnCleanupOwnTemps.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511271","id":"12511271","filename":"PooledSessionTempDestEventListener.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-20T16:34:49.355+0000","size":524,"mimeType":"text/java","content":"https://issues.apache.org/jira/secure/attachment/12511271/PooledSessionTempDestEventListener.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511147","id":"12511147","filename":"TestConnectionPoolLingeringTemps.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T17:49:50.366+0000","size":5980,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12511147/TestConnectionPoolLingeringTemps.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12511152","id":"12511152","filename":"TestConnectionPoolTempCleanup.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T18:22:21.692+0000","size":7795,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12511152/TestConnectionPoolTempCleanup.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"59358","customfield_12312823":null,"summary":"temp destinations should only be deleted once all users of a pooled connection call close","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"5.6-SNAPSHOT","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13086304","id":"13086304","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Patch applied, thanks for catching that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-08-17T13:29:58.082+0000","updated":"2011-08-17T13:29:58.082+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13086308","id":"13086308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"body":"Awesome. Thanks for the quick review!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"created":"2011-08-17T13:36:45.999+0000","updated":"2011-08-17T13:36:45.999+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13121162","id":"13121162","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"body":"Found another issue with this... so in the original bug multiple clients were using the same pooled connection and if one of those clients called close, it could potentially delete another client's temporary destination since they all shared the same connection. The fix was to wait until all clients had called close before deleting the temp destination.\n\nNow, in the case where there is a large pool of connections available, every client gets their own connection so the previous issue isn't a problem anymore. However, the AdvisoryConsumer holds on to a copy of all temp destinations and also adds each of these temp destinations to the connection it uses. So now, 2 connections have a reference to the same temp destination... which is a problem. If this connection is also used by a client and the client calls close, then the temp destinations will be deleted even though they are still used by another connection. \n\nWill commit a fix shortly for this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"created":"2011-10-05T17:13:41.150+0000","updated":"2011-10-05T17:13:41.150+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13125307","id":"13125307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joed","name":"joed","key":"joed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Edstrom Johan","active":true,"timeZone":"America/Denver"},"body":"To confirm the last comment, yup. You'll delete other clients destinations and in an active system this cleanup really will not hit...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joed","name":"joed","key":"joed","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Edstrom Johan","active":true,"timeZone":"America/Denver"},"created":"2011-10-11T19:17:35.484+0000","updated":"2011-10-11T19:17:35.484+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13125710","id":"13125710","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Jon's fix was committed, see: http://svn.apache.org/viewvc?view=rev&rev=1179328","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-10-12T10:50:48.195+0000","updated":"2011-10-12T10:50:48.195+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13188941","id":"13188941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Is this a complete fix, or will it lead to temporary destinations that linger on a heavily reused connection?\n\nDoesn't the PooledConnection need to keep track of the temporary destinations created by its sessions and specifically delete those on close()?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T05:54:04.941+0000","updated":"2012-01-19T05:54:04.941+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189117","id":"13189117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"body":"Possibly. Though I'm just going on memory here - haven't looked at the latest code :) Are you seeing this behavior in your application?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janstey","name":"janstey","key":"janstey","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=janstey&avatarId=15911","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=janstey&avatarId=15911","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=janstey&avatarId=15911","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=janstey&avatarId=15911"},"displayName":"Jonathan Anstey","active":true,"timeZone":"America/New_York"},"created":"2012-01-19T14:04:50.066+0000","updated":"2012-01-19T14:04:50.066+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189122","id":"13189122","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"ActiveMQConnection keeps track of the temp destinations, and the patch causes the PooledConnection to ask the connection to deletes the temp destinations it created once the PooledConnection is closed, so no need to deplicate that logic in the PooledConnection.\n\nIf you are still seeing an issue then a JUnit test case to demonstrate the problem would be appropriate.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-01-19T14:10:11.211+0000","updated":"2012-01-19T14:10:11.211+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189171","id":"13189171","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Below is my understanding.  I'll work on a JUnit case, and send a proposal that I believe fixes the issue, a little later today.\n\n* The PooledConnection no longer cleans up the temp destinations itself\n* ConnectionPool removes the temp destinations after all references to the ConnectionPool are dropped (meaning that the underlying ActiveMQConnection is also no longer used)\n* PooledConnection gets its ConnectionPool from the PooledConnectionFactory when instantiated.\n\n* PooledConnectionFactory keeps a cache of ConnectionPool objects in a hash-map keyed on the user-name + passsword.\n** On createConnection(), if the ConnectionPool (with the matching username + password) is already in the cache, it is passed to the newly created PooledConnection.\n** If it's not already in the cache, a new one is added to the cache and used for the newly created PooledConnection.\n\nHere are the changes to ConnectionPool and PooledConnection for this bug that I believe back this up.\n\n{code}\nIndex: trunk/activemq-pool/src/main/java/org/apache/activemq/pool/ConnectionPool.java\n===================================================================\ndiff -u -N -r1071256 -r1158694\n--- trunk/activemq-pool/src/main/java/org/apache/activemq/pool/ConnectionPool.java\t(.../ConnectionPool.java)\t(revision 1071256)\n+++ trunk/activemq-pool/src/main/java/org/apache/activemq/pool/ConnectionPool.java\t(.../ConnectionPool.java)\t(revision 1158694)\n@@ -144,6 +144,12 @@\n         lastUsed = System.currentTimeMillis();\n         if (referenceCount == 0) {\n             expiredCheck();\n+            \n+            // only clean up temp destinations when all users \n+            // of this connection have called close\n+            if (getConnection() != null) {\n+                getConnection().cleanUpTempDestinations();\n+            }\n         }\n     }\n \nIndex: trunk/activemq-pool/src/main/java/org/apache/activemq/pool/PooledConnection.java\n===================================================================\ndiff -u -N -r1142267 -r1158694\n--- trunk/activemq-pool/src/main/java/org/apache/activemq/pool/PooledConnection.java\t(.../PooledConnection.java)\t(revision 1142267)\n+++ trunk/activemq-pool/src/main/java/org/apache/activemq/pool/PooledConnection.java\t(.../PooledConnection.java)\t(revision 1158694)\n@@ -16,9 +16,6 @@\n  */\n package org.apache.activemq.pool;\n \n-import java.util.Iterator;\n-import java.util.concurrent.ConcurrentHashMap;\n-\n import javax.jms.Connection;\n import javax.jms.ConnectionConsumer;\n import javax.jms.ConnectionMetaData;\n@@ -39,7 +36,6 @@\n import org.apache.activemq.AlreadyClosedException;\n import org.apache.activemq.EnhancedConnection;\n import org.apache.activemq.advisory.DestinationSource;\n-import org.apache.activemq.command.ActiveMQTempDestination;\n \n /**\n  * Represents a proxy {@link Connection} which is-a {@link TopicConnection} and\n@@ -73,9 +69,6 @@\n     public void close() throws JMSException {\n         if (this.pool != null) {\n             this.pool.decrementReferenceCount();\n-            if (this.pool.getConnection() != null) {\n-                this.pool.getConnection().cleanUpTempDestinations();\n-            }\n             this.pool = null;\n         }\n     }\n{code}\n\nBy the way, for a JUnit test - do you have any recommendation on testing whether a temporary destination has been deleted?  My plan is to produce to it from another connection and expect an exception.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T16:13:25.717+0000","updated":"2012-01-19T16:13:25.717+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189183","id":"13189183","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Proposal for correcting the potential for lingering temporary destinations.\n\nThis has not yet been tested; I'm posting it now to demonstrate my thinking.  Unit test is being written now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T16:35:27.753+0000","updated":"2012-01-19T16:35:27.753+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189226","id":"13189226","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Producing to the temporary destination to test for its existence is not working.  Any tips on how I can check if the temporary destination is deleted?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T17:38:02.417+0000","updated":"2012-01-19T17:38:02.417+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189233","id":"13189233","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"JUnit test case which shows the temporary destinations of closed PooledConnection objects linger.\n\nUses the destinationExists() method from the advisory/TempDestDeleteTest.java source - thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T17:49:50.510+0000","updated":"2012-01-19T17:49:50.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189248","id":"13189248","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Corrected patch - the original missed the all-important change to the PooledConnection.close() method itself.\n\nThis was tested with the JUnit case provided and is working.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T18:08:01.665+0000","updated":"2012-01-19T18:08:01.665+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189252","id":"13189252","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Third try - better remove the temp dests before decrementing the count on the connection pool in case that causes the underlying ActiveMQConnection to close.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T18:12:25.129+0000","updated":"2012-01-19T18:12:25.129+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189258","id":"13189258","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"More thorough JUnit - supercedes the TestConnectionPoolLingeringTemps.\n\nCorrects the assertion comments and adds a test that closing one PooledConnection does not delete the temporary destinations of a second one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-19T18:22:21.752+0000","updated":"2012-01-19T18:22:21.752+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13189878","id":"13189878","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"New source file that's missing from the patch and is needed for the solution.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-20T16:34:49.514+0000","updated":"2012-01-20T16:34:49.514+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13192684","id":"13192684","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Is there more I can do to facilitate this?  I know I updated several times; I apologize for not providing cleaner packaging.\n\nShould I reopen this ticket, or open a new one?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-25T00:20:24.013+0000","updated":"2012-01-25T00:20:24.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13192700","id":"13192700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"You are welcome to reopen or create a new issue with your additional work.  When someone has time to review the issue they will be able to determine the correct course of action.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-01-25T00:29:55.737+0000","updated":"2012-01-25T00:29:55.737+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12519109/comment/13192728","id":"13192728","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Created AMQ-3680 to follow up.  It turns out I can't re-open this ticket.\n\nThanks!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2012-01-25T00:48:22.853+0000","updated":"2012-01-25T00:48:22.853+0000"}],"maxResults":19,"total":19,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3457/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0aj1j:"}}