{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12522272","self":"https://issues.apache.org/jira/rest/api/2/issue/12522272","key":"AMQ-3489","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2012-08-21T10:39:19.946+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 29 21:27:24 UTC 2012","customfield_12310420":"61903","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_38727049528_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-11-29T21:27:24.046+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3489/watchers","watchCount":3,"isWatching":false},"created":"2011-09-08T15:56:34.556+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315625","id":"12315625","description":"","name":"5.4.2","archived":false,"released":true,"releaseDate":"2010-12-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-11-29T21:27:24.082+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I'm seeing some strange behavior with ActiveMQ 5.4.2 pure master slave setup...\n\n5.4.2 master running on mqmaster01:\n\n <broker xmlns=\"http://activemq.apache.org/schema/core\" brokerName=\"localhost\" dataDirectory=\"${activemq.base}/data\" destroyApplicationContextOnStop=\"true\" schedulerSupport=\"false\" advisorySupport=\"false\">\n...\n        <transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://0.0.0.0:61616\"/>\n        </transportConnectors>\n\n5.4.2 slave running on mqslave01:\n\n    <broker masterConnectorURI=\"tcp://mqmaster01:61616\" shutdownOnMasterFailure=\n\"false\" xmlns=\"http://activemq.apache.org/schema/core\" brokerName=\"localhost\" da\ntaDirectory=\"${activemq.base}/data\" destroyApplicationContextOnStop=\"true\" sched\nulerSupport=\"false\" advisorySupport=\"false\">\n...\n        <transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://0.0.0.0:61616\"/>\n        </transportConnectors>\n\nProducers and consumers are using this connection URL:\n\nfailover:(tcp://mqmaster01:61616,tcp://mqslave01:61616)?randomize=false\n\nHere's what I'm seeing.  I start up the master.  My producers/consumers connect immediately (they were waiting to connect) and begin doing their thing.\n\nI then start up the slave (with a freshly emptied ./data dir).  The slave connects to the master, as witnessed by this in data/activemq.log on mqslave01:\n\n2011-08-24 22:51:48,833 | INFO  | Starting a slave connection between vm://localhost#0 and tcp://mqmaster01:61616 | org.apache.activemq.broker.ft.MasterConnector | main\n2011-08-24 22:51:48,843 | INFO  | Slave connection between vm://localhost#0 and tcp://mqmaster01/10.0.3.42:61616 has been established. | org.apache.activemq.broker.ft.MasterConnector | main\n\nShortly thereafter, a message is sent to a queue.  A consumer consumes it.  On mqmaster01, I can see on http://mqmaster01:8161/admin/queues.jsp that the enqueue/dequeue count went up by one, and \"Number Of Pending Messages\" is zero.  All good, right?\n\nYeah, except mqslave01 now shows Messages Enqueued = 1, and Number Of Pending Messages = 1.  As more messages run through the system, mqslave01's enqueue & pending count continues to go up, but the dequeue count remains at zero.  I don't understand why the slave isn't replicating the consumption of these messages...\n\nHas anybody seen this before?  Any idea what might be causing it?  Did I screw something up in my configuration, i.e. with schedulerSupport=\"false\" or advisorySupport=\"false\"?\n\nAny help would be much appreciated... \n\n\n------------------------------------------\n\n\n\nTorsten then posted:\n\nHi,\n\nI just gave it a quick test here using the latest 5.5 release and there does indeed seem to be an issue.\nWas sending and consuming msgs on the master broker using a new queue and the JMX properties got updated correctly on both master and slave.\n \nHowever when sending some msgs to queue example.A which also has a Camel consumer connected, I noticed the same problem as reported here. On the slave the Enqueue Count rises correctly but dequeue and dispatch count remain 0. QueueSize is at EnqueueCount number, despite all msgs being consumed already.\n\nI further noticed the following error in the slave log:\n\nWARN | Async error occurred: java.lang.IllegalStateException: Cannot lookup a connection that had not been registered: ID:mac.fritz.box-53812-1315495654277-4:1\njava.lang.IllegalStateException: Cannot lookup a connection that had not been registered: ID:mac.fritz.box-53812-1315495654277-4:1\n        at org.apache.activemq.broker.MapTransportConnectionStateRegister.lookupConnectionState(MapTransportConnectionStateRegister.java:97)\n        at org.apache.activemq.broker.TransportConnection.lookupConnectionState(TransportConnection.java:1444)\n        at org.apache.activemq.broker.TransportConnection.processRemoveProducer(TransportConnection.java:530)\n        at org.apache.activemq.command.RemoveInfo.visit(RemoveInfo.java:78)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:316)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:180)\n        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69)\n        at org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:218)\n        at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n        at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)\n\n\n\nThere seems to be a problem here.\n\nDan, if you have the time, could you raise a new JIRA for this problem?\n\nThanks,\n\nTorsten Mielke ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"81465","customfield_12312823":null,"summary":"Slave not replicating consumption with Pure Master Slave","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dcheckoway","name":"dcheckoway","key":"dcheckoway","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Checkoway","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dcheckoway","name":"dcheckoway","key":"dcheckoway","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Checkoway","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12522272/comment/13438592","id":"13438592","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vkviatkouski","name":"vkviatkouski","key":"vkviatkouski","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vitali Kviatkouski","active":true,"timeZone":"Etc/UTC"},"body":"Reproduced on ActiveMQ 5.6.0\n Seems this happens because it is expected that there is consumer connection on slave. And when we follow this flow:\n 1. Start master\n 2. Start slave\n 3. Start consumers (consuming app)\n everything works fine as consumer connections are replicated to slave only when they are created.\n But when we restart slave, consumer connections on master are untouched, so they are not replicated to slave.\n My proposal is to replicate active consumer connections on slave when slave connects to master.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vkviatkouski","name":"vkviatkouski","key":"vkviatkouski","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vitali Kviatkouski","active":true,"timeZone":"Etc/UTC"},"created":"2012-08-21T10:39:19.946+0000","updated":"2012-08-21T10:39:19.946+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12522272/comment/13506827","id":"13506827","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Pure master/slave removed in upcoming v5.8.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-11-29T21:27:24.060+0000","updated":"2012-11-29T21:27:24.060+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3489/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0eaif:"}}