{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482433","self":"https://issues.apache.org/jira/rest/api/2/issue/12482433","key":"AMQ-1795","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"parent":{"id":"12482554","key":"AMQ-1786","self":"https://issues.apache.org/jira/rest/api/2/issue/12482554","fields":{"summary":"Journal files don't get cleaned up","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-06-12T14:36:22.621+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jun 18 19:35:08 UTC 2008","customfield_12310420":"84767","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1451352_*|*_6_*:*_1_*:*_0_*|*_5_*:*_2_*:*_5147586_*|*_4_*:*_1_*:*_2417277110","customfield_12312321":null,"resolutiondate":"2008-07-10T15:29:54.457+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1795/watchers","watchCount":0,"isWatching":false},"created":"2008-06-12T14:12:11.296+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-07-11T16:22:54.487+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Under load, I see the error below.\n\nthe problem is that org.apache.activemq.store.amq.AMQPersistenceAdapter.cleanup() does not capture all of the in use files.\nI have made some changes that improves the situation but there is still a window, that seems to be related to spooling messages when a memory limit is reached.\n\n\n2008-06-12 14:55:16,689 [main           ] INFO  BrokerService                  - Using Persistence Adapter: AMQPersistenceAdapter(activemq-data\\localhost)\n2008-06-12 14:55:16,704 [main           ] INFO  AMQPersistenceAdapter          - AMQStore starting using directory: activemq-data\\localhost\n2008-06-12 14:55:17,361 [main           ] INFO  AMQPersistenceAdapter          - Journal deleted: \n2008-06-12 14:55:17,361 [main           ] INFO  KahaStore                      - Kaha Store successfully deleted data directory activemq-data\\localhost\\kr-store\\data\n2008-06-12 14:55:17,392 [main           ] INFO  KahaStore                      - Kaha Store successfully deleted data directory activemq-data\\localhost\\kr-store\\state\n2008-06-12 14:55:17,392 [main           ] INFO  KahaStore                      - Kaha Store using data directory activemq-data\\localhost\\kr-store\\state\n2008-06-12 14:55:17,470 [main           ] INFO  AMQPersistenceAdapter          - Active data files: []\n2008-06-12 14:55:17,705 [main           ] INFO  BrokerService                  - ActiveMQ null JMS Message Broker (localhost) is starting\n2008-06-12 14:55:17,705 [main           ] INFO  BrokerService                  - For help or more information please see: http://activemq.apache.org/\n2008-06-12 14:55:17,814 [JMX connector  ] INFO  ManagementContext              - JMX consoles can connect to service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi\n2008-06-12 14:55:17,924 [main           ] INFO  KahaStore                      - Kaha Store using data directory activemq-data\\localhost\\kr-store\\data\n2008-06-12 14:55:17,939 [main           ] INFO  TransportServerThreadSupport   - Listening for connections at: tcp://salthill:61616\n2008-06-12 14:55:17,939 [main           ] INFO  TransportConnector             - Connector Default Started\n2008-06-12 14:55:17,939 [main           ] INFO  BrokerService                  - ActiveMQ JMS Message Broker (localhost, ID:salthill-2790-1213278917752-0:0) started\n2008-06-12 14:55:17,939 [main           ] INFO  MissingDataFileTest            - Starting broker..\n2008-06-12 14:55:58,516 [age Thread Pool] ERROR AsyncDataManager               - Looking for key 551 but not found in fileMap: {1014=data-1014 number = 1014 , length = 1960 refCount = 6, 607=data-607 number = 607 , length = 1266 refCount = 1, 928=data-928 number = 928 , .. .. 622 , length = 1352 refCount = 2, 328=data-328 number = 328 , length = 1266 refCount = 1, 256=data-256 number = 256 , length = 1264 refCount = 1, 92=data-92 number = 92 , length = 1264 refCount = 1, 404=data-404 number = 404 , length = 1266 refCount = 1}\n2008-06-12 14:55:58,563 [age Thread Pool] ERROR AbstractStoreCursor            - Failed to fill batch\njava.io.IOException: Failed to read to journal for: offset = 0, file = 551, size = -1, type = 0. Reason: java.io.IOException: Could not locate data file data--551\n\tat org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:33)\n\tat org.apache.activemq.store.amq.AMQPersistenceAdapter.createReadException(AMQPersistenceAdapter.java:635)\n\tat org.apache.activemq.store.amq.AMQPersistenceAdapter.readCommand(AMQPersistenceAdapter.java:521)\n\tat org.apache.activemq.store.amq.AMQMessageStore.getMessage(AMQMessageStore.java:432)\n\tat org.apache.activemq.store.amq.RecoveryListenerAdapter.recoverMessageReference(RecoveryListenerAdapter.java:54)\n\tat org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverReference(KahaReferenceStore.java:82)\n\tat org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverNextMessages(KahaReferenceStore.java:120)\n\tat org.apache.activemq.store.amq.AMQMessageStore.recoverNextMessages(AMQMessageStore.java:530)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:75)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:188)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.onUsageChanged(AbstractStoreCursor.java:157)\n\tat org.apache.activemq.usage.Usage$1.run(Usage.java:266)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)\n\tat java.lang.Thread.run(Thread.java:595)\nCaused by: java.io.IOException: Could not locate data file data--551\n\tat org.apache.activemq.kaha.impl.async.AsyncDataManager.getDataFile(AsyncDataManager.java:303)\n\tat org.apache.activemq.kaha.impl.async.AsyncDataManager.read(AsyncDataManager.java:613)\n\tat org.apache.activemq.store.amq.AMQPersistenceAdapter.readCommand(AMQPersistenceAdapter.java:518)\n\t... 12 more\n2008-06-12 14:55:58,563 [age Thread Pool] ERROR AbstractStoreCursor            - Failed to fill batch \njava.lang.RuntimeException: java.io.IOException: Failed to read to journal for: offset = 0, file = 551, size = -1, type = 0. Reason: java.io.IOException: Could not locate data file data--551\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:191)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.onUsageChanged(AbstractStoreCursor.java:157)\n\tat org.apache.activemq.usage.Usage$1.run(Usage.java:266)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)\n\tat java.lang.Thread.run(Thread.java:595)\nCaused by: java.io.IOException: Failed to read to journal for: offset = 0, file = 551, size = -1, type = 0. Reason: java.io.IOException: Could not locate data file data--551\n\tat org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:33)\n\tat org.apache.activemq.store.amq.AMQPersistenceAdapter.createReadException(AMQPersistenceAdapter.java:635)\n\tat org.apache.activemq.store.amq.AMQPersistenceAdapter.readCommand(AMQPersistenceAdapter.java:521)\n\tat org.apache.activemq.store.amq.AMQMessageStore.getMessage(AMQMessageStore.java:432)\n\tat org.apache.activemq.store.amq.RecoveryListenerAdapter.recoverMessageReference(RecoveryListenerAdapter.java:54)\n\tat org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverReference(KahaReferenceStore.java:82)\n\tat org.apache.activemq.store.kahadaptor.KahaReferenceStore.recoverNextMessages(KahaReferenceStore.java:120)\n\tat org.apache.activemq.store.amq.AMQMessageStore.recoverNextMessages(AMQMessageStore.java:530)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:75)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:188)\n\t... 5 more\nCaused by: java.io.IOException: Could not locate data file data--551\n\tat org.apache.activemq.kaha.impl.async.AsyncDataManager.getDataFile(AsyncDataManager.java:303)\n\tat org.apache.activemq.kaha.impl.async.AsyncDataManager.read(AsyncDataManager.java:613)\n\tat org.apache.activemq.store.amq.AMQPersistenceAdapter.readCommand(AMQPersistenceAdapter.java:518)\n\t... 12 more\n2008-06-12 15:00:18,531 [main           ] INFO  BrokerService                  - ActiveMQ Message Broker (localhost, ID:salthill-2790-1213278917752-0:0) is shutting down\n2008-06-12 15:00:20,438 [main           ] INFO  TransportConnector             - Connector Default Stopped\n2008-06-12 15:00:20,641 [main           ] INFO  BrokerService                  - ActiveMQ JMS Message Broker (localhost, ID:salthill-2790-1213278917752-0:0) stopped\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461145","id":"12461145","filename":"AMQ-1795.further_improvement","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-17T10:59:42.055+0000","size":1760,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12461145/AMQ-1795.further_improvement"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461163","id":"12461163","filename":"AMQ-1795.test_and_partial_fix","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-12T14:18:13.061+0000","size":24428,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12461163/AMQ-1795.test_and_partial_fix"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172012","customfield_12312823":null,"summary":"in use data files removed from data store under load","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"all","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482433/comment/12939793","id":"12939793","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"MissingDataFileTest shows the problem.\n\nThere is a fix to cleanup to reference the inuse transaction files using checkpoint.\nalso checkpoint is fixed up to return the minimum file in use.\n\nof note also is AsyncDataManager removal of files that are not inUse. This capability seems to be bsolete but yet I see it remove a file on occasion.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-12T14:18:13.633+0000","updated":"2008-06-12T14:18:13.633+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482433/comment/12939830","id":"12939830","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"note, I had to reduce the store maxFileSize and the cleanup interval to make the test reproduceable. This meant exposing the cleanupInterfal to the persistenceAdapterFactory.\n\n        AMQPersistenceAdapterFactory factory = (AMQPersistenceAdapterFactory) broker.getPersistenceFactory();\n        factory.setMaxFileLength(2*1024); // ~4 messages\n        factory.setCleanupInterval(5000); // every few second","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-12T14:23:37.335+0000","updated":"2008-06-12T14:23:37.335+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482433/comment/12939798","id":"12939798","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Resolved by revision 667105","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-12T14:36:22.621+0000","updated":"2008-06-12T14:36:22.621+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482433/comment/12939778","id":"12939778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"remove some unnecessary info from the description","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-12T14:51:44.292+0000","updated":"2008-06-12T14:51:44.292+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482433/comment/12939799","id":"12939799","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"still needs work","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-12T16:01:57.321+0000","updated":"2008-06-12T16:01:57.321+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482433/comment/12939836","id":"12939836","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Still having problems with this:\n\nI find that the following change helps but is not bulit proof. I think it makes sense to use the mark as the boundary point for deletion but on a slower machine the MissingDataFileTest still shows the error stack trace. A multi core machine does not show the problem.\nAlso, the test case only complets when the memory usage limit is omitted or increased to 1024*1024 which may indicate a limitation of the test case. Decreasing the memory usage caused the problem to show up earlier, which does not now seem to be the case. So there is some progress.\n\nThe short of it is that collection of inUse file Ids is not sufficiently stable for the cleanup method. I still do not know where the problem lies though. I need another set of eyes.\n\nIndex: src/main/java/org/apache/activemq/store/amq/AMQPersistenceAdapter.java\n===================================================================\n--- src/main/java/org/apache/activemq/store/amq/AMQPersistenceAdapter.java      (revision 668601)\n+++ src/main/java/org/apache/activemq/store/amq/AMQPersistenceAdapter.java      (working copy)\n@@ -425,6 +425,7 @@\n             }\n             Integer lastDataFile = asyncDataManager.getCurrentDataFileId();\n             inProgress.add(lastDataFile);\n+            lastDataFile = asyncDataManager.getMark().getDataFileId();\n             inProgress.addAll(referenceStoreAdapter.getReferenceFileIdsInUse());\n             Location lastActiveTx = transactionStore.checkpoint();\n             if (lastActiveTx != null) {\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-17T10:42:10.280+0000","updated":"2008-06-17T10:42:10.280+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482433/comment/12939824","id":"12939824","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"changes that work well on a fast machine to alleviate the stack trace. I still see the error on a slower machine however. test works to completion with the changed memory limit.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-17T10:59:42.096+0000","updated":"2008-06-17T10:59:42.096+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482433/comment/12939841","id":"12939841","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Further patch applied by SVN revision 669265","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-18T19:35:08.079+0000","updated":"2008-06-18T19:35:08.079+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1795/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tt13:"}}