{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483566","self":"https://issues.apache.org/jira/rest/api/2/issue/12483566","key":"AMQ-2520","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316331","id":"12316331","description":"Next unplanned v5 maintenance release","name":"5.x","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2010-02-10T11:00:14.481+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Oct 11 21:22:48 UTC 2017","customfield_12310420":"44170","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_123640493668_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-11-02T21:15:37.312+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2520/watchers","watchCount":1,"isWatching":false},"created":"2009-12-02T20:40:43.664+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-10-11T21:38:32.731+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Two active MQ brokers are installed on RH EL 5 servers (one per server). \nThey're configured as a JDBC master / slave failover (as per examples). Failover is tested and working and messages delivered.\nOracle is used for synchronisation (ACTIVEMQ_ tables), persistence etc.\nWe run a durable subscriber, and the client connects via a failover operation.\n\nThe SELECT * FROM ACTIVEMQ_LOCK FOR UPDATE is causing spin lock on the Oracle database.\nBasically the indefinite waiting from the passive mq instance is causing high resource usage on Oracle.\n\nAfter a short period Oracle dashboard shows a high number of active sessions from Active MQ due to the continuous execution of\n    UPDATE ACTIVEMQ_LOCK SET TIME = ? WHERE ID = 1\nin the keepAlive method in \n    https://svn.apache.org/repos/asf/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/store/jdbc/DatabaseLocker.java\n\nAs a workaround we've had to push out the lockAcquireSleepInterval to 5 minutes in the configuration of ActiveMQ, but this didn't work. \n\n<jdbcPersistenceAdapter dataSource=\"#oracle-ds\" useDatabaseLock=\"true\" lockAcquireSleepInterval=\"300000\" createTablesOnStartup=\"true\"/>\n\nWe're currently changing the broker to poll rather than block so in Statement.java we've added a WAIT 0 that throws an exception if the lock is not acquired.\n\n    public String getLockCreateStatement() {\n        if (lockCreateStatement == null) {\n            lockCreateStatement = \"SELECT * FROM \" + getFullLockTableName();\n            if (useLockCreateWhereClause) {\n                lockCreateStatement += \" WHERE ID = 1\";\n            }\n            lockCreateStatement += \" FOR UPDATE WAIT 0\";\n        }\n        return lockCreateStatement;\n    }\n\n\nAny suggestions to this issue, this seems to be a quite fundamental issue?\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59764","customfield_12312823":null,"summary":"Oracle 10g RAC resource usage VERY high from the passive servers SQL requests to the Database.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomas_connolly","name":"thomas_connolly","key":"thomas_connolly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Connolly","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomas_connolly","name":"thomas_connolly","key":"thomas_connolly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Connolly","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Redhat Enterprise Linux 5, Oracle 10g RAC","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483566/comment/12942193","id":"12942193","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"So does the poll work for you by having the lock statement return immediately and hence make the lockAcquireSleepInterval relevant again. \nWe can provide a specialization of the lock implementation for Oracle if this is the case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-02-10T11:00:14.481+0000","updated":"2010-02-10T11:00:14.481+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483566/comment/12942166","id":"12942166","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomas_connolly","name":"thomas_connolly","key":"thomas_connolly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Connolly","active":true,"timeZone":"Etc/UTC"},"body":"In the class org.apache.activemq.store.jdbc.Statement I changed the code to add the WAIT 0 (as per the report).\n\nI then set the lockAcquireSleepInterval back to one second (i.e. the default DEFAULT_LOCK_ACQUIRE_SLEEP_INTERVAL setting).\n\nA specialisation of the DefaultDatabaseLocker class where the call to getLockCreateStatement method (allow this to be overridden in the DatabaseLocker interface?) calls the Oracle specific WAIT 0 should do it. This is how I got around the problem.\n\n    public void start() throws Exception {\n        stopping = false;\n\n        LOG.info(\"Attempting to acquire the exclusive lock to become the Master broker\");\n        String sql = statements.getLockCreateStatement(); // For Oracle use the WAIT 0 statement\n        LOG.debug(\"Locking Query is \"+sql);","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thomas_connolly","name":"thomas_connolly","key":"thomas_connolly","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Connolly","active":true,"timeZone":"Etc/UTC"},"created":"2010-02-11T08:58:43.864+0000","updated":"2010-02-11T08:58:43.864+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483566/comment/12942557","id":"12942557","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"you should be able to override the lockCreateStatement and any other via config:\n{code}\n<jdbcPersistenceAdapter dataSource=\"#oracle-ds\" useDatabaseLock=\"true\" lockAcquireSleepInterval=\"300000\" createTablesOnStartup=\"true\">\n    <statements>\n          <statements lockCreateStatement=\"SELECT * FROM ACTIVEMQ_LOCK WHERE ID = 1 FOR UPDATE WAIT 0\"/>\n    </statements>\n</jdbcPersistenceAdapter>\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-04-28T18:45:47.665+0000","updated":"2010-04-28T18:45:47.665+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483566/comment/15172717","id":"15172717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"body":"Hmm. Why on earth isn't this the default behavior of the default DB locker? You naturally do NOT want to sit around holding active transactions that are trying to acquire a DB resource that you know you'll never get unless the master broker fails. That's being a really bad citizen in the DB world. The FOR UPDATE NOWAIT clause is the right thing to use, period.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"created":"2016-02-29T22:11:49.898+0000","updated":"2016-02-29T22:11:49.898+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483566/comment/16200986","id":"16200986","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"body":"Also note that if you use the FOR UPDATE NOWAIT or FOR UPDATE WAIT N forms of the locking query (as should be the default!!!), you will get an exception from the attempt to lock. Currently these are being logged at \"info\" or \"warn\" level depending on the locker implementation you use, so they will flood your logs with something that should be perfectly ignored, as this exception is the expected state 99.99% of the time (it should at most be logged at debug level). So there's definitely a need for code change here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"created":"2017-10-11T21:22:48.129+0000","updated":"2017-10-11T21:38:32.720+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2520/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0aljr:"}}