{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483514","self":"https://issues.apache.org/jira/rest/api/2/issue/12483514","key":"AMQ-2556","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-03-31T12:42:50.497+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 09 12:27:35 UTC 2010","customfield_12310420":"14817","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_7550752063_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-04-01T23:27:19.704+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2556/watchers","watchCount":1,"isWatching":false},"created":"2010-01-04T14:01:27.641+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-09-09T12:27:35.482+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313896","id":"12313896","name":"JMS client"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Some transaction related information are not released in case of read-only transactions (where not messages have been consumed or produced) by broker and client, that causes an OutOfMemory after running some time.\n\nFields that hold these \"transaction related information\" are (at least) :\n- {{org.apache.activemq.state.ConnectionState.transactions}}\n- {{org.apache.activemq.TransactionContext.ENDED_XA_TRANSACTION_CONTEXTS}}\n\nAfter serach, it seems that the case of read-only XA transactions (that terminates at prepare time) has been missed in some code like :\n- {{org.apache.activemq.broker.TransportConnection}} that puts TransactionState in {{org.apache.activemq.state.ConnectionState.transactions}} at the beginning, release them at commit (or rollback) time *but not at prepare time where result is {{XAResource.XA_RDONLY}}*\n- {{org.apache.activemq.TransactionContext}} that do the same mistake via ENDED_XA_TRANSACTION_CONTEXTS in prepare()\n\n_Note that the case of read-only transactions seems correctly done by {{org.apache.activemq.transaction.XATransaction}} (very interesting comment here http://fisheye6.atlassian.com/browse/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/transaction/XATransaction.java?r=809940#l175)_\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461579","id":"12461579","filename":"XAConsumer.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daniel.santos","name":"daniel.santos","key":"daniel.santos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Santos","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-04T14:20:14.527+0000","size":3414,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461579/XAConsumer.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"63762","customfield_12312823":null,"summary":"Memory leaks with XA Transactions (case of read-only transactions)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daniel.santos","name":"daniel.santos","key":"daniel.santos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Santos","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daniel.santos","name":"daniel.santos","key":"daniel.santos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Santos","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"ActiveMQ 5.3.0\nAtomikos Transactions Essentials 3.5.8\nSpring 2.5.6\nOracle 11g (thin driver version 11.1.0.7.0)\n","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483514/comment/12941963","id":"12941963","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daniel.santos","name":"daniel.santos","key":"daniel.santos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Santos","active":true,"timeZone":"Etc/UTC"},"body":"TO REPRODUCE :\n1- Launch a broker\n2- Launch this ready to use app (consumer in a XA transaction, implemented as a Spring's MessageListenner. The config is taken from atomikos http://www.atomikos.com/Documentation/SpringIntegration)\n\nNo producer nor another XAResource is needed to show the problem\n\nSimply use a debugger, (j)visualvm, jmap/jhat or another memory profiler tool to see grow up indefinitly (at each receiveTimeout unit of time : 3s) the number of TransactionContext instances on client and TransactionState instances on broker","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=daniel.santos","name":"daniel.santos","key":"daniel.santos","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Santos","active":true,"timeZone":"Etc/UTC"},"created":"2010-01-04T14:20:14.595+0000","updated":"2010-01-04T14:20:14.595+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483514/comment/12942076","id":"12942076","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tkrah","name":"tkrah","key":"tkrah","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Krah","active":true,"timeZone":"Europe/Berlin"},"body":"5.3.1 is still affected.\nUsing Spring 3.0.1, Atomikos 3.6.0 and Springs Message Listener i can see this too. \nThe ActiveMQXASession and ActiveMQTopicSubscriber Instances are growing also until OOM.\n\nLooking the ActiveMQMessageConsumer in calls to close this is done:\n\nnew Synchronization() {\n                    public void afterCommit() throws Exception {\n                        doClose();\n                    }\n\n                    public void afterRollback() throws Exception {\n                        doClose();\n                    }\n                });\n\nBut what about not being commited or rollbacked at all in case of XA_RDONLY - doClose will never be called - don't know if this does matter for this memory leak but it seems inconsistent that resource cleanup is only done fpr commit + rollback.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tkrah","name":"tkrah","key":"tkrah","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Torsten Krah","active":true,"timeZone":"Europe/Berlin"},"created":"2010-03-31T12:42:50.497+0000","updated":"2010-03-31T12:42:50.497+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483514/comment/12942073","id":"12942073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"thanks for the great test case, issue resolved on trunk in r930135\nstate on the client, broker and failover transport needed to be reclaimed on prepare readonly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-04-01T23:27:19.628+0000","updated":"2010-04-01T23:27:19.628+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483514/comment/12942673","id":"12942673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mcarpella","name":"mcarpella","key":"mcarpella","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Carpella","active":true,"timeZone":"Etc/UTC"},"body":"Is the fix-version 5.4.0 correct, i.e. fix is not included in 5.3.2?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mcarpella","name":"mcarpella","key":"mcarpella","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Martin Carpella","active":true,"timeZone":"Etc/UTC"},"created":"2010-05-19T09:26:51.119+0000","updated":"2010-05-19T09:26:51.119+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483514/comment/12942672","id":"12942672","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"afraid so, 5.4 will be out by the end of the summer. It was rolled into a [fuse release|http://repo.fusesource.com/maven2/org/apache/activemq/apache-activemq/5.3.1-fuse-01-00/] so u can get it there in the mean time, if a 5.4-SNAPSHOT does not work for you. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-05-19T10:09:11.853+0000","updated":"2010-05-19T10:09:11.853+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483514/comment/12942737","id":"12942737","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mlayer","name":"mlayer","key":"mlayer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marc Layer","active":true,"timeZone":"Etc/UTC"},"body":"Even with the fix (r930135), is it not still possible that {{TransactionContexts}} remain indefinitely in {{TransactionContext.ENDED_XA_TRANSACTION_CONTEXTS}}? {{syncSendPacketWithInterruptionHandling}} could throw a {{JMSException}} before the context is removed from the Map, if I am not mistaken.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mlayer","name":"mlayer","key":"mlayer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marc Layer","active":true,"timeZone":"Etc/UTC"},"created":"2010-05-27T13:23:48.538+0000","updated":"2010-05-27T13:23:48.538+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483514/comment/12942888","id":"12942888","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"marc, think r995397 will resolve the possibility of dangling refs in ENDED_XA_TRANSACTION_CONTEXTS if prepare fails with an exception and rollback is not subsequently called, as it need not be.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-09T12:27:35.417+0000","updated":"2010-09-09T12:27:35.417+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2556/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ba6n:"}}