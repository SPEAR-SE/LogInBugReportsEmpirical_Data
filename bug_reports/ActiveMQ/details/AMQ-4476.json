{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12643540","self":"https://issues.apache.org/jira/rest/api/2/issue/12643540","key":"AMQ-4476","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2013-10-30T10:28:51.361+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Oct 30 11:00:56 UTC 2013","customfield_12310420":"323907","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4476/watchers","watchCount":2,"isWatching":false},"created":"2013-04-19T09:45:01.350+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-10-30T11:00:56.170+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313896","id":"12313896","name":"JMS client"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have an EAR that is deployed to Websphere 7.\nIt includes EJB module containing a couple of MDBs that are listening on Message Listener Port, pointing to connection factory and queue exposed by custom ActiveMQ JMS Provider.\n\nActiveMQ JMS Provider configuration script (JACL):\n{code}\nimport sys\n\njmsProviderUrl = \"tcp://x.x.x.x:61616\"    \n# Retrieve cell name\ncell = AdminControl.getCell()\nscope = \"Cell=\" + cell\njmsProviderName = \"ActiveMQ\"\nnode = sys.argv[0]\nserver = sys.argv[1]\n\n# ----------------\n# Add JMS Provider\n# ----------------\nattributes = [[\"description\", \"ActiveMQ JMS Provider\"], \\\n              [\"propertySet\", [[\"resourceProperties\", [ \\\n                                                       [[\"name\", \"java.naming.connectionFactoryNames\"], [\"type\", \"java.lang.String\"], [\"value\", \"ConnectionFactory,XAConnectionFactory\"]], \\\n                                                       [[\"name\", \"java.naming.queue.MXITEMIN\"], [\"type\", \"java.lang.String\"], [\"value\", \"MX.ITEM.IN\"]] \\\n                                                       ] \\\n                                ]] \\\n               ]]\nAdminJMS.createJMSProviderAtScope(scope, jmsProviderName, \\\n                                  \"org.apache.activemq.jndi.ActiveMQWASInitialContextFactory\", \\\n                                  jmsProviderUrl, attributes)\n\n# ----------------------\n# Add Connection Factory\n# ----------------------\nattributes = [[\"description\", \"ActiveMQ Queue Connection Factory\"], \\\n              [\"type\", \"UNIFIED\"], \\\n              [\"connectionPool\", [ \\\n                                  [\"connectionTimeout\", \"1800\"], \\\n                                  [\"maxConnections\", \"6\"], \\\n                                  [\"minConnections\", \"0\"], \\\n                                  [\"reapTime\", \"180\"], \\\n                                  [\"unusedTimeout\", \"1800\"], \\\n                                  [\"agedTimeout\", \"1800\"], \\\n                                  [\"purgePolicy\", \"EntirePool\"] \\\n                                  ] \\\n               ], \\\n              [\"sessionPool\", [ \\\n                                  [\"connectionTimeout\", \"1800\"], \\\n                                  [\"maxConnections\", \"1\"], \\\n                                  [\"minConnections\", \"0\"], \\\n                                  [\"reapTime\", \"10\"], \\\n                                  [\"unusedTimeout\", \"1800\"], \\\n                                  [\"agedTimeout\", \"1800\"], \\\n                                  [\"purgePolicy\", \"EntirePool\"] \\\n                                  ] \\\n            ]]\nAdminJMS.createGenericJMSConnectionFactoryAtScope(scope, jmsProviderName, \"ACTIVEMQCF\", \\\n                                                  \"if/maximo/activemq/cf\", \"XAConnectionFactory\", \\\n                                                  attributes)\n\n# ----------------------\n# Add Queues\n# ----------------------\n# 1. MX.ASSET.IN\nattributes = [[\"description\", \"ActiveMQ ASSET Queue\"], [\"type\", \"QUEUE\"]]\nAdminJMS.createGenericJMSDestinationAtScope(scope, jmsProviderName, \"MAXIMO04IN\", \\\n                                            \"if/maximo/activemq/q04cin\", \"MXASSETIN\", \\\n                                            attributes) \n\n\n# ---------------------------------------\n# Create IF-server Message Listener Ports \n# ---------------------------------------\n# PORTMAXIMO01IN\nattributes = [[\"description\", \"ActiveMQ Item\"]]\nAdminServerManagement.configureListenerPortForMessageListenerService(node, server, \"PORTMAXIMO01IN\", \\\n                                                                     \"if/maximo/activemq/cf\", \\\n                                                                     \"if/maximo/activemq/q01cin\", \\\n                                                                     1, 5, 1, attributes)\n{code}\n\n\nMDB code:\n{code}\npublic class MQQueueListener implements MessageListener, MessageDrivenBean {\n\t\n    protected MessageDrivenContext beanCtx;\n\n    public void setMessageDrivenContext(MessageDrivenContext ctx)\n            throws EJBException {\n        // Set the bean context.\n        beanCtx = ctx;\n    }\n\n    public void ejbCreate() throws EJBException {\n        [...]\n    }\n\n    public void ejbRemove() throws EJBException {\n        [...]\n    }\n\n    public void onMessage(Message message) {\n        [...]\n        try {\n            [...]\n        } catch (Exception e) {\n            // Rollback message to external queue.\n            beanCtx.setRollbackOnly();\n        }\n\n    }\n}\n{code}\n\nWhen something goes wrong with the message processing and Exception is thrown regardless if beanCtx.setRollbackOnly(); is executed or not message is not returned back to the queue - it simply disappears. \n\nThe same applies if Exception is re-thrown as RuntimeException instead of beanCtx.setRollbackOnly() call.\n\n------------------\nExpected behavior:\n------------------\nMessage that could not be processed is returned to the ActiveMQ queue and available for reprocessing (according to WebSphere reprocessing policy)","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"324252","customfield_12312823":null,"summary":"ActiveMQ WebSphere 7 JMS Provider - MBD - message consumed even though transaction marked for rollback","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrzej.wieclaw%40gmail.com","name":"andrzej.wieclaw@gmail.com","key":"andrzej.wieclaw@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrzej Więcław","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrzej.wieclaw%40gmail.com","name":"andrzej.wieclaw@gmail.com","key":"andrzej.wieclaw@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrzej Więcław","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows Server 2008 R2","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12643540/comment/13808931","id":"13808931","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"Are you using the ActiveMQ RAR in WebSphere?\n\nIf so this RAR has been improved/fixed in AMQ 5.9 release. Can you give that a try?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-30T10:28:51.361+0000","updated":"2013-10-30T10:28:51.361+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12643540/comment/13808960","id":"13808960","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrzej.wieclaw%40gmail.com","name":"andrzej.wieclaw@gmail.com","key":"andrzej.wieclaw@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrzej Więcław","active":true,"timeZone":"Europe/Berlin"},"body":"No, in fact I'm using AMQ as custom JMS provider.\nI believe it could have something to do with DLQ concept.\nDoesn't it work this way that rejected messages are moved to DLQ's? \nCould that behavior be modified so rejected message is rolled back to the original queue (instead of DLQ) and therefore stops processing of other awaiting messages?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andrzej.wieclaw%40gmail.com","name":"andrzej.wieclaw@gmail.com","key":"andrzej.wieclaw@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrzej Więcław","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-30T11:00:56.170+0000","updated":"2013-10-30T11:00:56.170+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4476/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1jvtr:"}}