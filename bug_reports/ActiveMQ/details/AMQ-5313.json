{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12732561","self":"https://issues.apache.org/jira/rest/api/2/issue/12732561","key":"AMQ-5313","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-08-07T18:41:48.106+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Sep 16 20:24:37 UTC 2014","customfield_12310420":"410589","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_3477110368_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-09-16T20:24:37.602+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5313/watchers","watchCount":4,"isWatching":false},"created":"2014-08-07T14:32:47.284+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-09-16T20:24:37.644+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313896","id":"12313896","name":"JMS client"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have run into an intermittent problem with ActiveMQ V5.9.0. The intermittent was tracked down to being a connection error that does not get properly recovered. \n\nI have recreated the problem in a very small example by creating a Camel \nconsumer route that retrieves messages from a JMS queue and writes the text message to a log.   \n\n        from(TEST_QUEUE).routeId(TEST_QUEUE).convertBodyTo(String.class) \n             .log(LoggingLevel.INFO, loggerName, \"Request Received \");\n \n  The connection string used is \n  failover:(tcp://serverd05.company.com:26093?keepAlive=true)?jms.prefetchPolicy.all=0\n   \nPlease note that polling is being used when the prefetch size is set to 0. \n\nI then use Hawtio on the ActiveMQ broker to add some text messages to the queue. It works fine.\n \nI then stop the Client Connector on the ActiveMQ broker side to simulate a \nbroken connection on the consumer side. (The broker must be remote to the consumer or the error will not occur.)  The client logs show that an \nEOFException is caught and the connection is reestablished. The connection also appears on the ActiveMQ broker. it only looks good though. Sending new text messages to the queue will not be processed. They will just sit there.  There are no errors or warnings logged on either the consumer or broker servers. Restarting the consumer will cause the messages to get processed. The reconnection only intermittently fails. I find is much more like to occur if 10 minutes pass from the previous message being processed. \n\nI turned on trace=yes in the connection string and found the root cause is the PullMessage commands are occasionally not being issued after a reconnect.  On cases where it works, the log shows that the PullMessage commands do reinstate. \n\nI am wondering if this might be a race condition, as this problem only showed up when the consumer was on fast servers \n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12660390","id":"12660390","filename":"fail.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"created":"2014-08-07T16:20:33.575+0000","size":33389,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12660390/fail.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"410583","customfield_12312823":null,"summary":"ActiveMq consumer intermittently hanging after reconnect","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"AIX 6.1, AIX 7.1, IBM Java 6, IBM Java 7","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12732561/comment/14089267","id":"14089267","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"body":"Log file showing a reconnection that does not resume issuing PullMessages.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"created":"2014-08-07T14:34:29.370+0000","updated":"2014-08-07T14:34:29.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12732561/comment/14089397","id":"14089397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"body":"Log showing PullMessages do not return after handling a reconnect.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"created":"2014-08-07T16:20:33.581+0000","updated":"2014-08-07T16:20:33.581+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12732561/comment/14089587","id":"14089587","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pminearo","name":"pminearo","key":"pminearo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Minearo","active":true,"timeZone":"America/Los_Angeles"},"body":"After reading up on this, we have seen a similar problem, possibly?\n\nhttp://activemq.2283324.n4.nabble.com/JMS-to-JMS-Bridge-Connection-td4684129.html\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pminearo","name":"pminearo","key":"pminearo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Minearo","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-08-07T18:41:48.106+0000","updated":"2014-08-07T18:41:48.106+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12732561/comment/14089739","id":"14089739","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"body":"I have read through the referenced JMS-to-JMS-Bridge-Conenction article, but I don't think it is related, although what is in common is it is triggered by a broken connection.  In this JIRA scope the reconnection is made successfully and remains connected as expected.  The connection can be explored with JMX on both the consumer and broker sides.  The only problem is the PullMessage command is never issued after the reconnect, so no actual messages are pulled.  The keepAlive=true option is used and the keepAlive commands are sent across the connection with no problem.  The root problem is something is intermittently not happening to establish the issuing of PullMessage commands after a reconnect ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"created":"2014-08-07T20:12:47.697+0000","updated":"2014-08-07T20:12:47.697+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12732561/comment/14136132","id":"14136132","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"body":"Narrowed problem down to the use a LinkedHashMap as a MessageCache in the ConsumerStateTracker class in ActiveMQ.  \nThe LinkedHashMap has a special method called removeEldestEntry that is called whenever a new entry is put into the HashMap.  In IBM JRE, this is called every time an entry is added to the HashMap, regardless if the key already exists or not.  In Oracle JRE, this method is only invoked if the key value being added is new (which in a polling config is always the same key for polling command).\nWhen the removeEldestEntry is invoked and the external field currentCacheSize exceeds 128K, it would automatically remove the oldest entry in the list.  In ActiveMQ 5.9.0, the field currentCacheSize was being grown by 400 bytes for every polling call to a queue (so 1 per second) regardless of whether adding a new entry to the queue or not.  Once the currentCacheSize exceeded 128K (after about 6 mins), the removeEldestEntry method in the IBM JRE would start to remove the eldest entry which in a polling state was the entry just inserted (so the message cache would be 0 entries in size and when a disconnect occurs, it wouldn't replay the PullCommands that were needed to resume the polling).  In the Oracle JRE, the removeEldestEntry was not being invoked because the pullMessage command was not a new entry.\nRegardless of the scenario above, a change was made in ActiveMQ 5.9.1 in that the currentCacheSize only grows by 400 bytes on the first poll, so, now the currentCache size only grows with additional polling consumers instead of after each poll.  Moving the ActiveMQ client to 5.9.1 will longer exhibit the issue with the Polling Consumer not resuming polling, as the removeEldestEntry will not remove the eldest entry until we exceed 320 polling consumers (as opposed to before, where it would remove the entry with just 1 entry in the cache after 6 mins of time).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"created":"2014-09-16T20:22:05.072+0000","updated":"2014-09-16T20:22:05.072+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12732561/comment/14136136","id":"14136136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"body":"A change was made in ActiveMQ 5.9.1 in that the currentCacheSize was only being grown by 400 on the first poll, so, now the currentCache size only grows with additional polling consumers instead of after each poll itself.  With this change, we should no longer exhibit the issue with the Polling Consumer not resuming polling, as the removeEldestEntry will not remove the eldest entry until we exceed 320 polling consumers (as opposed to before, where it would remove the entry with just 1 entry in the cache after 6 mins of time).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wayn23","name":"wayn23","key":"wayn23","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wayne Irwin","active":true,"timeZone":"America/Chicago"},"created":"2014-09-16T20:24:37.636+0000","updated":"2014-09-16T20:24:37.636+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5313/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1yn33:"}}