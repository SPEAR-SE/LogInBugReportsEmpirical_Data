{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12753265","self":"https://issues.apache.org/jira/rest/api/2/issue/12753265","key":"AMQ-5424","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315630","id":"12315630","description":"Issues that need to be reviewed - do we keep 'em or do we kick 'em? ","name":"NEEDS_REVIEW","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2015-02-05T14:33:04.682+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Nov 23 16:05:31 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_33058522585_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-11-23T16:05:31.770+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5424/watchers","watchCount":5,"isWatching":false},"created":"2014-11-06T01:10:09.225+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[{"id":"12401383","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12401383","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12706473","key":"AMQ-5133","self":"https://issues.apache.org/jira/rest/api/2/issue/12706473","fields":{"summary":"Selector Worker thread consumes significant CPU when broker is idle","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-11-23T16:05:31.808+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"In a network of 2 brokers (A and B) with durable queued messages \ngoing from A to B over a duplex NetworkConnector,\nif A is stopped and restarted while messages are in-flight, \nand if replayed messages from A are recognized as duplicates on B,\nthen 30 seconds after B goes idle, B's CPU goes to 100%.\n\nI have attached the thread dump to the ticket.\n\nFrom what I have been able to figure out, the dequeue counter does not count\nmoving the duplicate into the DLQ. The counters show a pending message when\nthere is none in the persisted queue. So when the scheduler kicks in 30 seconds\nafter the broker goes idle, it says \"I have a pending message, fetch it from the DB\"\nbut the fetch returns 0 messages. Immediately the scheduler still sees pending\nmessages and does a DB fetch, with no results. This is where the CPU is spinning.\n\nSee the attached thread dump.\n\nSo, in detail:\nIt appears that after A is restarted and it replays messages that have not been ACKed,\nB receives duplicate messages and sends them to the DLQ. Here is the warning from the log:\n{noformat}\n  WARN | duplicate message from store ID:host-lnx-59946-1415221396197-1:1:1:1:468, redirecting for dlq processing | org.apache.activemq.broker.region.Queue | ActiveMQ VMTransport: vm://broker1#11-1\n{noformat}\nAfter all messages are delivered and the brokers are idle for 30 seconds and the CPU on B is now 100%, if you use the WebConsole and look at the queues on B you see the following:\n{noformat}\n              Number Of                \t\n   Queue      Pending     Number Of  Messages  Messages\n   Name       Messages    Consumers  Enqueued  Dequeued\nActiveMQ.DLQ     1            0         1         0\nTEST.FOO         1            1        469       468\n{noformat}\n\nOn this test run, only one message was a duplicate. It was moved to the DLQ, but the TEST.FOO counters show it as pending. The counters are out of sync with actual messages in the persisted queue, because the duplicate message is now in the DLQ and not in the TEST.FOO queue.\n\nAt this point if you purge TEST.FOO, CPU on B goes back to normal because this clears the pending message counter.\n\n+*Steps to reproduce*+\n\nSet up 2 brokers as follows:\n\n  *producer* ==> *broker-A*  <==  duplex network connection  ==>  *broker-B* ==>  *consumer*\n\n1) Download the binary distribution of AMQ 5.10.0 and extract apache-activemq-5.10.0-bin.tar.gz\n\n2) Create two brokers\n{noformat}\n $ ACTIVEMQ_HOME/bin/activemq create /path/to/brokers/broker-a\n $ ACTIVEMQ_HOME/bin/activemq create /path/to/brokers/broker-b\n{noformat}\n\n3) Update broker-a to connect to broker-b with a duplex connection.\n   _You can use the attached *activemq.xml*_. It does the following:\n- Sets transport for broker-a to port 61610\n- Sets up networkConnector to connect to broker-b on 61616\n- Does not start jetty web console on broker-a to avoid port conflict\n\nbroker-b is un-modified and defaults to port 61616\n\n4) Start the brokers\n{noformat}\n $ broker-a/bin/broker-a start\n $ broker-b/bin/broker-b start\n{noformat}\n\n5) Start consumer connected to broker-b and producer connected to broker-a\n{noformat}\n $ ant consumer -Durl=tcp://localhost:61616 -Ddurable=true\n $ ant producer -Durl=tcp://localhost:61610 -Ddurable=true\n{noformat}\n\n6) Stop broker-a before producer is finished sending messages, then restart\n{noformat}\n $ broker-a/bin/broker-a stop\n $ broker-a/bin/broker-a start\n{noformat}\n\n7) Look at broker-b logs for duplicates, look at broker-b web console for pending messages\n http://localhost:8161/admin/queues.jsp\n\n8) 30 seconds after going idle, broker-b CPU will goto 100%\n\n9) Purge TEST.FOO on broker-b, pending messages will reset and CPU will go back to normal.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12679744","id":"12679744","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pbertrand","name":"pbertrand","key":"pbertrand","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pete Bertrand","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-06T01:11:14.422+0000","size":4802,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12679744/activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12679743","id":"12679743","filename":"thread-dump.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pbertrand","name":"pbertrand","key":"pbertrand","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pete Bertrand","active":true,"timeZone":"Etc/UTC"},"created":"2014-11-06T01:11:14.417+0000","size":7747,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12679743/thread-dump.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Broker at 100% CPU when idle after Network Connection reconnect with duplicates sent","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pbertrand","name":"pbertrand","key":"pbertrand","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pete Bertrand","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pbertrand","name":"pbertrand","key":"pbertrand","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pete Bertrand","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12753265/comment/14307262","id":"14307262","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rrdoshi","name":"rrdoshi","key":"rrdoshi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Doshi","active":true,"timeZone":"Etc/UTC"},"body":"We are running ActiveMQ 5.10.0 with network of 2 brokers here at Carnegie Mellon and see CPU usage spike to 100% from time to time.  We are however unable to reproduce this issue in test environment.  We would be very interested in any updates on this issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rrdoshi","name":"rrdoshi","key":"rrdoshi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rahul Doshi","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-05T14:33:04.682+0000","updated":"2015-02-05T14:33:04.682+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12753265/comment/14307492","id":"14307492","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pbertrand","name":"pbertrand","key":"pbertrand","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pete Bertrand","active":true,"timeZone":"Etc/UTC"},"body":"I was able to consistently reproduce the problem with the set-up described in the ticket above.\nIt looks like a bug in the code for this failure-mode case.\n\nI currently don't have the knowledge or time to attempt to fix the bug.\nI believe the best chance is to raise the awareness and visibility of this bug on development boards.\n\nPerhaps you could also make a post in the AMQ user forum. http://activemq.apache.org/user-forum.html\nThanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pbertrand","name":"pbertrand","key":"pbertrand","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pete Bertrand","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-05T16:24:23.816+0000","updated":"2015-02-05T16:24:23.816+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12753265/comment/14336468","id":"14336468","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larsn","name":"larsn","key":"larsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Neumann","active":true,"timeZone":"Europe/Berlin"},"body":"Could this be related to AMQ-5605?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larsn","name":"larsn","key":"larsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Neumann","active":true,"timeZone":"Europe/Berlin"},"created":"2015-02-25T13:20:18.009+0000","updated":"2015-02-25T13:20:18.009+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12753265/comment/14336500","id":"14336500","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I did some rework or AMQ-4485 because of AMQ-5266. Part of that was to fix up the counters/stats if the store traps a duplicate;\nsee: https://github.com/apache/activemq/blob/85b9c81a3f2431b8272c19acf4e4b1cddeb25c5e/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L770\n\nIf the counters are correct the spin probably can be avoided so I think this may not reproduce on 5.11.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-25T14:07:07.031+0000","updated":"2015-02-25T14:07:07.031+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12753265/comment/15022354","id":"15022354","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"No test case provided, no feedback against later broker releases with related bug fixes to the indicated problem area.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-11-23T16:05:31.797+0000","updated":"2015-11-23T16:05:31.797+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5424/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i221af:"}}