{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13065077","self":"https://issues.apache.org/jira/rest/api/2/issue/13065077","key":"AMQ-6658","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2017-05-26T19:41:11.571+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Oct 17 13:04:17 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_3221266199_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-05-26T19:42:24.658+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6658/watchers","watchCount":2,"isWatching":false},"created":"2017-04-19T12:54:38.514+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338822","id":"12338822","name":"5.14.3","archived":false,"released":true,"releaseDate":"2016-12-22"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-10-17T13:04:17.302+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I am facing a situation  where activemq seems not to respect the order for dispatched messages when a redilevery is needed using activemq-client 5.14.3.\n\nI am sending 60 messages to a queue with a single consumer, and I've noticed that sometimes when a relivery of the message is needed, as a consequence of rollback, another message from those 60 message is served before the redelivered message. There is no maxRedelivery set.\n\nWhat I notice debugging ActiveMQMessageConsumer is that the following behaviour may occur:\n\n- The 60 messages are dispatched in order in:\n\nActiveMQMessageConsumer:1376:\n\n    @Override\n    public void dispatch(MessageDispatch md) {\n        MessageListener listener = this.messageListener.get();\n        try {\n            clearMessagesInProgress();\n            ...\n\nunconsumedMessage is running so the message is sent to the listener.\n\n- a rollback is performed and the message is redelivered (with a default delay):\n\nActiveMQMessageConsumer:1305:\n\n                        if (redeliveryDelay > 0 && !unconsumedMessages.isClosed()) {\n                            // Start up the delivery again a little later.\n                            session.getScheduler().executeAfterDelay(new Runnable() {\n                                @Override\n                                public void run() {\n                                    try {\n                                        if (started.get()) {\n                                            start();\n                                        }\n                                    } catch (JMSException e) {\n                                        session.connection.onAsyncException(e);\n                                    }\n                                }\n                            }, redeliveryDelay);\n                        } else {\n                            start();\n                        }\n\nPeriodically, the messages enqueued in the session are attempted to be consumed (as the unconsumedMessages from the consumer is not running they are not sent to the listener to be consumed and they are enqueued as unconsumedMessages).\nBut if the thread scheduled from redelivery is started when the iteration from the unconsumed messages is being performed, the unconsumedMessages is started in:\n\n    public void start() throws JMSException {\n        if (unconsumedMessages.isClosed()) {\n            return;\n        }\n        started.set(true);\n        unconsumedMessages.start();\n        session.executor.wakeup();\n    }\n\nand the message that is being considered from session (in the other thread) is sent to the listener before the redelivered message, which may be an error in order.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Messenger does not respect order after redelivery","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabian.gonzalez","name":"fabian.gonzalez","key":"fabian.gonzalez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fabian González","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabian.gonzalez","name":"fabian.gonzalez","key":"fabian.gonzalez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fabian González","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13065077/comment/16026716","id":"16026716","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabian.gonzalez","name":"fabian.gonzalez","key":"fabian.gonzalez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fabian González","active":true,"timeZone":"Etc/UTC"},"body":"I think I found what causes the issue concerning the wrong order after redelivery.\n\nThere are two active threads which are involved in an apparent race condition:\nActiveMQConnection[xx]Scheduler\nActiveMQ Session Task\n1) A Session Task thread verifies in ActiveMQSessionExecutor.iterate that there are messages queued on the session (as there are 60 messages prefetched).\n2) It dispatchs the threads through ActiveMQMessageConsumer\n3) if unconsumedMessages is not running in ActiveMQMessageConsumer.dispatch, it enqueues the message in unconsumedMessages and it is not redelivered.\nSo if ActiveMQ Session Task polls messages several times before ActiveMQConnection[xx]Scheduler starts unconsumedMessages in ActiveMQMessageConsumer:1889 (unconsumedMessages.start(), there would be several items in unconsumedMessages.\nThe problem arises if ActiveMQ Session Task polls messages several times, it polls a new message, and then ActiveMQConnection[xx]Scheduler starts unconsumedMessage. In that case unconsumedMessages is running, so the message is delivered (but the first message which was enqueued in unconsumedMessage was the one which should have been delivered first instead of the one which was currently being considered by the session thread).\nI think the dispatch message has to deliver always the oldest message which was enqueued in unconsumedMessages.\n\nFor example in the dispatch method in ActiveMQMessageConsumer, something like this should be done:\n\n    @Override\n    public void dispatch(MessageDispatch md)\n    {\n        MessageListener listener = this.messageListener.get();\n        try\n        {\n            clearMessagesInProgress();\n            clearDeliveredList();\n            synchronized (unconsumedMessages.getMutex())\n            {\n                if (!unconsumedMessages.isClosed())\n                {\n                    if (this.info.isBrowser() || !session.connection.isDuplicate(this, md.getMessage()))\n                    {\n                        if (listener != null && unconsumedMessages.isRunning())\n                        {\n                            // otherwise I do not preserve the order for\n                            // redelivery\n                            unconsumedMessages.enqueue(md);\n                            md = unconsumedMessages.dequeueNoWait();\n\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabian.gonzalez","name":"fabian.gonzalez","key":"fabian.gonzalez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fabian González","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-26T19:21:01.908+0000","updated":"2017-05-26T19:30:28.958+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13065077/comment/16026736","id":"16026736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clebertsuconic","name":"clebertsuconic","key":"clebertsuconic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"clebert suconic","active":true,"timeZone":"America/New_York"},"body":"Ahaa..... I told you it was about prefetch... just saw your message after I answered you on the user's list.\n\n\nI will close this is a not a bug.. this is definitely not a bug... if you disable prefetch for everybody.. then there's no way to make everybody happy.\n\n\nWith ActiveMQ Artemis I believe we empty the buffer after redeliver.. so perhaps it's not an issue there.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clebertsuconic","name":"clebertsuconic","key":"clebertsuconic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"clebert suconic","active":true,"timeZone":"America/New_York"},"created":"2017-05-26T19:41:11.571+0000","updated":"2017-05-26T19:41:11.571+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13065077/comment/16026737","id":"16026737","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clebertsuconic","name":"clebertsuconic","key":"clebertsuconic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"clebert suconic","active":true,"timeZone":"America/New_York"},"body":"reopen it if its proved to be a bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=clebertsuconic","name":"clebertsuconic","key":"clebertsuconic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"clebert suconic","active":true,"timeZone":"America/New_York"},"created":"2017-05-26T19:42:24.699+0000","updated":"2017-05-26T19:42:24.699+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13065077/comment/16207609","id":"16207609","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabian.gonzalez","name":"fabian.gonzalez","key":"fabian.gonzalez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fabian González","active":true,"timeZone":"Etc/UTC"},"body":"Hello, [~clebertsuconic]. I think the problem which causes out of order redeliver is the one I reported in AMQ-6775. Could you take a look at it?\r\nThanks and sorry for the inconveniences.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fabian.gonzalez","name":"fabian.gonzalez","key":"fabian.gonzalez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fabian González","active":true,"timeZone":"Etc/UTC"},"created":"2017-10-17T13:04:17.302+0000","updated":"2017-10-17T13:04:17.302+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6658/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3dt4f:"}}