{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483698","self":"https://issues.apache.org/jira/rest/api/2/issue/12483698","key":"AMQ-2161","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316331","id":"12316331","description":"Next unplanned v5 maintenance release","name":"5.x","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2010-08-09T10:48:22.729+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Aug 09 10:48:22 UTC 2010","customfield_12310420":"75047","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2161/watchers","watchCount":9,"isWatching":false},"created":"2009-03-13T16:37:30.668+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-04-01T11:21:44.558+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I tried to read about 200000 messages from a queue. Reading was performed in XA transactions in chunks of 1000 messages per transaction.\nAfter reading some messages (I almost never came above 100000 read messages), an exception occured in the activemq log file (data/activemq.log).\nIn my application, null was returned for the message. Reading of further messages always returned null until a new transaction was opened.\nNo exception was thrown and the transaction was not marked as rolled back.\nAfter that, the number of read messages in my application and the number of dequeued messages I saw in the activemq JMX interface was often no longer in sync. It seems to me that activemq was of the opinion that the transaction was rolled back while my application was not.\nAnother indication is that my application always gets one of the read messages a second time some time after the incident.\n\nWhen I set the prefetchPolicy.all to 1, the problem first seemed to disappear. Normally, there were no more exceptions in the log file and a null message was never returned. After testing a little more, the problem also occured with prefetch size 1 (see attached log file). However, it seems to occur less often and only with more messages in the queue (I tested with 280000). Duplicate messages did not occur when I tested it once, but the JMX interface to activemq reported 280200 messages dequeued even though there were only 280000 in the queue. It also reported a size of -200 when the queue was empty.\n \nI also tried with prefetchPolicy.all=0, but that created a different problem: there are no exceptions either, but after some time, the application hang completely in the reader thread and never returned. I tried this only once, but probably this should also be investigated, if there is no easy explanation.\n\nI wrote a test case that demonstrates the bug (see attachment). It always occured for 200000 messages, and almost always for 100000 messages. For 20000 messages, for example, the problem almost never occurs. For executing the test, I first stopped the activemq server, deleted the data directory and then restarted the server. After that, I executed the test, which first writes all messages into a queue and then tries to read them back.\n\nThe stacktrace from the activemq log file is attached.\n\n\nThe configuration of the broker in my activemq.xml configuration file:\n\n{noformat}\n    <broker xmlns=\"http://activemq.apache.org/schema/core\" brokerName=\"localhost\" dataDirectory=\"${activemq.base}/data\" persistent=\"true\">\n\n        <destinationPolicy>\n            <policyMap>\n                <policyEntries>\n                    <policyEntry queue=\">\" memoryLimit=\"2000mb\"/>\n                    <policyEntry topic=\">\" memoryLimit=\"5mb\">\n                    </policyEntry>\n                </policyEntries>\n            </policyMap>\n        </destinationPolicy>\n        <managementContext>\n            <managementContext createConnector=\"false\"/>\n        </managementContext>\n\n        <networkConnectors>\n        </networkConnectors>\n\n        <persistenceAdapter>\n            <amqPersistenceAdapter syncOnWrite=\"false\" directory=\"${activemq.base}/data\" maxFileLength=\"20 mb\"\n                                   indexBinSize=\"131072\" indexPageSize=\"128kb\" />\n        </persistenceAdapter>\n\n        <sslContext>\n            <sslContext keyStore=\"file:${activemq.base}/conf/broker.ks\" keyStorePassword=\"password\" \ntrustStore=\"file:${activemq.base}/conf/broker.ts\" trustStorePassword=\"password\"/>\n        </sslContext>\n\n        <systemUsage>\n            <systemUsage>\n                <memoryUsage>\n                    <memoryUsage limit=\"1000 mb\"/>\n                </memoryUsage>\n                <storeUsage>\n                    <storeUsage limit=\"2 gb\" name=\"foo\"/>\n                </storeUsage>\n                <tempUsage>\n                    <tempUsage limit=\"2000 mb\"/>\n                </tempUsage>\n            </systemUsage>\n        </systemUsage>\n\n        <transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://localhost:61616\" />\n        </transportConnectors>\n\n    </broker>\n{noformat}\n\nThe configuration of the transaction manager (from the Spring application context):\n\n{noformat}\n<bean id=\"btmConfig\"\n        class=\"bitronix.tm.TransactionManagerServices\" factory-method=\"getConfiguration\">\n        <property name=\"serverId\" value=\"${processes.serverId}\"/>\n        <property name=\"logPart1Filename\" value=\"${processes.bitronix.logPart1Filename}\" />\n        <property name=\"logPart2Filename\" value=\"${processes.bitronix.logPart2Filename}\" />\n        <property name=\"warnAboutZeroResourceTransaction\" value=\"false\" />\n    </bean>\n    \n    <bean id=\"bitronixTransactionManager\" destroy-method=\"shutdown\" depends-on=\"btmConfig\"\n        class=\"bitronix.tm.TransactionManagerServices\" factory-method=\"getTransactionManager\">\n        <property name=\"transactionTimeout\" value=\"600000\"/>\n    </bean>\n    \n    <bean id=\"transactionManager\" class=\"org.springframework.transaction.jta.JtaTransactionManager\">\n        <property name=\"transactionManager\" ref=\"bitronixTransactionManager\" />\n        <property name=\"userTransaction\" ref=\"bitronixTransactionManager\" />\n        <property name=\"autodetectTransactionManager\" value=\"false\" />\n        <property name=\"autodetectUserTransaction\" value=\"false\" />\n        <property name=\"defaultTimeout\" value=\"600000\" />\n    </bean>\n    \n    <bean id=\"transactionTemplate\"\n        class=\"org.springframework.transaction.support.TransactionTemplate\">\n        <property name=\"transactionManager\" ref=\"transactionManager\" />\n    </bean>\n{noformat}\n\nThe queue definition from the applicationContext:\n\n{noformat}\n<amq:queue id=\"loadtestqueue\" physicalName=\"loadtestqueue\" />\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461401","id":"12461401","filename":"activemq-error-async.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T16:52:45.209+0000","size":23163,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461401/activemq-error-async.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461404","id":"12461404","filename":"activemq-error-prefetch1.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-16T17:09:13.833+0000","size":5272,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461404/activemq-error-prefetch1.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461402","id":"12461402","filename":"ActiveMqLoadTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T17:01:54.364+0000","size":6347,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461402/ActiveMqLoadTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59707","customfield_12312823":null,"summary":"Unmatched acknowledege Exception and duplicate received messages in XA transaction","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Ubuntu Linux 2.6.24-22\nProcessor with 2 cores\nJava 1.6.0_02-b05\nBitronix Transaction Manager 1.3.2","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483698/comment/12940988","id":"12940988","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"body":"Extract from the ActiveMQ log file with the exceptions. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T16:52:45.250+0000","updated":"2009-03-13T16:52:45.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483698/comment/12940991","id":"12940991","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"body":"Attached the TestNG test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T17:01:54.410+0000","updated":"2009-03-13T17:01:54.410+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483698/comment/12941000","id":"12941000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"body":"Added a log file which shows that the error also occurs with prefetch size 1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mgottschalk","name":"mgottschalk","key":"mgottschalk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Gottschalk","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-16T17:09:13.939+0000","updated":"2009-03-16T17:09:13.939+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483698/comment/12939633","id":"12939633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Just had a quick look at this test to see if it could easily be validated for 5.4, I notice the use of a pooled connection factory. For producers this makes sense, but for consumers it can lead to dangling prefetched messages if the consumers are added back to the pool. Just wanted to add this in case it is related to the problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-08-09T10:48:22.729+0000","updated":"2010-08-09T10:48:22.729+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2161/votes","votes":7,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0al73:"}}