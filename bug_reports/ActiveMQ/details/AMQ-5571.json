{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12773320","self":"https://issues.apache.org/jira/rest/api/2/issue/12773320","key":"AMQ-5571","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Feb 25 03:47:07 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5571/watchers","watchCount":1,"isWatching":false},"created":"2015-02-08T21:00:27.101+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-04-17T17:37:36.524+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I’m allocating about 6GB of RAM to ActiveMQ.  The problem is that this box only has 4GB free after that.\n\nIf I try to gracefully shut down ActiveMQ tries to run \"stop\" to gracefully request that ActiveMQ shutdown to avoid recovery on startup.\n\nThe problem is that this uses the ACTIVEMQ_OPTS_MEMORY again and since I'm setting memory settings to maximum here this simple command tries to allocate another 9GB.\n\nHowever, this will fail.  because ACTIVEMQ_OPTS includes ACTIVEMQ_OPTS_MEMORY which is where I set the daemon to use large amounts of memory.\n\nI THINK the resolution to this is to ONLY use ACTIVEMQ_OPTS_MEMORY in \"start\"…. wouldn’t you agree?\n\nThis has a second issue where since I’ms eating -Xms and -Xmx and allocating another 6GB during stop it could trigger an OOM killer and will definitely invalidate a large chunk of the VFS page cache.\n\nHere's a patch that fixes the issue.  \n\nIt does NOT fix the issue for the 'status' command.  That would take a larger refactoring of the init script and I'd like to avoid that for now since bash scripts can be fragile.\n\n{noformat}\nIndex: artemis-ansible/roles/artemis-scheduler/files/usr/share/apache-activemq/bin/activemq\nIDEA additional info:\nSubsystem: com.intellij.openapi.diff.impl.patch.CharsetEP\n<+>UTF-8\n===================================================================\n--- artemis-ansible/roles/artemis-scheduler/files/usr/share/apache-activemq/bin/activemq\t(revision 6cf4aa65d9b4362390ba251201cc71b6e2be1458)\n+++ artemis-ansible/roles/artemis-scheduler/files/usr/share/apache-activemq/bin/activemq\t(revision )\n@@ -250,7 +250,7 @@\n fi\n \n if [ -z \"$ACTIVEMQ_OPTS\" ] ; then\n-    ACTIVEMQ_OPTS=\"$ACTIVEMQ_OPTS_MEMORY -Djava.util.logging.config.file=logging.properties -Djava.security.auth.login.config=$ACTIVEMQ_CONF/login.config\"\n+    ACTIVEMQ_OPTS=\"-Djava.util.logging.config.file=logging.properties -Djava.security.auth.login.config=$ACTIVEMQ_CONF/login.config\"\n fi\n \n # create configuration if requested\n@@ -394,7 +394,7 @@\n    fi\n    # Execute java binary\n    if [ -n \"$PIDFILE\" ] && [ \"$PIDFILE\" != \"stop\" ];then\n-      $EXEC_OPTION $DOIT_PREFIX \"$JAVACMD $ACTIVEMQ_OPTS $ACTIVEMQ_DEBUG_OPTS \\\n+      $EXEC_OPTION $DOIT_PREFIX \"$JAVACMD $ACTIVEMQ_OPTS_MEMORY $ACTIVEMQ_OPTS $ACTIVEMQ_DEBUG_OPTS \\\n               -Dactivemq.classpath=\\\"${ACTIVEMQ_CLASSPATH}\\\" \\\n               -Dactivemq.home=\\\"${ACTIVEMQ_HOME}\\\" \\\n               -Dactivemq.base=\\\"${ACTIVEMQ_BASE}\\\" \\\n\\ No newline at end of file\n\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ActiveMQ fails to gracefully shut down if ACTIVEMQ_OPTS_MEMORY uses > 50% of memory","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12773320/comment/14335945","id":"14335945","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"body":"OK. I have a branch for this patch I'd like you guys to merge.  It only adds the memory settings when you launch anything other than 'stop' ... \n\nStop should not require massive amounts of memory or even a complex memory configuration. \n\nhttps://github.com/spinn3r/activemq\n\nBranch is: burton-memory-cmdline-fix\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-25T03:47:07.573+0000","updated":"2015-02-25T03:47:07.573+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5571/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i25cbb:"}}