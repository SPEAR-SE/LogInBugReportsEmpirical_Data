{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13004782","self":"https://issues.apache.org/jira/rest/api/2/issue/13004782","key":"AMQ-6429","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-09-14T10:03:04.615+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 14 10:50:45 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6429/watchers","watchCount":4,"isWatching":false},"created":"2016-09-14T05:05:59.789+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334019","id":"12334019","name":"5.11.4","archived":false,"released":true,"releaseDate":"2016-02-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-09-14T10:50:45.743+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We have experienced a problem during somewhat high load (>500 000 messages over 30 minutes to multiple queues), where 2 messages was both delivered and DLQ’ed, 8 messages was delivered twice and 7 messages disappeared (but then upon inspection 6 of them is present in the AMQ database, somehow without AMQ noticing).\n\nWe are running an ActiveMQ 5.11.4 broker in JDBC Master Slave setup with MSSQL server as persistent store, with 2 slaves (i.e. hot standbys).\n\nThere was no master-switching (failover) during the incident.\n\nWe have no indication that there were problems on the MS SQL server at the time.\n\nThere are only two log lines in the ActiveMQ log at the time of the incident:\n\n2016-08-29 06:03:54,857 [ActiveMQ BrokerService[svg-amq03_61616] Task-351933] WARN  o.a.a.b.r.c.AbstractStoreCursor - org.apache.activemq.broker.region.cursors.QueueStorePrefetch@24b740dc:stow:AgreementService.private.createOrder,batchResetNeeded=false,size=1,cacheEnabled=false,maxBatchSize:1,hasSpace:true,pendingCachedIds.size:0,lastSyncCachedId:null,lastSyncCachedId-seq:null,lastAsyncCachedId:null,lastAsyncCachedId-seq:null,store=stow:AgreementService.private.createOrder,pendingSize:1 - cursor got duplicate from store ID:svg-agreement01-49217-1471461423933-1:15:1:6980:1 seq: 1233709 \n2016-08-29 06:03:54,857 [ActiveMQ BrokerService[svg-amq03_61616] Task-351933] WARN  o.a.activemq.broker.region.Queue - duplicate message from store ID:svg-agreement01-49217-1471461423933-1:15:1:6980:1, redirecting for dlq processing \n\n\n2016-08-29 06:03:54,920 [ActiveMQ BrokerService[svg-amq03_61616] Task-351926] WARN  o.a.a.b.r.c.AbstractStoreCursor - org.apache.activemq.broker.region.cursors.QueueStorePrefetch@24b740dc:stow:AgreementService.private.createOrder,batchResetNeeded=false,size=2,cacheEnabled=false,maxBatchSize:2,hasSpace:true,pendingCachedIds.size:0,lastSyncCachedId:null,lastSyncCachedId-seq:null,lastAsyncCachedId:null,lastAsyncCachedId-seq:null,store=stow:AgreementService.private.createOrder,pendingSize:1 - cursor got duplicate from store ID:svg-agreement01-49217-1471461423933-1:15:1:6981:1 seq: 1233746 \n2016-08-29 06:03:54,920 [ActiveMQ BrokerService[svg-amq03_61616] Task-351926] WARN  o.a.activemq.broker.region.Queue - duplicate message from store ID:svg-agreement01-49217-1471461423933-1:15:1:6981:1, redirecting for dlq processing \n\nThe two DLQ’ed messages from the log lines were both delivered correctly, and then also DLQ’ed.\n\nAt the same time we got 8 other messages delivered twice, and 7 messages looked like they were gone. When querying the AMQ database, 6 of the 7 lost messages are present in the database, but not present when querying MBeans for the queues – leaving 1 message without a trace. (We know it was sent, due to log lines from the application).\n\nAll of this happened at the same time (during same second), and all of the problematic messages in question were on the same queue.\n\nAny idea why this happenend, and how to avoid it the future?","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"lost messages ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asbjorn%40aarrestad.com","name":"asbjorn@aarrestad.com","key":"asbjorn@aarrestad.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Asbjørn Aarrestad","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asbjorn%40aarrestad.com","name":"asbjorn@aarrestad.com","key":"asbjorn@aarrestad.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Asbjørn Aarrestad","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13004782/comment/15490017","id":"15490017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"most likely there are some duplicate sends in the mix. Producers that use failover and had an inflight send when they lost their connection and reconnected. \nThe first approach may be to use maxReconnectAttempts=0 in the failover urls such that the application sees these connection failures and can deal with them with new messages that won't be seen as duplicates by the broker.\n\nthe other option is some bug in the sync between the cursor and the store. disabling the cursor cache may avoid that scenario.\n\nThere are message audits on the cursors, if they detect a duplicate they will redirect it to the DLQ in case there is some error in the duplicate suppression to ensure no message loss. From that perspective the DLQ logging looks ok.\nHowever with 8 duplicates, it may be that the cursor audit needs to be configured with larger limits such that it will suppress more duplicates.\nsee: PolicyEntry - setMaxProducersToAudit  (the number for max concurrent producers - default to 64) and setMaxAuditDepth (the range to track - a transaction batch size). Most likely setMaxProducersToAudit needs to be larger for your setup.\n\nTo fully understand what is going on, we need a scenario that will reproduce and really against the master code base, which will contain all of the latest fixes.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-14T10:03:04.615+0000","updated":"2016-09-14T10:03:28.950+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13004782/comment/15490119","id":"15490119","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stolsvik","name":"stolsvik","key":"stolsvik","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Endre Stølsvik","active":true,"timeZone":"Europe/Oslo"},"body":"Thanks! We'll look into the suggestions, and check logs on the clients (there is quite a bit of app-side logging when receiving and sending messages, and committing transactions).\n\nHowever, what about the 7 lost messages, of which 6 evidently are present in DB but AMQ fails to \"see\" them when \"introspected\" via JMX, QueueBrowser and BrokerDestinationView? Also, the last one of those messages is utterly gone.\n\nAny clues in the time-aspect? It all happened within 1 second.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=stolsvik","name":"stolsvik","key":"stolsvik","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Endre Stølsvik","active":true,"timeZone":"Europe/Oslo"},"created":"2016-09-14T10:50:45.743+0000","updated":"2016-09-14T10:50:45.743+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6429/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i33lo7:"}}