{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12831373","self":"https://issues.apache.org/jira/rest/api/2/issue/12831373","key":"AMQ-5785","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-05-20T20:18:55.774+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Oct 26 08:38:10 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_25345920091_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-03-08T21:53:18.772+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5785/watchers","watchCount":6,"isWatching":false},"created":"2015-05-20T13:21:20.651+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-10-26T08:38:10.132+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"During the peak loads we are encountering a recurring deadlock issue in ActiveMQ broker. The threads that are deadlocked are \nActiveMQ  NIO Worker - trying to add message to FilePendingCursor\nBroker.Service Worker - that is trying to expire message from FilePendingCursor.\n\n=============================\nFound one Java-level deadlock:\n=============================\n\"ActiveMQ NIO Worker 1003\":\n  waiting to lock monitor 0x00002aeeb515a4f8 (object 0x00000007807da3e8, a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor),\n  which is held by \"ActiveMQ BrokerService.worker.1\"\n\"ActiveMQ BrokerService.worker.1\":\n  waiting for ownable synchronizer 0x000000077ac84b40, (a java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync),\n  which is held by \"ActiveMQ NIO Worker 1003\"\n\nJava stack information for the threads listed above:\n===================================================\n\"ActiveMQ NIO Worker 1003\":\n\tat org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:207)\n\t- waiting to lock <0x00000007807da3e8> (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.addMessageLast(StoreQueueCursor.java:96)\n\t- locked <0x00000007784e8c88> (a org.apache.activemq.broker.region.cursors.StoreQueueCursor)\n\tat org.apache.activemq.broker.region.Queue.sendMessage(Queue.java:1855)\n\tat org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:939)\n\tat org.apache.activemq.broker.region.Queue.send(Queue.java:733)\n\tat org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:424)\n\tat org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:445)\n\tat org.apache.activemq.broker.jmx.ManagedRegionBroker.send(ManagedRegionBroker.java:297)\n\tat org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)\n\tat org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:307)\n\tat org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:147)\n\tat org.apache.activemq.broker.UserIDBroker.send(UserIDBroker.java:56)\n\tat org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:152)\n\tat org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:496)\n\tat org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:756)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:294)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:148)\n\tat org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\n\tat org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)\n\tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n\tat org.apache.activemq.transport.nio.NIOTransport.serviceRead(NIOTransport.java:138)\n\tat org.apache.activemq.transport.nio.NIOTransport$1.onSelect(NIOTransport.java:69)\n\tat org.apache.activemq.transport.nio.SelectorSelection.onSelect(SelectorSelection.java:94)\n\tat org.apache.activemq.transport.nio.SelectorWorker$1.run(SelectorWorker.java:119)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n\"ActiveMQ BrokerService.worker.1\":\n\tat sun.misc.Unsafe.park(Native Method)\n\t- parking to wait for  <0x000000077ac84b40> (a java.util.concurrent.locks.ReentrantReadWriteLock$NonfairSync)\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:186)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:834)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireQueued(AbstractQueuedSynchronizer.java:867)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquire(AbstractQueuedSynchronizer.java:1197)\n\tat java.util.concurrent.locks.ReentrantReadWriteLock$WriteLock.lock(ReentrantReadWriteLock.java:945)\n\tat org.apache.activemq.broker.region.Queue.messageExpired(Queue.java:1841)\n\tat org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.discardExpiredMessage(FilePendingMessageCursor.java:474)\n\tat org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.expireOldMessages(FilePendingMessageCursor.java:420)\n\t- locked <0x00000007807da3e8> (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)\n\tat org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.onUsageChanged(FilePendingMessageCursor.java:398)\n\t- locked <0x00000007807da3e8> (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)\n\tat org.apache.activemq.usage.Usage$1.run(Usage.java:304)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n\tat java.lang.Thread.run(Thread.java:744)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12734128","id":"12734128","filename":"threaddump16214.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-05-20T13:24:41.488+0000","size":4294043,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12734128/threaddump16214.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Deadlock between FilePendingMessageCursor usage change and incoming send operations.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Physical Machine (192 GB RAM, 24 VCPU), RHEL 5.9, Java 1.7\nActiveMQ runs on 4 GB heap","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/14552309","id":"14552309","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"body":"Attaching the thread dump. This issue is occurring everyday at peak hours. We have upgraded to 5.10.0 from 5.6.0 about 4 months ago. This issue has started occurring since a week.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-05-20T13:24:41.510+0000","updated":"2015-05-20T13:24:41.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/14553030","id":"14553030","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"This appears to probably be the same race condition issue I reported here: https://issues.apache.org/jira/browse/AMQ-5712\n\n[~tabish121] uploaded a patch to that Jira that I've been running for a while and it has solved the deadlock problem for me.  It hasn't been committed to master yet but if you don't mind applying the patch yourself it should at least help you stop the deadlock until it gets fixed permanently.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2015-05-20T20:18:55.774+0000","updated":"2015-05-20T20:19:32.026+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/14555231","id":"14555231","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Given this is logged against 5.10 it may be a different issue so it'd be a good idea to try out a later release 5.11.1+","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-05-21T23:09:30.969+0000","updated":"2015-05-21T23:09:30.969+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/14558776","id":"14558776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"body":"Agree with Timothy. This seems to be a different issue. This issue occurs in one of our several AMQ environments and cannot be replicated anywhere else.\n\nI can go with the upgrade if I can find a root cause of the issue and for sure know that 5.11.1 will fix it as an AMQ upgrade in our environment is non trivial.\nThe issue again occurred yesterday and the thread dumps from yesterday tell the same story. If you need any activemq logs either in trace/debug mode I will be able to attach them here.\n\nI am going through the ActiveMQ source code to corner this issue. Any pointers/help in this regard is greatly appreciated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"created":"2015-05-26T07:22:37.212+0000","updated":"2015-05-26T07:22:37.212+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/14559016","id":"14559016","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Yes, I think you are right that it is different.  At first glance it looked like the same issue based on the addMessageLast thread being the same.  The patch I suggested helps with timing out while waiting to add a message on a store, but this is different. \n\nBased on your thread dump, the NIO worker has acquired the {{messagesLock}} in the {{sendMessage}} method of the Queue class (line 1853 in the Queue.java) and is waiting on the intrinsic lock of FilePendingMessageCursor on the {{addMessageLast}} method (line 207 in FilePendingMessageCursor.java).  The BrokerService thread has acquired the intrinsic lock of FilePendingMessageCursor in {{onUsageChanged}} (line 394 of FilePendingMessageCursor.java)  and is waiting on {{messagesLock}} in the {{messageExpired}} method (line 1841 of Queue.java)....a pretty classic deadlock.  In version 5.11.1 some of this has been refactored a bit, {{sendMessage}} method has been replaced with {{cursorAdd}}, etc.  However, at a glance I think the deadlock issue would still exist in 5.11.1.\n\nTim, do you think it would be worth replacing the {{messagesLock.writeLock().lock()}} calls with {{messagesLock.writeLock().tryLock()}} and handle the lock timeout to prevent a potential deadlock?\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2015-05-26T11:59:09.449+0000","updated":"2015-05-26T12:00:22.523+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/15185105","id":"15185105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"it looks like the onUsageChanged of the filecursor needs to remove expired messages from the cursor and then process them as expired *without* holding the cursor lock. So break out discardExpiredMessages from expireOldMessages and call discardExpiredMessages with some list, without the lock","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2016-03-08T15:41:18.087+0000","updated":"2016-03-08T15:41:18.087+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/15185454","id":"15185454","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 8b23e072eeab2beebf62fd267bf8d9f88d05b5c2 in activemq's branch refs/heads/master from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=8b23e07 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-5785\n\nAvoid holding the intrinsic lock on the cursor when expiring the\nmessages.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-03-08T18:38:54.756+0000","updated":"2016-03-08T18:38:54.756+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/15185493","id":"15185493","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~gtully] , Good idea, I meant to come back to this issue and take a closer look at solving it but it got lost in the backlog. :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-03-08T18:54:00.146+0000","updated":"2016-03-08T18:54:46.272+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12831373/comment/15607861","id":"15607861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"body":"Reviewing the commit I found that it introduces new mistake.\nI believe that commit solves the deadlock problem, but...\n\nIt breaks original implementation of method {{expireOldMessages()}} which is:\n# still used by other methods - {{tryAddMessageLast(MessageReference, long)}}, {{addMessageFirst(MessageReference)}}\n# protected, so potentially used by extending classes\n\nProblem caused by changing {{expireOldMessages()}} is that it breaks the functionality of freeing space when adding new messages to the cursor. Currently after this fix it only creates a an unnecessary load of expired messages to the list which is never used.\n\nCommenting on these lines in code (which are shared by both addMessageX methods):\n{code}\n  if (!hasSpace()) {\n    if (isDiskListEmpty()) {\n      expireOldMessages(); // this will not clear anything!\n      if (hasSpace()) { // this probably won't happen\n        memoryList.addMessageFirst(node);\n        node.incrementReferenceCount();\n        return;\n      } else { // will always fallback to flushing data to disk\n        flushToDisk();\n      }\n    }\n  }\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkubricht","name":"mkubricht","key":"mkubricht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michal Kubricht","active":true,"timeZone":"Europe/Berlin"},"created":"2016-10-26T08:38:10.132+0000","updated":"2016-10-26T08:38:10.132+0000"}],"maxResults":9,"total":9,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5785/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2ezkn:"}}