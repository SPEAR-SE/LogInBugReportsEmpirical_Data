{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13073792","self":"https://issues.apache.org/jira/rest/api/2/issue/13073792","key":"AMQ-6680","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338054","id":"12338054","name":"5.15.0","archived":false,"released":true,"releaseDate":"2017-07-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12340366","id":"12340366","name":"5.14.6","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-05-22T16:27:45.943+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon May 22 16:28:08 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_26839503_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-05-22T16:29:00.597+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6680/watchers","watchCount":2,"isWatching":false},"created":"2017-05-22T09:01:41.185+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["mqtt","patch","websocket"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12339772","id":"12339772","name":"5.14.5","archived":false,"released":true,"releaseDate":"2017-04-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-05-22T16:29:00.673+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12318701","id":"12318701","name":"MQTT","description":"MQTT Transport"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I tried to use the MQTT.js library in a browser but it didn't connect to ActiveMQ using MQTT-WebSocket transport.\nDebugging MQTT.js and ActiveMQ I found that the org.apache.activemq.transport.ws.jetty9.MQTTSocket class (in activemq-http module) assumes that a single WebSocket data frame +always+ contains a single MQTT Control Packet.\nThis is the cause of MQTT.js failure because MQTT.js makes several send over WebSocket for a single MQTT Control Packet (header, length etc).\n\nAccordingly to MQTT OASIS specification ( http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718127 ):\n\n??A single WebSocket data frame can contain multiple or partial MQTT Control Packets. The receiver MUST NOT assume that MQTT Control Packets are aligned on WebSocket frame boundaries.??\n\nAnd RFC 6455 ( https://www.ietf.org/rfc/rfc6455.txt ): \n\n??The WebSocket message does not necessarily correspond to a particular network layer framing, as a fragmented message may be coalesced or split by an intermediary.??\n\nSo I think that ActiveMQ should be fixed to be compliant to the WebSocket and MQTT specifications.\n\nI attached the diff patch file for MQTTSocket which fixes the problem and a new activemq-http module MQTT-WebSocket unit test for this issue (the same of MQTTWSTransportTest but which splits MQTT Frame Packet in multiple WebSocket frames):\n\nMQTTWSPartialFrameConnection.java\nMQTTWSPartialFrameTest.java\n\nWhen writing the unit test I found also a bug in the class org.apache.activemq.transport.ws.MQTTWSConnection.java. \nAll the occurrences of: \n\n{code:java}\nByteSequence payload = wireFormat.marshal(command.encode());\nconnection.getRemote().sendBytes(ByteBuffer.wrap(payload.data));\n{code}\n \nshould be replaced with:\n\n{code:java}\nByteSequence payload = wireFormat.marshal(command.encode());\nconnection.getRemote().sendBytes(ByteBuffer.wrap(payload.data, payload.offset, payload.length));\n{code}\n\nThat is because of the payload.data bytes array buffer in ByteSequenze is bigger than the real MQTT frame packed bytes size, so sending all the payload.data bytes array, ActiveMQ receives much more extra zero-extra bytes. With the current implementation, those extra zero-bytes are ignored and this makes wrongly passes the test (while it should fail because there are \"extra bytes\" which doesn't respect the MQTT protocol).\n\nI attached also the diff patch file for the MQTTWSConnection file.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12869219","id":"12869219","filename":"MQTTSocket-patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=grayra","name":"grayra","key":"grayra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Geri","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-22T09:03:22.491+0000","size":6224,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12869219/MQTTSocket-patch.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12869222","id":"12869222","filename":"MQTTWSConnection-patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=grayra","name":"grayra","key":"grayra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Geri","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-22T09:03:22.515+0000","size":1689,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12869222/MQTTWSConnection-patch.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12869220","id":"12869220","filename":"MQTTWSPartialFrameConnection.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=grayra","name":"grayra","key":"grayra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Geri","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-22T09:03:22.501+0000","size":10466,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12869220/MQTTWSPartialFrameConnection.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12869221","id":"12869221","filename":"MQTTWSPartialFrameTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=grayra","name":"grayra","key":"grayra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Geri","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-22T09:03:22.507+0000","size":7540,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12869221/MQTTWSPartialFrameTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"MQTT over WebSocket doesn't work when WebSocket data frame contains partial or multiple MQTT control packets","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=grayra","name":"grayra","key":"grayra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Geri","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=grayra","name":"grayra","key":"grayra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Geri","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10430","value":"Patch","id":"10430"}],"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13073792/comment/16019320","id":"16019320","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=grayra","name":"grayra","key":"grayra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Geri","active":true,"timeZone":"Etc/UTC"},"body":"Diff patch files and unit test","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=grayra","name":"grayra","key":"grayra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Geri","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-22T09:03:22.520+0000","updated":"2017-05-22T09:03:22.520+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13073792/comment/16019777","id":"16019777","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit e69367fbc329aa66a90e33a917b0d4ccd86c015e in activemq's branch refs/heads/master from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=e69367f ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6680\n\nFix handling of incoming MQTT binary data over WS.  The handler should\nuse the MQTTCodec to ensure that partial or packed frames are fully\nprocessed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-22T16:27:45.943+0000","updated":"2017-05-22T16:27:45.943+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13073792/comment/16019778","id":"16019778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit bf395fcdb3d63a3af48494cbec86734ed8867a90 in activemq's branch refs/heads/activemq-5.14.x from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=bf395fc ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6680\n\nFix handling of incoming MQTT binary data over WS.  The handler should\nuse the MQTTCodec to ensure that partial or packed frames are fully\nprocessed\n(cherry picked from commit e69367fbc329aa66a90e33a917b0d4ccd86c015e)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-22T16:28:08.174+0000","updated":"2017-05-22T16:28:08.174+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6680/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3fa93:"}}