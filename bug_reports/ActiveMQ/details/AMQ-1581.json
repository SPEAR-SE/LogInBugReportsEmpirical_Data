{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482293","self":"https://issues.apache.org/jira/rest/api/2/issue/12482293","key":"AMQ-1581","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-02-07T10:03:09.200+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 07 10:03:09 UTC 2008","customfield_12310420":"95835","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_61946416_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-02-07T10:03:09.232+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1581/watchers","watchCount":1,"isWatching":false},"created":"2008-02-06T16:50:42.816+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-02-07T10:03:09.217+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"In working with PooledConnections, I've found that there is a timing race condition that can occur on the initialization of new ConnectionPool objects.  The ConnectionPool object adds a custom TransportListener, which implements the onException method, in order to be informed when the transport has failed, so that it can properly execute its 'expiredCheck' method, and allow the PooledConnectionFactory to remove it from the ConnectionPool....\n\nIn the case of using an underlying FailoverTransport, which sets the maxReconnectAttempts to something small, such as \"2\", then it's possible that the FailoverTransport could fail prior to the ConnectionPool object completing it's own initialization, and thus prior to it's adding it's TransportListener to the connection.  I would expect there are other transports that could also fail immediately and have the same behavior.\n\nThis scenario is readily reproducible in the case where the client is started up with no broker available.\n\nI've found a solution by adding a simple check after the call to addTransportListener, to check for any prior transport failed, by calling 'connection.isTransportFailed()', and setting the 'hasFailed' flag if true.  This will update the flag for those cases that did not successfully add the transport listener prior to that initial failure.\n\nWithout this fix, the ConnectionPool is unusable, in that the underlying connection will never be evicted to from the PooledConnectionFactory....This is especially pronounced if the idleTimeout is set to 0, and it never recovers.\n\nJason","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460964","id":"12460964","filename":"ConnectionPool.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-07T05:54:45.626+0000","size":8147,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460964/ConnectionPool.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460842","id":"12460842","filename":"FailoverTransport.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-07T05:54:45.784+0000","size":27425,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460842/FailoverTransport.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161753","customfield_12312823":null,"summary":"PooledConnections don't initialize correctly when broker not available (causes problems with Failover)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"5.1-SNAPSHOT","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482293/comment/12939346","id":"12939346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"body":"I've included a patch built against a recent 5.1-SNAPSHOT source (svn rev 618082)\n\nThe file ConnectionPool.java, contains part of my fix for this issue.\nThe file FailoverTransport.java, includes fixes for 4 issues, including part of my fix for this issue.\n\nThe other issues that this patch includes fixes for are:\n\nAMQ-1116\nAMQ-1575\nAMQ-1577\nAMQ-1581\n\nI've added comments in the code that clearly indicate which sections apply to which issue, so you can easily take edit to include only the fixes you want specifically.\n\nJason","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-07T05:54:45.800+0000","updated":"2008-02-07T05:54:45.800+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482293/comment/12936630","id":"12936630","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Fixed by svn revision 619336","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-02-07T10:03:09.200+0000","updated":"2008-02-07T10:03:09.200+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1581/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s1pj:"}}