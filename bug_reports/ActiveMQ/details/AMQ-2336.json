{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483814","self":"https://issues.apache.org/jira/rest/api/2/issue/12483814","key":"AMQ-2336","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2009-07-31T12:48:41.859+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Mar 07 22:12:04 UTC 2011","customfield_12310420":"46510","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_50496275806_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-03-07T22:12:04.426+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2336/watchers","watchCount":4,"isWatching":false},"created":"2009-07-31T11:27:28.645+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-03-07T22:12:04.437+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Here are the steps to reproduce de problem:\n\n   - redeliveryPolicy configured in ActiveMQConnectionFactory as initialRedeliveryDelay 10000, maximumRedeliveries 6, useExponentialBackOff true, backOffMultiplier 3. With these settings, messages, in case of error, stays in the queue several minutes.\n   - DefaultMessageListenerContainer with concurrentConsumers, maxConcurrentConsumers set to 1, sessionTransacted=true, and cacheLevel CACHE_CONSUMER\n   - We introduce a \"bad\" message in a queue (configured to cause a RuntimeException in the MDP associated with the queue). The message waits in the queue to be redelivered again (seen in jconsole)\n   - We introduce a \"good\" message in a queue. The MDP associated with the queue should process this message inmediatly with no exception, but instead, the message is not been processed until last redelivery of the \"bad\" message, and it happens several minutes later. When this happens, message is processed Ok.\n\n   This problem can cause queues to grow unnecessarily if few messages are waiting to be redelivered. What I expected to happen is messages being processed as they arrive if  there is a consumer available, but it seems consumers with a rollback in a transaction are not available until the rollbacked  message is processed again and finally sent to DLQ.\n\n   In addition, in Activemq version 5.2.0, when I remove consumers while waiting for next redelivery of the message, broker throws this exception (this not happens with 5.3-SNAPSHOT):\n\n  30 jul 2009 14:17:45,140 ERROR [ActiveMQ Transport: tcp:///127.0.0.1:3656] org.apache.activemq.broker.TransportConnection.Service  - sync error occurred:\njavax.jms.JMSException: Transaction 'TX:ID:mymachine-4579-1248953104078-0:5207:52' has not been started.\njavax.jms.JMSException: Transaction 'TX:ID:mymachine-4579-1248953104078-0:5207:52' has not been started.\n       at org.apache.activemq.broker.TransactionBroker.getTransaction(TransactionBroker.java:270)\n       at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:190)\n       at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n       at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n       at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n       at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)\n       at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:456)\n       at org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)\n       at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)\n       at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)\n       at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n       at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)\n       at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)\n       at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n       at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)\n       at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)\n       at java.lang.Thread.run(Thread.java:595\n\n   ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172146","customfield_12312823":null,"summary":"Redeliveried messages stops consumers from going on consuming the rest of messages in the queue","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=drodriguez","name":"drodriguez","key":"drodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diego Rodriguez","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=drodriguez","name":"drodriguez","key":"drodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diego Rodriguez","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows XP, Java  1.5.0_11\nSpring 2.5.6 DefaultMessageListenerContainer","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483814/comment/12940574","id":"12940574","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"this is message ordering in action, it is expected behavior. The good message cannot be received till the bad message is discarded. A second consumer will see the new messages, but a good message cannot jump a bad message in the queue for a particular consumer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-07-31T12:48:41.859+0000","updated":"2009-07-31T12:48:41.859+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483814/comment/12940876","id":"12940876","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=drodriguez","name":"drodriguez","key":"drodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diego Rodriguez","active":true,"timeZone":"Etc/UTC"},"body":"Ok in the case of just 1 consumer. My intention was to simplify the reproduction of the problem\n\nIt still happens with 2 consumers and this sequence (the test pattern is the same, send a message to the queue and watch in jconsole and log if it is processed and queue size):\n\n   - 1 bad message: message stays in the queue waiting for redelivery. Queue size : 1\n   - 1 good message: it is processed ok.  Queue size : 1\n   - 1 good message: it is NOT processed. Queue size : 2\n   - 1 good message: it is processed ok.  Queue size : 2\n   - 1 good message: it is NOT processed. Queue size : 3\n   - 1 good message: it is processed ok.  Queue size : 3\n   - 1 good message: it is processed ok.  Queue size : 3\n   - 1 good message: it is processed ok.  Queue size : 3\n   ...................... \n\n   With 3 consumers\n\n   - 1 bad message: message stays in the queue waiting for redelivery. Queue size : 1\n   - 1 good message: it is processed ok.  Queue size : 1\n   - 1 good message: it is processed ok.  Queue size : 1\n   - 1 good message: it is NOT processed. Queue size : 2\n   - 1 good message: it is processed ok.  Queue size : 2\n   - 1 good message: it is processed ok.  Queue size : 2\n   - 1 good message: it is NOT processed. Queue size : 3\n   - 1 good message: it is processed ok.  Queue size : 3\n   - 1 good message: it is processed ok.  Queue size : 3\n   - 1 good message: it is processed ok.  Queue size : 3\n   \n\n   This seems odd to me, first because not all messages got stucked in the queue and every new message after queue size reaches 3 messages is processed inmediatly.\n\n   I'm going to install ActiveMQ in a production system in a few days and I am worried about the fact of messages being stucked in the queue for minutes because of redeliveries.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=drodriguez","name":"drodriguez","key":"drodriguez","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Diego Rodriguez","active":true,"timeZone":"Etc/UTC"},"created":"2009-07-31T14:56:22.298+0000","updated":"2009-07-31T14:56:22.298+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483814/comment/13003649","id":"13003649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This is working as designed for a transacted consumer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-03-07T22:12:04.434+0000","updated":"2011-03-07T22:12:04.434+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2336/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ttuv:"}}