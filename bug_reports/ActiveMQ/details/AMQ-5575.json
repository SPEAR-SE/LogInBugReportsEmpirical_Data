{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12774156","self":"https://issues.apache.org/jira/rest/api/2/issue/12774156","key":"AMQ-5575","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Mar 23 14:14:08 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5575/watchers","watchCount":1,"isWatching":false},"created":"2015-02-11T10:03:22.587+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-03-23T14:14:08.618+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The setup:\n- ActiveMQ with the default configuration providing one queue.\n- WebLogic server having\n  - a \"Foreign Server\" JMS module configured pointing to the ActiveMQ's queue\n  - a simple EJB3 MDB hooked up to this queue via XAConnectionFactory.\n\nThe issue is always reproducable as follows:\n1. Shut down WebLogic\n2. Start up ActiveMQ\n3. Put a message (M1) into ActiveMQ's queue (e.g. via web frontend)\n4. Start up WebLogic (including the simple EJB3 MDB deployment)\n5. You'll see that the message M1 is consumed. The MDB logs it and the message vanishes from the ActiveMQ web frontend => OK\n6. Put another message (M2) into ActiveMQ's queue.\n7. Put a third message (M3) into ActiveMQ's queue.\n\nExpected behavior:\nM2 and M3 are consumed by the MDB on WebLogic.\n\nActual behavior:\nM2 is getting \"stuck\".\nM3 is consumed correctly.\nThe next 15 messages you add to the ActiveMQ queue are consumed correctly.\nThe next message (MX) leads to a consumption of the previously stuck message (M2) and the current message (MX).\nAfter that, the behavior repeats with scenario step 6 above.\n\nSome further notes:\n1. Why 15/16 messages until the stuck message is consumed? Because ActiveMQ shows 16 listeners when WebLogic is started up.\n2. I can reproduce the issue every time.\n3. It occurs with version 5.8.0, 5.10.0 and 5.11.0 of activemq (of course also using the matching activemq-client jar in WebLogic).\n4. If you leave out step 3 of the scenario (means: ensure that ActiveMQ's queue is empty before WebLogic is started up), then everything is fine and no message is getting stuck.\n5. Good news is, that no message is getting lost without being consumed. But it's still quite annoying in my current integration project I'm working on. :-)\n\nCurrently I'm trying to add trace logging into the activemq-client to get a better idea on what's going on. What I can tell so far is, that the message M2 is indeed received by the client and enqueued into a SimplePriorityMessageDispatchChannel instance correctly. But it looks like that the dequeue() call is done on a different instance in this scenario.\nFurther I see, that some kind of \"round robin\" happens in the usage of these Channel instances and that might be the reason, why M2 is eventually consumed together with the 16th next message.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Stuck message in ActiveMQ after WebLogic (incl. MDB) startup","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slash","name":"slash","key":"slash","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernhard Trummer","active":true,"timeZone":"Europe/Vienna"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slash","name":"slash","key":"slash","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernhard Trummer","active":true,"timeZone":"Europe/Vienna"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux (Debian squeeze)\nWebLogic Server 10.3.6.0 with a \"Foreign Server\" JMS module pointing to ActiveMQ.\nWebLogic and ActiveMQ running locally.","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12774156/comment/14315932","id":"14315932","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slash","name":"slash","key":"slash","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernhard Trummer","active":true,"timeZone":"Europe/Vienna"},"body":"Feel free to request any additional information from me.\nIf desired, I also can provide the WebLogic MDB artifact and configuration instructions on how to set up the Foreign Destination.\nI even could provide a complete zip of my WebLogic installation via a separate channel, because I can't and won't attach it here. :-)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slash","name":"slash","key":"slash","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernhard Trummer","active":true,"timeZone":"Europe/Vienna"},"created":"2015-02-11T10:06:44.116+0000","updated":"2015-02-11T10:06:44.116+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12774156/comment/14324180","id":"14324180","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slash","name":"slash","key":"slash","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernhard Trummer","active":true,"timeZone":"Europe/Vienna"},"body":"Bug is reproducable when the MDB:\n- has the @TransactionAttribute annotation set to TransactionAttributeType.REQUIRED.\n- uses the mapped XAConnectionFactory as connectionFactoryJndiName @ActivationConfigProperty.\n\nHowever, the bug does not occur when the MDB is non-XA:\n- has the @TransactionAttribute annotation set to TransactionAttributeType.NOT_SUPPORTED.\n- uses the mapped ConnectionFactory as connectionFactoryJndiName @ActivationConfigProperty.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slash","name":"slash","key":"slash","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernhard Trummer","active":true,"timeZone":"Europe/Vienna"},"created":"2015-02-17T13:46:54.080+0000","updated":"2015-02-17T13:46:54.080+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12774156/comment/14375933","id":"14375933","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slash","name":"slash","key":"slash","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernhard Trummer","active":true,"timeZone":"Europe/Vienna"},"body":"Further update. The issue does not occur, when reducing the threads of the MDB from 16 to 1.\nI used the following weblogic-ejb-jar.xml for testing:\n{code}\n<weblogic-ejb-jar>\n    <weblogic-enterprise-bean>\n        <ejb-name>MyListenerEjbBean</ejb-name>\n        <dispatch-policy>WorkManager-0</dispatch-policy>\n    </weblogic-enterprise-bean>\n    <work-manager>\n        <name>WorkManager-0</name>\n        <max-threads-constraint>\n            <name>WorkManager-Constraint-0</name>\n            <count>1</count>\n        </max-threads-constraint>\n        <ignore-stuck-threads>true</ignore-stuck-threads>\n    </work-manager>\n</weblogic-ejb-jar>\n{code}\n\nHowever, as soon as the thread count is bigger than 1, the bug is reproducable.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slash","name":"slash","key":"slash","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bernhard Trummer","active":true,"timeZone":"Europe/Vienna"},"created":"2015-03-23T14:14:08.618+0000","updated":"2015-03-23T14:14:08.618+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5575/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i25h2n:"}}