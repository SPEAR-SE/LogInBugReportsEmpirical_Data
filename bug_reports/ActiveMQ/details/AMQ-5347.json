{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12739972","self":"https://issues.apache.org/jira/rest/api/2/issue/12739972","key":"AMQ-5347","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-10-31T16:46:27.019+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Oct 31 19:32:55 UTC 2014","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_4563814658_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-10-31T16:46:26.976+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5347/watchers","watchCount":3,"isWatching":false},"created":"2014-09-08T21:02:52.376+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-10-31T19:32:55.643+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The new flag in 5.10 that ensures the JMSRedelivered flag persists across broker restarts does not work correctly when an exception occurs when attempting to write the \"message update\" to disk before the restart.  In that case, messages can be assigned to receivers, the broker can be restarted, and then the messages are re-assigned to receivers and do not include the JMSRedelivered flag as expected.  I will attach a unit test and proposed fix to illustrate the problem.\n\nAlso, here is additional information I had sent to the mailing list:\nWhen using the new option persisteJMSRedelivered (to ensure the redelivered flag is set correctly on potentially duplicate messages that are re-dispatched by the broker even after a restart): <policyEntry queue=\">\" persistJMSRedelivered=\"true\"></policyEntry>\n\nthere is still a case where a message can be re-sent and will not be marked as redelivered.  I can open a JIRA and probably create a unit test but it is pretty clear from the pasted code below where the exception is getting swallowed.  Would the preferred fix be to update the broker interface and make preProcessDispatch throw an IOException or would it be better to add a new field to the MessageDispatch class to indicate an exception occurred and leave the interface alone?\n\nThe specific case when this can happen is when a MessageStore returns an exception during the updateMessage call, which then gets swallowed (and an ERROR logged) and still allows the message to be dispatched to the consumer.  The exception seems like it should actually propagate out of the preProcessDispatch function in RegionBroker as shown below, but this would require changing the Broker interface and making the void preProcessDispatch function throw an IOException.\n\n//RegionBroker.java\n    @Override\n    public void preProcessDispatch(MessageDispatch messageDispatch) {\n        Message message = messageDispatch.getMessage();\n        if (message != null) {\n            long endTime = System.currentTimeMillis();\n            message.setBrokerOutTime(endTime);\n            if (getBrokerService().isEnableStatistics()) {\n                long totalTime = endTime - message.getBrokerInTime();\n                ((Destination) message.getRegionDestination()).getDestinationStatistics().getProcessTime().addTime(totalTime);\n            }\n            if (((BaseDestination) message.getRegionDestination()).isPersistJMSRedelivered() && !message.isRedelivered() && message.isPersistent()) {\n                final int originalValue = message.getRedeliveryCounter();\n                message.incrementRedeliveryCounter();\n                try {\n                    ((BaseDestination) message.getRegionDestination()).getMessageStore().updateMessage(message);\n                } catch (IOException error) {\n                    LOG.error(\"Failed to persist JMSRedeliveryFlag on {} in {}\", message.getMessageId(), message.getDestination(), error);\n                } finally {\n                    message.setRedeliveryCounter(originalValue);\n                }\n            }\n        }\n    }\n\n//TransportConnection.java\n    protected void processDispatch(Command command) throws IOException {\n        MessageDispatch messageDispatch = (MessageDispatch) (command.isMessageDispatch() ? command : null);\n        try {\n            if (!stopping.get()) {\n                if (messageDispatch != null) {\n                    broker.preProcessDispatch(messageDispatch);\n                }\n                dispatch(command);  //This code will dispatch the message whether or not the updateMessage function actually worked\n            }\n        ...\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12667243","id":"12667243","filename":"AMQ5347.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-09-08T21:07:01.356+0000","size":8133,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12667243/AMQ5347.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12667244","id":"12667244","filename":"RedeliveryRestartWithExceptionTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-09-08T21:07:01.361+0000","size":13616,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12667244/RedeliveryRestartWithExceptionTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"persistJMSRedelivered flag doesn't work correctly when exceptions occur","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12739972/comment/14126095","id":"14126095","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"body":"Attached a proposed patch against the latest code on github for the persistJMSRedelivered issue.\n\nAlso, attached a new unit test that passes when run from activemq-unit-tests after the fix is applied.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-09-08T21:07:01.367+0000","updated":"2014-09-08T21:07:01.367+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12739972/comment/14192035","id":"14192035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"thanks for the test case and patch. I decided to keep the broker interface as is b/c lots of folks have their own plugins so the exception is propagated via a runtime exception. The exception kills the connection and hence the consumer and the delivery failure is properly accounted for.\nA variant of your test where the broker remains alive exposed another issue with the redelivery flag and dispatch ordering. That is also sorted with\nhttp://git-wip-us.apache.org/repos/asf/activemq/commit/52e1a05a ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-31T16:46:27.019+0000","updated":"2014-10-31T16:46:27.019+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12739972/comment/14192307","id":"14192307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"body":"Great thanks.  Killing the connection was the important thing and the runtime exception looks like it accomplishes that.  Originally, I looked at a way to sneak the exception through the interface since changing would impact so many files/plugins but ended up just submitting the patch so that the intent was clear.  Glad you were able to get this in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-10-31T19:32:55.643+0000","updated":"2014-10-31T19:32:55.643+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5347/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1zt33:"}}