{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12543079","self":"https://issues.apache.org/jira/rest/api/2/issue/12543079","key":"AMQ-3725","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-02-18T06:39:43.147+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat Jun 07 21:18:22 UTC 2014","customfield_12310420":"228365","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_66980092374_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-04-03T00:32:13.543+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3725/watchers","watchCount":11,"isWatching":false},"created":"2012-02-17T18:57:21.202+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318549","id":"12318549","name":"5.5.1","archived":false,"released":true,"releaseDate":"2011-10-16"}],"issuelinks":[{"id":"12497088","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12497088","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13050564","key":"AMQ-6625","self":"https://issues.apache.org/jira/rest/api/2/issue/13050564","fields":{"summary":"IOException in kahaDB needs to pause pending IOExceptionHandler intervention","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-03-13T13:41:36.254+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"An issue can arise that causes the broker to terminate when using kahaDB with a SAN, when the SAN fails over.  In this case the failover process is seamless however, on fail back there is a 2-3 sec delay where writes are blocked and the broker terminates.  With the JDBC datastore a similar situation can be handled by using the IOExceptionHandler.  However with kahaDB, when this same IOExceptionHandler is added it prevents the broker from terminating but kahaDB retains an invalid index.\n\n{code}\n INFO | ActiveMQ JMS Message Broker (Broker1, ID:macbookpro-251a.home-56915-1328715089252-0:1) started\n INFO | jetty-7.1.6.v20100715\n INFO | ActiveMQ WebConsole initialized.\n INFO | Initializing Spring FrameworkServlet 'dispatcher'\n INFO | ActiveMQ Console at http://0.0.0.0:8161/admin\n INFO | ActiveMQ Web Demos at http://0.0.0.0:8161/demo\n INFO | RESTful file access application at http://0.0.0.0:8161/fileserver\n INFO | FUSE Web Console at http://0.0.0.0:8161/console\n INFO | Started SelectChannelConnector@0.0.0.0:8161\nERROR | KahaDB failed to store to Journal\njava.io.SyncFailedException: sync failed\n\tat java.io.FileDescriptor.sync(Native Method)\n\tat org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:382)\n\tat org.apache.kahadb.journal.DataFileAppender$2.run(DataFileAppender.java:203)\n INFO | Ignoring IO exception, java.io.SyncFailedException: sync failed\njava.io.SyncFailedException: sync failed\n\tat java.io.FileDescriptor.sync(Native Method)\n\tat org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:382)\n\tat org.apache.kahadb.journal.DataFileAppender$2.run(DataFileAppender.java:203)\nERROR | Checkpoint failed\njava.io.SyncFailedException: sync failed\n\tat java.io.FileDescriptor.sync(Native Method)\n\tat org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:382)\n\tat org.apache.kahadb.journal.DataFileAppender$2.run(DataFileAppender.java:203)\n INFO | Ignoring IO exception, java.io.SyncFailedException: sync failed\njava.io.SyncFailedException: sync failed\n\tat java.io.FileDescriptor.sync(Native Method)\n\tat org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:382)\n\tat org.apache.kahadb.journal.DataFileAppender$2.run(DataFileAppender.java:203)\nERROR | KahaDB failed to store to Journal\njava.io.FileNotFoundException: /Volumes/NAS-01/data/kahadb/db-1.log (No such file or directory)\n\tat java.io.RandomAccessFile.open(Native Method)\n\tat java.io.RandomAccessFile.<init>(RandomAccessFile.java:216)\n\tat org.apache.kahadb.journal.DataFile.openRandomAccessFile(DataFile.java:70)\n\tat org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:324)\n\tat org.apache.kahadb.journal.DataFileAppender$2.run(DataFileAppender.java:203)\n INFO | Ignoring IO exception, java.io.FileNotFoundException: /Volumes/NAS-01/data/kahadb/db-1.log (No such file or directory)\njava.io.FileNotFoundException: /Volumes/NAS-01/data/kahadb/db-1.log (No such file or directory)\n\tat java.io.RandomAccessFile.open(Native Method)\n\tat java.io.RandomAccessFile.<init>(RandomAccessFile.java:216)\n\tat org.apache.kahadb.journal.DataFile.openRandomAccessFile(DataFile.java:70)\n\tat org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:324)\n\tat org.apache.kahadb.journal.DataFileAppender$2.run(DataFileAppender.java:203)\nERROR | KahaDB failed to store to Journal\njava.io.FileNotFoundException: /Volumes/NAS-01/data/kahadb/db-1.log (No such file or directory)\n\tat java.io.RandomAccessFile.open(Native Method)\n\tat java.io.RandomAccessFile.<init>(RandomAccessFile.java:216)\n\tat org.apache.kahadb.journal.DataFile.openRandomAccessFile(DataFile.java:70)\n\tat org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:324)\n\tat org.apache.kahadb.journal.DataFileAppender$2.run(DataFileAppender.java:203)\n INFO | Ignoring IO exception, java.io.FileNotFoundException: /Volumes/NAS-01/data/kahadb/db-1.log (No such file or directory)\njava.io.FileNotFoundException: /Volumes/NAS-01/data/kahadb/db-1.log (No such file or directory)\n\tat java.io.RandomAccessFile.open(Native Method)\n\tat java.io.RandomAccessFile.<init>(RandomAccessFile.java:216)\n\tat org.apache.kahadb.journal.DataFile.openRandomAccessFile(DataFile.java:70)\n\tat org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:324)\n\tat org.apache.kahadb.journal.DataFileAppender$2.run(DataFileAppender.java:203)\n WARN | Transport failed: java.io.EOFException\n WARN | Transport failed: java.io.EOFException\n INFO | KahaDB: Recovering checkpoint thread after death\nERROR | Checkpoint failed\njava.io.IOException: Input/output error\n\tat java.io.RandomAccessFile.write(Native Method)\n\tat java.io.RandomAccessFile.writeLong(RandomAccessFile.java:1001)\n\tat org.apache.kahadb.page.PageFile.writeBatch(PageFile.java:1006)\n\tat org.apache.kahadb.page.PageFile.flush(PageFile.java:484)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.checkpointUpdate(MessageDatabase.java:1290)\n\tat org.apache.activemq.store.kahadb.MessageDatabase$10.execute(MessageDatabase.java:768)\n\tat org.apache.kahadb.page.Transaction.execute(Transaction.java:760)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.checkpointCleanup(MessageDatabase.java:766)\n\tat org.apache.activemq.store.kahadb.MessageDatabase$3.run(MessageDatabase.java:315)\n INFO | Ignoring IO exception, java.io.IOException: Input/output error\njava.io.IOException: Input/output error\n\tat java.io.RandomAccessFile.write(Native Method)\n\tat java.io.RandomAccessFile.writeLong(RandomAccessFile.java:1001)\n\tat org.apache.kahadb.page.PageFile.writeBatch(PageFile.java:1006)\n\tat org.apache.kahadb.page.PageFile.flush(PageFile.java:484)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.checkpointUpdate(MessageDatabase.java:1290)\n\tat org.apache.activemq.store.kahadb.MessageDatabase$10.execute(MessageDatabase.java:768)\n\tat org.apache.kahadb.page.Transaction.execute(Transaction.java:760)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.checkpointCleanup(MessageDatabase.java:766)\n\tat org.apache.activemq.store.kahadb.MessageDatabase$3.run(MessageDatabase.java:315)\n INFO | KahaDB: Recovering checkpoint thread after death\nERROR | Checkpoint failed\njava.io.IOException: Input/output error\n\tat java.io.RandomAccessFile.write(Native Method)\n\tat java.io.RandomAccessFile.writeLong(RandomAccessFile.java:1001)\n\tat org.apache.kahadb.page.PageFile.writeBatch(PageFile.java:1006)\n\tat org.apache.kahadb.page.PageFile.flush(PageFile.java:484)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.checkpointUpdate(MessageDatabase.java:1290)\n\tat org.apache.activemq.store.kahadb.MessageDatabase$10.execute(MessageDatabase.java:768)\n\tat org.apache.kahadb.page.Transaction.execute(Transaction.java:760)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.checkpointCleanup(MessageDatabase.java:766)\n\tat org.apache.activemq.store.kahadb.MessageDatabase$3.run(MessageDatabase.java:315)\n INFO | Ignoring IO exception, java.io.IOException: Input/output error\njava.io.IOException: Input/output error\n\tat java.io.RandomAccessFile.write(Native Method)\n\tat java.io.RandomAccessFile.writeLong(RandomAccessFile.java:1001)\n\tat org.apache.kahadb.page.PageFile.writeBatch(PageFile.java:1006)\n\tat org.apache.kahadb.page.PageFile.flush(PageFile.java:484)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.checkpointUpdate(MessageDatabase.java:1290)\n\tat org.apache.activemq.store.kahadb.MessageDatabase$10.execute(MessageDatabase.java:768)\n\tat org.apache.kahadb.page.Transaction.execute(Transaction.java:760)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.checkpointCleanup(MessageDatabase.java:766)\n\tat org.apache.activemq.store.kahadb.MessageDatabase$3.run(MessageDatabase.java:315)\n WARN | Transport failed: java.io.EOFException\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12608043","id":"12608043","filename":"AMQ-3725-10112013.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"created":"2013-10-11T17:52:10.381+0000","size":54806,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12608043/AMQ-3725-10112013.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59725","customfield_12312823":null,"summary":"Kahadb error during SAN failover delayed write - Allow kahaDB to recover in a similar manner as the JDBC store using the IOExceptionHandler","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jsherman1","name":"jsherman1","key":"jsherman1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jsherman1&avatarId=13244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jsherman1&avatarId=13244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jsherman1&avatarId=13244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jsherman1&avatarId=13244"},"displayName":"Jason Sherman","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jsherman1","name":"jsherman1","key":"jsherman1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jsherman1&avatarId=13244","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jsherman1&avatarId=13244","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jsherman1&avatarId=13244","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jsherman1&avatarId=13244"},"displayName":"Jason Sherman","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13210843","id":"13210843","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"Jason,we are going to set up master-slave brokers with SAN but get into the trouble of synchronization.\nWe mount SAN to the same path directory on two servers while operations such as creating or deleting files in the shared directory seems not synchronous. \nOne server cannot see changes made by the other if not remounting manually.\nI know that even NFS can work well but it's not recommended to be the shared storage with AMQ.\nCan you share some experience about setting up the shared storage with SAN?\nThanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2012-02-18T06:39:43.147+0000","updated":"2012-02-18T06:39:43.147+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13443030","id":"13443030","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"body":"We have implemented a GFS based solution with i/o fencing (also called disk fencing). I/O fencing is used to avoid this \"split brain\" scenario where both active and passive servers write to the disk.\n\n\"One server cannot see changes made by the other if not remounting manually.\" . Could you please make this sentence more clear?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sreepanchajanyam","name":"sreepanchajanyam","key":"sreepanchajanyam","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sree Panchajanyam D","active":true,"timeZone":"Asia/Kolkata"},"created":"2012-08-28T08:38:10.106+0000","updated":"2012-08-28T08:38:10.106+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13578235","id":"13578235","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"body":"We ran into a similar issue but we a missing some of the exceptions shown in the description. We are running 5.7.0\n\n{noformat} \nKahaDB failed to store to Journal | org.apache.activemq.store.kahadb.MessageDatabase | ConcurrentQueueStoreAndDispatch\njava.io.SyncFailedException: sync failed\n        at java.io.FileDescriptor.sync(Native Method)\n        at org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:367)\n        at org.apache.kahadb.journal.DataFileAppender$1.run(DataFileAppender.java:188)\n2013-02-13 17:07:57,427 | INFO  | Stopping the broker due to exception, java.io.SyncFailedException: sync failed | org.apache.activemq.util.DefaultIOExceptionHandler | ConcurrentQueueStoreAndDispatch\njava.io.SyncFailedException: sync failed\n        at java.io.FileDescriptor.sync(Native Method)\n        at org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:367)\n        at org.apache.kahadb.journal.DataFileAppender$1.run(DataFileAppender.java:188)\n2013-02-13 17:07:57,517 | INFO  | Apache ActiveMQ 5.7.0 (habroker, ID:HOSTNAME-35138-1360038011880-0:1) is shutting down | org.apache.activemq.broker.BrokerService | Stopping the broker due to IO exception\n\n{noformat} \n\nAfter this, AMQ immediately went into shutdown mode. We did not see the FileNotFoundException, messages about checkpoint recovery with the IOException or the transport failures from EOFException. We did see the transport failures on the clients. The Java client also had an EOFException. Our C# client which is using NMS and gave the message \"Unable to read beyond the end of the stream\".\n\nWhen we restarted AMQ, it would immediately shut down due to the journal files missing. We set the parameter on KahaDB in activemq.xml ignoreMissingJournalfiles=true. This time AMQ came up and said that it lost 33 messages.\n\nWe then saw a number of errors (they actually show up a number of times with maybe three variations almost like multiple loggers are kicking off):\n\n{noformat}\n2013-02-13 17:46:14,892 | ERROR | Problem retrieving message for browse | org.apache.activemq.broker.region.Queue | ActiveMQ Broker[habroker] Scheduler\njava.lang.RuntimeException: java.lang.RuntimeException: java.io.IOException: Invalid location: 131:3886117, : java.lang.NegativeArraySizeException\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.reset(AbstractStoreCursor.java:113)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.reset(StoreQueueCursor.java:157)\n\tat org.apache.activemq.broker.region.Queue.doBrowse(Queue.java:1066)\n\tat org.apache.activemq.broker.region.Queue.expireMessages(Queue.java:832)\n\tat org.apache.activemq.broker.region.Queue.access$100(Queue.java:98)\n\tat org.apache.activemq.broker.region.Queue$2.run(Queue.java:138)\n\tat org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)\n\tat java.util.TimerThread.mainLoop(Timer.java:534)\n\tat java.util.TimerThread.run(Timer.java:484)\nCaused by: java.lang.RuntimeException: java.io.IOException: Invalid location: 131:3886117, : java.lang.NegativeArraySizeException\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:277)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.reset(AbstractStoreCursor.java:110)\n\t... 8 more\nCaused by: java.io.IOException: Invalid location: 131:3886117, : java.lang.NegativeArraySizeException\n\tat org.apache.kahadb.journal.DataFileAccessor.readRecord(DataFileAccessor.java:92)\n\tat org.apache.kahadb.journal.Journal.read(Journal.java:604)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:879)\n\tat org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:1030)\n\tat org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore$4.execute(KahaDBStore.java:558)\n\tat org.apache.kahadb.page.Transaction.execute(Transaction.java:769)\n\tat org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.recoverNextMessages(KahaDBStore.java:547)\n\tat org.apache.activemq.store.ProxyMessageStore.recoverNextMessages(ProxyMessageStore.java:106)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:97)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:274)\n\t... 9 more\n{noformat}\n\nThis all happens during an 8 second period. Then... about 13 minutes later we see some more:\n\n{noformat}\n2013-02-13 17:59:55,562 | ERROR | Failed to page in more queue messages  | org.apache.activemq.broker.region.Queue | ActiveMQ BrokerService[habroker] Task-38\njava.lang.RuntimeException: java.lang.RuntimeException: java.io.IOException: Invalid location: 125:11971180, : java.lang.NegativeArraySizeException\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.hasNext(AbstractStoreCursor.java:150)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.hasNext(StoreQueueCursor.java:131)\n\tat org.apache.activemq.broker.region.Queue.doPageInForDispatch(Queue.java:1766)\n\tat org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1993)\n\tat org.apache.activemq.broker.region.Queue.iterate(Queue.java:1486)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n\tat java.lang.Thread.run(Thread.java:679)\nCaused by: java.lang.RuntimeException: java.io.IOException: Invalid location: 125:11971180, : java.lang.NegativeArraySizeException\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:277)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.hasNext(AbstractStoreCursor.java:147)\n\t... 9 more\nCaused by: java.io.IOException: Invalid location: 125:11971180, : java.lang.NegativeArraySizeException\n\tat org.apache.kahadb.journal.DataFileAccessor.readRecord(DataFileAccessor.java:92)\n\tat org.apache.kahadb.journal.Journal.read(Journal.java:604)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:879)\n\tat org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:1030)\n\tat org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore$4.execute(KahaDBStore.java:558)\n\tat org.apache.kahadb.page.Transaction.execute(Transaction.java:769)\n\tat org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.recoverNextMessages(KahaDBStore.java:547)\n\tat org.apache.activemq.store.ProxyMessageStore.recoverNextMessages(ProxyMessageStore.java:106)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:97)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:274)\n\t... 10 more\n{noformat}\n\nWe haven't seen any more errors since the one above about 6 hours ago. I just pushed 1000 messages through and there were no errors, things seem normal.\n\nWe are not currently sure what may have happened to our SAN or connectivity during this time. We are still analyzing. Will attempt to recreate to understand the best way to mitigate this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-14T08:39:34.034+0000","updated":"2013-02-14T08:39:34.034+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13578539","id":"13578539","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"body":"I was looking at the source for JDBCIOExceptionHandler and it calls setStopStartConnectors(true) from the base class DefaultIOExceptionHandler.\n\nIt seems like the DefaultIOExceptionHandler already has code that would attempt to restart all the connectors. Don't know if this would resolve the issue but seems like we might want to either set stopStartConnectors to true by default or allow it to get set in activemq.xml.\n\nHaven't pulled the repo yet... hopefully the history of this file doesn't indicate that setting this to true is buggy..","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-14T18:11:53.936+0000","updated":"2013-02-14T18:11:53.936+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13578646","id":"13578646","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"body":"We made a build of 5.7.0 with the stopStartConnectors flag set to true in DefaultIOExceptionHandler. Locally, I used a thumb drive as the datadirectory and would get producers and consumers working and then yank it. We reproduced a stack trace a bit more similar to above but still a bit different.\n\n{noformat}\n2013-02-14 11:16:16,032 | ERROR | KahaDB failed to store to Journal | org.apache.activemq.store.kahadb.MessageDatabase | ActiveMQ Transport: tcp:///0:0:0:0:0:0:0:1:54836@61616\njava.io.SyncFailedException: sync failed\n                at java.io.FileDescriptor.sync(Native Method)\n                at org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:367)\n                at org.apache.kahadb.journal.DataFileAppender$1.run(DataFileAppender.java:188)\n2013-02-14 11:16:16,035 | INFO  | Initiating stop/restart of broker transport due to IO exception, java.io.SyncFailedException: sync failed | org.apache.activemq.util.DefaultIOExceptionHandler | ActiveMQ Transport: tcp:///0:0:0:0:0:0:0:1:54836@61616\njava.io.SyncFailedException: sync failed\n                at java.io.FileDescriptor.sync(Native Method)\n                at org.apache.kahadb.journal.DataFileAppender.processQueue(DataFileAppender.java:367)\n                at org.apache.kahadb.journal.DataFileAppender$1.run(DataFileAppender.java:188)\n2013-02-14 11:16:16,041 | INFO  | waiting for broker persistence adapter checkpoint to succeed before restarting transports | org.apache.activemq.util.DefaultIOExceptionHandler | restart transport connectors post IO exception\n2013-02-14 11:16:16,062 | WARN  | Transport Connection to: tcp://0:0:0:0:0:0:0:1:54836 failed: java.io.EOFException | org.apache.activemq.broker.TransportConnection.Transport | ActiveMQ Transport: tcp:///0:0:0:0:0:0:0:1:54836@61616\n2013-02-14 11:16:16,268 | ERROR | KahaDB failed to store to Journal | org.apache.activemq.store.kahadb.MessageDatabase | ActiveMQ Transport: tcp:///0:0:0:0:0:0:0:1:54848@61616\njava.io.IOException: The volume for a file has been externally altered so that the opened file is no longer valid\n                at java.io.RandomAccessFile.readBytes(Native Method)\n                at java.io.RandomAccessFile.read(RandomAccessFile.java:338)\n                at java.io.RandomAccessFile.readFully(RandomAccessFile.java:397)\n                at java.io.RandomAccessFile.readFully(RandomAccessFile.java:377)\n                at org.apache.kahadb.page.PageFile.readPage(PageFile.java:876)\n\n{noformat}\n\nThen we got a loop trying to get a checkpoint before restarting transports:\n\n{noformat}\n2013-02-14 11:16:21,046 | INFO  | KahaDB: Recovering checkpoint thread after death | org.apache.activemq.store.kahadb.MessageDatabase | restart transport connectors post IO exception\n2013-02-14 11:16:21,049 | INFO  | waiting for broker persistence adapter checkpoint to succeed before restarting transports | org.apache.activemq.util.DefaultIOExceptionHandler | restart transport connectors post IO exception\n2013-02-14 11:16:26,055 | ERROR | Checkpoint failed | org.apache.activemq.store.kahadb.MessageDatabase | ActiveMQ Journal Checkpoint Worker\njava.io.IOException: The volume for a file has been externally altered so that the opened file is no longer valid\n                at java.io.RandomAccessFile.write(Native Method)\n                at java.io.RandomAccessFile.writeLong(RandomAccessFile.java:1001)\n                at org.apache.kahadb.page.PageFile.writeBatch(PageFile.java:1077)\n                at org.apache.kahadb.page.PageFile.flush(PageFile.java:515)\n                at org.apache.activemq.store.kahadb.MessageDatabase.checkpointUpdate(MessageDatabase.java:1313)\n                at org.apache.activemq.store.kahadb.MessageDatabase$10.execute(MessageDatabase.java:769)\n                at org.apache.kahadb.page.Transaction.execute(Transaction.java:769)\n                at org.apache.activemq.store.kahadb.MessageDatabase.checkpointCleanup(MessageDatabase.java:767)\n                at org.apache.activemq.store.kahadb.MessageDatabase$3.run(MessageDatabase.java:323)\n2013-02-14 11:16:26,064 | INFO  | waiting for broker persistence adapter checkpoint to succeed before restarting transports | org.apache.activemq.util.DefaultIOExceptionHandler | restart transport connectors post IO exception\n2013-02-14 11:16:31,069 | INFO  | KahaDB: Recovering checkpoint thread after death | org.apache.activemq.store.kahadb.MessageDatabase | restart transport connectors post IO exception\n\n{noformat}\n\nSo it would not automatically come back... I then restarted AMQ and got the following:\n\n{noformat}\n2013-02-14 11:33:46,398 | INFO  | Using Persistence Adapter: KahaDBPersistenceAdapter[E:\\kahadb] | org.apache.activemq.broker.BrokerService | main\n2013-02-14 11:33:47,892 | INFO  | Corrupt journal records found in 'E:\\kahadb\\db-2.log' between offsets: 5576149..6343375 | org.apache.kahadb.journal.Journal | main\n2013-02-14 11:33:47,905 | INFO  | Corrupt journal records found in 'E:\\kahadb\\db-2.log' between offsets: 6351482..6356885 | org.apache.kahadb.journal.Journal | main\n2013-02-14 11:33:56,253 | INFO  | KahaDB is version 4 | org.apache.activemq.store.kahadb.MessageDatabase | main\n2013-02-14 11:33:56,373 | INFO  | Recovering from the journal ... | org.apache.activemq.store.kahadb.MessageDatabase | main\n2013-02-14 11:33:56,643 | INFO  | Recovery replayed 478 operations from the journal in 0.292 seconds. | org.apache.activemq.store.kahadb.MessageDatabase | main\n2013-02-14 11:33:56,702 | INFO  | Scheduler using directory: E:\\habroker\\scheduler | org.apache.activemq.broker.scheduler.SchedulerBroker | main\n2013-02-14 11:33:56,726 | INFO  | Apache ActiveMQ 5.7.0 (habroker, ID:kpc-eng-d27-55891-1360870436389-0:1) is starting | org.apache.activemq.broker.BrokerService | main\n2013-02-14 11:33:56,748 | INFO  | ignoring zero length, partially initialised journal data file: db-1.log number = 1 , length = 0 | org.apache.kahadb.journal.Journal | main\n2013-02-14 11:33:57,343 | INFO  | JobSchedulerStore:E:\\habroker\\scheduler started | org.apache.activemq.broker.scheduler.JobSchedulerStore | main\n{noformat}\n\nThis is a bit different than what we saw in our QA environment where it said it lost 33 messages.\n\nI looked in the history of the file and in 5.5.1, the stopStartConnectors is still false. Not really sure what kicked off the retry in 5.5.1 vs. the broker stop in 5.7.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-14T20:32:57.139+0000","updated":"2013-02-14T20:32:57.139+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13578649","id":"13578649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"body":"Also... today which is about 18 hours later... we still do see some errors popping in our AMQ instance that seems related to this issue. Perhaps our data store is still corrupted/odd and we only see it for certain queues. Things in general do seem to still be working but I don't trust the state that it is in:\n\n{noformat}\n2013-02-14 11:02:39,710 | ERROR | Failed to page in more queue messages  | org.apache.activemq.broker.region.Queue | ActiveMQ BrokerService[habroker] Task-789\njava.lang.RuntimeException: java.lang.RuntimeException: java.io.IOException: Invalid location: 129:8716740, : java.lang.NegativeArraySizeException\n                at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.hasNext(AbstractStoreCursor.java:150)\n                at org.apache.activemq.broker.region.cursors.StoreQueueCursor.hasNext(StoreQueueCursor.java:131)\n                at org.apache.activemq.broker.region.Queue.doPageInForDispatch(Queue.java:1766)\n                at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1993)\n                at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1486)\n                at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)\n                at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)\n                at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n                at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n                at java.lang.Thread.run(Thread.java:679)\nCaused by: java.lang.RuntimeException: java.io.IOException: Invalid location: 129:8716740, : java.lang.NegativeArraySizeException\n                at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:277)\n                at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.hasNext(AbstractStoreCursor.java:147)\n                ... 9 more\nCaused by: java.io.IOException: Invalid location: 129:8716740, : java.lang.NegativeArraySizeException\n                at org.apache.kahadb.journal.DataFileAccessor.readRecord(DataFileAccessor.java:92)\n                at org.apache.kahadb.journal.Journal.read(Journal.java:604)\n                at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:879)\n                at org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:1030)\n                at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore$4.execute(KahaDBStore.java:558)\n                at org.apache.kahadb.page.Transaction.execute(Transaction.java:769)\n                at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.recoverNextMessages(KahaDBStore.java:547)\n                at org.apache.activemq.store.ProxyMessageStore.recoverNextMessages(ProxyMessageStore.java:106)\n                at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:97)\n                at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:274)\n                ... 10 more\n\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-14T20:35:00.415+0000","updated":"2013-02-14T20:35:00.415+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13784107","id":"13784107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"Any update on this ticket? There has been many fixes et all since 5.5.1 release and we are closing in on 5.9.\nSo we need to know if this is resolved already or should be moved to 5.10.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-02T15:58:51.805+0000","updated":"2013-10-02T15:58:51.805+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13784172","id":"13784172","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"body":"The most recent stack traces occurred in 5.7.0. I have been watching commits and have not seen anything that seemed like it would have addressed this.\n\nI am pretty sure that losing the SAN or ability to write to disk is not handled correctly by the KahaDB-related code. I have seen LevelDB commits. Is there an opinion among the AMQ devs on whether KahaDB code will be deprecated in favor of another store?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"created":"2013-10-02T17:19:21.930+0000","updated":"2013-10-02T17:19:21.930+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13784871","id":"13784871","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"Yeah over time leveldb is intended as the preferred choice over kahadb. Though it takes time to be feature complete, and stabilize into the broker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-03T07:06:45.887+0000","updated":"2013-10-03T07:06:45.887+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13791987","id":"13791987","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@Rob Waite - do you have a scenario that is known to fail, a little test case. It is possible to configure the IOExceptionHandler.{code}<ioExceptionHandler>\n   <defaultIOExceptionHandler stopStartConnectors=\"true\" />\n </ioExceptionHandler>{code}. There may be an easy fix if there is a simple test case. The shutdown logic is better on trunk (5.9 snap)    and we auto recreate a corrupt index on restart so things could well be better. The original test case for the IOException handler revolved around disk-Full and disk-not-full recovery. Your scenario seems a little more random. But if we can narrow it down or break it down there may be some simple tweaks we can do to improve.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2013-10-10T21:09:35.927+0000","updated":"2013-10-10T21:09:35.927+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13792876","id":"13792876","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"body":"So I reattempted with the latest snapshot (apache-activemq-5.9-20131011.032953-115-bin) and it did seem a lot better. My test is really just to make a producer that sends messages in a tight loop and to use a USB thumbdrive for the data directory. Then, while the producer is writing as fast as it can, I yank out the thumbdrive, wait a bit, and put it back in and wait for AMQ to handle it.\n\nWe have seen issues with our SAN becoming unavailable and seeing very similar stack traces.\n\nWith the new snapshot... it seems like it recovers most of the time. Twice (in maybe 15 minutes of testing) it would not start back up. The first time it seemed like the USB drive \"data\" folder got corrupted... I couldnt read from the data folder from windows (it would say it was corrupted). I reformatted it and tried again and the most recent error seemed like it would recover but then a very vague null pointer error happened.\n\nAttached is the output (AMQ-3725-10112013.txt)... at the end you can see it tried to restart and then a nullpointerexception occurred and it halted (line 501).\n\nI know a thumbdrive would not be used in prod... but the exceptions seemed very similar to what we have seen with our NFS store.\n\nOverall, it is much more resilient than 5.7.0. Of the maybe 20 times I tried... 18 times it would restart automatically.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=absynthe49","name":"absynthe49","key":"absynthe49","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Waite","active":true,"timeZone":"Etc/UTC"},"created":"2013-10-11T17:54:38.030+0000","updated":"2013-10-11T17:56:28.601+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13810442","id":"13810442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Hi,\n\nI just pushed a change that should help with this scenario. I also tested ti with the USB drive and it seems that now KahaDB recovers properly. I also used a bit longer resume period (30 sec)\n\n        <ioExceptionHandler>\n            <defaultIOExceptionHandler stopStartConnectors=\"true\" resumeCheckSleepPeriod=\"30000\" />\n        </ioExceptionHandler>\n\nso I can have a bit more time to unplug and plug the drive back in before broker tries to recreate the folder. \n\nI started a new snapshot build, but I'm not sure if it's gonna be built soon. You can build it locally anyways. Test it out and let me know if the problem is still there.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2013-10-31T17:11:04.649+0000","updated":"2013-10-31T17:11:04.649+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13811124","id":"13811124","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Here's a snapshot containing a fix\n\nhttps://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.10-SNAPSHOT/apache-activemq-5.10-20131101.033855-13-bin.tar.gz\n\nto be tested","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2013-11-01T09:13:57.616+0000","updated":"2013-11-01T09:13:57.616+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13956662","id":"13956662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"Did anyone test the SNAPSHOT with a fix","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2014-04-01T15:46:26.087+0000","updated":"2014-04-01T15:46:26.087+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/13956663","id":"13956663","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"[~dejanb] should we assume this is fixed and close the ticket?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2014-04-01T15:46:59.470+0000","updated":"2014-04-01T15:46:59.470+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12543079/comment/14020977","id":"14020977","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Git commits:\nhttps://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=582af3e74adca7efbf7d88d092764325341b719d\n\nhttps://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commit;h=5dacae368b125cd6371bc5d74cb1820ba0a5ca5a","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-06-07T21:18:22.765+0000","updated":"2014-06-07T21:18:22.765+0000"}],"maxResults":16,"total":16,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3725/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0alb3:"}}