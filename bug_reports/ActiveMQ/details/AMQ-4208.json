{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12618964","self":"https://issues.apache.org/jira/rest/api/2/issue/12618964","key":"AMQ-4208","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2015-08-07T21:15:38.468+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 07 21:15:38 UTC 2015","customfield_12310420":"296233","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_84232538330_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-08-07T21:15:38.430+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4208/watchers","watchCount":2,"isWatching":false},"created":"2012-12-05T23:20:00.175+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-08-07T21:15:38.502+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319603","id":"12319603","name":"activemq-pool","description":"The ActiveMQ Connection Pool"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We have been facing a stuck message issue with 5.6 for a while now. This week I got a chance to reproduce this in a non-production environment every time I ran a high load.\n\nWe use Spring DMLC with the following configuration.\n    <bean id=\"asyncServiceContainer2\" class=\"org.springframework.jms.listener.DefaultMessageListenerContainer\">\n        <property name=\"connectionFactory\" ref=\"asyncServiceConnectionFactory2\" />\n        <property name=\"destination\" ref=\"asyncServiceDestination\" />\n        <property name=\"messageListener\" ref=\"asyncService\" />\n        <!-- Cache JMS connection -->\n        <property name=\"cacheLevelName\" value=\"CACHE_CONNECTION\" />\n        <!-- The maximum number of concurrent consumers to create -->\n        <property name=\"maxConcurrentConsumers\" value=\"30\" />\n        <property name=\"receiveTimeout\" value=\"10000\" />\n        <property name=\"maxMessagesPerTask\" value=\"20\" />\n        <property name=\"idleTaskExecutionLimit\" value=\"5\" />\n    </bean>\n\n\nThe broker uses the default settings with producerFlowControl on.\n\nIf I send a jmeter load with 100 concurrent users, with 1000 requests from each user...it generates a throughput of around 60TPS/node. This is for the producer side. \n\nI see no issues from a producer standpoint. \n\nBut everytime I run this test, it reaches a point where the deque count just freezes up and the enqueue keeps incrementing because the producer is not affected. This freeze affects all consumers. The only way to unlock it is by restarting the broker. I have seen it being released by restarting the app as well.\n\nWhen this free happens, there is usually a large number of *.log files in the kahadb folder and the size of the b-tree file db.data also keeps incrementing indicating the backlog. \n\nI have taken jstack traces for the broker as well as the application, which I will attach with this request. \n\nPlease note that this happens everytime I run with the setup shown.\n\nOne way I can prevent the issue from happening so frequently, is by turning off dynamic scaling by using concurrentConsumers to a high number and setting maxMessagesPerTask to the default (-1 or infinity) for Spring DMLC. This keeps the number of consumers constant and increased the consumption rate, preventing the backlog from happening. In addition to these changes I also had to switch from CACHE_CONNECTION cache type to CACHE_CONSUMER to prevent this from happening.\n\nI have seen a similar issue reported for an earlier version at http://mail-archives.apache.org/mod_mbox/activemq-users/201005.mbox/%3Cg2v4e6f67721005071419u5ca08751h569775ee4e682c5e@mail.gmail.com%3E\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12556171","id":"12556171","filename":"activemq-orig.11302012.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-05T23:44:16.986+0000","size":5657,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12556171/activemq-orig.11302012.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12556167","id":"12556167","filename":"activemqthreads6.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-05T23:40:14.798+0000","size":37909,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12556167/activemqthreads6.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12556168","id":"12556168","filename":"threads6.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-05T23:40:37.551+0000","size":216453,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12556168/threads6.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"232625","customfield_12312823":null,"summary":"Stuck Message Issue with ActiveMQ 5.6","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Production","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12618964/comment/13510923","id":"13510923","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"body":"Thread states from the broker when the issue happens","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-05T23:40:14.800+0000","updated":"2012-12-05T23:40:14.800+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12618964/comment/13510924","id":"13510924","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"body":"Thread states from the application during the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-05T23:40:37.553+0000","updated":"2012-12-05T23:40:37.553+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12618964/comment/13510934","id":"13510934","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"body":"Just want to add that I used two machines to reproduce this on a non-prod environment, one for the broker and one for the app. JMeter was run on a different machine, to send load to the application which acted like a producer as well as consumer ... all part of the same war file, implemented using Spring.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sinusekhar","name":"sinusekhar","key":"sinusekhar","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sinu Sekhar","active":true,"timeZone":"Etc/UTC"},"created":"2012-12-05T23:46:24.245+0000","updated":"2012-12-05T23:46:24.245+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12618964/comment/14662467","id":"14662467","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"No test case to validate against a current broker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-08-07T21:15:38.468+0000","updated":"2015-08-07T21:15:38.468+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4208/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14767:"}}