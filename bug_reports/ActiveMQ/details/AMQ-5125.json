{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12704250","self":"https://issues.apache.org/jira/rest/api/2/issue/12704250","key":"AMQ-5125","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326456","id":"12326456","name":"5.10.1","archived":false,"released":true,"releaseDate":"2015-01-20"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-03-28T13:54:13.992+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jul 08 14:07:23 UTC 2014","customfield_12310420":"382584","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_8755825812_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-07-07T21:55:33.839+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5125/watchers","watchCount":10,"isWatching":false},"created":"2014-03-28T13:45:08.072+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-12-16T00:07:01.340+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"JMS clients start to hang after a while in calls such as session.createObjectMessage(). Both the broker and the hanging clients can't be easily shut down when this happens - only forcefully applied kill's do the job.\n\nI'm using queues and transactional sessions. All clients (producers and consumers) are in the same Java VM. There is only one JMS connection between the application and the broker. Each client has its own session, but they all share the same connection.\n\nNormally, the data directory of the LevelDb contains only a few log files. But in my case, the number of log files is steadily increasing.\n\nFurthermore, I was able to track down the issue to following circumstance: The problem only occurs, when consumers do a rollback instead of a commit when they receive the message. The rollback / redelivery works as expected - the same message is received again after a previous rollback.\n\nAs far as I can tell, the problem does not occur with KahaDb.\n\nI'll attach a test program that provokes the error. It sets up a few hundred queues, consumers and producers. The consumers just receive the message and commit the session, but they also do \"random\" rollbacks. It can be observed immediately that the number of files starts increasing in the data directory. After a few minutes, the clients hang - sometimes sooner, sometimes later. I'll also attach the config file for the broker.\n\nI am aware, that heavy rollbacking should not happen in normal operation. But from a long term stability perspective, this is a blocker for us.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12637400","id":"12637400","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-03-28T13:50:23.308+0000","size":5801,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12637400/activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12654320","id":"12654320","filename":"AMQ-5125_made_synchronization_in_LevelDBStore_use_private_lock.5.9.2.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jameshome","name":"jameshome","key":"jameshome","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"James Home","active":true,"timeZone":"Etc/UTC"},"created":"2014-07-07T14:19:48.684+0000","size":3403,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12654320/AMQ-5125_made_synchronization_in_LevelDBStore_use_private_lock.5.9.2.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12638520","id":"12638520","filename":"Broker-threaddump-1396544622970.tdump","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-04-03T17:08:09.401+0000","size":48180,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12638520/Broker-threaddump-1396544622970.tdump"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12648470","id":"12648470","filename":"broker-threads-blocked.tdump","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=blondacz","name":"blondacz","key":"blondacz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tomas Klubal","active":true,"timeZone":"Etc/UTC"},"created":"2014-06-05T11:57:06.979+0000","size":79320,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12648470/broker-threads-blocked.tdump"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12638519","id":"12638519","filename":"Clients-threaddump-1396544622970.tdump","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-04-03T17:08:09.397+0000","size":306160,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12638519/Clients-threaddump-1396544622970.tdump"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12637399","id":"12637399","filename":"src.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-03-28T13:49:12.505+0000","size":6107,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12637399/src.zip"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12637401","id":"12637401","filename":"VM.PNG","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-03-28T13:52:46.846+0000","size":46973,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12637401/VM.PNG"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"382852","customfield_12312823":null,"summary":"Broker and clients hang","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows 7, Linux\nJAVA_HOME=C:\\Program Files\\Java\\jdk1.7.0_07\nActiveMQ 5.9.0 with LevelDB storage adapter enabled","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/13950718","id":"13950718","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"body":"Test program","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-03-28T13:49:12.509+0000","updated":"2014-03-28T13:49:12.509+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/13950720","id":"13950720","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"body":"Default configuration file as shipped with ActiveMQ. LevelDb enabled.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-03-28T13:50:23.312+0000","updated":"2014-03-28T13:50:23.312+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/13950724","id":"13950724","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"body":"The last minutes of the Java VM of the ActiveMQ.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-03-28T13:52:46.850+0000","updated":"2014-03-28T13:52:46.850+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/13950727","id":"13950727","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Recommend you test against a recent 5.10-SNAPSHOT which contains a great many fixes for LevelDB, you can make it simpler by turning your test into a JUnit test and drop it into the ActiveMQ source or create a simple maven project that allows you to quickly change version numbers. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-03-28T13:54:13.992+0000","updated":"2014-03-28T13:54:13.992+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/13958980","id":"13958980","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"body":"The problem seems to exist in the recent 5.10 snapshot as well. After a few minutes of brokering, the system comes to a halt. I attached the thread dumps of the broker and the clients. The broker seems to hang in a rollback.\n\nI observed that the number of LevelDB log files does *not* steadily increase anymore as it did in 5.9.0. \n\nRegarding the operating system: I ran reproduced the issue on Windows 7 with the attached test program. We observed the problem on Linux as well, but I haven't ran my test program on this platform.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Albert+Barmettler","name":"Albert Barmettler","key":"albert barmettler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Barmettler","active":true,"timeZone":"Etc/UTC"},"created":"2014-04-03T17:08:09.405+0000","updated":"2014-04-03T17:54:43.255+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/14018713","id":"14018713","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=blondacz","name":"blondacz","key":"blondacz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tomas Klubal","active":true,"timeZone":"Etc/UTC"},"body":"Same issue happening to us not every time but quite often on very small load and even with just one rollback. The all threads are BLOCKED. The version is  5.9.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=blondacz","name":"blondacz","key":"blondacz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tomas Klubal","active":true,"timeZone":"Etc/UTC"},"created":"2014-06-05T11:57:06.986+0000","updated":"2014-06-05T11:57:06.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/14019717","id":"14019717","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=saket","name":"saket","key":"saket","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Saket","active":true,"timeZone":"Europe/London"},"body":"We  have a similar issue for which I posted a message on the user forums. There is a performance test attached there which can be used to reproduce this.\n\nhttp://activemq.2283324.n4.nabble.com/ActiveMQ-message-dequeuing-hangs-td4681366.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=saket","name":"saket","key":"saket","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Saket","active":true,"timeZone":"Europe/London"},"created":"2014-06-06T09:51:37.408+0000","updated":"2014-06-06T09:51:37.408+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/14047662","id":"14047662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"Any chance you can see if having producers/consumers on separate connections make a difference?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2014-06-30T13:44:00.556+0000","updated":"2014-06-30T13:44:00.556+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/14053690","id":"14053690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jameshome","name":"jameshome","key":"jameshome","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"James Home","active":true,"timeZone":"Etc/UTC"},"body":"I believe the issue that this ticket was raised against is the same one described here (same link as above), which badavis has analysed in his recent post:\n\nhttp://activemq.2283324.n4.nabble.com/ActiveMQ-message-dequeuing-hangs-td4681366.html\n\nI've gone through the code, and I agree with his findings.\n\nI've attached a patch to 5.9.2 based on this, in which LevelDBStore uses an internal private lock variable instead of _this_, which removes the deadlock that can happen when the LocalTransaction synchronises externally on the transactionStore during a rollback.\n\nUsing this patch, the original (attached) test runs for hours without deadlocking, as do my own tests that previously deadlocked after a few thousand messages.\n\nThanks,\n\nJames\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jameshome","name":"jameshome","key":"jameshome","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"James Home","active":true,"timeZone":"Etc/UTC"},"created":"2014-07-07T14:19:48.687+0000","updated":"2014-07-07T14:19:48.687+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/14053788","id":"14053788","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=blondacz","name":"blondacz","key":"blondacz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tomas Klubal","active":true,"timeZone":"Etc/UTC"},"body":"Nice!!! \n\n\n-- \nSent from my Android device with K-9 Mail. Please excuse my brevity.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=blondacz","name":"blondacz","key":"blondacz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tomas Klubal","active":true,"timeZone":"Etc/UTC"},"created":"2014-07-07T15:57:35.134+0000","updated":"2014-07-07T15:57:35.134+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/14054203","id":"14054203","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Reviewed all the mailing list discussion and the threads dumps and the analysis is correct, the lock cannot be the LevelDBStore object since that can lead to  a lock in the hawtDispatch serialization thread runner if a task is modifying mutable state and needs to protect data that also accessible on the public store API. \n\nPatch applied with thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-07-07T21:55:33.876+0000","updated":"2014-07-07T21:55:33.876+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/14054450","id":"14054450","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=badavis","name":"badavis","key":"badavis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Davis","active":true,"timeZone":"Etc/UTC"},"body":"Awesome that this is getting fixed.  Thank you James for fixing this.  I apologize if this is the wrong form for this, I am new to this type of development.  The other issue I noticed from my analysis is the GCPolling job and the rollback job got scheduled to the same thread at the same time in the hawtdispatcher.  It just so happens that the GCPoll job got ran first.  My system had many dispatch threads available but all the jobs only went to the one dispatch thread causing the deadlock.  Could you tell me the reasoning this is not a concern?  I personally would like to understand this better.  Thank you.\n\nBrian","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=badavis","name":"badavis","key":"badavis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Davis","active":true,"timeZone":"Etc/UTC"},"created":"2014-07-08T02:54:28.594+0000","updated":"2014-07-08T02:54:28.594+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12704250/comment/14054964","id":"14054964","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"The reason is simple, the serial execution of tasks protects from concurrent modification of mutable state in the LeveDB store.  If the tasks executed on multiple threads concurrently then the code would need to be drastically more protective of all mutable state in the store and you'd see a lot more locking and most likely threading related bugs. The reason for the small number of synchronized areas is to protect those bits that are exposed by the persistence adapter API which need to read or modify some things that are also modified on the dispatch thread.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-07-08T14:07:23.995+0000","updated":"2014-07-08T14:07:23.995+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5125/votes","votes":4,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1twuv:"}}