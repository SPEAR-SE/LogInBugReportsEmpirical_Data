{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13042616","self":"https://issues.apache.org/jira/rest/api/2/issue/13042616","key":"AMQ-6598","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-11-12T19:20:35.588+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Dec 01 09:36:04 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_25114736123_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-12-01T09:36:13.585+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6598/watchers","watchCount":2,"isWatching":false},"created":"2017-02-13T17:17:17.530+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329258","id":"12329258","name":"5.12.0","archived":false,"released":true,"releaseDate":"2015-08-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12338822","id":"12338822","name":"5.14.3","archived":false,"released":true,"releaseDate":"2016-12-22"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-12-01T09:36:13.647+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324803","id":"12324803","name":"JDBC"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"ActiveMQ raises a SQLException when moving messages from two or more queues to the configured dead-letter-queue. It only happens with two or more queues and multiple messages. The exception is logged on level WARN and it seems that no messages are lost. First affected version is 5.12.0, but also happens with the current version 5.14.3.\n\n{code}\njava.io.IOException: Failed to broker message: ID:server-amq-46753-1486658241250-4:5:3:1:13 in container: java.sql.SQLException: org.apache.commons.dbcp2.DelegatingPreparedStatement with address: \"NULL\" is closed.\n        at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:34) ~[activemq-client-5.14.3.jar:5.14.3]\n        at org.apache.activemq.store.jdbc.JDBCMessageStore.addMessage(JDBCMessageStore.java:163) ~[activemq-jdbc-store-5.14.3.jar:5.14.3]\n        at org.apache.activemq.store.memory.MemoryTransactionStore.addMessage(MemoryTransactionStore.java:352) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.store.memory.MemoryTransactionStore$1.asyncAddQueueMessage(MemoryTransactionStore.java:159) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:837) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.Queue.send(Queue.java:727) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:503) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:468) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.jmx.ManagedRegionBroker.send(ManagedRegionBroker.java:293) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:153) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.scheduler.SchedulerBroker.send(SchedulerBroker.java:195) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:293) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:158) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.util.LoggingBrokerPlugin.send(LoggingBrokerPlugin.java:275) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:158) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.util.BrokerSupport.doResend(BrokerSupport.java:69) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.util.BrokerSupport.resendNoCopy(BrokerSupport.java:38) ~[activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.RegionBroker.sendToDeadLetterQueue(RegionBroker.java:799) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.BrokerFilter.sendToDeadLetterQueue(BrokerFilter.java:319) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.BrokerFilter.sendToDeadLetterQueue(BrokerFilter.java:319) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.BrokerFilter.sendToDeadLetterQueue(BrokerFilter.java:319) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.MutableBrokerFilter.sendToDeadLetterQueue(MutableBrokerFilter.java:331) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.util.LoggingBrokerPlugin.sendToDeadLetterQueue(LoggingBrokerPlugin.java:505) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.MutableBrokerFilter.sendToDeadLetterQueue(MutableBrokerFilter.java:331) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.PrefetchSubscription.sendToDLQ(PrefetchSubscription.java:535) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:394) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:526) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:484) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:88) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:88) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:276) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:98) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.util.LoggingBrokerPlugin.acknowledge(LoggingBrokerPlugin.java:162) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:98) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:590) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:245) [activemq-client-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:336) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:200) [activemq-broker-5.14.3.jar:5.14.3]\n        at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) [activemq-client-5.14.3.jar:5.14.3]\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:125) [activemq-client-5.14.3.jar:5.14.3]\n        at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:301) [activemq-client-5.14.3.jar:5.14.3]\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) [activemq-client-5.14.3.jar:5.14.3]\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:233) [activemq-client-5.14.3.jar:5.14.3]\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:215) [activemq-client-5.14.3.jar:5.14.3]\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\nCaused by: java.sql.SQLException: org.apache.commons.dbcp2.DelegatingPreparedStatement with address: \"NULL\" is closed.\n        at org.apache.commons.dbcp2.DelegatingStatement.checkOpen(DelegatingStatement.java:122) ~[commons-dbcp2-2.1.1.jar:2.1.1]\n        at org.apache.commons.dbcp2.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:143) ~[commons-dbcp2-2.1.1.jar:2.1.1]\n        at org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.doAddMessage(DefaultJDBCAdapter.java:233) ~[activemq-jdbc-store-5.14.3.jar:5.14.3]\n        at org.apache.activemq.store.jdbc.JDBCMessageStore.addMessage(JDBCMessageStore.java:159) ~[activemq-jdbc-store-5.14.3.jar:5.14.3]\n        ... 44 more\n{code}\n\n\n\nh5. Setup to reproduce:\nConfigure jdbcPersistenceAdapter with a MySQL datasource and a individualDeadLetterStrategy:\n{code}\n...\n<policyEntry queue=\">\">\n    <deadLetterStrategy>\n        <individualDeadLetterStrategy queuePrefix=\"DLQ.\" useQueueForQueueMessages=\"true\"/>\n    </deadLetterStrategy>\n</policyEntry>\n...\n<persistenceAdapter>\n   <jdbcPersistenceAdapter dataDirectory=\"${activemq.data}\" cleanupPeriod=\"0\" dataSource=\"#mysql-ds\"/>\n</persistenceAdapter>\n...\n<bean id=\"mysql-ds\" class=\"org.apache.commons.dbcp2.BasicDataSource\" destroy-method=\"close\">\n  <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n  <property name=\"url\" value=\"jdbc:mysql://localhost/activemq?relaxAutoCommit=true\"/>\n  <property name=\"username\" value=\"user\"/>\n  <property name=\"password\" value=\"password\"/>\n  <property name=\"poolPreparedStatements\" value=\"true\"/>\n</bean>\n...\n{code}\n\nSetup two consumers and producers for two different queues, e.g test.queue.1 and test.queue.2\n\nThe consumers should have no client-side redelivery and directly throw an exception when consuming the message to trigger the DLQ mechanism on the broker.\n\nSend around 1000 messages with each producer in a loop.\n\nAfter a few seconds you see the above mentioned SQLException in the ActiveMQ.log on level WARN.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"SQLException when moving messages to DLQ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=domaier","name":"domaier","key":"domaier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominik Maier","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=domaier","name":"domaier","key":"domaier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominik Maier","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13042616/comment/16248967","id":"16248967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=j.hedin","name":"j.hedin","key":"j.hedin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Johan Hedin","active":true,"timeZone":"Europe/Stockholm"},"body":"This one looks related to AMQ-6693","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=j.hedin","name":"j.hedin","key":"j.hedin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Johan Hedin","active":true,"timeZone":"Europe/Stockholm"},"created":"2017-11-12T19:20:35.588+0000","updated":"2017-11-12T19:20:35.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13042616/comment/16274167","id":"16274167","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=domaier","name":"domaier","key":"domaier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominik Maier","active":true,"timeZone":"Etc/UTC"},"body":"I double checked, its fixed in [AMQ-6693|https://issues.apache.org/jira/browse/AMQ-6693], thanks. I close this issue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=domaier","name":"domaier","key":"domaier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dominik Maier","active":true,"timeZone":"Etc/UTC"},"created":"2017-12-01T09:36:04.950+0000","updated":"2017-12-01T09:36:04.950+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6598/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3a04v:"}}