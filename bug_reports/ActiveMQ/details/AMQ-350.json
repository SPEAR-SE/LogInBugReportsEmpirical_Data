{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481316","self":"https://issues.apache.org/jira/rest/api/2/issue/12481316","key":"AMQ-350","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315602","id":"12315602","name":"3.2","archived":false,"released":true}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2005-09-15T01:48:42.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 06 14:45:45 UTC 2005","customfield_12310420":"84266","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_368614000_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2005-09-15T01:54:23.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-350/watchers","watchCount":1,"isWatching":false},"created":"2005-09-10T19:30:49.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315601","id":"12315601","name":"3.1","archived":false,"released":true}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2005-10-06T14:45:45.000+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I've just started experimenting with ActiveMQ.  When I run the broker\nwith the default configuration on a windows server I get the following\nerror when I try to send a message.  However this doesn't appear to\nhappen on a Unix/Linux environment.  Is the activemq.bat file that\nstarts up the broker missing something?\n\n11:47:02 WARN  caught exception consuming packet: ACTIVEMQ_MSG_ACK: id\n= 0 MessageAck{ consumerId =\n'ID:emcien-rb4yqw0r-3846-1126039084803-4:0' , messageID =\n'ID:cognos02-2362-1126107941270-12:0' , destination = Send.Queue,\ntransactionId ='ID:emcien-rb4yqw0r-3846-1126039084803-10:0' ,\nmessageRead = false, xaTransacted = false, persistent = true, expired\n= false, messageIdentity = null }\njava.lang.NullPointerException\n        at EDU.oswego.cs.dl.util.concurrent.ConcurrentHashMap.hash(Unknown\nSource)\n        at EDU.oswego.cs.dl.util.concurrent.ConcurrentHashMap.get(Unknown\nSource)\n        at org.activemq.store.journal.JournalTransactionStore.getTx(JournalTransactionStore.java:160)\n        at org.activemq.store.journal.JournalTransactionStore.addMessage(JournalTransactionStore.java:260)\n        at org.activemq.store.journal.JournalMessageStore.addMessage(JournalMessageStore.java:98)\n        at org.activemq.store.cache.CacheMessageStore.addMessage(CacheMessageStore.java:51)\n        at org.activemq.service.boundedvm.DurableQueueBoundedMessageContainer.enqueue(DurableQueueBoundedMessageContainer.java:218)\n        at org.activemq.service.boundedvm.DurableQueueBoundedMessageManager.sendToDeadLetterQueue(DurableQueueBoundedMessageManager.java:597)\n        at org.activemq.broker.impl.DefaultBroker.sendToDeadLetterQueue(DefaultBroker.java:814)\n        at org.activemq.service.DeadLetterPolicy.sendToDeadLetter(DeadLetterPolicy.java:186)\n        at org.activemq.service.boundedvm.DurableQueueBoundedMessageManager.redeliverMessage(DurableQueueBoundedMessageManager.java:415)\n        at org.activemq.service.boundedvm.DurableQueueBoundedMessageManager.acknowledgeMessage(DurableQueueBoundedMessageManager.java:335)\n        at org.activemq.broker.impl.DefaultBroker.acknowledgeMessage(DefaultBroker.java:321)\n        at org.activemq.broker.impl.BrokerContainerImpl.acknowledgeMessage(BrokerContainerImpl.java:509)\n        at org.activemq.broker.impl.BrokerConnectorImpl.acknowledgeMessage(BrokerConnectorImpl.java:283)\n        at org.activemq.broker.impl.BrokerClientImpl.consumeMessageAck(BrokerClientImpl.java:732)\n        at org.activemq.broker.impl.BrokerClientImpl.consume(BrokerClientImpl.java:329)\n        at org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:374)\n        at org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:368)\n        at org.activemq.transport.tcp.TcpTransportChannel.run(TcpTransportChannel.java:311)\n        at java.lang.Thread.run(Thread.java:534)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172327","customfield_12312823":null,"summary":"NullPointerException in Journal when DeadLetterPolicy.sendToDeadLetter() is used.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481316/comment/12936642","id":"12936642","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlim","name":"jlim","key":"jlim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jonas Lim","active":true,"timeZone":"Etc/UTC"},"body":" I tried reproducing the issue on Windows XP SP2 and wasn't able to reproduce the issue.  I  tested it against the 3.1 release and the latest version from svn using the default configuration. My test cases involved :\n\n\n1. running a simple  producer / consumer sample.  This did not reproduce the issue\n\n2. Sending messages under a transaction and doing  a rollback of messages  until the message is delivered to a deadletter queue. I also did a test by expiring the message and consuming it. I verified that the message was sent to a dead letter queue. In both cases I was not able to reproduce the exception the user reported.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlim","name":"jlim","key":"jlim","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jonas Lim","active":true,"timeZone":"Etc/UTC"},"created":"2005-09-15T01:48:42.000+0000","updated":"2005-09-15T01:48:42.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481316/comment/12937197","id":"12937197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caleb_phillips","name":"caleb_phillips","key":"caleb_phillips","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Caleb Phillips","active":true,"timeZone":"Etc/UTC"},"body":"I am getting the same exception on Windows XP when using journalPersistence with the default Derby data source.  When I use only jdbcPersistence with the same data source reference, I do not get the exception.  According to the logs it is successfully transfers the message to the dead letter queue in that configuration.  For the client I am using the Jencks JCA connector to invoke a message driven pojo.  The onMessage method is just throwing a RuntimeException.  Here are the corresponding log excerpts:\n\n------------------------------------------------------------\nusing the journal\n------------------------------------------------------------\nDEBUG ableQueueBoundedMessageManager - Message: DMP - msg = ACTIVEMQ_MAP_MESSAGE: id = 0 ActiveMQMessage{ , jmsMessageID = ID:CalebP-3286-1128542388401-147:0, bodyAsBytes = org.activemq.io.util.ByteArray@c017e9, readOnlyMessage = false, jmsClientID = 'ID:CalebP-3286-1128542388401-141:0' , jmsCorrelationID = 'null' , jmsDestination = Hello.Queue, jmsReplyTo = null, jmsDeliveryMode = 2, jmsRedelivered = true, jmsType = 'null' , jmsExpiration = 0, jmsPriority = 4, jmsTimestamp = 1128608801246, properties = null, readOnlyProperties = false, entryBrokerName = 'ID:CalebP-1168-1128608656738-0:0' , entryClusterName = 'default' , consumerNos = null, transactionId = 'null' , xaTransacted = false, consumerIdentifer = 'null' , messageConsumed = false, transientConsumed = false, sequenceNumber = 0, deliveryCount = 200, dispatchedFromDLQ = false, messageAcknowledge = null, jmsMessageIdentity = org.activemq.service.MessageIdentity@11d6489b[id=ID:CalebP-3286-1128542388401-147:0; sequenceNo=412], producerKey = ID:CalebP-3286-1128542388401-147: } ActiveMQMapMessage{ theTable = null } has exceeded its retry count\nDEBUG JournalPersistenceAdapter      - Checkpoint started.\nDEBUG JournalMessageStore            - removedFromJournal=0\nDEBUG JournalMessageStore            - Checkpoint: Hello.Queue\nDEBUG JournalMessageStore            - Added 0 message(s) and removed 0 message(s). removedFromJournal=0\nDEBUG JournalMessageStore            - In flight journal locations: []\nDEBUG JournalMessageStore            - removedFromJournal=0\nDEBUG JournalMessageStore            - Checkpoint: org.activemq.deadletter.Hello.Queue\nDEBUG JournalMessageStore            - Added 0 message(s) and removed 0 message(s). removedFromJournal=0\nDEBUG JournalMessageStore            - In flight journal locations: []\nDEBUG JDBCPersistenceAdapter         - Cleaning up old messages.\nDEBUG DefaultJDBCAdapter             - Deleted 0 old message(s).\nDEBUG JDBCPersistenceAdapter         - Cleanup done.\nDEBUG JournalPersistenceAdapter      - Checkpoint done.\nDEBUG JournalMessageStore            - Journalled in flight message add: ID:CalebP-3286-1128542388401-147:0 at 0:8139234\nWARN  BrokerClientImpl               - caught exception consuming packet: ACTIVEMQ_MSG_ACK: id = 0 MessageAck{ consumerId = 'ID:CalebP-1211-1128609184386-3:0' , messageID = 'ID:CalebP-3286-1128542388401-147:0' , destination = Hello.Queue, transactionId = 'ID:CalebP-1211-1128609184386-599:0' , messageRead = false, xaTransacted = false, persistent = true, expired = false, messageIdentity = null }\njava.lang.NullPointerException\n\tat EDU.oswego.cs.dl.util.concurrent.ConcurrentHashMap.hash(Unknown Source)\n\tat EDU.oswego.cs.dl.util.concurrent.ConcurrentHashMap.get(Unknown Source)\n\tat org.activemq.store.journal.JournalTransactionStore.getTx(JournalTransactionStore.java:160)\n\tat org.activemq.store.journal.JournalTransactionStore.addMessage(JournalTransactionStore.java:260)\n\tat org.activemq.store.journal.JournalMessageStore.addMessage(JournalMessageStore.java:98)\n\tat org.activemq.service.boundedvm.DurableQueueBoundedMessageContainer.enqueue(DurableQueueBoundedMessageContainer.java:218)\n\tat org.activemq.service.boundedvm.DurableQueueBoundedMessageManager.sendToDeadLetterQueue(DurableQueueBoundedMessageManager.java:597)\n\tat org.activemq.broker.impl.DefaultBroker.sendToDeadLetterQueue(DefaultBroker.java:814)\n\tat org.activemq.service.DeadLetterPolicy.sendToDeadLetter(DeadLetterPolicy.java:186)\n\tat org.activemq.service.boundedvm.DurableQueueBoundedMessageManager.redeliverMessage(DurableQueueBoundedMessageManager.java:415)\n\tat org.activemq.service.boundedvm.DurableQueueBoundedMessageManager.acknowledgeMessage(DurableQueueBoundedMessageManager.java:335)\n\tat org.activemq.broker.impl.DefaultBroker.acknowledgeMessage(DefaultBroker.java:321)\n\tat org.activemq.broker.impl.BrokerContainerImpl.acknowledgeMessage(BrokerContainerImpl.java:509)\n\tat org.activemq.broker.impl.BrokerConnectorImpl.acknowledgeMessage(BrokerConnectorImpl.java:283)\n\tat org.activemq.broker.impl.BrokerClientImpl.consumeMessageAck(BrokerClientImpl.java:732)\n\tat org.activemq.broker.impl.BrokerClientImpl.consume(BrokerClientImpl.java:329)\n\tat org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:374)\n\tat org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:368)\n\tat org.activemq.transport.tcp.TcpTransportChannel.run(TcpTransportChannel.java:311)\n\tat java.lang.Thread.run(Thread.java:595)\n\n\n------------------------------------------------------------\nusing jdbc without the journal\n------------------------------------------------------------\nDEBUG ableQueueBoundedMessageManager - Message: DMP - msg = ACTIVEMQ_MAP_MESSAGE: id = 0 ActiveMQMessage{ , jmsMessageID = ID:CalebP-3286-1128542388401-147:0, bodyAsBytes = org.activemq.io.util.ByteArray@17f4fbb, readOnlyMessage = false, jmsClientID = 'ID:CalebP-3286-1128542388401-141:0' , jmsCorrelationID = 'null' , jmsDestination = Hello.Queue, jmsReplyTo = null, jmsDeliveryMode = 2, jmsRedelivered = true, jmsType = 'null' , jmsExpiration = 0, jmsPriority = 4, jmsTimestamp = 1128608801246, properties = null, readOnlyProperties = false, entryBrokerName = 'ID:CalebP-1168-1128608656738-0:0' , entryClusterName = 'default' , consumerNos = null, transactionId = 'null' , xaTransacted = false, consumerIdentifer = 'null' , messageConsumed = false, transientConsumed = false, sequenceNumber = 0, deliveryCount = 200, dispatchedFromDLQ = false, messageAcknowledge = null, jmsMessageIdentity = org.activemq.service.MessageIdentity@11d6489b[id=ID:CalebP-3286-1128542388401-147:0; sequenceNo=412], producerKey = ID:CalebP-3286-1128542388401-147: } ActiveMQMapMessage{ theTable = null } has exceeded its retry count\nDEBUG DefaultBroker                  - ACTIVEMQ_MAP_MESSAGE: id = 0 ActiveMQMessage{ , jmsMessageID = ID:CalebP-3286-1128542388401-147:0, bodyAsBytes = org.activemq.io.util.ByteArray@17f4fbb, readOnlyMessage = false, jmsClientID = 'ID:CalebP-3286-1128542388401-141:0' , jmsCorrelationID = 'null' , jmsDestination = Hello.Queue, jmsReplyTo = null, jmsDeliveryMode = 2, jmsRedelivered = true, jmsType = 'null' , jmsExpiration = 0, jmsPriority = 4, jmsTimestamp = 1128608801246, properties = null, readOnlyProperties = false, entryBrokerName = 'ID:CalebP-1168-1128608656738-0:0' , entryClusterName = 'default' , consumerNos = null, transactionId = 'null' , xaTransacted = false, consumerIdentifer = 'null' , messageConsumed = false, transientConsumed = false, sequenceNumber = 0, deliveryCount = 200, dispatchedFromDLQ = true, messageAcknowledge = null, jmsMessageIdentity = org.activemq.service.MessageIdentity@11d6489b[id=ID:CalebP-3286-1128542388401-147:0; sequenceNo=414], producerKey = ID:CalebP-3286-1128542388401-147: } ActiveMQMapMessage{ theTable = null } sent to DLQ: org.activemq.deadletter.Hello.Queue\nDEBUG DeadLetterPolicy               - Passed message: ACTIVEMQ_MAP_MESSAGE: id = 0 ActiveMQMessage{ , jmsMessageID = ID:CalebP-3286-1128542388401-147:0, bodyAsBytes = org.activemq.io.util.ByteArray@17f4fbb, readOnlyMessage = false, jmsClientID = 'ID:CalebP-3286-1128542388401-141:0' , jmsCorrelationID = 'null' , jmsDestination = Hello.Queue, jmsReplyTo = null, jmsDeliveryMode = 2, jmsRedelivered = true, jmsType = 'null' , jmsExpiration = 0, jmsPriority = 4, jmsTimestamp = 1128608801246, properties = null, readOnlyProperties = false, entryBrokerName = 'ID:CalebP-1168-1128608656738-0:0' , entryClusterName = 'default' , consumerNos = null, transactionId = 'null' , xaTransacted = false, consumerIdentifer = 'null' , messageConsumed = false, transientConsumed = false, sequenceNumber = 0, deliveryCount = 200, dispatchedFromDLQ = true, messageAcknowledge = null, jmsMessageIdentity = org.activemq.service.MessageIdentity@11d6489b[id=ID:CalebP-3286-1128542388401-147:0; sequenceNo=414], producerKey = ID:CalebP-3286-1128542388401-147: } ActiveMQMapMessage{ theTable = null } to DLQ: org.activemq.deadletter.Hello.Queue\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=caleb_phillips","name":"caleb_phillips","key":"caleb_phillips","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Caleb Phillips","active":true,"timeZone":"Etc/UTC"},"created":"2005-10-06T14:45:45.000+0000","updated":"2005-10-06T14:45:45.000+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-350/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tuz3:"}}