{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481763","self":"https://issues.apache.org/jira/rest/api/2/issue/12481763","key":"AMQ-755","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315612","id":"12315612","description":"","name":"4.0.2","archived":false,"released":true,"releaseDate":"2006-07-25"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2006-06-28T20:02:38.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jun 28 20:02:38 UTC 2006","customfield_12310420":"84337","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1054137000_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2006-06-28T20:02:38.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-755/watchers","watchCount":2,"isWatching":false},"created":"2006-06-16T15:13:41.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315610","id":"12315610","name":"4.0","archived":false,"released":true}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-06-28T20:02:38.000+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We have been experiencing some fairly serious problems with timeouts using\nSpring, Lingo and a network of ActiveMQ brokers.\n\nAs I understand it, lingo creates temporary queues to transport the remote\nprocedure calls across JMS.\n\nWe are suspicious that the messaging roundtrip gets interrupted or lost when\nusing broker networks.\n\nWe integrated ActiveMQ 4.0 into our project this week and ran the JMX\njconsole to look at our broker network.\n\nWe see temporary queues come and go, and what we are expecting is complete\nreplication of the queues on each broker. Is this expectation correct?\nThis is not what we are seeing.\n\nWe believe that two things are happening:\n\n1) Temporary queues are not being cleaned up properly on all brokers.\n\n2) Temporary queues are not being created on a new broker when it is taken\ndown and then restarted.\n\nYour feedback on these apparent issues would be appreciated.\n\nTo substantiate our theory we created a couple of JUnit tests. (Our test\ncases do not include Lingo - just ActiveMQ client to broker.)\n\nTEST 1\n\nWe create a network of brokers, create a message queue, send a message and\nthen take a broker down. We are expecting that the temporary message queue\ncreated will be removed from both brokers. It is not.\n\nThe test fails on the last assert with:\n\njunit.framework.AssertionFailedError: No queues on broker 3 expected:<1> but\nwas:<0>\n\nSource code follows:\n\n\n public void testTempQueueCleanup() throws Exception {\n   ActiveMQConnectionFactory cf;\n   Connection conn = null;\n   Session sess = null;\n   try {\n     cf = new ActiveMQConnectionFactory(\n\n\"failover:(tcp://localhost:61626%3FsoTimeout=5000,tcp://localhost:61627%3FsoTimeout=5000)?maximumRetries=0&amp;establishConnectionTimeout=21000&amp;keepAliveTimeout=300000\");\n     conn = cf.createConnection();\n\n     sess = conn.createSession(false, Session.AUTO_ACKNOWLEDGE);\n\n     TemporaryQueue q = sess.createTemporaryQueue();\n\n     BrokerService broker2 = createBroker(\"broken2\",\n\"tcp://localhost:61627\", \"static:(tcp://localhost:61626)\");\n\n     Thread.sleep(5000);\n\n     assertEquals(\"No queues on broker 1\", 1,\nbroker1.getAdminView().getTemporaryQueues().length);\n     assertEquals(\"No queues on broker 2\", 1,\nbroker2.getAdminView().getTemporaryQueues().length);\n\n     q.delete();\n\n     assertEquals(\"Temp queue left behind on broker 1\", 0,\nbroker1.getAdminView().getTemporaryQueues().length);\n     assertEquals(\"Temp queue left behind on broker 2\", 0,\nbroker2.getAdminView().getTemporaryQueues().length);\n\n     broker2.stop();\n\n   } finally {\n     if (sess!=null)\n       sess.close();\n     if (conn!=null)\n       conn.close();\n   }\n }\n\n\nTEST 2\nWhen stopping a broker and then restarting it, we expect to see all queues\nreplicated on the new broker.\n\nThis test fails with:\n\njunit.framework.AssertionFailedError: No queues on broker 3 expected:<1> but\nwas:<0>\n\nSource code:\n\n public void testTempQueueRecovery() throws Exception {\n   ActiveMQConnectionFactory cf;\n   Connection conn = null;\n   Session sess = null;\n   try {\n     cf = new ActiveMQConnectionFactory(\n\n\"failover:(tcp://localhost:61626%3FsoTimeout=5000,tcp://localhost:61627%3FsoTimeout=5000)?maximumRetries=0&amp;establishConnectionTimeout=21000&amp;keepAliveTimeout=300000\");\n     conn = cf.createConnection();\n\n     sess = conn.createSession(false, Session.AUTO_ACKNOWLEDGE);\n\n     TemporaryQueue q = sess.createTemporaryQueue();\n\n     BrokerService broker2 = createBroker(\"broken2\",\n\"tcp://localhost:61627\",\n\"static:(tcp://localhost:61626,tcp://localhost:61628)\");\n\n     Thread.sleep(5000);\n\n     assertEquals(\"No queues on broker 1\", 1,\nbroker1.getAdminView().getTemporaryQueues().length);\n     assertEquals(\"No queues on broker 2\", 1,\nbroker2.getAdminView().getTemporaryQueues().length);\n\n     BrokerService broker3 = createBroker(\"broken3\",\n\"tcp://localhost:61628\",\n\"static:(tcp://localhost:61626,tcp://localhost:61627)\");\n\n     assertEquals(\"No queues on broker 3\", 1,\nbroker3.getAdminView().getTemporaryQueues().length);\n\n     Thread.sleep(5000);\n\n     q.delete();\n\n     Thread.sleep(5000);\n\n     assertEquals(\"Temp queue left behind on broker 1\", 0,\nbroker1.getAdminView().getTemporaryQueues().length);\n     assertEquals(\"Temp queue left behind on broker 2\", 0,\nbroker2.getAdminView().getTemporaryQueues().length);\n     assertEquals(\"Temp queue left behind on broker 3\", 0,\nbroker3.getAdminView().getTemporaryQueues().length);\n\n     broker3.stop();\n     broker2.stop();\n\n   } finally {\n     if (sess!=null)\n       sess.close();\n     if (conn!=null)\n       conn.close();\n   }\n }\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161914","customfield_12312823":null,"summary":"possible bug with temporary queues and networks?","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481763/comment/12938104","id":"12938104","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"I've added a test case to demonstrate this working:\n\nhttps://svn.apache.org/repos/asf/incubator/activemq/trunk/assembly/src/test/java/org/apache/activemq/usecases/ThreeBrokerTempQueueNetworkTest.java\n\nSome things to note - (why this test case works)\n\nFirstly - networkTTL - subscription and destination infomation is sensitive to the the networkTTL - which is the number of broker hops this infomation is allowed to be propogated. The default is one - and I couldn't see this parameter being used on the network connector.\n\nSecondly - the asychronous nature that infomation is propagated. When a tempoaray destination is created by a client - it's a synchronous call to it's local broker. Destination infomation (passed around as advisory messages using an embedded DestinationInfo command) are dispatched asynchronously - primarily to avoided issues with network locks.\n\nSo you'll notice I've added a sleep for a few seconds between the temporary destination delete and the assertion that the temporary destination is in fact removed from all the connected brokers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-28T20:02:38.000+0000","updated":"2006-06-28T20:02:38.000+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-755/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s2pb:"}}