{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13119567","self":"https://issues.apache.org/jira/rest/api/2/issue/13119567","key":"AMQ-6865","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/6","id":"6","description":"The problem isn't valid and it can't be fixed.","name":"Invalid"},"customfield_12312322":null,"customfield_12310220":"2017-11-20T14:12:31.438+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 28 21:01:56 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_24050222_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-11-20T14:12:31.385+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6865/watchers","watchCount":3,"isWatching":false},"created":"2017-11-20T07:31:41.229+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-03-28T21:01:56.117+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We have JBoss AMQ instance of  jboss-a-mq-6.3.0.redhat-187, and we use JDBC for master/slave configuration. \r\nAs per our observation, during networking disruption for connecting to the database, a broker was unable to recover cleanly. \r\nIn hawtio, both master/slave was showing as master, and ActiveMQ tab with amq connection was available on both broker and which resulted in a situation where one app was sending messages to broker01 (which was acting as producer) and all consumers were connected to broker02. \r\nWe have below setting :\r\n\r\n<persistenceAdapter>\r\n             <jdbcPersistenceAdapter dataSource=\"#mysql-ds\" lockKeepAlivePeriod=\"5000\">\r\n                <locker>\r\n                   <lease-database-locker lockAcquireSleepInterval=\"10000\"/>\r\n                </locker>\r\n             </jdbcPersistenceAdapter>\r\n  </persistenceAdapter>\r\n\r\nWe had seen this issue in production, we did not get a chance to look at an activemq_lock table.\r\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"JDBC Master/Slave: Master did not leave lock when the master loose database connection.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pbathia%40redhat.com","name":"pbathia@redhat.com","key":"pbathia@redhat.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pranjal Bathia","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pbathia%40redhat.com","name":"pbathia@redhat.com","key":"pbathia@redhat.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pranjal Bathia","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13119567/comment/16259267","id":"16259267","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Issue with other spins of ActiveMQ not released by the AcitveMQ community require that you seek support from the entity that released them, in this case you should contact Red Hat and log an issue using your support contract if you have one.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-11-20T14:12:31.438+0000","updated":"2017-11-20T14:12:31.438+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13119567/comment/16418074","id":"16418074","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rmars","name":"rmars","key":"rmars","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rohan Mars","active":true,"timeZone":"America/Los_Angeles"},"body":"I've been able to easily reproduce this error on 5.15.3. Use a packet loss strategy between amq and db and the problem will appear instantly.\r\n{code:java}\r\n tc qdisc add dev enp0s9 root netem loss 100%\r\n{code}\r\n \r\n\r\n1) You need to configure the mysql jdbc connection string to timeout before the lease check interval does. The default jdbc mysql connection doesn't timeout, which equivalent timeout settings will be required for any alternative database connection string.\r\n{code:java}\r\njdbc:mysql://dbhost/activemq?relaxAutoCommit=true&amp;useSSL=false&amp;useJDBCCompliantTimezoneShift=true&amp;connectTimeout=3000&amp;socketTimeout=3000\"{code}\r\n \r\n\r\n2) The use of the LeaseLockerIOExceptionHandler is not enabled by default when you use a lease-database-locker, major documentation gap. You need to declare the bean and inject it. Additionally, you need to set back StopStartConnectors to false, so a full restart of the broker occurs (which if it can't reconnect will actually shut down the process). I wasn't convinced that keeping it as \"true\" property shuts down the broker and/or cleans up it's internal state to be a slave mode trying to reconnect, which only occurs in the logs when you restore the packet loss after the original salve has become master.\r\n\r\n \r\n{code:java}\r\n<bean id=\"ioExceptionHandler\" class=\"org.apache.activemq.util.LeaseLockerIOExceptionHandler\">\r\n     <property name=\"stopStartConnectors\"><value>false</value></property>\r\n</bean>\r\n\r\n...\r\n\r\n<broker xmlns=\"http://activemq.apache.org/schema/core\" brokerName=\"amq1\" dataDirectory=\"${activemq.data}\" ioExceptionHandler=\"#ioExceptionHandler\">\r\n\r\n....\r\n{code}\r\nIdeally, ActiveMQ would support starting up in a \"retrying warm mode\" when the persistence adapter is using JDBC by going in a loop trying to startup, i.e. connecting to the database. Shutting down the whole process requires some additional operational overhead. But it appears that would not be a straight forward change based on the current code. \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rmars","name":"rmars","key":"rmars","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rohan Mars","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-28T20:37:36.929+0000","updated":"2018-03-28T20:37:36.929+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13119567/comment/16418098","id":"16418098","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rmars","name":"rmars","key":"rmars","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rohan Mars","active":true,"timeZone":"America/Los_Angeles"},"body":"The exception handler approach is additionally documented using the inbuilt syntax in the Fuse AMQ docs:\r\n\r\n[https://access.redhat.com/documentation/en-us/red_hat_jboss_a-mq/6.2/html/configuring_broker_persistence/mqpersiststorelock#MQLeaseDatabaseLocker]\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rmars","name":"rmars","key":"rmars","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rohan Mars","active":true,"timeZone":"America/Los_Angeles"},"created":"2018-03-28T21:01:56.117+0000","updated":"2018-03-28T21:01:56.117+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6865/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3mzi7:"}}