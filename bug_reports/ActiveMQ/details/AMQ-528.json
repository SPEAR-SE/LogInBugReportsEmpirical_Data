{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481938","self":"https://issues.apache.org/jira/rest/api/2/issue/12481938","key":"AMQ-528","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2006-03-06T20:09:34.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 07 14:23:53 UTC 2007","customfield_12310420":"43785","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_3596099000_*|*_5_*:*_2_*:*_8443598000_*|*_4_*:*_1_*:*_22238325306","customfield_12312321":null,"resolutiondate":"2007-03-07T14:23:53.306+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-528/watchers","watchCount":2,"isWatching":false},"created":"2006-02-03T20:43:31.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315610","id":"12315610","name":"4.0","archived":false,"released":true}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-03-07T14:23:53.299+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Setup: \n\n3 networked brokers, B1, B2, and B3, on 3 servers, connected using multicast discovery. activemq.xml: \n\n <broker useJmx=\"false\" brokerName=\"B1\"> \n  \n <persistenceAdapter> \n        <journaledJDBC journalLogFiles=\"5\" dataDirectory=\"foo\" dataSource=\"#mysql-ds\"/> \n </persistenceAdapter> \n  \n <transportConnectors> \n <transportConnector uri=\"tcp://localhost:61616\" discoveryUri=\"multicast://default\"/> \n </transportConnectors> \n  \n <networkConnectors> \n <networkConnector uri=\"multicast://default\"/> \n </networkConnectors> \n  \n </broker> \n  \n <bean id=\"mysql-ds\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\"> \n           <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/> \n           <property name=\"url\" value=\"jdbc:mysql://localhost/activemq?relaxAutoCommit=true\"/> \n                 <property name=\"username\" value=\"activemqUser\"/> \n                 <property name=\"password\" value=\"activemqPwd\"/> \n                 <property name=\"poolPreparedStatements\" value=\"true\"/> \n </bean> \n\nSimilar for B2 and B3. \n\nTwo queues: Q1 and Q2. \n\nTwo producers, one for each queue, both producers connected to B1. \n\nOne Q1 cosumer connected to B1, another Q1 consumer on B2. \n\nOne Q2 consumer connected to B2, another Q2 consumer connected to B3. \n\nSteps: \n\nStart the brokers and start sending messages to the queue. \n\nAfter a while, stop the brokers (Sequence does not matter) \n\nSee the errors in catalina.out of the Tomcat that has a broker with both producers and consumers connected \n\nThe problems:\n\n1. \n\nException in thread \"ActiveMQ Scheduler\" java.lang.NullPointerException\n         at edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils$SunPerfProvider.nanoTime(Utils.java:219)\n         at edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils.nanoTime(Utils.java:99)\n         at edu.emory.mathcs.backport.java.util.concurrent.ScheduledThreadPoolExecutor.now(ScheduledThreadPoolExecutor.java:88)\n         at edu.emory.mathcs.backport.java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.getDelay(ScheduledThreadPoolExecutor.java:137)\n Exception in thread \"ActiveMQ Scheduler\" Exception in thread \"ActiveMQ Scheduler\" Exception in thread \"ActiveMQ Scheduler\"      at edu.emory.mathcs.backport.java.util.concurrent.DelayQueue.take(DelayQueue.java:154)\n         at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:470)\n         at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:667)\n         at java.lang.Thread.run(Thread.java:595)\n java.lang.NullPointerException\n         at edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils$SunPerfProvider.nanoTime(Utils.java:219)\n Exception in thread \"ActiveMQ Scheduler\" Exception in thread \"ActiveMQ Scheduler\" Exception in thread \"ActiveMQ Scheduler\"      at edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils.nanoTime(Utils.java:99)\n         at edu.emory.mathcs.backport.java.util.concurrent.ScheduledThreadPoolExecutor.now(ScheduledThreadPoolExecutor.java:88)\n         at edu.emory.mathcs.backport.java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.getDelay(ScheduledThreadPoolExecutor.java:137)\n         at edu.emory.mathcs.backport.java.util.concurrent.DelayQueue.take(DelayQueue.java:154)\n         at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:470)\n Exception in thread \"ActiveMQ Scheduler\" Exception in thread \"ActiveMQ Scheduler\"       at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:667)\n         at java.lang.Thread.run(Thread.java:595)\n\n2. The same exception is logged to the log file (in my case catalina.out) for hundreds of times, resulting a log file exceeding 150 MB in 2 minutes. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161488","customfield_12312823":null,"summary":"4.0 M4 NullPointerException while shutting down","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lhu","name":"lhu","key":"lhu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Leon Hu","active":true,"timeZone":"Etc/UTC"},"subtasks":[{"id":"12481473","key":"AMQ-605","self":"https://issues.apache.org/jira/rest/api/2/issue/12481473","fields":{"summary":"Update to backport-util.concurrent 2.1","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lhu","name":"lhu","key":"lhu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Leon Hu","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"RedHat Linux Enterprise Server 3, Tomcat 5.5.15, MySQL 5.0.18 for Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12937485","id":"12937485","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"Given that in the stack trace this exception is being caused inside the backport-util-concurrent code (and there is no ActiveMQ code involved) I'm wondering if this is due to\n\nhttp://jira.activemq.org/jira/browse/AMQ-605","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2006-03-06T20:09:34.000+0000","updated":"2006-03-06T20:09:34.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12937667","id":"12937667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"We've just fixed AMQ-605 - I wonder if you can try reproduce the issue using the latest SVN code? (e.g. using tomorrow's SNAPSHOT build)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2006-03-07T09:02:14.000+0000","updated":"2006-03-07T09:02:14.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12937616","id":"12937616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"I've not heard back so am assuming this is now resolved due to the upgrade of backport-util-concurrent.jar. Please let us know if you are still having problems and we can reopen this issue again","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2006-03-17T11:38:30.000+0000","updated":"2006-03-17T11:38:30.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12938212","id":"12938212","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nextcoder","name":"nextcoder","key":"nextcoder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"will gunadi","active":true,"timeZone":"Etc/UTC"},"body":"Using:\n---------\nbackport-util-concurrent-2.1.jar\nactivemq-core-4.0.jar\nactivemq-ra-4.0.jar\njencks-all-1.1.3.jar\n\nbroker.xml:\n---------------\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://activemq.org/config/1.0\">\n  <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"/>\n\n  <broker useJmx=\"false\" persistent=\"false\">\n\n<!--\n    <persistenceAdapter>\n      <journaledJDBC journalLogFiles=\"5\" dataDirectory=\"foo\"/>\n    </persistenceAdapter>\n-->\n\n    <transportConnectors>\n      <transportConnector uri=\"tcp://localhost:51616\"/>\n    </transportConnectors>\n\n  </broker>\n\n</beans>\n\nException when shutting down tomcat:\n----------------------------------------------------\n\ntomcat@jupiter:~/dev/env/apache-tomcat-5.5.15/bin$ ./shutdown.sh\nUsing CATALINA_BASE:   /home/tomcat/dev/env/apache-tomcat-5.5.15\nUsing CATALINA_HOME:   /home/tomcat/dev/env/apache-tomcat-5.5.15\nUsing CATALINA_TMPDIR: /home/tomcat/dev/env/apache-tomcat-5.5.15/temp\nUsing JRE_HOME:       /usr/lib/j2sdk1.5-sun\nJun 22, 2006 4:53:19 PM org.apache.coyote.http11.Http11BaseProtocol pause\nINFO: Pausing Coyote HTTP/1.1 on http-8080\ntomcat@jupiter:~/dev/env/apache-tomcat-5.5.15/bin$ Jun 22, 2006 4:53:20 PM org.a\npache.catalina.core.StandardService stop\nINFO: Stopping service Catalina\nJun 22, 2006 4:53:22 PM org.apache.coyote.http11.Http11BaseProtocol destroy\nINFO: Stopping Coyote HTTP/1.1 on http-8080\nJun 22, 2006 4:53:22 PM org.apache.catalina.core.AprLifecycleListener lifecycleE\nvent\nINFO: Failed shutdown of Apache Portable Runtime\nException in thread \"AcitveMQ Connection Worker: tcp://localhost/127.0.0.1:51616\n\" Exception in thread \"AcitveMQ Connection Worker: tcp://localhost/127.0.0.1:516\n16\" java.lang.NullPointerException\n        at edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils$SunPerfP\nrovider.nanoTime(Utils.java:223)\nException in thread \"AcitveMQ Connection Worker: tcp://localhost/127.0.0.1:51616\n\"       at edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils.nanoTime\n(Utils.java:103)\n        at edu.emory.mathcs.backport.java.util.concurrent.LinkedBlockingQueue.po\nll(LinkedBlockingQueue.java:336)\n        at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor.get\nTask(ThreadPoolExecutor.java:482)\n        at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor$Wor\nker.run(ThreadPoolExecutor.java:674)\nException in thread \"AcitveMQ Connection Worker: tcp://localhost/127.0.0.1:51616\n\"       at java.lang.Thread.run(Thread.java:595)\njava.lang.NullPointerException\n        at edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils$SunPerfP\nrovider.nanoTime(Utils.java:223)\n        at edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils.nanoTime\n(Utils.java:103)\nException in thread \"AcitveMQ Connection Worker: tcp://localhost/127.0.0.1:51616\n\"       at edu.emory.mathcs.backport.java.util.concurrent.LinkedBlockingQueue.po\nll(LinkedBlockingQueue.java:336)\n        at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor.get\nTask(ThreadPoolExecutor.java:482)\n        at edu.emory.mathcs.backport.java.util.concurrent.ThreadPoolExecutor$Wor","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nextcoder","name":"nextcoder","key":"nextcoder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"will gunadi","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-23T05:05:07.000+0000","updated":"2006-06-23T05:05:07.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12938123","id":"12938123","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=h2o","name":"h2o","key":"h2o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=h2o&avatarId=30235","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=h2o&avatarId=30235","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=h2o&avatarId=30235","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=h2o&avatarId=30235"},"displayName":"Holger Hoffstätte","active":true,"timeZone":"Europe/Berlin"},"body":"This one is *really* weird so I decided to ask Dawid Kurzyniec what might cause this. Here's his reply:\n\nDawid Kurzyniec wrote:\n> Holger Hoffstätte wrote:\n>> Hello Dawid -\n>>\n>> Could you please have a quick look at\n>> https://issues.apache.org/activemq/browse/AMQ-528 and maybe post a\n>> comment if you have any idea what might be going wrong there? It's very weird.\n>>\n> \n> I think the exception may be originating from native code\n> (perf.highResCounter()). I suppose that something is freed in the JVM in\n> the course of the shutdown, making it respond badly to highResCounter\n> and resulting in the exception. (I've seen some analogous behavior with\n> Java 1.4 logging: the loggers won't initialize during shutdown, so they\n> won't print anything unless they did before the shutdown initiated).\n> \n> If this is the case, there's not much there can be done about it, except\n> 1) trying a different JVM, or 2) switching to a different NanoTimer (for\n> instance,\n>-Dedu.emory.mathcs.backport.java.util.concurrent.NanoTimerProvider=edu.emory.mathcs.backport.java.util.concurrent.helpers.Utils.MillisProvider,\n> or to use a custom nanotimer if you need more than ms granularity).\n> \n> Regards,\n> Dawid\n> \n\nI'll try to see if the native JDK 1.5 nanoTimer could be used dynamically; this might help. The other thing that the stack traces show is that the queue in question is the work queue of an ExecutorService, so it seems to me that properly shutting down that service would also solve the problem of the timer going away prematurely.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=h2o","name":"h2o","key":"h2o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=h2o&avatarId=30235","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=h2o&avatarId=30235","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=h2o&avatarId=30235","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=h2o&avatarId=30235"},"displayName":"Holger Hoffstätte","active":true,"timeZone":"Europe/Berlin"},"created":"2006-06-23T20:34:26.000+0000","updated":"2006-06-23T20:34:26.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12937809","id":"12937809","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=h2o","name":"h2o","key":"h2o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=h2o&avatarId=30235","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=h2o&avatarId=30235","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=h2o&avatarId=30235","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=h2o&avatarId=30235"},"displayName":"Holger Hoffstätte","active":true,"timeZone":"Europe/Berlin"},"body":"Quick follow-up:\n\n>> Thanks a lot for clearing this up. Would it be possible for the nanoTimer\n>> to discover the native JDK 1.5 timer when running on JDK 1.5+? That would\n>> not help with the bug on JDK 1.4 but it could be a start. I guess with\n>> more people using the backport but running on JDK 1.5 anyway this\n>> would be\n>> nice to have.\n>>   \n> Yes; in fact, I am planning to create a version of the backport for 1.5\n> that would perform with native speed (using native atomics etc). Next\n> release of the backport will probably have that.\n> \n>> I guess another way would be to prevent the queues (further up the stack)\n>> from running before the timer is shut down internally and gets a\n>> chance to explode.\n>>   \n> \n> That would probably work, if you can ensure it.\n> \n> Regards,\n> Dawid\n\nSo it seems a proper shutdown of the Executor will solve this.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=h2o","name":"h2o","key":"h2o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=h2o&avatarId=30235","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=h2o&avatarId=30235","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=h2o&avatarId=30235","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=h2o&avatarId=30235"},"displayName":"Holger Hoffstätte","active":true,"timeZone":"Europe/Berlin"},"created":"2006-06-23T20:51:10.000+0000","updated":"2006-06-23T20:51:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12938101","id":"12938101","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nextcoder","name":"nextcoder","key":"nextcoder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"will gunadi","active":true,"timeZone":"Etc/UTC"},"body":"Holger wrote:\n\n> So it seems a proper shutdown of the Executor will solve this.\n\nIs this something that can be done from the application code? \nor do I have to wait for the new version of the backport-*.jar? what's the ETA if I may ask?\n\nI tried to use the backport MillisProvider but I can't get the JVM to see the class (ClassNotFoundException) no matter where i put the backport*.jar file (I even tried it in tomcat's /shared/lib and it still can't find the class).  Yet the class is there, albeit it looks like an inner class (??)\n\nUntil Sun releases the next jvm after 1.5_06 for Linux, I don't have any other JVM to go to.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nextcoder","name":"nextcoder","key":"nextcoder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"will gunadi","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-24T21:36:18.000+0000","updated":"2006-06-24T21:36:18.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12937935","id":"12937935","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=h2o","name":"h2o","key":"h2o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=h2o&avatarId=30235","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=h2o&avatarId=30235","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=h2o&avatarId=30235","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=h2o&avatarId=30235"},"displayName":"Holger Hoffstätte","active":true,"timeZone":"Europe/Berlin"},"body":"Note: I'm not a dev on AMQ or the backport; I just use them myself.\n\n>Is this something that can be done from the application code?\n\nNo, it is a bug in ActiveMQ (as far as I can tell) so it needs to be fixed there.\n\nHolger\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=h2o","name":"h2o","key":"h2o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=h2o&avatarId=30235","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=h2o&avatarId=30235","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=h2o&avatarId=30235","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=h2o&avatarId=30235"},"displayName":"Holger Hoffstätte","active":true,"timeZone":"Europe/Berlin"},"created":"2006-06-24T21:49:58.000+0000","updated":"2006-06-24T21:49:58.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12937954","id":"12937954","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Ajusted target fix version so that it shows up on the roadmap right.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-07-02T02:07:43.000+0000","updated":"2006-07-02T02:07:43.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12938186","id":"12938186","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Hi Holger,\n\nDo you have a patch that you think might fix this issue?  I've never seen this bug so without a test case to reproduce it's going to be hard to build a fix for it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-07-11T21:39:11.000+0000","updated":"2006-07-11T21:39:11.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12938254","id":"12938254","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=h2o","name":"h2o","key":"h2o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=h2o&avatarId=30235","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=h2o&avatarId=30235","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=h2o&avatarId=30235","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=h2o&avatarId=30235"},"displayName":"Holger Hoffstätte","active":true,"timeZone":"Europe/Berlin"},"body":"I did not originally experience this bug and don't have a fix for it - I just got curious what might be causing the NPE inside the backport. However if you read my mail exchange with Dawid it seems to me that the problem is a GC race on shutdown between the deallocated timer and the Executor that has not yet been shut down properly. Obviously it is difficult to devise a \"simple\" test case & patch for a GC race, however it seems obvious from the stack trace that there's a still-running Executor somewhere that tries to use the freed counter. This is a typical problem with the badly designed VM shutdownHook mechanism which does not allow for dependenies or hook ordering. (admittedly this is a difficult problem)\nSo long story short, no I don't know what to do. You can try to run the \"main\" AMQ shutdown hook with a higher priority but that is not what I would call reliable.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=h2o","name":"h2o","key":"h2o","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=h2o&avatarId=30235","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=h2o&avatarId=30235","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=h2o&avatarId=30235","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=h2o&avatarId=30235"},"displayName":"Holger Hoffstätte","active":true,"timeZone":"Europe/Berlin"},"created":"2006-07-11T22:08:58.000+0000","updated":"2006-07-11T22:08:58.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481938/comment/12938879","id":"12938879","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"I'm hopeful this issue is resolevd in 4.2 as we'll be using Java 5's concurrent libraries and not rely on issues in backport-util-concurrent. Do let us know if it shows up again and we can reopen","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-07T14:23:53.292+0000","updated":"2007-03-07T14:23:53.292+0000"}],"maxResults":12,"total":12,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-528/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s02n:"}}