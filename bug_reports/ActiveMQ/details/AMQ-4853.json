{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12677814","self":"https://issues.apache.org/jira/rest/api/2/issue/12677814","key":"AMQ-4853","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-11-07T15:52:26.996+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jan 21 20:34:35 UTC 2015","customfield_12310420":"357189","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_421809525_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-11-11T14:57:37.126+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4853/watchers","watchCount":6,"isWatching":false},"created":"2013-11-06T17:47:27.636+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-21T20:34:35.471+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"After upgrading from AMQ 5.8 to 5.9 we have seen cpu usage continually climb until AMQ threads are taking nearly all of the CPU Resources while remaining fairly idle. This is just a single broker with advisory support on. (Advisory support is on in this case as we run the same config for a network of brokers.) Turning off advisory support reduced the CPU load to single digits.\n\ntop -H output:\nCpu(s): 97.8%us,  2.1%sy,  0.0%ni,  0.0%id,  0.0%wa,  0.0%hi,  0.1%si,  0.0%st\nMem:   7872040k total,  6574324k used,  1297716k free,   301028k buffers\nSwap:        0k total,        0k used,        0k free,  1635392k cached\n\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                                                                                                                          \n25476 root      16   0 2173m 891m  11m R 14.4 11.6  86:12.10 java                                                                                                                                              \n25472 root      15   0 2173m 891m  11m R 13.6 11.6  86:09.77 java                                                                                                                                              \n25155 root      16   0 2173m 891m  11m R  9.8 11.6  86:26.13 java                                                                                                                                              \n25471 root      16   0 2173m 891m  11m R  9.2 11.6  86:12.93 java                                                                                                                                              \n25514 root      16   0 2173m 891m  11m R  9.2 11.6  86:15.12 java                                                                                                                                              \n25202 root      16   0 2173m 891m  11m R  8.7 11.6  86:33.20 java                                                                                                                                              \n25189 root      16   0 2173m 891m  11m S  8.4 11.6  86:24.65 java                                                                                                                                              \n25274 root      16   0 2173m 891m  11m R  8.1 11.6  86:18.45 java                                                                                                                                              \n19272 root      15   0 2173m 891m  11m S  8.1 11.6   8:40.19 java                                                                                                                                              \n20039 root      15   0 2173m 891m  11m S  8.1 11.6   8:15.53 java                                                                                                                                              \n19270 root      15   0 2173m 891m  11m R  7.8 11.6   8:35.85 java                                                                                                                                              \n25134 root      16   0 2173m 891m  11m R  7.5 11.6  90:42.29 java                                                                                                                                              \n25259 root      15   0 2173m 891m  11m R  7.5 11.6  90:30.02 java                                                                                                                                              \n25474 root      16   0 2173m 891m  11m R  7.5 11.6  86:13.24 java                                                                                                                                              \n25475 root      16   0 2173m 891m  11m R  7.5 11.6  86:11.74 java                                                                                                                                              \n25483 root      16   0 2173m 891m  11m R  7.5 11.6  86:12.30 java                                                                                                                                              \n25210 root      15   0 2173m 891m  11m R  7.2 11.6  90:35.24 java                                                                                                                                              \n25129 root      16   0 2173m 891m  11m S  6.9 11.6  90:31.27 java                                                                                                                                              \n25249 root      16   0 2173m 891m  11m S  6.9 11.6  86:18.35 java                                                                                                                                              \n25489 root      16   0 2173m 891m  11m R  6.9 11.6  86:16.93 java                                                                                                                                              \n 9971 root      15   0 2173m 891m  11m S  6.6 11.6  38:53.66 java                                                                                                                                              \n25116 root      16   0 2173m 891m  11m R  6.3 11.6  90:28.39 java                                                                                                                                              \n25513 root      16   0 2173m 891m  11m R  6.3 11.6  86:07.62 java    \n\n\nThread dump snippets:\n\nPID 25476 --\n\"ActiveMQ Transport: tcp:///10.33.154.95:48799@61616\" daemon prio=10 tid=0x00002aaaf5288800 nid=0x6384 runnable [0x00000000489b1000]\n   java.lang.Thread.State: RUNNABLE\n\tat java.util.concurrent.ConcurrentLinkedQueue.remove(ConcurrentLinkedQueue.java:346)\n\tat org.apache.activemq.advisory.AdvisoryBroker.removeConsumer(AdvisoryBroker.java:270)\n\tat org.apache.activemq.broker.BrokerFilter.removeConsumer(BrokerFilter.java:132)\n\tat org.apache.activemq.broker.BrokerFilter.removeConsumer(BrokerFilter.java:132)\n\tat org.apache.activemq.broker.MutableBrokerFilter.removeConsumer(MutableBrokerFilter.java:137)\n\tat org.apache.activemq.broker.TransportConnection.processRemoveConsumer(TransportConnection.java:619)\n\tat org.apache.activemq.command.RemoveInfo.visit(RemoveInfo.java:76)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:292)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:149)\n\tat org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\n\tat org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)\n\tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n\tat org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)\n\tat java.lang.Thread.run(Thread.java:619)\n\n\nPID - 25473\n\"ActiveMQ Transport: tcp:///10.33.154.95:48802@61616\" daemon prio=10 tid=0x00002aaaf6afc800 nid=0x6381 runnable [0x000000004779f000]\n   java.lang.Thread.State: RUNNABLE\n\tat java.util.concurrent.ConcurrentLinkedQueue.remove(ConcurrentLinkedQueue.java:346)\n\tat org.apache.activemq.advisory.AdvisoryBroker.removeConsumer(AdvisoryBroker.java:270)\n\tat org.apache.activemq.broker.BrokerFilter.removeConsumer(BrokerFilter.java:132)\n\tat org.apache.activemq.broker.BrokerFilter.removeConsumer(BrokerFilter.java:132)\n\tat org.apache.activemq.broker.MutableBrokerFilter.removeConsumer(MutableBrokerFilter.java:137)\n\tat org.apache.activemq.broker.TransportConnection.processRemoveConsumer(TransportConnection.java:619)\n\tat org.apache.activemq.command.RemoveInfo.visit(RemoveInfo.java:76)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:292)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:149)\n\tat org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\n\tat org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)\n\tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n\tat org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)\n\tat java.lang.Thread.run(Thread.java:619)\n\n\nPID 25471 --\n\"ActiveMQ Transport: tcp:///10.33.154.95:48803@61616\" daemon prio=10 tid=0x00002aaaf6f4b800 nid=0x6380 runnable [0x00000000487af000]\n   java.lang.Thread.State: RUNNABLE\n\tat java.util.concurrent.ConcurrentLinkedQueue.remove(ConcurrentLinkedQueue.java:346)\n\tat org.apache.activemq.advisory.AdvisoryBroker.removeConsumer(AdvisoryBroker.java:270)\n\tat org.apache.activemq.broker.BrokerFilter.removeConsumer(BrokerFilter.java:132)\n\tat org.apache.activemq.broker.BrokerFilter.removeConsumer(BrokerFilter.java:132)\n\tat org.apache.activemq.broker.MutableBrokerFilter.removeConsumer(MutableBrokerFilter.java:137)\n\tat org.apache.activemq.broker.TransportConnection.processRemoveConsumer(TransportConnection.java:619)\n\tat org.apache.activemq.command.RemoveInfo.visit(RemoveInfo.java:76)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:292)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:149)\n\tat org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\n\tat org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)\n\tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n\tat org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)\n\tat java.lang.Thread.run(Thread.java:619)\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12612811","id":"12612811","filename":"amqAdvirsoryCPUIssue.jpg","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-08T11:01:21.668+0000","size":219797,"mimeType":"image/jpeg","content":"https://issues.apache.org/jira/secure/attachment/12612811/amqAdvirsoryCPUIssue.jpg"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"357479","customfield_12312823":null,"summary":"Advisory support leads to excessive CPU usage","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13816070","id":"13816070","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"You should investigate why all the consumers are coming and going so often.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-11-07T15:52:26.996+0000","updated":"2013-11-07T15:52:26.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13816093","id":"13816093","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"body":"I am. But it is worrying that Activemq 5.9 seemingly can't handle the consumers coming and going in the same way as 5.8. Also, it isn't just that the CPU usage is higher but that it continually grows. \n\nI am also looking over the changes from 5.8 to 5.9 in case something jumps out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-07T16:15:35.842+0000","updated":"2013-11-07T16:15:35.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13816125","id":"13816125","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"body":"Timothy,\n\nI just had a look at the code and I believe I see what the issue is. The change you made[1] moving the consumers hashmap to a queue is causing the performance issue. We have quite a few consumers so on remove we would have to potentially traverse all the consumers to remove the one. \n\nAs far as our code we do use camel with maxConsumers settings and request reply messages. So I would expect a bit of churn when it comes consumers coming and going.\n\n1. https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=commitdiff;h=74dafd7f24028c3503758581166ec10bb3d5116a","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-07T17:05:17.787+0000","updated":"2013-11-07T17:05:17.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13816154","id":"13816154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"The code that was there, using the map was completely broken so the Queue was used instead.  If you want to create a test case that shows how this impacts performance we can look to try and improve things however the basic functionality needs to stand as it resolves issues with replaying advisories over a network in the correct order.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-11-07T17:29:46.166+0000","updated":"2013-11-07T17:29:46.166+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13817062","id":"13817062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"LinkedHashMap may be the way to go on this one","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-08T07:01:52.548+0000","updated":"2013-11-08T07:01:52.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13817176","id":"13817176","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"body":"+1 Rob.\n\nTim,\nI will try to come up with a stress test for this code. Attached is a Profiling session when the cpu was at nearly 100% usage to show just how badly it is performing. (Note: we were not seeing such CPU usage issues in 5.8.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-08T11:01:21.673+0000","updated":"2013-11-08T11:01:51.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13817518","id":"13817518","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"body":"After doing a bit more research I think the issue is a bit more fundamental than simply using the Queue vs a Map. (The queue implementation definitely makes it worse.) I have been looking at the profiling information more and doing a few tests. I see that the queue is continually growing. Digging a bit deeper I see that the ConsumerInfo class does not have an equals method. Without an equals method the consumers.remove() call in AdvisoryBroker.removeConsumer is pretty useless if we ever create another consumer info object - which I believe to be the case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-08T18:01:00.833+0000","updated":"2013-11-08T18:01:00.833+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13817553","id":"13817553","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"body":"For completeness a unit test:\n{code}\n  public void testEqualsNeeded() throws Exception{\n    \t  //setup\n    \t  AdvisoryBroker testObj = (AdvisoryBroker) broker.getBroker().getAdaptor(\n      \t\t\tAdvisoryBroker.class);\n    \t  ActiveMQDestination destination = new ActiveMQQueue(\"foo\");\n          ConnectionInfo connectionInfo = createConnectionInfo();\n          ConnectionContext connectionContext =  new ConnectionContext(connectionInfo);\n          connectionContext.setBroker(broker.getBroker());\n          SessionInfo sessionInfo = createSessionInfo(connectionInfo);\n          ConsumerInfo consumerInfo = createConsumerInfo(sessionInfo, destination);\n          \n          testObj.addConsumer(connectionContext, consumerInfo);\n          ConsumerInfo duplicateConsumer = consumerInfo.copy();\n          \n          //act\n          testObj.removeConsumer(connectionContext, duplicateConsumer);\n          \n          \n          //assert\n          assertEquals(0, testObj.getAdvisoryConsumers().size()); \n    }\n\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-08T18:39:22.234+0000","updated":"2013-11-08T18:40:24.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13817592","id":"13817592","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Yes, there's definitely some issues to tackle. Can you attach you test as a complete Java source file?  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-11-08T19:19:41.757+0000","updated":"2013-11-08T19:19:41.757+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13817677","id":"13817677","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"I've added the appropriate equals and hashCode overrides on trunk for ConsumerInfo which when run with this test reduces the time from 182 seconds to 2 seconds.  \n\n{code}\n    @Test\n    public void testEqualsNeeded() throws Exception {\n        // setup\n        AdvisoryBroker testObj = (AdvisoryBroker) brokerService.getBroker().getAdaptor(AdvisoryBroker.class);\n        ActiveMQDestination destination = new ActiveMQQueue(\"foo\");\n        ConnectionInfo connectionInfo = createConnectionInfo();\n        ConnectionContext connectionContext = new ConnectionContext(connectionInfo);\n        connectionContext.setBroker(brokerService.getBroker());\n        SessionInfo sessionInfo = createSessionInfo(connectionInfo);\n\n        long start = System.currentTimeMillis();\n\n        for (int i = 0; i < 100; ++i) {\n\n            for (int j = 0; j < 1000; j++) {\n                ConsumerInfo consumerInfo = createConsumerInfo(sessionInfo, i, destination);\n                testObj.addConsumer(connectionContext, consumerInfo);\n                ConsumerInfo duplicateConsumer = consumerInfo.copy();\n                testObj.removeConsumer(connectionContext, duplicateConsumer);\n            }\n        }\n\n        long finish = System.currentTimeMillis();\n\n        long totalTime = finish - start;\n\n        LOG.info(\"Total test time: {} seconds\", TimeUnit.MILLISECONDS.toSeconds(totalTime));\n\n        // assert\n        // assertEquals(0, testObj.getAdvisoryConsumers().size());\n    }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-11-08T21:08:08.740+0000","updated":"2013-11-08T21:08:08.740+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13818868","id":"13818868","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"body":"Timothy, Thanks for that. I am on GMT and missed the message. Can we get this patched in 5.9 with a new release? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-11T11:09:53.283+0000","updated":"2013-11-11T11:09:53.283+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13819009","id":"13819009","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Fixed on trunk, will appear in the next release.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-11-11T14:57:37.153+0000","updated":"2013-11-11T14:57:37.153+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/13819139","id":"13819139","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"body":"Is there no possibility of getting this ported to the 5.9 and getting a 5.9.1 release? (Perhaps folding in a fix for the \"Leveldb being corrupted in a cluster\" for 5.9.1? [1]) As 5.9 just came out, then trunk would not be released for another ~6 months. This is a pretty long time to go with Advisory support and therefore broker networks being effectively broken (unless they are statically configured). Furthermore this is worse than a normal memory leak because the CPU will eventually become pegged.\n\n\n1. https://issues.apache.org/jira/browse/AMQ-4837","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jwatkins","name":"jwatkins","key":"jwatkins","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joshua Watkins","active":true,"timeZone":"Etc/UTC"},"created":"2013-11-11T17:23:57.452+0000","updated":"2013-11-11T17:23:57.452+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677814/comment/14286213","id":"14286213","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"body":"Also see https://issues.apache.org/jira/browse/AMQ-5337","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=joef","name":"joef","key":"joef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joe Fernandez","active":true,"timeZone":"America/New_York"},"created":"2015-01-21T20:34:35.471+0000","updated":"2015-01-21T20:34:35.471+0000"}],"maxResults":14,"total":14,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4853/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1pkr3:"}}