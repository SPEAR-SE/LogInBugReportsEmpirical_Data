{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483504","self":"https://issues.apache.org/jira/rest/api/2/issue/12483504","key":"AMQ-2622","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315624","id":"12315624","description":"Maintenance release for 5.4.0","name":"5.4.1","archived":false,"released":true,"releaseDate":"2010-09-21"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-02-22T21:16:21.931+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 08 11:25:52 UTC 2010","customfield_12310420":"14809","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2583016381_*|*_5_*:*_2_*:*_14505126487_*|*_4_*:*_1_*:*_1295057","customfield_12312321":null,"resolutiondate":"2010-09-08T11:25:52.295+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2622/watchers","watchCount":2,"isWatching":false},"created":"2010-02-22T16:21:54.370+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-09-08T11:25:52.245+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have outlined the problem in the following forum link: \n\nhttp://old.nabble.com/URGENT-QUESTION:-AMQ-5.3.0-bug-or-configuration-error------ObjectMessage-is--still--being-serialized-when-using-setObjectMessageSerializationDefered-and-setCopyMessageOnSend-td27654579.html\n\nI have not created a JUnit test that demonstrates this, but here are the basic steps to reproduce this:\n* create an embedded broker with no persistence, dedicatedTaskRunner = false, and optimizedDispatch = true\n* create the ActiveMQConnectionFactory and set the setObjectMessageSerializationDefered = TRUE and setCopyMessageOnSend = FALSE\n* create your connection from the factory\n* create a producer and [MessageListener] consumer against a Queue\n* create your own custom java object that implements Externalizable - this is important, because you will be able to set a breakpoint in the readExternal and writeExternal methods to see the 2 locations on the AMQ code where the message is copied - causing a serialization/de-serialization\n* create a new ObjectMessage and send it from the producer to the consumer\n\nThe message will get serialized in ActiveMQConnection.java on this line [msg = msg.copy();] - see the linked forum issue for the code snippet and line numbers. \n\nNOTE: you will need to continue stepping the code through the complete dispatch process because it will go through a de-serialization phase as well when the call to getObject is called in the onMessage of the MessageListener.\n\nPlease let me know if I can provide any more details - OR, if I'm not setting something properly to keep the ObjectMessage from being serialized.\n\nThanks,\nBob","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461627","id":"12461627","filename":"unit-test.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"created":"2010-02-22T21:16:21.895+0000","size":8860,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461627/unit-test.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"63770","customfield_12312823":null,"summary":"ObjectMessage is [still] being serialized and de-serialized when using setObjectMessageSerializationDefered and setCopyMessageOnSend in local vm:// scenario","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bob.deremer","name":"bob.deremer","key":"bob.deremer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bob DeRemer","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bob.deremer","name":"bob.deremer","key":"bob.deremer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bob DeRemer","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows Server 2008 R2, 64-bit, binary download of ActiveMQ 5.3.0, Java 1.6.0_17 (64-bit), Eclipse 3.5 (64-bit), tomcat 6.0 (64-bit)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483504/comment/12942269","id":"12942269","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"body":"Here's a unit test patch that shows the problem, am currently looking into a fix for this also.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=slewis","name":"slewis","key":"slewis","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=slewis&avatarId=12536","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=slewis&avatarId=12536","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=slewis&avatarId=12536","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=slewis&avatarId=12536"},"displayName":"Stan Lewis","active":true,"timeZone":"America/New_York"},"created":"2010-02-22T21:16:21.931+0000","updated":"2010-02-22T21:16:21.931+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483504/comment/12942177","id":"12942177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolved in r927054\n\nObjectMessage.copy is now respects setObjectMessageSerializationDefered","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-24T13:52:10.662+0000","updated":"2010-03-24T13:52:10.662+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483504/comment/12942758","id":"12942758","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thammoud","name":"thammoud","key":"thammoud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarek Hammoud","active":true,"timeZone":"Etc/UTC"},"body":"Hi, I tested this fix and encountered a case where this mechanism does not seem to work properly. Here is the scenario we have:\n\nA server that has a producer. The producer communicates with the local broker using the vm://. There are local consumers that listen on the topic being published to in the same VM. All consumers that are local in the same VM work as advertised without any serialization thanks to this fix. \n\nHere is the problem:\n\nRemote consumers communicate to the broker using TCP for the same topic. When the producer sends the message to the destination, it is being sent over the vm:// and ObjectMessage has content set to null and a valid object. The broker then tries to send the message to the remote client with null contents causing errors.\n\nIt seems that perhaps, ObjectMessage should override getContent() to detect this situation. i.e if object != null and content is null, then serialize first and then return the content. I am sure you have a better solution to this issue. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=thammoud","name":"thammoud","key":"thammoud","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarek Hammoud","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-02T23:03:02.421+0000","updated":"2010-06-02T23:03:02.421+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483504/comment/12942859","id":"12942859","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"when a deferred serializable message is marshaled it needs to serialize, as described in the case of a vm non serialized message to a topic with multiple consumers, some of which don't use vm: transport and as a result need marshaling.\nQuery ordering? if the non vm: consumer is dispatched to before the vm: consumer, will it negate the non serialization for the vm consumer?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-08T11:04:17.176+0000","updated":"2010-09-08T11:04:17.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483504/comment/12942860","id":"12942860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolved in r994990\n\nthe issue of ordering disappears as each consumer gets its own copy, so an objects write operation will be called but reads will happen in unserialised copies. The serialisation is now called before marshalling which will only be invoked for non vm transports. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-08T11:25:52.236+0000","updated":"2010-09-08T11:25:52.236+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2622/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ba8f:"}}