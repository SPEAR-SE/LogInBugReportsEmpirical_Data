{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12623010","self":"https://issues.apache.org/jira/rest/api/2/issue/12623010","key":"AMQ-4214","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2012-12-12T23:28:54.092+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon May 13 22:23:53 UTC 2013","customfield_12310420":"296600","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_13513017552_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-05-13T22:23:53.923+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4214/watchers","watchCount":2,"isWatching":false},"created":"2012-12-08T12:46:56.421+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-13T22:23:53.970+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"2012-12-07 13:07:06,317 | WARN  | Failed to browse Topic: AllDocumentsTopic | org.apache.activemq.broker.region.Topic | ActiveMQ Broker[localhost] Scheduler\njava.lang.IllegalStateException: PageFile is not loaded\n        at org.apache.kahadb.page.PageFile.assertLoaded(PageFile.java:809)\n        at org.apache.kahadb.page.PageFile.tx(PageFile.java:303)\n        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.recover(KahaDBStore.java:523)\n        at org.apache.activemq.store.ProxyTopicMessageStore.recover(ProxyTopicMessageStore.java:62)\n        at org.apache.activemq.store.ProxyTopicMessageStore.recover(ProxyTopicMessageStore.java:62)\n        at org.apache.activemq.broker.region.Topic.doBrowse(Topic.java:570)\n        at org.apache.activemq.broker.region.Topic.access$100(Topic.java:63)\n        at org.apache.activemq.broker.region.Topic$6.run(Topic.java:695)\n        at org.apache.activemq.thread.SchedulerTimerTask.run(SchedulerTimerTask.java:33)\n        at java.util.TimerThread.mainLoop(Timer.java:512)\n        at java.util.TimerThread.run(Timer.java:462)\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"233170","customfield_12312823":null,"summary":"PageFile is not loaded","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdblack98","name":"mdblack98","key":"mdblack98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Black","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdblack98","name":"mdblack98","key":"mdblack98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Black","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Red Hat Enterprise Linux Server release 5.7 (Tikanga)\nSystem had been up for 15 days.\nThe \"Messages Enqueued\" in the Topics tab for our topic was negative (~-63000)\nThe Subscriber tab showed about 14,000 in the Pending Queue Size and was not decreasing.  Messages Enqueued/Dequeued were incrementing and messages were being delivered (this is a real-time queue).\nSo I deleted the Q.  Then we could not recreate the Q and got the message below.\nOther topics in the system appeared to be fine.\nI had been doing a fair amount of testing on client error recover dropping port connections and IP connections using the firewall so was aborting connections frequently (though not doing a lot at once).\nA number of times (due to a bug) tried to make a duplication connection to the Q.  I'm not sure exactly when the topic went haywire.\nWe are running over a WAN with about 30ms latency.\nCan't think of anything else we were doing different than anybody else.\nHere's our connection\n            ActiveMQConnectionFactory tcf =new ActiveMQConnectionFactory(cs);\n            conn = tcf.createTopicConnection();\n            String iName = prop.getTopicSubscriberName();\n            conn.setClientID(iName);\n            session = conn.createTopicSession(false,TopicSession.AUTO_ACKNOWLEDGE);\n            topic = session.createTopic(prop.getBigDataRepositoryTopicName());\n            conn.start();\n            String sName = iName;\n            subscriber = session.createDurableSubscriber(topic, sName);\n\n","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12623010/comment/13530486","id":"13530486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Can you provide any further details here, broker logs?  Unit tests?  Broker config?  Context on when this happens/happened?  Anything???","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-12-12T23:28:54.092+0000","updated":"2012-12-12T23:28:54.092+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12623010/comment/13531257","id":"13531257","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdblack98","name":"mdblack98","key":"mdblack98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Black","active":true,"timeZone":"America/Chicago"},"body":"Unfortunately I haven't been able to reproduce yet though I'm not doing the firewall testing like I was doing which may have precipitated this.\n\nI would think just checking for negative numbers might help on the server side...seems to me that's not something that should ever happen.   How could Pending ever go negative?\n\nMichael D. Black\nSenior Scientist\nAdvanced Analytics Directorate\nAdvanced GEOINT Solutions Operating Unit\nNorthrop Grumman Information Systems\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdblack98","name":"mdblack98","key":"mdblack98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Black","active":true,"timeZone":"America/Chicago"},"created":"2012-12-13T18:10:11.887+0000","updated":"2012-12-13T18:10:11.887+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12623010/comment/13532309","id":"13532309","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdblack98","name":"mdblack98","key":"mdblack98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Black","active":true,"timeZone":"America/Chicago"},"body":"One thing I can add....here is the script I was running to test our error checking.\nOur system retrieves a small message containing a document name from \"activemq\" below and then gets the document itself from another system (a mysql database called UDR).\n\nThe script either blocks the IP address completely (network down) or rejects the packet (service down).\n\nSo my suspicion is that doing \"./fw.sh activemq down\" or \"./fw.sh activemq reject\" or the combo is what caused this.  Perhaps in the middle of a receive or while the receive was in wait status.  And messages were being deposited in the topic (though probably at rate of maybe 1 to 10 per second...it's a realtime news feed so it varies).  During my testing the topic queue did have thousands of messages waiting since I was not pulling them off until empty for my testing.\nWe are on a WAN with about 25ms latency to the activemq system.\n\nI probably tested doing this several dozen times and eventually noticed the negative numbers in the topic it was using.  All other topics were fine (though I think were the ones mainly using the activemq system).  I could try and recreate this but it's going to be random I'm sure.  And my guys on the other end of the WAN won't be happy if they have to restart ActiveMQ again.\n\nAnd I'll note again...we had a bug where we were trying to reconnect an already-opened connection.  But I doubt that was the cause since it never gets to the queue in that situation.\n\nSo the 2 most likely situations IMHO:\n#1 receive() is blocked and packets are either dropped or rejected during that time\n#2 receive() is receiving message and packets are either dropped or rejected during that time perhaps messing with the autoacknowledge.\n\nI'd say the odds of #2 seem small but with 25ms delays it's more than feasible for me to have hit that occurrence.\n\nSo if you receive a message and drop the connection before it's autoacknowledged could that cause it? \n\n#!/bin/sh\nif [ \"$1\" == \"\" ];then\necho Usage: $0 [udr activemq up] [down reject]\necho To turn off firewall \"$0 up\"\nexit 1\nfi\nif [ \"$1\" == \"udr\" ];then\nIPADDR=10.2.100.214\nPORT=8080\nshift\nfi\nif [ \"$1\" == \"activemq\" ];then\nIPADDR=10.2.100.209\nPORT=61616\nshift\nfi\nif [ \"$1\" == \"down\" ];then\necho $IPADDR down\niptables -A INPUT -s \"$IPADDR\" -j DROP\nfi\nif [ \"$1\" == \"reject\" ];then\necho port $PORT reject\niptables -A OUTPUT -p TCP --destination $IPADDR -j REJECT --reject-with tcp-reset\n#iptables -A OUTPUT -p TCP --dport $PORT -j REJECT --reject-with tcp-reset\nfi\nif [ \"$1\" == \"up\" ];then\necho iptables flushed\niptables --flush\nfi\n\n\nMichael D. Black\nSenior Scientist\nAdvanced Analytics Directorate\nAdvanced GEOINT Solutions Operating Unit\nNorthrop Grumman Information Systems\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mdblack98","name":"mdblack98","key":"mdblack98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Black","active":true,"timeZone":"America/Chicago"},"created":"2012-12-14T14:04:11.545+0000","updated":"2012-12-14T14:04:11.545+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12623010/comment/13656455","id":"13656455","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Not reproducible test case or other information.  Recommend testing against a 5.9-SNAPSHOT to see if the KahaDB hardening that we've done changes anything. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-05-13T22:23:53.956+0000","updated":"2013-05-13T22:23:53.956+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4214/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14ajb:"}}