{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482650","self":"https://issues.apache.org/jira/rest/api/2/issue/12482650","key":"AMQ-1983","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"parent":{"id":"12483556","key":"AMQ-1999","self":"https://issues.apache.org/jira/rest/api/2/issue/12483556","fields":{"summary":"XAException: POST COMMIT FAILED (NPE in Pure master/slave setup)","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-10-24T15:52:25.640+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 06 10:47:07 UTC 2008","customfield_12310420":"43780","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_756238101_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-10-28T12:09:08.162+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1983/watchers","watchCount":0,"isWatching":false},"created":"2008-10-19T18:05:10.061+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-11-10T17:53:56.066+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have tried to reduce the real-life problem to something smaller. See activemqjee-0.0.8.tar.gz\n\nIt's a MDB that forwards a message to another queue. \n\nWhat I did:\n- send some messages to queue.A (I did 10 at a time, using the webconsole setting Persistent Delivery)\n- the MDB sends each message to queue.B\n- if a reply queue was set in the message, the MDB sends a reply\n\nOn queue.B is an MDB that just received and logs the message.\n\n\nLogged on the master:\n{code}\n2008-10-19 18:39:54,114 [127.0.0.1:43972] DEBUG AMQMessageStore                - Journalled transacted message add for:\n   ID:selten.cluster-40744-1224434310420-0:2:4:1:1, at: offset = 90045, file = 1, size = 429, type = 1\n......\n2008-10-19 18:39:54,278 [127.0.0.1:43972] DEBUG AMQMessageStore                - Transacted message add commit for:\n   ID:selten.cluster-40744-1224434310420-0:2:4:1:1, at: offset = 90045, file = 1, size = 429, type = 1\n......\n2008-10-19 18:39:54,305 [127.0.0.1:43962] ERROR MasterBroker                   - Slave Failed\njavax.jms.JMSException: Unmatched acknowledege: MessageAck {commandId = 1031, responseRequired = true, ackType = 2, \n  consumerId = ID:selten.cluster-40744-1224434310420-0:0:-1:2, firstMessageId = \nID:selten.cluster-40744-1224434310420-0:2:4:1:1, lastMessageId = ID:selten.cluster-40744-1224434310420-0:2:4:1:1, \n  destination = queue://queue.B, \ntransactionId = XID:131075:312d2d32613062356562303a613535653a34386662363236643a313135:2d32613062356562303a613535653a34386662363236643a313136,\n messageCount = 1}; Could not find Message-ID ID:selten.cluster-40744-1224434310420-0:2:4:1:1 in dispatched-list (start of ack)\n        at org.apache.activemq.broker.region.PrefetchSubscription.assertAckMatchesDispatched(PrefetchSubscription.java:438)\n        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:188)\n        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:373)\n        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)\n{code}\n\nLogged on the slave:\n{code}\n2008-10-19 18:39:54,112 [.cluster#1] DEBUG AMQMessageStore                - Journalled transacted message add for: ID:selten.cluster-40744-1224434310420-0:2:4:1:1, at: offset = 90045, file = 1, size = 429, type = 1\n......\n2008-10-19 18:39:54,241 [.cluster#1] DEBUG AMQMessageStore                - Transacted message add commit for: ID:selten.cluster-40744-1224434310420-0:2:4:1:1, at: offset = 90045, file = 1, size = 429, type = 1\n......\n2008-10-19 18:39:54,288 [.cluster#1] ERROR Service                        - Async error occurred: javax.jms.JMSException: Slave broker out of sync with master: \n  Dispatched message (ID:selten.cluster-40744-1224434310420-0:2:4:1:1) was not in the pending list for queue.B\n  javax.jms.JMSException: Slave broker out of sync with master: Dispatched message \n(ID:selten.cluster-40744-1224434310420-0:2:4:1:1) was not in the pending list for queue.B\n        at org.apache.activemq.broker.region.PrefetchSubscription.processMessageDispatchNotification(PrefetchSubscription.java:175)\n        at org.apache.activemq.broker.region.AbstractRegion.processDispatchNotification(AbstractRegion.java:414)\n        at org.apache.activemq.broker.region.RegionBroker.processDispatchNotification(RegionBroker.java:585)\n{code}\n\nI could not consistently reproduce it with a single JBoss server running. I've sent a few 100 messages without any problem.\n\nI've tested both 5.2.0-RC2 and 5.3.0-SNAPSHOT (rev 706043).\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461203","id":"12461203","filename":"activemqjee-0.0.9-src.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-26T22:37:24.146+0000","size":7956,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12461203/activemqjee-0.0.9-src.tar.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461204","id":"12461204","filename":"activemq-master.log.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-21T16:52:30.271+0000","size":48979,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12461204/activemq-master.log.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461155","id":"12461155","filename":"activemq-slave.log.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-21T21:32:21.196+0000","size":44778,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12461155/activemq-slave.log.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461134","id":"12461134","filename":"ASF.LICENSE.NOT.GRANTED--activemqjee-0.0.8-src.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-19T18:05:10.110+0000","size":7769,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12461134/ASF.LICENSE.NOT.GRANTED--activemqjee-0.0.8-src.tar.gz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"233372","customfield_12312823":null,"summary":"Async error occurred - Slave broker out of sync with master","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"java version \"1.6.0_07\"\nClient is a JBoss 4.2.3.GA cluster using the ActiveMQ resource adapter (from RC2)\nActiveMQ 5.3.0  rev 706043 in pure master/slave setup","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482650/comment/12940385","id":"12940385","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"I've run another test with our real application with a single JBoss 4.0.5 host and a pure master/slave ActiveMQ setup (5.2.0 RC2).\n\nSee the ERRORs in \"activemq-master.log.gz\" and \"activemq-slave.log.gz\"\n\nLogged at DEBUG level, so I hope it's clear enough.\n\nI think the case matches quite closely to the test code in this issue, though the real application does a lot more.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-21T16:58:36.411+0000","updated":"2008-10-21T17:01:18.892+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482650/comment/12940383","id":"12940383","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"This was the message from the JBoss server log that produced the issue:\n\n2008-10-21 18:27:06,677 DEBUG [org.apache.activemq.ActiveMQSession] ID:master.cluster-49988-1224605035095-0:42:339 sending message: ActiveMQTextMessage {commandId = 0, responseRequired = false, messageId = ID:master.cluster-49988-1224605035095-0:42:339:1:1, originalDestination = null, originalTransactionId = null, producerId = ID:master.cluster-49988-1224605035095-0:42:339:1, destination = queue://queue.CLIENT_OUT_TOKEN, transactionId = XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530323500000000000000000000000000000000000000000000000000000000000000000000000000:\n31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, expiration = 0, timestamp = 1224606426677, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, text = ..........(removed the message)............}\n\n\nIt was one of 686 messages sent by the same EJB to the same queue within about 15 minutes during my tests.\n\nThe transaction commit happened at the time of the ERROR Service                        - Async error occurred: \n  JMSException: Slave broker out of sync with master: Dispatched message (ID:master.cluster-49988-1224605035095-0:42:339:1:1) was not in the pending list\n\nin the slave log.\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-21T21:45:00.079+0000","updated":"2008-10-21T21:47:04.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482650/comment/12940397","id":"12940397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"This is the start and end of the XA transactions with that XID in the JBoss server log:\n\n2008-10-21 18:27:09,412 DEBUG [org.apache.activemq.TransactionContext] Started XA transaction: XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:\n31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n...........\n2008-10-21 18:27:09,457 DEBUG [org.apache.activemq.TransactionContext] Started XA transaction: XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:\n31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n\n.................\n2008-10-21 18:27:09,459 DEBUG [org.apache.activemq.ActiveMQSession] ID:master.cluster-49988-1224605035095-0:42:346 sending message: ActiveMQTextMessage {commandId = 0, responseRequired = false, messageId = ID:master.cluster-49988-1224605035095-0:42:346:1:1, originalDestination = null, originalTransactionId = null, producerId = ID:master.cluster-49988-1224605035095-0:42:346:1, destination = topic://topic.PRE_CLIENT_OUT, transactionId = XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:\n31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, expiration = 0, timestamp = 1224606429459, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = true, readOnlyBody = true, droppable = false, text =\n \n2008-10-21 18:27:09,478 DEBUG [org.apache.activemq.ActiveMQSession] ID:master.cluster-49988-1224605035095-0:42:346 sending message: ActiveMQTextMessage {commandId = 0, responseRequired = false, messageId = ID:master.cluster-49988-1224605035095-0:42:346:2:1, originalDestination = null, originalTransactionId = null, producerId = ID:master.cluster-49988-1224605035095-0:42:346:2, destination = queue://queue.CLIENT_OUT, transactionId = XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:\n31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000, expiration = 0, timestamp = 1224606429478, arrival = 0, brokerInTime = 0, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = true, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = null, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = {tnx435=true}, readOnlyProperties = true, readOnlyBody = true, droppable = false, text =\n.............\n\n2008-10-21 18:27:09,730 DEBUG [org.apache.activemq.TransactionContext] Ended XA transaction: XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:\n31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n2008-10-21 18:27:09,730 DEBUG [org.apache.activemq.TransactionContext] End: XidImpl[FormatId=257, GlobalId=mcfadden.marketxs.com/15084, BranchQual=1, localId=15084]\n2008-10-21 18:27:09,730 DEBUG [org.apache.activemq.TransactionContext] Ended XA transaction: XID:257:6d6366616464656e2e6d61726b657478732e636f6d2f313530383400000000000000000000000000000000000000000000000000000000000000000000000000:\n31000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\n\nApparently there are 2 transactions with the same transaction id!\n\nFor different queues, though.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-22T07:07:49.679+0000","updated":"2008-10-22T08:39:19.423+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482650/comment/12940349","id":"12940349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"Nothing special: it's just a single MDB running in the same XA transaction and sending messages to different queues or topics.\n\nI think I must create a better test application.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-22T10:49:56.855+0000","updated":"2008-10-22T10:49:56.855+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482650/comment/12940390","id":"12940390","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I think the following patch will fix your issue. There is not much in the line of XA tests in core that can help me verify at the moment. If you get a chance, can you build trunk with this patch and validate.\n{code}\nIndex: activemq-core/src/main/java/org/apache/activemq/broker/ft/MasterBroker.java\n===================================================================\n--- activemq-core/src/main/java/org/apache/activemq/broker/ft/MasterBroker.java\t(revision 707659)\n+++ activemq-core/src/main/java/org/apache/activemq/broker/ft/MasterBroker.java\t(working copy)\n@@ -253,7 +253,7 @@\n      */\n     public int prepareTransaction(ConnectionContext context, TransactionId xid) throws Exception {\n         TransactionInfo info = new TransactionInfo(context.getConnectionId(), xid, TransactionInfo.PREPARE);\n-        sendAsyncToSlave(info);\n+        sendSyncToSlave(info);\n         int result = super.prepareTransaction(context, xid);\n         return result;\n     }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-24T15:52:25.640+0000","updated":"2008-10-24T15:52:25.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482650/comment/12940402","id":"12940402","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"It seems this fixes it. I've sent more than 1600 messages without this happening again.\nIt's a bit modified MDB that forwards the message to 2 queues and a topic and sends a reply to the replyTo queue. (closer to what our real application does)\nSee activemqjee-0.0.9-src.tar.gz\n\nI've not tested the stand-alone version and that one is not transacted anyway.\nOnly tested the EJB version on JBoss 4.2.3.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-26T22:36:22.655+0000","updated":"2008-10-26T22:36:22.655+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482650/comment/12940404","id":"12940404","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolved in r708548\n\nthanks for validating the patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-28T12:09:08.054+0000","updated":"2008-10-28T12:09:08.054+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482650/comment/12939596","id":"12939596","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"These fixes will now make 5.2.0 rc3","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-06T10:47:07.318+0000","updated":"2008-11-06T10:47:07.318+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1983/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14bs7:"}}