{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12747547","self":"https://issues.apache.org/jira/rest/api/2/issue/12747547","key":"AMQ-5390","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2014-10-21T22:01:04.325+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Oct 21 22:01:04 UTC 2014","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_852448032_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-10-21T22:01:04.287+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5390/watchers","watchCount":3,"isWatching":false},"created":"2014-10-12T01:13:36.308+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-10-21T22:01:04.333+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12318701","id":"12318701","name":"MQTT","description":"MQTT Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"If there are pending messages to be delivered to a subscriber and if the broker is restarted at this point, the pending messages are not delivered to the subscriber when it connects after broker restart.\n\nI modified existing test case testReceiveMessageSentWhileOffline() and added test case testReceiveMessageSentWhileOfflineAndBrokerRestart() shown below:\nchanges:\n* use standalone broker as I was not sure if embedded broker persists messages on permanent store.\n* manually need to restart when test prompts to restart broker\n\n{noformat}\n@Test(timeout = 60 * 1000)\n    public void testReceiveMessageSentWhileOfflineAndBrokerRestart() throws Exception {\n        final byte[] payload = new byte[1024 * 32];\n        for (int i = 0; i < payload.length; i++) {\n            payload[i] = '2';\n        }\n\n        int numberOfRuns = 100;\n        int messagesPerRun = 2;\n\n        final MQTT mqttPub = createMQTTConnection(\"MQTT-Pub-Client\", true);\n        final MQTT mqttSub = createMQTTConnection(\"MQTT-Sub-Client\", false);\n        mqttPub.setHost(\"tcp://localhost:1883\");\n        mqttSub.setHost(\"tcp://localhost:1883\");\n\n        final BlockingConnection connectionPub = mqttPub.blockingConnection();\n        connectionPub.connect();\n\n        BlockingConnection connectionSub = mqttSub.blockingConnection();\n        connectionSub.connect();\n\n        Topic[] topics = { new Topic(\"TopicA\", QoS.EXACTLY_ONCE) };\n        connectionSub.subscribe(topics);\n\n        for (int i = 0; i < messagesPerRun; ++i) {\n            connectionPub.publish(topics[0].name().toString(), payload, QoS.AT_LEAST_ONCE, false);\n        }\n\n        int received = 0;\n        for (int i = 0; i < messagesPerRun; ++i) {\n            Message message = connectionSub.receive(5, TimeUnit.SECONDS);\n            assertNotNull(message);\n            received++;\n            assertTrue(Arrays.equals(payload, message.getPayload()));\n            message.ack();\n        }\n        connectionSub.disconnect();\n\n        for (int j = 0; j < numberOfRuns; j++) {\n\n            for (int i = 0; i < messagesPerRun; ++i) {\n                connectionPub.publish(topics[0].name().toString(), payload, QoS.AT_LEAST_ONCE, false);\n            }\n            \n            System.out.println(\"Restart broker here.....\");\n\n            Thread.sleep(30000);\n            \n            connectionSub = mqttSub.blockingConnection();\n            connectionSub.connect();\n            connectionSub.subscribe(topics);\n\n            for (int i = 0; i < messagesPerRun; ++i) {\n                Message message = connectionSub.receive(5, TimeUnit.SECONDS);\n                assertNotNull(message);\n                received++;\n                assertTrue(Arrays.equals(payload, message.getPayload()));\n                message.ack();\n            }\n            connectionSub.disconnect();\n        }\n        assertEquals(\"Should have received \" + (messagesPerRun * (numberOfRuns + 1)) + \" messages\", (messagesPerRun * (numberOfRuns + 1)), received);\n    }\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"MQTT pending durable subscriber messages are not delievered after broker restart","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=workanandr","name":"workanandr","key":"workanandr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"AR","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=workanandr","name":"workanandr","key":"workanandr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"AR","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12747547/comment/14179201","id":"14179201","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Added new test to the test suite to show that things are working as expected, messages are recovered after broker restart. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-10-21T22:01:04.325+0000","updated":"2014-10-21T22:01:04.325+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5390/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i212on:"}}