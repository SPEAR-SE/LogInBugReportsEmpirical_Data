{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12767071","self":"https://issues.apache.org/jira/rest/api/2/issue/12767071","key":"AMQ-5516","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2017-04-11T06:39:11.711+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Apr 11 06:39:11 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5516/watchers","watchCount":3,"isWatching":false},"created":"2015-01-13T09:17:20.625+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-04-11T07:23:40.543+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313893","id":"12313893","name":"Connector"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Hi,\n\nHere is the fragement of our spring config which declares the connectors:\n\n<amq:networkConnectors>\n\t<amq:networkConnector name=\"brokerName\" uri=\"multicast://default\" />\n</amq:networkConnectors>\n<amq:transportConnector name=\"openwire\" uri=\"tcp://10.1.1.5:61616\" discoveryUri=\"multicast://default\">\n\t<amq:publishedAddressPolicy>\n\t\t<amq:publishedAddressPolicy publishedHostStrategy=\"IPADDRESS\" />\n\t</amq:publishedAddressPolicy>\n</amq:transportConnector>\n \n\nWe have a configuration where several IP addresses are given to the machine in /etc/hosts. There is no dns resolving mybox.\nThe relevant part is this one:\n\n127.0.0.1 mybox localhost\n10.1.1.5  mybox\n172.16.2.5  mybox\n#...others...\n\n\nIn org.apache.activemq.transport.tcp.TcpTransportServer:138, the method bind() calls resolveHostName(serverSocket, addr) to rewrite the URI (why??).\nThe URI tcp://10.1.1.5:61616 is rewritten tcp://mybox:61616.\n\nWe can't advertise tcp://mybox:61616 since there is no name resolution. This is why the publishedAddressPolicy is set to IPADDRESS. \nThe multicast agent rewrites the URI again but the name resolution found for mybox is 127.0.0.1. The advertised URI is now tcp://127.0.0.1:61616. Each broker tries to connect to themselves.\n\nDepending on the order of the lines in /etc/hosts to resolve to the correct ip is about random chance.\nIs this call to resolveHostName(serverSocket, addr) really necessary? Why trying to outsmart the configuration?\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Misbehaving name resolution in org.apache.activemq.transport.tcp.TcpTransportServer","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ulrichd","name":"ulrichd","key":"ulrichd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ulrich","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ulrichd","name":"ulrichd","key":"ulrichd","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ulrich","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"AMQ  : 5.10.0\njava : Oracle 1.7.0_72-b14\nOS   : debian 7.4","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12767071/comment/15963899","id":"15963899","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dma2017","name":"dma2017","key":"dma2017","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Mack","active":true,"timeZone":"Europe/Berlin"},"body":"confirmed for AMQ 5.14.3\n\npossible workaround (Java Broker config) :\n\n{code}\nprivate DiscoveryAgent agent;\nprivate TransportConnector transportConnector;\n\n//(...)\n\nprivate final void initialize() {\n   //(...)\n   if (null != agent) {\n     agent.stop();\n   }\n   agent = MulticastDiscoveryAgentFactory.createDiscoveryAgent(transportConnector.getDiscoveryUri());\n   agent.registerService(transportConnector.getUri().toString());\n   transportConnector.setDiscoveryAgent(agent);\n   //(...)\n}\n\npublic final void start() {\n   //(...) !!! IMPORTANT, START YOUR BROKER / BROKERSERVICE HERE !!!\n   agent.stop();\n   agent.registerService(transportConnector.getUri().toString());\n   agent.start();\n}\n{code}\n\nsimilar workarounds could be applied to many other types of network configurations - simply re-start your connectors with numeric addresses *after* the broker has already been started","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dma2017","name":"dma2017","key":"dma2017","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Mack","active":true,"timeZone":"Europe/Berlin"},"created":"2017-04-11T06:39:11.711+0000","updated":"2017-04-11T07:23:40.534+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5516/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i24arj:"}}