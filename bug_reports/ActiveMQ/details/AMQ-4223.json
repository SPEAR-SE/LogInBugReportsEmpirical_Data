{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12623887","self":"https://issues.apache.org/jira/rest/api/2/issue/12623887","key":"AMQ-4223","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jul 08 16:48:08 UTC 2013","customfield_12310420":"297723","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4223/watchers","watchCount":1,"isWatching":false},"created":"2012-12-14T02:44:12.680+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-07-08T17:13:23.103+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Now that AMQ-3664 is out of the way I thought I could turn on optimizeAcknowledge back on as long as I gave it some decent timeOut & scheduledAckInterval values.\n\nWell, it turns out the behavior I was seeing still happens, and I think now it's clearer that it is something else, just was partially masked by that other issue.\n\nMy configuration is a \"network of brokers\" two brokers with a producer on each one, and a consumer on each one.  The consumers are set up with exclusive=true as their part of my application is an \"aggregation\" step.  I'm using the exclusive mode to ensure that only one of them receives all the messages, and the other is essentially a standby/backup in case the first one is offline.\n\nWhen I have optimizeAcknowlege enabled, I see a situation where it is distributing (fairly equally, in fact) the messages to both of the consumers.  When I set that to false, all the messages funnel into the currently active consumer as expected.\n\nI cannot find anything that says these are incompatible features, and cannot figure out what it is that causes this behavior.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"236192","customfield_12312823":null,"summary":"Messages being distributed to exclusive consumers!","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"RHEL5, Java 1.6","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12623887/comment/13532524","id":"13532524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"body":"It's probably worth noting that this issue may not specifically tied to the optimizeAcknowledge=true setting.  I have seen it happen on occasion even with that was false, but very rarely.  But when it's true it always happens for sure.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"created":"2012-12-14T18:25:44.812+0000","updated":"2012-12-14T18:26:07.592+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12623887/comment/13612760","id":"13612760","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"body":"FWIW I am still seeing this issue on occasion.  I have not made any changes to the system (optimizeAcknowledge has remained false) since opening this issue.  It runs fine for a while (as in months on end) and then just decides one day to start violating the exclusive consumer logic.\n\nRestarting my application doesn't really help at all.\nDeleting the activemq datastore doesn't really help much either.\n\nSo now I have to keep it limping along until it randomly decides to stop stumbling on this issue and run smooth for a while again.\n\n\n\nLooking at it right now I can see that all the \"incorrectly delivered\" messages were delivered directly from the \"local\" broker.  To expand on that...\n\nThis application has a network of brokers that is currently only 2 of them, on separate boxes.  Each instance has one exclusive consumer on the same queue.  If I look at the state of one broker via JMX I can see the queue has 2 subscriptions (1 local and 1 via the other broker) and they are marked as exclusive.  From the other broker it's the same thing but in \"reverse\" so to speak.  This effectively gives me an active/passive level of HA in my application for this aggregation point of the process flow.\n\nUnder normal operation, from both brokers I'll see the counters all sitting at 0 for the one that is on standby and non-zero for the one that is supposed to receive all the messages.  And for one broker it's the local one that is non-zero and for the other broker it's the remote one that is non-zero, which makes perfect sense.\n\nWhen this bug occurs, I'll see local counters as non-zero and remotes at zero from both sides.  So that means each broker is specifically delivering only to its local subscription as if it considers the local subscription the primary/exclusive one, even know it is fully aware of the remote.\n\nSo perhaps the problem is in how the network of brokers negotiate/choose which consumer is the exclusive one.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"created":"2013-03-25T16:00:27.330+0000","updated":"2013-06-06T21:08:53.027+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12623887/comment/13677509","id":"13677509","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"body":"FWIW, I upgraded to AMQ 5.8.0 today, the problem still persists.\n\nIt's becoming more of a serious problem now as the system cannot function in a redundant manner.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"created":"2013-06-06T21:06:27.794+0000","updated":"2013-06-06T21:07:23.729+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12623887/comment/13702112","id":"13702112","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"body":"I noticed something else today that may be related to this issue..\n\nI connected to each of my brokers via JMX and was browsing the tree of MBeans under org.apache.activemq -> Broker -> (brokername) -> Queue.  For my application there are many queues, of which 5 of them behave as described above using exclusive consumers.  Viewing the attributes of the queues From one of the brokers I will see the Options has a value of \"consumer.exclusive=true\" on each Queue, whereas on the other broker I see 4 out of 5 have an empty string for that value.  The one that is different?  Well it also has the \"consumer.exclusive=true\" value there as well.  And it just so happens that the particular part of my application suffering from this bug at the moment is precisely that which shows this discrepancy.\n\n-When everything is working smoothly, I only see the \"consumer.exclusive=true\" listed in the options of the Queue which has the consumer that all messages are going to.  Thus, when more than one broker lists the queue with that option, they are not in agreement about where the messages go, and I end up with the lack of exclusivity.-\nUpon further testing, the above statement didn't hold true.  I still saw it fail when it was consistent with other Queues.  And honestly with my limited nowledge of the AMQ guts, I'd expect ALL of them to show the option set on ALL brokers.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"created":"2013-07-08T16:48:08.344+0000","updated":"2013-07-08T17:13:23.099+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4223/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14t6f:"}}