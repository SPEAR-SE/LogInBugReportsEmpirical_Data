{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12510581","self":"https://issues.apache.org/jira/rest/api/2/issue/12510581","key":"AMQ-3369","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2011-07-12T12:52:17.379+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Aug 22 13:18:04 UTC 2011","customfield_12310420":"64197","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2873118807_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-07-19T20:56:07.287+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3369/watchers","watchCount":0,"isWatching":false},"created":"2011-06-16T14:50:48.521+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315624","id":"12315624","description":"Maintenance release for 5.4.0","name":"5.4.1","archived":false,"released":true,"releaseDate":"2010-09-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-08-22T13:18:04.878+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Sometime we get NullPointerException when sending a text message. We use method send(destination, message) of interface javax.jms.MessageProducer.\n\njava.lang.NullPointerException\n at org.apache.activemq.command.ActiveMQTextMessage.getSize(ActiveMQTextMessage.java:148)\n at org.apache.activemq.ActiveMQSession.send(ActiveMQSession.java:1753)\n at org.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:231)\n at org.apache.activemq.ActiveMQMessageProducerSupport.send(ActiveMQMessageProducerSupport.java:300)\n\nCaller code is:\n\ntry {\n    final TextMessage message = session.createTextMessage(msg);\n    message.setJMSType(type);\n    message.setJMSReplyTo(destination);\n    message.setJMSCorrelationID(jmsMessageId);\n    producer.send(destination, message);\n} catch (JMSException ex) {\n    ...\n}\n\nI.e. we don't reuse or store the message being sent.\n\nWe are also 100% sure that both session and its producer are used only from one thread at any point of time (we have custom session pool).\n\nBroker URI is vm://jboss-activemq-broker?jms.copyMessageOnSend=false&jms.objectMessageSerializationDefered=true&jms.useAsyncSend=true\n\nThe NPE occurs occasionally, we were not able to reproduce it deterministically so far.\n\nAny suggestions on how to investigate this?","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172325","customfield_12312823":null,"summary":"occasionally NPE in ActiveMQTextMessage.getSize()","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ipechorin","name":"ipechorin","key":"ipechorin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Pechorin","active":true,"timeZone":"Asia/Dubai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ipechorin","name":"ipechorin","key":"ipechorin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Pechorin","active":true,"timeZone":"Asia/Dubai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"JDK 1.6 (64-bit), Windows Server 2008 x64","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12510581/comment/13063860","id":"13063860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Do you have a test case that can reproduce this issue?\nHave you tried using a later release such as 5.5 or a 5.6-SNAPSHOT?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-07-12T12:52:17.379+0000","updated":"2011-07-12T12:52:17.379+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12510581/comment/13067961","id":"13067961","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Unable to reproduce and no test case provided.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-07-19T20:56:07.296+0000","updated":"2011-07-19T20:56:07.296+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12510581/comment/13088678","id":"13088678","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nigelt","name":"nigelt","key":"nigelt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nigel Tamplin","active":true,"timeZone":"Etc/UTC"},"body":"I was also seeing this error in a high load system with embedded AMQ,  but was unable to reproduce in a small / simple test case.\n\nThe exception was originating from a single thread with a transacted session, running in a bigger application (a subtle timing issue?).\nThe thread was creating TextMessages from external events, sending to a queue then committing the session, shortly after the same thread would read back from that queue and send to another queue then commit again.\nIt was the send to the 2nd queue that would very occasionally throw the NullPointer.  In 30 – 40 thousand iterations over a 12 hour period I'd see the NullPointer maybe 20 times.  I could not however contrive a test case to reliably reproduce it.\n\nWhat I could do however was to put the JVM in debug mode and catch the NullPointer.\n\nWhat I found was\n\npublic int getSize() {\n        if (size  0 && content  null && text != null) {\n            size = getMinimumMessageSize();\n            if (marshalledProperties != null) {\n                size += marshalledProperties.getLength();\n            }\n            size = text.length() * 2;        <<<< null pointer thrown here\n        }\n        return super.getSize();\n    }\n\nException occurred: java.lang.NullPointerException (to be caught at: org.apache.activemq.ActiveMQSession.send(), line=1,700 bci=447)\"thread=Thread 50\", org.apache.activemq.command.ActiveMQTextMessage.getSize(), line=148 bci=57\n148                size = text.length() * 2;\n\nMQ IN SMA.TEST.ORBITAL.01.CT/MQ_LOOP_BACK.1[1] list\n144                size = getMinimumMessageSize();\n145                if (marshalledProperties != null) {\n146                    size += marshalledProperties.getLength();\n147                }\n148 =>             size = text.length() * 2;\n149            }\n150            return super.getSize();\n151        }\n152        \n153        public String toString() {\nThread 50[1] print text\n text = null\n\nSince the check that text != null and the accessing of text it was being set to null.\n\nI was running version 5.3.0, and suspected the cause of the NullPointer to be the\n\ttext = null;\nassignment at the end of the beforeMarshall() method in ActiveMQTextMessage.  This looks to be the only place it could be set to null.\n\nSee \nhttps://issues.apache.org/jira/browse/AMQ-2103\nhttps://issues.apache.org/jira/browse/AMQ-2966\n\nThe “text = null;” assignment is present in AMQ versions 5.3.0, 5.3.1, 5.3.2, 5.4.0, 5.4.1\nand removed in 5.4.2 and subsequence versions.\n\nUnable to upgrade to 5.4.2 (or newer) in the short term, but needing to avoid this problem immediately I rebuilt 5.3.0 removing the “text=null;” assignment and have not experienced the NullPointerException since.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nigelt","name":"nigelt","key":"nigelt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Nigel Tamplin","active":true,"timeZone":"Etc/UTC"},"created":"2011-08-22T13:18:04.838+0000","updated":"2011-08-22T13:18:04.838+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3369/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tuyn:"}}