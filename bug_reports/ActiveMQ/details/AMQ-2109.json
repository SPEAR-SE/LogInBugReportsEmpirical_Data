{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482548","self":"https://issues.apache.org/jira/rest/api/2/issue/12482548","key":"AMQ-2109","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-02-24T15:10:45.932+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Feb 24 15:10:45 UTC 2009","customfield_12310420":"75071","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_976138830_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-02-24T15:10:45.989+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2109/watchers","watchCount":0,"isWatching":false},"created":"2009-02-13T08:01:47.159+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-02-24T15:10:45.960+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"This error occurs, when we have two brokers BrokerA and BrokerB. The simplest case is BrokerA being networked to BrokerB with a static network connector. If a consumer is created on BrokerB for a queue TEST, we will also note a consumer being established on BrokerA for that Queue, which is the intended behavior. If the consumer is closed on BrokerB, the proxy consumer on BrokerA continues to exist. Now consider the client reconnects due to failover reasons to BrokerA this time. BrokerA would then have 2 consumers on TEST, causing a portion of the messages being consumed by the proxy consumer. \n\nSo, when a consumer is closed for a queue, the proxy consumers in the peer brokers should also be closed.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461286","id":"12461286","filename":"amq-2109.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-19T12:34:54.270+0000","size":1309,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461286/amq-2109.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461275","id":"12461275","filename":"NetworkBrokerDetachTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-13T08:03:48.174+0000","size":6973,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461275/NetworkBrokerDetachTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"233524","customfield_12312823":null,"summary":"Proxy Consumers are not closed when a consumer closes on a networked broker ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"This is not related to a specific environment, but could be reproduced on Linux based machines, Windows machines using  different JDK's.","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482548/comment/12940758","id":"12940758","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"body":"This is a test case for the error. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-13T08:03:48.240+0000","updated":"2009-02-13T08:03:48.240+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482548/comment/12940808","id":"12940808","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"body":"Analyzing the problem further it seems that the proxy consumer cannot be found once the remote consumer closes. Though the close event is propagated, it is not processed. \nThe following diff addresses the problem. It seems, that the consumer id is being changed once the proxy consumer is created both for queues and topics. This makes sense\nin case of topics and durable subscribers as those must survive when the consumer disconnects. For queues that does not make sense as a durable subscriber is not needed \nto trigger a desired persistence mechanism. For these reasons the class DurableConduitBridge has been modified according to the following diff:\n\n++++ Snip \n\nIndex: src/main/java/org/apache/activemq/network/DurableConduitBridge.java\n===================================================================\n--- src/main/java/org/apache/activemq/network/DurableConduitBridge.java\t(revision 745834)\n+++ src/main/java/org/apache/activemq/network/DurableConduitBridge.java\t(working copy)\n@@ -82,17 +82,11 @@\n         }\n         //add our original id to ourselves\n         info.addNetworkConsumerId(info.getConsumerId());\n-        // not matched so create a new one\n-        // but first, if it's durable - changed set the\n-        // ConsumerId here - so it won't be removed if the\n-        // durable subscriber goes away on the other end\n-        if (info.isDurable() || (info.getDestination().isQueue() && !info.getDestination().isTemporary())) {  \n-            info.setConsumerId(new ConsumerId(localSessionInfo.getSessionId(), consumerIdGenerator\n-                .getNextSequenceId()));\n-        }\n+\n         if (info.isDurable()) {\n             // set the subscriber name to something reproducible\n-\n+            info.setConsumerId(new ConsumerId(localSessionInfo.getSessionId(), consumerIdGenerator\n+                    .getNextSequenceId()));\n             info.setSubscriptionName(getSubscriberName(info.getDestination()));\n         }\n         info.setSelector(null);\n\n\n++++ snap\n\nThis patch didn't break any existing test and also succeeded with the NetworkBrokerDetachTest provided earlier. \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-19T12:32:58.544+0000","updated":"2009-02-19T12:32:58.544+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482548/comment/12940774","id":"12940774","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"body":"This file contains the patch that presumably fixes the issue. It has been created based on the ActiveMQ 5.3.0 trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=atooni","name":"atooni","key":"atooni","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andreas Gies","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-19T12:34:54.568+0000","updated":"2009-02-19T12:34:54.568+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482548/comment/12940804","id":"12940804","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"patch applied with thanks to trunk: r747384","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-24T15:10:45.932+0000","updated":"2009-02-24T15:10:45.932+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2109/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14cpz:"}}