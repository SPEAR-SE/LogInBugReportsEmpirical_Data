{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12750445","self":"https://issues.apache.org/jira/rest/api/2/issue/12750445","key":"AMQ-5413","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329258","id":"12329258","name":"5.12.0","archived":false,"released":true,"releaseDate":"2015-08-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-04-02T23:00:24.680+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed May 27 15:32:05 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_13833912143_*|*_5_*:*_2_*:*_4724914074_*|*_4_*:*_1_*:*_187223","customfield_12312321":null,"resolutiondate":"2015-05-27T15:32:05.918+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5413/watchers","watchCount":2,"isWatching":false},"created":"2014-10-24T20:15:12.570+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"issuelinks":[{"id":"12402144","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12402144","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12757501","key":"AMQ-5453","self":"https://issues.apache.org/jira/rest/api/2/issue/12757501","fields":{"summary":"AMQP interop: Active broker does not respect the \"drain\" flag.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-05-27T15:32:06.002+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12321807","id":"12321807","name":"AMQP","description":"AcitveMQ's AMQP Transport"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Using Apache Qpid test clients qpid-send and qpid-receive ActiveMQ broker behaves differently from qpidd and I'm wondering if the difference is important.\n\nThe test code command lines are:\n{noformat}\nqpid-send -a \"chuck; {create:always}\" --connection-options {protocol:amqp1.0} --sequence yes --content-string 0\nqpid-receive -a chuck -m 1 --connection-options \"{protocol:amqp1.0}\" --print-headers yes\n{noformat}\n\nWhen I run the tests against qpidd they send one message and receive one message every time. However against ActiveMQ 5.11 the qpid-receive does not receive the message until one of several conditions:\n* the qpid-receive command also includes \"--timeout 1\"\n* the qpid-receive command is repeated several, possibly dozens, of times.\n\nWhen qpidd broker is running or when activemq is running and --timeout is specified then the qpid-receive output is:\n{noformat}\nchug@FJELD ~> qpid-receive -a chuck -m 1 --connection-options \"{protocol:amqp1.0}\" --print-headers yes\nProperties: {sn:1, ts:1414177685195174548, x-amqp-first-acquirer:True}\n\n0\n{noformat}\n\nHowever, activemq running the client twice without the timeout and once with the timeout looks like this:\n{noformat}\nchug@FJELD ~> qpid-receive -a chuck -m 1 --connection-options \"{protocol:amqp1.0}\" --print-headers yes\nchug@FJELD ~> qpid-receive -a chuck -m 1 --connection-options \"{protocol:amqp1.0}\" --print-headers yes\nchug@FJELD ~> qpid-receive -a chuck -m 1 --connection-options \"{protocol:amqp1.0}\" --print-headers yes --timeout 1\nRedelivered: true\nProperties: {sn:1, ts:1414178091185765136, x-amqp-delivery-count:1}\n\n0\n{noformat}\n\nThe false receive attempts make the message look like it was already delivered, hence the Redelivered: true, first-acquirer absent and the x-amqp-delivery-count setting.\n\nViews of the protocol interactions between the brokers and clients are here:\nhttp://people.apache.org/~chug/adverb_qpid_send_receive_1/\n\nI ran the tests twice on ActiveMQ with the tcpnodelay option turned on and off but that didn't seem to make any difference.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"AMQP test client delivery/redelivery anomoly","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chug","name":"chug","key":"chug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chug&avatarId=32782","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chug&avatarId=32782","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chug&avatarId=32782","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chug&avatarId=32782"},"displayName":"Chuck Rolke","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chug","name":"chug","key":"chug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chug&avatarId=32782","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chug&avatarId=32782","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chug&avatarId=32782","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chug&avatarId=32782"},"displayName":"Chuck Rolke","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"broker: snapshot apache-activemq-5.11-20141022.222801-124-bin.tar.gz \t\n  Wed Oct 22 22:28:02 UTC 2014\nhost: Linux Fedora 19 x64\nclients: Apache Qpid C++ messaging qpid-send qpid-receive (current trunk)\nprotocol: AMQP 1.0","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750445/comment/14185786","id":"14185786","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chug","name":"chug","key":"chug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chug&avatarId=32782","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chug&avatarId=32782","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chug&avatarId=32782","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chug&avatarId=32782"},"displayName":"Chuck Rolke","active":true,"timeZone":"America/New_York"},"body":"I believe that the broker is mishandling the Flow performative 'drain' flag. Referring to trace http://people.apache.org/~chug/adverb_qpid_send_receive_1/qpid-send-receive_activemq-5.11_nodelay_1.html the following flow exchange happens:\n{noformat}\n◊  ◊◊  Frame 97  127.0.0.1:38598  -> 127.0.0.1:5672  10.422229 flow [0,0] (0,1000)   (drain=false)\n◊  ◊◊  Frame 98  127.0.0.1:38598  -> 127.0.0.1:5672  10.422252 flow [0,0] (0,1000)   (drain=true)\n◊  ◊◊  Frame 100  127.0.0.1:38598 <-  127.0.0.1:5672  10.423470 flow [0,0] (1000,0)\n◊  ◊◊  Frame 101  127.0.0.1:38598  -> 127.0.0.1:5672  10.423595 flow [0,0] (1000,1000)\n◊  ◊◊  Frame 102  127.0.0.1:38598 <-  127.0.0.1:5672  10.423810 flow [0,0] (2000,0)\n{noformat}\nThe client sends two closely spaced flow messages to the broker. They are identical except that the drain flag is false in Frame 97 but true in Frame 98. The broker responds in Frame 100 by advancing the delivery count to 1000 to drain the available credit.  Frames 101 and 102 are a repeat of the flow-with-drain from the client followed by the broker effecting the drain with an advanced delivery count.\n\nThe protocol error is that by AMQP 1.0 the sender receiving a flow with drain=true SHOULD send all available messages before advancing the delivery count to effect the drain.\n\nJust a guess here but the broker looks like it starts to form a delivery for the message it has in the queue but can't deliver it because the drain behavior kicked in. That's why when the client finally gets the message it is 'redelivered'.\n\nSince the behavior is marked with SHOULD and not with MUST then the drain behavior is probably acceptable. However, if the drain bypasses available messages then a user might expect that the messages would finally be delivered with Redelivered=false. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chug","name":"chug","key":"chug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chug&avatarId=32782","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chug&avatarId=32782","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chug&avatarId=32782","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chug&avatarId=32782"},"displayName":"Chuck Rolke","active":true,"timeZone":"America/New_York"},"created":"2014-10-27T20:49:43.680+0000","updated":"2014-10-27T20:49:43.680+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750445/comment/14393672","id":"14393672","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This is resolved with the addition of proper drain support.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-04-02T23:00:24.680+0000","updated":"2015-04-02T23:00:24.680+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750445/comment/14561143","id":"14561143","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Found an issue with the credit handling after drain completes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-05-27T15:28:58.756+0000","updated":"2015-05-27T15:28:58.756+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750445/comment/14561150","id":"14561150","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Additional fix and tests added","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-05-27T15:32:05.973+0000","updated":"2015-05-27T15:32:05.973+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5413/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i21k6v:"}}