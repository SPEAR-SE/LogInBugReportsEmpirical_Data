{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12989011","self":"https://issues.apache.org/jira/rest/api/2/issue/12989011","key":"AMQ-6354","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2016-07-13T14:04:55.927+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jul 18 19:42:11 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_478698185_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-07-18T19:42:11.243+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6354/watchers","watchCount":4,"isWatching":false},"created":"2016-07-13T06:43:54.029+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["activemq","broker","kahaDB","messagestore"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318549","id":"12318549","name":"5.5.1","archived":false,"released":true,"releaseDate":"2011-10-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-07-18T19:42:12.211+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12325017","id":"12325017","name":"KahaDB"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"AMQ Configuration:\n1.\tKahaDb Persistence store\n2.\tTopics and Queues destination are configured.\n3.\tDurable Subscribers configured (added/removed) dynamically (All added subscribers will be active) for Topic destination. \n\nIssue:\n\n•\tNearly ~20 Durable Subscriber added/deleted to a particular destination dynamically.\n•\tAfter configuration, Once the message are sent to the Topic, the messages are consumed and Acknowledged by each subscribers.\n•\tThere were 249 Subscribers and we could see from Journal file that all subscribers acknowledged.\n•\tIn JMX logs after message is sent the below entries are observed for yyyy destination, \no\tConsumer Count is 249\no\tIn-Flight Count is 0\no\tDispatch count is matching with the consumer count (messages * Consumer count)\n\n•\tWe enabled kahaDB TRACE logs and it clearly points out that for a particular Topic destination the journal files could not be gc collected\n\nSnippet of activemq.log\n\n----------------------------------------------\n2016-06-30 01:41:43,980 org.apache.activemq.store.kahadb.MessageDatabase TRACE (MessageDatabase.java:checkpointUpdate:1413) [ActiveMQ Journal Checkpoint Worker] [24] | gc candidates after dest:0:xxxxx, [8066, 8067, ...........]\n\n2016-06-30 01:41:43,980 org.apache.activemq.store.kahadb.MessageDatabase TRACE (MessageDatabase.java:checkpointUpdate:1413) [ActiveMQ Journal Checkpoint Worker] [24] | gc candidates after dest:1:yyyy, [8067, 8073, ............]\n--------------------------------------------\n\n•\tAfter analyzing the 8066 file, we understood that 8066 has one message for yyyy Topic destination and 249 ACk’s in the same file. But Checkpoint cleanup could not remove the file. So this pattern followed and all the files containing the yyyy destination messages are not removed, which leads to journal files pile-up.\n\nWorkaround :\n\n•\tAs a work around, first we restarted the process but still the files were not cleaned up.\n•\tSecondly,  we stopped the process, removed the index (db.data) file and restarted. Now all the files are cleaned up.\n•\tBy above workaround, we suspect that index file is corrupted, which is causing the journal pile up. \n•\tOur question, \no\tif index file is corrupted, what is the reason for corruption?\no\tIs there any bug in the 5.5.1 version of AMQ regarding index file corruption for Durable Subscription?\n\nThis is sporadic issue and not reproducible always. (Not always Dynamic Subscription configuration leads to journal pile up)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"KahaDb journal file piling up because of Durable subscriber destination","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Rajagopal","name":"Rajagopal","key":"rajagopal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajagopal","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Rajagopal","name":"Rajagopal","key":"rajagopal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajagopal","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10431","value":"Important","id":"10431"}],"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12989011/comment/15375055","id":"15375055","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"A couple of things.  First, 5.5.1 is really old and there have been many fixes with KahaDB since then so you need to try a more recent version.  I know there have been fixes related to garbage collection since then which may help.  Second, the behavior you describe of journal files sticking around because of a messages mixed in with acks is expected behavior.  The file can't be removed until all the messages are acked. You can reduce this occurrence by using multi kahaDB instead.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2016-07-13T14:04:55.927+0000","updated":"2016-07-13T14:04:55.927+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12989011/comment/15376208","id":"15376208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Rajagopal","name":"Rajagopal","key":"rajagopal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajagopal","active":true,"timeZone":"Etc/UTC"},"body":"Hi Christopher,\n\nThanks for your comments. Yes currently in our production old version 5.5.1 is deployed, in our next release of software we used 5.11, so we need to know whether the issue related to gc is fixed in that version. \nFYI, all the messages in the journal files are acked, even though checkpoint update could not remove it. In AciveMQ trace log it is pointing to a particular topic destination as the cause but all the registered subscriber consumed the message and acked.  After performing the workaround steps the files are gc'ed so we are suspecting index file corruption.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Rajagopal","name":"Rajagopal","key":"rajagopal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rajagopal","active":true,"timeZone":"Etc/UTC"},"created":"2016-07-14T02:34:56.475+0000","updated":"2016-07-14T02:34:56.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12989011/comment/15382928","id":"15382928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Given this is reported against a very old broker release and there's no reproducer supplied to test on newer releases there isn't much that we can do here.  The KahaDB store will GC when possible but if older messages are left in the store this can lead to log files being left ineligible for GC.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2016-07-18T19:42:11.971+0000","updated":"2016-07-18T19:42:11.971+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6354/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i30wef:"}}