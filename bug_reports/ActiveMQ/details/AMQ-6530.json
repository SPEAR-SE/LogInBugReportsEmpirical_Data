{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13026489","self":"https://issues.apache.org/jira/rest/api/2/issue/13026489","key":"AMQ-6530","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2016-12-07T22:34:02.253+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Dec 07 22:35:37 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2746542_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-12-07T22:35:35.689+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6530/watchers","watchCount":2,"isWatching":false},"created":"2016-12-07T21:49:50.935+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338124","id":"12338124","name":"5.14.1","archived":false,"released":true,"releaseDate":"2016-09-30"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-12-07T22:35:37.453+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12321807","id":"12321807","name":"AMQP","description":"AcitveMQ's AMQP Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I'm talking about queues with a low message volume and high processing time. In such a setup is it important that messages are not \"heaping up\" in the dispatch queue. The queueprefetch must be one in order to keep it workable. \n\nI have done a test with an ActiveMQ 5.14.1 broker and an AMQP consumer with a brokerURL configured with a queuePrefetch of one (jms.prefetchPolicy.queuePrefetch=1). \n\nI have the impression that the Dispatched Queue contains two messages during the period that a message is received and the time the acknowledgement is sent (clientacknowlegde mode). \n\nThe consumer details in the ActiveMQ Web Console tells me that the \"Dispatched Queue\" contains indeed two messages at that moment in time what should maximum be one with a defined queuePrefetch of one. \n\n!5.14.1 - queueprefetch of one -  max dispatched queue is two.png!\n\nWhen I do the same test with an ActiveMQ 5.13.3 broker then the Dispatched Queue contains maximum one message at any point in time, what is more correct in my opinion.\n\n!5.13.3 - queueprefetch of one -  max dispatched queue is one.png!\n\nI have created a unit test that shows the difference between ActiveMQ 5.13.3 and 5.14.1. The test consists of two asynchronous consumers and one sender. When the first consumer receives a first message then the onMessage thread will block before the message is acked. The second consumer should consume all the other messages.\n\nThe unit test sends four messages. With ActiveMQ 5.13.3 are all the four messages consumed (unit test passes). With ActiveMQ 5.14.1 are only three of the four messages consumed (unit test fails) because one of the messages stays in the Dispatched Queue. \n\nPlease find below my unit test and the corresponding activemq config :\n* [^JmsClientUnitTest.java] \n* [^activemq.xml]\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12842218","id":"12842218","filename":"5.13.3 - queueprefetch of one -  max dispatched queue is one.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=patrickv","name":"patrickv","key":"patrickv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Vansevenant","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-07T21:53:20.712+0000","size":8996,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12842218/5.13.3+-+queueprefetch+of+one+-++max+dispatched+queue+is+one.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12842219","id":"12842219","filename":"5.14.1 - queueprefetch of one -  max dispatched queue is two.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=patrickv","name":"patrickv","key":"patrickv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Vansevenant","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-07T21:53:20.716+0000","size":9028,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12842219/5.14.1+-+queueprefetch+of+one+-++max+dispatched+queue+is+two.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12842216","id":"12842216","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=patrickv","name":"patrickv","key":"patrickv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Vansevenant","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-07T21:51:19.916+0000","size":6831,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12842216/activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12842217","id":"12842217","filename":"JmsClientUnitTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=patrickv","name":"patrickv","key":"patrickv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Vansevenant","active":true,"timeZone":"Etc/UTC"},"created":"2016-12-07T21:51:19.919+0000","size":5239,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12842217/JmsClientUnitTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"A configured queuePrefetch of one in ActiveMQ 5.14.1 with AMQP 1.0 behaves like a queuePrefetch of two.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=patrickv","name":"patrickv","key":"patrickv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Vansevenant","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=patrickv","name":"patrickv","key":"patrickv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrick Vansevenant","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13026489/comment/15730149","id":"15730149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"From looking at the test the current behavior is correct.  The client will flow one credit back to the broker before the message is delivered to the message listener in order to maintain a prefetch of 1 which is leading you to having two messages dispatched to consumer 1.  Consumer 2 then gets two messages because it is consuming and acknowledging the message it did get which is 2.  If you want consumer 1 to only get 1 message then you need to use a prefetch of 0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2016-12-07T22:34:02.253+0000","updated":"2016-12-07T22:34:02.253+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13026489/comment/15730153","id":"15730153","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Code is working as it should in 5.14.x.  Issue likely relates to bugs fixed in the AMQP layer that affected the low credit cases such as the single credit scenario.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2016-12-07T22:35:37.288+0000","updated":"2016-12-07T22:35:37.288+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6530/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i37bev:"}}