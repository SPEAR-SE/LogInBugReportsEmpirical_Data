{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481051","self":"https://issues.apache.org/jira/rest/api/2/issue/12481051","key":"AMQ-1020","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2006-11-02T12:09:10.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jan 08 13:49:44 UTC 2007","customfield_12310420":"84428","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_5860979742_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2007-01-08T13:49:44.742+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1020/watchers","watchCount":1,"isWatching":false},"created":"2006-11-01T17:46:45.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315612","id":"12315612","description":"","name":"4.0.2","archived":false,"released":true,"releaseDate":"2006-07-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-01-08T13:49:44.737+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have a multi-threaded client (client1) which is acting as both a publisher (Topic1) and subscriber (Topic2) using a single session.  There is another client process (client2) which publishes on Topic2.\n\nI have witnessed the following repeatable scenario where both clients get stuck, which can only be rectified by restarting the broker! :-\n\nClient1 publishes messages to Topic1 (rate = about 30 msgs/sec).\nClient2 publishes bursts of messages to Topic2 (rate = 500 msgs/sec) \nClient1 is a slow subscriber on Topic2\n\nAfter running in this scenario for a couple of seconds, Client1 and Client2 become stuck.  Looking at a stack trace for Client1 I can see that it's read_loop is stuck waiting for input, and it's publisher thread is stuck waiting for an acknowledgement to the synchronous message send (the acknowledgement never arrives because the broker won't sent any more messages).\n\nClient2 is also stuck waiting for an acknowledgement to a synchronous send.\n\nMy perception is that it appears the broker is throttling the connection because the consumer is running slowly, but for some reason it gets into a state where all message flow stops (even though the consumer is automatically acknowledging messages, albeit slowly).  Furthermore, if I kill Client1 the broker doesn't recover (using a JMX console the connection remains visible).\n\nThe broker uses a vanilla configuration (i.e. no policies are set for the topics in quedtion).\n ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161859","customfield_12312823":null,"summary":"Slow consumer terminally blocks both client and broker","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=roblugt","name":"roblugt","key":"roblugt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Lugt","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=roblugt","name":"roblugt","key":"roblugt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Lugt","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Broker: Windows XP, Sun JDK1.5  Client: activemq-dotnet (Trunk)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481051/comment/12938490","id":"12938490","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"Are you using explicit acknowledgements or auto-ack (or transactions?). The default prefetch is only about 1000 I think for NMS which means after sending 1000 messages no more messages will be dispatched to a consumer until it receives acks. So I can see why Client1 becomes stuck pretty quickly and why client1 can no longer publish more messages.\n\nSo 2 things to try...\n\nuse dispatchAsync=true (on consumer info) on the consumers, so that dispatching to consumers is asynchronous in the broker. That way a producer won't get blocked waiting to dispatch to slow consumers.\n\nAlso try upping the prefetch value to something large. e.g. on Java for non-persistent topics its about 32000 I think","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2006-11-02T12:09:10.000+0000","updated":"2006-11-02T12:09:10.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481051/comment/12938522","id":"12938522","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=roblugt","name":"roblugt","key":"roblugt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Lugt","active":true,"timeZone":"Etc/UTC"},"body":"Hi James\n\nI'm using auto-acknowledgements (no transactions).  You are correct that the NMS prefetch default is 1000 messages, and this threshold appears to have a bearing on when the consumer (and hence the publisher) gets stuck.  Changing the prefetch size may well remove the symtoms from my test case, but that's not really what I'm looking for.  I believe the test case exposes a critical bug in the broker, and hence gives us an opportunity to fix the bug, which is preferable to changing the configuration to avoid the condition (sod's law dictates that the condition will re-emerge as soon as my application goes into production).\n\nI think there are two crucial points here that need investigating\n1) even though [auto] acknowledgements are being sent to the broker, the consumer is getting stuck dead (i.e. no message activity is occuring once the broker becomes stuck).\n2) killing the slow consumer does not rectify the situation.  This implies that the broker is stuck in some state where it doesn't recognise the client socket has been closed.\n\nIt's probably worth noting that this problem does not occur when I disable Client1 from publishing (even though it's still a slow consumer).  It's only when Client1 is a slow consumer and a [fast] publisher that it falls into the dead-locked condition.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=roblugt","name":"roblugt","key":"roblugt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Rob Lugt","active":true,"timeZone":"Etc/UTC"},"created":"2006-11-02T22:48:37.000+0000","updated":"2006-11-02T22:48:37.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481051/comment/12938701","id":"12938701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pauln%40pandora.com","name":"pauln@pandora.com","key":"pauln@pandora.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"paul normington","active":true,"timeZone":"Etc/UTC"},"body":"\nI have run into this same issue I think.\n\nWe have a scenario with a DurableSubscriber that has retrieved some messages and then disconnects.\nThe publisher continuous publishing at 1000 messages per second.\nAfter 60000 messages are sent, the publisher hangs, and the broker quiesces.\n\nI have seen this behavior with 4.0.1 and 4.1.0\n\nI took a stack trace which showed the server was stuck in UsageManager.waitForSpace().\n\nI can delay the hanging problem by configuring more memory in the MemoryManager.\nI have tried setting timeToLives and pendingMessageLimitStrategies but I still get the hanging.\n\nIf I use a non durable subscriber the problem goes away, but this is not an ideal solution for us.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pauln%40pandora.com","name":"pauln@pandora.com","key":"pauln@pandora.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"paul normington","active":true,"timeZone":"Etc/UTC"},"created":"2006-12-05T19:30:55.000+0000","updated":"2006-12-05T19:30:55.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481051/comment/12936599","id":"12936599","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"This is fixed by the default use of cursors and the spooling to disk for non-durable slow topic consumers","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-01-08T13:49:44.733+0000","updated":"2007-01-08T13:49:44.733+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1020/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s2d3:"}}