{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12500963","self":"https://issues.apache.org/jira/rest/api/2/issue/12500963","key":"AMQ-3214","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-03-28T12:04:58.033+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jun 29 23:42:20 UTC 2011","customfield_12310420":"14590","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_9676190820_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-06-29T23:42:20.091+0000","workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3214/watchers","watchCount":0,"isWatching":false},"created":"2011-03-09T23:52:29.297+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":3600,"aggregatetimeoriginalestimate":3600,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-09-20T10:42:12.797+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313896","id":"12313896","name":"JMS client"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":3600,"customfield_12310080":null,"description":"-Have a multi-thread consumers running to consumer messages\n-Have Connection to have these :\n       \t\tActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(brokerUrl);\n\t\tconnectionFactory.setUseAsyncSend(false);\n\t\tconnectionFactory.setDispatchAsync(false);\n\t\tconnectionFactory.setAlwaysSessionAsync(false);\n\t\tconnectionFactory.setAlwaysSyncSend(true);\n\n-Run the consumers for several hours and profile it\n-You will see there are threads with the name \"InactivityMonitor Async Task\" being spawning continuously\n\nThis will cause the entire consumer system to slow down eventually due to thread context switching.  \n\nSuggestion to fix: we should not put a limit on the number of \"InactivityMonitor Async Task\" threads to be Max Integer.  There is a bug in Java lib that\nit will not stop a thread after a given idle time-to-live. We could fix this in the file InactivityMonitor.java\n","customfield_10010":null,"timetracking":{"originalEstimate":"1h","remainingEstimate":"1h","originalEstimateSeconds":3600,"remainingEstimateSeconds":3600},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12479844","id":"12479844","filename":"threadleak.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-19T21:41:25.400+0000","size":118235,"mimeType":"image/x-png","content":"https://issues.apache.org/jira/secure/attachment/12479844/threadleak.png"}],"aggregatetimeestimate":3600,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59469","customfield_12312823":null,"summary":"\"InactivityMonitor Async Task\" threads leaking","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":3600,"percent":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":3600,"percent":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500963/comment/13012017","id":"13012017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"do you have a reference to the JDK bug that will not timeout idle threads?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-03-28T12:04:58.033+0000","updated":"2011-03-28T12:04:58.033+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500963/comment/13036504","id":"13036504","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Gary,\n\nI used java version \"1.6.0_20\".  However, I do think this issue is on ThreadPoolExecutor so it will happen on all 1.6.x.\nThe problem is that if we construct a ThreadPoolExecutor like the way the InactivityMonitor.java does, all threads will become core threads and they will not get discarded as they become idle unless we set  ThreadPoolExecutor.allowCoreThreadTimeOut to be true (it is false be default).\n\nI think both ActiveMQ client and server are using the InactivityMonitor class and both will be slow down to a complete stop after a while.\n\nI had a patch on this in our development and I could see the problem is gone.  What I did was the change the way InactivityMonitory construct the asynch task threadpool.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-19T21:40:02.042+0000","updated":"2011-05-19T21:40:02.042+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500963/comment/13036506","id":"13036506","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"body":"This image is on the ActiveMQ client library after I ran using it stress test the ActiveMQ server","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-19T21:41:25.418+0000","updated":"2011-05-19T21:41:25.418+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500963/comment/13036527","id":"13036527","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"I tried to replicate this sort of behaviour from AMQ but can't using JDK 1.6.0_21 also couldn't find any open bugs for the JDK that sound like this.  Perhaps you should try an JDK update and if that fails to help maybe provide a stress test example that demonstrates the problem.  \n\nThe way the executor is created now should prevent any threads from being treated as Core threads so they should timeout according to the set idle time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-05-19T22:11:31.755+0000","updated":"2011-05-19T22:11:31.755+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500963/comment/13037111","id":"13037111","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"body":"Hi Timothy,\n\nWe actually had this issue in a few different enviroments here running ActiveMQ server or ActiveMQ client.  \n\nIn my previous company, they opted out to purchase SonicMQ after deploying ActiveMQ server to production and having to restart ActiveMQ almost every week with a noticeable slow-down day after day.  \n\nI would not say that it is JDK's bug.  The way ThreadPoolExecutor being used in that InactivityMonitor is the problem.\nI can repeat this every time.  Otherwise, could you please explain why there are so many InactivityMonitor  threads in my attached image?  I was using YourKit to do the profiling.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timiblossom","name":"timiblossom","key":"timiblossom","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Minh Do","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-05-20T22:02:33.081+0000","updated":"2011-05-20T22:02:33.081+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12500963/comment/13057552","id":"13057552","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Added the call to allowCoreThreadTimeOut(true) since it shouldn't affect the code regardless.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-06-29T23:42:20.098+0000","updated":"2011-06-29T23:42:20.098+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3214/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ajq7:"}}