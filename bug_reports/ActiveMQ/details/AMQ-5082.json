{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12698796","self":"https://issues.apache.org/jira/rest/api/2/issue/12698796","key":"AMQ-5082","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2014-04-11T20:05:56.702+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Feb 03 15:02:41 UTC 2017","customfield_12310420":"377144","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_92145526172_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-02-03T15:02:41.417+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5082/watchers","watchCount":25,"isWatching":false},"created":"2014-03-05T03:03:55.302+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-02-03T15:02:41.468+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320200","id":"12320200","name":"activemq-leveldb-store","description":"LevelDB based message store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have a 3 node amq cluster and one zookeeper node using a replicatedLevelDB persistence adapter.\n\n{code}\n        <persistenceAdapter>\n            <replicatedLevelDB\n              directory=\"${activemq.data}/leveldb\"\n              replicas=\"3\"\n              bind=\"tcp://0.0.0.0:0\"\n              zkAddress=\"zookeep0:2181\"\n              zkPath=\"/activemq/leveldb-stores\"/>\n        </persistenceAdapter>\n{code}\n\nAfter about a day or so of sitting idle there are cascading failures and the cluster completely stops listening all together.\n\nI can reproduce this consistently on 5.9 and the latest 5.10 (commit 2360fb859694bacac1e48092e53a56b388e1d2f0).  I am going to attach logs from the three mq nodes and the zookeeper logs that reflect the time where the cluster starts having issues.\n\nThe cluster stops listening Mar 4, 2014 4:56:50 AM (within 5 seconds).\n\nThe OSs are all centos 5.9 on one esx server, so I doubt networking is an issue.\n\nIf you need more data it should be pretty easy to get whatever is needed since it is consistently reproducible.\n\nThis bug may be related to AMQ-5026, but looks different enough to file a separate issue.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12633523","id":"12633523","filename":"03-07.tgz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-08T03:14:43.124+0000","size":649535,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12633523/03-07.tgz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12639859","id":"12639859","filename":"amq_5082_threads.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"created":"2014-04-11T20:06:50.389+0000","size":3972,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12639859/amq_5082_threads.tar.gz"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12632749","id":"12632749","filename":"mq-node1-cluster.failure","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-05T03:04:42.646+0000","size":13752,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12632749/mq-node1-cluster.failure"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12632752","id":"12632752","filename":"mq-node2-cluster.failure","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-05T03:04:42.657+0000","size":48529,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12632752/mq-node2-cluster.failure"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12632751","id":"12632751","filename":"mq-node3-cluster.failure","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-05T03:04:42.653+0000","size":103603,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12632751/mq-node3-cluster.failure"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12632750","id":"12632750","filename":"zookeeper.out-cluster.failure","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-05T03:04:42.650+0000","size":14454,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12632750/zookeeper.out-cluster.failure"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12778502","id":"12778502","filename":"zookeeper-failover-logs.7z","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glstephen","name":"glstephen","key":"glstephen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregor Stephen","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-18T15:38:03.532+0000","size":275008,"mimeType":"application/x-7z-compressed","content":"https://issues.apache.org/jira/secure/attachment/12778502/zookeeper-failover-logs.7z"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"377439","customfield_12312823":null,"summary":"ActiveMQ replicatedLevelDB cluster breaks, all nodes stop listening","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13920424","id":"13920424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"body":"Attaching logs from three mq nodes and zookeeper.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-05T03:04:42.660+0000","updated":"2014-03-05T03:04:42.660+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13924689","id":"13924689","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"body":"I've been doing some more digging on this.  It turns out that there is a job on another vm on the esx box that occurs exactly when things fail.  The job is backing up @ 60GB s3.  At that point there is a big hiccup in the system and all the activemq nodes stop listening and never recover.  I tried to increase the zookeeper timeout from 2s to 10s on the activemq nodes and that still doesn't help.\n\nI think the bug here is that the nodes never recover from this outage.  It seems like there should be some type of recovery logic when all the nodes lose their connection and come back to life at some later point in time.\n\nI am adding more logs with DEBUG enabled from 03/07/14.\n\nThis set of logs shows the behavior that I am talking about.  Starting at 04:52:22,366 the nodes go into a state where none are elected\n\n{code}\n$ egrep '\"elected\":' mq-node1-activemq.log.bug \n2014-03-07 04:50:49,325 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000169,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":-1,\"weight\":1,\"elected\":\"0000000171\"}), (0000000171,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:58506\",\"position\":-1,\"weight\":1,\"elected\":null})))\n2014-03-07 04:50:54,453 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000169,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":-1,\"weight\":1,\"elected\":\"0000000171\"}), (0000000171,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:58506\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000173,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161531,\"weight\":1,\"elected\":null})))\n2014-03-07 04:51:06,008 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000169,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":-1,\"weight\":1,\"elected\":\"0000000171\"}), (0000000171,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:58506\",\"position\":-1,\"weight\":1,\"elected\":null})))\n2014-03-07 04:51:42,386 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000169,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":-1,\"weight\":1,\"elected\":\"0000000171\"}), (0000000171,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null})))\n2014-03-07 04:52:22,366 DEBUG [main] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null})))\n2014-03-07 04:52:24,160 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000175,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null})))\n2014-03-07 04:52:24,167 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000175,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null}), (0000000176,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null})))\n2014-03-07 04:52:58,259 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000175,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null}), (0000000176,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null}), (0000000177,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161531,\"weight\":1,\"elected\":null})))\n2014-03-07 04:55:12,679 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000175,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null}), (0000000176,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null})))\n2014-03-07 04:55:12,681 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000175,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null})))\n2014-03-07 04:56:02,014 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000175,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null}), (0000000178,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null})))\n2014-03-07 05:00:20,550 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000175,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null})))\n2014-03-07 05:01:32,446 DEBUG [main-EventThread] [org.apache.activemq.leveldb.replicated.MasterElector@112] ZooKeeper group changed: Map(localhost -> ListBuffer((0000000174,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://10.1.1.218:49168\",\"position\":-1,\"weight\":1,\"elected\":null}), (0000000175,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161609,\"weight\":1,\"elected\":null}), (0000000179,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":161531,\"weight\":1,\"elected\":null})))\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-03-08T03:14:43.129+0000","updated":"2014-03-08T03:14:43.129+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13967034","id":"13967034","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"body":"I believe I am seeing the same issue.  We have a three node dev setup that seems to consistently get into this state.  Attached are thread dumps from each of the nodes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"created":"2014-04-11T20:05:56.702+0000","updated":"2014-04-11T20:05:56.702+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13967035","id":"13967035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"body":"Thread dump of non-listening cluster.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"created":"2014-04-11T20:06:50.393+0000","updated":"2014-04-11T20:06:50.393+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13967040","id":"13967040","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"body":"Shutting down node1 from the attached thread dumps properly promoted node3 to be the master.  So, it appears that node1 is somehow maintaining its leadership (but not listening) when this happens.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"created":"2014-04-11T20:13:32.912+0000","updated":"2014-04-11T20:13:32.912+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13967073","id":"13967073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"body":"This can be reproduced by causing a network disruption where all the apache nodes can't access any of the zookeeper cluster.  The disruption needs to be longer than the zk timeout.  The quickest way I've been able to accomplish this is by using my local firewall, although the state of the objects isn't always the exact same as the logs that i posted the overall symptoms are.\n\nIn code I think the problem is in the org.apache.activemq.leveldb.replicated.MasterElector.scala -> change_listener.  As Kevin said, the node thinks that it is the master but it is not correctly initializing the listener when it gets into this state.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-04-11T20:37:50.828+0000","updated":"2014-04-11T20:37:50.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13978219","id":"13978219","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"body":"Still exists in 5.9.1.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"created":"2014-04-23T14:04:22.199+0000","updated":"2014-04-23T14:04:22.199+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13979002","id":"13979002","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"body":"This actually seems pretty easy to reproduce without network errors or slow IO.\n\n# Setup 3 node ActiveMQ cluster\n# Setup 3 node ZK cluster on same hosts\n# Start ActiveMQ and ZK on each host\n# Determine which ActiveMQ process is the master (telnet 61616 on each host)\n# Look in ActiveMQ log of the master, determine which ZK it is connected to via DEBUG log\n{{Got ping response for sessionid: ... after 1ms | org.apache.zookeeper.ClientCnxn | main-SendThread($host:2181)}}\n# Restart that ZK process.\n# Most of the time the ActiveMQ cluster does not recover/is dead at this point.  If it does recover go to #4.  I haven't made it past rolling two ZK processes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"created":"2014-04-23T22:17:30.744+0000","updated":"2014-04-23T22:17:30.744+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/13979145","id":"13979145","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"body":"The 7 step process above requires a step 0.  That is, have a rogue process listening on 61619 on a single host in your cluster.  After stopping that, I can't reproduce easily anymore.  I'm not sure if ActiveMQ could check ports that it requires at startup or not, even when it is not going to bind to them unless it becomes the master.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=krm1312","name":"krm1312","key":"krm1312","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin McLaughlin","active":true,"timeZone":"America/New_York"},"created":"2014-04-24T00:46:41.621+0000","updated":"2014-04-24T00:46:41.621+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14041885","id":"14041885","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adewavrin","name":"adewavrin","key":"adewavrin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anselme dewavrin","active":true,"timeZone":"Europe/Berlin"},"body":"Dear all,\n\nWe had the exact same problem due to backups at our hosting company, that we could not avoid.\n\nSo we can consider that the cluster behaves  normally : when unable to communicate with each others, the brokers try to fail over.\n\nWe increased the ticktime in zookeeper and it works perfectly. 4 months in production already.\n\nAnselme","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adewavrin","name":"adewavrin","key":"adewavrin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anselme dewavrin","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-24T08:53:23.137+0000","updated":"2014-06-24T09:03:27.288+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14052614","id":"14052614","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"body":"increasing the ticktime didn't solve the issue for me.  I increased it to 20000 and it still consistently fails.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-07-04T18:46:11.024+0000","updated":"2014-07-04T18:46:11.024+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14357632","id":"14357632","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"I was seeing similar behavior on 5.11.1 when I spun up two 3-node clusters in a VirtualBox environment.  I assumed the problem was not enough cpu cycles to keep the zookeeper session alive.  I've got a proposed Unit Test:\n\nhttps://github.com/jimrobinson/activemq/commit/58b7198880f5296af6b2e4e9efbbdfdb51220411\n\nand a potential fix:\n\nhttps://github.com/jimrobinson/activemq/commit/d272a116ff5c0916a6044d657f99df48f264bd2a\n\nI believe the underlying issue is that ZooKeeperGroup is relying on\n\norg.linkedin.zookeeper.tracker.ZooKeeperTreeTracker\n\nto keep its membership list up to date, and I don't believe that is happening on zookeeper session expiration.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-11T21:17:45.103+0000","updated":"2015-03-11T21:19:56.681+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14363414","id":"14363414","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user jimrobinson opened a pull request:\n\n    https://github.com/apache/activemq/pull/74\n\n    AMQ-5082 unit test and patch\n\n    A proposed unit test and patch to address the issues raised in AMQ-5082 (the quorum never recovered after a broker's zookeeper session expires)\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/jimrobinson/activemq master\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/activemq/pull/74.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #74\n    \n----\ncommit 58b7198880f5296af6b2e4e9efbbdfdb51220411\nAuthor: James A. Robinson <jim.robinson@stanford.edu>\nDate:   2015-03-06T23:22:46Z\n\n    unit test for AMQ-5082\n\ncommit d272a116ff5c0916a6044d657f99df48f264bd2a\nAuthor: James A. Robinson <jim.robinson@stanford.edu>\nDate:   2015-03-11T20:47:14Z\n\n    recompute ZooKeeperTreeTracker on reconnect\n\ncommit 8e5558c731fe0ddeee4136d806315023c47f108c\nAuthor: James A. Robinson <jim.robinson@stanford.edu>\nDate:   2015-03-16T16:10:24Z\n\n    synchronize the entire tree check/rebuild operation; use a boolean instead of a counter to track reconnected state\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-03-16T16:13:37.372+0000","updated":"2015-03-16T16:13:37.372+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14385419","id":"14385419","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"body":"I've been running with Jim's patch for several days now without failure.  Everytime I try to break the cluster - via load spikes or blocking zookeeper ports - the system recovers immediately after the failure event ends.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-28T17:11:57.588+0000","updated":"2015-03-28T17:11:57.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14385634","id":"14385634","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"Awesome, thanks [~jim.robinson@gmail.com] for the patch. I'll take a look tomorrow or Monday and get this in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2015-03-29T05:30:08.755+0000","updated":"2015-03-29T05:30:08.755+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14387628","id":"14387628","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"Hey [~jim.robinson@gmail.com] i'm trying to apply your patch but the unit tests you have doesn't pass w/ or w/o the patch. Can you take a look with the patch applied to master? https://github.com/apache/activemq/pull/74.diff","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2015-03-30T23:47:42.668+0000","updated":"2015-03-30T23:47:42.668+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14387659","id":"14387659","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"After running a handful more times, it seems to pass ~90% of the time. Is that the same behavior for you? The patch looks fine to me (e.g., rebuilding the ZK tracking tree on reconnect). I'll keep running to see if it's my env or if there is a timing issue with the test.\n\nI've applied the patch (w/o using the pull request which had some other merge noise) as a clean commit here: https://github.com/apache/activemq/commit/a39e51e0519852332f7779443c3db09b6e691d49\n\n[~scottmf] can you test on the latest master to verify things look good?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2015-03-31T00:09:32.103+0000","updated":"2015-03-31T00:09:32.103+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14387689","id":"14387689","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"I ran the leveldb based tests a few times in a row before I submitted\nit, but never ran the full scaffold.  Do you have a copy of one of the\noutput text files that failed, so that I can see which line it failed\non?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-31T00:24:41.140+0000","updated":"2015-03-31T00:24:41.140+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14387955","id":"14387955","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"The very last assert it was failing. I've run it about 10 times in a row and seems to pass now. Not sure what was up earlier.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2015-03-31T04:26:37.843+0000","updated":"2015-03-31T04:26:37.843+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14388237","id":"14388237","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"\n\nIt's possible that it took longer than 30 seconds to re-run the\nelection.  I'm not sure what the appropriate time to wait is, but it\nwas pretty ugly as it was with all the 30 second delays I had plugged\nin. :(\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-31T08:29:41.144+0000","updated":"2015-03-31T08:29:41.144+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14388891","id":"14388891","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Most recent Jenkins build indicates there is still an issue, either with the test or the fix:\nhttps://builds.apache.org/job/ActiveMQ-Java8/org.apache.activemq$activemq-leveldb-store/308/console","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-03-31T17:30:46.568+0000","updated":"2015-03-31T17:30:46.568+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14389036","id":"14389036","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm running some iterations of the test now, to see if I can\nget it to fail the same way on my system.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-31T18:07:41.061+0000","updated":"2015-03-31T18:07:41.061+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14389116","id":"14389116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"If I run the test enough times I can get a failure.  I'll dig into this.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-31T18:33:41.188+0000","updated":"2015-03-31T18:33:41.188+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14389197","id":"14389197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"This is from a successful run:\n\n2015-03-31 10:57:48,599 | INFO  | ActiveMQ Task-EventThread | Promoted to\nmaster\n2015-03-31 10:57:48,601 | INFO  | ActiveMQ Task | Using the pure java\nLevelDB implementation.\n2015-03-31 10:57:48,621 | INFO  | ActiveMQ Task | Master started:\ntcp://localhost:61227\n2015-03-31 10:57:48,625 | INFO  | ActiveMQ Task | Using the pure java\nLevelDB implementation.\n2015-03-31 10:57:48,625 | INFO  | ActiveMQ Task | Using the pure java\nLevelDB implementation.\n2015-03-31 10:57:48,626 | INFO  | ActiveMQ Task | Attaching to master:\ntcp://localhost:61227\n2015-03-31 10:57:48,626 | INFO  | ActiveMQ Task | Attaching to master:\ntcp://localhost:61227\n2015-03-31 10:57:48,626 | INFO  | ActiveMQ Task | Slave started\n2015-03-31 10:57:48,627 | INFO  | ActiveMQ Task | Slave started\n2015-03-31 10:57:48,883 | INFO  | hawtdispatch-DEFAULT-3 | Slave has\nconnected: 03942600-8462-4b44-b40d-e3a398193638\n2015-03-31 10:57:49,130 | INFO  | hawtdispatch-DEFAULT-4 | Slave has\nconnected: 85f59a26-8faf-4d0c-992c-dc04ffa0e051\n2015-03-31 10:57:49,132 | INFO  | hawtdispatch-DEFAULT-5 | Attaching...\nDownloaded 0.00/0.00 kb and 1/1 files\n2015-03-31 10:57:49,132 | INFO  | hawtdispatch-DEFAULT-5 | Attached\n2015-03-31 10:57:49,137 | INFO  | hawtdispatch-DEFAULT-7 | Attaching...\nDownloaded 0.00/0.00 kb and 1/1 files\n2015-03-31 10:57:49,137 | INFO  | hawtdispatch-DEFAULT-7 | Attached\n2015-03-31 10:57:49,142 | INFO  | hawtdispatch-DEFAULT-3 | Slave has now\ncaught up: 03942600-8462-4b44-b40d-e3a398193638\n2015-03-31 10:57:49,143 | INFO  | hawtdispatch-DEFAULT-4 | Slave has now\ncaught up: 85f59a26-8faf-4d0c-992c-dc04ffa0e051\n2015-03-31 10:58:15,391 | INFO  | Thread-6 | Checking for a single master\n\nAnd this is from a failed run:\n\n2015-03-31 11:24:58,612 | INFO  | ActiveMQ Task-EventThread | Promoted to\nmaster\n2015-03-31 11:24:58,614 | INFO  | ActiveMQ Task | Using the pure java\nLevelDB implementation.\n2015-03-31 11:24:58,631 | INFO  | ActiveMQ Task | Master started:\ntcp://localhost:49958\n2015-03-31 11:24:58,636 | INFO  | ActiveMQ Task | Using the pure java\nLevelDB implementation.\n2015-03-31 11:24:58,637 | INFO  | ActiveMQ Task | Attaching to master:\ntcp://localhost:49958\n2015-03-31 11:24:58,637 | INFO  | ActiveMQ Task | Slave started\n2015-03-31 11:24:58,936 | INFO  | hawtdispatch-DEFAULT-3 | Slave has\nconnected: 143f918b-8ff0-4d8e-ba9b-04bd6644a443\n2015-03-31 11:24:58,940 | INFO  | hawtdispatch-DEFAULT-4 | Attaching...\nDownloaded 0.00/0.00 kb and 1/1 files\n2015-03-31 11:24:58,940 | INFO  | hawtdispatch-DEFAULT-4 | Attached\n2015-03-31 11:24:58,949 | INFO  | hawtdispatch-DEFAULT-3 | Slave has now\ncaught up: 143f918b-8ff0-4d8e-ba9b-04bd6644a443\n2015-03-31 11:24:59,248 | INFO  | ActiveMQ\nTask-SendThread(fe80:0:0:0:0:0:0:1%1:49627) | Socket connection established\nto fe80:0:0:0:0:0:0:1%1/fe80:0:0:0:0:0:0:1%1:49627, initiating session\n2015-03-31 11:24:59,248 | INFO  | NIOServerCxn.Factory:0.0.0.0/0.0.0.0:0 |\nAccepted socket connection from /fe80:0:0:0:0:0:0:1%1:49962\n2015-03-31 11:24:59,248 | INFO  | NIOServerCxn.Factory:0.0.0.0/0.0.0.0:0 |\nClient attempting to renew session 0x14c7112e2cc0001 at\n/fe80:0:0:0:0:0:0:1%1:49962\n2015-03-31 11:24:59,249 | INFO  | NIOServerCxn.Factory:0.0.0.0/0.0.0.0:0 |\nInvalid session 0x14c7112e2cc0001 for client /fe80:0:0:0:0:0:0:1%1:49962,\nprobably expired\n2015-03-31 11:24:59,249 | INFO  | NIOServerCxn.Factory:0.0.0.0/0.0.0.0:0 |\nClosed socket connection for client /fe80:0:0:0:0:0:0:1%1:49962 which had\nsessionid 0x14c7112e2cc0001\n2015-03-31 11:24:59,249 | INFO  | ActiveMQ Task-EventThread | Initiating\nclient connection, connectString=localhost:49627 sessionTimeout=15000\nwatcher=org.apache.activemq.leveldb.replicated.groups.ZKClient@99b2a1d\n2015-03-31 11:24:59,249 | INFO  | ActiveMQ Task-EventThread | EventThread\nshut down\n2015-03-31 11:24:59,250 | INFO  | ActiveMQ Task-SendThread(localhost:49627)\nsession\n2015-03-31 11:24:59,250 | INFO  | NIOServerCxn.Factory:0.0.0.0/0.0.0.0:0 |\nAccepted socket connection from /127.0.0.1:49963\n2015-03-31 11:24:59,250 | INFO  | NIOServerCxn.Factory:0.0.0.0/0.0.0.0:0 |\nClient attempting to establish new session at /127.0.0.1:49963\n2015-03-31 11:24:59,252 | INFO  | SyncThread:0 | Established session\n0x14c7112e2cc0005 with negotiated timeout 10000 for client /127.0.0.1:49963\n2015-03-31 11:24:59,252 | INFO  | ActiveMQ Task-SendThread(localhost:49627)\nsessionid = 0x14c7112e2cc0005, negotiated timeout = 10000\n2015-03-31 11:24:59,257 | INFO  | ActiveMQ Task | Using the pure java\nLevelDB implementation.\n2015-03-31 11:24:59,258 | INFO  | ActiveMQ Task | Attaching to master:\ntcp://localhost:49958\n2015-03-31 11:24:59,260 | INFO  | ActiveMQ Task | Slave started\n2015-03-31 11:24:59,541 | INFO  | hawtdispatch-DEFAULT-5 | Slave has\nconnected: 5f12ef48-86ab-472a-ae1a-5379bf490902\n2015-03-31 11:24:59,544 | INFO  | hawtdispatch-DEFAULT-6 | Attaching...\nDownloaded 0.00/0.00 kb and 1/1 files\n2015-03-31 11:24:59,544 | INFO  | hawtdispatch-DEFAULT-6 | Attached\n2015-03-31 11:24:59,553 | INFO  | hawtdispatch-DEFAULT-5 | Slave has now\ncaught up: 5f12ef48-86ab-472a-ae1a-5379bf490902\n2015-03-31 11:25:25,396 | INFO  | Thread-6 | Checking for a single master\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-31T18:58:41.496+0000","updated":"2015-03-31T18:58:41.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14389459","id":"14389459","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"So, for some reason the call to\n\nElectingLevelDBStore.isMaster()\n\nis returning false during some runs.  That function checks\ntwo atomic booleans:\n\nmaster_started.get() && !master_stopped.get()\n\nand in some cases master_stopped.get() is returning true\n(triggering failure) and in other cases it is returning false.\n\nJim\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-03-31T21:33:41.088+0000","updated":"2015-03-31T21:33:41.088+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14389681","id":"14389681","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user jimrobinson closed the pull request at:\n\n    https://github.com/apache/activemq/pull/74\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-03-31T23:45:01.244+0000","updated":"2015-03-31T23:45:01.244+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14389735","id":"14389735","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"It's not at all clear to me how master_stopped is sometimes true\nand sometimes false.  I'm wondering if there's a section of the\ncode that I'm missing where the broker is discarded and then\nrecreated on failure.\n\nI'm running a round of tests after having made a change to\nreset master_stopped after master.start():\n\n{code}\ndiff --git a/activemq-leveldb-store/src/main/scala/org/apache/activemq/leveldb/replicated/ElectingLevelDBStore.scala\nb/activemq-leveldb-store/src/main/scala/org/apache/activemq/leveldb/replicated/ElectingLevelDBStore.scala\nindex 331d06b..a47baab 100644\n--- a/activemq-leveldb-store/src/main/scala/org/apache/activemq/leveldb/replicated/ElectingLevelDBStore.scala\n+++ b/activemq-leveldb-store/src/main/scala/org/apache/activemq/leveldb/replicated/ElectingLevelDBStore.scala\n@@ -228,6 +228,7 @@ class ElectingLevelDBStore extends ProxyLevelDBStore {\n     master_started.set(true)\n     master.blocking_executor.execute(^{\n       master.start();\n+      master_stopped.set(false)\n       master_started_latch.countDown()\n     })\n     master.blocking_executor.execute(^{\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-01T00:17:41.093+0000","updated":"2015-04-01T00:17:41.093+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14389928","id":"14389928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"GitHub user jimrobinson opened a pull request:\n\n    https://github.com/apache/activemq/pull/76\n\n    fix the inconsistency with ElectingLevelDBStore.isMaster() under AMQ-5082\n\n    I've run through 100 iterations of the ElectingLevelDBStoreTest, I believe this fixes the intermittent issue with the ElectingLevelDBStore failing its isMaster() check.\n\n\nYou can merge this pull request into a Git repository by running:\n\n    $ git pull https://github.com/jimrobinson/activemq amq-5082-unit-test-fix\n\nAlternatively you can review and apply these changes as the patch at:\n\n    https://github.com/apache/activemq/pull/76.patch\n\nTo close this pull request, make a commit to your master/trunk branch\nwith (at least) the following in the commit message:\n\n    This closes #76\n    \n----\ncommit fd917ed3b40e8132876cab11d090e33eb6ac5de8\nAuthor: James A. Robinson <jimr@highwire.org>\nDate:   2015-04-01T02:51:15Z\n\n    fix the inconsistency with ElectingLevelDBStore.isMaster() under AMQ-5082 unit test conditions\n\n----\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-01T03:20:32.444+0000","updated":"2015-04-01T03:20:32.444+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14390648","id":"14390648","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"Thanks Jim for digging into this. I've committed your PR. Running tests on my side I've not gotten it to fail. Hopefully jenkins thinks the same thing :)\n\nThanks again for your contributions!! Look forward to others :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2015-04-01T14:42:07.223+0000","updated":"2015-04-01T14:42:07.223+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14390671","id":"14390671","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"body":"Github user jimrobinson closed the pull request at:\n\n    https://github.com/apache/activemq/pull/76\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=githubbot","name":"githubbot","key":"githubbot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF GitHub Bot","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-01T14:49:58.082+0000","updated":"2015-04-01T14:49:58.082+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14390730","id":"14390730","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adewavrin","name":"adewavrin","key":"adewavrin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anselme dewavrin","active":true,"timeZone":"Europe/Berlin"},"body":"A big Thank you Jim, we were truly annoyed by this !\n\nChristian, will this be included in the main branch of the downloadable binaries ? In which version ?\n\nThanks in advance,\n\nAnselme","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adewavrin","name":"adewavrin","key":"adewavrin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anselme dewavrin","active":true,"timeZone":"Europe/Berlin"},"created":"2015-04-01T14:54:16.058+0000","updated":"2015-04-01T14:54:16.058+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14390759","id":"14390759","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"Will be in 5.12 when released. Do you needed it back ported to a 5.11.x?\nOr can test with the nightly builds here:\n\nhttps://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.12-SNAPSHOT/","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2015-04-01T15:08:40.171+0000","updated":"2015-04-01T15:08:40.171+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14392618","id":"14392618","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adewavrin","name":"adewavrin","key":"adewavrin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anselme dewavrin","active":true,"timeZone":"Europe/Berlin"},"body":"Well, it depends... When do you think v5.12 is planned for release ?\n\nHow do I patch a 5.11 ?\n\nThank you, we have been using ActiveMQ a lot in production for 20 months and it works well. We could give testimonial.\n\nAnselme","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adewavrin","name":"adewavrin","key":"adewavrin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anselme dewavrin","active":true,"timeZone":"Europe/Berlin"},"created":"2015-04-02T11:57:08.454+0000","updated":"2015-04-02T11:57:08.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14392908","id":"14392908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"On Thu, Apr 2, 2015 at 6:30 AM, anselme dewavrin (JIRA) <jira@apache.org>\n\n\n\nYou can just drop in the updated files into the 5.11 source tree and\nrebuild the activemq-leveldb-store tree.  You should then be able to\ntake new activemq-leveldb-store-5.11.2-SNAPSHOT.jar and use that\nto run the updated code.\n\nThe two fixes were in:\n\nhttps://github.com/apache/activemq/blob/master/activemq-leveldb-store/src/main/scala/org/apache/activemq/leveldb/replicated/ElectingLevelDBStore.scala\nhttps://github.com/apache/activemq/blob/master/activemq-leveldb-store/src/main/scala/org/apache/activemq/leveldb/replicated/groups/ZooKeeperGroup.scala\n\nThe unit test changes were:\n\nhttps://github.com/apache/activemq/blob/master/activemq-leveldb-store/src/test/java/org/apache/activemq/leveldb/test/ElectingLevelDBStoreTest.java\nhttps://github.com/apache/activemq/blob/master/activemq-leveldb-store/src/test/java/org/apache/activemq/leveldb/test/ZooKeeperTestSupport.java\nhttps://github.com/apache/activemq/blob/master/activemq-leveldb-store/src/test/java/org/apache/zookeeper/server/TestServerCnxnFactory.java\n\nJim\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-04-02T16:26:41.787+0000","updated":"2015-04-02T19:39:21.376+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14392950","id":"14392950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adewavrin","name":"adewavrin","key":"adewavrin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anselme dewavrin","active":true,"timeZone":"Europe/Berlin"},"body":"Thanks Jim for these precisions.\n\ndoing it very soon !\n\nAnselme","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adewavrin","name":"adewavrin","key":"adewavrin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"anselme dewavrin","active":true,"timeZone":"Europe/Berlin"},"created":"2015-04-02T16:58:37.142+0000","updated":"2015-04-02T16:58:37.142+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14637081","id":"14637081","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"[~adewavrin], did you end up applying this patch?  Is it working for you?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-22T15:37:59.656+0000","updated":"2015-07-22T15:37:59.656+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14637098","id":"14637098","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"[~scottmf], have you had any new issues with the brokers getting into a bad state?  I'm seeing some intermittent cases where the brokers end up in a state where none of them think they are the master.  It's frustratingly similar in nature to this bug so I am thinking I missed another edge case w/ my original patches.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-22T15:43:11.486+0000","updated":"2015-07-22T15:43:11.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14638308","id":"14638308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nIt was really helpful to see this patch. With this path broker cluster should not become orphan.  However, It is still not clear to me why zookeeper server is not able to reply within the timeframe. This error still comes even after increasing the \"zksessionTimeout\". \n\nDetails from zookeeper: From what i understand the client sends a ping every 1/3 the timeout, and then looks for a response before another 1/3 elapses. This allows time to reconnect to a different server (and still maintain the session) if the current server were to become unavailable.\n\n\"2014-03-04 04:56:46,861 | INFO  | Client session timed out, have not heard from server in 2667ms for sessionid 0x1437e99789c040c, closing socket connection and attempting reconnect | org.apache.zookeeper.ClientCnxn | main-SendThread(10.1.1.230:2181)\"\n\nThanks,\nAnuj","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2015-07-23T06:46:51.145+0000","updated":"2015-07-23T06:46:51.145+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14638341","id":"14638341","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larsn","name":"larsn","key":"larsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Neumann","active":true,"timeZone":"Europe/Berlin"},"body":"Hi,\n\nI applied to patch to two brokers but they still become unresponsive, though it seems like there are up a bit longer than without the patch. Playing with the {{zksessionTimeout}} didn't help.\n\nCheers,\nLars","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larsn","name":"larsn","key":"larsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Neumann","active":true,"timeZone":"Europe/Berlin"},"created":"2015-07-23T07:03:06.387+0000","updated":"2015-07-23T07:03:06.387+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14638940","id":"14638940","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"body":"I have not seen this issue since applying the patch on top of the origin/activemq-5.11.x branch.\n\nMy zookeeper timeout setting is pretty high.  On activemq my zkSessionTimeout is 60s and time timeouts in my zoo.cfg are set to:\n\ntickTime=5000\nminSessionTimeout=2\nmaxSessionTimeout=180000\n\nLet me know if you want me to check the logs for anything specific.  It is running on DEBUG level and the logs are being forwarded to a log collection tool so i should be able to easily check","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-23T14:56:22.853+0000","updated":"2015-07-23T14:56:22.853+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14638990","id":"14638990","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"Lars,\n\nThanks for the reply.  Can you tell me whether or not your zkSessionTimeout matches the timeout value of your zookeeper server?  I'm not sure what \"playing with\" the value means. :)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-23T15:29:57.677+0000","updated":"2015-07-23T15:29:57.677+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14638995","id":"14638995","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"Ok, so that looks very much like what I have seen on my dev cluster.  Can you tell me whether or not your zkSessionTimeout value matches the value used in your zookeeper cluster?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-23T15:30:59.787+0000","updated":"2015-07-23T15:30:59.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14661481","id":"14661481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larsn","name":"larsn","key":"larsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Neumann","active":true,"timeZone":"Europe/Berlin"},"body":"Jim,\n\nSorry for the late reply. My current configuration is as follows\n* zkSessionTimeout is 4s\n* zoo.cfg is set to tickTime=5000, minSessionTimeout and maxSessionTimeout are not set at all.\n\nBy \"playing around\" I meant that I decreased and increased zkSessionTimeout and tickTime in quite a few different ways.\n* decrease/increase both\n* decrease/increase only one of them\n* increase one and decrease the other and vice versa\n\nSo far I did not experience the issue any more.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=larsn","name":"larsn","key":"larsn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lars Neumann","active":true,"timeZone":"Europe/Berlin"},"created":"2015-08-07T08:12:30.865+0000","updated":"2015-08-07T08:12:30.865+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14728828","id":"14728828","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nSorry for the late reply. \nNo both values are different. I am using zksesseionTimeout= 15s in ActiveMQ configuration to give it more time while zookeeper configuration is : \n\nticktime = 2000 \nminSessionTimeout and maxSessionTimeout are not set.\n\nThanks,\nAnuj\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-03T10:26:27.598+0000","updated":"2015-09-03T10:27:46.425+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14728831","id":"14728831","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"Should we configure zookeeper ticktime also. What is the relation between both the timeouts ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-03T10:30:01.257+0000","updated":"2015-09-03T10:30:01.257+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14729326","id":"14729326","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"body":"If you look at this code:\n\nhttp://grepcode.com/file/repo1.maven.org/maven2/org.apache.zookeeper/zookeeper/3.3.0/org/apache/zookeeper/server/ZooKeeperServer.java#664\n\nyou can see that if you do not set a minSessionTimeout or maxSessionTimeout then zookeeper will default to\n\nminSessionTimeout == 2 x ticktime\n\nmaxSessionTimeout == 20 x ticktime\n\nThe ticktime is milliseconds, so that means your configuration is currently:\n\ntickTime == 2 seconds\nminSessionTimeout == 4 seconds\nmaxSessionTimeout == 40 seconds\n\nMy configuration is the same.  So your zkSessionTimeout is within the accepted range the server will allow, but what I've been finding is that  with my setup the server only became stable at the higher end of that timeout range.   In my case I set it to 40 seconds, the maximum the zookeeper server would allow.\n\nI think what's going on is that the code i ZooKeeperGroup.scala, e.g., at\n\nhttps://github.com/apache/activemq/blob/master/activemq-leveldb-store/src/main/scala/org/apache/activemq/leveldb/replicated/groups/ZooKeeperGroup.scala#L142\n\nisn't handling all the possible exceptions that might get thrown, like with a timeout, and breaks if the timeout gets hit.\n\nI've been too busy on other things to dig into it any more, but I'm pretty confident that the activemq zookeeper client code that interacts with zookeeper server needs to be reevaluated to handle the different ways a connection might be lost.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jim.robinson%40gmail.com","name":"jim.robinson@gmail.com","key":"jim.robinson@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jim Robinson","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-09-03T16:07:37.111+0000","updated":"2015-09-03T16:07:37.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/14730336","id":"14730336","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"Thanks Jim for the detailed explanation. I will increase the value of 'zkSessionTimeout' to 35 sec and see how it goes. \n\n> zookeeper client code that interacts with zookeeper server needs to be reevaluated to handle the different ways a connection might be lost.\nI completely agree with you. We have also faced some weird issue after moving to replicated leveldb which I have posted: \n\nhttp://activemq.2283324.n4.nabble.com/Durable-client-removal-caused-broker-to-shutdown-in-replicated-leveldb-td4701209.html#a4701241 \n\nThanks,\nAnuj\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-04T05:19:18.715+0000","updated":"2015-09-04T05:19:18.715+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/15030598","id":"15030598","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abin","name":"abin","key":"abin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"lee","active":true,"timeZone":"Etc/UTC"},"body":"at recently, my replicated leveldb stored cluster is broken.   if zookeeper session is expired , my zookeeper client will restart to reconnect the zookeeper server that have been connected   and activemq cluser is not elected a master .  though all of the activemq node is connecting the zookeeper,   a master  will not be elected.\n\n\nmy zkSessiontimeout is 25s and the zookeeper server ticktime=2000,,my activemq cluser is three activemq node.   it offen happens recently, please  fixed this bug.   because it reconnects and do not elected a master.\n\nwhy all of the activemq node do not select a master that all reconnect the zookeeper when zookeeper session has expired.\n\nsorry, my english is pool , i do not know that everyone can understand my problem,\n\nthinks!!!!\n\nmy environment is produce.\nAffects Version/s: 5.11.1\n\n\nbut i use 5.12.1 now ,    the problem is still exists.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abin","name":"abin","key":"abin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"lee","active":true,"timeZone":"Etc/UTC"},"created":"2015-11-28T17:31:36.895+0000","updated":"2015-12-02T07:07:19.591+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/15043823","id":"15043823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abin","name":"abin","key":"abin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"lee","active":true,"timeZone":"Etc/UTC"},"body":"for this,  if you set ticktime is short time, Can you try it  in the environment of produce?\n\nshort time is wrong,  my ticktime is 2000 that  this wrong is appearing for a while tiime ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=abin","name":"abin","key":"abin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"lee","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-06T11:05:07.856+0000","updated":"2015-12-06T11:06:45.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/15055052","id":"15055052","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"body":"I cannot change the environment without risking that it will fail again.\n\nI suggest you try something similar to settings i have provided and increase your timeouts so that your zookeeper connections don't get into the state you are describing.  I have been running for several months now without any issues after applying Jim's patch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=scottmf","name":"scottmf","key":"scottmf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Scott Feldstein","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-12-13T17:09:02.059+0000","updated":"2015-12-13T17:09:02.059+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/15064099","id":"15064099","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glstephen","name":"glstephen","key":"glstephen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregor Stephen","active":true,"timeZone":"Etc/UTC"},"body":"We are seeing something very similar to this in our development environment.\n\nWe have a 3-node ActiveMQ cluster where each node has ActiveMQ 5.12.0 and Zookeeper 3.4.6 (*note, we have done some testing with Zookeeper 3.4.7, but this has failed to resolve the issue. Time constraints have so far prevented us from testing ActiveMQ 5.13).\n\nWhat we have found is that when we stop the master ZooKeeper process (via the \"end process tree\" command in Task Manager), the remaining two ZooKeeper nodes continue to function as normal. Sometimes the ActiveMQ cluster is able to handle this, but sometimes it does not.\n\nWhen the cluster fails, we typically see this in the ActiveMQ log:\n\n2015-12-18 09:08:45,157 | WARN  | Too many cluster members are connected.  Expected at most 3 members but there are 4 connected. | org.apache.activemq.leveldb.replicated.MasterElector | WrapperSimpleAppMain-EventThread\n...\n...\n2015-12-18 09:27:09,722 | WARN  | Session 0x351b43b4a560016 for server null, unexpected error, closing socket connection and attempting reconnect | org.apache.zookeeper.ClientCnxn | WrapperSimpleAppMain-SendThread(192.168.0.10:2181)\njava.net.ConnectException: Connection refused: no further information\n\tat sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)[:1.7.0_79]\n\tat sun.nio.ch.SocketChannelImpl.finishConnect(Unknown Source)[:1.7.0_79]\n\tat org.apache.zookeeper.ClientCnxnSocketNIO.doTransport(ClientCnxnSocketNIO.java:361)[zookeeper-3.4.6.jar:3.4.6-1569965]\n\tat org.apache.zookeeper.ClientCnxn$SendThread.run(ClientCnxn.java:1081)[zookeeper-3.4.6.jar:3.4.6-1569965]\n\t\nWe were immediately concerned by the fact that (A)ActiveMQ seems to think there are four members in the cluster when it is only configured with 3 and (B) when the exception is raised, the server appears to be null. We then increased ActiveMQ's logging level to DEBUG in order to display the list of members:\n\n2015-12-18 09:33:04,236 | DEBUG | ZooKeeper group changed: Map(localhost -> ListBuffer((0000000156,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":-1,\"weight\":5,\"elected\":null}), (0000000157,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":-1,\"weight\":1,\"elected\":null}), (0000000158,{\"id\":\"localhost\",\"container\":null,\"address\":\"tcp://192.168.0.11:61619\",\"position\":-1,\"weight\":10,\"elected\":null}), (0000000159,{\"id\":\"localhost\",\"container\":null,\"address\":null,\"position\":-1,\"weight\":10,\"elected\":null}))) | org.apache.activemq.leveldb.replicated.MasterElector | ActiveMQ BrokerService[localhost] Task-14\n\nCan anyone suggest why this may be happening and/or suggest a way to resolve this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glstephen","name":"glstephen","key":"glstephen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregor Stephen","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-18T15:36:18.006+0000","updated":"2015-12-18T15:36:56.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/15064107","id":"15064107","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glstephen","name":"glstephen","key":"glstephen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregor Stephen","active":true,"timeZone":"Etc/UTC"},"body":"Attaching log/config files (zookeeper-failover-logs.7z)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=glstephen","name":"glstephen","key":"glstephen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gregor Stephen","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-18T15:38:03.548+0000","updated":"2015-12-18T15:38:03.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/15363636","id":"15363636","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djj0809","name":"djj0809","key":"djj0809","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ding Jinqiang","active":true,"timeZone":"Asia/Shanghai"},"body":"Does this issue have any progress? We also ran into the same situation with version 5.11, And have no idea how to avoid it","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djj0809","name":"djj0809","key":"djj0809","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ding Jinqiang","active":true,"timeZone":"Asia/Shanghai"},"created":"2016-07-06T02:21:04.199+0000","updated":"2016-07-06T02:21:34.831+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12698796/comment/15851595","id":"15851595","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"LevelDB has been deprecated and is no longer supported.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-02-03T15:02:41.455+0000","updated":"2017-02-03T15:02:41.455+0000"}],"maxResults":54,"total":54,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5082/votes","votes":12,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1szlb:"}}