{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482544","self":"https://issues.apache.org/jira/rest/api/2/issue/12482544","key":"AMQ-1509","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-01-16T19:53:20.196+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Nov 09 11:50:38 UTC 2011","customfield_12310420":"84524","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2817316600_*|*_5_*:*_2_*:*_10203649561_*|*_4_*:*_1_*:*_25568355565","customfield_12312321":null,"resolutiondate":"2009-02-19T09:14:27.897+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1509/watchers","watchCount":1,"isWatching":false},"created":"2007-11-30T17:59:06.171+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315614","id":"12315614","description":"","name":"4.1.1","archived":false,"released":true,"releaseDate":"2007-06-08"}],"issuelinks":[{"id":"12345400","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12345400","type":{"id":"10020","name":"Cloners","inward":"is cloned by","outward":"is a clone of","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10020"},"inwardIssue":{"id":"12530867","key":"AMQ-3582","self":"https://issues.apache.org/jira/rest/api/2/issue/12530867","fields":{"summary":"CLONE - Duplicate topic messages received with network of brokers and selectors","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-09T11:59:52.446+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"If you create a network of two brokers, A and B, one publisher publishing to A, and n (where n is > 1) receivers with selectors, each receiver recieves n messages for every 1 message sent.  The key here is to have a selector.   It would appear that the conduitSubscriptions flag does not work when using selectors.  The conduit does not properly reconcile consumers if they have selectors.  A suggested soltuion would be that ather than process each selector independantly, each selector should be or'ed together and if any selector results in true then a single message should be sent to the other broker.\n\nIn doing research, it would appear that this problem was introduced with bug fix AMQ-810.  Another user reported it via email back to the assignee of AMQ-810 and a short dialog transpired.  See http://www.mail-archive.com/activemq-users@geronimo.apache.org/msg05198.html.  \n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461031","id":"12461031","filename":"ActiveMQActor.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-23T13:23:23.667+0000","size":10715,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461031/ActiveMQActor.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161542","customfield_12312823":null,"summary":"Duplicate topic messages received with network of brokers and selectors","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hoorner","name":"hoorner","key":"hoorner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Howard Orner","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hoorner","name":"hoorner","key":"hoorner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Howard Orner","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12937721","id":"12937721","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hoorner","name":"hoorner","key":"hoorner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Howard Orner","active":true,"timeZone":"Etc/UTC"},"body":"I do not see any subversion commits listed nor do I see code changes in files I would have expected to change on the main subversion trunk.  Is there a way to get the code changes associated with this resolution?   Thanks!\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hoorner","name":"hoorner","key":"hoorner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Howard Orner","active":true,"timeZone":"Etc/UTC"},"created":"2008-01-11T02:18:43.814+0000","updated":"2008-01-11T02:18:43.814+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12939308","id":"12939308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vuinguyen","name":"vuinguyen","key":"vuinguyen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vui Nguyen","active":true,"timeZone":"Etc/UTC"},"body":"Hello Rob. I have been assigned to fix this bug for a version of activemq at work. Since we need this fix fairly soon and it would be a shame to have to reinvent the wheel, I'd really appreciate it if you could share your solution to this bug. I'm actually working on this task for Howard Orner, who submitted the previous comments. Thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vuinguyen","name":"vuinguyen","key":"vuinguyen","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vui Nguyen","active":true,"timeZone":"Etc/UTC"},"created":"2008-01-16T19:53:20.196+0000","updated":"2008-01-16T19:53:20.196+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12939542","id":"12939542","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"body":"Hi all,\n\nI'm also wondering how to get to the patch for this issue, it seems it's not included in the RC4 release of 5.1.0 as I can still reproduce it using 4 brokers.\nDid anybody manage to solve the problem?\n\nThank you.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"created":"2008-04-24T14:57:42.960+0000","updated":"2008-04-25T07:45:56.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12939616","id":"12939616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hoorner","name":"hoorner","key":"hoorner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Howard Orner","active":true,"timeZone":"Etc/UTC"},"body":"Here's a description of how to fix it.  Sorry, I don't have the source available to me right now to upload it, but it's pretty straight forward.  I'm also doing this from memory so you may have to look at the code a bit and make sure I'm not missing anything.\n\nThe ideal solution would actually apply an 'or' of all selectors before forwarding message between brokers.  However that appears very difficult to do because of all the classes involved and the fact that the selector is parsed and cached where its used in other places.  So instead, the org.apache.activemq.network.ConduitBridge and DurableConduitBridge were modified to change all incoming subscription selectors to null before adding the subscription to the list of interested consumers.  This results in excess network traffic because all messages get forwarded regardless of whether the 'other' brokers will actually deliver them after they apply individual selectors.  But it works.\n\nIn ConduitBridge.addToAlreadyInterestedConsumers() remove the lines that check for a selector.  Then put in a line that sets the selector to null before doCreateDemandSubscrition is called in createDemandSubcription.  Do basically the same in DurableConduitBridge.\n\nRob - If this hasn't really been fixed (it appears not to be), I and I'm sure others would appreciate it if you would incorporate this into the code.  It would be better to take my original suggestion of 'or'ing selectors together, but that looks like a lot of code changes, so this at least fixes the bug with just a few lines of code.  \n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hoorner","name":"hoorner","key":"hoorner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Howard Orner","active":true,"timeZone":"Etc/UTC"},"created":"2008-04-25T23:58:42.589+0000","updated":"2008-04-25T23:58:42.589+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12939526","id":"12939526","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"body":"Thank you Howard.\n\nI'm afraid the temporary fix you propose wouldn't be of much use in my case. I am currently working at comparing how well our in-house distributed pub/sub solution routes packets  with respect to ActiveMQ on a generic network of brokers: if I implement the temporary fix ActiveMQ performance wouldn't probably be as good as it should invalidating my test. I guess I'll have to find another MOM for the experiments while ActiveMQ gets fixed. Did any of you ever use any other JMS implementation supporting generic (cyclic) networks of brokers? \n\nUsing pub/sub on networks of brokers must not be so common after all, I would have expected this bug to receive much more comments.\n\nThank you again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"created":"2008-04-26T15:53:14.288+0000","updated":"2008-04-26T15:53:14.288+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12939571","id":"12939571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Yep - not fixed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-04-29T10:55:12.277+0000","updated":"2008-04-29T10:55:12.277+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12939626","id":"12939626","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"The only 'safe' way to do this is the simple fix suggested by Howard. If we try and OR selectors together - we have to deal with the timing around updating  that selector state - and this could be prone to some difficult to track down timing issues.\n\nIf you want to shape the traffic across networks, the best way would be to use destinations, wilcards and network filters.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-04-30T06:25:34.158+0000","updated":"2008-04-30T06:25:34.158+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12939710","id":"12939710","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"body":"Hi Rob,\n\nI saw you committed the changes to fix issue AMQ-1509. I downloaded the latest svn snapshot on may the 8th and tested it  on the (for me usual) 4-nodes-in-a-cycle topology. It seems your patch improves the whole thing as now my test runs end nicely (before the duplication was so massive clients were not able to finish their workload), alas, my clients keep receiving duplicate messages.\n\nI will attach the code of my clients for completeness, either there's something wrong with them or the bug is still there for bigger cyclic topologies. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-23T13:21:57.107+0000","updated":"2008-05-23T13:21:57.107+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12939688","id":"12939688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"body":"This are the clients I use to reproduce the bug on cyclic topologies.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-23T13:23:23.686+0000","updated":"2008-05-23T13:23:23.686+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/12940779","id":"12940779","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"We did some refactoring in this area for another issue, but this generally should be working.\n\nHere's the test case that tries to reproduce the problem (org.apache.activemq.usecases.ThreeBrokerQueueNetworkTest)\n\n{code}\n    public void testABandBCbrokerNetworkWithSelectors() throws Exception {\n        // Setup broker networks\n        bridgeBrokers(\"BrokerA\", \"BrokerB\", dynamicOnly, 2, true);\n        bridgeBrokers(\"BrokerB\", \"BrokerC\", dynamicOnly, 2, true);\n\n        startAllBrokers();\n\n        // Setup destination\n        Destination dest = createDestination(\"TEST.FOO\", true);\n\n        // Setup consumers\n        MessageConsumer clientA = createConsumer(\"BrokerC\", dest, \"dummy = 33\");\n        MessageConsumer clientB = createConsumer(\"BrokerC\", dest, \"dummy > 30\");\n        MessageConsumer clientC = createConsumer(\"BrokerC\", dest, \"dummy = 34\");\n\n        // let consumers propogate around the network\n        Thread.sleep(2000);\n        // Send messages\n        // Send messages for broker A\n        HashMap<String, Object> props = new HashMap<String, Object>();\n        props.put(\"dummy\", 33);\n        sendMessages(\"BrokerA\", dest, MESSAGE_COUNT, props);\n        props.put(\"dummy\", 34);\n        sendMessages(\"BrokerA\", dest, MESSAGE_COUNT * 2, props);\n\n        // Get message count\n        MessageIdList msgsA = getConsumerMessages(\"BrokerC\", clientA);\n        MessageIdList msgsB = getConsumerMessages(\"BrokerC\", clientB);\n        MessageIdList msgsC = getConsumerMessages(\"BrokerC\", clientC);\n\n        msgsA.waitForMessagesToArrive(MESSAGE_COUNT);\n        msgsB.waitForMessagesToArrive(MESSAGE_COUNT * 3);\n        msgsC.waitForMessagesToArrive(MESSAGE_COUNT * 2) ;\n\n        assertEquals(MESSAGE_COUNT, msgsA.getMessageCount());\n        assertEquals(MESSAGE_COUNT * 3, msgsB.getMessageCount());\n        assertEquals(MESSAGE_COUNT *2, msgsC.getMessageCount());\n    }{code}\n\nIf you find it still not working, please submit the test case similar to the one above","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-02-19T09:14:27.870+0000","updated":"2009-02-19T09:14:27.870+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482544/comment/13146959","id":"13146959","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"body":"Hi Dejan,\n\njust by chance I started looking again at this issue. I don't think the problem is fixed: as soon as there are more than one ( at least 2 hops ) paths between brokers message duplication occurs.\n\nHere's a little example:\n\n{code:title=FourBrokerTopicNetworkTest}\n\npublic class FourBrokerTopicNetworkTest extends JmsMultipleBrokersTestSupport implements MessageListener {\n\tprotected static final int MESSAGE_COUNT = 5;\n\tpublic boolean dynamicOnly;\n\n\tpublic void initCombosForTestABandBCbrokerNetworkWithSelectors() {\n\t\taddCombinationValues(\"dynamicOnly\", new Object[] { true, false });\n\t}\n\n\t/**\n\t * A simple square topology BrokerA <-> BrokerB BrokerA <-> BrokerC BrokerB\n\t * <-> BrokerD BrokerD <-> BrokerC\n\t * \n\t */\n\tpublic void testSquareConnectedBrokerNetwork2() throws Exception {\n\t\tint networkTTL = 2;\n\t\tboolean conduitSubs = true;\n\t\tboolean dynamicOnly = false;\n\n\t\t// Setup broker networks\n\t\tbridgeBrokers(\"BrokerA\", \"BrokerB\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerB\", \"BrokerA\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerA\", \"BrokerC\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerC\", \"BrokerA\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\n\t\tbridgeBrokers(\"BrokerD\", \"BrokerC\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerC\", \"BrokerD\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerD\", \"BrokerB\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerB\", \"BrokerD\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\n\t\tstartAllBrokers();\n\n\t\t// Setup destination\n\t\tDestination dest = createDestination(\"TEST.FOO\", true);\n\n\t\t// Setup consumers\n\t\tMessageConsumer clientA = createConsumer(\"BrokerA\", dest, \"msgId > 0\");\n\t\tMessageConsumer clientB = createConsumer(\"BrokerB\", dest, \"msgId > 0\");\n\t\tMessageConsumer clientC = createConsumer(\"BrokerC\", dest, \"msgId > 0\");\n\t\tMessageConsumer clientD = createConsumer(\"BrokerD\", dest, \"msgId > 0\");\n\t\t// let consumers propogate around the network\n\t\tThread.sleep(5000);\n\t\t\n\t\tclientD.setMessageListener(this);\n\n\t\t// Send messages\n\t\tString[] brokers = { \"BrokerA\", \"BrokerB\", \"BrokerC\", \"BrokerD\" };\n\t\tHashMap<String, Object> props = new HashMap<String, Object>();\n\t\tfor (String broker : brokers) {\n\t\t\tprops.put(\"sender\", broker);\n\t\t\tfor (int i = 1; i <= MESSAGE_COUNT; i++) {\n\t\t\t\tprops.put(\"msgId\", i);\n\t\t\t\tsendMessages(broker, dest, 1, props);\n\t\t\t}\n\t\t}\n\n\t\t// Get message count\n\t\tMessageIdList msgsA = getConsumerMessages(\"BrokerA\", clientA);\n\t\tMessageIdList msgsB = getConsumerMessages(\"BrokerB\", clientB);\n\t\tMessageIdList msgsC = getConsumerMessages(\"BrokerC\", clientC);\n\t\tMessageIdList msgsD = getConsumerMessages(\"BrokerD\", clientD);\n\n\t\tmsgsA.waitForMessagesToArrive(MESSAGE_COUNT * 4);\n\t\tmsgsB.waitForMessagesToArrive(MESSAGE_COUNT * 4);\n\t\tmsgsC.waitForMessagesToArrive(MESSAGE_COUNT * 4);\n\t\tmsgsD.waitForMessagesToArrive(MESSAGE_COUNT * 4);\n\t\t\n\t\tSystem.out.println(msgsA.toString());\n\n\t\tassertEquals(MESSAGE_COUNT * 4, msgsA.getMessageCount());\n\t\tassertEquals(MESSAGE_COUNT * 4, msgsB.getMessageCount());\n\t\tassertEquals(MESSAGE_COUNT * 4, msgsC.getMessageCount());\n\t\tassertEquals(MESSAGE_COUNT * 4, msgsD.getMessageCount());\n\t}\n\n\t/**\n\t * A simple square topology BrokerA <-> BrokerB BrokerA <-> BrokerC BrokerB\n\t * <-> BrokerD BrokerD <-> BrokerC\n\t * \n\t */\n\tpublic void testSquareConnectedBrokerNetwork() throws Exception {\n\t\tint networkTTL = 2;\n\t\tboolean conduitSubs = true;\n\t\tboolean dynamicOnly = false;\n\n\t\t// Setup broker networks\n\t\tbridgeBrokers(\"BrokerA\", \"BrokerB\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerB\", \"BrokerA\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerA\", \"BrokerC\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerC\", \"BrokerA\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\n\t\tbridgeBrokers(\"BrokerD\", \"BrokerC\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerC\", \"BrokerD\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerD\", \"BrokerB\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\t\tbridgeBrokers(\"BrokerB\", \"BrokerD\", dynamicOnly, networkTTL,\n\t\t\t\tconduitSubs);\n\n\t\tstartAllBrokers();\n\n\t\t// Setup destination\n\t\tDestination dest = createDestination(\"TEST.FOO\", true);\n\n\t\t// Setup consumers\n\t\tMessageConsumer clientA = createConsumer(\"BrokerA\", dest);\n\t\tMessageConsumer clientB = createConsumer(\"BrokerB\", dest);\n\t\tMessageConsumer clientC = createConsumer(\"BrokerC\", dest);\n\t\tMessageConsumer clientD = createConsumer(\"BrokerD\", dest);\n\t\t// let consumers propogate around the network\n\t\tThread.sleep(5000);\n\n\t\t// Send messages\n\t\tsendMessages(\"BrokerA\", dest, MESSAGE_COUNT);\n\t\tsendMessages(\"BrokerB\", dest, MESSAGE_COUNT);\n\t\tsendMessages(\"BrokerC\", dest, MESSAGE_COUNT);\n\t\tsendMessages(\"BrokerD\", dest, MESSAGE_COUNT);\n\n\t\t// Get message count\n\t\tMessageIdList msgsA = getConsumerMessages(\"BrokerA\", clientA);\n\t\tMessageIdList msgsB = getConsumerMessages(\"BrokerB\", clientB);\n\t\tMessageIdList msgsC = getConsumerMessages(\"BrokerC\", clientC);\n\t\tMessageIdList msgsD = getConsumerMessages(\"BrokerD\", clientD);\n\n\t\tmsgsA.waitForMessagesToArrive(MESSAGE_COUNT * 4);\n\t\tmsgsB.waitForMessagesToArrive(MESSAGE_COUNT * 4);\n\t\tmsgsC.waitForMessagesToArrive(MESSAGE_COUNT * 4);\n\t\tmsgsD.waitForMessagesToArrive(MESSAGE_COUNT * 4);\n\n\t\tassertEquals(MESSAGE_COUNT * 4, msgsA.getMessageCount());\n\t\tassertEquals(MESSAGE_COUNT * 4, msgsB.getMessageCount());\n\t\tassertEquals(MESSAGE_COUNT * 4, msgsC.getMessageCount());\n\t\tassertEquals(MESSAGE_COUNT * 4, msgsD.getMessageCount());\n\t}\n\n\tpublic void setUp() throws Exception {\n\t\tsuper.setAutoFail(true);\n\t\tsuper.setUp();\n\t\tString options = new String(\"?persistent=false&useJmx=false\");\n\t\tcreateBroker(new URI(\"broker:(tcp://localhost:61616)/BrokerA\" + options));\n\t\tcreateBroker(new URI(\"broker:(tcp://localhost:61617)/BrokerB\" + options));\n\t\tcreateBroker(new URI(\"broker:(tcp://localhost:61618)/BrokerC\" + options));\n\t\tcreateBroker(new URI(\"broker:(tcp://localhost:61619)/BrokerD\" + options));\n\t}\n\n\tpublic static Test suite() {\n\t\treturn suite(FourBrokerTopicNetworkTest.class);\n\t}\n\n\t@Override\n\tpublic void onMessage(Message message) {\n\t\ttry {\n\t\t\tSystem.err.println(message.getStringProperty(\"sender\") + \" msgID:\" + message.getIntProperty(\"msgId\") );\n\t\t} catch (JMSException e) {\n\t\t\t// TODO Auto-generated catch block\n\t\t\te.printStackTrace();\n\t\t}\n\t\t\n\t}\n}\n\n{code}\n\nI don't know if there's anything wrong with this test, or if I should use different configurations of TTL, conduit, and dynamicOnly. I tested it with the latest AMQ I could get (5.5.1).\n\nAs you can see delivered messages are more than 20, they are 25. The reason behind it can be seen in the testSquareConnectedBrokerNetwork2 method: clientD will print all messages coming from BrokerA twice as they are forwarded by both BrokerB and BrokerC on two different paths.\nAnd of course this is a major problem whenever a broker network has multiple paths as message duplication becomes so severe that it basically kills the whole thing.\n\nPlease let me know if the test is correct as I'd like to have some more insight about why this is happening. Also my colleagues and I have some ideas about the correct way to fix it.\n\nRegards,\n\ng","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtoff","name":"gtoff","key":"gtoff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovanni Toffetti","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-09T11:50:38.713+0000","updated":"2011-11-09T11:50:38.713+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1509/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s0en:"}}