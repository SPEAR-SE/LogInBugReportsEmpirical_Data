{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12937077","self":"https://issues.apache.org/jira/rest/api/2/issue/12937077","key":"AMQ-6162","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/10005","id":"10005","description":"Workaround","name":"Workaround"},"customfield_12312322":null,"customfield_12310220":"2016-02-08T22:24:02.259+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 02 18:41:04 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2253150061_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-03-02T18:41:04.227+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6162/watchers","watchCount":3,"isWatching":false},"created":"2016-02-05T16:48:34.233+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329848","id":"12329848","name":"5.13.0","archived":false,"released":true,"releaseDate":"2015-12-03"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-03-02T18:41:04.291+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"Given the following setup: Q1 -> DLQ1 (dead letter for Q1) -> DLQ2 (dead letter for Q2).\n\nSessions are transacted.\n\n1. Send message to Q1\n2. Consume Q1 and rollback\n3. Message is DLQ'd to DLQ1\n4. Consume DLQ1 and rollback\n5. Message is DLQ'd to DLQ2\n6. Move message via JMX from DLQ2 to Q1 (QueueViewMBean.moveMessageTo())\n7. Consume Q1 and rollback\n8. DLQ1 stays empty, message seems lost\n\nIf you restart the broker between step 5 and step 6, the message does get DLQ'd to DLQ1 again.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12786503","id":"12786503","filename":"AMQ6162Test.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jo.vandermeeren","name":"jo.vandermeeren","key":"jo.vandermeeren","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"created":"2016-02-05T16:50:58.664+0000","size":8903,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12786503/AMQ6162Test.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"DLQ'd message does not get DLQ'd again until broker restart","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jo.vandermeeren","name":"jo.vandermeeren","key":"jo.vandermeeren","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jo.vandermeeren","name":"jo.vandermeeren","key":"jo.vandermeeren","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12937077/comment/15134447","id":"15134447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jo.vandermeeren","name":"jo.vandermeeren","key":"jo.vandermeeren","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"body":"Unit test added","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jo.vandermeeren","name":"jo.vandermeeren","key":"jo.vandermeeren","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"created":"2016-02-05T16:50:58.668+0000","updated":"2016-02-05T16:50:58.668+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12937077/comment/15137850","id":"15137850","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"The message will be filtered as a duplicate when the rollback attempts to place it back onto the DLQ1 queue in the no restart case.  In the restart case the queues are essentially all fresh so the message is not tagged as a duplicate because that broker instance has in fact not seen that message in that queue before as it was just freshly baked following the restart.  If you were to repeat the sequence a second time following the restart the message would again be filtered as a duplicate as it has now passed through DLQ1 once before during this broker run.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2016-02-08T22:24:02.259+0000","updated":"2016-02-08T22:24:02.259+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12937077/comment/15138736","id":"15138736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jo.vandermeeren","name":"jo.vandermeeren","key":"jo.vandermeeren","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"body":"That is correct, a broker restart does not resolve the issue permanently. I was also thinking that the broker ignored it as a duplicate or something along those lines.\nI can add another failing test case for the case you mentioned but I think the nature of the issue is clear, or isn't it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jo.vandermeeren","name":"jo.vandermeeren","key":"jo.vandermeeren","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"created":"2016-02-09T10:22:14.295+0000","updated":"2016-02-09T10:22:14.295+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12937077/comment/15141061","id":"15141061","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"It does seems like there is an issue going on in that the move case implies that the duplicates tracking should probably roll back the audit to allow the message to cycle again.  I'm not sure yet where that might be going wrong but a debug of the move process might reveal that.  Will add this to the list of things to check out.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2016-02-10T16:05:45.560+0000","updated":"2016-02-10T16:05:45.560+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12937077/comment/15145546","id":"15145546","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"I dug a little deeper and the issue is that the setup you have were the message passes through multiple DLQ's makes it quite tricky to not capture the message as a duplicate when it passes through the chain of Queues again.  The move does rollback the message from the audit of DLQ2 but the broker doesn't know that the message was previously in DLQ1 and so it can't run back through and remove the message from the audit of that Queue.  You can work around this by disabling the Audit for your dead letter strategies which will prevent the tiered DLQ's from filtering out the message on repeated cycles through them.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2016-02-12T23:28:39.767+0000","updated":"2016-02-12T23:28:39.767+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12937077/comment/15145928","id":"15145928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jov","name":"jov","key":"jov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"body":"Thanks for looking into this. I have disabled audit for the DLQs and the messages cycle through as expected now.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jov","name":"jov","key":"jov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jo Vandermeeren","active":true,"timeZone":"Europe/Brussels"},"created":"2016-02-13T11:09:55.866+0000","updated":"2016-02-13T11:09:55.866+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12937077/comment/15176218","id":"15176218","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Workaround exists and the behavior is not unexpected given the chain of DLQ strategies and the forced looping that is occurring.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2016-03-02T18:41:04.263+0000","updated":"2016-03-02T18:41:04.263+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6162/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2shen:"}}