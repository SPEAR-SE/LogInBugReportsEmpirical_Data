{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12646546","self":"https://issues.apache.org/jira/rest/api/2/issue/12646546","key":"AMQ-4521","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2013-05-08T21:23:25.409+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 09 00:25:05 UTC 2013","customfield_12310420":"326904","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_80708499_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-05-09T00:26:48.728+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4521/watchers","watchCount":3,"isWatching":false},"created":"2013-05-08T02:01:40.253+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["TCP_KEEPCNT","TCP_KEEPIDLE","TCP_KEEPINTVL","keepalive","stomp","tcp"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-09T00:26:48.750+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12315706","id":"12315706","name":"stomp"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"keepAlive not working for stomp URLs. Here is the activemq.xml:\n\n{{<transportConnector name=\"stomp+ssl\" uri=\"stomp+ssl://0.0.0.0:61613?trace=true&amp;soLinger30000&amp;keepAlive=true&amp;soTimeout=44000\"/>}}\n\nRunning \"netstat -tupnco\" as root shows java processes without the keepalive timer counting down. This confirms that tcp keepalive is not working.\n\nHowever, running activemq under the following strace command seems to indicate tcp keepalive is being enabled with the setsockopt() system call:\n\nbq.{{strace -o /dev/stdout -f -e setsockopt bin/activemq-admin start  | grep -i setsockopt}}\nbq.{{3029  setsockopt(14, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3029  setsockopt(128, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3040  setsockopt(130, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3040  setsockopt(131, SOL_TCP, TCP_NODELAY, [1], 4) = 0}}\nbq.{{3040  setsockopt(131, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0}}\nbq.{{3044  setsockopt(132, SOL_TCP, TCP_NODELAY, [1], 4) = 0}}\nbq.{{3029  setsockopt(133, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3044  setsockopt(133, SOL_TCP, TCP_NODELAY, [1], 4) = 0}}\nbq.{{3044  setsockopt(133, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0}}\nbq.{{3047  setsockopt(134, SOL_TCP, TCP_NODELAY, [1], 4) = 0}}\nbq.{{3044  setsockopt(135, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3029  setsockopt(135, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3029  setsockopt(136, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3029  setsockopt(131, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3057  setsockopt(134, SOL_SOCKET, SO_RCVBUF, [65536], 4) = 0}}\nbq.{{3057  setsockopt(134, SOL_SOCKET, SO_SNDBUF, [65536], 4) = 0}}\nbq.{{3056  setsockopt(133, SOL_SOCKET, SO_RCVBUF, [65536], 4) = 0}}\nbq.{{3056  setsockopt(133, SOL_SOCKET, SO_SNDBUF, [65536], 4) = 0}}\nbq.{{3029  setsockopt(140, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3029  setsockopt(140, SOL_SOCKET, SO_REUSEADDR, [1], 4) = 0}}\nbq.{{3046  setsockopt(145, SOL_TCP, TCP_NODELAY, [1], 4) = 0}}\nbq.{{3046  setsockopt(145, SOL_SOCKET, SO_KEEPALIVE, [1], 4) = 0}}\nbq.{{3078  setsockopt(146, SOL_TCP, TCP_NODELAY, [1], 4) = 0}}\n\nBut, again, netstat output does not show keepalives being enabled. netstat shows some java processes with keepalive, but then they quickly disappear. The remaining long lived listening and connected sockets do not have keepalive.\n\nnetstat -tupnco\n{{Active Internet connections (w/o servers)}}\n{{Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name Timer}}\n{{tcp        0      0 10.5.48.17:61613        10.5.48.241:57464       ESTABLISHED 3287/java        off (0.00/0/0)}}\n{{tcp        0      0 10.5.48.17:22           192.168.2.10:1203       ESTABLISHED 1548/sshd: b [priv] keepalive (3768.50/0/0)}}\n{{tcp        0      0 10.5.48.17:61613        169.254.6.55:35975      ESTABLISHED 3287/java        off (0.00/0/0)}}\n\nIn addition, even if keepAlive was being set, this is not really a good solution as implemented because one cannot set the keepalive options at the socket level, only at the OS system-wide level. There's no way to set TCP_KEEPCNT, TCP_KEEPIDLE, and TCP_KEEPINTVL. When I set the keepalive options at the OS level, all applications are affected. I clearly don't want to use the same keepalive settings system wide. These three settings should be allowed to set keepalives only for activemq.\n\nTemporary workaround: use http://libkeepalive.sourceforge.net/","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"327249","customfield_12312823":null,"summary":"stomp tcp keepalive not working","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aletheia7","name":"aletheia7","key":"aletheia7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Erik","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aletheia7","name":"aletheia7","key":"aletheia7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Erik","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux: Ubuntu 12.04.1 LTS (precise)\njava version \"1.6.0_27\"\nOpenJDK Runtime Environment (IcedTea6 1.12.5) (6b27-1.12.5-1)\nOpenJDK Client VM (build 20.0-b12, mixed mode, sharing)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12646546/comment/13652373","id":"13652373","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"TCP_KEEPCNT, TCP_KEEPIDLE, and TCP_KEEPINTVL are not accessible for Java based apps, you need to set them on the OS.\n\nSTOMP client's using v1.1 and up can use STOMP defined heart-beat messages to test the connection.  The Broker supports this and its generally a better solution than relying on TCP keepalive ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-05-08T21:23:25.409+0000","updated":"2013-05-08T21:23:25.409+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12646546/comment/13652397","id":"13652397","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"To set the value on the connected transport i.e. the one that's created for each incoming client connection and not the actual Broker side server socket use \"?transport.keepAlive=true\"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-05-08T21:56:59.771+0000","updated":"2013-05-08T21:56:59.771+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12646546/comment/13652578","id":"13652578","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aletheia7","name":"aletheia7","key":"aletheia7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Erik","active":true,"timeZone":"America/Los_Angeles"},"body":"transport.keepAlive=true along with transport.soLinger=30 work as expected. netstat command shows keepalive being enabled on the sockets with these options.\n\nThank you for the clarification.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aletheia7","name":"aletheia7","key":"aletheia7","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Erik","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-05-09T00:25:05.875+0000","updated":"2013-05-09T00:25:05.875+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4521/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1kean:"}}