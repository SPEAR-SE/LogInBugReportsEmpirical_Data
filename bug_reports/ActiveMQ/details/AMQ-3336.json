{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12508355","self":"https://issues.apache.org/jira/rest/api/2/issue/12508355","key":"AMQ-3336","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2011-05-26T10:17:19.236+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 26 16:47:42 UTC 2011","customfield_12310420":"74699","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3336/watchers","watchCount":2,"isWatching":false},"created":"2011-05-25T21:10:26.038+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315625","id":"12315625","description":"","name":"5.4.2","archived":false,"released":true,"releaseDate":"2010-12-02"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-05-26T16:47:42.806+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Based on the following page, the failover transport should handle Temporary destinations transparent to clients after a failover:\n\n{code}\n  http://activemq.apache.org/how-do-i-configure-automatic-reconnection.html\n{code}\n\nHowever, I have a test in which a producer to a Temporary Destination receives the following error on a temporary destination created before a failover, when producing after the failover (message truncated):\n\n{code}\n  javax.jms.InvalidDestinationException: Cannot publish to a deleted Destination: temp-queue://ID: ...\n{code}\n\nHere's the test steps:\n\n  # create broker network (using 3 nodes in this test, but 2 should suffice)\n    #* each broker connects to the other 2 with duplex network connectors\n    #* failover transport is used (custom \"single\" transport also used to test)\n    #* H/A pairs; each NODE consits of 2 brokers using shared fileystem locking\n  # start an echo service connected to node \"2\"\n    #* service listens on a permanent queue\n    #* replyTo header used to send a copy of message back to the sender\n    #* on request, create producer to the replyTo destination, send response, close producer\n    #* using failover transport\n  # start an echo client connected to node \"1\"\n    #* a temporary Queue or Topic (2 separate tests) is created\n    #* client sends requests to the echo service with replyTo of the temp dest\n    #* requests sent at regular intervals asynchronous of response processing\n    #* multiple requests sent in sequence\n  # after a short delay, node \"1\" is forced to fail over\n    #* BrokerService stop method called on the active broker in the node\n    #* failover completes succesfully\n  # next request by the echo client to the service result in the following error (message truncated)\n{code}\n       javax.jms.InvalidDestinationException: Cannot publish to a deleted Destination: temp-queue://ID: ...\n{code}\n\nCan the failover transport and broker support transparent recovery of the temporary destination by a producer on a different broker/connection?\n\nNote that this sequence works fine with queues, as-expected.  Topics with non-durable subscriptions lose messages, but that's likely expected due to the consumer being off the bus for a period of time.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"81554","customfield_12312823":null,"summary":"Temporary Destination errors on H/A failover in broker network with Failover transport","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Client using failover transport\nNetwork of brokers with failover transports using maxReconnectAttempts=1\nTemporary Queues and Topics\n5.4.2 with patches","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12508355/comment/13039624","id":"13039624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"the failover transport will recreate temp destinations but an activemq connection tracks a temp destination deleted advisory. \nWhen the broker is shutdown via stop, the temp dest is deleted as part of the connection close and the advisory fires so the connection sees the destination as deleted.\n\nYou need to configure the activemq connection to not track temp advisories:\njms.watchTopicAdvisories=false as a url param on the client brokerURL, or via the corresponding attribute on the connection or connection factory.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-26T10:17:19.236+0000","updated":"2011-05-26T10:17:19.236+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12508355/comment/13039743","id":"13039743","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Disabling the advisories will lead to other issues for our network.  Perhaps the right answer here is to distinguish a clean broker shutdown from an abrupt one.  On a clean shutdown, a formal process can be used to eliminate, or minimize, the impact on clients of temporary destinations.\n\nI'll test abrupt broker termination.  Any tips on doing so in a JUnit with multiple brokers (BrokerService instances) would be appreciated.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2011-05-26T15:48:02.458+0000","updated":"2011-05-26T15:48:02.458+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12508355/comment/13039767","id":"13039767","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"On the advisory, in an ActiveMQConnection, the advisory is only used for temp deletion detection as an optimization to save on a round trip to the broker. So the impact will be limited to just your use case. You still leave advisorySupport=true for the broker.\n\nTo simulate an abortive broker shutdown for clients I use the org.apache.activemq.util.SocketProxy test class from activemq-core, that easily allows the connection to be aborted between the client and broker. See usage is something like\norg.apache.activemq.usecases.BrokerQueueNetworkWithDisconnectTest\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-26T16:34:21.449+0000","updated":"2011-05-26T16:34:21.449+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12508355/comment/13039774","id":"13039774","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"I see.  I'll try the advisory setting - that sounds good.\n\nFor abortive, the primary purpose is H/A testing of a failover, although I can test this use case with that method...  I'll look at that.\n\nThanks!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2011-05-26T16:47:42.782+0000","updated":"2011-05-26T16:47:42.782+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3336/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0eb27:"}}