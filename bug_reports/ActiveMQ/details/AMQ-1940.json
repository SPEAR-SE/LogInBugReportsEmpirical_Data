{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482508","self":"https://issues.apache.org/jira/rest/api/2/issue/12482508","key":"AMQ-1940","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338054","id":"12338054","name":"5.15.0","archived":false,"released":true,"releaseDate":"2017-07-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12338909","id":"12338909","name":"5.14.4","archived":false,"released":true,"releaseDate":"2017-03-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-09-17T08:36:16.502+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jan 24 13:48:35 UTC 2017","customfield_12310420":"75166","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_471706050_*|*_4_*:*_2_*:*_6949956522_*|*_5_*:*_3_*:*_256208445306","customfield_12312321":null,"resolutiondate":"2017-01-24T13:49:20.328+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1940/watchers","watchCount":14,"isWatching":false},"created":"2008-09-17T07:14:12.514+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[{"id":"12335010","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12335010","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12482854","key":"AMQ-1693","self":"https://issues.apache.org/jira/rest/api/2/issue/12482854","fields":{"summary":"Nagitive Number Of Pending Messages ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-01-24T13:49:20.378+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"When you \"purge\" queue from web admin console, it zeroes queue message\ncounter. But if you have an active consumer at that time which\npre-fetched messages than your consumer will keep sending ack as it\nprocess messages from its buffer. ActiveMQ will keep decrement counter\nupon receiving each ack. So when consumer is done queue will show\nMINUS<consumer buffer size>.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461247","id":"12461247","filename":"Main.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vchekan","name":"vchekan","key":"vchekan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Chekan","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-09-17T07:16:46.988+0000","size":3675,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461247/Main.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461388","id":"12461388","filename":"Picture 6.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmoran","name":"bmoran","key":"bmoran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Moran","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-10T22:10:35.583+0000","size":123479,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12461388/Picture+6.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461132","id":"12461132","filename":"QueuePurgeTest.java.diff.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bsnyder","name":"bsnyder","key":"bsnyder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bruce Snyder","active":true,"timeZone":"America/Denver"},"created":"2008-09-17T14:45:04.096+0000","size":3768,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461132/QueuePurgeTest.java.diff.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161459","customfield_12312823":null,"summary":"Negative queue size (reproducible)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vchekan","name":"vchekan","key":"vchekan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Chekan","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[{"id":"12482854","key":"AMQ-1693","self":"https://issues.apache.org/jira/rest/api/2/issue/12482854","fields":{"summary":"Nagitive Number Of Pending Messages ","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vchekan","name":"vchekan","key":"vchekan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Chekan","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Found on Windows but reproduced under Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12940208","id":"12940208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vchekan","name":"vchekan","key":"vchekan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Chekan","active":true,"timeZone":"America/Los_Angeles"},"body":"Attached program reproduces a queue with -100 messages.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vchekan","name":"vchekan","key":"vchekan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Chekan","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-09-17T07:16:47.244+0000","updated":"2008-09-17T07:16:47.244+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12940244","id":"12940244","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bsnyder","name":"bsnyder","key":"bsnyder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bruce Snyder","active":true,"timeZone":"America/Denver"},"body":"I've created the following test case out of the attached {{Main.java}} class: \n\n{code}\npackage org.apache.activemq.broker.region;\n\nimport javax.jms.Connection;\nimport javax.jms.ConnectionFactory;\nimport javax.jms.JMSException;\nimport javax.jms.Message;\nimport javax.jms.MessageConsumer;\nimport javax.jms.MessageProducer;\nimport javax.jms.Queue;\nimport javax.jms.Session;\nimport javax.jms.TextMessage;\nimport javax.management.MBeanServerInvocationHandler;\nimport javax.management.MalformedObjectNameException;\nimport javax.management.ObjectName;\n\nimport junit.framework.TestCase;\n\nimport org.apache.activemq.ActiveMQConnectionFactory;\nimport org.apache.activemq.broker.BrokerService;\nimport org.apache.activemq.broker.jmx.QueueViewMBean;\n\npublic class QueuePurgeTest extends TestCase {\n    \n    BrokerService broker; \n    ConnectionFactory factory; \n    Connection connection;\n    Session session;\n    Queue queue;\n    MessageConsumer consumer;\n\n    protected void setUp() throws Exception {\n        broker = new BrokerService();\n        broker.setUseJmx(true);\n        broker.setPersistent(false);\n        broker.addConnector(\"tcp://localhost:0\");\n        broker.start();\n        \n        factory = new ActiveMQConnectionFactory(\"vm://localhost\");\n        \n        connection = factory.createConnection();\n        connection.start();\n    }\n\n    protected void tearDown() throws Exception {\n        consumer.close();\n        session.close();\n        connection.stop();\n        connection.close();\n        broker.stop();\n    }\n    \n    public void testPurgeQueueWithActiveConsumer() throws Exception {\n        createProducerAndSendMessages();        \n        QueueViewMBean proxy = getProxyToQueueViewMBean();\n        createConsumer();\n        proxy.purge();\n        assertEquals(\"Queue size is not zero, it's \" + proxy.getQueueSize(), 0, proxy.getQueueSize());\n    }\n\n    private QueueViewMBean getProxyToQueueViewMBean()\n            throws MalformedObjectNameException, JMSException {\n        ObjectName queueViewMBeanName = new ObjectName(\"org.apache.activemq\" + \":Type=Queue,Destination=\" + \n                queue.getQueueName() + \",BrokerName=localhost\");\n        QueueViewMBean proxy = (QueueViewMBean)MBeanServerInvocationHandler.newProxyInstance(\n                broker.getManagementContext().getMBeanServer(), \n                queueViewMBeanName, QueueViewMBean.class, true);\n         \n         return proxy;\n    }\n    \n    private void createProducerAndSendMessages() throws Exception {\n        session =  connection.createSession(false, Session.CLIENT_ACKNOWLEDGE);\n        queue = session.createQueue(\"test1\");\n        MessageProducer producer = session.createProducer(queue);\n        for(int i=0; i<10000; i++) {\n            TextMessage message = session.createTextMessage(\"message \"+i);\n            producer.send(message);\n        }\n        producer.close();\n    }\n    \n    private void createConsumer() throws Exception {\n        consumer = session.createConsumer(queue);\n        // wait for buffer fill out\n        Thread.sleep(5*1000);\n        \n        for(int i = 0; i < 100; ++i) {\n            Message message = consumer.receive();\n            message.acknowledge();\n        }\n    }\n\n}\n{code}\n\nWhat I'm finding is that failure is intermittent, but I am able to see it once in a while: \n\n{panel}\njunit.framework.AssertionFailedError: Queue size is not zero expected:<0> but was:<-60>\n\tat junit.framework.Assert.fail(Assert.java:47)\n\tat junit.framework.Assert.failNotEquals(Assert.java:282)\n\tat junit.framework.Assert.assertEquals(Assert.java:64)\n\tat junit.framework.Assert.assertEquals(Assert.java:136)\n\tat org.apache.activemq.broker.region.QueuePurgeTest.testPurgeQueueWithActiveConsumer(QueuePurgeTest.java:56)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:585)\n\tat junit.framework.TestCase.runTest(TestCase.java:154)\n\tat junit.framework.TestCase.runBare(TestCase.java:127)\n\tat junit.framework.TestResult$1.protect(TestResult.java:106)\n\tat junit.framework.TestResult.runProtected(TestResult.java:124)\n\tat junit.framework.TestResult.run(TestResult.java:109)\n\tat junit.framework.TestCase.run(TestCase.java:118)\n\tat junit.framework.TestSuite.runTest(TestSuite.java:208)\n\tat junit.framework.TestSuite.run(TestSuite.java:203)\n\tat org.eclipse.jdt.internal.junit.runner.junit3.JUnit3TestReference.run(JUnit3TestReference.java:130)\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:460)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:673)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:386)\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:196)\n{panel}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bsnyder","name":"bsnyder","key":"bsnyder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bruce Snyder","active":true,"timeZone":"America/Denver"},"created":"2008-09-17T08:36:16.502+0000","updated":"2008-09-17T08:36:16.502+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12940240","id":"12940240","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vchekan","name":"vchekan","key":"vchekan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Chekan","active":true,"timeZone":"America/Los_Angeles"},"body":"Perhaps it can be made more reproducible if purge is run in a thread parallel to the consumer. I'll try to rewrite it later tonight.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vchekan","name":"vchekan","key":"vchekan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Chekan","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-09-17T17:48:19.942+0000","updated":"2008-09-17T17:48:19.942+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12940201","id":"12940201","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Fixed by SVN revision 697921","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-22T18:15:58.537+0000","updated":"2008-09-22T18:15:58.537+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12940416","id":"12940416","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ghopper","name":"ghopper","key":"ghopper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ghopper&avatarId=15643","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ghopper&avatarId=15643","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ghopper&avatarId=15643","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ghopper&avatarId=15643"},"displayName":"Gordon Hopper","active":true,"timeZone":"Etc/UTC"},"body":"1693 displays the same symptom of negative message counts.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ghopper","name":"ghopper","key":"ghopper","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ghopper&avatarId=15643","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ghopper&avatarId=15643","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ghopper&avatarId=15643","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ghopper&avatarId=15643"},"displayName":"Gordon Hopper","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-04T17:24:51.740+0000","updated":"2008-11-04T17:24:51.740+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12940950","id":"12940950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmoran","name":"bmoran","key":"bmoran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Moran","active":true,"timeZone":"Etc/UTC"},"body":"I can reproduce this in 5.2.0. \nI am going to attach a screenshot.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmoran","name":"bmoran","key":"bmoran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Moran","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-10T22:09:18.956+0000","updated":"2009-03-10T22:09:18.956+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12940944","id":"12940944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmoran","name":"bmoran","key":"bmoran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Moran","active":true,"timeZone":"Etc/UTC"},"body":"Screenshot of negative messages, reproducible in 5.2.0 after purging the message queue, STOMP clients.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bmoran","name":"bmoran","key":"bmoran","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brian Moran","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-10T22:10:35.621+0000","updated":"2009-03-10T22:10:35.621+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12941067","id":"12941067","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deathemperor","name":"deathemperor","key":"deathemperor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Loc Truong","active":true,"timeZone":"Etc/UTC"},"body":"I can reproduct this in 5.2.0. This happens to me because there are too many receivers, each of them try to recevie 500 messages but the total messages in queue is smaller, hence negative number.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deathemperor","name":"deathemperor","key":"deathemperor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Loc Truong","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-27T09:24:47.403+0000","updated":"2009-03-27T09:24:47.403+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12941075","id":"12941075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuriushakov","name":"yuriushakov","key":"yuriushakov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuri Ushakov","active":true,"timeZone":"Etc/UTC"},"body":"We have the same problem with 5.2.0.  A queue, single consumer, single producer.  We have -1 pending now, 1616 sent, 1617 received.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yuriushakov","name":"yuriushakov","key":"yuriushakov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuri Ushakov","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-27T10:37:03.634+0000","updated":"2009-03-27T10:37:03.634+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12941109","id":"12941109","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deathemperor","name":"deathemperor","key":"deathemperor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Loc Truong","active":true,"timeZone":"Etc/UTC"},"body":"I can reproduce this on 5.2.0 too. I have 7 consumers getting 150 messages each. The negative number I receive is -123 at lowest.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deathemperor","name":"deathemperor","key":"deathemperor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Loc Truong","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-02T08:55:13.485+0000","updated":"2009-04-02T08:55:13.485+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12941340","id":"12941340","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wfrag","name":"wfrag","key":"wfrag","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Dubrov","active":true,"timeZone":"America/Los_Angeles"},"body":"I had the same issue today. \n\nWe are running two AMQ brokers in network of brokers, each one talking to the other one (the duplex is set to false). Under a high load after few hours I've noted that one of our queues started growing on both nodes, several thousand of pending messages in about 20 minutes (and the cursor memory usage was quite large). After I accidentally stopped the second node, the network bridge stopped on the first node and the queue size on the first node immediately became \"-8\".\n\nSo in my case this probably somehow related to the instability of network of brokers implementation, because if I disable the network connector the system runs stable for several days under the load.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wfrag","name":"wfrag","key":"wfrag","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ivan Dubrov","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-05-20T04:44:19.674+0000","updated":"2009-05-20T04:44:19.674+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/12941375","id":"12941375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Fixed for the 5.3","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-26T08:51:02.203+0000","updated":"2009-05-26T08:51:02.203+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/13715175","id":"13715175","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hubbitus","name":"hubbitus","key":"hubbitus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pavel","active":true,"timeZone":"Europe/Moscow"},"body":"We seen such issue on 5.6.0 ActiveMQ.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hubbitus","name":"hubbitus","key":"hubbitus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pavel","active":true,"timeZone":"Europe/Moscow"},"created":"2013-07-22T12:50:41.664+0000","updated":"2013-07-22T12:50:41.664+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/14049673","id":"14049673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wschlich","name":"wschlich","key":"wschlich","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wschlich&avatarId=16150","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wschlich&avatarId=16150","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wschlich&avatarId=16150","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wschlich&avatarId=16150"},"displayName":"Wolfram Schlich","active":true,"timeZone":"Europe/Berlin"},"body":"We also experience this currently with ActiveMQ 5.8.0.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wschlich","name":"wschlich","key":"wschlich","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=wschlich&avatarId=16150","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=wschlich&avatarId=16150","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=wschlich&avatarId=16150","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=wschlich&avatarId=16150"},"displayName":"Wolfram Schlich","active":true,"timeZone":"Europe/Berlin"},"created":"2014-07-02T06:56:30.764+0000","updated":"2014-07-02T06:56:30.764+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/14315643","id":"14315643","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cp123","name":"cp123","key":"cp123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey ","active":true,"timeZone":"Europe/Moscow"},"body":"Still have this issue in 5.10.0. Moreover, sometime I can see number of pending messages groving, but if I try to browse queue, I see nothing there. I.e. this numbers are all wrong.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cp123","name":"cp123","key":"cp123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey ","active":true,"timeZone":"Europe/Moscow"},"created":"2015-02-11T06:18:30.468+0000","updated":"2015-02-11T06:18:30.468+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/14316080","id":"14316080","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cp123","name":"cp123","key":"cp123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey ","active":true,"timeZone":"Europe/Moscow"},"body":"What I can see in JMX using Hawtio:\nTotal dequeue count 2474137\nTotal enqueue count 1795563\nTotal message count -678584\n\nBTW, I have camel route within broker, where incoming messages are duplicated in two queues. And, at the moment, web console displays something like:\n\n||queue||pending||enqueued||dequeued||\n|algo250a|856725|906471|1552909|\n|algo250b|-23451|906472|929923|\n|highwayQueue|0|0|\t0|\n\nLast one is inbound queue, algoxxx are outbound. I expect that number of enqueued messages for inbound Q should be equal to number of dequeued. But its always zero.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cp123","name":"cp123","key":"cp123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey ","active":true,"timeZone":"Europe/Moscow"},"created":"2015-02-11T11:32:45.601+0000","updated":"2015-02-11T11:32:45.601+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/14316120","id":"14316120","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@Sergey - can you make a junit test case that can reproduce - peek at the activemq-camel module if you need to use camel routes","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-11T12:06:04.874+0000","updated":"2015-02-11T12:06:04.874+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/14316127","id":"14316127","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cp123","name":"cp123","key":"cp123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey ","active":true,"timeZone":"Europe/Moscow"},"body":"I've just created AMQ-5576, and where is a route test case.\n\nJust deploy this route, and send 1 message into inbound queue using web console, it should be enough to reproduce some of issues with counters/sizes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cp123","name":"cp123","key":"cp123","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergey ","active":true,"timeZone":"Europe/Moscow"},"created":"2015-02-11T12:14:08.863+0000","updated":"2015-02-11T12:14:08.863+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/15830358","id":"15830358","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"I noticed this issue today when doing a purge.  I believe the issue is that after the messages are removed in the do/while loop inside the queue purge method the statistics counter is reset to 0.  This is a problem because there is nothing preventing messages from being added to the Queue in between message removal and resetting of the counters.  This means it's possible to have new messages in the queue but the counter is set to 0 such that the count will now go negative when those messages acked.\n\n[~gtully], I think the fix is as simple as removing two lines of code on line 1267 and 1268.  https://github.com/apache/activemq/blob/activemq-5.14.3/activemq-broker/src/main/java/org/apache/activemq/broker/region/Queue.java#L1267\n\nI don't see any reason why we should need to reset the messages cursor or the messages statistics counter to 0 at the end if the purge behaves properly as the counter should already be properly decremented when each message is dropped.  What do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-01-19T18:14:13.854+0000","updated":"2017-01-19T18:14:13.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/15831541","id":"15831541","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"[~cshannon] that is interesting.. I agree, setting to zero does seem wrong.  Also, I think it makes sense to sync some more such that both sending and dispatch is locked out.\nSeems there two issues: \n 1) the concurrent send issue\n 2) removing messages that may be dispatched and the ack doing a double decrement\n\nfor 1) locking is the answer\nfor 2) locking and then a) ensuring that an ack does not decrement if the message cannot be found or b) purge ignoring inflight messages or c) ensuring the stat cannot go negative. \n\n2b may be the cleanest but may be difficult to implement, on balance maybe go for 2a. 2c would potentially hide later problems \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-20T10:57:14.163+0000","updated":"2017-01-20T10:57:14.163+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/15831571","id":"15831571","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~gtully], Thanks for the feedback.  I was going to try for option 2a) (and possibly 2b) initially because it seems like some of that work might have already been done over the years to prevent handling acks for messages that don't exist.  I will check the ack handling to verify and see what changes are needed.\n\nIn terms of locking I thought about this but was concerned about it being a bit slow if the purge took a long time.  My initial thought was to just grab a write lock on the pagedInMessagesLock for the entire purge() method and release when purge is done.  This should prevent new messages from being sent to the Queue.  Off the top of my head I don't remember if that is sufficient for preventing dispatch or if we need to grab another lock such as the messages lock or pagedInPendingDispatchLock. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-01-20T11:30:27.758+0000","updated":"2017-01-20T11:31:15.157+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/15831728","id":"15831728","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I don't think perf is a problem with the purge operation. an all out destination pause is sensible to maintain consistent state. I think purge needs to take  the sendLock and pagedInPendingDispatchLock. It is like purge a snapshot. Inflight sends can still be inflight. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-20T13:12:34.342+0000","updated":"2017-01-20T13:12:34.342+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/15831736","id":"15831736","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Makes sense, I don't think I'll get a chance today but hopefully Monday I'll take a look at a patch for this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-01-20T13:27:40.722+0000","updated":"2017-01-20T13:27:40.722+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/15835130","id":"15835130","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~gtully], I don't think we need to do anything here other than to grab the sendLock to prevent new messages from coming in while the purge is running and works its way through all the pending messages in the queue including already dispatched messages (we can also remove the line of code that sets the count to 0 which isn't necessary)\n\nFor messages that are already dispatched we don't seem to need to worry about the ack doing a double decrement.  If the Queue has been purged and the already dispatched messages are acked later the metrics don't double decrement because in dropMessage() there is a dropIfLive() check that will fail.  This scenario is already shown if you look at QueuePurgeTest and run testPurgeLargeQueueWithConsumer.  This test shows that after a purge if the consumer acks the messages already in prefetch the messages count doesn't go negative.\n\nI suppose an argument could be made that we should clear out the dispatch list in each subscription to save memory but then if messages are acked we'd get a bunch of unmatched acknowledge warnings in the log because assertAckMatchesDispatched() in PrefetchSubscription would throw a bunch of exceptions when the acks came in.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-01-23T19:53:09.761+0000","updated":"2017-01-23T19:53:09.761+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/15836148","id":"15836148","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 56bb079c8227a2beee609b205c001d66597db98a in activemq's branch refs/heads/master from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=56bb079 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-1940\n\nQueue purge now acquires the sendLock to prevent new messages from\ncoming in while purging.  The statistics are no longer zeroed out as\nthey should properly decrement as messages are removed.  These changes\nshould prevent the statistics from going negative.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-24T13:48:20.546+0000","updated":"2017-01-24T13:48:20.546+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482508/comment/15836149","id":"15836149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 1811d191afa91d15e6a37d13dbfd7fd8ef32690e in activemq's branch refs/heads/activemq-5.14.x from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=1811d19 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-1940\n\nQueue purge now acquires the sendLock to prevent new messages from\ncoming in while purging.  The statistics are no longer zeroed out as\nthey should properly decrement as messages are removed.  These changes\nshould prevent the statistics from going negative.\n\n(cherry picked from commit 56bb079c8227a2beee609b205c001d66597db98a)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-01-24T13:48:35.803+0000","updated":"2017-01-24T13:48:35.803+0000"}],"maxResults":26,"total":26,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1940/votes","votes":5,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rzw7:"}}