{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483869","self":"https://issues.apache.org/jira/rest/api/2/issue/12483869","key":"AMQ-3027","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315630","id":"12315630","description":"Issues that need to be reviewed - do we keep 'em or do we kick 'em? ","name":"NEEDS_REVIEW","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-12-16T16:28:41.730+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Dec 16 16:28:41 UTC 2015","customfield_12310420":"74746","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3027/watchers","watchCount":3,"isWatching":false},"created":"2010-11-10T19:56:53.792+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315624","id":"12315624","description":"Maintenance release for 5.4.0","name":"5.4.1","archived":false,"released":true,"releaseDate":"2010-09-21"}],"issuelinks":[{"id":"12452135","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12452135","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12483576","key":"AMQ-2106","self":"https://issues.apache.org/jira/rest/api/2/issue/12483576","fields":{"summary":"Allow broker to evenly distribute message groups among consumers","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype","name":"New Feature","subtask":false,"avatarId":21141}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-12-16T16:30:40.612+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"I am using message groups with ActiveMQ 5.4.1 and when ending the group I'm seeing some odd behavior.  \n\nI run two consumers on Queue A.  There is a 200ms delay when processing a message.  I have a producer send 500 messages with group A to the broker with the last having a group sequence of -1.  The first consumer starts processing messages from group A while the producer is creating the messages, but as soon as the broker gets the message with group sequence of -1 that message gets sent to the second consumer, and then the remaining in the group go to the second consumer.  So the processing is out of order and all the messages don't go to the same consumer.  \n\nI believe only messages created after the one with group sequence of -1 should go to the second consumer.  And the message with -1 sequence gets processed last.   Should this also be the case if the master broker fails over during this time?\n\nIssue AMQ-2952 does not appear to be the same issue.  Unfortunately I do not have time to test this against the current snapshot or include a test case.  The scenario, however, is very simple and I'm sure it would be easy to whip up an example.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"81503","customfield_12312823":null,"summary":"Message Groups and Group Sequence -1 sending messages in group to multiple consumers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=magellings","name":"magellings","key":"magellings","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Gellings","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=magellings","name":"magellings","key":"magellings","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Gellings","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows Server 2008 for broker, Windows 7 for clients, NMS","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483869/comment/15060246","id":"15060246","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smil","name":"smil","key":"smil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tamas Cserveny","active":true,"timeZone":"Etc/UTC"},"body":"I can confirm that the issue exists on the latest version. The problem is very likely that the following code in Queue.java:\n\n{code:java}\nprotected boolean assignMessageGroup(Subscription subscription, QueueMessageReference node) throws Exception {\n~~~\n                    if (groupOwner.equals(subscription.getConsumerInfo().getConsumerId())) {\n                        // A group sequence < 1 is an end of group signal.\n                        if (sequence < 0) {\n                            messageGroupOwners.removeGroup(groupId);\n                            subscription.getConsumerInfo().decrementAssignedGroupCount();\n                        }\n                    } else {\n                        result = false;\n                    }\n{code}\n\n... closes the assignment instantly so the next message will go to another group even if this message did not yet dispatched/ACK-ed. \nClosing should be done by the ACK on the message, not in case of assignment.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=smil","name":"smil","key":"smil","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tamas Cserveny","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-16T16:28:41.730+0000","updated":"2015-12-16T16:28:41.730+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3027/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0eaqv:"}}