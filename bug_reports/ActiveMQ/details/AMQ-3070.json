{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12492056","self":"https://issues.apache.org/jira/rest/api/2/issue/12492056","key":"AMQ-3070","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-07-11T19:56:58.610+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 19 14:55:30 UTC 2012","customfield_12310420":"60059","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_18983178486_*|*_6_*:*_2_*:*_6101950737_*|*_4_*:*_1_*:*_325490","customfield_12312321":null,"resolutiondate":"2011-09-20T11:01:34.857+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3070/watchers","watchCount":2,"isWatching":false},"created":"2010-12-04T02:50:40.159+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315625","id":"12315625","description":"","name":"5.4.2","archived":false,"released":true,"releaseDate":"2010-12-02"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-09-19T14:55:30.804+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Discovered while authoring a custom SubscriptionRecoveryPolicy.\n\nWhen function 'recover' is being run, no new connections to the broker can be made.  All connection attempts hang until 'recover' returns.\n\nThis is a huge problem when recovery takes any amount of time.  In my particular case, recovery can take many minutes.\n\nNote that this problem also prevents the addition/removal of consumers and producers in general, so any threads needing to do so are also blocked.\n\nThe issue appears to be a lock on RegionBroker.purgeInactiveDestinationsTask.  I would attempt to fix, but I am unsure of the consequences of messing with this lock and I am unclear on what is being protected here.\n\nThread doing work in \"recover\":\n\n\n    \"ActiveMQ Transport: ssl:///10.1.210.140:45407\" - Thread t@48\n        at MyCustomSubscriptionRecoveryPolicy.recover(MyCustomSubscriptionRecoveryPolicy.java:xxx)\n        at org.apache.activemq.broker.region.Topic.addSubscription(Topic.java:133)\n        at org.apache.activemq.broker.region.AbstractRegion.addConsumer(AbstractRegion.java:290)\n        - locked java.lang.Object@62f4a9a3\n        at org.apache.activemq.broker.region.TopicRegion.addConsumer(TopicRegion.java:111)\n        at org.apache.activemq.broker.region.RegionBroker.addConsumer(RegionBroker.java:447)\n        - locked org.apache.activemq.broker.region.RegionBroker$1@6d0718b7\n        at org.apache.activemq.broker.jmx.ManagedRegionBroker.addConsumer(ManagedRegionBroker.java:240)\n        at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:89)\n        at org.apache.activemq.advisory.AdvisoryBroker.addConsumer(AdvisoryBroker.java:91)\n        at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:89)\n        at org.apache.activemq.broker.BrokerFilter.addConsumer(BrokerFilter.java:89)\n        at org.apache.activemq.broker.MutableBrokerFilter.addConsumer(MutableBrokerFilter.java:95)\n        at org.apache.activemq.broker.TransportConnection.processAddConsumer(TransportConnection.java:550)\n        at org.apache.activemq.command.ConsumerInfo.visit(ConsumerInfo.java:349)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:311)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:228)\n        - locked org.apache.activemq.transport.InactivityMonitor$1@2208d444\n        at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:81)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.sendToActiveMQ(ProtocolConverter.java:140)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompSubscribe(ProtocolConverter.java:425)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:188)\n        at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:70)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n        at org.apache.activemq.transport.tcp.SslTransport.doConsume(SslTransport.java:91)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:220)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:202)\n        at java.lang.Thread.run(Thread.java:619)\n\n    Locked ownable synchronizers:\n    - None\n\n\nThread attempting to make new connection:\n\n    \"ActiveMQ Transport: ssl:///10.1.210.140:45408\" - Thread t@55\n     java.lang.Thread.State: BLOCKED on org.apache.activemq.broker.region.RegionBroker$1@6d0718b7 owned by: ActiveMQ Transport: ssl:///10.1.210.140:45407 \n        at org.apache.activemq.broker.region.RegionBroker.addProducer(RegionBroker.java:392)\n        at org.apache.activemq.broker.BrokerFilter.addProducer(BrokerFilter.java:93)\n        at org.apache.activemq.advisory.AdvisoryBroker.addProducer(AdvisoryBroker.java:145)\n        at org.apache.activemq.broker.CompositeDestinationBroker.addProducer(CompositeDestinationBroker.java:56)\n        at org.apache.activemq.broker.BrokerFilter.addProducer(BrokerFilter.java:93)\n        at org.apache.activemq.broker.MutableBrokerFilter.addProducer(MutableBrokerFilter.java:99)\n        at org.apache.activemq.broker.TransportConnection.processAddProducer(TransportConnection.java:511)\n        at org.apache.activemq.command.ProducerInfo.visit(ProducerInfo.java:105)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:311)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:228)\n        - locked org.apache.activemq.transport.InactivityMonitor$1@53134610\n        at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:81)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.sendToActiveMQ(ProtocolConverter.java:140)\n        at org.apache.activemq.transport.stomp.ProtocolConverter$2.onResponse(ProtocolConverter.java:518)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.onActiveMQCommand(ProtocolConverter.java:579)\n        at org.apache.activemq.transport.stomp.StompTransportFilter.oneway(StompTransportFilter.java:58)\n        at org.apache.activemq.transport.InactivityMonitor.oneway(InactivityMonitor.java:255)\n        - locked java.util.concurrent.atomic.AtomicBoolean@165cef0c\n        at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40)\n        - locked java.lang.Object@2f52084c\n        at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1249)\n        at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:810)\n        at org.apache.activemq.broker.TransportConnection.dispatchSync(TransportConnection.java:770)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:187)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:228)\n        - locked org.apache.activemq.transport.InactivityMonitor$1@53134610\n        at org.apache.activemq.transport.stomp.StompTransportFilter.sendToActiveMQ(StompTransportFilter.java:81)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.sendToActiveMQ(ProtocolConverter.java:140)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompConnect(ProtocolConverter.java:503)\n        at org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:192)\n        at org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:70)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n        at org.apache.activemq.transport.tcp.SslTransport.doConsume(SslTransport.java:91)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:220)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:202)\n        at java.lang.Thread.run(Thread.java:619)\n\n    Locked ownable synchronizers:\n        - None\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59018","customfield_12312823":null,"summary":"New clients unable to connect to broker while SubscriptionRecoveryPolicy is running","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asussman","name":"asussman","key":"asussman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Sussman","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asussman","name":"asussman","key":"asussman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Sussman","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12492056/comment/12966783","id":"12966783","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asussman","name":"asussman","key":"asussman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Sussman","active":true,"timeZone":"Etc/UTC"},"body":"Note that the apparent inability to complete a connection happens because most\nclient libs attempt to subscribe to advisory messaging by default, so the connection\nappears to hang.\n\nBut event if advisory message watching is disabled, the new connection (and any existing\nconnections) can't create new subscriptions or become new producers while the lock is\nactive.  So still bad.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=asussman","name":"asussman","key":"asussman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Sussman","active":true,"timeZone":"Etc/UTC"},"created":"2010-12-04T03:01:36.056+0000","updated":"2010-12-04T03:01:36.056+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12492056/comment/13063497","id":"13063497","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"You can now control the number of destinations that are purged in a single GC sweep.  See AMQ-3339.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-07-11T19:56:58.610+0000","updated":"2011-07-11T19:56:58.610+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12492056/comment/13108513","id":"13108513","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"reopen to set fix version to 5.6","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-20T10:56:09.366+0000","updated":"2011-09-20T10:56:09.366+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12492056/comment/13108554","id":"13108554","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"closing again with correct fix version","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2011-09-20T11:01:34.863+0000","updated":"2011-09-20T11:01:34.863+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12492056/comment/13458728","id":"13458728","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@Tim, I am thinking that this is a partial fix, if a recover operaton takes a long time, there will still be the lock out. The real fix is to change the way we do recovery. what do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-09-19T14:49:00.963+0000","updated":"2012-09-19T14:49:00.963+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12492056/comment/13458731","id":"13458731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"a real fix for this is not trivial, if we want to support a large backlog, then we need to deal with order and possible additions while dispatching batches of the backlog.\nDispatch should be async in any event.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-09-19T14:55:30.804+0000","updated":"2012-09-19T14:55:30.804+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3070/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0agxz:"}}