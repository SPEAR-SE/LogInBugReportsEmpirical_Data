{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12825929","self":"https://issues.apache.org/jira/rest/api/2/issue/12825929","key":"AMQ-5752","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-04-30T11:28:06.532+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jun 20 09:29:02 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5752/watchers","watchCount":5,"isWatching":false},"created":"2015-04-29T12:26:59.650+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329382","id":"12329382","name":"5.11.1","archived":false,"released":true,"releaseDate":"2015-02-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-06-20T09:29:02.961+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When moving a message with web console (clicking message, select target queue and press move) the message get's lost.\n\nThe following message is found in the ActiveMQ log. It's wierd since a move should not trigger a duplicate error since the message should be moved.\n\n` INFO | Moving message FROM(ID:petters-mbp.got.vgregion.se-65058-1430309626002-5:1:1:1:1) to TO\n WARN | org.apache.activemq.broker.region.cursors.QueueStorePrefetch@42db79bc:TO,batchResetNeeded=false,size=0,cacheEnabled=true,maxBatchSize:1,hasSpace:true,pendingCachedIds.size:1,lastSyncCachedId:null,lastSyncCachedId-seq:null,lastAsyncCachedId:null,lastAsyncCachedId-seq:null,store=permits:9999,sd=nextSeq:3,lastRet:MessageOrderCursor:[def:0, low:0, high:0],pending:0 - cursor got duplicate send ID:petters-mbp.got.vgregion.se-65058-1430309626002-5:1:1:1:1 seq: org.apache.activemq.store.kahadb.KahaDBStore$StoreQueueTask$InnerFutureTask@38864035\n WARN | Duplicate message add attempt rejected. Destination: QUEUE://TO, Message id: ID:petters-mbp.got.vgregion.se-65058-1430309626002-5:1:1:1:1`\n\n\nThe same problem goes for \"copy\". But, the original message does not get deleted. The error in the log is similar:\n\n`INFO | FROM(ID:petters-mbp.got.vgregion.se-65058-1430309626002-5:1:1:1:1) copy to TO\n WARN | org.apache.activemq.broker.region.cursors.QueueStorePrefetch@42db79bc:TO,batchResetNeeded=false,size=0,cacheEnabled=true,maxBatchSize:1,hasSpace:true,pendingCachedIds.size:1,lastSyncCachedId:null,lastSyncCachedId-seq:null,lastAsyncCachedId:null,lastAsyncCachedId-seq:null,store=permits:9999,sd=nextSeq:1,lastRet:MessageOrderCursor:[def:0, low:0, high:0],pending:0 - cursor got duplicate send ID:petters-mbp.got.vgregion.se-65058-1430309626002-5:1:1:1:1 seq: org.apache.activemq.store.kahadb.KahaDBStore$StoreQueueTask$InnerFutureTask@571547ee\n WARN | Duplicate message add attempt rejected. Destination: QUEUE://TO, Message id: ID:petters-mbp.got.vgregion.se-65058-1430309626002-5:1:1:1:1`\n\n\nThe problem with move is a bit critical since it can cause loss of important data.\n\nVerified in AMQ 5.11.0 and 5.11.1","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Move and copy message does not work in web console","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=northlander","name":"northlander","key":"northlander","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petter Nordlander","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=northlander","name":"northlander","key":"northlander","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petter Nordlander","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12825929/comment/14521347","id":"14521347","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"would it be possible to validate a 5.12 snapshot? \nI did a sanity check on the unit test - org.apache.activemq.broker.jmx.MBeanTest#testMoveMessages with kahadb (it used the memory store) and it works as expected.\nI wonder how your scenario is different from the unit test\n\nhttps://github.com/apache/activemq/blob/ad39fc00fbd9556deac2b7ed3646dae598c00125/activemq-unit-tests/src/test/java/org/apache/activemq/broker/jmx/MBeanTest.java#L121","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-30T11:28:06.532+0000","updated":"2015-04-30T11:28:06.532+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12825929/comment/14521370","id":"14521370","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=northlander","name":"northlander","key":"northlander","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petter Nordlander","active":true,"timeZone":"Etc/UTC"},"body":"Gave apache-activemq-5.12-20150429.222352-120 a test run. Simply downloaded the snapshot build and run \"bin/activemq console\", so no special config.\n\nIt seems that \"copy\" works as intended (did not in 5.11). However, move does not (console output below). The message get removed. I tried with both web console and JMX moveMessageTo(messageId,destinationName) - same result. So this seems not to be an issue isolated in the web console.\n\nIt only affects persistent messages. Non persistent message are possible to move. Can it be that the test case uses a simplified persistence model, since it uses the memory store?\n\nThe behavior is verified on both Linux and Mac.\n\n INFO | FROM(ID:petters-mbp.got.vgregion.se-58859-1430393889647-3:1:1:1:1) copy to TO\n INFO | Moving message FROM(ID:petters-mbp.got.vgregion.se-58859-1430393889647-3:1:1:1:1) to TO\n WARN | org.apache.activemq.broker.region.cursors.QueueStorePrefetch@5a87a7f9:TO,batchResetNeeded=false,size=0,cacheEnabled=true,maxBatchSize:1,hasSpace:true,pendingCachedIds.size:1,lastSyncCachedId:null,lastSyncCachedId-seq:null,lastAsyncCachedId:null,lastAsyncCachedId-seq:null,store=permits:9999,sd=nextSeq:1,lastRet:MessageOrderCursor:[def:0, low:0, high:0],pending:0 - cursor got duplicate send ID:petters-mbp.got.vgregion.se-58859-1430393889647-3:1:1:1:1 seq: org.apache.activemq.store.kahadb.KahaDBStore$StoreQueueTask$InnerFutureTask@24fade\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=northlander","name":"northlander","key":"northlander","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petter Nordlander","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-30T11:52:40.617+0000","updated":"2015-04-30T11:52:40.617+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12825929/comment/14521447","id":"14521447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"interesting. I flipped the bit in the unit test to enable persistence and, it is still good.\n\nbut from the output of the log messages above, I think this is expected to some extent.\n\nThe copy takes a message and then the move takes the same message. So it is the same message id. It makes sense to suppress the second insert/send.\nIt is possible to disable the cursor audit - policyEntry enableAudit=false but it looks like it is doing its job in this instance.\nIt is broken that the move results in the message being deleted though. That is a bug I think.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-30T12:57:09.818+0000","updated":"2015-04-30T13:04:17.484+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12825929/comment/14521535","id":"14521535","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=northlander","name":"northlander","key":"northlander","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petter Nordlander","active":true,"timeZone":"Etc/UTC"},"body":"I also run that test (master branch) with persistence turned on and it does not replicate the issue with move. I'm not sure exactly what is the difference in the test setup and the standard activemq.xml configuration as it seems to be somewhat similar.\n\nAnd I agree that move method deleting the message seems like a bug (to my use case, it's rather nasty).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=northlander","name":"northlander","key":"northlander","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Petter Nordlander","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-30T14:07:50.858+0000","updated":"2015-04-30T14:07:50.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12825929/comment/14521648","id":"14521648","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I pushed a test that shows the nasty behaviour[1] the fix is not obvious because it points to a short fall in how we deal with duplicate sends, the store may or may not track them and the cursor may or may not be able to so at the moment a send call will not fail on a duplicate send, it has to throw an exception b/c there is currently no return state from queue.send but it will take some thought to figure out where best to deal with this.\n\nhttp://git-wip-us.apache.org/repos/asf/activemq/commit/82200b6e","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-30T15:23:44.456+0000","updated":"2015-04-30T15:23:44.456+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12825929/comment/15339232","id":"15339232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=isral1","name":"isral1","key":"isral1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Israel Alvarez","active":true,"timeZone":"Europe/Stockholm"},"body":"I have tested with 5.13.3 on Windows and I could not reproduce it. I think it is solved","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=isral1","name":"isral1","key":"isral1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Israel Alvarez","active":true,"timeZone":"Europe/Stockholm"},"created":"2016-06-20T09:29:02.961+0000","updated":"2016-06-20T09:29:02.961+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5752/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2e2sn:"}}