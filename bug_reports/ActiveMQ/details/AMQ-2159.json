{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482827","self":"https://issues.apache.org/jira/rest/api/2/issue/12482827","key":"AMQ-2159","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-03-13T16:28:08.152+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 09 13:50:43 UTC 2009","customfield_12310420":"75048","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_15635491027_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-09-09T13:50:43.073+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2159/watchers","watchCount":2,"isWatching":false},"created":"2009-03-12T14:39:12.046+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-09-09T13:50:43.058+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"A problem in message eviction seems to cause a strange behavior of message delivery. After a slow consumer consumed it's prefetched messages, it start receiving one message out of two that were produced. When stepping into the sources I noticed that one message evicted out of two is dispatched to the destination even if no message have been consumed during that time. The problem seems to be in the class 'TopicSubscription'. This is what I found:\n\n- When a message is discarded dequeueCounter is incremented. \n- Then next time a message arrives it is evicted then dispatchMatched is called. \n- Because dequeueCounter have been called without any message dispatched, isFull() return false. \n- As a result it assumes there is an empty room in the prefetch and dispatch the message. \n\nThe following example show what I expect against what I get when I produce 100 messages with a unique ID then consume 10 message and output the message ID. Prefetch size is 5. and constantPendingMessageLimitStrategy limit=\"5\"\n\nExpected:\n0, 1, 2, 3, 4, 95, 96, 97, 98, 99\n\nWhat I really get\n 0, 1, 2, 3, 4, 5, 7, 9, 11, 13\n\nI made a test application and a unit test, I didn't found how to attach it to the issue.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461400","id":"12461400","filename":"testActiveMQ.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T16:52:22.527+0000","size":4637,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461400/testActiveMQ.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161839","customfield_12312823":null,"summary":"One evicted message out of two is delivered to the consumer","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows Xp, Java 5, ActiveMQ 5.2","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482827/comment/12940975","id":"12940975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"body":"This is the test application & unit test\n-You can start the application by executing class \"Application\"\n-You can run the unit test by running jUnit4 on \"TestMessageEviction\"\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-12T14:44:59.216+0000","updated":"2009-03-12T14:44:59.216+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482827/comment/12940948","id":"12940948","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"body":"Fix activemq.xml","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-12T15:03:22.978+0000","updated":"2009-03-12T15:03:22.978+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482827/comment/12940995","id":"12940995","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Yannick, thanks for the test case. Could you reattach (delete and attach again) it to the issue with a license grant. There is a check box on the Attach file page. Otherwise we can't include your test case. Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T16:28:08.152+0000","updated":"2009-03-13T16:28:08.152+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482827/comment/12940980","id":"12940980","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"body":"Add the test with the granted license","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T16:52:22.575+0000","updated":"2009-03-13T16:52:22.575+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482827/comment/12940987","id":"12940987","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=elihusmails","name":"elihusmails","key":"elihusmails","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Webb","active":true,"timeZone":"Etc/UTC"},"body":"I was tracking down a similar problem.  If you run this code in YourKit, capture a memory snapshot and look at the instance of ActiveMQMessageConsumer, you will see that the unconsumedMessages list size never decreases.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=elihusmails","name":"elihusmails","key":"elihusmails","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mark Webb","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T20:33:22.551+0000","updated":"2009-03-13T20:33:22.551+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482827/comment/12940986","id":"12940986","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"body":"We also discovered this problem because we were running out of memory even if a Message Limit Strategy was activated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yenki","name":"yenki","key":"yenki","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yannick","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-14T16:13:21.232+0000","updated":"2009-03-14T16:13:21.232+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482827/comment/12941114","id":"12941114","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Ran test case against 5.3 - works as expected","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2009-09-09T13:50:43.017+0000","updated":"2009-09-09T13:50:43.017+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2159/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s28n:"}}