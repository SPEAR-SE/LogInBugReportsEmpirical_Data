{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482194","self":"https://issues.apache.org/jira/rest/api/2/issue/12482194","key":"AMQ-1979","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-10-15T14:20:17.410+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 06 10:47:07 UTC 2008","customfield_12310420":"75140","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_259579316_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-10-17T13:02:56.433+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1979/watchers","watchCount":0,"isWatching":false},"created":"2008-10-14T12:56:37.117+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-11-06T10:47:07.753+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Maybe not the most logical client code, but it happened here and I guess it will happen somewhere again:\n\n  TemporaryQueue reply = session.createTemporaryQueue();      \t\n  MessageConsumer consumer = session.createConsumer(reply);\n  Message received = consumer.receive(timeout);\n  ...\n  reply.delete();\n  consumer.close();\n\nI've removed try/finally blocks to keep it simple.\n\nSee the attached source code.\n\nIt works fine, but set \n\n  JmsMessageHandler.REVERSE_ORDER=true\n\nand the slave will not be cleaned up properly.\n\nIt means that the number of threads is increasing and at some time it will get an OutOfMemoryError (see AMQ-1849) and the slave dies.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461154","id":"12461154","filename":"ASF.LICENSE.NOT.GRANTED--activemqjee-0.0.6-src.tar.gz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-14T12:56:37.120+0000","size":8053,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12461154/ASF.LICENSE.NOT.GRANTED--activemqjee-0.0.6-src.tar.gz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"114348","customfield_12312823":null,"summary":"Temporary queue on slave not removed in Pure Master/Slave setup","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"subtasks":[{"id":"12482689","key":"AMQ-1849","self":"https://issues.apache.org/jira/rest/api/2/issue/12482689","fields":{"summary":"Slave threads increasing when sending to temporary queue","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482194/comment/12940375","id":"12940375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"not sure about the validity of the test case here. I tried to reproduce using an existing test case and I get an exception because the temp destination is in use till the consumer is closed. so it is not possible to delete before the close; can you concur.\nI see an exception in your test case also. In the exception case, the temp destination is not deleted at all!\n\nsee the simple code mod to TempQueueMemoryTest:\n{code}\nIndex: activemq-core/src/test/java/org/apache/activemq/advisory/TempQueueMemoryTest.java\n===================================================================\n--- activemq-core/src/test/java/org/apache/activemq/advisory/TempQueueMemoryTest.java\t(revision 704890)\n+++ activemq-core/src/test/java/org/apache/activemq/advisory/TempQueueMemoryTest.java\t(working copy)\n@@ -37,7 +37,7 @@\n     protected Connection clientConnection;\n     protected Session clientSession;\n     protected Destination serverDestination;\n-    protected static final int COUNT = 2000;\n+    protected static final int COUNT = 1; // 2000\n \n     public void testLoadRequestReply() throws Exception {\n         MessageConsumer serverConsumer = serverSession.createConsumer(serverDestination);\n@@ -63,8 +63,9 @@\n             msg.setJMSReplyTo(replyTo);\n             producer.send(msg);\n             Message reply = consumer.receive();\n+            //consumer.close();\n+            replyTo.delete();\n             consumer.close();\n-            replyTo.delete();\n         }\n         \n         clientSession.close();\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-15T14:20:17.410+0000","updated":"2008-10-15T14:20:17.410+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482194/comment/12940361","id":"12940361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"exception from your test case:\n{code}\n2008-10-15 15:16:10,551 [MQ Session Task] ERROR JmsMessageHandler              - Failed to delete reply queue ID:gtullyd810-51430-1224080169714-3:2:1\njavax.jms.JMSException: A consumer is consuming from the temporary destination\n\tat org.apache.activemq.ActiveMQConnection.deleteTempDestination(ActiveMQConnection.java:1869)\n\tat org.apache.activemq.command.ActiveMQTempDestination.delete(ActiveMQTempDestination.java:51)\n\tat org.activemq.jms.JmsMessageHandler.forwardToNext(JmsMessageHandler.java:236)\n\tat org.activemq.jms.JmsMessageHandler.onMessage(JmsMessageHandler.java:167)\n\tat org.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:1021)\n\tat org.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:122)\n\tat org.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:192)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)\n\tat java.lang.Thread.run(Thread.java:595)\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-15T14:22:15.122+0000","updated":"2008-10-15T14:22:15.122+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482194/comment/12940362","id":"12940362","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"Maybe it's removed later by some other cleanup method?\n\nThe application, where I've found it is running in JBoss and I suppose JBoss keeps the open connection in a pool, so then the temporary destinations are not removed.\n\nProblem is that it causes a difference between the master and the slave: on the master the queue is removed, but on the slave it still exists.\nI can reproduce that with this code.\n\nI don't have a problem with this issue anymore, because I've fixed our client code, but I suppose the same error will be made again and will keep causing headaches. (it was worse in our case, because the exception on the failing delete attempt was not logged)\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-15T14:34:06.248+0000","updated":"2008-10-15T14:34:06.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482194/comment/12940348","id":"12940348","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"Remove the \"reply.delete()\" code entirely. It indeed does not matter.\n\nThe issue is that the TemporaryQueue is removed in the Master and not in the Slave.\n\nIf it would not be removed in the Master (until the Connection is closed) that would be okay.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-16T16:39:10.488+0000","updated":"2008-10-16T16:39:10.488+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482194/comment/12940370","id":"12940370","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolved in 705592.\nSlave connection now knows about temp destinations so it can delete on close rather than just on an explicit delete command. It now behaves like the master in the absence of a tempDestination.delete call.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-10-17T13:02:56.386+0000","updated":"2008-10-17T13:02:56.386+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482194/comment/12940468","id":"12940468","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"These fixes will now make 5.2.0 rc3","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-06T10:47:07.752+0000","updated":"2008-11-06T10:47:07.752+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1979/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0jxfz:"}}