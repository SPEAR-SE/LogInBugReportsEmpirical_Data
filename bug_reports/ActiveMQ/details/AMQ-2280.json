{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483075","self":"https://issues.apache.org/jira/rest/api/2/issue/12483075","key":"AMQ-2280","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-07-14T20:33:42.985+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 07 09:20:28 UTC 2009","customfield_12310420":"74998","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_5512072829_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-08-07T09:20:28.153+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2280/watchers","watchCount":1,"isWatching":false},"created":"2009-06-04T14:12:35.324+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-08-07T09:20:28.124+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313893","id":"12313893","name":"Connector"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"\nThis does not happen in 5.2.0, only in 5.3..SNAPSHOT \n\nI'm getting the above exception with the following STOMP session\n\n\n> telnet localhost 61613\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nCONNECT\npasscode:password\nlogin:login\n\n^@\nCONNECTED\nsession:ID:alex-60773-1244124360289-2:2\n\n\nSUBSCRIBE\nactivemq.prefetchSize:1\nack:client\ndestination:/queue/COMMAND.HOST.alex\nactivemq.exclusive:true\n\n^@\nBEGIN\ndestination:/queue/COMMANDREPLY.HOST.alex\ntransaction:ID:alex-58262-1244123488785-2:1-1\npersistent:true\n\n^@\nSEND\ndestination:/queue/COMMANDREPLY.HOST.alex\ntransaction:ID:alex-58262-1244123488785-2:1-1\nreceipt:ID:alex-58262-1244123488785-2:1-2\npersistent:true\n\nreplytext\n^@\nRECEIPT\nreceipt-id:ID:alex-58262-1244123488785-2:1-2\n\n\nCOMMIT\ndestination:/queue/COMMANDREPLY.HOST.alex\ntransaction:ID:alex-58262-1244123488785-2:1-1\n\n^@\nConnection closed by foreign host.\n\n\nat this point AMQ closses the TCP connection and I see the following in the log (DEBUG root log level):\n\nDEBUG TransportConnection            - Setting up new connection: /127.0.0.1:44692\nDEBUG AMQPersistenceAdapter          - dataFilesInProgress.values: (0) []\nDEBUG AMQPersistenceAdapter          - lastDataFile: 1\nDEBUG AsyncDataManager               - lastFileId=0, purgeList: (0) []\nDEBUG AbstractRegion                 - localhost adding consumer: ID:alex-60773-1244124360289-2:2:-1:1 for destination: queue://COMMAND.HOST.alex\nDEBUG AMQPersistenceAdapter          - Checkpoint started.\nDEBUG AMQPersistenceAdapter          - Checkpoint done.\nDEBUG AMQPersistenceAdapter          - Checkpoint started.\nDEBUG AMQPersistenceAdapter          - Checkpoint done.\nDEBUG AMQPersistenceAdapter          - dataFilesInProgress.values: (0) []\nDEBUG AMQPersistenceAdapter          - lastDataFile: 1\nDEBUG AsyncDataManager               - lastFileId=0, purgeList: (0) []\nDEBUG AMQPersistenceAdapter          - Checkpoint started.\nDEBUG AMQPersistenceAdapter          - Checkpoint done.\nDEBUG AMQMessageStore                - Journalled transacted message add for: ID:alex-60773-1244124360289-2:2:-1:1:1, at: offset = 10973, file = 1, size = 375, type = 1\nDEBUG AMQPersistenceAdapter          - dataFilesInProgress.values: (0) []\nDEBUG AMQPersistenceAdapter          - lastDataFile: 1\nDEBUG AsyncDataManager               - lastFileId=0, purgeList: (0) []\nDEBUG AMQPersistenceAdapter          - Checkpoint started.\nDEBUG AMQPersistenceAdapter          - Checkpoint done.\nDEBUG Transport                      - Transport failed: java.io.IOException: Unexpected error occured\njava.io.IOException: Unexpected error occured\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:192)\n\tat java.lang.Thread.run(Thread.java:619)\nCaused by: java.util.NoSuchElementException\n\tat java.util.LinkedList.getFirst(LinkedList.java:109)\n\tat org.apache.activemq.transport.stomp.StompSubscription.onStompCommit(StompSubscription.java:130)\n\tat org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommit(ProtocolConverter.java:337)\n\tat org.apache.activemq.transport.stomp.ProtocolConverter.onStompCommand(ProtocolConverter.java:179)\n\tat org.apache.activemq.transport.stomp.StompTransportFilter.onCommand(StompTransportFilter.java:67)\n\tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n\tat org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)\n\t... 1 more\nDEBUG TransportConnection            - Stopping connection: /127.0.0.1:44692\nDEBUG TcpTransport                   - Stopping transport tcp:///127.0.0.1:44692\nDEBUG TransportConnection            - Stopped transport: /127.0.0.1:44692\nDEBUG TransportConnection            - Cleaning up connection resources: /127.0.0.1:44692\nDEBUG AbstractRegion                 - localhost removing consumer: ID:alex-60773-1244124360289-2:2:-1:1 for destination: queue://COMMAND.HOST.alex\nDEBUG LocalTransaction               - rollback: TX:ID:alex-60773-1244124360289-2:2:1 syncCount: 3\nDEBUG AMQMessageStore                - Transacted message add rollback for: ID:alex-60773-1244124360289-2:2:-1:1:1, at: offset = 10973, file = 1, size = 375, type = 1\nDEBUG TransportConnection            - Connection Stopped: /127.0.0.1:44692\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461557","id":"12461557","filename":"AMQ-2280.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gseben","name":"gseben","key":"gseben","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovani Seben","active":true,"timeZone":"Etc/UTC"},"created":"2009-07-14T20:35:47.305+0000","size":1175,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461557/AMQ-2280.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161701","customfield_12312823":null,"summary":"stomp: Transport failed: java.io.IOException: Unexpected error occured","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aivanise","name":"aivanise","key":"aivanise","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aleksandar Ivanisevic","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aivanise","name":"aivanise","key":"aivanise","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aleksandar Ivanisevic","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"linux  2.6.26.8, Fedora Core 8\n\njava version \"1.6.0_11\"\nJava(TM) SE Runtime Environment (build 1.6.0_11-b03)\nJava HotSpot(TM) Client VM (build 11.0-b16, mixed mode, sharing)\n\napache-activemq-5.3-SNAPSHOT-bin.gz   \t Fri May 29 06:12:47 GMT+00:00 2009  \t 34977374  \t   ","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483075/comment/12941740","id":"12941740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gseben","name":"gseben","key":"gseben","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovani Seben","active":true,"timeZone":"Etc/UTC"},"body":"I was reviewing this report and I found the problem that generates this exception. \n\nIn the particular case shown here, when commiting a transaction the broker will attempt to commit messages received by the subscriber created before the transaction. \n{code}\nSUBSCRIBE\nactivemq.prefetchSize:1\nack:client\ndestination:/queue/COMMAND.HOST.alex\nactivemq.exclusive:true\n{code}\nSince there are no messages there to be commited it fails when doing a lookup on the message subscription linked list. \n\nStomp transactions are based only on the transaction ID. The sample here assumes that the transaction is tied to the destination which is not the case. In this case the destination parameter passed in the BEGIN and COMMIT statements is simply ignored by the stomp transport. They are not part of the protocol specification AFAIK. Since mixing multiple transacted and non-transacted destinations within the same stomp connection will cause problems I added a simple check that will warn the user about this issue.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gseben","name":"gseben","key":"gseben","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovani Seben","active":true,"timeZone":"Etc/UTC"},"created":"2009-07-14T20:33:42.985+0000","updated":"2009-07-14T20:33:42.985+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483075/comment/12941742","id":"12941742","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aivanise","name":"aivanise","key":"aivanise","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aleksandar Ivanisevic","active":true,"timeZone":"Europe/Berlin"},"body":"Hi,\n\nMany thanks for the patch, I'll try to test as soon as it gets comitted or i find the time to build amq myself, whichever comes first :)\n\nSending destination in BEGIN frame was an error, I have since corrected that.\n\nHowever I'm intrigued by your statement that \"Mixing multiple transacted and non-transacted destinations within the same stomp connection will cause problems\"\n\nCan you elaborate on this? What is a \"transacted destination\" if, as you said, transactions are not dependent on the destinations?\n\nWhat kind of problems can I expect? Can you point me to some documentation? I thought that, like in SQL, i can BEGIN, send MESSAGEs and then either COMMIT or ABORT and all the messages in between will either be sent or discarded.\n\nMany thanks for your insights.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aivanise","name":"aivanise","key":"aivanise","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aleksandar Ivanisevic","active":true,"timeZone":"Europe/Berlin"},"created":"2009-07-16T17:43:48.740+0000","updated":"2009-07-16T17:43:48.740+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483075/comment/12940993","id":"12940993","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gseben","name":"gseben","key":"gseben","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovani Seben","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nThe patch that I'm suggesting is a simple check on the code to try to avoid this situation since in my opinion without a more fine grained definition of transactions with Stomp would be required.\n\nLet me try to explain this a bit better. \nThe particular problem with the snippet of stomp code that you attached to this report is that it first subscribes to destination \"/queue/COMMAND.HOST.alex\" and then you tries to send transacted messages to \"/queue/COMMANDREPLY.HOST.alex\".  Since stomp transactions are bound only by the transactionID the logic in the code needs to check *all* destinations used in a connection for messages to commit. In this case the exception happens because there is nothing to be commited at \"/queue/COMMAND.HOST.alex\".\n\nThe bottom line is that since BEGIN doesn't take a destination as a parameter there is no way to identify for which destination you are starting a transaction and that's the reason why all destinations for the current connection have to be checked for messages to be commited.\n\nMy recommendation is that if you use transactions, don't use more than one destination per connection. This way you avoid the confusion of which destination the transaction is actually supposed to be for.\n\nHope that this clarifies some of your questions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gseben","name":"gseben","key":"gseben","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Giovani Seben","active":true,"timeZone":"Etc/UTC"},"created":"2009-08-06T20:03:02.325+0000","updated":"2009-08-06T20:03:02.325+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483075/comment/12941015","id":"12941015","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aivanise","name":"aivanise","key":"aivanise","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aleksandar Ivanisevic","active":true,"timeZone":"Europe/Berlin"},"body":"\nJust to confirm that I have split the sending and receiving part of my client into separate connections and that appears to have \"fixed\" the problem.\n\nI still don't see anything both in the STOMP spec and common sense that would be against mixing transacted and non-transacted statements in one connection, so IMO this is a bug in AMQ STOMP, not in my usage (if we don't count sending a destination in BEGIN frame which is clearly an error).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aivanise","name":"aivanise","key":"aivanise","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aleksandar Ivanisevic","active":true,"timeZone":"Europe/Berlin"},"created":"2009-08-07T08:21:59.979+0000","updated":"2009-08-07T08:21:59.979+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483075/comment/12940998","id":"12940998","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Fixed in SVN revision 801916, by checking if the subscriber has some messages in the tx, before sending ack. Please check it out by building the current trunk (or trying the next nightly build).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-08-07T09:20:28.075+0000","updated":"2009-08-07T09:20:28.075+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2280/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s1dz:"}}