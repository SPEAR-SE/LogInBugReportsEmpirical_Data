{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12507051","self":"https://issues.apache.org/jira/rest/api/2/issue/12507051","key":"AMQ-3320","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2011-07-12T21:04:52.107+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jul 12 23:48:40 UTC 2011","customfield_12310420":"68230","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3320/watchers","watchCount":2,"isWatching":false},"created":"2011-05-12T22:55:18.692+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315625","id":"12315625","description":"","name":"5.4.2","archived":false,"released":true,"releaseDate":"2010-12-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-07-12T23:48:40.807+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have enabled <policyEntry tempQueue=\"true\" advisoryForConsumed=\"true\" /> in the broker so I can subscribe to \"ActiveMQ.Advisory.MessageConsumed.TempQueue.>\" to get notified of messages consumed on a tempQueue/s. When client shuts down \nif remaining messages are in the tempQueue an advisory message is generated and send to the ActiveMQ.Advisory.MessageConsumed.TempQueue topic for each message for that tempQueue. The same will happen if purge() is called on a TempQueue or Queue for example through JMX.  \n\nIn my application I need to know if a message is consumed by a client but I can not differentiate between a client \"ack\" massage and one \"ack\" by the broker when the tempQueue is \"disposed\" looking to the message sent to the ActiveMQ.Advisory.MessageConsumed.TempQueue... . \n \nLooking at the code for TempQueue and Queue this is the sequence :\n\nTempQueue.dispose(context) --> purge() --> removeMessage() -> acknowledge() --> messageConsumed() \n\nThis is kind of a conceptual issue since myself consider that removing a message due a purge or a tempQueue cleanup should not trigger a messageConsumed advisory.\n\n\nOriginal ActiveMQ users post : http://activemq.2283324.n4.nabble.com/ActiveMQ-Advisory-MessageConsumed-TempQueue-problem-td3510067.html\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12479029","id":"12479029","filename":"AdvisoryTempDestinationTests.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-12T23:08:51.399+0000","size":11451,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12479029/AdvisoryTempDestinationTests.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"81555","customfield_12312823":null,"summary":"ActiveMQ.Advisory.MessageConsumed.TempQueue and AMQ.A.MC.Queue Topics receive advisory messages when TQ or Queue are purged","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507051/comment/13032740","id":"13032740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"body":"Added testTempMessageConsumedAdvisoryConnectionClose() method to test this issue. The test should fail since the test expects no new advisories when the connection is closed ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-12T23:08:51.426+0000","updated":"2011-05-13T20:22:43.100+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507051/comment/13032744","id":"13032744","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"body":"  A possible simple solution is to set setAdvisoryForConsumed(false); at the beginning of the purge() or maybe in  removeMessage(ConnectionContext c, QueueMessageReference r) method in Queue.java\n\n   public void purge() throws Exception {\n        boolean isAdvisoryForConsumed = isAdvisoryForConsumed();\n    \tsetAdvisoryForConsumed(false);\n\n        ConnectionContext c = createConnectionContext();\n        List<MessageReference> list = null;\n        do {\n            doPageIn(true);\n            pagedInMessagesLock.readLock().lock();\n            try {\n                list = new ArrayList<MessageReference>(pagedInMessages.values());\n            }finally {\n                pagedInMessagesLock.readLock().unlock();\n            }\n\n            for (MessageReference ref : list) {\n                try {\n                    QueueMessageReference r = (QueueMessageReference) ref;\n                    removeMessage(c, r);\n                } catch (IOException e) {\n                }\n            }\n            // don't spin/hang if stats are out and there is nothing left in the\n            // store\n        } while (!list.isEmpty() && this.destinationStatistics.getMessages().getCount() > 0);\n        if (this.destinationStatistics.getMessages().getCount() > 0) {\n            LOG.warn(getActiveMQDestination().getQualifiedName()\n                    + \" after purge complete, message count stats report: \"\n                    + this.destinationStatistics.getMessages().getCount());\n        }\n        gc();\n        this.destinationStatistics.getMessages().setCount(0);\n        getMessages().clear();\n        setAdvisoryForConsumed(isAdvisoryForConsumed);\n    }\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"created":"2011-05-12T23:26:41.336+0000","updated":"2011-05-13T20:22:02.901+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507051/comment/13064135","id":"13064135","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"I'd suggest something like this instead of the disable / enable method shown above. \n\n{code}\n### Eclipse Workspace Patch 1.0\n#P activemq-core\nIndex: src/main/java/org/apache/activemq/broker/region/BaseDestination.java\n===================================================================\n--- src/main/java/org/apache/activemq/broker/region/BaseDestination.java\t(revision 1145597)\n+++ src/main/java/org/apache/activemq/broker/region/BaseDestination.java\t(working copy)\n@@ -452,7 +452,9 @@\n      * @param messageReference\n      */\n     public void messageConsumed(ConnectionContext context, MessageReference messageReference) {\n-        if (advisoryForConsumed) {\n+        // If there are no consumers then the message was consumed by a purge which we don't\n+        // want to propagate as a consumer ack of the message.\n+        if (advisoryForConsumed && destinationStatistics.getConsumers().getCount() > 0) {\n             broker.messageConsumed(context, messageReference);\n         }\n     }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-07-12T21:04:52.107+0000","updated":"2011-07-12T21:04:52.107+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12507051/comment/13064239","id":"13064239","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"body":"Probably I'm missing something but I think that checking the number of consumers does not fix all the possible use cases that can go wrong. Like if I hit \"purge\" in jconsole for a \"queue\" with slow consumers and remaining messages in the queue. The removed messages are going to cause the creation of advisory messages.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelcasado","name":"marcelcasado","key":"marcelcasado","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcel Casado","active":true,"timeZone":"Etc/UTC"},"created":"2011-07-12T23:48:40.789+0000","updated":"2011-07-12T23:48:40.789+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3320/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0eb2f:"}}