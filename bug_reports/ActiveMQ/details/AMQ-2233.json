{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483038","self":"https://issues.apache.org/jira/rest/api/2/issue/12483038","key":"AMQ-2233","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-04-28T16:31:32.410+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jul 08 09:03:05 UTC 2009","customfield_12310420":"75017","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_6123264676_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-07-08T09:03:05.417+0000","workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2233/watchers","watchCount":1,"isWatching":false},"created":"2009-04-28T12:08:40.741+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":0,"aggregatetimeoriginalestimate":0,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[{"id":"12335011","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12335011","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"outwardIssue":{"id":"12482777","key":"AMQ-2034","self":"https://issues.apache.org/jira/rest/api/2/issue/12482777","fields":{"summary":"consumer close with active XA transaction results in java.lang.IllegalArgumentException: The subscription does not exist: ...","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-08T09:03:05.378+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":0,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"After rollback received messages not re-presented.  If I receive in a transaction and then roll back the messages should be re-presented in the next transaction.  This used to work in 5.1.0, but is broken in 5.2.0.\n\nYou can browse the Queue in JMX after the rollback and see that the messages are still there, but they are not received by a consumer in the same process.\n\nHere's a test case (fails on the checkPostConditions()):\n\n{code}\npublic class RawRollbackTests {\n\t\n\tprivate static ConnectionFactory connectionFactory;\n\tprivate static Destination queue;\n\tprivate static BrokerService broker;\n\n\t@BeforeClass\n\tpublic static void clean() throws Exception {\n\t\tFileUtils.deleteDirectory(new File(\"activemq-data\"));\n\t\tbroker = new BrokerService();\n\t\tbroker.setUseJmx(true);\n\t\tbroker.start();\n\t\tActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory();\n\t\tconnectionFactory.setBrokerURL(\"vm://localhost?async=false\");\n\t\tRawRollbackTests.connectionFactory = connectionFactory;\n\t\tqueue = new ActiveMQQueue(\"queue\");\n\t}\n\n\t@AfterClass\n\tpublic static void close() throws Exception {\n\t\tbroker.stop();\n\t}\n\n\t@Before\n\tpublic void clearData() throws Exception {\n\t\tgetMessages(false); // drain queue\n\t\tconvertAndSend(\"foo\");\n\t\tconvertAndSend(\"bar\");\n\t}\n\n\n\t@After\n\tpublic void checkPostConditions() throws Exception {\n\n\t\tThread.sleep(1000L);\n\t\tList<String> list = getMessages(false);\n\t\tassertEquals(2, list.size());\n\n\t}\n\n\t@Test\n\tpublic void testReceiveMessages() throws Exception {\n\n\t\tList<String> list = getMessages(true);\n\t\tassertEquals(2, list.size());\n\t\tassertTrue(list.contains(\"foo\"));\n\n\t}\n\t\n\tprivate void convertAndSend(String msg) throws Exception {\n\t\tConnection connection = connectionFactory.createConnection();\n\t\tconnection.start();\n\t\tSession session = connection.createSession(true, Session.AUTO_ACKNOWLEDGE);\n\t\tMessageProducer producer = session.createProducer(queue);\n\t\tproducer.send(session.createTextMessage(msg));\n\t\tproducer.close();\n\t\tsession.commit();\n\t\tsession.close();\n\t\tconnection.close();\n\t}\n\n\tprivate List<String> getMessages(boolean rollback) throws Exception {\n\t\tConnection connection = connectionFactory.createConnection();\n\t\tconnection.start();\n\t\tSession session = connection.createSession(true, Session.AUTO_ACKNOWLEDGE);\n\t\tString next = \"\";\n\t\tList<String> msgs = new ArrayList<String>();\n\t\twhile (next != null) {\n\t\t\tnext = (String) receiveAndConvert(session);\n\t\t\tif (next != null)\n\t\t\t\tmsgs.add(next);\n\t\t}\n\t\tif (rollback) {\n\t\t\tsession.rollback();\n\t\t} else {\n\t\t\tsession.commit();\n\t\t}\n\t\tsession.close();\n\t\tconnection.close();\n\t\treturn msgs;\n\t}\n\n\tprivate String receiveAndConvert(Session session) throws Exception {\n\t\tMessageConsumer consumer = session.createConsumer(queue);\n\t\tMessage message = consumer.receive(100L);\n\t\tconsumer.close();\n\t\tif (message==null) {\n\t\t\treturn null;\n\t\t}\n\t\treturn ((TextMessage)message).getText();\n\t}\n}\n{code}","customfield_10010":null,"timetracking":{"originalEstimate":"0h","remainingEstimate":"0h","originalEstimateSeconds":0,"remainingEstimateSeconds":0},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461512","id":"12461512","filename":"RawRollbackSharedConsumerTests.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-13T11:27:14.674+0000","size":3313,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461512/RawRollbackSharedConsumerTests.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461503","id":"12461503","filename":"RawRollbackTests.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-29T05:20:08.101+0000","size":3315,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461503/RawRollbackTests.java"}],"aggregatetimeestimate":0,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161695","customfield_12312823":null,"summary":"After rollback received messages not re-presented","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941230","id":"12941230","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"can you attach your test case (see the attach file link) and make a license grant so that your test can be added to the activemq suite?\n\nThis is an interesting test case. The change of behavior is around consumer.close() and transactions. When in a transaction, the close is deferred till the transaction completes, so with a prefetch > 0, messages dispatched to that consumer will not be available till the transaction commits.\n\nI think your test case will work with a prefetch of 0, connectionFactory.setBrokerURL(\"vm://localhost?async=false&waitForStart=5000&jms.prefetchPolicy.all=0\");","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-28T16:31:32.410+0000","updated":"2009-04-28T16:47:46.932+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941236","id":"12941236","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"for a managed case, the XA case was made the general case. a close is deferred if in any transaction.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-28T16:46:45.655+0000","updated":"2009-04-28T16:46:45.655+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941234","id":"12941234","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"body":"Attached test case as file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-29T05:20:08.199+0000","updated":"2009-04-29T05:20:08.199+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941244","id":"12941244","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the response.  The prefetch hint didn't have any effect on the test case.  I didn't follow the comment about the deferred close.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-02T07:44:47.747+0000","updated":"2009-05-02T07:44:47.747+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941298","id":"12941298","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Added your test case with the prefetch workaround: http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/bugs/RawRollbackTests.java?view=markup\n\nThe issue is the consumer.close call in the receiveAndConvert. The close occurs in a transaction and the close is deferred till the transaction completes. The default prefetch value of 100 ensures that the consumer will have both messages queued up for dispatch. The undispatched are only redispatched afer the close. But we don't know if the messages are to be acked till the transaction completes. Thus the additional prefetched \"bar\" message is not available to a second consumer.\nChanging the prefetch value to 0 (note the changed connectionURL) ensures that each consumer gets a single message from a call to receive so only that message is outstanding until the transaction completes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-12T11:36:29.649+0000","updated":"2009-05-12T11:36:29.649+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941297","id":"12941297","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"body":"Thanks for the update.  I tried (as previously indicated) the prefetch hint and it didn't change anything.  If I understand the comment correctly maybe you misunderstood the test case: it doesn't fail because \"bar\" is unavailable to a second consumer - in fact it is, as the assertion {{assertEquals(2, list.size())}} in the test method shows. \n\nIt fails because neither \"foo\" nor \"bar\" is available to any consumer whatsoever, after the rollback has occurred.  The transaction has certainly completed by the time the test fails (thecomment seems to imply the opposite, but maybe I misunderstood).\n\nIt still fails for you, right?  (I only ran it against 5.2.0.)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-12T12:37:30.839+0000","updated":"2009-05-12T12:37:30.839+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941277","id":"12941277","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"so the test (your test) I committed to trunk works. It uses &jms.prefetchPolicy.all=0\n\nWith out the prefetch=0 config, the assertion fails for me with list.size() == 1\nIn the rollback case, receiveAndConvert is called twice so two consumers are created. The first consumer gets both messages dispatched to it and consumes one before closing. The second consumer gets nothing. So list.size == 1.\nThe problem is the consumer.close is deferred till the transaction completes (commits or rollsback)\n\nThe workaround is to only deliver messages on demand, when receive is called, prefetch=0 gives this.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-12T15:42:10.870+0000","updated":"2009-05-12T15:42:10.870+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941296","id":"12941296","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"body":"Your failure is not the same as mine (in 5.2.0).  I am failing in the @After, and it sounds like you are failing (before the fetch size hint) in @Test.\n\nI will try it when a new snapshot appears.  The Apache snapshots repo has a latest version in mid April; any news on that, or am I looking in the wrong place?\n\nThe original test (with or without the fech size) still fails with 5.2.0 and passes with 5.1.0.  It also fails if I use a single consumer to consume all messages in a Session.  So I'd be interested to know what broke in the meantime there.  5.1.0 seems correct as far as the JMS spec goes.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-13T00:42:09.129+0000","updated":"2009-05-13T00:42:09.129+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941291","id":"12941291","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The nightly snapshot is available at https://repository.apache.org/content/repositories/snapshots/org/apache/activemq/apache-activemq/5.3-SNAPSHOT/ \n\nI think the key change (on trunk) relates to consumer.close when there is a transaction. The close is deferred to a synchronisation afterCompletion so the effect of the close is not visible till the transaction completes. From what i can see, the test depends on the visibility of predispatched messages before the transaction completes.\n\nCan you provide your test variant that uses a single consumer so I can include it?\nW.r.t the spec, the whole prefetch issue is outside the spec, prefetch=0 gets it back in line.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-13T08:22:02.883+0000","updated":"2009-05-13T08:22:02.883+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941295","id":"12941295","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"body":"Added shared consumer test case.  This passes in 5.3-SNAPSHOT even without the fetch size hint as predicted.  But it also fails in 5.2.0, which still seems like a bug to me, considering what you said above.  What do you think?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-13T11:27:14.755+0000","updated":"2009-05-13T11:27:14.755+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941303","id":"12941303","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"yea, I think that is a bug with 5.2.0. All is good on trunk now though. I committed that shared test to protect against regression, thanks. Are you happy to see this issue closed?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-15T09:30:43.187+0000","updated":"2009-05-15T09:30:43.187+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941329","id":"12941329","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"body":"Not abundantly happy, really, no.  I think it's a regression from 5.1.0, and hiding behind the strict letter of the law regarding the specification is a weak position to take.  Even if prefetch is a proprietary feature, having to set it to a non-default value to get a system to behave as expected makes it very hard for users to guess or understand what is happening.  Also, prefetch is a good feature that I probably want to use, so switching it off just to get messages redelivered to another consumer in the same process seems like it must be a workaround for a bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-19T10:01:49.850+0000","updated":"2009-05-19T10:01:49.850+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941496","id":"12941496","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"body":"I am seeing this issue in production environments now - unacked messages sit on the broker forever until it is restarted.  Is there some way I can help to fix it so the behaviour goes back to the way it was in 5.1?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-06-15T17:12:17.825+0000","updated":"2009-06-15T17:12:17.825+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941708","id":"12941708","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"body":"This issue is now apparently fixed in 5.3-SNAPSHOT (my original test case passes), presumably as a result of fixes for other issues?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=david_syer","name":"david_syer","key":"david_syer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Syer","active":true,"timeZone":"Etc/UTC"},"created":"2009-07-08T07:36:02.542+0000","updated":"2009-07-08T07:36:02.542+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483038/comment/12941707","id":"12941707","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolving as per dave's comment, current snapshot has a fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-07-08T09:03:05.316+0000","updated":"2009-07-08T09:03:05.316+0000"}],"maxResults":15,"total":15,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2233/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s1cn:"}}