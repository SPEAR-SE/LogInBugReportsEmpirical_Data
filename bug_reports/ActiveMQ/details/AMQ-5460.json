{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12758148","self":"https://issues.apache.org/jira/rest/api/2/issue/12758148","key":"AMQ-5460","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2014-11-27 07:01:54.574","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5460/watchers","watchCount":1,"isWatching":false},"created":"2014-11-27T07:01:54.574+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":["failover","high-availability"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-11-27T07:01:54.574+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We have two ActiveMQ(version 5.10.0) instances running and I am using the shared storage to achieve HA. However I am unable to see failover happening for the producer and consumer(s).\n\nActiveMQ broker-1 runs on IP1 and broker-2 on IP2 And under the activemq.xml of configuration I have modified persistence adapter to use a shared directory which is present on IP1.\n\n{quote}\n<persistenceAdapter>\n  <kahaDB directory=\"\\\\IP1\\shared-directory\\for activemq\\data\"/>\n</persistenceAdapter>\nBoth in producer and consumer sides I am using following JNDI configurations to get the connections and build sessions,etc.\n{quote}\n\njndi.properties\n{quote}\njava.naming.factory.initial = ..........ActiveMQInitialContextFactory\njava.naming.provider.url = failover:(tcp://IP1:61616,tcp://IP2:61616)?randomize=false\nconnectionFactoryNames = myConnectionFactory\nqueue.requestQ = my.RequestQ\n{quote}\n\nInteresting part is :\n\nWhen I start this broker pair, I see that one of the brokers becomes master. When I start the producer, which puts the message on the Q (say producer has put 100 messages on the Q). While my producer is still running; I shutdown master broker, hence slave broker acquires the file-lock and becomes master.When I open the webconsole I see that 100 messages are still there on the Q. Even though producer is running it no longer puts any messages on this Q.\n\nSimilar to this for the consumers also. Consumer was picking messages from the Q, this Q has say 100 messages unconsumed when master failed, now master goes down, slave becomes master, I see 100 messages are still unconsumed, but the consumer does not pick any message from the Q.\n\nI waited them to failover for a long time.(>10 mins.) Can any one please suggest what configuration am I missing ?\n\nI am copy pasting producer and consumer as is (I've copied this from ActiveMQ in action book with minor modifications).\n\n{quote}\nProducer\n\npublic class Producer {\n\n    private static String brokerURL = \"failover:(tcp://IP1:3389,tcp://IP2:3389)\";\n    private static transient ConnectionFactory factory;\n    private transient Connection connection;\n    private transient Session session;\n    private transient MessageProducer producer;\n\n    private static int count = 10;\n    private static int total;\n    private static int id = 1000000;\n    private String jobs[] = new String[] { \"suspend\", \"delete\" };\n\n    public Producer() throws JMSException {\n        factory = new ActiveMQConnectionFactory(brokerURL);\n        connection = factory.createConnection();\n        connection.start();\n        session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);\n        producer = session.createProducer(null);\n    }\n\n    public void close() throws JMSException {\n        if (connection != null) {\n            connection.close();\n        }\n    }\n\n    public static void main(String[] args) throws JMSException {\n        Producer producer = new Producer();\n        while (total < 1000) {\n            for (int i = 0; i < count; i++) {\n                producer.sendMessage();\n            }\n            total += count;\n            System.out.println(\"Sent '\" + count + \"' of '\" + total\n                    + \"' job messages\");\n            try {\n                Thread.sleep(1000);\n            } catch (InterruptedException x) {\n            }\n        }\n        producer.close();\n\n    }\n\n    public void sendMessage() throws JMSException {\n        int idx = 0;\n        while (true) {\n            idx = (int) Math.round(jobs.length * Math.random());\n            if (idx < jobs.length) {\n                break;\n            }\n        }\n        String job = jobs[idx];\n        Destination destination = session.createQueue(\"JOBS.\" + job);\n        Message message = session.createObjectMessage(id++);\n        System.out.println(\"Sending: id: \"\n                + ((ObjectMessage) message).getObject() + \" on queue: \"\n                + destination);\n        producer.send(destination, message);\n    }\n}\n{quote}\n\nConsumer\n{quote}\npublic class Consumer {\n\n    private static String brokerURL = \"failover:(tcp://IP1:3389,tcp://IP2:3389)\";\n    private static transient ConnectionFactory factory;\n    private transient Connection connection;\n    private transient Session session;\n\n    private String jobs[] = new String[] { \"suspend\", \"delete\" };\n\n    public Consumer() throws JMSException {\n        factory = new ActiveMQConnectionFactory(brokerURL);\n        connection = factory.createConnection();\n        connection.start();\n        session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);\n    }\n\n    public void close() throws JMSException {\n        if (connection != null) {\n            connection.close();\n        }\n    }\n\n    public static void main(String[] args) throws JMSException {\n        Consumer consumer = new Consumer();\n        for (String job : consumer.jobs) {\n            Destination destination = consumer.getSession().createQueue(\n                    \"JOBS.\" + job);\n            MessageConsumer messageConsumer = consumer.getSession()\n                    .createConsumer(destination);\n            messageConsumer.setMessageListener(new Listener(job));\n        }\n    }\n\n    public Session getSession() {\n        return session;\n    }\n\n}\n{quote}\n\n\n*What I've observed is :*\nOne AMQ is running on 32 bit, another on 64 bit. \nIf the producer/consumer is running on 64 bit machine, it fails over to 32 bit AMQ.\nIf the producer or consumer is running on 32 bit machine it does not failover to 64 bit AMQ.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"HA : Failover does not happen with 2 AMQ instances when one runs on 32 bit another on 64 bit","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpanr","name":"arpanr","key":"arpanr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpan Rajani","active":true,"timeZone":"Europe/London"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=arpanr","name":"arpanr","key":"arpanr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arpan Rajani","active":true,"timeZone":"Europe/London"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"RHEL 6.5, Oracle JDK 1.7, (64 bit)\nRHEL 6.x , Oracle JDK 1.7 (32 bit)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5460/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i22u7r:"}}