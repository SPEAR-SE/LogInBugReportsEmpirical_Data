{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481950","self":"https://issues.apache.org/jira/rest/api/2/issue/12481950","key":"AMQ-368","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2005-10-14T01:14:53.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Feb 14 01:45:29 UTC 2007","customfield_12310420":"84264","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_9879883000_*|*_6_*:*_1_*:*_2806004000_*|*_5_*:*_1_*:*_0_*|*_4_*:*_1_*:*_20000","customfield_12312321":null,"resolutiondate":"2006-02-16T11:43:54.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-368/watchers","watchCount":2,"isWatching":false},"created":"2005-09-22T15:52:07.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315601","id":"12315601","name":"3.1","archived":false,"released":true}],"issuelinks":[{"id":"12335004","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12335004","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12481394","key":"AMQ-377","self":"https://issues.apache.org/jira/rest/api/2/issue/12481394","fields":{"summary":"Unbounded number of jdbc connections created to postgresql","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-02-14T01:45:29.882+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The activemq server seems to be leaking database connections:\n\n2005-09-22 19:01:51,109 [ocalport=61616]] WARN  BrokerClientImpl               - caught exception consuming packet: ACTIVEMQ_OBJECT_MESSAGE: id = 185 ActiveMQMessage{ , jmsMessageID = ID:AMT915-1611-1127395790823-44:19, bodyAsBytes = org.activemq.io.util.ByteArray@16de067, readOnlyMessage = false, jmsClientID = 'ID:AMT915-1611-1127395790823-9:0' , jmsCorrelationID = 'null' , jmsDestination = SmsGateway.OutboundQueue, jmsReplyTo = null, jmsDeliveryMode = 2, jmsRedelivered = false, jmsType = 'null' , jmsExpiration = 0, jmsPriority = 4, jmsTimestamp = 1127395909844, properties = {esmeId=3, callId=70867}, readOnlyProperties = false, entryBrokerName = 'ID:AMT915-1055-1127393936629-0:0' , entryClusterName = 'default' , consumerNos = null, transactionId = 'null' , xaTransacted = false, consumerIdentifer = 'null' , messageConsumed = false, transientConsumed = false, sequenceNumber = 19, deliveryCount = 1, dispatchedFromDLQ = false, messageAcknowledge = null, jmsMessageIdentity = null, producerKey = ID:AMT915-1611-1127395790823-44: } ActiveMQObjectMessage{ object = {destAddress=919811771123, userDataHeader=[B@15fb38, sourceAddress=111, charset=US-ASCII, userDataBinary=[B@120540c} }\njavax.jms.JMSException: Failed to broker message: ID:AMT915-1611-1127395790823-44:19 in container: org.postgresql.util.PSQLException: Backend start-up failed: FATAL: connection limit exceeded for non-superusers.\n\tat org.activemq.util.JMSExceptionHelper.newJMSException(JMSExceptionHelper.java:49)\n\tat org.activemq.store.jdbc.JDBCMessageStore.addMessage(JDBCMessageStore.java:74)\n\tat org.activemq.store.vm.VMTransactionStore.addMessage(VMTransactionStore.java:230)\n\tat org.activemq.store.vm.VMTransactionStore$1.addMessage(VMTransactionStore.java:118)\n\tat org.activemq.store.cache.CacheMessageStore.addMessage(CacheMessageStore.java:51)\n\tat org.activemq.service.boundedvm.DurableQueueBoundedMessageContainer.enqueue(DurableQueueBoundedMessageContainer.java:218)\n\tat org.activemq.service.boundedvm.DurableQueueBoundedMessageManager.sendMessage(DurableQueueBoundedMessageManager.java:302)\n\tat org.activemq.broker.impl.DefaultBroker.doMessageSend(DefaultBroker.java:566)\n\tat org.activemq.broker.impl.DefaultBroker.sendMessage(DefaultBroker.java:305)\n\tat org.activemq.broker.impl.BrokerContainerImpl.sendMessage(BrokerContainerImpl.java:462)\n\tat org.activemq.broker.impl.BrokerConnectorImpl.sendMessage(BrokerConnectorImpl.java:272)\n\tat org.activemq.broker.impl.BrokerClientImpl.consumeActiveMQMessage(BrokerClientImpl.java:722)\n\tat org.activemq.broker.impl.BrokerClientImpl.consume(BrokerClientImpl.java:323)\n\tat org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:374)\n\tat org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:368)\n\tat org.activemq.transport.tcp.TcpTransportChannel.run(TcpTransportChannel.java:311)\n\tat java.lang.Thread.run(Thread.java:595)\nCaused by: org.postgresql.util.PSQLException: Backend start-up failed: FATAL: connection limit exceeded for non-superusers.\n\tat org.postgresql.core.v3.ConnectionFactoryImpl.readStartupMessages(ConnectionFactoryImpl.java:443)\n\tat org.postgresql.core.v3.ConnectionFactoryImpl.openConnectionImpl(ConnectionFactoryImpl.java:98)\n\tat org.postgresql.core.ConnectionFactory.openConnection(ConnectionFactory.java:65)\n\tat org.postgresql.jdbc2.AbstractJdbc2Connection.<init>(AbstractJdbc2Connection.java:117)\n\tat org.postgresql.jdbc3.AbstractJdbc3Connection.<init>(AbstractJdbc3Connection.java:30)\n\tat org.postgresql.jdbc3.Jdbc3Connection.<init>(Jdbc3Connection.java:24)\n\tat org.postgresql.Driver.connect(Driver.java:235)\n\tat org.apache.commons.dbcp.DriverConnectionFactory.createConnection(DriverConnectionFactory.java:37)\n\tat org.apache.commons.dbcp.PoolableConnectionFactory.makeObject(PoolableConnectionFactory.java:290)\n\tat org.apache.commons.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:771)\n\tat org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:95)\n\tat org.apache.commons.dbcp.BasicDataSource.getConnection(BasicDataSource.java:544)\n\tat org.activemq.store.jdbc.JDBCPersistenceAdapter.getConnection(JDBCPersistenceAdapter.java:312)\n\tat org.activemq.store.jdbc.JDBCMessageStore.addMessage(JDBCMessageStore.java:71)\n\t... 15 more\n2005-09-22 19:01:51,656 [ocalport=61616]] WARN  BrokerClientImpl               - caught exception consuming packet: TRANSACTION_INFO: id = 283 TransactionInfo{ transactionId = 'ID:AMT915-1611-1127395790823-30:9' , type = 103 }\njavax.jms.JMSException\n\tat org.activemq.broker.impl.DefaultBroker.commitTransaction(DefaultBroker.java:352)\n\tat org.activemq.broker.impl.BrokerContainerImpl.commitTransaction(BrokerContainerImpl.java:449)\n\tat org.activemq.broker.impl.BrokerConnectorImpl.commitTransaction(BrokerConnectorImpl.java:261)\n\tat org.activemq.broker.impl.BrokerClientImpl.consumeTransactionInfo(BrokerClientImpl.java:751)\n\tat org.activemq.broker.impl.BrokerClientImpl.consume(BrokerClientImpl.java:340)\n\tat org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:374)\n\tat org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:368)\n\tat org.activemq.transport.tcp.TcpTransportChannel.run(TcpTransportChannel.java:311)\n\tat java.lang.Thread.run(Thread.java:595)\nCaused by: javax.transaction.xa.XAException\n\tat org.activemq.store.vm.VMTransactionStore$Tx.commit(VMTransactionStore.java:100)\n\tat org.activemq.store.vm.VMTransactionStore.commit(VMTransactionStore.java:172)\n\tat org.activemq.service.impl.LocalTransactionCommand.commit(LocalTransactionCommand.java:66)\n\tat org.activemq.broker.impl.DefaultBroker.commitTransaction(DefaultBroker.java:348)\n\t... 8 more\nCaused by: javax.jms.JMSException: Failed to broker message: ID:AMT915-1611-1127395790823-47:9 in container: org.postgresql.util.PSQLException: Backend start-up failed: FATAL: connection limit exceeded for non-superusers.\n\tat org.activemq.util.JMSExceptionHelper.newJMSException(JMSExceptionHelper.java:49)\n\tat org.activemq.store.jdbc.JDBCMessageStore.removeMessage(JDBCMessageStore.java:151)\n\tat org.activemq.store.vm.VMTransactionStore$4.run(VMTransactionStore.java:249)\n\tat org.activemq.store.vm.VMTransactionStore$Tx.commit(VMTransactionStore.java:97)\n\t... 11 more\nCaused by: org.postgresql.util.PSQLException: Backend start-up failed: FATAL: connection limit exceeded for non-superusers.\n\tat org.postgresql.core.v3.ConnectionFactoryImpl.readStartupMessages(ConnectionFactoryImpl.java:443)\n\tat org.postgresql.core.v3.ConnectionFactoryImpl.openConnectionImpl(ConnectionFactoryImpl.java:98)\n\tat org.postgresql.core.ConnectionFactory.openConnection(ConnectionFactory.java:65)\n\tat org.postgresql.jdbc2.AbstractJdbc2Connection.<init>(AbstractJdbc2Connection.java:117)\n\tat org.postgresql.jdbc3.AbstractJdbc3Connection.<init>(AbstractJdbc3Connection.java:30)\n\tat org.postgresql.jdbc3.Jdbc3Connection.<init>(Jdbc3Connection.java:24)\n\tat org.postgresql.Driver.connect(Driver.java:235)\n\tat org.apache.commons.dbcp.DriverConnectionFactory.createConnection(DriverConnectionFactory.java:37)\n\tat org.apache.commons.dbcp.PoolableConnectionFactory.makeObject(PoolableConnectionFactory.java:290)\n\tat org.apache.commons.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:771)\n\tat org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:95)\n\tat org.apache.commons.dbcp.BasicDataSource.getConnection(BasicDataSource.java:544)\n\tat org.activemq.store.jdbc.JDBCPersistenceAdapter.getConnection(JDBCPersistenceAdapter.java:312)\n\tat org.activemq.store.jdbc.JDBCMessageStore.removeMessage(JDBCMessageStore.java:148)\n\t... 13 more\n2005-09-22 19:01:51,765 [ocalport=61616]] WARN  BrokerClientImpl               - caught exception consuming packet: TRANSACTION_INFO: id = 286 TransactionInfo{ transactionId = 'ID:AMT915-1611-1127395790823-24:9' , type = 103 }\njavax.jms.JMSException\n\tat org.activemq.broker.impl.DefaultBroker.commitTransaction(DefaultBroker.java:352)\n\tat org.activemq.broker.impl.BrokerContainerImpl.commitTransaction(BrokerContainerImpl.java:449)\n\tat org.activemq.broker.impl.BrokerConnectorImpl.commitTransaction(BrokerConnectorImpl.java:261)\n\tat org.activemq.broker.impl.BrokerClientImpl.consumeTransactionInfo(BrokerClientImpl.java:751)\n\tat org.activemq.broker.impl.BrokerClientImpl.consume(BrokerClientImpl.java:340)\n\tat org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:374)\n\tat org.activemq.transport.TransportChannelSupport.doConsumePacket(TransportChannelSupport.java:368)\n\tat org.activemq.transport.tcp.TcpTransportChannel.run(TcpTransportChannel.java:311)\n\tat java.lang.Thread.run(Thread.java:595)\nCaused by: javax.transaction.xa.XAException\n\tat org.activemq.store.vm.VMTransactionStore$Tx.commit(VMTransactionStore.java:100)\n\tat org.activemq.store.vm.VMTransactionStore.commit(VMTransactionStore.java:172)\n\tat org.activemq.service.impl.LocalTransactionCommand.commit(LocalTransactionCommand.java:66)\n\tat org.activemq.broker.impl.DefaultBroker.commitTransaction(DefaultBroker.java:348)\n\t... 8 more\nCaused by: javax.jms.JMSException: Failed to broker message: ID:AMT915-1611-1127395790823-50:9 in container: org.postgresql.util.PSQLException: Backend start-up failed: FATAL: connection limit exceeded for non-superusers.\n\tat org.activemq.util.JMSExceptionHelper.newJMSException(JMSExceptionHelper.java:49)\n\tat org.activemq.store.jdbc.JDBCMessageStore.getMessageSequenceId(JDBCMessageStore.java:134)\n\tat org.activemq.store.jdbc.JDBCMessageStore.removeMessage(JDBCMessageStore.java:143)\n\tat org.activemq.store.vm.VMTransactionStore$4.run(VMTransactionStore.java:249)\n\tat org.activemq.store.vm.VMTransactionStore$Tx.commit(VMTransactionStore.java:97)\n\t... 11 more\nCaused by: org.postgresql.util.PSQLException: Backend start-up failed: FATAL: connection limit exceeded for non-superusers.\n\tat org.postgresql.core.v3.ConnectionFactoryImpl.readStartupMessages(ConnectionFactoryImpl.java:443)\n\tat org.postgresql.core.v3.ConnectionFactoryImpl.openConnectionImpl(ConnectionFactoryImpl.java:98)\n\tat org.postgresql.core.ConnectionFactory.openConnection(ConnectionFactory.java:65)\n\tat org.postgresql.jdbc2.AbstractJdbc2Connection.<init>(AbstractJdbc2Connection.java:117)\n\tat org.postgresql.jdbc3.AbstractJdbc3Connection.<init>(AbstractJdbc3Connection.java:30)\n\tat org.postgresql.jdbc3.Jdbc3Connection.<init>(Jdbc3Connection.java:24)\n\tat org.postgresql.Driver.connect(Driver.java:235)\n\tat org.apache.commons.dbcp.DriverConnectionFactory.createConnection(DriverConnectionFactory.java:37)\n\tat org.apache.commons.dbcp.PoolableConnectionFactory.makeObject(PoolableConnectionFactory.java:290)\n\tat org.apache.commons.pool.impl.GenericObjectPool.borrowObject(GenericObjectPool.java:771)\n\tat org.apache.commons.dbcp.PoolingDataSource.getConnection(PoolingDataSource.java:95)\n\tat org.apache.commons.dbcp.BasicDataSource.getConnection(BasicDataSource.java:544)\n\tat org.activemq.store.jdbc.JDBCPersistenceAdapter.getConnection(JDBCPersistenceAdapter.java:312)\n\tat org.activemq.store.jdbc.JDBCMessageStore.getMessageSequenceId(JDBCMessageStore.java:127)\n\t... 14 more\n\nHere's the activemq config file:\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE beans PUBLIC  \"-//ACTIVEMQ//DTD//EN\" \"http://activemq.org/dtd/activemq.dtd\">\n<beans>\n  \n  <!-- ==================================================================== -->\n  <!-- ActiveMQ Broker Configuration -->\n  <!-- ==================================================================== -->\n  <broker>\n    <connector>\n      <tcpServerTransport uri=\"tcp://localhost:61616\" backlog=\"1000\" maxOutstandingMessages=\"50\"/>\n    </connector>\n\n    <persistence>\n      <cachePersistence>\n          <jdbcPersistence dataSourceRef=\"postgres-ds\"/>\n      </cachePersistence>\n    </persistence>\n\n\t<!-- Approximately one day -->\n\t<redeliveryPolicy maximumRetryCount=\"100\" backOffMode=\"true\" backOffIncreaseRate=\"1.1\" initialRedeliveryTimeout=\"1000\"/>\n\n  </broker>\n\n  <!-- ==================================================================== -->\n  <!-- JDBC DataSource Configurations -->\n  <!-- ==================================================================== -->\n  <bean id=\"postgres-ds\"\n    class=\"org.apache.commons.dbcp.BasicDataSource\"\n    destroy-method=\"close\">\n    <property name=\"driverClassName\">\n      <value>org.postgresql.Driver</value>\n    </property>\n    <property name=\"url\">\n      <value>jdbc:postgresql://localhost:5432/activemq</value>\n    </property>\n    <property name=\"username\">\n      <value>username</value>\n    </property>\n    <property name=\"password\">\n      <value>password</value>\n    </property>\n    <property name=\"maxActive\">\n      <value>20</value>\n    </property>\n    <property name=\"maxIdle\">\n      <value>10</value>\n    </property>\n    <property name=\"maxWait\">\n      <value>120000</value>\n    </property>\n    <property name=\"testWhileIdle\">\n      <value>true</value>\n    </property>\n    <property name=\"validationQuery\">\n      <value>select 1</value>\n    </property>\n\n    <property name=\"poolPreparedStatements\">\n      <value>true</value>\n    </property>\n  </bean>\n\n</beans>\n\n\nIn case it might be relevant, I post JMS object messages concurrently from some Tomcat HTTP processor threads with 100 concurrent users and at the same time I have a message driven POJO consuming messages from the same persistent queue, in the same tomcat, in a different Tomcat context. Both use the same JMS connection factory configuration:\n\n  <Resource name=\"jms/MessagingGatewayJms\" auth=\"Container\"\n\ttype=\"org.activemq.ActiveMQConnectionFactory\"\n\tdescription=\"bla bla bla\"\n        factory=\"org.activemq.jndi.JNDIReferenceFactory\"\n\tbrokerURL=\"reliable://tcp://localhost:61616\"\n\tuseAsyncSend=\"false\"/> \n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"254566","customfield_12312823":null,"summary":"Database Connection Leaks","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aioaneid","name":"aioaneid","key":"aioaneid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Aioanei","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aioaneid","name":"aioaneid","key":"aioaneid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Aioanei","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"java version \"1.5.0_04\"","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481950/comment/12936905","id":"12936905","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aioaneid","name":"aioaneid","key":"aioaneid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Aioanei","active":true,"timeZone":"Etc/UTC"},"body":"postgres has the follwing configuration:\n\nport = 5432\nmax_connections = 100\n\t# note: increasing max_connections costs about 500 bytes of shared\n\t# memory per connection slot, in addition to costs from shared_buffers\n\t# and max_locks_per_transaction.\n#superuser_reserved_connections = 2\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aioaneid","name":"aioaneid","key":"aioaneid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Daniel Aioanei","active":true,"timeZone":"Etc/UTC"},"created":"2005-09-22T16:01:38.000+0000","updated":"2005-09-22T16:01:38.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481950/comment/12936271","id":"12936271","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dub","name":"dub","key":"dub","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wendel Schultz","active":true,"timeZone":"Etc/UTC"},"body":"I find that if I run a process that floods the broker with messages I get the 'unable to get connection' errors.  Pretty much the same stack trace.  I have followed the source around and I am pretty much perplexed.  I'm updating a ton of data by sending many messages; it appears that I send enough messages to max out my db's (MySQL) configuration's max connections (100) before ActiveMQ can broker them all, resulting in this error.\n\nI am using ActiveMQ 3.1.\n\nI looked to the stack trace for clues.  From the stacktrace: JDBCMessageStore.addMessage() line 74ish (persistenceAdapter is a JDBCPersistenceAdapter ):\n...\n        // Get a connection and insert the message into the DB.\n        Connection c = null;\n        try {\n            c = persistenceAdapter.getConnection();            \n            adapter.doAddMessage(c, seq, messageID, destinationName, data, message.getJMSExpiration());\n        } catch (SQLException e) {\n            throw JMSExceptionHelper.newJMSException(\"Failed to broker message: \" + messageID + \" in container: \" + e, e);\n        } finally {\n        \tpersistenceAdapter.returnConnection(c);\n        }\n...\n\nAnd in JDBCPersistenceAdapter.getConnection() :\n...\npublic Connection getConnection() throws SQLException {\n        Connection answer = TransactionContext.peekConnection();\n        if (answer == null) {\n            answer = dataSource.getConnection();\n            answer.setAutoCommit(true);\n        }\n        return answer;\n    }\n...\n\nSo getting my connection from my DataSource is the problem.  I have configured my data source to be (as in the examples) a BasicDataSource:\n...\n    <persistence>\n          <jdbcPersistence dataSourceRef=\"mysql-ds\"\n                         adapterClass=\"org.activemq.store.jdbc.adapter.BlobJDBCAdaptor\"/>\n    </persistence>\n.\n.\n  <!-- The MYSQL Datasource that will be used by the Broker -->\n  <bean id=\"mysql-ds\"\n    class=\"org.apache.commons.dbcp.BasicDataSource\"\n    destroy-method=\"close\">\n    <property name=\"driverClassName\">\n      <value>com.mysql.jdbc.Driver</value>\n    </property>\n    <property name=\"url\">\n      <value>jdbc:mysql://jmsbox.wendel.gov/activemq</value>\n    </property>\n    <property name=\"username\">\n      <value>jms</value>\n    </property>\n    <property name=\"password\">\n      <value>debugging</value>\n    </property>\n    <property name=\"poolPreparedStatements\">\n      <value>true</value>\n    </property>\n    <property name=\"maxActive\">\n      <value>5</value>\n    </property>\n    <property name=\"maxIdle\">\n      <value>5</value>\n    </property>\n  </bean>\n...\n\nActiveMQ seems to spawn a thread for every message, similar to a servlet container spawning a new thread for every request.  If the message is persisted, that thread needs a db connection, which it acquires from the GenericObjectPool instance (commons-pool).  That instance can be configured to behave differently if all the resources have been exhausted; specifically it can block, grow or fail (WHEN_EXHAUSTED_FAIL, WHEN_EXHAUSTED_BLOCK, WHEN_EXHAUSTED_GROW) using GenericObjectPool.setWhenExhaustedAction( ... );\n\nThat instance is configured in BasicDataSource by creating a GenericObjectPool.createDataSource() using the default constructor then manually setting the pool's values from the configured values in the activemq.xml.  Nowhere is pool.setWhenExhaustedAction(..) called.  This is because the default constructor sets its default: DEFAULT_WHEN_EXHAUSTED_ACTION, which is statically defined as WHEN_EXHAUSTED_BLOCK.  This is the behavior I desire.\n\nFollowing the stack trace's recommendation, I looked at GenericObjectPool.borrowObject() around line 730.  This seems to happen because of one of two reasons:  either ActiveMQ's maxActive is set to indefinite (<=0) or I misbehave when my resources run out (_whenExhaustedAction):\n...\n// check if we can create one\n// (note we know that the num sleeping is 0, else we wouldn't be here)\nif(_maxActive <= 0 || _numActive < _maxActive) {\n// allow new object to be created\n} else {\n  // the pool is exhausted\n  switch(_whenExhaustedAction) {\n    case WHEN_EXHAUSTED_GROW:\n      // allow new object to be created\n      break;\n    case WHEN_EXHAUSTED_FAIL:\n      throw new NoSuchElementException();\n    case WHEN_EXHAUSTED_BLOCK:\n      try {\n        if(_maxWait <= 0) {\n          wait();\n        } else {\n          wait(_maxWait);\n        }\n      } catch(InterruptedException e) {\n        // ignored\n      }\n...\n\nI understand this to mean that when I run out of resources, I'll block until one is freed.  So I looked into configuration of maxActive.  I am clearly stating that I want a maxActive of 5 in my activemq.xml, and the code explicitly states that it uses the value configured by Spring beans.\n\nFrom the above discussion, I have absolutely NO idea why ActiveMQ is behaving the way it is.  It seems to indefinitely make database connections without regard for configuration, unless I'm missing something.  I'll admit that I'm not sure what the destroy-method=\"close\" means (I assume it tells the pool how to return resources), but it DOES appear that no restrictive pooling is taking place.\n\nWhat kind of help can anyone offer?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dub","name":"dub","key":"dub","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wendel Schultz","active":true,"timeZone":"Etc/UTC"},"created":"2005-10-14T01:14:53.000+0000","updated":"2005-10-14T01:14:53.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481950/comment/12937289","id":"12937289","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dub","name":"dub","key":"dub","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wendel Schultz","active":true,"timeZone":"Etc/UTC"},"body":"Also, I can reproduce this pretty regularly.  I'm not sure specifically what the threshold of messages/minute is, but enough to where I have sent the max db connection number of messages in the time it takes to broker one message, yielding the Exception.\n\nThat is my guess anyway.  FWIW.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dub","name":"dub","key":"dub","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wendel Schultz","active":true,"timeZone":"Etc/UTC"},"created":"2005-10-14T01:16:48.000+0000","updated":"2005-10-14T01:16:48.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481950/comment/12937142","id":"12937142","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dub","name":"dub","key":"dub","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wendel Schultz","active":true,"timeZone":"Etc/UTC"},"body":"Is this related to AMQ-377 ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dub","name":"dub","key":"dub","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wendel Schultz","active":true,"timeZone":"Etc/UTC"},"created":"2005-10-14T01:36:52.000+0000","updated":"2005-10-14T01:36:52.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481950/comment/12937278","id":"12937278","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dub","name":"dub","key":"dub","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wendel Schultz","active":true,"timeZone":"Etc/UTC"},"body":"I have found a workaround bypassing debugging.\n\nI plugged in c3p0 as my connection pooler and my connections are properly throttled; no more 'connection not available' exceptions.  Here is the configuration I used in activemq.xml.  Again, I'm using MySQL.  ActiveMQ now behaves properly.\n\nBe sure to include in c3p0.jar lib/optional/.  I am using c3p0-0.8.4.5.jar.  By default, c3p0 defaults to 3 minimum connectionts, max of 15 which is reasonable.  I changed them here to see that it is actually configuring the way I want.  It is.  c3p0 is super easy to use and apparantly works pretty well.\n\nBetter than commons-dbcp/commons-pool in any case.  I feel this is a bug in either pool or dbcp relinquishing resources properly.\n\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE beans PUBLIC  \"-//ACTIVEMQ//DTD//EN\" \"http://activemq.org/dtd/activemq.dtd\">\n<beans>\n\n  <!-- ==================================================================== -->\n  <!-- ActiveMQ Broker Configuration -->\n  <!-- ==================================================================== -->\n  <broker name=\"AMQBroker\">\n    <connector>\n      <tcpServerTransport uri=\"tcp://messaging.wendel.gov:61616\" backlog=\"1000\" useAsyncSend=\"true\" maxOutstandingMessages=\"50\"/>\n    </connector>\n\n    <persistence>\n          <jdbcPersistence dataSourceRef=\"mysql-ds\"\n                         adapterClass=\"org.activemq.store.jdbc.adapter.BlobJDBCAdaptor\"/>\n    </persistence>\n  </broker>\n\n  <!-- ==================================================================== -->\n  <!-- JDBC DataSource Configurations -->\n  <!-- ==================================================================== -->\n  <!-- The MYSQL Datasource that will be used by the Broker -->\n  <bean id=\"mysql-ds\"\n        class=\"com.mchange.v2.c3p0.ComboPooledDataSource\"\n        destroy-method=\"close\">\n    <property name=\"driverClass\">\n      <value>com.mysql.jdbc.Driver</value>\n    </property>\n    <property name=\"jdbcUrl\">\n      <value>jdbc:mysql://jms.wendel.gov/activemq</value>\n    </property>\n    <property name=\"user\">\n      <value>wendel</value>\n    </property>\n    <property name=\"password\">\n      <value>go-c3p0!</value>\n    </property>\n    <property name=\"minPoolSize\">\n      <value>6</value>\n    </property>\n    <property name=\"maxPoolSize\">\n      <value>18</value>\n    </property>\n    <property name=\"acquireIncrement\">\n      <value>3</value>\n    </property>\n  </bean>\n</beans>","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dub","name":"dub","key":"dub","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Wendel Schultz","active":true,"timeZone":"Etc/UTC"},"created":"2005-10-14T20:15:17.000+0000","updated":"2005-10-14T20:15:17.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481950/comment/12937493","id":"12937493","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dflores","name":"dflores","key":"dflores","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Darwin Flores","active":true,"timeZone":"Etc/UTC"},"body":"I simulated the scenario in AMQ-377, which is to create connection for consumers and close. This process is repeated for 200 times, and no error/exception was generated. I used the latest build of amq-4.0 and postgresql-8.0.3","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dflores","name":"dflores","key":"dflores","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Darwin Flores","active":true,"timeZone":"Etc/UTC"},"created":"2006-01-11T09:56:22.000+0000","updated":"2006-01-11T09:56:22.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481950/comment/12937366","id":"12937366","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"closing since we cannot reproduce, and a possible work around has been reported in case someone else can reproduce.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-01-15T00:16:50.000+0000","updated":"2006-01-15T00:16:50.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481950/comment/12938746","id":"12938746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cwbrandon","name":"cwbrandon","key":"cwbrandon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chad Brandon","active":true,"timeZone":"Etc/UTC"},"body":"The bug apparents to be in commons-dbcp (I'm seeing the issue myself), it occurs when you set  <property name=\"poolPreparedStatements\" value=\"true\"/> (if you remove it or set to false, dbcp correctly keeps the connecton count to the maxActive setting), ActiveMQ guys you might want to remove this \"poolPreparedStatements\" setting from your MySQL datasource examples (that's the reason I had it there in the first place).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cwbrandon","name":"cwbrandon","key":"cwbrandon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chad Brandon","active":true,"timeZone":"Etc/UTC"},"created":"2007-02-14T01:45:29.708+0000","updated":"2007-02-14T01:45:29.708+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-368/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i17yjj:"}}