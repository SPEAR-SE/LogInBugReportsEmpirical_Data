{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481422","self":"https://issues.apache.org/jira/rest/api/2/issue/12481422","key":"AMQ-443","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315610","id":"12315610","name":"4.0","archived":false,"released":true}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2006-06-15T10:47:20.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jun 15 19:42:11 UTC 2006","customfield_12310420":"49121","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_15687878000_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2006-06-15T10:47:21.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-443/watchers","watchCount":0,"isWatching":false},"created":"2005-12-15T21:02:43.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315602","id":"12315602","name":"3.2","archived":false,"released":true},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315603","id":"12315603","name":"3.2.1","archived":false,"released":true}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-06-15T19:42:11.000+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The current implementation of KeepAliveDaemon.java will sometimes force disconnections on well behaved connections.  The problem may arrise if there is a connection which goes away, and the KeepAlive send to that channel blocks while attempting to reconnect.  If this reconnection takes a while, then other channels that were responding fine may get their connections broken.  This happens due to the following code in KeepAliveDaemon.java:\n\n\t\tif ((channel.getLastReceiptTimestamp() + channel.getKeepAliveTimeout() * 2) < System.currentTimeMillis()) {\nor\n\t\t} else if ((channel.getLastReceiptTimestamp() + channel.getKeepAliveTimeout()) < System.currentTimeMillis()) {\n\nThe fact that the receipt timestamp is checked against System.currentTimeMillis() causes the code to break otherwise good connections.  If a KeepAlive send (in examineChannel) for a broken channel takes longer than some good channel's KeepAliveTimeout, then the good connection gets broken.\n\nThis can, in turn, cause some pretty bad behavior in the Broker.  While testing and diagnosing this problem, I could some brokers in a network of brokers stuck.  The sequence of events during recovery, which get interrupted due to closing the connections, would sometimes lead to the broker hanging waiting for a receipt, such as during an addConsumer (which eventually calls syncSendWithReceipt).\n\nI have redone the logic in KeepAliveDaemon.java (which required a small change to ReliableTransportChannel as well).  This now seems to work.\n\nI'm a bit concerned about the blocking calls, though.  This may be a different issue / bug.  I thought it looked like there was a mechanism to cancel outstanding receipt waiters - but, every once in a while that mechanism would not get called.  This results in the broker basically getting stuck, and does not ever really recover.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460715","id":"12460715","filename":"ASF.LICENSE.NOT.GRANTED--KeepAliveDaemon.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"created":"2005-12-15T21:02:43.000+0000","size":9207,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460715/ASF.LICENSE.NOT.GRANTED--KeepAliveDaemon.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460613","id":"12460613","filename":"ASF.LICENSE.NOT.GRANTED--ReliableTransportChannel.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"created":"2005-12-15T21:02:43.000+0000","size":9655,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460613/ASF.LICENSE.NOT.GRANTED--ReliableTransportChannel.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"254611","customfield_12312823":null,"summary":"ReliableTransport / KeepAlive algorithm does not work properly.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Solaris 8 / 10.  JDK 1.5","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481422/comment/12938200","id":"12938200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"4.0 Has implemented a more robust keepalive solution.  KeepAlive packets are only sent when the transport has been idle.  Also, while the transport is performing a blocking opperation it is not considered idle.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2006-06-15T10:47:20.000+0000","updated":"2006-06-15T10:47:20.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481422/comment/12937969","id":"12937969","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"body":"Yes - and so far the 4.0 approach is working very well in this respect.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"created":"2006-06-15T19:42:11.000+0000","updated":"2006-06-15T19:42:11.000+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-443/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i17ytj:"}}