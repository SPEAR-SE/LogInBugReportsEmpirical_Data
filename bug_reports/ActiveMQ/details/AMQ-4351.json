{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12634386","self":"https://issues.apache.org/jira/rest/api/2/issue/12634386","key":"AMQ-4351","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-02-28T13:37:21.548+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Apr 26 22:52:15 UTC 2013","customfield_12310420":"314879","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1135397177_*|*_5_*:*_2_*:*_3901460011_*|*_4_*:*_1_*:*_20221894","customfield_12312321":null,"resolutiondate":"2013-04-26T22:52:15.253+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4351/watchers","watchCount":6,"isWatching":false},"created":"2013-02-27T10:07:36.200+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["patch"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-04-26T22:52:15.280+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We started using durable subscribers a week ago, and after the 4th durable subscriber unsubscribed (due to 1 hour inactivity), the system deadlocked. If the \"Durable Subscriber Cleanup Timer\" goes of at the wrong time, your entire server locks up. \n\nSetup: \nActive MQ 5.7.0 with master/slave using JDBC store \nApprox 3 - 5 concurrent durable subscribers \nApprox 5 messages / sec \n\nActive MQ checks every 1 minute for subscribers which have been offline for 1 hour. \n\nLocked threads: \n\"ActiveMQ Transport: tcp:///79.125.71.104:48082@8090\": \n        at org.apache.activemq.broker.region.Topic.doMessageSend(Topic.java:446) \n        - waiting to lock <0x00000000c6228480> (a org.apache.activemq.broker.region.Topic) \n        at org.apache.activemq.broker.region.Topic.send(Topic.java:427) \n        at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:407) \n        at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:503) \n\n\n\"ActiveMQ Transport: tcp:///79.125.71.104:47590@8090\": \n        at org.apache.activemq.broker.region.PrefetchSubscription.add(PrefetchSubscription.java:142) \n        - waiting to lock <0x00000000c66ba050> (a java.lang.Object) \n        at org.apache.activemq.broker.region.DurableTopicSubscription.add(DurableTopicSubscription.java:243) \n        at org.apache.activemq.broker.region.policy.StrictOrderDispatchPolicy.dispatch(StrictOrderDispatchPolicy.java:58) \n\n\n\"ActiveMQ Durable Subscriber Cleanup Timer\": \n        at org.apache.activemq.broker.region.Topic.deactivate(Topic.java:288) \n        - waiting to lock <0x00000000c6250670> (a java.util.concurrent.CopyOnWriteArrayList) \n        at org.apache.activemq.broker.region.DurableTopicSubscription.deactivate(DurableTopicSubscription.java:184) \n        - locked <0x00000000c66ba060> (a java.lang.Object) \n        - locked <0x00000000c66ba050> (a java.lang.Object) \n        at org.apache.activemq.broker.region.Topic.deleteSubscription(Topic.java:195) \n        at org.apache.activemq.broker.region.TopicRegion.removeSubscription(TopicRegion.java:199) \n        at org.apache.activemq.broker.region.TopicRegion.doCleanup(TopicRegion.java:99) \n\n\nI have attached a patch which fixes the problem.\nSince there is only one dispatch policy per Topic, synchronisation can happen on the DispatchPolicy instead of on the consumers object which causes the deadlock.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12571413","id":"12571413","filename":"ActiveMQUnsubscribeTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frederikcolardyn","name":"frederikcolardyn","key":"frederikcolardyn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Frederik Colardyn","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-28T14:13:37.733+0000","size":6132,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12571413/ActiveMQUnsubscribeTest.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12571177","id":"12571177","filename":"dispatcher.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlammens","name":"tlammens","key":"tlammens","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Lammens","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-27T10:08:47.128+0000","size":765,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12571177/dispatcher.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"315223","customfield_12312823":null,"summary":"Deadlock when unsubscribing durable subscriber","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlammens","name":"tlammens","key":"tlammens","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Lammens","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tlammens","name":"tlammens","key":"tlammens","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Lammens","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Setup: \nActive MQ 5.7.0 with master/slave using JDBC store \nApprox 3 - 5 concurrent durable subscribers \nApprox 5 messages / sec ","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12634386/comment/13589535","id":"13589535","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@Tim, thanks for the report and patch. Is there any chance you could provide a unit test that can demonstrate so that we can protect the change?\n\nMy suspicion is that the cleanup safety should not come down to sync on the consumers list, but should be handled at a higher level.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-28T13:37:21.548+0000","updated":"2013-02-28T13:37:21.548+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12634386/comment/13589553","id":"13589553","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frederikcolardyn","name":"frederikcolardyn","key":"frederikcolardyn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Frederik Colardyn","active":true,"timeZone":"Etc/UTC"},"body":"Hi Gary,\n\nIt's easy to reproduce, and we've got a unit test for it (see attach), but it's not very well suited to include in an automated build system as it produces high load over Â± 4 minutes in order to trigger the deadlock. It's reliable though, always deadlocking without the patch.\n\nScenario:\n1. 100 durable consumers, of which 97 go inactive after receiving the first message\n2. producer sends messages as fast as possible\n3. after 3 minutes, broker tries to clean up the 97 inactive producers => always deadlocks. No more messages are being sent to the active produces. kill -3 of the jms broker always shows the same deadlock.\n\nWe took 100 durable consumers in our test in order to provoke the deadlock quickly, but in our production system it occurred with only 4 consumers (of which 1 was cleaned up after 1 hour inactivity).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=frederikcolardyn","name":"frederikcolardyn","key":"frederikcolardyn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Frederik Colardyn","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-28T14:13:37.737+0000","updated":"2013-02-28T14:19:10.615+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12634386/comment/13590217","id":"13590217","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"I'm interesting in the issue.It seems the thread stack does not reveal the deadlock threads and the test is not an unit test as there are many special objects rather than pure AMQ objects.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-03-01T03:53:38.821+0000","updated":"2013-03-01T03:53:38.821+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12634386/comment/13599679","id":"13599679","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"Looks like Hiram fixed this one w/ r1455290. Can you verify the fix in the next nightly build?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2013-03-12T04:11:27.270+0000","updated":"2013-03-12T04:11:27.270+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12634386/comment/13600030","id":"13600030","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"I've fixed the dead lock and included a leaner vesion of the test case at: [commit|https://github.com/apache/activemq/commit/846cf7df3fdea5c27030ed77473aba3b5a4699aa]","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2013-03-12T13:30:53.347+0000","updated":"2013-03-12T13:30:53.347+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12634386/comment/13643041","id":"13643041","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Changes for this issue have affected the destination stats for Topics depending on whether keep durable subs active is true or not. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-04-26T17:15:13.354+0000","updated":"2013-04-26T17:15:13.354+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12634386/comment/13643338","id":"13643338","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Fixed the stats issue on trunk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-04-26T22:52:15.277+0000","updated":"2013-04-26T22:52:15.277+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4351/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1ic4f:"}}