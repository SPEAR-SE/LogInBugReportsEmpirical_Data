{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482187","self":"https://issues.apache.org/jira/rest/api/2/issue/12482187","key":"AMQ-1233","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"parent":{"id":"12482910","key":"AMQ-2274","self":"https://issues.apache.org/jira/rest/api/2/issue/12482910","fields":{"summary":"Setting keepAlive through URL does nothing","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315630","id":"12315630","description":"Issues that need to be reviewed - do we keep 'em or do we kick 'em? ","name":"NEEDS_REVIEW","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-11-20T19:58:16.899+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 25 23:23:45 UTC 2011","customfield_12310420":"41763","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_137253976949_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-08-25T23:23:45.480+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1233/watchers","watchCount":1,"isWatching":false},"created":"2007-04-20T09:17:28.648+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[{"id":"12334955","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12334955","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"12482114","key":"AMQ-1156","self":"https://issues.apache.org/jira/rest/api/2/issue/12482114","fields":{"summary":"option \"wireFormat.tcpNoDelayEnabled=true\" is ignored","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-08-25T23:23:45.593+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"As you may know, there are some problems when setting options in the URI for a TransportConnector in the broker configuration file activemq.xml (at least for me when launching the console with the Main class and the start command).\nFor example, the option 'socket.tcpNoDelay=true' works fine in a producer or consumer URI, but doesn't make the broker have TCP_NODELAY sockets when it is set in the activemq.xml file.\n\nI think I have this more or less nailed down, I will try to explain.\nDuring all my explanation, I'm using the last source from SVN at the time of writing.\n\nLet's imagine you have the following piece of xml in your activemq.xml file:\n\n    <transportConnectors>\n      <transportConnector uri=\"tcp://localhost:61616?trace=true&foo=bar\"/>\n    </transportConnectors>\n\n(side note: i have not found in the documentation the need to use ' & a m p ;' in this file, instead of just '&' like in Java code, would be a nice addition for clueless people like myself)\n(side note 2: in the forum the & a m p ; appears as just &, but you have to write '& a m p ;' without the spaces of course).\n\nHow do these options get processed? Well at some point the method 'org.apache.activemq.transport.tcp.TcpTransportFactory.doBind' gets executed.\n\n    public TransportServer doBind(String brokerId, final URI location) throws IOException {\n        try {\n            Map options = new HashMap(URISupport.parseParamters(location));\n\nWe now have a nice HashMap with our options: {trace=true, foo=bar}\n\n            ServerSocketFactory serverSocketFactory = createServerSocketFactory();\n            TcpTransportServer server = createTcpTransportServer(location, serverSocketFactory);\n            server.setWireFormatFactory(createWireFormatFactory(options));\n            IntrospectionSupport.setProperties(server, options);\n\n'IntrospectionSupport.setProperties' is a method who uses reflexion to find the setter methods of a class, and if there is a setter method with the same name as a key of our HashMap, sets the value.\nThe 'doBind' method finishes wish\n\n            Map transportOptions = IntrospectionSupport.extractProperties(options, \"transport.\");\n            server.setTransportOption(transportOptions);\n            server.bind();\n           \n            return server;\n        }\n        catch (URISyntaxException e) {\n            throw IOExceptionSupport.create(e);\n        }\n    }\n\nThis is what happens when you start the broker.\nNow, what happens when a client connects and the broker has to create a Transport object for the connection?\nThe method org.apache.activemq.transport.tcp.TcpTransportServer.run() gets executed:\n\n    [some stuff]\n                        HashMap options = new HashMap();\n                        options.put(\"maxInactivityDuration\", new Long(maxInactivityDuration));\n                        options.put(\"minmumWireFormatVersion\", new Integer(minmumWireFormatVersion));\n                        options.put(\"trace\", new Boolean(trace));\n                        options.putAll(transportOptions);\n                        WireFormat format = wireFormatFactory.createWireFormat();\n                        Transport transport = createTransport(socket, format);\n                        Transport configuredTransport = transportFactory.serverConfigure(transport, format, options);\n                        getAcceptListener().onAccept(configuredTransport);\n    [more stuff]\n\nAs you see this method constructs a new HashMap options object, which is used to configure the Transport with the line:\n                        Transport configuredTransport = transportFactory.serverConfigure(transport, format, options);\nIf you have a look at this method, you will see that after a call to another method, the properties of the Transport are set again with 'IntrospectionSupport.setProperties'.\n\nSo what's the problem? The problem is that for the properties to be recognized, they have to be declared as setters in 2 classes. In this case, TcpTransport and TcpTransportServer.\nWhen a property is set in the connection URI of a client, the ActiveMQ classes don't use TcpTransportServer. They directly set the options on the TcpTransport.\nHowever in a broker, the execution path goes through the TcpTransportServer class. If the options don't have setters declared, and are not later put into the 'options' object in the The method 'org.apache.activemq.transport.tcp.TcpTransportServer.run()' method, the Transport created by the broker does not have these options set.\n\nIn our example, trace=true will be recognized but not foo=bar.\n\nIf you have a look at the TcpTransportServer class, you will see that the only options accepted are:\n-maxInactivityDuration\n-minmumWireFormatVersion (small mispelling btw)\n-trace\n-transport.* options\n\nFurthermore, the way things work, if you put another option on the URI, it will be silently ignored. You can put 'foo=bar' or 'socket.tcpNoDelay=true' and no error message appears. So people may have been using options and thinking they had no effect, where in fact they were ignored without warning, like in the TCP_NODELAY case.\n\nI don't know how the ActiveMQ devs want to design this class, but I see 2 solutions:\n-manually add the missing options to TcpTransportServer, and update the docs so that they are synchronized with the actual options that have to be used (like socket.tcpNoDelay=true instead of wireFormat.tcpNoDelayEnabled=true).\n-somehow eliminate the double IntrospectionSupport.setProperties usage, and pass the options directly to the TcpTransport class. This will save the need to remember to put options in 2 classes every time one is added. And of course, there is still the need to keep the docs synchronized... :)\n\nIf you want to reproduce my analysis, I used Eclipse, executing ActiveMQ source using the console Main class, in debug mode, and using breakpoints in the methods above mentioned.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59861","customfield_12312823":null,"summary":"Bug when setting transportConnector URI options in activemq.xml","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davidmc","name":"davidmc","key":"davidmc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Martín Clavo","active":true,"timeZone":"Etc/UTC"},"subtasks":[{"id":"12482114","key":"AMQ-1156","self":"https://issues.apache.org/jira/rest/api/2/issue/12482114","fields":{"summary":"option \"wireFormat.tcpNoDelayEnabled=true\" is ignored","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davidmc","name":"davidmc","key":"davidmc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Martín Clavo","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482187/comment/12936411","id":"12936411","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davidmc","name":"davidmc","key":"davidmc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Martín Clavo","active":true,"timeZone":"Etc/UTC"},"body":"This bug is most probably the reason why the option \"wireFormat.tcpNoDelayEnabled=true\" is still ignored in the broker's activemq.xml file.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davidmc","name":"davidmc","key":"davidmc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Martín Clavo","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-13T07:24:05.593+0000","updated":"2007-06-13T07:24:05.593+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482187/comment/12936446","id":"12936446","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davidmc","name":"davidmc","key":"davidmc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Martín Clavo","active":true,"timeZone":"Etc/UTC"},"body":"Also, I think this bug / problem should be given a higher priority, since it affects the ActiveMQ-CPP people.\nActiveMQ-CPP was recently updated so that the c++ client's sockets could have TCP_NODELAY set to true.\nBut that's not 100% useful if the ActiveMQ broker's sockets cannot have TCP_NODELAY set to true (unless you hack the code to make all sockets have TCP_NODELAY=true).\nIn my description, I already describe where I think the problem i. I don't want to write a patch myself since it would imply changing the insides of the code and I don't know how you guys would like it to be done.\n\nJust my 2 cents...\n\nDavid","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davidmc","name":"davidmc","key":"davidmc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Martín Clavo","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-13T08:00:59.450+0000","updated":"2007-06-13T08:00:59.450+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482187/comment/12941851","id":"12941851","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bsnyder","name":"bsnyder","key":"bsnyder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bruce Snyder","active":true,"timeZone":"America/Denver"},"body":"This appears to be fixed by AMQ-1156, no? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bsnyder","name":"bsnyder","key":"bsnyder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bruce Snyder","active":true,"timeZone":"America/Denver"},"created":"2009-11-20T19:58:16.899+0000","updated":"2009-11-20T19:58:16.899+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482187/comment/13091412","id":"13091412","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Appears to be fixed, reopen with test case if its still an issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-08-25T23:23:45.518+0000","updated":"2011-08-25T23:23:45.518+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1233/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0am5b:"}}