{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482281","self":"https://issues.apache.org/jira/rest/api/2/issue/12482281","key":"AMQ-1244","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-06-12T08:25:45.711+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jun 19 22:45:43 UTC 2008","customfield_12310420":"84578","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_35050357401_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-06-19T22:45:43.087+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1244/watchers","watchCount":0,"isWatching":false},"created":"2007-05-11T06:33:05.686+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315614","id":"12315614","description":"","name":"4.1.1","archived":false,"released":true,"releaseDate":"2007-06-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-06-19T22:45:43.087+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The current implementation of the JDBC Master/Slave feature makes one broker (the master) acquire a lock on a database object. In Sybase, this has been implemented with the command:\n\nLOCK TABLE foo IN EXCLUSIVE MODE\n\nThis command can only be executed within a transaction, see:\nhttp://manuals.sybase.com/onlinebooks/group-as/asg1250e/sqlug/@Generic__BookTextView/54552;pt=54651\n\nThis implies that for the whole lifespan of the ActiveMQ-process there is an open transaction in the RDBMS. This is a problem in a professional environment making use of a database replication server: The open transaction impedes that the transaction log in the active database is emptied, then the stable queue at the replication server won't be purged and will steadily grow up to infinitum. We have been able to observe this behaviour.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"233344","customfield_12312823":null,"summary":"DatabaseLocker implementation impedes database replication","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marsangr","name":"marsangr","key":"marsangr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcos Sanz","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marsangr","name":"marsangr","key":"marsangr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcos Sanz","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Latest ActiveMQ snapshot, Sybase ASE 12.5.x","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482281/comment/12936484","id":"12936484","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"A few thoughts. Firstly note that this locking transaction never updates any data and never needs to be replicated.\n\nCouldn't the replication server just ignore the lock table? Or we could allow the lock table to be in a different schema (logical database) if that helps?\n\nThere needs to be some table used for locking; as we need to ensure multiple brokers don't write to the same logical database. Though by all means suggest a suitable workaround that works for you with database replication; would ignoring the table, or moving it to a separate logical database/schema work?\n\nWorst case scenario; we could use a completely separate database entirely (even a different JDBC provider! :) but I'd rather reuse the same DataSource if we can (it makes things much simpler to code and removes a multitude of possible issues such as folks using a local Derby DB for the lock :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-12T08:25:45.711+0000","updated":"2007-06-12T08:25:45.711+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482281/comment/12936334","id":"12936334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marsangr","name":"marsangr","key":"marsangr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcos Sanz","active":true,"timeZone":"Etc/UTC"},"body":"Our DBAs confirm that configuring the replication server to ignore the lock-table is a possible workaround with our system. This might be manufacturer-dependent. Using a lock table in a different logical database (not to be replicated) is another possible solution.\n\nWouldn't it though be easier and much more portable to actually insert a (dummy) row in the lock-table as the inter-broker communication mechanism? This wouldn't require a transaction to be kept open for the whole lifetime of the broker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marsangr","name":"marsangr","key":"marsangr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcos Sanz","active":true,"timeZone":"Etc/UTC"},"created":"2007-07-03T12:00:22.937+0000","updated":"2007-07-03T12:00:22.937+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482281/comment/12936378","id":"12936378","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"The idea of keeping the transaction open is to keep a lock; so that if the connection/transaction fails, the broker stops being the master, then all the brokers fight to get the lock again.\n\nInserting a row in a database doesn't really help; if the master dies; how do the slaves know?\n\nIf you can come up with a workable alternative I'm all ears. (Especially if its with [a patch|http://activemq.apache.org/contributing.html] :) but until then, I think the long transaction is the only real alternative we have. \n\nYou could experiement with the SQL (the Statements class)  so that the lock table is named to be in a different logical database; yet using the same DataSource .\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2007-07-03T14:51:51.392+0000","updated":"2007-07-03T14:51:51.392+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482281/comment/12936381","id":"12936381","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marsangr","name":"marsangr","key":"marsangr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcos Sanz","active":true,"timeZone":"Etc/UTC"},"body":"I assume that the only communication channel that two brokers have in common is the database. What about leveraging on the usual concept of a heartbeat? Let the Lock-Table have a datetime row and let the active broker update periodically the row with the current (database) time. If the standby broker detects that the row value diverges from the current time more than a delta, then the active broker is stalled/dead. Advantages of this technique:\na) No transaction kept open for an undetermined time window\nb) To my eyes, this is even more effective in detecting a failure that the current mechanism, for it requires now the active broker to actually undertake an action,and not just remain inactive holding a token.\n\nComments?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marsangr","name":"marsangr","key":"marsangr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcos Sanz","active":true,"timeZone":"Etc/UTC"},"created":"2007-07-04T08:57:18.359+0000","updated":"2007-07-04T08:57:18.359+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482281/comment/12939867","id":"12939867","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jasonrtheune","name":"jasonrtheune","key":"jasonrtheune","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason R. Theune","active":true,"timeZone":"Etc/UTC"},"body":"We have addressed an issue mentioned in TS-1244 with a snippet of code.\nWe would like to contribute our fix to the ActiveMQ 5.2 code base for consideration for permanent inclusion.\n\nThis fix has proven out in our customer environment, and our customer is happy with the code.\nWe would now like to be sure our fix gets into the main branch so we do not have to patch a one off version with every release.\n\nAny chance in getting this patch accepted to the community through any channel that works?  \nThe fix is fairly simple in that it basically does what James Strachan suggests in the ticket...\n   (i.e., optionally use a different data source for the lock).  \n\nThis code change is submitted by Jason Theune on behalf of Rod Cope.\n\nHere's the changed and added code in JDBCPersistenceAdapter.java:\n ======================================================\n    // Added by Rod Cope of OpenLogic to allow the lock table to\n    // reside in a separate database.  This makes sure that the\n    // main database's transaction logs don't fill up because\n    // the ActiveMQ lock transaction never closes.\n    private DataSource lockDataSource;\n \n    // Modified by Rod Cope of OpenLogic to allow the lock table to\n    // reside in a separate database.  This makes sure that the\n    // main database's transaction logs don't fill up because\n    // the ActiveMQ lock transaction never closes. \n    protected DatabaseLocker createDatabaseLocker() throws IOException {\n        return new DefaultDatabaseLocker(getLockDataSource(), getStatements());\n    }\n\n \n    // Added by Rod Cope of OpenLogic to allow the lock table to\n    // reside in a separate database.  This makes sure that the\n    // main database's transaction logs don't fill up because\n    // the ActiveMQ lock transaction never closes.\n    public DataSource getLockDataSource() throws IOException {\n        if (lockDataSource == null) {\n            lockDataSource = getDataSource();\n            if (lockDataSource == null) {\n                throw new IllegalArgumentException(\"No dataSource property has been configured\");\n            }\n        } else {\n            LOG.info(\"Using a separate dataSource for locking: \" + lockDataSource);\n        }\n        return lockDataSource;\n    }\n    // Added by Rod Cope of OpenLogic to allow the lock table to\n    // reside in a separate database.  This makes sure that the\n    // main database's transaction logs don't fill up because\n    // the ActiveMQ lock transaction never closes.\n    public void setLockDataSource(DataSource dataSource) {\n        this.lockDataSource = dataSource;\n    }\n \nOf course, it's fine if they resolve the issue in some other way that makes sense and/or change any comments.  \nI'd just like to avoid having our customer on a forked version because support efforts would be complicated.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jasonrtheune","name":"jasonrtheune","key":"jasonrtheune","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason R. Theune","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-19T18:17:54.647+0000","updated":"2008-06-19T18:17:54.647+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482281/comment/12939846","id":"12939846","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Fixed by SVN revision 669733","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-19T22:45:43.063+0000","updated":"2008-06-19T22:45:43.063+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1244/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14blz:"}}