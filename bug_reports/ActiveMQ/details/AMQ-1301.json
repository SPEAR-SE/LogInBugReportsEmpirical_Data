{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481909","self":"https://issues.apache.org/jira/rest/api/2/issue/12481909","key":"AMQ-1301","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-06-29T15:58:05.835+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Oct 23 18:40:46 UTC 2007","customfield_12310420":"84593","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_24692364179_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-04-10T06:42:59.912+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1301/watchers","watchCount":3,"isWatching":false},"created":"2007-06-29T11:43:35.733+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315615","id":"12315615","description":"","name":"4.1.2","archived":false,"released":true,"releaseDate":"2008-04-14"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-04-10T06:42:59.892+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When using a network of brokers, I get problems in the following scenario. Consider two brokers, broker1 and broker2, connected to eachother (see config below). Everything works ok: durable consumers on topics get messages sent to either server. The messages are all persistent.\n\nThe problems occur in this scenario:\n\n1. Bring down one of the brokers, let's say broker2 (all consumers and producers connect to the other server, without any problems)\n2. Start the killed broker2 again\n3. The broker2 reconnects to the network as expected\n4. However, messages don't get propagated correctly on the network anymore. Consumers on broker1 don't get messages sent to broker2 anymore, and messages from broker2 get sent to broker1 over and over again. This can also be seen in the webconsole for example, where the number of messages in the queue grows rapidly.\n\nThe only way to fix this is to kill all brokers, and remove the persistent message stores. THis is unacceptable, since this loses messages.\n\nConfig is below:\n\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:util=\"http://www.springframework.org/schema/util\">\n \n <broker brokerName=\"broker1\" useJmx=\"true\" persistent=\"true\" xmlns=\"http://activemq.org/config/1.0\">\n  \n    <persistenceAdapter>\n        <journaledJDBC journalLogFiles=\"5\" dataDirectory=\"${activemq.base}/activemq-data\"/>\n    </persistenceAdapter>\n  \n    <transportConnectors>\n       <transportConnector name=\"openwire\" uri=\"tcp://localhost:61616\"/>\n       <transportConnector name=\"stomp\"   uri=\"stomp://localhost:61627\"/>\n    </transportConnectors>\n  \n<networkConnectors>\n\t\t<networkConnector name=\"ha-network\" uri=\"static://(tcp://localhost:61618)\" networkTTL=\"5\"/>\n</networkConnectors>\n</broker>\n\n\n\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n       xmlns:util=\"http://www.springframework.org/schema/util\">\n \n <broker brokerName=\"broker2\" useJmx=\"true\" persistent=\"true\" xmlns=\"http://activemq.org/config/1.0\">\n  \n    <persistenceAdapter>\n        <journaledJDBC journalLogFiles=\"5\" dataDirectory=\"${activemq.base}/activemq-data\"/>\n    </persistenceAdapter>\n  \n    <transportConnectors>\n       <transportConnector name=\"openwire\" uri=\"tcp://localhost:61618\"/>\n       <transportConnector name=\"stomp\"   uri=\"stomp://localhost:61628\"/>\n    </transportConnectors>\n  \n<networkConnectors>\n\t\t<networkConnector name=\"ha-network\" uri=\"static://(tcp://localhost:61616)\" networkTTL=\"5\"/>\n</networkConnectors>\n</broker>","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161929","customfield_12312823":null,"summary":"Problems with reconnecting broker to network of brokers after broker shutdown","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijsklont","name":"ijsklont","key":"ijsklont","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pieter","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijsklont","name":"ijsklont","key":"ijsklont","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pieter","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481909/comment/12936256","id":"12936256","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijsklont","name":"ijsklont","key":"ijsklont","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pieter","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, in the second config the journal dataDirectory should be \"${activemq.base}/activemq-broker2-data\".\n\nFor additional info, see this thread: http://www.nabble.com/Weird-problem-with-network-of-brokers-tf3964843s2354.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijsklont","name":"ijsklont","key":"ijsklont","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pieter","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-29T11:49:24.408+0000","updated":"2007-06-29T11:49:24.408+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481909/comment/12936205","id":"12936205","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"why is the network TTL=5 ? - It should be 1 - I think this could be your problem","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-29T15:58:05.835+0000","updated":"2007-06-29T15:58:05.835+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481909/comment/12936432","id":"12936432","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijsklont","name":"ijsklont","key":"ijsklont","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pieter","active":true,"timeZone":"Etc/UTC"},"body":"I've changed the networkTTL. It looks like it's running OK now, only I don't understand how this could be the problem. According to the documentation, this is the *maximum* number of brokers the message can travel through. I don't see how increasing it can result into duplicate messages (because that was which i was seeing). The number of messages in the topics rose quickly to ~ 30.000, even while I've sent only about 50 messages to the topic.\n\nThe problem is that I haven't found I reliable way to reproduce this behaviour, but I've seen it on a few occasions already. If I encounter it again (with TTL=1 settings), I'll report it here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijsklont","name":"ijsklont","key":"ijsklont","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pieter","active":true,"timeZone":"Etc/UTC"},"created":"2007-07-26T14:24:53.744+0000","updated":"2007-07-26T14:24:53.744+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481909/comment/12936367","id":"12936367","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijsklont","name":"ijsklont","key":"ijsklont","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pieter","active":true,"timeZone":"Etc/UTC"},"body":"Unfortunately I get the same behaviour again. I can't find a reliable way to restore a network of brokers after one broker is brought down, other than shutting down all brokers and removing the data directories.\n\nThis specific behaviour is perhaps a bug in the loop detection? I could image it gets a message from the broker, sees it as a new messages, and forwards it again to the other broker, ad infinitum. In any case, not being able to restore a network of brokers without problems makes the network practically useless.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ijsklont","name":"ijsklont","key":"ijsklont","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pieter","active":true,"timeZone":"Etc/UTC"},"created":"2007-07-26T15:07:52.222+0000","updated":"2007-07-26T15:07:52.222+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481909/comment/12939177","id":"12939177","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcusn","name":"marcusn","key":"marcusn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcus Nilsson","active":true,"timeZone":"Etc/UTC"},"body":"I get the same problem. Do we know why it is happening and is there a workaround?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcusn","name":"marcusn","key":"marcusn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcus Nilsson","active":true,"timeZone":"Etc/UTC"},"created":"2007-10-23T06:41:27.341+0000","updated":"2007-10-23T06:41:27.341+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481909/comment/12939180","id":"12939180","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcusn","name":"marcusn","key":"marcusn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcus Nilsson","active":true,"timeZone":"Etc/UTC"},"body":"Testcase demonstrating persistent message not forwarded. It uses a memory adapter as persistence. When the first broker restarts, it does not forward the persistent message to the other broker. I'm not sure it tests exactly the problem outlined in this issue, it might be that it is just a problem with reloading presistent messages, but it's a start.\n\n*Had an error, didn't close connections, so deleted testcase again*","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcusn","name":"marcusn","key":"marcusn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcus Nilsson","active":true,"timeZone":"Etc/UTC"},"created":"2007-10-23T07:23:58.859+0000","updated":"2007-10-23T14:49:20.920+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481909/comment/12939168","id":"12939168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcusn","name":"marcusn","key":"marcusn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcus Nilsson","active":true,"timeZone":"Etc/UTC"},"body":"Here is a theory. If this issue is the same as AMQ-961 then it could be that the following happens:\n\n* If there are persistent messages, maybe it takes some time for one of the brokers to start, making the transport interrupt.\n* If there are no persistent messages, both network connectors start reliably.\n\nIn any case, the fix to AMQ-961 (applied a bit after 4.1.1) will fix the problem, it will restart the bridge whenever the transport resumes.\n \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcusn","name":"marcusn","key":"marcusn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcus Nilsson","active":true,"timeZone":"Etc/UTC"},"created":"2007-10-23T18:40:46.443+0000","updated":"2007-10-23T18:41:43.270+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1301/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s2sn:"}}