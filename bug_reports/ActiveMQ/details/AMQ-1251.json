{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482177","self":"https://issues.apache.org/jira/rest/api/2/issue/12482177","key":"AMQ-1251","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-08-23T03:49:31.934+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 18 04:14:53 UTC 2007","customfield_12310420":"84454","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_7649266732_*|*_5_*:*_2_*:*_252294737_*|*_4_*:*_1_*:*_4839847500","customfield_12312321":null,"resolutiondate":"2007-10-18T04:14:53.042+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1251/watchers","watchCount":4,"isWatching":false},"created":"2007-05-23T16:58:04.073+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315613","id":"12315613","description":"","name":"4.1.0","archived":false,"released":true,"releaseDate":"2006-11-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-10-18T04:14:53.040+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have around 40 consumers taking messages from a single queue. After awhile 1 or 2 consumers stop receiveing any messages. Going to JMX and stopping corresponding connection causes re-connect and messages are delivered again.\n\nI reproduced it twice in QA enviroment and now it happened in production. I tried to instrument the code and set the log in debug, but that changed timing and I failed to reproduce it after the changes.\n\nI suspect that runtime association b/w Queue and Consumer objects is lost on the Broker side. \n\nOne of the suspects is the empty catch block in the RoundRobinDispatchPolicy (line 64) class. It is possible that the CopyOnWrite array list is messed up and it fails when removed consumer is added back. \n\nBTW CopyOnWrite list is good when you mostly read, but not so good when you write for every message delivery and empty catch blocks are bad in any case.\n\nif (firstMatchingConsumer != null) {\n      // Rotate the consumer list.\n      try {\n                consumers.remove(firstMatchingConsumer);\n                consumers.add(firstMatchingConsumer);\n      } catch (Throwable bestEffort) {\n      }\n}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460965","id":"12460965","filename":"QueueWorkerPrefetchTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2007-09-06T19:30:20.290+0000","size":8454,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460965/QueueWorkerPrefetchTest.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460648","id":"12460648","filename":"TestActiveMQ.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-08-27T23:49:25.629+0000","size":7344,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460648/TestActiveMQ.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461015","id":"12461015","filename":"TestActiveMQSyncReceive.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-05T01:58:36.536+0000","size":8141,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461015/TestActiveMQSyncReceive.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161730","customfield_12312823":null,"summary":"Broker stops delivering messages to some consumers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vpesochi","name":"vpesochi","key":"vpesochi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Pesochinskiy","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vpesochi","name":"vpesochi","key":"vpesochi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Pesochinskiy","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"WinXP","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12936323","id":"12936323","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vpesochi","name":"vpesochi","key":"vpesochi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Pesochinskiy","active":true,"timeZone":"Etc/UTC"},"body":"This issue now occurs on a very slow and busy machine after consumer gets a dozen of messages it stops getting others.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vpesochi","name":"vpesochi","key":"vpesochi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Pesochinskiy","active":true,"timeZone":"Etc/UTC"},"created":"2007-07-20T18:43:02.633+0000","updated":"2007-07-20T18:43:02.633+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12938595","id":"12938595","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Can you explain how this issue is resolved?  I see this issue still occurring with a svn checkout of trunk from yesterday (revision number 568479).  From what I can see, RoundRobinDispatchPolicy hasn't been changed as recommended by the author of this bug.\n\nWas there any code committed to fix this bug?  If so, what was it?\n\nI see exactly the same issue - after a while in my application, the consumers stop consuming messages, and I can confirm via JMX there are a couple of messages left in a persistent queue.  When I start up a new process which is a consumer for this queue, it immediately gets these messages, and the older consumers never receive any more, despite having subscriptions to the queue (as confirmed by JMX).\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-08-23T03:49:31.934+0000","updated":"2007-08-23T03:49:31.934+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12938680","id":"12938680","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"As noted by my previous comment - I still see this issue occurring, so I am re-opening this bug.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-08-23T03:50:45.538+0000","updated":"2007-08-23T03:50:45.538+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939035","id":"12939035","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vpesochi","name":"vpesochi","key":"vpesochi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Pesochinskiy","active":true,"timeZone":"Etc/UTC"},"body":"David, \n\nYou may be having a different issue though. If you have idle consumers some messages can be stack in the pre-fetch buffer. You can check this out by setting pre-fetch buffer to 0 for all consumer connections, but keep in mind that it does not work with asynchronous MessageListener interface. You have to call recieve*(*) methods for it to work. \n\nPre-fetch buffer is on the client / consumer JVM. Messages are pushed to the consumer until the buffer size is not exceeded. This is a performance solution, so if you are not getting 1000 msgs/sec you can pull messages from the queue with prefetchSize = 0.\n\nTo set prefetch size you can use this code or google amq site to figure out how to set it in connection URL.\n\n            ActiveMQConnectionFactory cf = new ActiveMQConnectionFactory(user, password, url);\n            cf.setPrefetchPolicy(getPrefetchPolicy());\n\n\nRegards.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vpesochi","name":"vpesochi","key":"vpesochi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vadim Pesochinskiy","active":true,"timeZone":"Etc/UTC"},"created":"2007-08-23T17:27:52.969+0000","updated":"2007-08-23T17:27:52.969+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12938993","id":"12938993","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Hi Vadim,\n\nI can't use the receive call, since my application uses the async MessageListener interface.  I posted on the activemq-user mailing list more detail on my application, with a unit test which demonstrates the issue.  http://www.nabble.com/Large-PendingQueueSize-values-for-subscriptions-on-a-queue-with-one-message-tf4316080s2354.html.\n\nI've attached a unit test which demonstrates the problem.  I tried to make the code as small as possible.\n\nIn this situation, the issue (program hangs) seems to happen when QUEUE_PREFETCH_SIZE == 1 and NUM_WORKERS = 2 (90% of the time).\nChanging NUM_WORKERS to 1 seems to make it work.\n\nIncreasing the QUEUE_PREFETCH_SIZE also seems to make things work.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-08-27T23:47:20.550+0000","updated":"2007-08-27T23:47:20.550+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939025","id":"12939025","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Example unit test which demonstrates the issue.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-08-27T23:49:25.813+0000","updated":"2007-08-27T23:49:25.813+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12938966","id":"12938966","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"this seems fixed - svn  revision 571150.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-08-30T12:56:41.093+0000","updated":"2007-08-30T12:56:41.093+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12937956","id":"12937956","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Thanks for that Rob, I'll try out the latest code soon.\n\nFollowing Vadim's advice, I restructured my application to use synchronous receives, and setting prefetchSize = 0 prevented the issue from occurring.  Setting it to a value of 1 or more in my application causes the issues of messages not being delivered.\n\nWhen I get some time soon, I'll update my activemq and let you know if your changes have indeed fixed the problems I am seeing for other prefetch sizes.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-03T02:21:02.869+0000","updated":"2007-09-03T02:21:02.869+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12938359","id":"12938359","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Hi Rob,\n\nI updated my activemq to 572492, but the problem still occurs when I run the unit test.  Not every time, but it still happens, around 75% of the time on the machine I am using.\n\nCan you not reproduce this on your end?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-04T05:11:27.566+0000","updated":"2007-09-04T05:11:27.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939060","id":"12939060","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Similar unit test to TestActiveMQ, except it has been rewritten to use synchronous receives, which is how my main application works now.\n\nI still get the unit test hanging about 50% of the time when the number of worker threads is 2 or more, and interestingly when the prefetch size is 0.  If the prefetch is set to 1 or more, then the program _seems_ to work.\n\nWhatever the problem is, both with this test and the previous one, there is some sort of race condition, since the program doesn't always hang.\n\nWhenever the program hangs, it seems the PendingQueueSize values for the queue subscriptions are very large, in fact when I add the values up from all worker queue subscriptions, it seems to equal the total number of messages which have been sent to the queue.\n\nWhen the program works, as expected, the PendingQueueSize on the subscriptions is 0.\n\nAny ideas what is wrong?  This is with checkout 572492 and built using mvn -Dmaven.test.skip=true clean install.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-05T01:58:36.681+0000","updated":"2007-09-05T01:58:36.681+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12937506","id":"12937506","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"To add a bit more potentially relevant information, I am running these unit tests under Vista, JDK 1.6.0_02 on a duo core machine.  Perhaps the fact it is running on duo core means it is exposing a race condition that may not be as easy to reproduce on a single core machine.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-05T06:31:47.944+0000","updated":"2007-09-05T06:31:47.944+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939007","id":"12939007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"In case it is hard for you to reproduce, here are the relevant statistics obtained using JMX when the unit test hangs after the first batch of 1000 messages are processed:\n\nFor the work-items queue (which has two worker thread consumers):\n\nConsumerCount: 2\nDequeueCount: 1000\nDispatchCount: 1000\nEnqueueCount: 1001\n\nThis makes sense - the 1001 enqueue count indicates the message the master has sent to the work-items queue to indicate to the workers to start processing the second batch of 1000 items, but for whatever reason, this message hasn't been dispatched to a worker.\n\nFor the two worker subscriptions on this queue, here are their stats:\n\nWorker 1:\n\nDequeueCounter: 998\nDispatchedCounter: 998\nDispatchedQueueSize: 0\nEnqueueCounter: 1001\nMaximumPendingMessageLimit: 0\nPendingQueueSize: 3\nPrefetchSize: 0\n\nWorker 2:\n\nDequeueCounter: 2\nDispatchedCounter: 2\nDispatchedQueueSize: 0\nEnqueueCounter: 1001\nMaximumPendingMessageLimit: 0\nPendingQueueSize: 998\nPrefetchSize: 0\n\nI can also confirm that all 3 threads (two workers, one master) and waiting in receive(), by dumping the thread stacks:\n\nat org.apache.activemq.MessageDispatchChannel.dequeue(MessageDispatchChannel.java:75)\n-locked <0x199c50d8> (a java.lang.Object)\nat org.apache.activemq.ActiveMQMessageConsumer.dequeue(ActiveMQMessageConsumer.java:405)\nat org.apache.activemq.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:453)\n\nLooking at the numbers, it really looks like a new message has been put into the queue, but hasn't been dispatched.\n\nIs there any more information you need apart from the above and the unit tests provided to squash this issue?\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-05T07:06:02.424+0000","updated":"2007-09-05T07:06:02.424+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939082","id":"12939082","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Attaching a version of the test case that does not seem to fail.  All I did was avoid some of the synchronization contention that the test case had by avoiding those big sychronization blocks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2007-09-06T19:30:20.444+0000","updated":"2007-09-06T19:30:20.444+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939066","id":"12939066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Hiram - thanks for your comment.  Your unit test confirms that what we are dealing with here is a race condition in the activemq code, somewhere.  Although the original unit tests do have excessive synchronization, it is not invalid code from what I can tell, and it should complete to the end.\n\nI started to have a little look at the activemq code under a debugger, and noticed the case when both workers are stuck, is when they have non-empty pending queues where all message references have dropped is true.  When the dispatcher sends the next message from the master, it is just added to both pending queues for the worker, and according to the logic I saw, it wasn't immediately dispatched since the pending queue was not empty.\n\nI tried pressing the gc() operation on various objects from JMX, but it didn't seem to clear out any of the messages.\n\nAt this stage - nothing seems to happen, the pending queues stay non-empty, and the new message is never delivered.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-06T21:27:46.504+0000","updated":"2007-09-06T21:27:46.504+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939013","id":"12939013","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"actually I spoke too soon.I ran it a few more times and it got stuck again.\n\nbut I think I have cornnered the cause of the problem and should have a fix soon.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2007-09-06T21:56:53.160+0000","updated":"2007-09-06T21:56:53.160+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12938392","id":"12938392","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Hi David,\n\nI think the issue is now resolved in the trunk version of activemq as of revision 573400.  If you get a chance could you double check it for me?? \n\n/Regards,\nHiram","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2007-09-06T22:22:15.507+0000","updated":"2007-09-06T22:22:15.507+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939000","id":"12939000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Hi Hiram,\n\nMany thanks for fixing this issue - all my unit tests now work, and my application runs far further than it used to - I suspect these problems are mine now :).\n\nI am curious though, your change to VMPendingMessageCursor makes sense in that isEmpty() need to ignore dropped messages.  Do we not need to make a similar change for other implementations of PendingMessageCursor, such as FilePendingMessageCursor and StoreQueueCursor?\n\nCheers,\nDavid\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-10T02:17:21.917+0000","updated":"2007-09-10T02:17:21.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939031","id":"12939031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Hi Hiram,\n\nIncidentally, https://issues.apache.org/activemq/browse/AMQ-1333 I believe was created as a clone of this bug, so that any fixes could be applied to the 4.1.X release.  Can/should your changes be applied to 4.1.X as well?\n\nCheers,\nDavid\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-10T03:42:25.706+0000","updated":"2007-09-10T03:42:25.706+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939070","id":"12939070","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=leguil2007","name":"leguil2007","key":"leguil2007","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"François Guillemette","active":true,"timeZone":"Etc/UTC"},"body":"Hi all, \n\nI have tried revision 574216 of activemq trunk. I'm still having a problem when I set the queue prefetch size to 1, when using a pure master slave configuration. Here what I have done:\n1. Start two brokers, one master, one slave (with shutdownIfMasterFailure set to false).\n2. Start one consumer (with prefetch set to 1), and with sleeptime = 5000 millisecond\n3. Start one producer (for example: 10 durable messages)\n4. After the consumer have consumed 1 or 2 messages, kill the master\n5. The consumer will eat only one message from the slave (and they are more message in the queue).\n\nIf the prefetch is not set, then the in step 5, the consumer will eat all the remaining messages.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=leguil2007","name":"leguil2007","key":"leguil2007","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"François Guillemette","active":true,"timeZone":"Etc/UTC"},"created":"2007-09-10T17:25:45.396+0000","updated":"2007-09-10T17:25:45.396+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939044","id":"12939044","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Hi Hiram,\n\nI have found an issue with your change I believe.  While running my code, I received the following exception:\n\n[ActiveMQ Task] 881755 ERROR org.apache.activemq.broker.region.Queue.worker-items - Failed to page in more queue messages \njava.lang.RuntimeException: not implemented\n\tat org.apache.activemq.broker.region.NullMessageReference.isDropped(NullMessageReference.java:47)\n\tat org.apache.activemq.broker.region.cursors.VMPendingMessageCursor.isEmpty(VMPendingMessageCursor.java:43)\n\tat org.apache.activemq.broker.region.PrefetchSubscription.add(PrefetchSubscription.java:119)\n\tat org.apache.activemq.broker.region.policy.RoundRobinDispatchPolicy.dispatch(RoundRobinDispatchPolicy.java:70)\n\tat org.apache.activemq.broker.region.Queue.doDispatch(Queue.java:1054)\n\tat org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1069)\n\tat org.apache.activemq.broker.region.Queue.iterate(Queue.java:940)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:118)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:42)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\n\nI can't look at the code where I am writing this from, but is this something easy to fix?  Thanks.\n\nCheers,\nDavid\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-09-20T11:30:00.415+0000","updated":"2007-09-20T11:30:00.415+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939023","id":"12939023","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"David,\n\nworked around that issue with the Runtime Exception\n\ncheers,\n\nRob","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-10-03T11:27:10.703+0000","updated":"2007-10-03T11:27:10.703+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939100","id":"12939100","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"body":"Hi Rob,\n\nThanks - I can confirm that I no longer see the following messages:\n\n\"java.lang.RuntimeException: not implemented\nat org.apache.activemq.broker.region.NullMessageReference.isDropped(NullMessageReference.java:47)\"\n\nNow I would mark this issue as resolved from my perspective, except I hadn't heard back from Hiram about one of my previous comments above:\n\n> Hi Hiram,\n> \n> Many thanks for fixing this issue - all my unit tests now work, and my application runs far further than it used to - I suspect these problems are mine now .\n>\n> I am curious though, your change to VMPendingMessageCursor makes sense in that isEmpty() need to ignore dropped messages. Do we not need to make a similar \n> change for other implementations of PendingMessageCursor, such as FilePendingMessageCursor and StoreQueueCursor?\n>\n> Cheers,\n> David","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sits","name":"sits","key":"sits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Sitsky","active":true,"timeZone":"Australia/Sydney"},"created":"2007-10-08T01:44:37.813+0000","updated":"2007-10-08T01:44:37.813+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939099","id":"12939099","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"It makes sense to update FilePendingMessageCursor.isEmpty() logic to check that nodes haven't been dropped from the in memory list it holds.\nHowever, the disk part of the list - or the StoreQueueCursor will not hold the same instance as used by the Queue - and persisted references aren't updated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-10-18T04:13:52.345+0000","updated":"2007-10-18T04:13:52.345+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482177/comment/12939062","id":"12939062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Update FilePendingMessageCursor.isEmpty() method to check for dropped message references in its in-memory list\nsvn revision: 585853","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-10-18T04:14:53.037+0000","updated":"2007-10-18T04:14:53.037+0000"}],"maxResults":24,"total":24,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1251/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s1kf:"}}