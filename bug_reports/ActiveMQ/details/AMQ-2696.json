{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483433","self":"https://issues.apache.org/jira/rest/api/2/issue/12483433","key":"AMQ-2696","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-04-15T08:42:40.262+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 19 14:55:18 UTC 2010","customfield_12310420":"74840","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_91639837_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-04-15T13:56:52.039+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2696/watchers","watchCount":1,"isWatching":false},"created":"2010-04-14T12:29:32.202+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315621","id":"12315621","description":"","name":"5.3.1","archived":false,"released":true,"releaseDate":"2010-03-23"}],"issuelinks":[{"id":"12339145","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12339145","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12483844","key":"AMQ-2956","self":"https://issues.apache.org/jira/rest/api/2/issue/12483844","fields":{"summary":"ActiveMQ broker fails to start due to java.lang.NullPointerException","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-05-17T21:29:18.415+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"org.apache.activemq.store.jdbcJDBCPersistenceAdapter.getLastMessageBrokerSequenceId() calls:\n\norg.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter:\n\nThe call to doGetLastMessageStoreSequenceId will return the max acks table id if the max msgs id is less.\n\nThe result is used to seed the sequenceGenerator:\n\nlong seq =  getAdapter().doGetLastMessageStoreSequenceId(c);\nsequenceGenerator.setLastSequenceId(seq);\n\nHowever the next call to set the brokerSeq variable will fail if the seq variable has been seeded with the max acks id, as 'doGetMessageById' expects a valid msgs id.\n\nlong brokerSeq = 0;\n            if (seq != 0) {\n            \tMessage last = (Message)wireFormat.unmarshal(new ByteSequence(getAdapter().doGetMessageById(c, seq)));\n            \tbrokerSeq = last.getMessageId().getBrokerSequenceId();\n            }\n            return brokerSeq;\n\nIf 'seq' is not a valid msgs id (I presume because the message has expired and/or been removed) then this causes a NullPointerException in ByteSequence, which is not caught, and this leads to a complete failure to start ActiveMQ.\n\nThe solution is not simple if the tables are in production, and is compounded even further by durable subscribers that cannot simply be deleted from the acks table.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"159806","customfield_12312823":null,"summary":"DefaultJDBCAdapter returns incorrect value that prevents ActiveMQ from starting.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Vista 64bit","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483433/comment/12942407","id":"12942407","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"body":"Also in trunk","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"created":"2010-04-15T06:33:46.643+0000","updated":"2010-04-15T06:33:46.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483433/comment/12942398","id":"12942398","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Andy,\n\njust wondering if you can create a test case that can reproduce the issue? Or this is something you encountered in production?\n\nRegards,\nDejan","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2010-04-15T08:42:40.262+0000","updated":"2010-04-15T08:42:40.262+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483433/comment/12942410","id":"12942410","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Dejan,\n\nIt's going to be difficult to create a test case, but is easy to reproduce if you have any JDBC adapter configured.\n\n<persistenceAdapter>\n<jdbcPersistenceAdapter dataSource=\"#postgresql-activemq-ds\">\n<adapter>\n<postgresql-jdbc-adapter/>\n</adapter>\n</jdbcPersistenceAdapter>\n</persistenceAdapter>\n\nJust change the DataSource database to an empty test database and let ActiveMQ create new empty tables.\n\nStop ActiveMQ.\n\nManually add one dummy row to the empty 'activemq_acks' table:\n\nINSERT INTO activemq_acks(container, sub_dest, client_id, sub_name, selector, last_acked_id) VALUES ('topic://a', 'topic://a', 'a', 'a', 'a', 555);\n\nStart ActiveMQ.\n\nIt will try to load message id 555 - which does not exist, and will drop a NullPointerException.\n\nThe code in doGetLastMessageStoreSequenceId uses Math.max(seq1, seq2) to determine the next sequence id, so this is then definitely not safe to use in getLastMessageBrokerSequenceId() to load a message by id.\n\nI suppose a test case using something like Derby could be created - without looking, is Derby on the default test classpath?\n\nAndy. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"created":"2010-04-15T12:18:56.650+0000","updated":"2010-04-15T12:18:56.650+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483433/comment/12942417","id":"12942417","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Andy,\n\nno worries, I created a test case and will commit a fix soon.\n\nCheers","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2010-04-15T12:46:14.848+0000","updated":"2010-04-15T12:46:14.848+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483433/comment/12942403","id":"12942403","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"body":"Great stuff, many thanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"created":"2010-04-15T13:28:38.446+0000","updated":"2010-04-15T13:28:38.446+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483433/comment/12942416","id":"12942416","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"This should be fixed on now with svn revision 934408.\n\nJDBC store postpones deleting messages with min last seq id to the next iteration cycle. Also getting last broker sequence id procedure is also made resilient on these cases as they can still happen due to expired messages.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2010-04-15T13:56:52.006+0000","updated":"2010-04-15T13:56:52.006+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483433/comment/12942444","id":"12942444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"body":"\n   [[ Old comment, sent by email on Thu, 15 Apr 2010 11:33:28 +0200 ]]\n\nHi Dejan,\n\nIt's going to be difficult to create a test case, but is easy to \nreproduce if you have any JDBC adapter configured.\n\n<persistenceAdapter>\n<jdbcPersistenceAdapter dataSource=\"#postgresql-activemq-ds\">\n<adapter>\n<postgresql-jdbc-adapter/>\n</adapter>\n</jdbcPersistenceAdapter>\n</persistenceAdapter>\n\nJust change the DataSource database to an empty test database and let \nActiveMQ create new empty tables.\n\nStop ActiveMQ.\n\nManually add one dummy row to the empty 'activemq_acks' table:\n\nINSERT INTO activemq_acks(container, sub_dest, client_id, sub_name, \nselector, last_acked_id) VALUES ('topic://a', 'topic://a', 'a', 'a', \n'a', 555);\n\nStart ActiveMQ.\n\nIt will try to load message id 555 - which does not exist, and will drop \na NullPointerException.\n\nThe code in doGetLastMessageStoreSequenceId uses Math.max(seq1, seq2) to \ndetermine the next sequence id, so this is then definitely not safe to \nuse in getLastMessageBrokerSequenceId() to load a message by id.\n\nI suppose a test case using something like Derby could be created - \nwithout looking, is Derby on the default test classpath?\n\nAndy.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=andyg","name":"andyg","key":"andyg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=andyg&avatarId=20366","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=andyg&avatarId=20366","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=andyg&avatarId=20366","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=andyg&avatarId=20366"},"displayName":"Andy Gumbrecht","active":true,"timeZone":"Europe/Berlin"},"created":"2010-04-19T14:55:18.823+0000","updated":"2010-04-19T14:55:18.823+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2696/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rpov:"}}