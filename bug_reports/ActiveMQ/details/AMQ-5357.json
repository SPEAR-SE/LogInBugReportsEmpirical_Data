{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12741457","self":"https://issues.apache.org/jira/rest/api/2/issue/12741457","key":"AMQ-5357","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2014-09-15T13:21:18.862+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 25 11:53:30 UTC 2014","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_53433133047_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-05-25T22:37:47.882+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5357/watchers","watchCount":4,"isWatching":false},"created":"2014-09-15T12:05:34.909+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-05-25T22:37:47.935+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12319603","id":"12319603","name":"activemq-pool","description":"The ActiveMQ Connection Pool"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Hi,\n\nBroker version : 5.10.0\n\nProblem : \nI am using ActiveMQv5.10.0 broker in my setup. In my broker I am facing a weird problem where a durable subscriber is not able to connect to the broker because of stale subscription shown by the broker with the same client id. Please note that this issue is not reproducible, I tried but not able to reproduce. It happens sometimes. \n\n\nDetails: \nIn my application I am creating 3 durable subscriptions on different topics. I am using PooledConnectionFactory with maxConnection=3 to create connections for each listener. I am using separate Spring Default message listener container for creation of the each listener. \n\nSometime when I start my client, I get below exception :  \n-----------\nlistener.DefaultMessageListenerContainer.refreshConnectionUntilSuccessful():907 ERROR]: Could not refresh JMS Connection for destination 'topic://test.newPnlSpn' - retrying in 5000 ms. Cause: Broker: mqbrokerdev - Client: new_pnl_spn_test_client already connected from tcp://a.b.c.d:2338 \n-----------\nBut when I check connections from \"a.b.c.d\". I don;t see any connections from the IP. Even on JConsole, it does not show any clients connecting to the same topic with this client_id. \nIn some cases i observed that this is the IP address where my client was previously running. \nBecause of this issue my current client which is running from some other IP address is not able to connect to the broker. \nI suspect that there is some race condition in ActiveMQ connection pooling. This is a serious issue I am facing in my setup, My clients are not able to connect to the broker.\n\n\nWhen I face this issue :\nI tried to restart the broker by clearing out the persistent store, but this issue was still there. It only got resolved when I changed the client ID of my listener. \nWhich means broker somewhere keeping stale connection state for this client id. As soon as new client id comes, it start working properly and connecting to the broker.\n\n\nDetailed Error logs: \n[20140915 16:23:14:964 IST (jmsContainer-6) org.springframework.jms.listener.DefaultMessageListenerContainer#handleListenerSetupFailure 666 ERROR] - Setup\n of JMS message listener invoker failed - trying to recover \njavax.jms.IllegalStateException: javax.jms.InvalidClientIDException: Broker: mqbrokerdev - Client: new_pnl_spn_seed_client already connected from tcp://10\n*.*.*.*:3456\n        at org.apache.activemq.jms.pool.ConnectionPool.createSession(ConnectionPool.java:135)\n        at org.apache.activemq.jms.pool.PooledConnection.createSession(PooledConnection.java:167)\n        at org.springframework.jms.support.JmsAccessor.createSession(JmsAccessor.java:200)\n        at org.springframework.jms.listener.DefaultMessageListenerContainer.access$1000(DefaultMessageListenerContainer.java:116)\n        at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.initResourcesIfNecessary(DefaultMessageListenerCon\ntainer.java:883)\n        at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.invokeListener(DefaultMessageListenerContainer.jav\na:869)\n        at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:810)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: javax.jms.InvalidClientIDException: Broker: mqbrokerdev - Client: new_pnl_spn_seed_client already connected from tcp://10.79.26.84:2338\n        at org.apache.activemq.broker.region.RegionBroker.addConnection(RegionBroker.java:246)\n        at org.apache.activemq.broker.jmx.ManagedRegionBroker.addConnection(ManagedRegionBroker.java:231)\n        at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:92)\n        at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:92)\n        at org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:92)\n        at org.apache.activemq.broker.MutableBrokerFilter.addConnection(MutableBrokerFilter.java:97)\n        at org.apache.activemq.broker.util.LoggingBrokerPlugin.addConnection(LoggingBrokerPlugin.java:189)\n        at org.apache.activemq.broker.MutableBrokerFilter.addConnection(MutableBrokerFilter.java:97)\n        at tools.jms.ActiveMQLoggingPlugin.addConnection(ActiveMQLoggingPlugin.java:425)\n        at org.apache.activemq.broker.MutableBrokerFilter.addConnection(MutableBrokerFilter.java:97)\n        at org.apache.activemq.broker.TransportConnection.processAddConnection(TransportConnection.java:764)\n        at org.apache.activemq.broker.jmx.ManagedTransportConnection.processAddConnection(ManagedTransportConnection.java:79)\n        at org.apache.activemq.command.ConnectionInfo.visit(ConnectionInfo.java:139)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:294)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:148)\n        at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n        at org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)\n        ... 1 more\n\n\n\n\n\n\n\n\nThanks,\nAnuj\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Race conditions in ActiveMQ Connection Pooling","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741457/comment/14133878","id":"14133878","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Recommend you create a unit test that demonstrates your issue.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-09-15T13:21:18.862+0000","updated":"2014-09-15T13:21:18.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741457/comment/14133937","id":"14133937","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"Tim,\n\nI already tried to reproduce the issue. For unit test there is only one xml file for creation of listeners which you can see below:\nJust suspecting : Can there be any problem because of using \"PooledConnectionFactory\" for more than one connections for durable subscribers ?\n\nclient.xml:\n\n <bean id=\"jmsFactory\" class=\"org.apache.activemq.pool.PooledConnectionFactory\" \n      destroy-method=\"stop\">\n      <property name=\"connectionFactory\">\n          <bean class=\"org.apache.activemq.ActiveMQConnectionFactory\">\n      <property name=\"brokerURL\">\n      <value>${jms.broker.url}</value>\n      </property>\n      </bean>\n      </property>\n      <property name=\"maxConnections\" value=\"3\" />\n      \nand my listener is using it as: \n   <bean id=\"listenerContainer1\"  class=\"org.springframework.jms.listener.DefaultMessageListenerContainer\">\n          <property name=\"connectionFactory\" ref=\"jmsFactory\" />\n          <property name=\"destination\" ref=\"topic_pnlCompleteTopic1\" />\n          <property name=\"durableSubscriptionName\" value=\"FAGCompletion1\" />\n          <property name=\"pubSubDomain\" value=\"true\" />\n          <property name=\"subscriptionDurable\" value=\"true\" />\n          <property name=\"clientId\" value=\"jms.fagsListener.clientId.1\" />\n          <property name=\"messageListener\" ref=\"pnlMessageListener1\" />\n     </bean>\n\n\n\n   <bean id=\"listenerContainer2\"  class=\"org.springframework.jms.listener.DefaultMessageListenerContainer\">\n          <property name=\"connectionFactory\" ref=\"jmsFactory\" />\n          <property name=\"destination\" ref=\"topic_pnlCompleteTopic2\" />\n          <property name=\"durableSubscriptionName\" value=\"FAGCompletion2\" />\n          <property name=\"pubSubDomain\" value=\"true\" />\n          <property name=\"subscriptionDurable\" value=\"true\" />\n          <property name=\"clientId\" value=\"jms.fagsListener.clientId2\" />\n          <property name=\"messageListener\" ref=\"pnlMessageListener2\" />\n     </bean>\n\n   <bean id=\"listenerContainer3\"  class=\"org.springframework.jms.listener.DefaultMessageListenerContainer\">\n          <property name=\"connectionFactory\" ref=\"jmsFactory\" />\n          <property name=\"destination\" ref=\"topic_pnlCompleteTopic3\" />\n          <property name=\"durableSubscriptionName\" value=\"FAGCompletion3\" />\n          <property name=\"pubSubDomain\" value=\"true\" />\n          <property name=\"subscriptionDurable\" value=\"true\" />\n          <property name=\"clientId\" value=\"jms.fagsListener.clientId3\" />\n          <property name=\"messageListener\" ref=\"pnlMessageListener3\" />\n     </bean>\n\n\n\nThanks,\nAnuj","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2014-09-15T14:18:58.338+0000","updated":"2014-09-15T14:18:58.338+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741457/comment/14133943","id":"14133943","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"From the information given it seems like it's working as designed for durable topics subscriptions, you cannot have multiple connections with the same client Id connected to the Broker. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-09-15T14:23:27.827+0000","updated":"2014-09-15T14:23:27.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741457/comment/14133952","id":"14133952","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"Yes. Each client has different client ID.\n\nI am also not able to reproduce this issues but as I mentioned the issue happens sometimes for long connecting clients...sometimes when clients restarts after long time.. at that time this issue occurs and that too not for all 3 listeners. \nI see two listeners are connecting fine but 3rd listener is not able to connect because broker shows stale client id already connected. \nI also discussed this issue here  http://activemq.2283324.n4.nabble.com/javax-jms-InvalidClientIDException-for-durable-subscription-on-broker-restart-td4684381.html#a4684743 \n \n\nThanks,\nAnuj\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2014-09-15T14:33:42.500+0000","updated":"2014-09-15T14:33:42.500+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741457/comment/14133992","id":"14133992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Would recommend you test against 5.11-SNAPSHOT as this could be a symptom of AMQ-5258 or AMQ-5226 ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-09-15T15:11:47.956+0000","updated":"2014-09-15T15:11:47.956+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741457/comment/14145991","id":"14145991","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"Hi Tim,\n\nI have tried to reproduce. It's not the exact test case but kind of similar problem. \n\n1. I have my own local plugin \"ActiveMQLoggingPlugin extends BrokerPluginSupport\" and override \"removeConnections\" and \"removeSession\" functions.\n2. I returned from the functions without passing it to super class for example: \n-----------\n    public void removeConnection(ConnectionContext context, ConnectionInfo info, Throwable error) throws Exception\n    {\n        if (info.toString() != \"hello\") {\n            return; // It's a hack so that it always return from here. \n        }\n        super.removeConnection(context, info, error);\n    }\n\n3. Now when I run the client application(consumers) which is using pooledConnectionFactory with maxConnection=5. it is creating 5 different connections using different client ids. Each listeners is a durable subscriber and I am setting different client id for each of them (It is using the configuration mentioned in previous comment)\n\n4. It is able to connect and work properly. Now I stop the client application. I can see that connections are gone and applciation is stopped. I checked that broker is not connecting to any client now. \n\n5 Now when I start the client application. I get the invalidclientIDexception by saying that this client is already connected to the broker. \nI think since broker is not closing the connection, it keeps the client id associated with it and does not clear the connection state. and when next time application starts, it says that client is already connected even if no client is actually connected to the broker. \n\nThanks,\nAnuj \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2014-09-24T06:56:58.126+0000","updated":"2014-09-24T06:56:58.126+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12741457/comment/14147664","id":"14147664","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"Hi Tim,\n\nI have seen a new feature \"allowLinkStealing\" with ActiveMQv5.10. This is supposed to be used with mqtt transport.\nbut this options seems to be working for my issue. I tested when a normal durable client is connecting to the borker and if other client tries with the same client id, it still throws exception saying \"javax.jms.JMSException: Durable consumer is in use for client: Test and subscriptionName: ActiveMQConsumer\"\n\nBut when broker keeps stale entries of client ids and actually no client is connected, then the new client is able to connect properly.\n\nI just want to know that can I use it for normal tcp transport or will there be some consequence ?\n\n\nThanks,\nAnuj ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2014-09-25T11:53:30.230+0000","updated":"2014-09-25T11:53:30.230+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5357/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i201kf:"}}