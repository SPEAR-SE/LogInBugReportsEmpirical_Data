{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13074272","self":"https://issues.apache.org/jira/rest/api/2/issue/13074272","key":"AMQ-6682","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2017-05-23T18:09:27.754+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 25 19:13:24 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_10805734449_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-09-25T19:13:24.658+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6682/watchers","watchCount":3,"isWatching":false},"created":"2017-05-23T17:37:50.317+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12339772","id":"12339772","name":"5.14.5","archived":false,"released":true,"releaseDate":"2017-04-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-09-25T19:13:24.758+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313896","id":"12313896","name":"JMS client"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When using spring's DefaultMessageListenerContainer (DMLC) to consume messages from AMQ 5.14.5 server, and using prefetch of 0, spring container hangs when shutting down DMLC (e.g. on tomcat server shutdown). \n\nApplicable 2 threads from spring client app thread dump (logs on separate network so I cannot copy/paste):\n\n\"dmlc-1\" ...\n at org.apache.activemq.FifoMessageDispatchChannel.dequeue(FifoMessageDispatchChannel.java:72)\n - locked <> (a java.lang.Object)\n at org.apache.activemq.ActiveMQMessageConsumer.dequeue(ActiveMQMessageConsumer.java:486)\n at org.apache.activemq.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:648)\n\n\"http-bio-exec-11\" \n   at org.springframework.jms.listener.DefaultMessageListenerContainer.doShutdown(DefaultMessageListenerContainer.java:571)\n...\n\n\nApplicable spring configuration file:\n\n<bean id=\"jmsFactory\" class=\"org.apache.activemq.ActiveMQConnectionFactory\">\n    <property name=\"brokerURL\">\n      <value>tcp://localhost:61616?jms.prefetchPolicy.queuePrefetch=0</value>\n    </property>\n  </bean>\n\n<bean id=\"queue\" class=\"org.apache.activemq.command.ActiveMQQueue\">\n  <constructor-arg index=\"0\" value=\"myQueue\" />\n</bean>\n\n<bean id=\"dmlc\" class=\"org.springframework.jms.listener.DefaultMessageListenerContainer\">\n    <property name=\"connectionFactory\" ref=\"jmsFactory\" />\n    <property name=\"destination\" ref=\"queue\" />\n    <property name=\"messageListener\" ref=\"myQueueConsumer\" />\n    <property name=\"sessionTransacted\" value=\"true\" />\n</bean>\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"AMQ client hangs when stopping Spring DefaultMessageListenerContainer","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsharmo","name":"dsharmo","key":"dsharmo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Harmon","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsharmo","name":"dsharmo","key":"dsharmo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Harmon","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"JDK 1.8.0_112\nspring-jms-4.3.8.RELEASE.jar\nactivemq-client-5.14.5.jar","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13074272/comment/16021564","id":"16021564","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Have you confirmed that consumer close or connection close is being called?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-05-23T18:09:27.754+0000","updated":"2017-05-23T18:09:27.754+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13074272/comment/16021827","id":"16021827","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsharmo","name":"dsharmo","key":"dsharmo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Harmon","active":true,"timeZone":"Etc/UTC"},"body":"Logic to close consumer and connection is not being called yet by Spring DMLC. Appears mutex.wait() in FifoMessageDispatchChannel.java:72 is blocked forever, preventing Spring DLMC doShutdown from closing consumer and connection.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsharmo","name":"dsharmo","key":"dsharmo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Harmon","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-23T20:47:16.786+0000","updated":"2017-05-23T20:48:45.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13074272/comment/16021835","id":"16021835","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"So that's not a bug then as the receive call is by definition blocking, it will only return when a message is available or the consumer is explicitly closed, which is true regardless of prefetch being set to 0, 1, or 100.  This is a configuration issue and not a client issue as far as I can tell.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-05-23T20:50:19.386+0000","updated":"2017-05-23T20:50:35.517+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13074272/comment/16022944","id":"16022944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsharmo","name":"dsharmo","key":"dsharmo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Harmon","active":true,"timeZone":"Etc/UTC"},"body":"When using a prefetch value other than 0, Spring DMLC shuts down normally.\n\nWhen using prefetch value of 0, DMLC shutdown hangs. The DMLC shutdown sequence calls org.apache.activemq.ActiveMQConnection.stop (ActiveMQConnection.java:569) which eventually calls org.apache.activemq.FifoMessageDispatchChannel.stop(FifoMessageDispatchChannel.java:124) which sets running=false. In separate thread, this in turn causes the mutex.wait() to in FifoMessageDispatchChannel.java:72 to block forever. Appears to be a timing issue/race condition as when I step thru threads in remote debugger, sometimes the spring DMLC shuts down normally with prefetch value of 0. \n\nI also created https://jira.spring.io/browse/SPR-15579. Not sure where the problem resides.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsharmo","name":"dsharmo","key":"dsharmo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Harmon","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-24T14:11:14.486+0000","updated":"2017-05-24T14:11:14.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13074272/comment/16022991","id":"16022991","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsharmo","name":"dsharmo","key":"dsharmo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Harmon","active":true,"timeZone":"Etc/UTC"},"body":"Also note, a workaround is to set prefetch value of 0 on AMQ server and omit jms.prefetchPolicy.queuePrefetch=0 from brokerURL. Spring DMLC shutdown successfully in this scenario.\n\n<broker ... >\n  ...\n  <destinationPolicy>\n    <policyMap>\n      <policyEntries>\n        <policyEntry queue=\">\" queuePrefetch=”0”/>","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dsharmo","name":"dsharmo","key":"dsharmo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Harmon","active":true,"timeZone":"Etc/UTC"},"created":"2017-05-24T14:42:09.840+0000","updated":"2017-05-24T14:43:11.443+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13074272/comment/16033498","id":"16033498","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Looked again and so far I still don't see a bug with what information has been given so far.  A consumer receive will block and is not unblocked by connection stop,  so if the spring bits are waiting for the receive to return after calling connection stop that'd be wrong.  Would need a stack trace or thread dump of the ActiveMQ threads to see what was hung up.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-06-01T19:04:07.377+0000","updated":"2017-06-01T19:04:07.377+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13074272/comment/16179601","id":"16179601","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Given the current information this appears to be a spring issue as it is depending on receive not blocking which it certainly can under the conditions listed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-09-25T19:13:24.746+0000","updated":"2017-09-25T19:13:24.746+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6682/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3fd7r:"}}