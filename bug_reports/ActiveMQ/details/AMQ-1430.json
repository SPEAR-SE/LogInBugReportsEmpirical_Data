{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483156","self":"https://issues.apache.org/jira/rest/api/2/issue/12483156","key":"AMQ-1430","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-11-10T21:30:04.883+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Nov 20 18:17:12 UTC 2009","customfield_12310420":"95780","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_68421577879_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-11-20T18:17:12.595+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1430/watchers","watchCount":1,"isWatching":false},"created":"2007-09-20T20:17:34.716+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-11-20T18:17:12.567+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Using this CQ config:\n\n\t\t\t\t\t<compositeQueue name=\"A\">\n\t\t\t\t\t\t<forwardTo>\n\t\t\t\t\t\t\t<queue physicalName=\"B\" />\n\t\t\t\t\t\t\t<queue physicalName=\"C\" />\n\t\t\t\t\t\t</forwardTo>\n\t\t\t\t\t</compositeQueue>\n\nand this JDBC config:\n\n\t\t\t<journaledJDBC journalLogFiles=\"5\"\n\t\t\t\tdataDirectory=\"${esb.data.dir}/activemq/data\"\n\t\t\t\tdataSource=\"#derby-ds\" />\n\nI create a subscriber to queue B and one to queue C. I start a publisher that sends 20 messages.\n\nThe subscriber to queue B receives 20 messages ; the one on queue C receives 0.\n\nThe server prints this error for each message:\n\nSep 20, 2007 1:11:04 PM org.apache.activemq.util.TransactionTemplate run\nSEVERE: Having to Rollback - caught an exception: java.io.IOException: The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or unique index identified by 'SQL070920011040920' defined on 'ACTIVEMQ_MSGS'.\nSep 20, 2007 1:11:04 PM org.apache.activemq.store.journal.JournalPersistenceAdapter doCheckpoint\nSEVERE: Failed to checkpoint a message store: java.util.concurrent.ExecutionException: java.io.IOException: Not started.\njava.util.concurrent.ExecutionException: java.io.IOException: Not started.\n\tat java.util.concurrent.FutureTask$Sync.innerGet(FutureTask.java:205)\n\tat java.util.concurrent.FutureTask.get(FutureTask.java:80)\n\tat org.apache.activemq.store.journal.JournalPersistenceAdapter.doCheckpoint(JournalPersistenceAdapter.java:397)\n\tat org.apache.activemq.store.journal.JournalPersistenceAdapter$1.iterate(JournalPersistenceAdapter.java:118)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:118)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:42)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)\n\tat java.lang.Thread.run(Thread.java:613)\nCaused by: java.io.IOException: Not started.\n\tat org.apache.activemq.store.jdbc.TransactionContext.rollback(TransactionContext.java:174)\n\tat org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.rollbackTransaction(JDBCPersistenceAdapter.java:366)\n\tat org.apache.activemq.store.journal.JournalPersistenceAdapter.rollbackTransaction(JournalPersistenceAdapter.java:200)\n\tat org.apache.activemq.util.TransactionTemplate.run(TransactionTemplate.java:59)\n\tat org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:257)\n\tat org.apache.activemq.store.journal.JournalMessageStore.checkpoint(JournalMessageStore.java:232)\n\tat org.apache.activemq.store.journal.JournalPersistenceAdapter$4.call(JournalPersistenceAdapter.java:367)\n\tat org.apache.activemq.store.journal.JournalPersistenceAdapter$4.call(JournalPersistenceAdapter.java:366)\n\tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:269)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:123)\n\t... 3 more","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"171942","customfield_12312823":null,"summary":"Composite Queue causes duplicate keys in JDBC store","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ddossot","name":"ddossot","key":"ddossot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ddossot&avatarId=25441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ddossot&avatarId=25441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ddossot&avatarId=25441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ddossot&avatarId=25441"},"displayName":"David Dossot","active":true,"timeZone":"America/Vancouver"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ddossot","name":"ddossot","key":"ddossot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ddossot&avatarId=25441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ddossot&avatarId=25441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ddossot&avatarId=25441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ddossot&avatarId=25441"},"displayName":"David Dossot","active":true,"timeZone":"America/Vancouver"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"apache-activemq-5.0-20070920.154726-5, JVM 1.5.0_07, Mac OS X","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483156/comment/12940450","id":"12940450","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpettitt","name":"cpettitt","key":"cpettitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Pettitt","active":true,"timeZone":"Etc/UTC"},"body":"I ran into this issue with ActiveMQ in the 4.1.1 branch and found that it had been fixed in changeset 646880 (I manually bisected about 12 changesets to find this).\n\nThe brokerSequenceId for a Message is used as its unique identifier in the persistence store. In code preceding 646880 the brokerSequenceId is never changed for a message after it has been copied (as by CompositeQueue), so it is possible to have an ID collision in the database. 646880 resolved this by setting a new brokerSequenceId (the regionBroker's sequence ID) immediately before sending the message to the persistence store in the Queue (and Topic) class.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpettitt","name":"cpettitt","key":"cpettitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Pettitt","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-10T21:30:04.883+0000","updated":"2008-11-10T21:30:04.883+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483156/comment/12938606","id":"12938606","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bsnyder","name":"bsnyder","key":"bsnyder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bruce Snyder","active":true,"timeZone":"America/Denver"},"body":"Fixed by AMQ-1656. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bsnyder","name":"bsnyder","key":"bsnyder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bruce Snyder","active":true,"timeZone":"America/Denver"},"created":"2009-11-20T18:17:12.566+0000","updated":"2009-11-20T18:17:12.566+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1430/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tslj:"}}