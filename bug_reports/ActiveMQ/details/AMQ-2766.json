{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483783","self":"https://issues.apache.org/jira/rest/api/2/issue/12483783","key":"AMQ-2766","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jun 07 21:03:47 UTC 2010","customfield_12310420":"74810","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2766/watchers","watchCount":0,"isWatching":false},"created":"2010-06-07T15:43:56.026+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315621","id":"12315621","description":"","name":"5.3.1","archived":false,"released":true,"releaseDate":"2010-03-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315622","id":"12315622","description":"","name":"5.3.2","archived":false,"released":true,"releaseDate":"2010-05-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-09-18T16:43:22.636+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"hi,\n\ni was trying durable topics with jdbcPersistenceAdapter and mysql using JmsDurableTopicTransactionTest  class (activemq test sources) and modified the connection and the method testReceiveRollback adding a reconnect after the rollback. it should be work fine but it fails and i'm not sure if i'm doing something wrong or is a bug.\n\ni would appreciate someone can check this test with this little modification\n\njavier\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"81519","customfield_12312823":null,"summary":"lost messages using jdbcPersistenceAdapter and mysql","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier","name":"javier","key":"javier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"javier","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier","name":"javier","key":"javier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"javier","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"ubuntu","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483783/comment/12942698","id":"12942698","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier","name":"javier","key":"javier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"javier","active":true,"timeZone":"Etc/UTC"},"body":"here is my setting for activemq:\n\n\n<!--\n    Licensed to the Apache Software Foundation (ASF) under one or more\n    contributor license agreements.  See the NOTICE file distributed with\n    this work for additional information regarding copyright ownership.\n    The ASF licenses this file to You under the Apache License, Version 2.0\n    (the \"License\"); you may not use this file except in compliance with\n    the License.  You may obtain a copy of the License at\n   \n    http://www.apache.org/licenses/LICENSE-2.0\n   \n    Unless required by applicable law or agreed to in writing, software\n    distributed under the License is distributed on an \"AS IS\" BASIS,\n    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n    See the License for the specific language governing permissions and\n    limitations under the License.\n-->\n<beans\n  xmlns=\"http://www.springframework.org/schema/beans\"\n  xmlns:amq=\"http://activemq.apache.org/schema/core\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xmlns:osgi=\"http://www.springframework.org/schema/osgi\"\n  xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd   \n  http://activemq.apache.org/camel/schema/spring http://activemq.apache.org/camel/schema/spring/camel-spring.xsd\n  http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd\">\n\n    <!-- Allows us to use system properties as variables in this configuration file -->\n    <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"/>\n\n    <bean id=\"mysql-ds\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n\t    <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n\t    <property name=\"url\" value=\"jdbc:mysql://localhost/activemq\"/>\n\t    <property name=\"username\" value=\"root\"/>\n\t    <property name=\"password\" value=\"javier\"/>\n\t    <property name=\"poolPreparedStatements\" value=\"true\"/>\n    </bean>\n\n    <broker xmlns=\"http://activemq.apache.org/schema/core\" brokerName=\"default\"  useShutdownHook=\"false\" dataDirectory=\"${servicemix.base}/activemq-data/default\">\n\n        <!-- Destination specific policies using destination names or wildcards -->\n        <destinationPolicy>\n            <policyMap>\n                <policyEntries>\n                    <policyEntry queue=\">\" memoryLimit=\"5mb\"/>\n                    <policyEntry topic=\">\" memoryLimit=\"5mb\">\n                        <subscriptionRecoveryPolicy>\n                            <lastImageSubscriptionRecoveryPolicy/>\n                        </subscriptionRecoveryPolicy>\n                    </policyEntry>\n                </policyEntries>\n            </policyMap>\n        </destinationPolicy>\n\n        <!-- Use the following to configure how ActiveMQ is exposed in JMX -->\n        <managementContext>\n            <managementContext createConnector=\"false\"/>\n        </managementContext>\n\n        <!-- The store and forward broker networks ActiveMQ will listen to -->\n        <networkConnectors>\n        </networkConnectors>\n\n        <persistenceAdapter>\n\t\t <jdbcPersistenceAdapter dataDirectory=\"${servicemix.base}/activemq-data\" dataSource=\"#mysql-ds\" />\n        </persistenceAdapter>\n\n        <!-- Use the following if you wish to configure the journal with JDBC -->\n        <!--\n        <persistenceAdapter>\n            <journaledJDBC dataDirectory=\"${activemq.base}/data\" dataSource=\"#postgres-ds\"/>\n        </persistenceAdapter>\n        -->\n\n        <!-- Or if you want to use pure JDBC without a journal -->\n        <!--\n        <persistenceAdapter>\n            <jdbcPersistenceAdapter dataSource=\"#postgres-ds\"/>\n        </persistenceAdapter>\n        -->\n\n        <!--  The maximum about of space the broker will use before slowing down producers -->\n        <systemUsage>\n            <systemUsage>\n                <memoryUsage>\n                    <memoryUsage limit=\"20 mb\"/>\n                </memoryUsage>\n                <storeUsage>\n                    <storeUsage limit=\"1 gb\" name=\"foo\"/>\n                </storeUsage>\n                <tempUsage>\n                    <tempUsage limit=\"100 mb\"/>\n                </tempUsage>\n            </systemUsage>\n        </systemUsage>\n\n\n        <!-- The transport connectors ActiveMQ will listen to -->\n        <transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://localhost:61616\" discoveryUri=\"multicast://default\"/>\n            <transportConnector name=\"stomp\" uri=\"stomp://localhost:61613\"/>\n        </transportConnectors>\n\n    </broker>\n\n    <bean id=\"activemqConnectionFactory\" class=\"org.apache.activemq.ActiveMQConnectionFactory\">\n        <property name=\"brokerURL\" value=\"tcp://localhost:61616\" />\n    </bean>\n\n    <bean id=\"pooledConnectionFactory\" class=\"org.apache.activemq.pool.PooledConnectionFactoryBean\">\n        <property name=\"maxConnections\" value=\"8\" />\n        <property name=\"maximumActive\" value=\"500\" />\n        <property name=\"transactionManager\" ref=\"transactionManager\" />\n        <property name=\"connectionFactory\" ref=\"activemqConnectionFactory\" />\n        <property name=\"resourceName\" value=\"activemq.default\" />\n    </bean>\n\n    <bean id=\"resourceManager\" class=\"org.apache.activemq.pool.ActiveMQResourceManager\" init-method=\"recoverResource\">\n          <property name=\"transactionManager\" ref=\"transactionManager\" />\n          <property name=\"connectionFactory\" ref=\"activemqConnectionFactory\" />\n          <property name=\"resourceName\" value=\"activemq.default\" />\n    </bean>\n\n    <osgi:reference id=\"transactionManager\" interface=\"javax.transaction.TransactionManager\" />\n\n    <osgi:service ref=\"pooledConnectionFactory\">\n        <osgi:interfaces>\n            <value>javax.jms.ConnectionFactory</value>\n        </osgi:interfaces>\n        <osgi:service-properties>\n            <entry key=\"name\" value=\"default\"/>\n        </osgi:service-properties>\n    </osgi:service>\n\n</beans>\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier","name":"javier","key":"javier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"javier","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-07T20:03:42.960+0000","updated":"2010-06-07T20:03:42.960+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483783/comment/12942700","id":"12942700","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier","name":"javier","key":"javier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"javier","active":true,"timeZone":"Etc/UTC"},"body":"here the modified code:\n\npublic class JmsDurableTopicTransactionTest extends JmsTopicTransactionTest {\n\n    /**\n     * see JmsTransactionTestSupport#getJmsResourceProvider()\n     */\n    protected JmsResourceProvider getJmsResourceProvider() {\n        JmsResourceProvider provider = new JmsResourceProvider();\n        provider.setTopic(true);\n  \n       provider.setServerUri(\"tcp://localhost:61616\");\n\n        provider.setDeliveryMode(DeliveryMode.PERSISTENT);\n        provider.setClientID(getClass().getName());\n        provider.setDurableName(getName());\n        return provider;\n    }\n\n}\n\n\n\n\n\n\n\n\npublic abstract class JmsTransactionTestSupport extends TestSupport implements MessageListener {\n\n......\n\n    public void testReceiveRollback() throws Exception {\n        Message[] outbound = new Message[] {session.createTextMessage(\"First Message\"), session.createTextMessage(\"Second Message\")};\n\n        // lets consume any outstanding messages from prev test runs\n        beginTx();\n        while (consumer.receive(1000) != null) {\n        }\n        commitTx();\n\n        // sent both messages\n        beginTx();\n        producer.send(outbound[0]);\n        producer.send(outbound[1]);\n        commitTx();\n\n        \n        LOG.info(\"Sent 0: \" + outbound[0]);\n        LOG.info(\"Sent 1: \" + outbound[1]);\n\n        ArrayList<Message> messages = new ArrayList<Message>();\n        beginTx();\n        Message message = consumer.receive(1000);\n        messages.add(message);\n        assertEquals(outbound[0], message);\n        commitTx();\n\n        // rollback so we can get that last message again.\n        beginTx();\n        message = consumer.receive(1000);\n        if(message != null){\n        \tassertNotNull(message);\n        \tassertEquals(outbound[1], message);\n        \trollbackTx();\n        }\n\n// ----------------------------\n// this reconnect shouldn't cause any prob\n\n        reconnect();\n// ----------------------------\n       \n        // Consume again.. the prev message should\n        // get redelivered.\n        beginTx();\n        message = consumer.receive(5000);\n        assertNotNull(\"Should have re-received the message again!\", message);\n        messages.add(message);\n        commitTx();\n\n        Message inbound[] = new Message[messages.size()];\n        messages.toArray(inbound);\n        assertTextMessagesEqual(\"Rollback did not work\", outbound, inbound);\n    }\n    \n\n....","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier","name":"javier","key":"javier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"javier","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-07T20:05:05.843+0000","updated":"2010-06-08T12:16:01.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483783/comment/12942692","id":"12942692","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier","name":"javier","key":"javier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"javier","active":true,"timeZone":"Etc/UTC"},"body":"trying same test but with amqPersistenceAdapter doesn't happen any problems, the test works fine, any idea?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=javier","name":"javier","key":"javier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"javier","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-07T21:03:47.602+0000","updated":"2010-06-07T21:03:47.602+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2766/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0eauf:"}}