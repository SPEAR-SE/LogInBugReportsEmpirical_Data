{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483069","self":"https://issues.apache.org/jira/rest/api/2/issue/12483069","key":"AMQ-1807","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-12-16T11:12:17.854+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Aug 19 11:37:03 UTC 2009","customfield_12310420":"43750","customfield_12312320":null,"customfield_12310222":"3_*:*_1_*:*_3820569474_*|*_1_*:*_1_*:*_15641469211_*|*_5_*:*_2_*:*_1808752097_*|*_4_*:*_1_*:*_14428943121","customfield_12312321":null,"resolutiondate":"2009-08-05T14:48:10.097+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1807/watchers","watchCount":6,"isWatching":false},"created":"2008-06-18T10:12:36.194+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-08-19T11:37:03.071+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"As requested by Dejan Bosanac, I'm adding this ticket. I'm willing to help fix it, ie. I can get my hands dirty, but I must have some pointers on where to look because (unfortunately) I don't have much time to learn ActiveMQ's internals and architecture.\n\nA copy of the email I sent to the users mailing-list:\n=============================================\n\nI'm currently struggling to understand the reason behind that's causing the behaviour described in the subject: I'm connecting to activemq via stomp on a python app. Because I need to have the messages rolled back in case of some processing failure I'm wrapping the message processing in the following way:\n\n message received -> start transaction -> ack message in transaction ->\nprocess message -> if no exception commit tx, else rollback transaction\n\n\nAFAIK, this is the only way of making message unacknowledgement possible with stomp. Also, this is a single client connection, ie. I'm using a\nsingle client connection to create a message processing daemon, all messages are sent and received via this single connection to the MQ server.\n\nHere's a telnet session that can be used to reproduce the problem (open jconsole and send 5 text messages to the queue):\n\n% telnet localhost 61613\nTrying 127.0.0.1...\nConnected to localhost.\nEscape character is '^]'.\nCONNECT\n\n^@\nCONNECTED\nsession:ID:starfish-53281-1213736462979-2:2\n\n\nSUBSCRIBE\ndestination: /queue/testq\nack: client\nactivemq.prefetchSize: 1\n\n^@\nMESSAGE\nmessage-id:ID:starfish-53281-1213736462979-3:3:1:1:1\ndestination:/queue/testq\ntimestamp:1213736837743\nexpires:0\npriority:0\n\n1\nBEGIN\ntransaction: 1\n\n^@\nACK\nmessage-id:ID:starfish-53281-1213736462979-3:3:1:1:1\ntransaction: 1\n\n^@\nMESSAGE\nmessage-id:ID:starfish-53281-1213736462979-3:4:1:1:1\ndestination:/queue/testq\ntimestamp:1213736840224\nexpires:0\npriority:0\n\n2\nMESSAGE\nmessage-id:ID:starfish-53281-1213736462979-3:5:1:1:1\ndestination:/queue/testq\ntimestamp:1213736842611\nexpires:0\npriority:0\n\n3\nABORT   \ntransaction: 1\n\n^@\nBEGIN \ntransaction:2\n\n^@\nACK\nmessage-id:ID:starfish-53281-1213736462979-3:4:1:1:1\ntransaction:2\n\n^@\nABORT\ntransaction:2\n\n^@\nACK\nmessage-id:ID:starfish-53281-1213736462979-3:5:1:1:1\n\n^@\n\n\nI see a couple of issues here:\n\n#1) even though I specified activemq.prefetchSize to 1 in the subscription command, the connector dispatches two messages in a row\n\n#2) no more messages are dispatched after aborting the transaction/acknowledging the last received message. Even if the second message isn't wrapped in a transaction, message dispatch stops there.\n\nTo add to the confusion, if I don't use transactions _at all_, my client keeps getting messages, one by one, ie. no two messages are sent together, I only get a new message after ACK'ing the previous one.\n\nI think I may be stepping into the realms of a buggy STOMP connector. Please tell me if I'm missing something obvious that fixes this issue\n(hence making it a non-issue) or if indeed the STOMP connector has problems.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461213","id":"12461213","filename":"stomp_test.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T00:00:43.183+0000","size":3003,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461213/stomp_test.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161455","customfield_12312823":null,"summary":"Activemq stops dispatching messages aborting transaction (STOMP)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux, JDK 1.6_06b2","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12939893","id":"12939893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"body":"This test uncovers two messages being dispatched on client ACK","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T00:00:43.295+0000","updated":"2008-07-01T00:00:43.295+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12939907","id":"12939907","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"body":"I've attached a patch for tests that displays the error described on #1. Digging through the code, I found it is related with the following piece of code in activemq-core/src/main/java/org/apache/activemq/broker/region/PrefetchSubscription.java at line 230:\n\nprefetchExtension = Math.max(prefetchExtension, index + 1);\n\nThis code is broken because when the first message is dispatched to the client, prefetchExtension isn't incremented so when the client ACKs the first message, index is incremented to 1 and Math.max() returns 2 so two messages are dispatched.\n\nCan anyone please explain what prefetchExtension is supposed to do and how changing it impacts the rest of the code? I've asked on IRC and received no replies, same thing on activemq-devel mailing list. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T00:06:50.627+0000","updated":"2008-07-01T00:06:50.627+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12940545","id":"12940545","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"I've committed a change (along with a test case) regarding the prefetch size problem. I've changed \"index + 1\" with \"index\", since it is being incremented earlier. All tests are passing. If anyone else can take a look at this as well it would be great.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2008-12-16T11:12:17.854+0000","updated":"2008-12-16T11:12:17.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12940691","id":"12940691","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"The problem with dispatch stopping after transaction abort was due to the fact that messages were acked at the moment they were dispatched and we didn't have any logic to redeliver them after the rollback. I implemented some additional logic (Committed revision 738904), that acks messages received in the transaction on commit, and redeliver them after the abort. This helps in this usecase, as you can see in the StompTest.testPrefetchSize().\n\nI still can imagine certain scenarios where this would not work well, mostly because we dispatch messages as they come to the transport and don't care whether some of already dispatched messages should be redelivered before, but this requires quite a big refactoring, so I leave it for the future enhancements.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-01-29T16:19:54.865+0000","updated":"2009-01-29T16:19:54.865+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12940803","id":"12940803","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"It seems that acking a messages before an abort, still makes the client hang on the next receive.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-02-19T14:45:46.948+0000","updated":"2009-02-19T14:45:46.948+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12941574","id":"12941574","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"pushing this out to 5.4.0 as more work is needed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-06-24T11:23:11.316+0000","updated":"2009-06-24T11:23:11.316+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12941641","id":"12941641","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ervandew","name":"ervandew","key":"ervandew","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Van Dewoestine","active":true,"timeZone":"America/Denver"},"body":"I just wanted to offer a bit of feedback on the current state of this as of the 20090620 snapshot (which includes Dejan's 738904 revision).  For message redelivery, when aborting the transaction, the redelivery policy is not currently honored.  This results in an infinite number of immediate retries to deliver the unacknowledged messages.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ervandew","name":"ervandew","key":"ervandew","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Van Dewoestine","active":true,"timeZone":"America/Denver"},"created":"2009-06-30T00:35:23.915+0000","updated":"2009-06-30T00:35:23.915+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12940937","id":"12940937","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Just looked at the test case again and it seems that this is working fine now (modified test case proves it).\n\nAs for the redelivery policy, it is not implemented for Stomp. I created another issue for this: https://issues.apache.org/activemq/browse/AMQ-2345","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-08-05T14:48:10.049+0000","updated":"2009-08-05T14:48:10.049+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12941227","id":"12941227","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"The final comment on this issue: redelivery of messages after abort is not supported by Stomp protocol (thanks Hiram for the tip), so I reverted some of the delivery logic that was implemented for this issue. The test case is StompTest.testPrefetchSize() is now modified to reflect these changes and some fixes are implemented to make it work. Please take a look at http://activemq.apache.org/how-do-i-unack-the-message-with-stomp.html for more info on this topic.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-08-18T08:13:48.486+0000","updated":"2009-08-18T08:13:48.486+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12941288","id":"12941288","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"body":"I'm sorry but that is just wrong, if the consumer dies out of an unexpected/unhandled error (think OOM) then the message is gone for good. The STOMP protocol does define transactions, it just doesn't specify how a consumer transaction must work. I personally see that as an oversight of the specification. You should do The Right Thing and rollback the messages if the transaction is a) explicitly aborted or b) the client connection is dropped, independently of the lack of completeness in the STOMP specification, anything else is unnacceptable and unexpected behavior of the message broker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cpinto","name":"cpinto","key":"cpinto","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Celso Pinto","active":true,"timeZone":"Etc/UTC"},"created":"2009-08-18T13:11:22.255+0000","updated":"2009-08-18T13:11:22.255+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483069/comment/12941294","id":"12941294","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Celso,\n\nI think you're confusing transaction rollback and death of consumer.\n\nIn case when consumer dies, the broker will detect it and will append all messages that are dispatched but not acknowledged by that consumer (all the messages you have acked in the transaction that hasn't been committed) to the end of the dispatch list. So these messages will be redelivered again to another consumer eventually. This works now in the same way for JMS and Stomp clients.\n\nBut when we rollback the transaction, we say to the broker that we haven't yet consumed messages that were delivered to us. So the broker will wait for those messages to be acked before sending more messages. This also works in the same way for Java and Stomp clients, it's just that JMS Java client has built-in logic that will try to redeliver those messages first (locally) when you start a new transaction. You can also implement the same logic in your Stomp client (or application).\n\nThe whole point is that redelivery of messages after the rollback, is the task for the client, since there's no need for the broker to resend those messages over the network again.\n\nHope this helps,\nDejan","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-08-19T11:37:03.062+0000","updated":"2009-08-19T11:37:03.062+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1807/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rzvb:"}}