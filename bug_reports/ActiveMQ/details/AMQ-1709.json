{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482191","self":"https://issues.apache.org/jira/rest/api/2/issue/12482191","key":"AMQ-1709","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-05-15T11:58:40.825+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 15 11:58:40 UTC 2008","customfield_12310420":"84590","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1101694466_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-05-15T11:58:40.911+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1709/watchers","watchCount":1,"isWatching":false},"created":"2008-05-02T17:57:06.445+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315615","id":"12315615","description":"","name":"4.1.2","archived":false,"released":true,"releaseDate":"2008-04-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-05-15T11:58:40.868+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When you a a network of brokers configuration with at least 3 brokers, such as:\n\n<broker brokerName=\"A\" persistent=\"false\" ...\n...\n<transportConnector name=\"AListener\" uri=\"tcp://localhost:61610\"/>\n...\n<networkConnector name=\"BConnector\" uri=\"static:(tcp://localhost:61620)\"/>\n<networkConnector name=\"CConnector\" uri=\"static:(tcp://localhost:61630)\"/>\n\nwith the other brokers have a similar configuration.\nThen, if you have subscribers trying to connect to all of the brokers you can have a race condition at start up where the transports accept connections from subscribers before the network connectors are initialized.  In BrokerService.startAllConnectors(), the transports are started first.  Then the NetworkConnectors.  As part of starting the network connectors, their constructors takes a collection obtained by calling getBroker().getDurableDestinations().  Normally this list would be empty.  However, if clients connect before this is called, a list is returned for each topic subscribed to.  Then, instead of creating standard TopicSubscriptions for the network connector, DurableTopicSubscriptions are created.  I'm not sure if this really should be a problem, but it is because SimpleDispatchPolicy, in the process of iterating through the DurableTopicSubscriptions, causes messages to be queued up for prefetch without clearing all of the references (for each pass through it looks like three references are registered and only two are cleared.  This becomes a memory leak.  In the logs you see a message saying the PrefetchLimit was reached and then you start seeing logs about memory usage increasing until it gets to 100% and then everything stops.  \n\nTo reproduce this, create a network of brokers configuration of at least 3 brokers -- the more you have the more likely you are to hit this without a lot of tries so I suggest a bunch.  Start all brokers.  Establish a publisher on broker A using failover://(tcp://localhost:61610) then establish a bunch of subscribers on all the brokers using a similar configuration, i.e, failover://(tcp://localhost:61610), failover://(tcp://localhost:61620).  The more you have on broker 'A' the better since you are trying to reproduce the race condition.  You want the others up so that the other brokers expect messages to be passed to them.    Once everybody is up and happy, kill broker A and restart it.  If you do that enough times, you will hit the race condition and the memory leak will start.    You can also put a break point in BrokerService.startAllConnectors() after the transports are started but before the network connectors are started.  That'll give clients to connect to the transport threads before you tell the VM to continue.\n\nI found it an easy fix to store the durable destination list in a local variable before starting the transports and passing that to the network connectors instead of separate calls..  I'm not sure if there are 'normal' ways for that list to be anything other than empty.  If not, you could just pass an empty set to the network connectors, but suspect there are legitimate configurations that may need this to requested.  If so, this memory leak would likely occur in these cases, too.   \n\nI ran into this in 4.1.2.  I haven't tested 5.0 since our attempts to switch to 5.0 were met with failure due to the number of bugs in 5.0 (already reported by others).  Looking at 5.0.0 source, the race condition is still there in BrokerService.startAllConnectors() so I suspect the memory leak is there as well.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"233334","customfield_12312823":null,"summary":"Network of Brokers Memory Leak Due to Race Condition","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hoorner","name":"hoorner","key":"hoorner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Howard Orner","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hoorner","name":"hoorner","key":"hoorner","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Howard Orner","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482191/comment/12939662","id":"12939662","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Fixed by SVN revision 656601","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-15T11:58:40.825+0000","updated":"2008-05-15T11:58:40.825+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1709/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i14bjr:"}}