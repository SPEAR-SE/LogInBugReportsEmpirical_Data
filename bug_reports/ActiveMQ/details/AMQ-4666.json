{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12661495","self":"https://issues.apache.org/jira/rest/api/2/issue/12661495","key":"AMQ-4666","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-01-08T14:53:10.794+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun Jan 11 05:28:52 UTC 2015","customfield_12310420":"341684","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4666/watchers","watchCount":3,"isWatching":false},"created":"2013-08-02T22:03:28.898+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-11T05:28:52.699+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Failing scenario:\n\n1. Embedded broker starts with the following configurations:\n   - persistent = true,\n   - systemUsage.memoryUsage.limit = 10*1024*1024 // 10mb broker main memory limit\n   - destinationPolicy.policyEntry.memoryLimit = 1*1024*1024 // 1mb per-destination memory limit\n2. Create a topic durable subscription with prefetchLimit=0.\n3. Create a topic publisher and publish persistent 400kb messages.\n4. (Problem) After publishing 3 messages successfully, PFC kicks in and the above topic publisher gets blocked its publishing.\n\nAt step #4, the expectation is not seeing any publisher blocking for the persistent message publishing until the store limit is reached.  How come the persistent message publishing is limited by 100% memory full?\n\nPer the code inspection, this is because the store cursor of the topic durable subscriber (i.e. TopicStorePrefetch) is working with the main broker's memory limit, not with the per-destination memory limit.  Hence, it keeps increasing broker main memory usage over the per-destination memory limit and after it reached 100% of per-destination limit, PFC kicked in.\n\nI verified that the above scenario went through well if I fix the store cursor to use/refer-to the per-destination memory usage along with its pending list (cache) management.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12595684","id":"12595684","filename":"MemoryLimitTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choijw1","name":"choijw1","key":"choijw1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaewoong Choi","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-02T22:18:22.471+0000","size":11241,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12595684/MemoryLimitTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"341990","customfield_12312823":null,"summary":"Topic persistent message publishing is blocked by hitting 100% of per-destination memory limit if there's any durable subscriber connected but not consuming.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choijw1","name":"choijw1","key":"choijw1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaewoong Choi","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choijw1","name":"choijw1","key":"choijw1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaewoong Choi","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12661495/comment/13728194","id":"13728194","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choijw1","name":"choijw1","key":"choijw1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaewoong Choi","active":true,"timeZone":"America/Los_Angeles"},"body":"This simple standalone test case will demonstrate the blocking situation.  Changing prefetch limit \"prefetchLimitForAll\" will just move the blocking point. Please try setting \"patchApplied\" to true to see how the workaround works.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choijw1","name":"choijw1","key":"choijw1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaewoong Choi","active":true,"timeZone":"America/Los_Angeles"},"created":"2013-08-02T22:18:22.474+0000","updated":"2013-08-02T22:18:58.664+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12661495/comment/14269399","id":"14269399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"body":"What's unexpected about this?  You set a limit on how much space messages can take up in a single destination, you send enough messages to reach/pass that limit, and the broker flow controls you until one or more of those messages are consumed.  This is all by design; where's the bug?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"created":"2015-01-08T14:53:10.794+0000","updated":"2015-01-08T14:53:10.794+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12661495/comment/14269459","id":"14269459","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choijw1","name":"choijw1","key":"choijw1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaewoong Choi","active":true,"timeZone":"America/Los_Angeles"},"body":"Have you read the problem description section at #4 in my original request? In short, why would all \"persistent\" message publishing are blocked by topic's shared memory limit which is only for non-persistent messages, unnecessarily??  That's the problem. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=choijw1","name":"choijw1","key":"choijw1","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jaewoong Choi","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-01-08T15:44:48.153+0000","updated":"2015-01-08T15:44:48.153+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12661495/comment/14272816","id":"14272816","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"body":"I overlooked your statement that you're using persistent messages; sorry about that.\n\nTorsten's comment on Christian's post at http://www.christianposta.com/blog/?p=273 gives a detailed description of why you're seeing this, and of two work-arounds available to you (disabling per-destination memory limits and setting cursorMemoryHighWaterMark to a percentage that is less than the ratio of the per-destination memory limit to the entire-broker memory limit.  Hopefully one of those options is workable for you.\n\nBoth Christian's blog post and Torsten's comments make it clear that this is known and expected behavior.  That's not to say that that's the best possible way for it to work, or that the change you're requesting shouldn't be implemented; I think that it should, as long as the people who know this code well can assure themselves that it doesn't mess up anything else.  But it makes this an Improvement, not a Bug, so you should change the issue type to Improvement.\n\nIf you want it to have the best chance of getting implemented, I'd recommend you reword the title and description to focus on the improvement to be made, not the unwanted behavior that results from not making the change.  It also sounds like you're proposing changing the implementation of AbstractPendingMessageCursor.hasSpace(); is that right?  Since you have an implementation in mind, I'd encourage you to create and attach the patch you're proposing; an already-implemented patch is going to be the most likely to get implemented because it's the least work for whoever might take this on.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"created":"2015-01-11T05:28:52.699+0000","updated":"2015-01-11T05:28:52.699+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4666/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1mxen:"}}