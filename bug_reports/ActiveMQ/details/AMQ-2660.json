{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483745","self":"https://issues.apache.org/jira/rest/api/2/issue/12483745","key":"AMQ-2660","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2010-03-24T06:40:52.648+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Mar 07 21:57:15 UTC 2011","customfield_12310420":"96156","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_30151509803_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-03-07T21:57:15.768+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2660/watchers","watchCount":2,"isWatching":false},"created":"2010-03-23T22:32:05.994+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315621","id":"12315621","description":"","name":"5.3.1","archived":false,"released":true,"releaseDate":"2010-03-23"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-03-07T21:57:15.792+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Running 5.3.1 broken on Win64, using Sun 1.6 x64 JVM.\nMaximum heap size is set to 1024M.\n\nWe're sending and receiving huge messages over ActiveMQ, and cannot get the system running in a stable way.\nFor purposes of testing, we're sending text messages of 100M characters, I guess this means 200MB in-memory, since Strings are stored as UTF16 in JVM memory.\nHowever, with the broker having a 1GB heap this should work - we assume.\n\nTesting with a single producer, single consumer.\n\nWe're using a slightly modified activemq.xml:\n1) \"systemUsage\" block enabled, and configured as shown below:\n-------\n        <systemUsage>\n            <systemUsage>\n                <memoryUsage>\n                    <memoryUsage limit=\"500 mb\"/>\n                </memoryUsage>\n                <storeUsage>\n                    <storeUsage limit=\"1 gb\" name=\"foo\"/>\n                </storeUsage>\n                <tempUsage>\n                    <tempUsage limit=\"100 mb\"/>\n                </tempUsage>\n            </systemUsage>\n        </systemUsage>\n-------\n2) producerFlowControl disabled, as shown below:\n-------\n<policyEntry queue=\">\" producerFlowControl=\"false\" memoryLimit=\"1mb\">\n-------\n\nDescription of symptoms:\n1) Starting up producer, let it run until store gets full. This typically works out to 9 or 10 messages, each being 100M characters in size. From this I'm inferring that ActiveMQ stores these in UTF-8 format.\n2) Starting up consumer\n\nWhen starting the consumer, ActiveMQ broker fails with OOM shown below:\n-------\nERROR | Failed to page in more queue messages\njava.lang.OutOfMemoryError: Java heap space\n        at org.apache.activemq.protobuf.BaseMessage.mergeFramed(BaseMessage.java:228)\n        at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:681)\n        at org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:550)\n        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore$5.execute(KahaDBStore.java:242)\n        at org.apache.kahadb.page.Transaction.execute(Transaction.java:728)\n        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.recoverNextMessages(KahaDBStore.java:235)\n        at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:97)\n        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:251)\n        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.hasNext(AbstractStoreCursor.java:142)\n        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.hasNext(StoreQueueCursor.java:131)\n        at org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1447)\n        at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1585)\n        at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1219)\n        at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n        at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)\n-------\nConsumer keeps waiting, and never actually succeeds in consuming a message.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172415","customfield_12312823":null,"summary":"OutOfMemoryError trying to consume big message","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=taras.tielkes","name":"taras.tielkes","key":"taras.tielkes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Taras Tielkes","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=taras.tielkes","name":"taras.tielkes","key":"taras.tielkes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Taras Tielkes","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483745/comment/12942116","id":"12942116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"You should try enabling compression - by setting the useCompression property on your ActiveMQConnectionFactory\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-24T06:40:52.648+0000","updated":"2010-03-24T06:40:52.648+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483745/comment/12942198","id":"12942198","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=taras.tielkes","name":"taras.tielkes","key":"taras.tielkes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Taras Tielkes","active":true,"timeZone":"Etc/UTC"},"body":"While this test uses a Java client, we're also using STOMP clients for other languages in production, so \"useCompression\" would not help there.\nApart from that, it's just the test that uses text messages. In production we transfer binary structures, which will benefit less from gzip compression.\n\nI *do* appreciate the suggestion of using \"useCompression\" as a *workaround*, but I think there's a structural issue in the broker core here.\nThe broker should not hit an OOM while attempting to service a consumer queue read request.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=taras.tielkes","name":"taras.tielkes","key":"taras.tielkes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Taras Tielkes","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-24T18:22:48.030+0000","updated":"2010-03-24T18:23:11.653+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483745/comment/12942185","id":"12942185","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"if you have really large messages, they the destination pageSize can be reduced and there is also lazyDispatch that with a prefetch of 1 would ensure that there are only as many messages as concurrent consumers in memory at a time.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-24T18:42:36.354+0000","updated":"2010-03-24T18:42:36.354+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483745/comment/12942195","id":"12942195","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=taras.tielkes","name":"taras.tielkes","key":"taras.tielkes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Taras Tielkes","active":true,"timeZone":"Etc/UTC"},"body":"Gary, could you specific in a bit more details which elements/attributes I need to add to make it work like you suggest?\nI'd be happy to perform a batch of stress tests in our environment based on your suggestions.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=taras.tielkes","name":"taras.tielkes","key":"taras.tielkes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Taras Tielkes","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-24T20:53:12.089+0000","updated":"2010-03-24T20:53:12.089+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483745/comment/12942206","id":"12942206","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"the details of how to configure are in http://activemq.apache.org/per-destination-policies.html\nThe attributes in question are maxPageSize (reduce from the 200 default value) or queuePrefetch and lazyDispatch.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-25T09:16:59.723+0000","updated":"2010-03-25T09:16:59.723+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483745/comment/13003638","id":"13003638","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This is a configuration issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-03-07T21:57:15.789+0000","updated":"2011-03-07T21:57:15.789+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2660/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tvin:"}}