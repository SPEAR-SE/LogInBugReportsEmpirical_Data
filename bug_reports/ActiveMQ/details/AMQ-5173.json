{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12712588","self":"https://issues.apache.org/jira/rest/api/2/issue/12712588","key":"AMQ-5173","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-05-06T18:46:40.898+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed May 07 09:09:37 UTC 2014","customfield_12310420":"390904","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_66428004_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-05-07T09:10:04.913+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5173/watchers","watchCount":2,"isWatching":false},"created":"2014-05-06T14:42:56.952+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-05-07T09:10:04.947+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We are seeing an issue where a broker using Kaha DB will gradually increase its footprint on disk over time and never shrink back down again even when all queues are empty.\n\nThe default cleanup settings will reclaim space at first but over time it seems the size of the data directory will grow and never shrink back down to its original size.\n\nI can reproduce this with a test that sends and consumes a large number of messages to a single queue (.net client, broker hosted on windows). The data file grows and will never shrink back down again.\n\n{code}\n        [Test]\n        public void ButLoadOfMessagesOnASingleQueue()\n        {\n            const int messagesPerProducerThread = 1000000;\n            const int numberProducers = 1;\n            const int numberConsumers = 3;\n            var producersConsumers = new List<Task>();\n\n            var factory = new ConnectionFactory\n            {\n                AcknowledgementMode = AcknowledgementMode.Transactional,\n                AsyncSend = true\n            };\n\n            for (var i = 0; i < numberProducers; i++)\n            {\n                var producer = Task.Factory.StartNew(() => Send(factory, messagesPerProducerThread));\n                producersConsumers.Add(producer);\n            }\n            for (var i = 0; i < numberConsumers; i++)\n            {\n                var consumer = Task.Factory.StartNew(() => Consume(factory));\n                producersConsumers.Add(consumer);\n            }\n\n            Task.WaitAll(producersConsumers.ToArray());\n        }\n\n        private void Send(IConnectionFactory connectionFactory, int noMessages)\n        {\n            var connection = connectionFactory.CreateConnection();\n            connection.Start();\n\n            var session = connection.CreateSession();\n            var destination = SessionUtil.GetDestination(session, GetQueueName(1));\n            var producer = session.CreateProducer(destination);\n            for (var i = 0; i < noMessages; i++)\n            {\n                producer.Send(new ActiveMQTextMessage(i.ToString()));\n\n                if (i%100 == 0)\n                    session.Commit();\n            }\n            session.Commit();\n            connection.Close();\n        }\n\n        private void Consume(IConnectionFactory connectionFactory)\n        {\n            var connection = connectionFactory.CreateConnection();\n            connection.Start();\n\n            var session = connection.CreateSession();\n            var destination = SessionUtil.GetDestination(session, GetQueueName(1));\n            var consumer = session.CreateConsumer(destination);\n            var count = 0;\n            while (true)\n            {\n                if (consumer.Receive(TimeSpan.FromSeconds(5)) == null)\n                    break;\n                count++;\n\n                if (count%100 == 0)\n                    session.Commit();\n            }\n            session.Commit();\n            connection.Close();\n        }\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"391139","customfield_12312823":null,"summary":"Kaha DB cleanup fails to reclaim disk space after some time","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=imran99","name":"imran99","key":"imran99","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Imran","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=imran99","name":"imran99","key":"imran99","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Imran","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12712588/comment/13990976","id":"13990976","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Have you tested with a current release of ActiveMQ?  The latest release is v5.9.1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-05-06T18:46:40.898+0000","updated":"2014-05-06T18:46:40.898+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12712588/comment/13991664","id":"13991664","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=imran99","name":"imran99","key":"imran99","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Imran","active":true,"timeZone":"Etc/UTC"},"body":"5.9.1 is not an option for us at the moment. I also didn't see any jiras relating to something similar for releases after 5.6 but i'll install 5.9.1 and give it a try.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=imran99","name":"imran99","key":"imran99","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Imran","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-07T08:22:35.934+0000","updated":"2014-05-07T08:22:35.934+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12712588/comment/13991677","id":"13991677","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=imran99","name":"imran99","key":"imran99","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Imran","active":true,"timeZone":"Etc/UTC"},"body":"[~tabish121] looks like 5.9.1 does handle this better and does not exhibit this behavior when running the same test. Any idea which jira implemented this fix?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=imran99","name":"imran99","key":"imran99","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Imran","active":true,"timeZone":"Etc/UTC"},"created":"2014-05-07T09:09:37.736+0000","updated":"2014-05-07T09:09:37.736+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5173/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1vbuv:"}}