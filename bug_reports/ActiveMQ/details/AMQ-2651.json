{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483428","self":"https://issues.apache.org/jira/rest/api/2/issue/12483428","key":"AMQ-2651","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-04-20T15:17:16.166+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Apr 20 15:17:16 UTC 2010","customfield_12310420":"65689","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_3088458535_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-04-20T15:17:16.251+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2651/watchers","watchCount":0,"isWatching":false},"created":"2010-03-15T21:22:57.716+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[{"id":"12342086","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12342086","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"12483708","key":"AMQ-2652","self":"https://issues.apache.org/jira/rest/api/2/issue/12483708","fields":{"summary":"ActiveMQ non-conformance to JMS Spec causing deadlock when using 3rd-party Resource Adapter","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-02T02:29:43.001+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Linked to forum discussion: http://old.nabble.com/prefetchExtension-off-by-1-for-transacted-consumers-with-prefetchSize-%3E-0-ts27866123.html\n\nHi,\n\nI've searched the forum and JIRA and have noticed that the prefetchExtension in PrefetchSubscription has caused grief before.  However, I think there's still a problem.\n\nFirst, I understand the purpose of the prefetchExtension for the case when prefetchSize = 0.  It allows messages to be dispatched to the consumer when the consumer requests them (i.e. polls them).  However, I don't really understand the purpose of the prefetchExtension for the cases when prefetchSize > 0.  If the consumer has set the prefetchSize to x, shouldn't it always receive only x messages at a time?  Why is the prefetchSize being extended?  I see that it is only extended in the case when the message delivery is transacted but I still don't understand why this is necessary.\n\nIn any case, assuming the prefetchExtension is necessary in the case of prefetchSize > 0 and transacted message delivery, I think the calculation of the prefetchExtension in this case has an off-by-1 error.  I am attaching a junit test that illustrates this problem.\n\nThe test is basically acting like a JCA Resource Adapter and sets up an asynchronous message listener by creating a ConnectionConsumer with a maxMessages value of 1.  This translates into a PrefetchSubscription with a prefetchSize of 1.  The test then sends 3 messages.  The purpose of the 1st message is to trigger the prefetch extension logic in PrefetchSubscription upon the message's ack.  When this happens, the prefetchExtension is set to 1 and the prefetchSize essentially becomes 2.  I believe this is incorrect and is the off-by-1 error (assuming the prefetchExtension is required at all in this case).  The 2nd message is simulated to be a long running message so that when the 3rd message is dispatched, the 2nd message is still being processed.  When the 3rd message is dispatched, because the prefetchSize has been extended, it will try to deliver it even though the processing of the 2nd message has not been completed and even though maxMessages on the ConnectionConsumer was specified as 1.\n\nNow, if I only have 1 ServerSession in the ServerSessionPool, this behavior seems to violate the JMS Spec since the maxMessages parameter used during ConnectionConsumer creation is defined as \"the maximum number of messages that can be assigned to a server session at one time\" and ActiveMQ is trying to assign 2 messages to the same ServerSession at the same time. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461666","id":"12461666","filename":"ASF.LICENSE.NOT.GRANTED--UsePrefetchExtension_Option.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rodos77","name":"rodos77","key":"rodos77","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Rodos","active":true,"timeZone":"America/New_York"},"created":"2010-04-15T15:45:24.866+0000","size":4616,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461666/ASF.LICENSE.NOT.GRANTED--UsePrefetchExtension_Option.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461656","id":"12461656","filename":"OnePrefetchAsyncConsumerTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rodos77","name":"rodos77","key":"rodos77","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Rodos","active":true,"timeZone":"America/New_York"},"created":"2010-03-15T21:24:56.444+0000","size":7479,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461656/OnePrefetchAsyncConsumerTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"159885","customfield_12312823":null,"summary":"prefetchExtension off-by-1 for transacted consumers with prefetchSize > 0","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rodos77","name":"rodos77","key":"rodos77","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Rodos","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rodos77","name":"rodos77","key":"rodos77","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Rodos","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483428/comment/12942355","id":"12942355","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rodos77","name":"rodos77","key":"rodos77","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Rodos","active":true,"timeZone":"America/New_York"},"body":"Attaching junit test.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rodos77","name":"rodos77","key":"rodos77","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Rodos","active":true,"timeZone":"America/New_York"},"created":"2010-03-15T21:24:56.503+0000","updated":"2010-03-15T21:24:56.503+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483428/comment/12942406","id":"12942406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rodos77","name":"rodos77","key":"rodos77","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Rodos","active":true,"timeZone":"America/New_York"},"body":"Patch attached.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rodos77","name":"rodos77","key":"rodos77","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eugene Rodos","active":true,"timeZone":"America/New_York"},"created":"2010-04-15T15:45:24.898+0000","updated":"2010-04-15T15:45:24.898+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483428/comment/12942475","id":"12942475","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolved in r935954\n\npolicyEntry.usePrefetchExtension allows the prefetch extension behaviur to be disabled. When false, and with prefetch of 1 or X, a new message will only be dispatched when the message is acked, rather than when it is delivered. When false, a client ack consumer  or transacted consumer will only ever get prefetch (X) number messages. \n\ncode example of it disabled from the test:\n{code}\n        PolicyMap policyMap = new PolicyMap();\n        PolicyEntry defaultEntry = new PolicyEntry();\n        // ensure prefetch is exact. only delivery next when current is acked\n        defaultEntry.setUsePrefetchExtension(false);\n        policyMap.setDefaultEntry(defaultEntry);\n        broker.setDestinationPolicy(policyMap);{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-04-20T15:17:16.166+0000","updated":"2010-04-20T15:17:16.166+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2651/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rq6f:"}}