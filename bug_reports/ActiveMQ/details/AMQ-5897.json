{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12846362","self":"https://issues.apache.org/jira/rest/api/2/issue/12846362","key":"AMQ-5897","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-07-24T13:13:32.016+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Aug 03 18:15:46 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5897/watchers","watchCount":3,"isWatching":false},"created":"2015-07-20T21:07:22.215+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329382","id":"12329382","name":"5.11.1","archived":false,"released":true,"releaseDate":"2015-02-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-08-03T18:15:46.698+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When a slave takes over for a failed master, pending messages are not delivered.\n\nI have a 5.11 cluster consisting of 2 pairs of master/slaves: m1/s1 and m2/s2.  They use multicast://default for their networkConnectors.  1 subscriber, 1 publisher, also both using multicast urls. My subscriber is a durable subscriber. Msgs are persistent. \n\nI am testing system robustness in the face of a master failure.  I have 3 test cases, of which 2 behave as expected and 1 is problematic.  My publisher connects to a master, sends a set of 10 persistent messages and exits.  The subscriber (durable) receives a message and spends 1 sec simulating processing time, and waits for the next msg (auto-acknowledge). \n\nFor each test case I connect the subscriber, then publish the message set, then kill a master after a few messages are received by the subscriber.  When the slave comes online I expect the remaining msgs to be delivered. \n\n1. subscribe to m2, publish to m2, kill m2. Messages are all delivered \n2. subscribe to m1, publish to m2, kill m2. Messages are all delivered \n3. subscribe to m1, publish to m2, kill m1. Remaining msgs are NOT DELIVERED :( \n\nIn case #3, when m1 is killed I can see the subscriber reconnecting to m2.  The remaining messages are not delivered at that time though.\n\nIf I then connect the subscriber directly to s1 (using tcp:// url), the remaining msgs are indeed delivered. I would have expected s1 to route the remaining msgs to m2 during the test execution, but that did not happen. \n\nWhen I \"kill\" the master I mean that I do \"kill -9 XXXX\".","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746183","id":"12746183","filename":"ActiveMQFailOverDurableMessageListener.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T21:12:24.919+0000","size":4278,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12746183/ActiveMQFailOverDurableMessageListener.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746184","id":"12746184","filename":"ActiveMQFailOverMessageSender.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T21:12:24.922+0000","size":2920,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12746184/ActiveMQFailOverMessageSender.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746179","id":"12746179","filename":"master1-activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T21:12:24.905+0000","size":4687,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12746179/master1-activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746180","id":"12746180","filename":"master2-activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T21:12:24.909+0000","size":4687,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12746180/master2-activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746181","id":"12746181","filename":"slave1-activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T21:12:24.912+0000","size":4686,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12746181/slave1-activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12746182","id":"12746182","filename":"slave2-activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T21:12:24.915+0000","size":4686,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12746182/slave2-activemq.xml"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Slave fails to deliver messages","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Solaris 5.11","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12846362/comment/14634085","id":"14634085","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"activemq.xml files for the 4 nodes in the sample cluster, and the client code to run.\n\nThe consumer is called ActiveMQFailOverDurableMessageListener.java, and I run it using a discovery transport url, like this: \n\n/usr/bin/java -cp . com.xifin.jms.tools.activemq.ActiveMQFailOverDurableMessageListener 'discovery:(multicast://default)?maxReconnectAttempts=10' id\n\nThe producer is called ActiveMQFailOverMessageSender.java, and I run it like this: \n\n/usr/bin/java -cp . com.xifin.jms.tools.activemq.ActiveMQFailOverMessageSender tcp://brokerhost:61612 58\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-20T21:12:24.927+0000","updated":"2015-07-20T21:12:24.927+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12846362/comment/14640430","id":"14640430","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"ah... so durable topics across network of brokers can be confusing as messages can get orphaned on a broker depending on where the durable sub is.  Maybe a little bit related to this? https://issues.apache.org/jira/browse/AMQ-4000\n\nOr to this?\n\nhttp://blog.christianposta.com/activemq/activemq-clustering-durable-subscribers-and-virtual-topics-to-the-rescue/\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2015-07-24T13:13:32.016+0000","updated":"2015-07-24T13:13:32.016+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12846362/comment/14643210","id":"14643210","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"The problem I encountered sounds exactly like the issue you described in your blog post (\"virtual topics to the rescue\").  Not so much like the AMQ-4000 issue though.\n\nThe Virtual Topic solution sounds neat, however I am not interested in going off the JMS reservation and writing custom code to solve this problem.  If I understand correctly, to use Virtual Topics I need to rewrite my consumers to connect to a specially named queue instead of a topic.  This approach will not be portable if we plug-in a different JMS broker.\n\nWe're now looking into using (yep!) ActiveMQ's JDBC Persistence to satisfy our requirements; our performance needs are not tremendous so I am hopeful it will suffice.  It performs as expected for fail-over scenarios, so that is good.\n\nI appreciate your response on this issue!  Thanks. \n\nIs the jira protocol for me to now change the status of this issue to something like \"As Designed\" or somesuch?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-07-27T18:48:20.062+0000","updated":"2015-07-27T18:48:20.062+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12846362/comment/14651993","id":"14651993","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"body":"Thanks for closing the loop!\n\nSo you'll have all of the brokers in the network of brokers attach to the same database instance? \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ceposta","name":"ceposta","key":"ceposta","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=ceposta&avatarId=15051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=ceposta&avatarId=15051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=ceposta&avatarId=15051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=ceposta&avatarId=15051"},"displayName":"Christian Posta","active":true,"timeZone":"America/Phoenix"},"created":"2015-08-03T15:37:18.242+0000","updated":"2015-08-03T15:37:18.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12846362/comment/14652207","id":"14652207","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"body":"The use of a network seems to be the root cause of the lost messages during failover, so we are abandoning the use of a network. Instead we will use Master/Slave shared persistence (a single master broker alive at any one time, with N slaves ready to take over in the event of a master failure).\n\nI had hoped to use JDBC persistence but it did not perform well enough for us under a reasonable load (6+ secs on average to deliver msgs) so we are instead using kahadb which is much faster of course.\n\nWe will have hundreds, if not thousands of connections to the single master; I am hoping that will not be an issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jlindwall","name":"jlindwall","key":"jlindwall","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"John Lindwall","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-08-03T18:15:46.698+0000","updated":"2015-08-03T18:15:46.698+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5897/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2hgt3:"}}