{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482130","self":"https://issues.apache.org/jira/rest/api/2/issue/12482130","key":"AMQ-2440","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315621","id":"12315621","description":"","name":"5.3.1","archived":false,"released":true,"releaseDate":"2010-03-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-10-06T10:15:24.922+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 10 12:50:49 UTC 2010","customfield_12310420":"74946","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_13474763916_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-03-10T12:50:50.057+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2440/watchers","watchCount":1,"isWatching":false},"created":"2009-10-05T13:51:26.141+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-03-10T12:50:50.030+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The bug is observed on code checkout from https://svn.apache.org/repos/asf/activemq/tags/activemq-5.3.0\nA server is initiated with stomp+nio transport on port 61612.\n\nA client connects. A SelectorWorker is created on SelectorManager:68.\nIf the client drops the connection an exception is received at StompNIOTransport:91.\n\"java.io.IOException: An existing connection was forcibly closed by the remote host\".\nBut selector are not cleaned up. It works with stomp transport. But not with stomp+nio.\n\nWhat I see in the end is an increasing number of \"connections\" if the JVM.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461362","id":"12461362","filename":"AMQ-2440-1.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-05T21:18:42.408+0000","size":2349,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461362/AMQ-2440-1.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461374","id":"12461374","filename":"StompDropTestConsumer.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-06T12:42:48.810+0000","size":1184,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461374/StompDropTestConsumer.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461368","id":"12461368","filename":"StompDropTestServer.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-06T12:42:48.661+0000","size":360,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461368/StompDropTestServer.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"159864","customfield_12312823":null,"summary":"stomp+nio leaking file descriptor on client drop","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows XP","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482130/comment/12940885","id":"12940885","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"body":"This is my first shot at fixing it.\n\nSome of the issues I found:\n\n1) SelectorWorker calls Selector.open(), but the selector is never ever closed. I'm closing at SelectorManager.onWorkerEmptyEvent. Not sure if that's the correct spot.\n\n2) StompNIOTransport.serviceRead was not calling selection.close on IOException. NIOTransport does call selection.close on channel.read == -1 but not on IOException.\n\n3) DataInputStream not being closed at StompNIOTransport.serviceRead\n\nI'm still getting some side effects. The exception below happened once on a client disconnect. Seems like a race condition at SelectorWorker.\n\nException in thread \"NIO Transport Thread\" java.nio.channels.ClosedSelectorException\n\tat sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:66)\n\tat sun.nio.ch.SelectorImpl.select(SelectorImpl.java:80)\n\tat org.apache.activemq.transport.nio.SelectorWorker.run(SelectorWorker.java:76)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n\tat java.lang.Thread.run(Thread.java:619)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-05T21:18:42.511+0000","updated":"2009-10-05T21:18:42.511+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482130/comment/12940894","id":"12940894","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"I'm failing to reproduce this problem. Can you provide your testing code (in any language that you have it)? Thanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-10-06T10:15:24.922+0000","updated":"2009-10-06T10:15:24.922+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482130/comment/12940921","id":"12940921","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"body":"- Start a server with a single stomp+nio transport. StompDropTestServer.java attached.\n\n- Now you need a way to see the TCP ports opened by the server process. netstat will do, but I'm using \"Process Explorer\" [1] on Windows XP. Choose the process on the list, go to properties page, TCP/IP tab.\n\n- For the client I'm using the gozirra library, which is a java stomp client [2]. I think StompConnection from ActiveMQ would lead to the same issue. But my application already uses gozirra. Create a client, StompDropTestConsumer.java attached.\nNo matter if the client calls disconnect or not, the server TCP ports will still be opened when the client terminates (and won't be reused).\n\n[1] http://technet.microsoft.com/en-us/sysinternals/bb896653.aspx\n[2] http://www.germane-software.com/software/Java/Gozirra/\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-06T12:41:51.777+0000","updated":"2009-10-06T12:41:51.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482130/comment/12940951","id":"12940951","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"body":"The client requires gozirra client from http://www.germane-software.com/software/Java/Gozirra/","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-06T12:42:48.815+0000","updated":"2009-10-06T12:42:48.815+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482130/comment/12941066","id":"12941066","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"body":"Another thing that disturbs me is that TcpTransport.closeStreams is never called.\nThe only call is commented out at TcpTransport.doStop.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tuler","name":"tuler","key":"tuler","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Danilo Tuler","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-06T19:30:14.614+0000","updated":"2009-10-06T19:30:14.614+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482130/comment/12942330","id":"12942330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"This is now fixed on trunk and 5.3 branch. It's tested manually using StompLoadTest in activemq-systest subproject, which opens/closes a connection for every send/receive and simulates a real load on the broker. This test should be converted to the real system test, but that's the case for another issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2010-03-10T12:50:49.961+0000","updated":"2010-03-10T12:50:49.961+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2440/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rq1r:"}}