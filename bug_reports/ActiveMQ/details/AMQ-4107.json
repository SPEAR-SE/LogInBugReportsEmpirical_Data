{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12611796","self":"https://issues.apache.org/jira/rest/api/2/issue/12611796","key":"AMQ-4107","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-12-17T13:11:11.306+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jan 12 12:02:13 UTC 2015","customfield_12310420":"248654","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_70775578281_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-01-12T12:02:13.526+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4107/watchers","watchCount":6,"isWatching":false},"created":"2012-10-15T08:09:15.309+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-01-12T12:02:13.576+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"For <amq:policyEntry topic=\">\" producerFlowControl=\"true\" memoryLimit=\"30mb\" {color:red}topicPrefetch=\"1\"{color} blockedProducerWarningInterval=\"30\">\n\nShort excerpt from TopicSubscription class:\npublic void add(MessageReference node) throws Exception {\n\n…..\n              if ({color:red}!isFull(){color} && matched.isEmpty()  && !isSlave()) {\n            // if maximumPendingMessages is set we will only discard messages which\n            // have not been dispatched (i.e. we allow the prefetch buffer to be filled)\n       {color:red}dispatch(node);{color}                   <- Second message will go this way and might be dispatched sooner than first one.\n            setSlowConsumer(false);\n        } else {\n…….\nif ({color:red}matched.tryAddMessageLast(node, 10)){color} {    <- first message will be put in the VMCursor queue and might be dispatched later \n        \nbreak;\n                        }\n.....\n {color:red}dispatchMatched();{color}   <- First message won't be dispatched immediately because !isFull() is still false\n}\nPossible scenario as I can see it from logs:\n1. First message has arrived and !isFull() is false because consumer didn't take some previous message yet.\n2. First message will be processed by tryAddMessageLast in VMPendingMessageCursor class and will be dispatched very lately because !isFull() is still false.\n3. Meanwhile consumer reads some previous message and !isFull() will return true.    \n4. Second message will be dispatched immediately and might be first to be delivered. \n5. Then first message is dispatched.\n6. Message order is broken.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12552440","id":"12552440","filename":"4107.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-07T09:08:32.683+0000","size":2857,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12552440/4107.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12622146","id":"12622146","filename":"ActiveMQ-5.9-AMQ-4107.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alexanderz","name":"alexanderz","key":"alexanderz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Zobkov","active":true,"timeZone":"Europe/Moscow"},"created":"2014-01-09T10:01:53.706+0000","size":3366,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12622146/ActiveMQ-5.9-AMQ-4107.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"55875","customfield_12312823":null,"summary":"Message order can be broken for Topic under a high load when topicPrefetch=1 and comsumer is slow","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611796/comment/13492208","id":"13492208","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"body":"Please have a look at the attachment for the patch to fix wrong message order issue.The patch synchronizes a message processing and remove excess syncs inside added sync block.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-07T09:08:32.685+0000","updated":"2012-11-07T09:11:31.056+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611796/comment/13850427","id":"13850427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"body":"Problem reproduces on 5.9.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"created":"2013-12-17T13:11:11.306+0000","updated":"2013-12-17T13:11:11.306+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611796/comment/13866493","id":"13866493","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alexanderz","name":"alexanderz","key":"alexanderz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Zobkov","active":true,"timeZone":"Europe/Moscow"},"body":"A patch to fix the problem on ActiveMQ 5.9","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alexanderz","name":"alexanderz","key":"alexanderz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexander Zobkov","active":true,"timeZone":"Europe/Moscow"},"created":"2014-01-09T10:01:53.715+0000","updated":"2014-01-09T10:01:53.715+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611796/comment/13867772","id":"13867772","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@Alexander that patch looks good but it would be great if it included a junit test case that shows the problem can protect the change into the future.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2014-01-10T13:08:56.757+0000","updated":"2014-01-10T13:08:56.757+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611796/comment/14149593","id":"14149593","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"body":"Will this patch only be applied if a unit test is added for it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"created":"2014-09-26T16:14:50.235+0000","updated":"2014-09-26T16:14:50.235+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611796/comment/14151958","id":"14151958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"body":"Sorry. We have used JMeter based tests for fix proof and don't plan to contribute unit tests at the moment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"created":"2014-09-29T17:55:37.450+0000","updated":"2014-09-29T17:55:37.450+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611796/comment/14273501","id":"14273501","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"seems the intermittent failure of org.apache.activemq.usecases.TwoMulticastDiscoveryBrokerTopicSendReceiveTest shows this problem","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-12T11:30:17.790+0000","updated":"2015-01-12T11:30:17.790+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12611796/comment/14273524","id":"14273524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"fix in http://git-wip-us.apache.org/repos/asf/activemq/commit/8dbb48a2\n\nTwoMulticastDiscoveryBrokerTopicSendReceiveTest provided the test","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-12T12:02:13.566+0000","updated":"2015-01-12T12:02:13.566+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4107/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i09xjj:"}}