{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12551200","self":"https://issues.apache.org/jira/rest/api/2/issue/12551200","key":"AMQ-3809","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2012-04-17T13:38:31.037+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Apr 20 12:30:49 UTC 2012","customfield_12310420":"236064","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_265149993_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-04-20T12:30:49.648+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3809/watchers","watchCount":2,"isWatching":false},"created":"2012-04-17T10:51:39.836+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318549","id":"12318549","name":"5.5.1","archived":false,"released":true,"releaseDate":"2011-10-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-04-20T12:30:49.799+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have a simple consumer application which connects to the broker using failover url. The consumer uses Message listener to asynchronously listen to messages. Whenever i kill my primary broker, I get an EOF exception(which is expected), the consumer tries to connect to failover broker but before it could finish the reconnect, it shuts down. \nMy simple producer connecting with the same failover url never dies and successfully connects to failover broker.\n\nWhat is going on here?\n\nPosting the snippet with which the consumer dies:-\n\n2012-04-17 06:45:25,771 WARN  org.apache.activemq.transport.failover.FailoverTransport - Transport (host1/10.240.170.28:61616) failed to tcp://host1:61616 , attempting to automatically reconnect due to: java.io.EOFException\n2012-04-17 06:45:25,772 DEBUG org.apache.activemq.transport.failover.FailoverTransport - Transport failed with the following exception:\njava.io.EOFException\n        at java.io.DataInputStream.readInt(DataInputStream.java:392)\n        at org.apache.activemq.openwire.OpenWireFormat.unmarshal(OpenWireFormat.java:269)\n        at org.apache.activemq.transport.tcp.TcpTransport.readCommand(TcpTransport.java:227)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:219)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:202)\n        at java.lang.Thread.run(Thread.java:722)\n2012-04-17 06:45:25,774 DEBUG org.apache.activemq.transport.failover.FailoverTransport - urlList connectionList:[tcp://host2:61616, tcp://host1:61616], from: [tcp://host1:61616, tcp://host2:61616]\n2012-04-17 06:45:25,774 DEBUG org.apache.activemq.transport.failover.FailoverTransport - Attempting connect to: tcp://host2:61616\n[20120417 06:45:25.776 EDT (Shutdown-ActiveMQConsumer) ActiveMQConsumer#stop INFO] Stopping the consumer...\n2012-04-17 06:45:26,242 DEBUG org.apache.activemq.transport.failover.FailoverTransport - Stopped.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"249813","customfield_12312823":null,"summary":"Simple ActiveMQ consumer dies on failover","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xbhanu","name":"xbhanu","key":"xbhanu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Bhanu","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xbhanu","name":"xbhanu","key":"xbhanu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Bhanu","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"solaris, linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551200/comment/13255561","id":"13255561","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Can you post a complete sample app that demonstrates your consumer code, can't tell from this snippet what your client is doing.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-04-17T13:38:31.037+0000","updated":"2012-04-17T13:38:31.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551200/comment/13255631","id":"13255631","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xbhanu","name":"xbhanu","key":"xbhanu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Bhanu","active":true,"timeZone":"Etc/UTC"},"body":"Here is a bare-bone implementation of my app:-\n\n\npublic class ActiveMQConsumer implements MessageListener\n{\n    private Connection myConnection;\n    \n    private Session mySession;\n    \n    private void start()\n    {\n        try {\n             ActiveMQConnectionFactory connectionFactory = \n                new ActiveMQConnectionFactory(ActiveMQConnection.DEFAULT_USER,\n                                              ActiveMQConnection.DEFAULT_PASSWORD,\n                                              ourBrokerUrl);\n            myConnection = connectionFactory.createConnection();\n            myConnection.start();\n            mySession = myConnection.createSession(false, Session.AUTO_ACKNOWLEDGE);\n            MessageConsumer consumer = mySession.createConsumer(mySession.createTopic(\"test_topic\"));\n            consumer.setMessageListener(this);\n        }\n        catch (JMSException e) {\n            throw new RuntimeException(e);\n        }     \n    }\n   \n    private void stop()\n    {\n        myConnection.close();\n    }\n   \n    public void onMessage(Message message)\n    {\n\t // Do Something\n    }\n\n    public static void main(final String args[])\n    {\n        TerminatingThreadGroup.runInTerminatingThreadGroup(new Runnable() {\n            public void run()\n            {\n                final ActiveMQConsumer consumer = new ActiveMQConsumer();\n\n                ShutdownTasks.addShutdownHook(new Runnable() {\n                    @Override\n                    public void run()\n                    {\n                        consumer.stop();\n                    }\n                }, \"Shutdown-ActiveMQConsumer\");\n\n                consumer.start();\n            }\n        });\n    }\n}\n\nWhat I might be doing wrong here ??","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xbhanu","name":"xbhanu","key":"xbhanu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Bhanu","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-17T15:12:38.506+0000","updated":"2012-04-17T15:12:38.506+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551200/comment/13255633","id":"13255633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xbhanu","name":"xbhanu","key":"xbhanu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Bhanu","active":true,"timeZone":"Etc/UTC"},"body":"Woah ! Something messed up the indentation quiet badly !! :(\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xbhanu","name":"xbhanu","key":"xbhanu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Bhanu","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-17T15:18:13.989+0000","updated":"2012-04-17T15:18:13.989+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551200/comment/13256031","id":"13256031","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"There doesn't appear to be anything in main preventing the Process from going down, so you are seeing a shutdown related to: AMQ-796","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-04-17T22:55:47.092+0000","updated":"2012-04-17T22:55:47.092+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551200/comment/13256223","id":"13256223","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"I think we should fix AMQ-796","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-18T05:55:29.184+0000","updated":"2012-04-18T05:55:29.184+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551200/comment/13256272","id":"13256272","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xbhanu","name":"xbhanu","key":"xbhanu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Bhanu","active":true,"timeZone":"Etc/UTC"},"body":"Yeah, It seems quiet weird to explicitly maintain a non-daemon thread. From what I understood is in my app the only non-daemon thread was the ActiveMQ Transport thread. When the broker dies, the client Transport thread dies with an EOFException and the failover protocol tries to start a new Transport(non-daemon) thread to initiate connection with the failover broker. In this small window since no thread was non-daemon, the client application exits.\n\nOne shot at AMQ-796 can be something like maintaining a non-daemon failover thread apart from the regular ActiveMQ Transport thread. This failover thread should perform the reconnection and subsequent failover ActivMQ Transport thread spawning.\n\nThanks a lot guys !!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xbhanu","name":"xbhanu","key":"xbhanu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10438","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10438","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10438","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10438"},"displayName":"Bhanu","active":true,"timeZone":"Etc/UTC"},"created":"2012-04-18T07:44:02.654+0000","updated":"2012-04-18T07:44:02.654+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551200/comment/13256486","id":"13256486","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Rob resolved AMQ-796 so you may want to give the latest SNAPSHOT build a go and mark this as resolved if your code is working as expect now.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-04-18T12:32:56.889+0000","updated":"2012-04-18T12:32:56.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12551200/comment/13258182","id":"13258182","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This was resolved by the fix for AMQ-796","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-04-20T12:30:49.759+0000","updated":"2012-04-20T12:30:49.759+0000"}],"maxResults":8,"total":8,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3809/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1757r:"}}