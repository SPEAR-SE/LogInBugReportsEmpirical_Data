{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12509358","self":"https://issues.apache.org/jira/rest/api/2/issue/12509358","key":"AMQ-3358","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2011-06-07T11:31:16.243+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jun 07 18:42:17 UTC 2011","customfield_12310420":"71797","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_101280704_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-06-07T18:42:17.609+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3358/watchers","watchCount":0,"isWatching":false},"created":"2011-06-06T14:34:16.955+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-06-07T18:42:17.655+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313904","id":"12313904","name":"JMX","description":"The JMX support in ActiveMQ"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We have run into a problem in production where our ActiveMQ 5.5 Broker eventually uses thousands of threads. Doing a thread stack dump we have thousands of the following entries:\n\n\"JMX server connection timeout 127937\" daemon prio=10 tid=0x000000001c215000 nid=0x1734 in Object.wait() [0x00002aabd7c97000]\n   java.lang.Thread.State: TIMED_WAITING (on object monitor)\n        at java.lang.Object.wait(Native Method)\n        at com.sun.jmx.remote.internal.ServerCommunicatorAdmin$Timeout.run(ServerCommunicatorAdmin.java:150)\n        - locked <0x00002b74ffe91938> (a [I)\n        at java.lang.Thread.run(Thread.java:619)\n\nWe are using Hyperic HQ to monitor ActiveMQ remotely over JMX.\n\nTo reproduce the problem in a stand-alone environment (without needing Hyperic) :\n1. Start ActiveMQ 5.5 Broker\n2. Connect to ActiveMQ using JConsole and then disconnect\n3. Force a thread dump on the ActiveMQ broker process as follows:\n   kill -QUIT <activemq-pid>\n4. After every JConsole connection to the Broker process the following additional thread is created:\n\"JMX server connection timeout 128\" daemon prio=5 tid=1030bd000 nid=0x1108f8000 in Object.wait() [1108f7000]\n\nUnder ActiveMQ 5.4.2-Fuse-03-09 we do not see this issue. Is there an existing patch somewhere that has just not been applied to 5.5?\n\nSomeone else with the same issue:\nhttp://web.archiveorange.com/archive/v/hXOgqMGA78WNhT5lpmKX\n\nWe found more info on closing the JMX connection:\nhttp://forums.oracle.com/forums/thread.jspa?threadID=1665966&tstart=0\n\nWe are willing to make and submit a patch with a little guidance on where we should call the close() on JMXConnectorFactory.\nIt appears the source file where the change should be made is:\nactivemq-core/src/main/java/org/apache/activemq/broker/jmx/ManagementContext.java\n\nAny help is appreciated.\n\nThank you,\nReid","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"81689","customfield_12312823":null,"summary":"ActiveMQ JMXConnectorFactory is not calling close causing thousands of threads to be created","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=reidmorrison","name":"reidmorrison","key":"reidmorrison","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Reid Morrison","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=reidmorrison","name":"reidmorrison","key":"reidmorrison","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Reid Morrison","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Occurs on RHEL 5 and Mac OS","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12509358/comment/13045375","id":"13045375","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Just based on the provided stack trace it looks like it's a bug in the JVM.  The JVM provides the JMX connection handling implementation.  The ActiveMQ ManagementContext is just registering objects in the JVM's JMX server implementation and that does not use any connections at all.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2011-06-07T11:31:16.243+0000","updated":"2011-06-07T11:31:16.243+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12509358/comment/13045377","id":"13045377","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=reidmorrison","name":"reidmorrison","key":"reidmorrison","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Reid Morrison","active":true,"timeZone":"Etc/UTC"},"body":"Hiram, thank you for the fast response, I will look into the client and make sure it is closing connections to the server. Otherwise, hopefully the JVM has a setting to drop these abandoned connections.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=reidmorrison","name":"reidmorrison","key":"reidmorrison","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Reid Morrison","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-07T11:38:02.866+0000","updated":"2011-06-07T11:38:02.866+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12509358/comment/13045391","id":"13045391","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Just played with this a bit with JConsole and provisioning threads using VisualVM. When connecting to amq connector (port 1099 by default), the thread will be in thread state for two more minutes (JVM default) after closing the connection. And after that period they will be gone. Also\n\n{code}-Djmx.remote.x.server.connection.timeout=0{code}\n\nseems to work for configuring this timeout value","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2011-06-07T12:18:15.353+0000","updated":"2011-06-07T12:18:15.353+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12509358/comment/13045586","id":"13045586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=reidmorrison","name":"reidmorrison","key":"reidmorrison","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Reid Morrison","active":true,"timeZone":"Etc/UTC"},"body":"Downgraded the Hyperic HQ Agent from 4.5.1 to 4.4.0, which stops the threads from being created. Clearly a regression with the Hyperic HQ release.\n\nTried setting -Djmx.remote.x.server.connection.timeout=30000 but the JVM did not close the unused connections/threads.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=reidmorrison","name":"reidmorrison","key":"reidmorrison","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Reid Morrison","active":true,"timeZone":"Etc/UTC"},"created":"2011-06-07T18:42:17.617+0000","updated":"2011-06-07T18:42:17.617+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3358/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ebw7:"}}