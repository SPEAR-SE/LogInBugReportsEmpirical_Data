{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12730988","self":"https://issues.apache.org/jira/rest/api/2/issue/12730988","key":"AMQ-5300","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-10-31T10:53:32.497+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Mar 02 13:45:42 UTC 2015","customfield_12310420":"409060","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_13872289518_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-01-07T17:12:30.404+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5300/watchers","watchCount":12,"isWatching":false},"created":"2014-07-31T03:47:40.962+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-03-02T13:45:42.585+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320200","id":"12320200","name":"activemq-leveldb-store","description":"LevelDB based message store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"While searching for a workaround for issue AMQ-5284, I came across this issue.\n\nTo work around the serialization issue (AMQ-5284), I deleted the index snapshots from the LevelDB datastore. This will replay the logs to regenerate the index. However, if a log rotation has already occurred, you will get an infinite loop upon restart.\n\nHere are the steps to reproduce what I am seeing:\n\nConfigure ActiveMQ 5.10.0 to use a LevelDB data store with the log size of about 1MB.\n{code}\n<persistenceAdapter>\n    <levelDB directory=\"${activemq.data}/leveldb\" logSize=\"1000000\" />\n</persistenceAdapter>\n{code}\n\nThen I started up the broker and published 10,000 persistent messages to a queue, causing the log files to rotate (twice in my case). I see the following files in the data store folder:\n{code}\n-rw-rw-r--. 1 user users 1000071 Jul 30 11:15 0000000000000000.log\n-rw-rw-r--. 1 user users 1000009 Jul 30 11:16 00000000000f4287.log\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:16 00000000001e84d0.index\n-rw-rw-r--. 1 user users 1000000 Jul 30 11:17 00000000001e84d0.log\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:11 dirty.index\n-rw-rw-r--. 1 user users       0 Jul 30 11:11 lock\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:11 plist.index\n-rw-rw-r--. 1 user users      24 Jul 30 11:11 store-version.txt\n{code}\n\nI then consume 5,000 messages, which causes the first log to be deleted since it is no longer being referenced. I see the following log statements:\n{code}\n2014-07-30 11:29:14,960 | DEBUG | Log no longer referenced: 0 | org.apache.activemq.leveldb.LevelDBClient | Thread-2\n2014-07-30 11:29:14,967 | DEBUG | Deleting log at 0 | org.apache.activemq.leveldb.LevelDBClient | Thread-2\n{code}\n\nAnd I see the remaining files in the data store folder (notice the 0000000000000000.log is gone):\n{code}\n-rw-rw-r--. 1 user users 1000009 Jul 30 11:16 00000000000f4287.log\n-rw-rw-r--. 1 user users 1000011 Jul 30 11:29 00000000001e84d0.log\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:29 00000000002dc71b.index\n-rw-rw-r--. 1 user users 1000000 Jul 30 11:29 00000000002dc71b.log\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:11 dirty.index\n-rw-rw-r--. 1 user users       0 Jul 30 11:11 lock\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:11 plist.index\n-rw-rw-r--. 1 user users      24 Jul 30 11:11 store-version.txt\n{code}\n\nAt this point, I shut down the broker and here is the listing of what's left in the data store:\n{code}\n-rw-rw-r--. 1 user users 1000009 Jul 30 11:16 00000000000f4287.log\n-rw-rw-r--. 1 user users 1000011 Jul 30 11:29 00000000001e84d0.log\n-rw-rw-r--. 1 user users 1000000 Jul 30 11:29 00000000002dc71b.log\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:36 0000000000301737.index\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:11 dirty.index\ndrwxrwxr-x. 2 user users    4096 Jul 30 11:11 plist.index\n-rw-rw-r--. 1 user users      24 Jul 30 11:11 store-version.txt\n{code}\n\nI then delete the index folder within the data store (in my case \"0000000000301737.index\"). I am doing this to force a replay of the logs to regenerate the index (due to the serialization issue I ran into).\n\nAnd finally, this is the message I am getting once I start the broker back up (infinite loop of this same message, and I have to shut down the broker):\n\n{code}\n2014-07-30 11:40:27,415 | WARN  | No reader available for position: 0, log_infos: {1000071=LogInfo(/home/user/apache-activemq-5.10.0/data/leveldb/00000000000f4287.log,1000071,1000009), 2000080=LogInfo(/home/user/apache-activemq-5.10.0/data/leveldb/00000000001e84d0.log,2000080,1000011), 3000091=LogInfo(/home/user/apache-activemq-5.10.0/data/leveldb/00000000002dc71b.log,3000091,0)} | org.apache.activemq.leveldb.RecordLog | main\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"409056","customfield_12312823":null,"summary":"Inifinite loop when attempting to replay levelDB logs to rebuild index","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vhle01","name":"vhle01","key":"vhle01","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vu Le","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vhle01","name":"vhle01","key":"vhle01","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vu Le","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730988/comment/14191683","id":"14191683","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"body":"I have seen exact same issue with my ActiveMQ broker (5.10). It looks like a bug, Can someone please take a look here ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=anujkhandelwal","name":"anujkhandelwal","key":"anujkhandelwal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anuj Khandelwal","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-31T10:53:32.497+0000","updated":"2014-10-31T10:53:32.497+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730988/comment/14252456","id":"14252456","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"body":"I'm having similar issues with corruption in AMQ.  could you upload your code for testing?  I can then test it to see if I have similar behavior.  \n\nI may be wrong I think your problem is that it CAN NOT recover in your situation because the log has been deleted and it has no index to start from.\n\nIt should print a better message though.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=burtonator","name":"burtonator","key":"burtonator","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=burtonator&avatarId=22761","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=burtonator&avatarId=22761","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=burtonator&avatarId=22761","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=burtonator&avatarId=22761"},"displayName":"Kevin Burton","active":true,"timeZone":"Etc/UTC"},"created":"2014-12-18T22:47:13.974+0000","updated":"2014-12-18T22:47:13.974+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730988/comment/14267882","id":"14267882","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"fix and test in http://git-wip-us.apache.org/repos/asf/activemq/commit/b54606b1","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-07T17:12:30.451+0000","updated":"2015-01-07T17:12:30.451+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730988/comment/14298185","id":"14298185","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"body":"Hi Good day,\n\nIt seems this issue is not fixed as I have been able to replicated on Replicated Level DB and the lastest 5.11 snapshot. The levelDB corrupts even at the point that every time I kill current master the next slave to take the position starts doing the infinite loop. The only way to fix this is to delete the leveldb data from all ActiveMQ instances which obviously lets me without messages. I find this issue to be quite critical as it occurs even on graceful shut downs of ActiveMQ.\n\nI have a attached a copy of the logs and my levelDB directory. (If all messages on the Queue look the same is because they are, for testing purposes i send the same message over and over)\nhttps://drive.google.com/file/d/0B6ANh1aTzRg3S2Q2SVRUY0ZhT0k/view?usp=sharing\n\n\nMy settings are:\nUbuntu 14.04 64bit\nleveldb jin linux-x64\n\n            <replicatedLevelDB\n                    directory=\"${mailSystem.activeMQ.rebDB}\"\n                    replicas=\"3\"\n                    sync=\"local_mem\"\n                    logSize=\"25413000\"\n                    indexCompression=\"none\"\n                    zkAddress=\"lstkmy90430:2181,lstkmy36606:2181,lstkmy52108:2181\"\n                    zkPath=\"/activemq/leveldb-stores\"\n                    />\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"created":"2015-01-30T04:26:22.255+0000","updated":"2015-01-30T04:53:47.077+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12730988/comment/14343163","id":"14343163","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem.karpenko","name":"artem.karpenko","key":"artem.karpenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Artem Karpenko","active":true,"timeZone":"Europe/Kiev"},"body":"Since this is resolved and specifically mentiones LevelDB, I've opened another issue for Replicated LevelDB: AMQ-5618","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem.karpenko","name":"artem.karpenko","key":"artem.karpenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Artem Karpenko","active":true,"timeZone":"Europe/Kiev"},"created":"2015-03-02T13:45:42.585+0000","updated":"2015-03-02T13:45:42.585+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5300/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1ydsn:"}}