{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482653","self":"https://issues.apache.org/jira/rest/api/2/issue/12482653","key":"AMQ-1585","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-03-21T15:52:45.986+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Sep 08 17:06:02 UTC 2008","customfield_12310420":"84520","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_11644481759_*|*_5_*:*_3_*:*_4999351485_*|*_4_*:*_2_*:*_958970867","customfield_12312321":null,"resolutiondate":"2008-09-08T17:06:02.800+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1585/watchers","watchCount":4,"isWatching":false},"created":"2008-02-17T23:25:58.689+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315614","id":"12315614","description":"","name":"4.1.1","archived":false,"released":true,"releaseDate":"2007-06-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-09-08T17:06:02.798+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"As posted in the AMQ user forum:\nhttp://www.nabble.com/Problems-with-Pure-Master-Slave-in-AMQ-5.0.0-to15471491s2354.html#a15474769\n-------------------\nHi all,\n\nI am having trouble setting up a *stable* ActiveMQ Pure Master/Slave topology.\n\nInitially I have tried v4.1.1 which failed with an exception. I found an AMQ JIRA ticket which said that Pure/Master slave didn't work in v4.1.1.\nOk, so I switched to AMQ 5.0.0, created 2 configs (master/slave, see end of message) and ran two AMQ instances (on the same box) and most of the times my test (see below) worked, but more often I get various error messages like:\n\n- On the slave:\n\nERROR Service                        - Async error occurred: javax.jms.JMSException: Slave broker out of sync with master: Dispatched message (ID:tbuckel-desktop-41814-1202886136210-0:0:565:1:1) was not in the pending list\njavax.jms.JMSException: Slave broker out of sync with master: Dispatched message (ID:tbuckel-desktop-41814-1202886136210-0:0:565:1:1) was not in the pending list\n        at org.apache.activemq.broker.region.PrefetchSubscription.processMessageDispatchNotification(PrefetchSubscription.java:160)\n        at org.apache.activemq.broker.region.AbstractRegion.processDispatchNotification(AbstractRegion.java:381)\n        at org.apache.activemq.broker.region.RegionBroker.processDispatchNotification(RegionBroker.java:550)\n        at org.apache.activemq.broker.BrokerFilter.processDispatchNotification(BrokerFilter.java:201)\n        at org.apache.activemq.broker.BrokerFilter.processDispatchNotification(BrokerFilter.java:201)\n        at org.apache.activemq.broker.BrokerFilter.processDispatchNotification(BrokerFilter.java:201)\n        at org.apache.activemq.broker.MutableBrokerFilter.processDispatchNotification(MutableBrokerFilter.java:211)\n        at org.apache.activemq.broker.TransportConnection.processMessageDispatchNotification(TransportConnection.java:450)\n        at org.apache.activemq.command.MessageDispatchNotification.visit(MessageDispatchNotification.java:77)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:281)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:178)\n        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:100)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)\n        at org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:202)\n        at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n        at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)\n\n\n- After having killed the master, stopped the slave, copied the slave's data into the master's data directory various error message came up (as described in the Master/Slave recovery section), e.g. (internal) ActiveMQ topics were not available, the admin webApp showed exceptions and errors on the client.\n\nThe test I've created uses Spring 2.0.x and pumps 1000 MapMessages in a queue through Spring's JmsTempate, each message is created within its own transaction, using JmsTransactionManager and TransactionTemplate.\nThe created messages are consumed by an initially instantiated transactional DefaultMessageListenerContainer. The AMQ JARs in the test's classpath are activemq-core-5.0.0.jar, geronimo-jms_1.1_spec-1.0.jar, geronimo-jta_1.0.1B_spec-1.0.jar as I've noticed a really bad performance when only using the activemq-all-5.0.0.jar (maybe this is the problem?).\nThe test code work's without problems with OpenMQ, but I'd prefer using the nice Pure Master/Active ActiveMQ if I can get it running in a *stable* config ;)\n\nI would highly appreciate any help or suggestions. Maybe my config is wrong or I miss something essential. I've also tried a recent AMQ 5.1 SNAPSHOT which wasn't better...\n\nSee below for the small program i used to test (no unit test, behaviour appeared to be non deterministic to me and it's not so nice as i've changed it quite often)\n\nThanks in advance,\nThomas\n\n<!-- MASTER config -->\n<beans\n  xmlns=\"http://www.springframework.org/schema/beans\"\n  xmlns:amq=\"http://activemq.org/config/1.0\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n  http://activemq.org/config/1.0 http://activemq.apache.org/schema/activemq-core.xsd\n  http://activemq.apache.org/camel/schema/spring http://activemq.apache.org/camel/schema/spring/camel-spring.xsd\">\n\n  <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"/>\n  <broker xmlns=\"http://activemq.org/config/1.0\" brokerName=\"master\" dataDirectory=\"${activemq.base}/data\">\n    <destinationPolicy>\n      <policyMap>\n        <policyEntries>\n          <policyEntry topic=\"FOO.>\" producerFlowControl=\"false\" memoryLimit=\"1mb\">\n            <dispatchPolicy>\n              <strictOrderDispatchPolicy/>\n            </dispatchPolicy>\n            <subscriptionRecoveryPolicy>\n              <lastImageSubscriptionRecoveryPolicy/>\n            </subscriptionRecoveryPolicy>\n          </policyEntry>\n        </policyEntries>\n      </policyMap> \n    </destinationPolicy>\n\n    <transportConnectors>\n       <transportConnector name=\"openwire\" uri=\"tcp://tbuckel-desktop:7778\" />\n    </transportConnectors>\n\n    <networkConnectors/>\n\n    <managementContext>\n       <managementContext connectorPort=\"1100\" jmxDomainName=\"org.apache.activemq\"/>\n    </managementContext>\n\n  </broker>\n\n  <commandAgent xmlns=\"http://activemq.org/config/1.0\"/>\n\n  <jetty xmlns=\"http://mortbay.com/schemas/jetty/1.0\">\n    <connectors>\n      <nioConnector port=\"8161\" />\n    </connectors>\n\n    <handlers>\n      <webAppContext contextPath=\"/admin\" resourceBase=\"${activemq.base}/webapps/admin\" logUrlOnStart=\"true\" />\n    </handlers>\n  </jetty>\n</beans>\n\n\n<!-- SLAVE config -->\n<beans\n  xmlns=\"http://www.springframework.org/schema/beans\"\n  xmlns:amq=\"http://activemq.org/config/1.0\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n  http://activemq.org/config/1.0 http://activemq.apache.org/schema/activemq-core.xsd\n  http://activemq.apache.org/camel/schema/spring http://activemq.apache.org/camel/schema/spring/camel-spring.xsd\">\n\n  <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"/>\n  \n  <broker xmlns=\"http://activemq.org/config/1.0\" brokerName=\"slave\" dataDirectory=\"${activemq.base}/data-slave\"\n          masterConnectorURI=\"tcp://tbuckel-desktop:7778\">\n  \n    <destinationPolicy>\n      <policyMap>\n        <policyEntries>\n          <policyEntry topic=\"FOO.>\" producerFlowControl=\"false\" memoryLimit=\"1mb\">\n            <dispatchPolicy>\n              <strictOrderDispatchPolicy/>\n            </dispatchPolicy>\n            <subscriptionRecoveryPolicy>\n              <lastImageSubscriptionRecoveryPolicy/>\n            </subscriptionRecoveryPolicy>\n          </policyEntry>\n        </policyEntries>\n      </policyMap>\n    </destinationPolicy>\n\n    <transportConnectors>\n       <transportConnector name=\"openwire\" uri=\"tcp://localhost:7779\"/>\n    </transportConnectors>\n\n    <networkConnectors/>\n\n    <managementContext>\n       <managementContext connectorPort=\"1101\" jmxDomainName=\"org.apache.activemq\"/>\n    </managementContext>\n\n  </broker>\n\n  <commandAgent xmlns=\"http://activemq.org/config/1.0\"/>\n\n  <jetty xmlns=\"http://mortbay.com/schemas/jetty/1.0\">\n    <connectors>\n      <nioConnector port=\"8162\" />\n    </connectors>\n\n    <handlers>\n      <webAppContext contextPath=\"/admin\" resourceBase=\"${activemq.base}/webapps/admin\" logUrlOnStart=\"true\" />\n    </handlers>\n  </jetty>\n\n</beans>\n\n------------\nTest code:\n\nimport org.apache.activemq.ActiveMQConnectionFactory;\nimport org.springframework.jms.connection.JmsTransactionManager;\nimport org.springframework.jms.connection.TransactionAwareConnectionFactoryProxy;\nimport org.springframework.jms.core.JmsTemplate;\nimport org.springframework.jms.core.MessageCreator;\nimport org.springframework.jms.listener.DefaultMessageListenerContainer;\nimport org.springframework.transaction.TransactionStatus;\nimport org.springframework.transaction.support.TransactionCallbackWithoutResult;\nimport org.springframework.transaction.support.TransactionTemplate;\nimport javax.jms.*;\nimport java.math.BigInteger;\nimport java.util.ArrayList;\nimport java.util.List;\nimport java.util.concurrent.TimeUnit;\n\npublic class AnotherFailoverTest {\n\n    public static final int MESSAGES = 1000;\n\n    private final static List<BigInteger> notConsumedMessages = new ArrayList<BigInteger>(MESSAGES);\n\n    private static ConnectionFactory createCF() throws Exception {\n        ActiveMQConnectionFactory cf = new ActiveMQConnectionFactory();\n        cf.setBrokerURL(\"failover://(tcp://localhost:7778,tcp://localhost:7779)?randomize=false\");\n        return new TransactionAwareConnectionFactoryProxy(cf);\n    }\n\n    private static void send() throws Exception {\n        JmsTransactionManager transactionManager = new JmsTransactionManager();\n        transactionManager.setConnectionFactory(createCF());\n        transactionManager.afterPropertiesSet();\n\n        int i=0;\n        do {\n            i++;\n            final int number = i;\n            try {\n                final BigInteger v = new BigInteger(Integer.toString(number));\n                TransactionTemplate tt = new TransactionTemplate(transactionManager);\n                tt.execute(new TransactionCallbackWithoutResult() {\n                    protected void doInTransactionWithoutResult(TransactionStatus status) {\n                        final JmsTemplate template = new JmsTemplate(pcf);\n                        template.setSessionTransacted(true);\n                        template.afterPropertiesSet();\n                        template.send(\"testqueue\", new MessageCreator() {\n                            public Message createMessage(Session session) throws JMSException {\n                                ObjectMessage dummyMessage = session.createObjectMessage();\n                                dummyMessage.setObject(v);\n                                synchronized (notConsumedMessages) {\n                                    notConsumedMessages.add(v);\n                                }\n//                                System.out.println(\"Created message \" + number + \"(\" + notConsumedMessages.size() + \")\");\n                                return dummyMessage;\n                            }\n                        });\n                    }\n                });\n            } catch (Exception e) {\n                e.printStackTrace();\n                System.out.println(\"Error creating message \" + number);\n            }\n        } while (i < MESSAGES);\n    }\n\n    private static void setupReceiver() throws Exception {\n        JmsTransactionManager transactionManager = new JmsTransactionManager();\n        transactionManager.setConnectionFactory(createCF());\n        transactionManager.afterPropertiesSet();\n\n        final DefaultMessageListenerContainer container = new DefaultMessageListenerContainer();\n        container.setConnectionFactory(pcf);\n        container.setTransactionManager(transactionManager);\n        container.setMessageListener(new MessageListener() {\n            public void onMessage(Message message) {\n                try {\n                    ObjectMessage msg = (ObjectMessage) message;\n                    BigInteger number = (BigInteger) msg.getObject();\n                    synchronized (notConsumedMessages) {\n                        if (!notConsumedMessages.remove(number)) {\n                           System.err.println(\"Message \" + number + \" not found in list!\");\n                        } else {\n   //                        System.out.println(\"Consumed message \" + number);\n                       }\n                   }\n                } catch (JMSException e) {\n//                    e.printStackTrace();\n                    System.out.println(\"Error consuming message!\");\n                }\n            }\n        });\n        container.setSessionTransacted(true);\n        container.setDestinationName(\"testqueue\");\n        container.setExceptionListener(new ExceptionListener() {\n            public void onException(JMSException jmsException) {\n                System.err.println(jmsException);\n            }\n        });\n        container.afterPropertiesSet();\n        container.initialize();\n        TimeUnit.SECONDS.sleep(1);\n    }\n\n    public static void main(String[] args) throws Exception {\n        long start = System.currentTimeMillis();\n        setupReceiver();\n        send();\n\n        int remainingSize = 0;\n        do {\n            Thread.sleep(500);\n            synchronized (notConsumedMessages) {\n                remainingSize = notConsumedMessages.size();\n            }\n            System.out.println(\"Unconsumed \" + remainingSize + \": \" + sb);\n        } while (remainingSize > 0);\n\n        System.out.println(\"All messages consumed.\");\n        long end = System.currentTimeMillis();\n        System.out.println((end-start));\n        System.exit(0);\n    }\n\n}\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461169","id":"12461169","filename":"AMQ-1585.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T15:45:44.392+0000","size":4139,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461169/AMQ-1585.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461180","id":"12461180","filename":"AMQ-1585.transacted.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-02T16:14:28.735+0000","size":3835,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461180/AMQ-1585.transacted.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"114345","customfield_12312823":null,"summary":"Problems with pure master/slave configuration","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbuckel","name":"tbuckel","key":"tbuckel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Buckel","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbuckel","name":"tbuckel","key":"tbuckel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Thomas Buckel","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Ubuntu 6.04, JDK 1.5.0_011, Spring 2.0.x","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939404","id":"12939404","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkelley63","name":"mkelley63","key":"mkelley63","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Kelley","active":true,"timeZone":"America/Los_Angeles"},"body":"I'm seeing the same thing -- running 5.0.0 -- using the example consumer/producer ant tasks and configuration described above. This would be a blocker if we were in production.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkelley63","name":"mkelley63","key":"mkelley63","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Kelley","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-03-21T15:52:45.986+0000","updated":"2008-03-21T15:52:45.986+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939525","id":"12939525","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bkorsunsky","name":"bkorsunsky","key":"bkorsunsky","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Boris Korsunsky","active":true,"timeZone":"Etc/UTC"},"body":"Also seeing same issue running 5.0.0 pure master/slave config:\n\njavax.jms.JMSException: Slave broker out of sync with master: Acknowledgment (MessageAck {commandId = 198, responseRequired = true, ackType = 2, consumerId = ID:BorisJr-1198-1207765232687-0:0:1:1, firstMessageId = null, lastMessageId = ID:Boris-3004-1207702245296-0:0:20:1:1, destination = queue://queue, transactionId = null, messageCount = 1}) was not in the dispatch list: []\n        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:332)\n        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:340)\n        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:427)\n        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:73)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:73)\n        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:87)\n        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:440)\n        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:196)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:281)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:178)\n        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:100)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:67)\n        at org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:202)\n        at org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n        at org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bkorsunsky","name":"bkorsunsky","key":"bkorsunsky","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Boris Korsunsky","active":true,"timeZone":"Etc/UTC"},"created":"2008-04-09T18:31:34.623+0000","updated":"2008-04-09T18:31:34.623+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939614","id":"12939614","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkelley63","name":"mkelley63","key":"mkelley63","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Kelley","active":true,"timeZone":"America/Los_Angeles"},"body":"Still a problem in 5.1.0 RC3.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mkelley63","name":"mkelley63","key":"mkelley63","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mike Kelley","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-04-23T17:18:19.575+0000","updated":"2008-04-23T17:18:19.575+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939673","id":"12939673","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ammulder","name":"ammulder","key":"ammulder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Mulder","active":true,"timeZone":"Etc/UTC"},"body":"Still seeing this in 5.1.0 final.\n\nI hear that \"pure\" master/slave is not the way to go and SAN-based master/slave would be better.  :)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ammulder","name":"ammulder","key":"ammulder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Mulder","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-20T19:09:59.525+0000","updated":"2008-05-20T19:09:59.525+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939865","id":"12939865","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I find that the org.apache.activemq.broker.ft.QueueMasterSlaveTest can reproduce this problem if the number of messages produced in increased to 200, greater than the default maxPageSize, 100, for a destination.\n\nIt appears that there are a few problems.\n1) the decrementing inflight statistics cause messages in the slave to be lost once the maxpageSize for a destination is reached. This is fixed by not decrementing in error when queue is on the slave.\n2) the dispatch notification can be late getting to the slave, so similar to send processing, the notification is sent in advance.\n3) even with early sending, a send can be later than a dispatchNotification so sending sync fixes that.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T12:20:20.181+0000","updated":"2008-07-01T12:20:20.181+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939854","id":"12939854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"it may be worth giving the attached patch a whirl if the issue is still pressing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T12:25:35.419+0000","updated":"2008-07-01T12:25:35.419+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939810","id":"12939810","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"still seeing the issue using latest trunk with the patch attached. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T13:51:07.862+0000","updated":"2008-07-01T13:51:07.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939855","id":"12939855","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"ying, thanks for trying this out. Do you think it would be possible to reproduce your scenarion with a variation of org.apache.activemq.broker.ft.QueueMasterSlaveTest ?\nIf not, what is the simplest formula for reproducing your behaviour, is it the code included with the original jira?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T14:06:34.100+0000","updated":"2008-07-01T14:06:34.100+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939903","id":"12939903","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I have been able to reproduce again by pushing more messages through org.apache.activemq.broker.ft.QueueMasterSlaveTest, have some more work to do!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T14:51:29.180+0000","updated":"2008-07-01T14:51:29.180+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939904","id":"12939904","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"hi, Gary, I test on both win xp and solaris 9 jdk 1.5\n\nTo reproduce this issue, i have 1 client producer, I have 3 clients each with its own connection as a consumer\n1. use original activemq.xml for master\n2. add masterConnectorURI=\"tcp://localhost:61616\" shutdownOnMasterFailure=\"false\" in activemq.xml for slave\n3. start master, start slave, start 3 consumers\n4. start the producer to send one message, stop the producer ( the delivery is good)\n5. start the producer again to send a second message, i will get the exception ( because of this exception, message will get redelivered according to the delivery policy)\n\nthe jndi.properties of the client looks like the following:\njava.naming.factory.initial=org.apache.activemq.jndi.ActiveMQInitialContextFactory\njava.naming.provider.url=failover://(tcp://localhost:61616,tcp://localhost:62616)?randomize=false\nconnection.ConnectionFactory.redeliveryPolicy.initialRedeliveryDelay=300000\nconnection.ConnectionFactory.redeliveryPolicy.maximumRedeliveries=3\n\nI have another issue for the pure master/slave, not sure whether it is related to this. It has the same setup as the above tests. the formula is:\n1. use original activemq.xml for master\n2. add masterConnectorURI=\"tcp://localhost:61616\" shutdownOnMasterFailure=\"false\" in activemq.xml for slave\n3. start master, start slave, start 3 consumers\n4. start the producer to send one message, stop the producer ( the delivery is good)\n5. stop the master, stop the slave, do NOT stop 3 consumers,  restart the master, restart the slave\n6. start the producer to send one message, i will get the following exception:\nERROR Service                        - Async error occurred: java.lang.IllegalStateException: Cannot lookup a connection that had not been registered: ID:yhe-1633-1214919996630-0:0\njava.lang.IllegalStateException: Cannot lookup a connection that had not been registered: ID:yhe-1633-1214919996630-0:0\n\tat org.apache.activemq.broker.MapTransportConnectionStateRegister.lookupConnectionState(MapTransportConnectionStateRegister.java:93)\n\tat org.apache.activemq.broker.TransportConnection.lookupConnectionState(TransportConnection.java:1356)\n\tat org.apache.activemq.broker.TransportConnection.processBeginTransaction(TransportConnection.java:362)\n\tat org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:94)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:308)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:180)\n\tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:104)\n\tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n\tat org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:205)\n\tat org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n\tat org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)\nDEBUG Service                        - Error occured while processing sync command: java.lang.IllegalStateException: Cannot lookup a consumer from a connection that had not been registered: ID:yhe-1633-1214919996630-0:0\njava.lang.IllegalStateException: Cannot lookup a consumer from a connection that had not been registered: ID:yhe-1633-1214919996630-0:0\n\tat org.apache.activemq.broker.MapTransportConnectionStateRegister.lookupConnectionState(MapTransportConnectionStateRegister.java:63)\n\tat org.apache.activemq.broker.TransportConnection.lookupConnectionState(TransportConnection.java:1344)\n\tat org.apache.activemq.broker.TransportConnection.getConsumerBrokerExchange(TransportConnection.java:1261)\n\tat org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:458)\n\tat org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:308)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:180)\n\tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:104)\n\tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n\tat org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:205)\n\tat org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n\tat org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)\nDEBUG Service                        - Error occured while processing sync command: java.lang.IllegalStateException: Cannot lookup a connection that had not been registered: ID:yhe-1633-1214919996630-0:0\njava.lang.IllegalStateException: Cannot lookup a connection that had not been registered: ID:yhe-1633-1214919996630-0:0\n\tat org.apache.activemq.broker.MapTransportConnectionStateRegister.lookupConnectionState(MapTransportConnectionStateRegister.java:93)\n\tat org.apache.activemq.broker.TransportConnection.lookupConnectionState(TransportConnection.java:1356)\n\tat org.apache.activemq.broker.TransportConnection.processCommitTransactionOnePhase(TransportConnection.java:413)\n\tat org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:100)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:308)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:180)\n\tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:104)\n\tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n\tat org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:205)\n\tat org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n\tat org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)\n\nI think the issue might be when the master is restarted and the consumer establish connections with it before the slave is started so the slave is not aware of those consumers/sessions/connection\n\nPlease let me know whether i shall create another jira for the this IllegalStateException for pure master/slave\n\nBTW, is there any documentation of the component relationship for the activemq core, such as what the responsibility of BrokerService, Region, Broker, TransportConnection etc. I am looking into the source now to see what I can find.\n\nThank you for your quick response.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T15:05:18.736+0000","updated":"2008-07-01T15:05:18.736+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939898","id":"12939898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"update to fix additional issue.\nmake slave use optimizedDispatch so that a send operation completes sync, since there is no real dispatch the call will return quickly.\nThis ensures that sends are complete before the dispatch notification is received.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T15:45:44.454+0000","updated":"2008-07-01T15:45:44.454+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939880","id":"12939880","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"ying,\nIs your producer using a transacted session? If so, I think we need to build a specific test case around QueueMasterSlaveTest to reproduce.\n\nI have modified the patch to address another synchronisation issue with slave mode, hopefully this will help.\n\nI think you should raise another jira for the IllegalStateException.\nRe documentation, the code is your best and only reference I think.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T16:35:24.175+0000","updated":"2008-07-01T16:35:24.175+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939860","id":"12939860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"patch applied in SVN revision 673157","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-01T18:00:40.445+0000","updated":"2008-07-01T18:00:40.445+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939905","id":"12939905","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"with a transacted producer there is a failure, txid does not exist.\nmodifying the TransactedTopicMasterSlaveTest to stop the master reproduces the problem. The fix is to have the failover transport state tracker rember the transaction begin command so that the begin can be correctly replayed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-02T16:14:28.781+0000","updated":"2008-07-02T16:14:28.781+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939901","id":"12939901","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Applied patch for txn part in SVN revision 673433","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-02T16:23:51.382+0000","updated":"2008-07-02T16:23:51.382+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939944","id":"12939944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"AMQ-1585.patch is not completely merged into the trunk. It is missing the following:\nfor MasterBroker.java\n-        sendToSlave(message);\n+        sendSyncToSlave(message);\n\nWithout this change, I am still getting the exception in the latest trunk activemq-core 675484.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-10T16:10:49.889+0000","updated":"2008-07-10T16:10:49.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939970","id":"12939970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"patch is not completely merged into trunk. it is missing a change without which the exception still happens.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-10T16:11:56.349+0000","updated":"2008-07-10T16:11:56.349+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939958","id":"12939958","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"ying, good catch!. yea, I think that sendSync is necessary. thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-11T15:15:39.976+0000","updated":"2008-07-11T15:15:39.976+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12939977","id":"12939977","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"completed patch in SVN revision 675990","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-11T15:33:33.144+0000","updated":"2008-07-11T15:33:33.144+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12940117","id":"12940117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"I just checked out version 690257 and it happens again:\n\n==== the master ====\n\nINFO  TransportConnection            - Slave Broker solowslave is attached\nWARN  BrokerRegistry                 - Broker localhost not started so using seltenmaster instead\nINFO  TransportConnector             - Connector vm://localhost Started\nERROR MasterBroker                   - Slave Failed\njavax.jms.JMSException: Slave broker out of sync with master: Acknowledgment (MessageAck {commandId = 33, responseRequired = true, ackType = 2, consumerId = ID:hans-34771-1220018526479-0:1:1:1, firstMessageId = null, lastMessageId = ID:hans-34771-1220018526479-0:0:1:1:1, destination = queue://queue.B, transactionId = null, messageCount = 1}) was not in the dispatch list: []\n        at org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:387)\n        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:373)\n        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)\n        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)\n\n\n====== the slave ===\nERROR Service                        - Async error occurred: javax.jms.JMSException: Slave broker out of sync with master: Dispatched message (ID:selten.marketxs.com-55318-1220018484119-2:1:1:1:1) was not in the pending list\njavax.jms.JMSException: Slave broker out of sync with master: Dispatched message (ID:selten.marketxs.com-55318-1220018484119-2:1:1:1:1) was not in the pending list\n        at org.apache.activemq.broker.region.PrefetchSubscription.processMessageDispatchNotification(PrefetchSubscription.java:172)\n        at org.apache.activemq.broker.region.AbstractRegion.processDispatchNotification(AbstractRegion.java:414)\n        at org.apache.activemq.broker.region.RegionBroker.processDispatchNotification(RegionBroker.java:585)\n\n\nA previous 5.2.0-SNAPSHOT worked fine.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-29T14:04:48.682+0000","updated":"2008-08-29T14:04:48.682+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12940136","id":"12940136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"\"worked fine\" except for https://issues.apache.org/activemq/browse/AMQ-1849\n\n\nI've used the same JMS test client (stand-alone)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-29T14:08:37.477+0000","updated":"2008-08-29T14:08:37.477+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12940091","id":"12940091","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"body":"Checked out and compiled revision 675990 again.\n\nStill worked fine (as far as this issue is concerned) with the same configuration files as the failing 690257.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hansb","name":"hansb","key":"hansb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Hans Bausewein","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-29T14:51:49.446+0000","updated":"2008-08-29T14:51:49.446+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482653/comment/12940105","id":"12940105","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"fix related to resolution of https://issues.apache.org/activemq/browse/AMQ-1849","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-08T17:06:02.796+0000","updated":"2008-09-08T17:06:02.796+0000"}],"maxResults":23,"total":23,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1585/votes","votes":4,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0jxfb:"}}