{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482220","self":"https://issues.apache.org/jira/rest/api/2/issue/12482220","key":"AMQ-1202","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-05-09T20:23:12.638+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 18 03:55:52 UTC 2007","customfield_12310420":"84711","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_18957719664_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2007-10-18T03:55:52.598+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1202/watchers","watchCount":2,"isWatching":false},"created":"2007-03-12T17:53:52.934+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-10-18T03:55:52.596+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"If the NetworkConnector list contains any entries to unavailable / unreachable targets, memory is leaked.\n\nTested with a broker having fairly \"stock\" settings, and with the following NetworkConnector section:\n    <networkConnectors>\n      <networkConnector uri=\"static://(tcp://dummy:5111?connectionTimeout=5000)\" prefetchSize=\"10000\"/>\n    </networkConnectors>\n\nI am using JDK 1.6, since that version of jmap allows the \"-histo:live\" switch, producing a list of the live objects.\n\nJust after starting the Broker, here is the top 10 entries from jmap:\nnum   #instances    #bytes  class name\n--------------------------------------\n  1:     36639     4143792  <constMethodKlass>\n  2:     36639     2935200  <methodKlass>\n  3:     54423     2326752  <symbolKlass>\n  4:      8099     2008984  [B\n  5:      3451     1771816  <constantPoolKlass>\n  6:      3451     1433032  <instanceKlassKlass>\n  7:     14220     1212160  [C\n  8:      2894     1089840  <constantPoolCacheKlass>\n  9:         8      524352  [Lorg.apache.activemq.command.DataStructure;\n\n\nAnd then after about 5 minutes or so, here's the jmap top 10:\nnum   #instances    #bytes  class name\n--------------------------------------\n  1:       198    12977712  [Lorg.apache.activemq.command.DataStructure;\n  2:     36647     4144520  <constMethodKlass>\n  3:     36647     2935840  <methodKlass>\n  4:     54427     2326960  <symbolKlass>\n  5:      8293     2207032  [B\n  6:      3455     1773488  <constantPoolKlass>\n  7:      3455     1434376  <instanceKlassKlass>\n  8:     14499     1234040  [C\n  9:      2898     1091120  <constantPoolCacheKlass>\n 10:     17754      426096  java.lang.String\n\n\nNot sure what component down the list is holding onto DataStructure, but I've included the full jmap output files.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460929","id":"12460929","filename":"ASF.LICENSE.NOT.GRANTED--jmap.tar","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-12T17:53:52.958+0000","size":92160,"mimeType":"application/x-tar","content":"https://issues.apache.org/jira/secure/attachment/12460929/ASF.LICENSE.NOT.GRANTED--jmap.tar"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161737","customfield_12312823":null,"summary":"4.2 Broker memory leak wrt network connectors","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482220/comment/12938863","id":"12938863","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"body":"This is kind of an ugly one, but I traced it down to org/apache/activemq/broker/TransportConnector.java and its usage of the connections list.  The code pathway for setting up a Network connection goes as far as calling TransportConnector.onStarted, which adds to this list.  However, this path gets called prior to discovering that the target is not there, but TransportConnector.onStopped is never called.  Thus, TransportConnection objects are leaked into the connections list.\n\nI did not discover yet what use this list is, other than potentially on Broker shutdown, if TransportConnector.stop is called.  So, as a quick work around, I've commented out usage of the connections list in TransportConnector.onStarted and onStopped.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"created":"2007-04-16T15:41:32.247+0000","updated":"2007-04-16T15:41:32.247+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482220/comment/12938988","id":"12938988","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"body":"Another data point, we are running in to this issue as well. It seems to be much worse when the number of connections is large. We run embedded brokers in each of our app server processes, with each broker connected to every other broker (fully connected network). When 9 of the 12 app servers were down it ran through 1.5GB of heap on each of the remaining 3 app servers in about an hour.\n\nAny idea if a fix of this can be put out before 4.2 is released? This is a fairly serious issue for us.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"created":"2007-05-09T20:23:12.638+0000","updated":"2007-05-09T20:23:12.638+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482220/comment/12938930","id":"12938930","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"body":"I've looked in to this a bit more and agree with Kevin. TransportConnector is holding on to TransportConnection instances in the connections list. TransportConnector.onStopped() would remove them from the list, but it never gets called. The reason it never gets called is a bit of a long story:\n\nIf there are multiple NetworkConnector entries, DiscoveryNetworkConnector creates a bridge for each one. A bridge has a local and remote transport, one for each end of the connection. The 'local' transport of each of those bridge connections is an in-VM transport obtained from the VMTransportFactory. \nVMTransportFactory caches it VMTransportServer instances by 'host'. Because it caches these by host, and the host portion of the VM-transport is based on the broker name, all of the bridges' local transports share the same VMTransportServer instance.\nWhen the bridge can't connect to the remote broker, DiscoveryNetworkConnector does the right thing and tries to dispose of the local and remote transports it created. This disposal includes calling VMTransportServer.stop(), which usually includes stopping the releated TransportConnections, which would in turn cause TransportConnector.onStopped(TransportConnection) to be called, thus cleaning up the connections list. BUT becuase there are other bridges running that share the same VMTransportServer, it's connectionCount variable is greater than 0 which prevents it from closing the related transport connections. So the TransportConnector lives on and holds on to useless TransportConnections.\n\nI don't know what can be done to fix this, but at least the details may be useful to someone who wants to look at it further.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"created":"2007-05-21T19:31:41.299+0000","updated":"2007-05-21T19:31:41.299+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482220/comment/12938942","id":"12938942","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"body":"Sorry, Adam.  I should have posted this a little while ago.  I ended up just commenting out the contents of onStarted and onStopped in TransportConnector.  The collections didn't appear to be used for anything - it has been a safe change for us so far.\n\nThere's another, similar, leak.  I'll open a new issue for that.  It involves rejected connections *into* the broker (as opposed to this one which is connections *out* being made by this broker).\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yaussy","name":"yaussy","key":"yaussy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kevin Yaussy","active":true,"timeZone":"Etc/UTC"},"created":"2007-05-23T15:36:51.357+0000","updated":"2007-05-23T15:36:51.357+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482220/comment/12939092","id":"12939092","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Added testcase:  org.apache.activemq.network.NetworkConnectionsCleanedupTest in svn revision 585843\nprofiled for an hour - memory usage remained below 3mb for the jvm in this time","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-10-18T03:55:52.592+0000","updated":"2007-10-18T03:55:52.592+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1202/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s1lz:"}}