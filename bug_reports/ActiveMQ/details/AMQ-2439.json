{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483096","self":"https://issues.apache.org/jira/rest/api/2/issue/12483096","key":"AMQ-2439","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315621","id":"12315621","description":"","name":"5.3.1","archived":false,"released":true,"releaseDate":"2010-03-23"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-10-06T11:21:17.194+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Nov 13 16:13:48 UTC 2009","customfield_12310420":"74947","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_436715237_*|*_5_*:*_2_*:*_3137499867_*|*_4_*:*_1_*:*_6428376","customfield_12312321":null,"resolutiondate":"2009-11-13T03:04:55.806+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2439/watchers","watchCount":0,"isWatching":false},"created":"2009-10-02T16:27:32.326+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-11-13T16:13:48.245+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"Every time the broker is restarted, the same set of duplicate messages get redelivered to consumers.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461445","id":"12461445","filename":"amq2439-patch.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-07T16:09:44.616+0000","size":12788,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12461445/amq2439-patch.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461334","id":"12461334","filename":"AMQ-2439patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"created":"2009-11-13T02:59:45.762+0000","size":33055,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461334/AMQ-2439patch.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"159907","customfield_12312823":null,"summary":"KahaDB + Network of Brokers + Restart = Duplicate Messages that cannot be removed from the data store","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941807","id":"12941807","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"How to reproduce:\nStart broker 1 with config:\n{code:xml}\n<beans\n  xmlns=\"http://www.springframework.org/schema/beans\"\n  xmlns:amq=\"http://activemq.apache.org/schema/core\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd\">\n\n    <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\">\n        <property name=\"locations\">\n            <value>file:${activemq.base}/conf/credentials.properties</value>\n        </property>\n    </bean>\n\n    <broker xmlns=\"http://activemq.apache.org/schema/core\"  brokerName=\"activemq1\" dataDirectory=\"${activemq.base}/data\">\n        <networkConnectors>\n                <networkConnector\n                        uri=\"static://(tcp://localhost:61617)\"\n                        name=\"Connection to 61617\"\n                        dynamicOnly=\"true\"/>\n\n        </networkConnectors>\n        <persistenceAdapter>\n                <kahaDB directory=\"${activemq.base}/data/kaha\" journalMaxFileLength=\"32mb\"/>\n        </persistenceAdapter>\n        <systemUsage>\n          <systemUsage>\n            <memoryUsage>\n              <memoryUsage limit=\"50 mb\" />\n            </memoryUsage>\n            <storeUsage>\n              <storeUsage limit=\"4 gb\" />\n            </storeUsage>\n            <tempUsage>\n              <tempUsage limit=\"200 mb\" />\n            </tempUsage>\n          </systemUsage>\n        </systemUsage>\n        <transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://0.0.0.0:61616\"/>\n        </transportConnectors>\n\n    </broker>\n        <jetty xmlns=\"http://mortbay.com/schemas/jetty/1.0\">\n        <connectors>\n            <nioConnector port=\"8161\"/>\n        </connectors>\n\n        <handlers>\n            <webAppContext contextPath=\"/admin\" resourceBase=\"${activemq.base}/webapps/admin\" logUrlOnStart=\"true\"/>\n        </handlers>\n    </jetty>\n\n</beans>\n{code}\n\nand broker 2 with config:\n{code:xml}\n<beans\n  xmlns=\"http://www.springframework.org/schema/beans\"\n  xmlns:amq=\"http://activemq.apache.org/schema/core\"\n  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n  xsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n  http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd\">\n\n    <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\">\n        <property name=\"locations\">\n            <value>file:${activemq.base}/conf/credentials.properties</value>\n        </property>\n    </bean>\n\n    <broker xmlns=\"http://activemq.apache.org/schema/core\"  brokerName=\"activemq2\" dataDirectory=\"${activemq.base}/data\">\n        <networkConnectors>\n                <networkConnector\n                        uri=\"static://(tcp://localhost:61616)\"\n                        name=\"Connection to 61616\"\n                        dynamicOnly=\"true\"/>\n\n        </networkConnectors>\n        <persistenceAdapter>\n                <kahaDB directory=\"${activemq.base}/data/kaha\" journalMaxFileLength=\"32mb\"/>\n        </persistenceAdapter>\n        <systemUsage>\n          <systemUsage>\n            <memoryUsage>\n              <memoryUsage limit=\"50 mb\" />\n            </memoryUsage>\n            <storeUsage>\n              <storeUsage limit=\"4 gb\" />\n            </storeUsage>\n            <tempUsage>\n              <tempUsage limit=\"200 mb\" />\n            </tempUsage>\n          </systemUsage>\n        </systemUsage>\n        <transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://0.0.0.0:61617\"/>\n        </transportConnectors>\n\n    </broker>\n        <jetty xmlns=\"http://mortbay.com/schemas/jetty/1.0\">\n        <connectors>\n            <nioConnector port=\"8162\"/>\n        </connectors>\n\n        <handlers>\n            <webAppContext contextPath=\"/admin\" resourceBase=\"${activemq.base}/webapps/admin\" logUrlOnStart=\"true\"/>\n        </handlers>\n    </jetty>\n\n</beans>\n{code}\n\nUse the example producer and consumer in the distribution examples dir:\n{code}\nant producer -Durl=tcp://localhost:61616  -Dtopic=false -Ddurable=true -Dmax=1000\n{code}\n{code}\nant consumer -Durl=tcp://localhost:61617 -Dtopic=false -Ddurable=true -Dmax=500\n{code}\n\nrun the producer once.\nrun that consumer 2 times.\nthen restart the broker on port 61617\nand run the consumer again.\n\nThe 3rd run of the consumer should get no messages but it receives multiple messages.  What's worse is that restarting the broker and consumer will result in the same duplicates getting delivered again.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2009-10-02T16:32:35.427+0000","updated":"2009-10-02T16:32:35.427+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941799","id":"12941799","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"I confirmed that KahaDB indexes were inconsistent on a restart and that is the reason the same duplicate message kept getting re-delivered.\nI seems the reason the indexes were becoming inconsistent is because it was not being defensive when it add new messages.  If a duplicate message was added to kahadb it's two of it's btrees would no longer be consistent.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2009-10-02T16:36:55.004+0000","updated":"2009-10-02T16:36:55.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941798","id":"12941798","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"I will work on message store unit test to see if there are any other store which also are not being defensive about dup messages.\n\nWe still need to work out why the broker is tryping to store a dup message in the first place.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2009-10-02T16:38:56.974+0000","updated":"2009-10-02T16:38:56.974+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941815","id":"12941815","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"Rob want to take a crack at figuring out whats causing the dup on the network?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2009-10-02T18:00:47.640+0000","updated":"2009-10-02T18:00:47.640+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12940915","id":"12940915","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"the dups are coming from ignored acks from the network bridge.\nThe network consumer with default prefetch is happy to take all of the messages and they are dispatched async. During the dispatch, the remove consumer is happy with its 500 messages and closes. The close propagates back to the network consumer but between the consumer remove operation and the disposing of the bridge a few messages are dispatched but cannot be acked.\n\nSome logic in: org.apache.activemq.broker.region.AbstractRegion.acknowledge(ConsumerBrokerExchange, MessageAck) is happy to silently ignore the ack and the result is a resend.\n\nThe remove signal should terminate dispatch and await any outstanding ack but not hang forever. need to investigate a bit more to see if there is a solution.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-06T11:21:17.194+0000","updated":"2009-10-06T11:21:17.194+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941110","id":"12941110","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"patch that resolves the duplicate issue, worth a quick review (as I am just doing a test run atm) of the org.apache.activemq.network.DemandSubscription.waitForCompletion() implementation.\nI pulled the existing logic for dealing with acks for no subscriptions in AbstractRegion that was the root cause. With the changes, any acks that don't have a sub should be considered an error and result in an exception.\nwill commit pending no issues showing up in my local test run.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-07T16:09:44.730+0000","updated":"2009-10-07T16:09:44.730+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941113","id":"12941113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolved in r822811\n\nasync dispatch of messages by the bridge was resulting in acks to removed subs as the response to a remove advisory did not know about outstanding requests, the sub now waits till outstanding delivered messages have been acked such that it will not deliver duplicates.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-07T17:46:07.518+0000","updated":"2009-10-07T17:46:07.518+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941149","id":"12941149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"body":"applied my kahadb changes to the 5.3 branch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chirino","name":"chirino","key":"chirino","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=chirino&avatarId=12659","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=chirino&avatarId=12659","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=chirino&avatarId=12659","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=chirino&avatarId=12659"},"displayName":"Hiram Chirino","active":true,"timeZone":"America/New_York"},"created":"2009-10-07T18:38:31.067+0000","updated":"2009-10-07T18:38:31.067+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941363","id":"12941363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"dito. merged duplicate message fix to 5.3 branch: r822811","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-08T10:02:22.339+0000","updated":"2009-10-08T10:02:22.339+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941606","id":"12941606","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"body":"Seeing the exception below in a 2 broker cluster with this fix which is causing the cluster network connection to be dropped. When an MessageDispatch that was sent async is sent through the bridge, it is sent oneway over the transport and then acked back to the local broker in the sending thread. The problem is that peer broker might concurrently be closing the subscription during the send, and the resulting ack now generates an IllegalStateException when the subscription isn't found. To fix, I'm adding tighter synchronization around subscription tear down to avoid this case. (See attached patch)\n\n{code}\n22:19:55 [REMOTE] BROKER1: 22:19:55 WARN  AbstractRegion: Ack for non existent subscription, ack:MessageAck {commandId = 8392, responseRequired = false, ackType = 4, \nconsumerId = ID:nbcmacnaug1-3881-1257920362625-5:1:1:6, firstMessageId = null, lastMessageId = ID:nbcmacnaug1-3919-1257920382750-1:14:1:1:1236, \ndestination = queue://QUEUE-Profile-6, transactionId = null, messageCount = 1} \n22:19:55 [REMOTE] BROKER1: 22:19:55 WARN  Service: Async error occurred: java.lang.IllegalArgumentException: The subscription does not exist: ID:nbcmacnaug1-3881-1257920362625-5:1:1:6 \n22:19:55 [REMOTE] BROKER1: java.lang.IllegalArgumentException: The subscription does not exist: ID:nbcmacnaug1-3881-1257920362625-5:1:1:6 \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:363) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:470) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:449) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.command.MessageAck.visit(MessageAck.java:205) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:297) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:175) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:109) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:112) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.network.DemandForwardingBridgeSupport.serviceLocalCommand(DemandForwardingBridgeSupport.java:708) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.network.DemandForwardingBridgeSupport$1.onCommand(DemandForwardingBridgeSupport.java:159) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:109) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:112) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1190) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:779) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:815) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122) \n22:19:55 [REMOTE] BROKER1: \tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43) \n22:19:55 [REMOTE] BROKER1: \tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650) \n22:19:55 [REMOTE] BROKER1: \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675) \n22:19:55 [REMOTE] BROKER1: \tat java.lang.Thread.run(Thread.java:595) \n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"created":"2009-11-13T01:17:47.382+0000","updated":"2009-11-13T01:17:47.382+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941688","id":"12941688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"body":"Patch for IllegalState Issue  (against revision 835714)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"created":"2009-11-13T02:59:45.862+0000","updated":"2009-11-13T03:00:38.169+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941689","id":"12941689","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"body":"Fixed IllegalStateException issue in revision 835715.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"created":"2009-11-13T03:04:55.739+0000","updated":"2009-11-13T03:04:55.739+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941690","id":"12941690","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"body":"Changing fix to 5.3.1/5.4.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cmacnaug","name":"cmacnaug","key":"cmacnaug","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Colin MacNaughton","active":true,"timeZone":"Etc/UTC"},"created":"2009-11-13T03:06:04.374+0000","updated":"2009-11-13T03:06:04.374+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483096/comment/12941776","id":"12941776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"nice catch, looks good. that is the final bit of the puzzle. :-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-11-13T16:13:48.214+0000","updated":"2009-11-13T16:13:48.214+0000"}],"maxResults":14,"total":14,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2439/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rqbb:"}}