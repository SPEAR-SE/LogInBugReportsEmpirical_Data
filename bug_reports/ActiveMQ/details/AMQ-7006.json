{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13169695","self":"https://issues.apache.org/jira/rest/api/2/issue/13169695","key":"AMQ-7006","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12343307","id":"12343307","description":"","name":"5.15.5","archived":false,"released":true,"releaseDate":"2018-08-09"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2018-07-16T11:44:02.567+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jul 19 20:59:50 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1440606971_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-07-19T21:02:28.797+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-7006/watchers","watchCount":4,"isWatching":false},"created":"2018-07-03T04:52:21.842+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341947","id":"12341947","name":"5.15.3","archived":false,"released":true,"releaseDate":"2018-02-01"}],"issuelinks":[{"id":"12537639","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12537639","type":{"id":"10020","name":"Cloners","inward":"is cloned by","outward":"is a clone of","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10020"},"outwardIssue":{"id":"13161645","key":"AMQ-6975","self":"https://issues.apache.org/jira/rest/api/2/issue/13161645","fields":{"summary":"STOMP protocol converter tracks pending ACKS in Client mode but doesn't remove all ACK'd IDs, just the one submitted.","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-19T21:02:28.808+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12315706","id":"12315706","name":"stomp"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The patch referenced in AMQ-5423 only addressed the memory leak for Client-Individual mode. Client mode is still affected as multiple messages are acknowledged with a single ACK.  The single ACK is removed from memory but all the rest remain which grows over time until AMQ crashes or until the client session ends and all the pending ACKs are cleaned up at that point.  At the moment we are having to regularly restart our STOMP clients to prevent the memory leak from causing a crash.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12931869","id":"12931869","filename":"AMQ-7006_Remove_all_pending_acks_that_have_been_dispatched.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Avikash+Mishra","name":"Avikash Mishra","key":"avikash mishra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34051"},"displayName":"Avikash Mishra","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-17T01:03:22.327+0000","size":3109,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12931869/AMQ-7006_Remove_all_pending_acks_that_have_been_dispatched.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"STOMP protocol converter tracks pending ACKS in Client mode but doesn't remove all ACK'd IDs, just the one submitted.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Avikash+Mishra","name":"Avikash Mishra","key":"avikash mishra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34051"},"displayName":"Avikash Mishra","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Avikash+Mishra","name":"Avikash Mishra","key":"avikash mishra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34051"},"displayName":"Avikash Mishra","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13169695/comment/16545100","id":"16545100","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"This patch looks ok to me but for the logging you should use the SLF4J logger and not System.out.println statements.  In general it's also good to add a test or two (if possible, might be tricky to verify in this case because the behavior is not broken just a memory leak) to show the patch works and to prevent future issues.\r\n\r\n[~tabish121] - Before I merge does since you worked on AMQ-5423 can you take a quick look and make sure this looks good to you as well?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-07-16T11:44:02.567+0000","updated":"2018-07-16T11:44:20.888+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13169695/comment/16545728","id":"16545728","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Avikash+Mishra","name":"Avikash Mishra","key":"avikash mishra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34051"},"displayName":"Avikash Mishra","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~cshannon]\r\n\r\nI have had trouble writing unit tests for this patch. We have it running on our test environment for a few weeks with no issues so far. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Avikash+Mishra","name":"Avikash Mishra","key":"avikash mishra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34051"},"displayName":"Avikash Mishra","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-16T21:01:40.355+0000","updated":"2018-07-16T21:01:40.355+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13169695/comment/16545746","id":"16545746","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"The patch on the surface looks ok as it does seem we are not properly cleaning up.  The cleanUpPendingAcks method seems a bit off as it's comparing every value in the pending map to the values to be removed instead of just trying to remove the values given and reporting the removal if successful which would probably be more performant in the presence of many subscriptions. \r\n\r\nYou might be able to write a test that show you can send an ack for something that should have been ack'd already and compare the ERROR response to see if the message matches expectations as before the fix the message Ack IDs seems to be retained so I'd expect a difference error before and after the fix. \r\n\r\nThe code should be updated to follow the style of the surrounding code instead of introducing your own style and the logging should use the SLF4J loggers and not System.out calls. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2018-07-16T21:25:35.949+0000","updated":"2018-07-16T21:25:35.949+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13169695/comment/16545907","id":"16545907","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Avikash+Mishra","name":"Avikash Mishra","key":"avikash mishra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34051"},"displayName":"Avikash Mishra","active":true,"timeZone":"Etc/UTC"},"body":"Hi [~tabish121]\r\n\r\nI did think of looping through the values just given. But at the point where I am adding elements to my removeMessageIds I don't have access to the 'ackId' which is the key for the pedingAcks array. So all I have is the messageId which is a property of ActEntry. ActEntry is the value of the pedingAcks array. \r\n\r\nFor the unit tests I did try to check against different ERROR responses. The issue is line 445 in ProtocolConverter.java. The method call to pendingAck.onMessageAck(activemqTx); always returns null if we are 'acking' a message that as already been acked because inside that method it checks whether the message is in the dispatchedMessage array (which it isn't because it removes it correctly). So the response always returns 'Unexpected ACK received for message-id 123'\r\n\r\nIf you have any other ideas of how to write a unit test for this let me know. \r\n\r\nI have just updated the patch with the logging changes. Please review as we would like to push this to our prod environment in the next release. \r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Avikash+Mishra","name":"Avikash Mishra","key":"avikash mishra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=34051","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=34051","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=34051","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=34051"},"displayName":"Avikash Mishra","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-17T00:57:17.907+0000","updated":"2018-07-17T00:57:17.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13169695/comment/16549855","id":"16549855","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 9abbe826ecc47596fb43fd42e094d403c56b158d in activemq's branch refs/heads/master from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9abbe82 ]\n\nAMQ-7006 Remove STOMP pending acks after client acknowledge\n\nReworked patch from Avikash Mishra to remove tracked pending acks from a\nSTOMP subscription that has acked.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-19T20:59:05.401+0000","updated":"2018-07-19T20:59:05.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13169695/comment/16549858","id":"16549858","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 4bcc991d72c6b8bccc764ce2a704324ec9544803 in activemq's branch refs/heads/activemq-5.15.x from [~tabish121]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=4bcc991 ]\n\nAMQ-7006 Remove STOMP pending acks after client acknowledge\n\nReworked patch from Avikash Mishra to remove tracked pending acks from a\nSTOMP subscription that has acked.\n(cherry picked from commit 9abbe826ecc47596fb43fd42e094d403c56b158d)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-19T20:59:50.625+0000","updated":"2018-07-19T20:59:50.625+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-7006/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3vh7r:"}}