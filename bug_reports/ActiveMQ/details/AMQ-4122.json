{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12612994","self":"https://issues.apache.org/jira/rest/api/2/issue/12612994","key":"AMQ-4122","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-10-23T13:21:01.416+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Mar 06 09:05:35 UTC 2014","customfield_12310420":"250366","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1570133182_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-11-09T20:16:19.026+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4122/watchers","watchCount":8,"isWatching":false},"created":"2012-10-22T16:07:25.864+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"}],"issuelinks":[{"id":"12360092","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12360092","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12611903","key":"AMQ-4108","self":"https://issues.apache.org/jira/rest/api/2/issue/12611903","fields":{"summary":"Cannot receive 'ActiveMQ.Advisory.MasterBroker' messages when master dies and slave takes control","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-06T09:05:35.676+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We are using ActiveMQ 5.7.0 together with a mysql database and could not observe correct failover behavior with lease database locker.\nIt seems that there is a race condition, which prevents the correct failover procedure.\nWe noticed that when starting up two instances, both instance are becoming master.\n\nWe did several test, including the following and could not observe intended functionality:\n- shutdown all instances\n- manipulate database lock that one node has lock and set expiry time in distance future\n- start up both instances. both instances are unable to acquire lock, as the lock hasn't expired, which should be correct behavior.\n- update the expiry time in database, so that the lock is expired.\n- first instance notices expired lock and becomes master\n- when second instance checks for lock, it also updates the database and becomes master.\n\nTo my understanding the second instance should not be able to update the lock, as it is held by the first instance and should not be able to become master.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12551023","id":"12551023","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fieldju","name":"fieldju","key":"fieldju","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Justin Field","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-26T21:15:00.075+0000","size":3811,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12551023/activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12550630","id":"12550630","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=seyffchr","name":"seyffchr","key":"seyffchr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=seyffchr&avatarId=16145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=seyffchr&avatarId=16145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=seyffchr&avatarId=16145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=seyffchr&avatarId=16145"},"displayName":"Christoph Seyffer","active":true,"timeZone":"Europe/Berlin"},"created":"2012-10-24T14:14:33.703+0000","size":7952,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12550630/activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12552677","id":"12552677","filename":"activemq-kyle.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=millkyl","name":"millkyl","key":"millkyl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kyle Miller","active":true,"timeZone":"America/New_York"},"created":"2012-11-08T17:45:03.719+0000","size":5921,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12552677/activemq-kyle.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12633081","id":"12633081","filename":"amq_dual_master_5.7_backport.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=metatech","name":"metatech","key":"metatech","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"metatech","active":true,"timeZone":"Europe/Berlin"},"created":"2014-03-06T09:05:35.648+0000","size":2257,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12633081/amq_dual_master_5.7_backport.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12570282","id":"12570282","filename":"AMQ4122.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-02-21T09:34:27.373+0000","size":4520,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12570282/AMQ4122.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12570319","id":"12570319","filename":"mysql.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"created":"2013-02-21T16:23:35.454+0000","size":17662,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12570319/mysql.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"61768","customfield_12312823":null,"summary":"Lease Database Locker failover broken","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Java 7u9, SUSE 11, Mysql","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13482310","id":"13482310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"are the broker names unique for master and slave. If not, then you need to provide unique names to the locker via setLeaseHolderId in xml config.\n\nIf possible, could you try and make a variant of org.apache.activemq.store.jdbc.LeaseDatabaseLockerTest (from activemq-core) that demonstrates the problem you are seeing.\nThat test uses an embedded derby instance, but you can fire off sql to that instance to simulate whatever changes you want.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-10-23T13:21:01.416+0000","updated":"2012-10-23T13:21:01.416+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13483260","id":"13483260","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=seyffchr","name":"seyffchr","key":"seyffchr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=seyffchr&avatarId=16145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=seyffchr&avatarId=16145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=seyffchr&avatarId=16145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=seyffchr&avatarId=16145"},"displayName":"Christoph Seyffer","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Gary, I attached our current activemq.xml which was active on two nodes (master/slave). As you can see the broker attribute useLocalHostBrokerName is set to true. The broker registers with its unique hostname.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=seyffchr","name":"seyffchr","key":"seyffchr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=seyffchr&avatarId=16145","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=seyffchr&avatarId=16145","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=seyffchr&avatarId=16145","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=seyffchr&avatarId=16145"},"displayName":"Christoph Seyffer","active":true,"timeZone":"Europe/Berlin"},"created":"2012-10-24T14:14:33.705+0000","updated":"2012-10-24T14:15:27.021+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13483533","id":"13483533","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"thanks for the config Christoph, I went ahead and built a simple unit test based on your description. It works fine. Maybe I need to add more contention, ie: more locks to try and replicate a race condition. The locker currently verifies that it succeeded in acquiring the lock by doing a lease extend immediately after, so it should be safe but there may be need for a random pause in there.\nCan you peek at the test case and see if it reflects your use case and is possible modify it such that it breaks?\nhttp://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/store/jdbc/LeaseDatabaseLockerTest.java?view=diff&r1=1401848&r2=1401849&pathrev=1401849","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-10-24T20:06:28.264+0000","updated":"2012-10-24T20:06:28.264+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13485200","id":"13485200","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fieldju","name":"fieldju","key":"fieldju","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Justin Field","active":true,"timeZone":"America/Los_Angeles"},"body":"I can also confirm that I am having the same issue.\n\nI have to brokers running on 2 different machines and when I kill the mysql DB, \nand it comes back online both brokers both become the master.\n\nI also attached my activeMQ config\nand here is a screen shot of the log\nhttp://i.imgur.com/ZS4Er.jpg","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fieldju","name":"fieldju","key":"fieldju","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Justin Field","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-26T21:09:39.199+0000","updated":"2012-10-26T21:20:58.661+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13485247","id":"13485247","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fieldju","name":"fieldju","key":"fieldju","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Justin Field","active":true,"timeZone":"America/Los_Angeles"},"body":"looks like I was using the depreciated setDatabaseLocker when i should have been using setLocker.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fieldju","name":"fieldju","key":"fieldju","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Justin Field","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-10-26T22:30:33.789+0000","updated":"2012-10-26T22:30:33.789+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13493324","id":"13493324","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=millkyl","name":"millkyl","key":"millkyl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kyle Miller","active":true,"timeZone":"America/New_York"},"body":"We are seeing a similar issue.  After debugging, I've found some odd behavior. \n\nWhen the LockableServiceSupport class gets a \"false\" back from the LeaseDatabaseBaseLocker.keepAlive() method, it calls LockableServiceSupport.stopBroker().\n\nOn line 132 of LockableServiceSupport:\n\nLOG.info(brokerService.getBrokerName() + \", no longer able to keep the exclusive lock so giving up being a master\");\n\nThis fails for me with a NullPointerException, which kills the thread, but does not stop the broker.\n\nIt turns out, there is an org.apache.activemq.broker.BrokerService variable (brokerService) that is null.  However, there is also a org.apache.activemq.xbean.XBeanBrokerService variable (brokerService) that is not null.  This is odd.\n\nI'm guessing that I have a problem with my configuration.  I will be posting mine as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=millkyl","name":"millkyl","key":"millkyl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kyle Miller","active":true,"timeZone":"America/New_York"},"created":"2012-11-08T17:35:11.250+0000","updated":"2012-11-08T17:35:11.250+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13493329","id":"13493329","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fieldju","name":"fieldju","key":"fieldju","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Justin Field","active":true,"timeZone":"America/Los_Angeles"},"body":"I was never able to resolve the issue so i made the following work around\nI basically have each broker query the db to get who the current Master should be (based of the brokers hostname)\ncompare it to its host name and check the isSlave value. if there is a discrepancy I shut the broker down and create a new one.\n\nActiveMQ Broker Monitor\nhttps://gist.github.com/4040309\n\nActiveMQ bean definitions / configuration\nhttps://gist.github.com/4040646\n\nParallel Ingestion ActiveMQ Manager\nhttps://gist.github.com/4fc5669d41f25072d2f4\n\nBroker Factory (see bean definition in ActiveMQ bean definitions)\nhttps://gist.github.com/8ad9cf6ace9245c63f41","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fieldju","name":"fieldju","key":"fieldju","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Justin Field","active":true,"timeZone":"America/Los_Angeles"},"created":"2012-11-08T17:41:45.665+0000","updated":"2012-11-08T18:45:03.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13493533","id":"13493533","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=millkyl","name":"millkyl","key":"millkyl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kyle Miller","active":true,"timeZone":"America/New_York"},"body":"I looked at things a bit closer and realized that there is a bug that is contributing to this behavior.\n\norg.apache.activemq.broker.LockableServiceSupport has a private BrokerService variable.  It implements BrokerServiceAware and has a method setBrokerService(...).\n\norg.apache.activemq.store.jdbc.JDBCPersistenceAdapter (which extends from LockableServiceSupport) ALSO has a private BrokerService variable.  It ALSO implements BrokerServiceAware and has a method setBrokerService(...).  Because it extends from LockableServiceSupport, it overrides the setter and consequently, the private BrokerService variable will NEVER be set.\n\nI think that the JDBCPersistenceAdapter class should get rid of its private BrokerService variable (and setter).  This will solve the issue that I was seeing with 2 active master brokers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=millkyl","name":"millkyl","key":"millkyl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kyle Miller","active":true,"timeZone":"America/New_York"},"created":"2012-11-08T21:54:46.424+0000","updated":"2012-11-08T21:54:46.424+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13494058","id":"13494058","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"the duplicate hiding brokerService variable in JDBCPersistenceAdapter was resolved by https://issues.apache.org/jira/browse/AMQ-4108 but there is still the need to tidy up the inheritance structure.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-09T15:46:59.794+0000","updated":"2012-11-09T15:46:59.794+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13494061","id":"13494061","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"hidden brokerService var removed as part of the fix for AMQ-4108","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-09T15:48:24.173+0000","updated":"2012-11-09T15:48:24.173+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13494281","id":"13494281","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Closing this off, did the final bit of tidy up in: http://svn.apache.org/viewvc?rev=1407614&view=rev\n\nIt would be great if you could validate a 5.8-SNAPSHOT at some stage.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-11-09T20:16:19.041+0000","updated":"2012-11-09T20:16:19.041+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13582204","id":"13582204","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"body":"I did some first tests with the 5.8 Release version. The lease database locker seems to work as expected now. However, it seems that it is always the last node that is available that becomes master. \nFor instance:\nstart node1 -> node1 is master\nstart node2 -> node1 gives up being master; node2 becomes master\nstop node1 -> node2 stays master\nstart node1 -> node2 gives up being master; node1 becomes master\nWhile I am not sure if this is the intended behavior, right now I do not expect any issues with that.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"created":"2013-02-20T14:23:05.013+0000","updated":"2013-02-20T14:23:05.013+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13582509","id":"13582509","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@st.h - that is not expected unless all of the brokers have the same name. I would be great to see a sql log of the db for the lock table as the nodes attempt to get the lock","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-20T20:43:59.396+0000","updated":"2013-02-20T20:43:59.396+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13582517","id":"13582517","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"body":"I have configured ActiveMQ to use the hostnames. The master correctly shows up with its hostname in the DB, so that should be good. Is it possible to configure ActiveMQ to log the sql statements, or do you need the DBs log? The latter one might be a problem here.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"created":"2013-02-20T21:06:08.907+0000","updated":"2013-02-20T21:06:08.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13582563","id":"13582563","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@st.h was thinking the latter. Or maybe there is a logging sql driver or wrapper. The broker does not provide this, well not the data in prepared statements which is the interesting part. For that reason, the logs from the DB is best. And the DB is common to all brokers so it should provide the interesting overlap etc.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-20T21:55:55.217+0000","updated":"2013-02-20T21:55:55.217+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13583010","id":"13583010","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"I also see the same unexpected behavior experienced by st.h.\nNew broker starts up will obtain the lease lock successfully every time and no slaves can keep standing.\nThe patch I attached may reveal the cause.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-02-21T08:41:55.320+0000","updated":"2013-02-21T08:41:55.320+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13583318","id":"13583318","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"body":"Please find the query log attached. This is a simple test I have run on two Ubuntu servers VMs. It is basically starting node-h03-ap21 in console mode, which becomes master. Then I started up node-h03-ap22 in console mode, which takes over as master. node-h03-ap21 automatically quits as soon as node-h03-ap22 becomes master.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"created":"2013-02-21T16:23:35.457+0000","updated":"2013-02-21T16:23:35.457+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13583817","id":"13583817","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"The cause is that LeaseDatabaseLocker always succeed updating the broker name (the owner of the lease lock) by later lease time in contrast to the current lease owner,that means new broker will always obtain the lease lock and the previous owner has to give up the lock and becomes slave. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-02-22T02:05:05.106+0000","updated":"2013-02-22T02:05:05.106+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13583822","id":"13583822","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"The patch works for me and you may give a try.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-02-22T02:10:54.546+0000","updated":"2013-02-22T02:10:54.546+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13584596","id":"13584596","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@st.h - thanks for the slq log.\nFrom looking at https://issues.apache.org/jira/secure/attachment/12570319/mysql.log, it looks like a configuration problem.\nnode-h03-ap21 is obtaining a 5s lease that it renews every 10s. So there is a s period when the lease is available to others.\n\nIt needs to obtain a 10 second lease and update it every 5 seconds. So that a second (slave) broker always sees time > now when it attempts an update as part of an acquire.\n\nYou need:\n{code}\n<jdbcPersistenceAdapter ... lockKeepAlivePeriod=\"5000\">\n   ..\n   <locker>\n     <lease-database-locker lockAcquireSleepInterval=\"10000\"/>\n   </locker>\n{code}\nlockAcquireSleepInterval is the lease duration, lockKeepAlivePeriod is the lease renew period. On a renew, the lease is extended by the lockAcquireSleepInterval (lease duration). So a master is always (lockAcquireSleepInterval - lockKeepAlivePeriod) ahead with its lease.\nIn short, ensure: lockAcquireSleepInterval > lockKeepAlivePeriod.\n\nCan you verify this.\nI think it may also makes sense to add lease related attributes to this locker. leaseDuration, leaseRenewPeriod so that it is a little more intuitive and obvious that the leaseDuration > leaseRenewPeriod\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-22T19:49:17.240+0000","updated":"2013-02-25T11:57:57.083+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13585090","id":"13585090","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"[~gtully]st.h uploaded the query log not me.\nIn fact I already know that lockAcquireSleepInterval should be greater than lockKeepAlivePeriod.\nTheir names are not intuitive indeed, new names seem very well.\nI had tested your suggested configuration before you told me, there are two problems:\n1. The duplicate hiding brokerService variable in JDBCPersistenceAdapter causes the presence of multiple master brokers(solved by AMQ-4108).\n2. The subsequent problem after problem 1 is that a new startup broker always succeeds in obtaining the lease lock and becomes master and the previous master unexpectedly loses the lock and terminates.No brokers can keep obtaining the lease lock all the time.\nThe cause is that LeaseDatabaseLocker always succeed updating the broker name (the owner of the lease lock) by later lease time in contrast to the current lease owner.\nI have tested my patch and it solves the problems.\nCan you review and verify it? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-02-23T11:12:54.082+0000","updated":"2013-02-23T11:12:54.082+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13585816","id":"13585816","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"@SouNayi  - thanks for the feedback. on {quote}The cause is that LeaseDatabaseLocker always succeed updating the broker name (the owner of the lease lock) by later lease time in contrast to the current lease owner.{quote}\n\nCan you make a variant of https://fisheye6.atlassian.com/viewrep/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/store/jdbc/LeaseDatabaseLockerTest.java that shows the problem? I don't see a problem against derby in the unit test. Note: in the unit test there is no periodic call to keepalive.\nThe intent of the update to acquire a lock checks the TIME value against current time and sets it to obtain the lease. It should (and does) fail if the lease is still valid. ie: the time is set to a value in the future.https://issues.apache.org/jira/browse/AMQ-4122?page=com.atlassian.jira.plugin.system.issuetabpanels:comment-tabpanel#","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-25T12:06:20.775+0000","updated":"2013-02-25T12:06:20.775+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13585841","id":"13585841","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"body":"Gary, I can confirm expected behavior when applying your changes. Thanks. However, I would suggest the following changes:\n- modify the documentation to show the correct configuration. currently it shows {{lockKeepAlivePeriod=\"10000\"  lockAcquireSleepInterval=\"5000\"}}, which has been the config I used for the tests.\n- in case lockAcquireSleepInterval < lockKeepAlivePeriod, at least log a warning.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=st.h","name":"st.h","key":"st.h","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"st.h","active":true,"timeZone":"Europe/Berlin"},"created":"2013-02-25T13:06:44.626+0000","updated":"2013-02-25T13:06:44.626+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13586913","id":"13586913","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"@Gary,verification is passed for amq 5.8.\nI misread the parameter order for the lease obtain statement so I made a wrong presumption.\nSorry for your time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-02-26T08:01:28.071+0000","updated":"2013-02-26T08:01:28.071+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13587195","id":"13587195","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"thanks for closing the loop.\n\nadded LOG warning if lockKeepAlivePeriod < lockAcquireSleepInterval","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2013-02-26T15:28:24.340+0000","updated":"2013-02-26T15:28:24.340+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13640778","id":"13640778","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgaudet","name":"jgaudet","key":"jgaudet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Gaudet","active":true,"timeZone":"America/Chicago"},"body":"I noticed that the code in the attached patch differs from the code in 5.8.  Although perhaps different in form, is this fix a part of 5.8?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgaudet","name":"jgaudet","key":"jgaudet","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Gaudet","active":true,"timeZone":"America/Chicago"},"created":"2013-04-24T18:43:53.465+0000","updated":"2013-04-24T18:43:53.465+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12612994/comment/13922181","id":"13922181","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=metatech","name":"metatech","key":"metatech","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"metatech","active":true,"timeZone":"Europe/Berlin"},"body":"For those using ServiceMix 4.5, the file \"amq_dual_master_5.7_backport.patch\" provides a backport for ActiveMQ 5.7. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=metatech","name":"metatech","key":"metatech","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"metatech","active":true,"timeZone":"Europe/Berlin"},"created":"2014-03-06T09:05:35.654+0000","updated":"2014-03-06T09:05:35.654+0000"}],"maxResults":27,"total":27,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4122/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0axx3:"}}