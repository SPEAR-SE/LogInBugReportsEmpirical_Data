{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483788","self":"https://issues.apache.org/jira/rest/api/2/issue/12483788","key":"AMQ-1873","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315630","id":"12315630","description":"Issues that need to be reviewed - do we keep 'em or do we kick 'em? ","name":"NEEDS_REVIEW","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2009-10-30T12:44:40.679+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Jul 05 20:31:25 UTC 2011","customfield_12310420":"69108","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_92493015379_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-07-05T20:31:25.367+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1873/watchers","watchCount":8,"isWatching":false},"created":"2008-07-30T08:01:10.002+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-07-05T20:31:25.378+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I'm actually testing ActiveMQ with a python stomp Client (stomp.py http://www.briggs.net.nz/log/projects/stomppy/).\n\nI'm trying to load the broker with ~200 producers (on ~200 hosts) feeding one TOPIC for only one consumer.\n\nEverything is working almost fine until the client connection fails.\n\nThe ActiveMQ log displays :\n...\n2008-07-30 09:28:43,665 [localhost:61613] ERROR TransportConnector             - Could not accept connection : Too many open files\n2008-07-30 09:28:43,665 [localhost:61613] DEBUG TransportConnector             - Reason: Too many open files\njava.net.SocketException: Too many open files\n\tat java.net.PlainSocketImpl.socketAccept(Native Method)\n\tat java.net.PlainSocketImpl.accept(PlainSocketImpl.java:384)\n\tat java.net.ServerSocket.implAccept(ServerSocket.java:450)\n\tat java.net.ServerSocket.accept(ServerSocket.java:421)\n\tat org.apache.activemq.transport.tcp.TcpTransportServer.run(TcpTransportServer.java:221)\n\tat java.lang.Thread.run(Thread.java:595)\n\nWhen I look at the open files (or connections) (with lsof) I see 65446 lines like :\n\njava    26765 root *066u  sock        0,4          7534034 can't identify protocol\n\nThis seems to indicate that ActiveMQ doesn't totally released the UNIX socket\n\nI'm attaching the activemq.xml conf file.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461126","id":"12461126","filename":"ASF.LICENSE.NOT.GRANTED--activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=devemy","name":"devemy","key":"devemy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Julien Devemy","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-30T08:01:10.006+0000","size":5126,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12461126/ASF.LICENSE.NOT.GRANTED--activemq.xml"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172198","customfield_12312823":null,"summary":"Stomp connections doesn't seem to be released cleanly (Too many open files error)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=devemy","name":"devemy","key":"devemy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Julien Devemy","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=devemy","name":"devemy","key":"devemy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Julien Devemy","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux RHEL 4\njava version \"1.5.0_15\"\nJava(TM) 2 Runtime Environment, Standard Edition (build 1.5.0_15-b04)\nJava HotSpot(TM) Server VM (build 1.5.0_15-b04, mixed mode)\n","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483788/comment/12941399","id":"12941399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alex.hollerith","name":"alex.hollerith","key":"alex.hollerith","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alex Hollerith","active":true,"timeZone":"Etc/UTC"},"body":"config:\n<policyEntry queue=\">\" producerFlowControl=\"true\" memoryLimit=\"5mb\">\n\nsetup:\n1 perl stomp producer producing into a queue,\n  connecting and disconnecting on every post,\n  rather low frequency of posts (0.5/minute)\n0 consumers\n\nbehaviour:\nworks OK until around 68 messages are in the queue (surely depends on the size of the messages)\n\nafter that you get this in the log:\n2009-10-29 20:32:05,189 | INFO  | Usage Manager memory limit reached on queue://test.soccerfeeds.queue. Producers will be throttled to the rate at which messages are removed <...>\n\nAnd while the activemq service is in that \"throttling producers\" state you will see CLOSE_WAIT sockets building up:\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:41519    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:36141    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:45840    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:43793    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:40212    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:44060    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:43776    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:44032    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:43781    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:40200    CLOSE_WAIT\ntcp        0      0 ::ffff:10.60.1.51:61613     ::ffff:10.60.1.206:44045    CLOSE_WAIT\n\nYou can watch the numbers grow with:\nwatch --interval=5 'netstat -an |grep tcp |grep 61613 | grep CLOSE_WAIT |wc -l'\n\nEvery post increases the number of CLOSE_WAIT sockets by 1. And the sockets will not go away, the number seems to be steadily growing.\n\nJust consume one single message (we did it via the admin webinterface) and the number of sockets in CLOSE_WAIT drops to 0 instantly.\n\n[root@bladedist01 activemq]# netstat -an |grep tcp |grep 61613\ntcp        0      0 :::61613                    :::*                        LISTEN\n\nOur theory is that activemq does somehow manage to build up sockets in CLOSE_WAIT state while it is \"throttling producers\" mode on a given queue until, eventually, the system runs out of resources (file descriptors in this case).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alex.hollerith","name":"alex.hollerith","key":"alex.hollerith","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alex Hollerith","active":true,"timeZone":"Etc/UTC"},"created":"2009-10-30T12:44:40.679+0000","updated":"2009-10-30T12:44:40.679+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483788/comment/12941956","id":"12941956","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ruben.wagner%40gmx.net","name":"ruben.wagner@gmx.net","key":"ruben.wagner@gmx.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ruben Wagner","active":true,"timeZone":"Etc/UTC"},"body":"We can reproduce this issue on a Linux platform which runs under a high load. One client is sufficient to produce the stale sockets.\nThe client has to do something like (perl):\n{code}\nwhile(1)\n{\n    my $c = Stomp::Connection->new(host=>\"localhost\", port=>61613 );\n    $c->Send( \"/topic/foo\", \"hi5\" );\n    $c->Disconnect();\n}\n{code}\nWe have reproduced the problem with the following transport connectors:\n- stomp (Perl, PHP)\n- stomp+nio (Perl, PHP)\n- openwire (Java)\n\nWe have reproduced the problem with the following builds: 5.3.2, 5.3.1, 5.4-SNAPSHOT (we did not try the others)\n\nIt looks like a race condition to me, as the problem occures more often, the weaker the running machine is. It does not occure when I add a short sleep to my test script.\n\nTesting environments:\n#1:\nLinux version 2.6.26.8+pata\njava version \"1.6.0_12\"\nJava(TM) SE Runtime Environment (build 1.6.0_12-b04)\nJava HotSpot(TM) 64-Bit Server VM (build 11.2-b01, mixed mode)\n\n#2:\nLinux version 2.6.32-23-generic-pae\njava version \"1.6.0_20\"\nJava(TM) SE Runtime Environment (build 1.6.0_20-b02)\nJava HotSpot(TM) Server VM (build 16.3-b01, mixed mode)\n\nP.S.\nexcuse my english, I'm not a native speaker","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ruben.wagner%40gmx.net","name":"ruben.wagner@gmx.net","key":"ruben.wagner@gmx.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ruben Wagner","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-21T09:21:25.466+0000","updated":"2010-07-21T09:21:25.466+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483788/comment/13019837","id":"13019837","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rws_urbancode","name":"rws_urbancode","key":"rws_urbancode","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Smith","active":true,"timeZone":"Etc/UTC"},"body":"Is this the same issue as AMQ-1739 ?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rws_urbancode","name":"rws_urbancode","key":"rws_urbancode","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ryan Smith","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-14T14:08:00.953+0000","updated":"2011-04-14T14:08:00.953+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483788/comment/13060116","id":"13060116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This is in some ways related to AMQ-3393. There is also the fact that Stomp 1.0 doesn't allow for a keep alive so sometimes connection drops aren't detected. \n\nReopen if the problem persists.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-07-05T20:31:25.376+0000","updated":"2011-07-05T20:31:25.376+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1873/votes","votes":8,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tu6f:"}}