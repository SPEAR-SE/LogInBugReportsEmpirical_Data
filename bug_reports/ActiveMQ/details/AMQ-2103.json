{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483485","self":"https://issues.apache.org/jira/rest/api/2/issue/12483485","key":"AMQ-2103","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315625","id":"12315625","description":"","name":"5.4.2","archived":false,"released":true,"releaseDate":"2010-12-02"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-02-11T07:34:54.210+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Oct 14 11:24:48 UTC 2010","customfield_12310420":"14757","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_39953122_*|*_5_*:*_3_*:*_52508695708_*|*_4_*:*_2_*:*_209098686","customfield_12312321":null,"resolutiondate":"2010-10-14T11:24:48.736+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2103/watchers","watchCount":0,"isWatching":false},"created":"2009-02-10T20:29:01.220+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"issuelinks":[{"id":"12463040","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12463040","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12839815","key":"AMQ-5857","self":"https://issues.apache.org/jira/rest/api/2/issue/12839815","fields":{"summary":"Message content stored twice while sending","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12469902","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12469902","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12978816","key":"AMQ-6323","self":"https://issues.apache.org/jira/rest/api/2/issue/12978816","fields":{"summary":"Support reduceMemoryFootprint flag for Topics","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/2","id":"2","description":"A new feature of the product, which has yet to be developed.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21141&avatarType=issuetype","name":"New Feature","subtask":false,"avatarId":21141}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-06-14T14:37:52.512+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When an org.apache.activemq.command.ActiveMQTextMessage is marshaled into the persistence store some portion of the messages are stored in memory (i.e. pending cursor/consumer dispatch queue).  The messages stored in memory have the potential to cause the broker to run out of memory because org.apache.activemq.command.ActiveMQTextMessage objects can store the data twice, once in the 'text' field and once in the 'content' field.  Normally this isn't a problem since the 'content' field is cleared when the message is being used in a client application (i.e. by calling getText() clears content).  The problem occurs when a consumer is slow and a large number of messages are sitting around on the broker in pending/dispatch memory space.  The message is marshaled for the store and then persisted to disk and copied to pending memory when space is available.\n\nThis bug affects any ActiveMQ*Message object that does not clear its temporary data (i.e. 'text' field) once it has been marshaled.  When a message is marshaled we should null the derived objects memory space once the data has been written to the parent object's 'content' field.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461209","id":"12461209","filename":"AMQ-2103.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:33:35.218+0000","size":563,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12461209/AMQ-2103.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461351","id":"12461351","filename":"Duplicate Message Data (Internal Marshalling).png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:30:23.195+0000","size":78474,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12461351/Duplicate+Message+Data+%28Internal+Marshalling%29.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461297","id":"12461297","filename":"heap_100_1MB_messages.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T22:21:00.792+0000","size":94871,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12461297/heap_100_1MB_messages.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461251","id":"12461251","filename":"jhat_ActiveMQTextMessage_0xe837a478.htm","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:31:23.042+0000","size":3683,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12461251/jhat_ActiveMQTextMessage_0xe837a478.htm"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461208","id":"12461208","filename":"jhat_ByteSequence_0xe837a5c0.htm","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:31:55.364+0000","size":1108,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12461208/jhat_ByteSequence_0xe837a5c0.htm"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461285","id":"12461285","filename":"jhat_ByteSequence_data_0xe837adb0.htm","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:32:20.089+0000","size":6048,"mimeType":"text/html","content":"https://issues.apache.org/jira/secure/attachment/12461285/jhat_ByteSequence_data_0xe837adb0.htm"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"63723","customfield_12312823":null,"summary":"Memory leak when marshaling ActiveMQTextMessage to persistent store","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"ActiveMQ 5.0.0.20-fuse","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940748","id":"12940748","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"attaching memory usage diagram showing how the message data can be duplicated.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:30:23.286+0000","updated":"2009-02-10T20:30:23.286+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940756","id":"12940756","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"attaching jhat heap analysis showing ActiveMQTextMessage object with duplicate data.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:31:23.085+0000","updated":"2009-02-10T20:31:23.085+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940762","id":"12940762","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"attaching jhat heap analysis showing ActiveMQTextMessage->ByteSequence object holding the byte array data.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:31:55.386+0000","updated":"2009-02-10T20:31:55.386+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940741","id":"12940741","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"attaching jhat heap analysis showing ActiveMQTextMessage->ByteSequence->byte array object holding the message data.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:32:20.125+0000","updated":"2009-02-10T20:32:20.125+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940743","id":"12940743","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"attaching patch that clears ActiveMQTextMessage 'text' field data when marshaling.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T20:33:35.541+0000","updated":"2009-02-10T20:33:35.541+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940765","id":"12940765","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"I also forgot to mention that this probably only affects use cases with something like vm transport where the message stays internal to the same JVM and is not marshaled across the wire.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T21:07:01.028+0000","updated":"2009-02-10T21:07:01.028+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940764","id":"12940764","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"attaching heap usage graph comparing memory before and after applying patch ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-10T22:21:00.881+0000","updated":"2009-02-10T22:21:00.881+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940738","id":"12940738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Patch applied in SVN revision 743258","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-11T07:34:54.210+0000","updated":"2009-02-11T07:34:54.210+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12940769","id":"12940769","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"Rob did you look at all to see if this affects other message types (i.e. ActiveMQObjectMessage, ActiveMQMapMessage)?  I believe some of these these suffer from the same problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-11T17:22:45.068+0000","updated":"2009-02-11T17:22:45.068+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12943045","id":"12943045","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"This fix breaks the topic case with multiple consumers and a vm transport producer. There is contention over marshaling so whacking the marshaled state is not possible, results in missing content for some of the consumers. https://issues.apache.org/activemq/browse/AMQ-2966\n\nThink the fix is to have an reduceMemoryFootprint policy option that when enabled for queues, will clear the marshaled state (can work for map and object messages also) when the message is first persisted. This is a natural sync point that is contention free provided the concurrentStoreAndDispatchQueue KahaDB option that tries to optimize out persistence, is not enabled.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-11T16:23:52.621+0000","updated":"2010-10-11T16:23:52.621+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12943042","id":"12943042","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"patch reverted and new policy based solution applied in r1021466\n\nThe patch, setting the text attribute to null, was unprotected. Currently there are no destructive operations, on a message, allowing it to be shared across topic consumers without synchronization, which allows concurrent dispatch to be fast. This is important to maintain.\n\nA new destination policy for queues, boolean attribute reduceMemoryFootprint has been introduced to do meet this use case.\nWhen true, the marshaled state of a message will be cleared once the message is persisted in the store. This is a natural, contention free sync point.\nNote:  The kahaDB concurrentStoreAndForwardQueues option (which introduces concurrency) and the memory persistence adapter (which will not marshall) are not compatible with this new policy.\n\nTrevor, can you validate that this change meet your use case?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-11T19:18:08.557+0000","updated":"2010-10-11T19:18:08.557+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12943048","id":"12943048","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"body":"This fix looks like it will work but I do have some concerns implementing it as a destination policy. Wouldn't it make more sense to implement this using SoftReferences or a hook into the MarshallAware interface?  In my opinion it makes sense to clear memory at the discretion of the collector when the message has been completely serialized to disk when there is not enough memory. The actual problem I was trying to solve was to prevent \"hidden\" memory from hanging around that was not tied to the ActiveMQ memory usage policies. I could be missing something here but it seems there are disjoint philosophies for memory management related to overall broker memory usage, fast dispatch cursors and other unaccounted for \"live\" objects. I'm not sure what to do here but the proposed fix (including my original submission) seems like a kludge at best. Does anyone else have other opinions?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tpounds","name":"tpounds","key":"tpounds","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Trevor Pounds","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-12T04:13:37.889+0000","updated":"2010-10-12T04:13:37.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12942818","id":"12942818","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I think there is merit in the original use case, but soft references would not cut it as the messages are retained in memory by the cursors and there is duplication. The key issue with any destruction of a message in memory is that it requires a sync point. A general MarshallAware interface hook would require a sync on message that would have a large impact on scaleability of topics.\n\nI agree, that there needs to be some tie with available vm memory and cursor memory usage, but that sort of scheme would require major surgery atm.\n\nMemory management is something that is central to the amq 6.0 (apollo) architecture. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-12T09:30:43.385+0000","updated":"2010-10-12T09:30:43.385+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483485/comment/12943053","id":"12943053","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolving. \naddressing any further limitations to the memory usage tracking as it pertains to actual jvm usage will be punted to 6.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-14T11:24:48.704+0000","updated":"2010-10-14T11:24:48.704+0000"}],"maxResults":14,"total":14,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2103/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0b9xz:"}}