{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483314","self":"https://issues.apache.org/jira/rest/api/2/issue/12483314","key":"AMQ-1992","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2008-11-03T10:04:58.175+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Sep 27 21:06:25 UTC 2011","customfield_12310420":"33644","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_91628684800_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-09-27T21:06:25.960+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1992/watchers","watchCount":2,"isWatching":false},"created":"2008-11-01T08:41:41.216+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-09-27T21:06:26.010+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"To reproduce BUG follow instructions:\n\n1. Unpack fresh AMQ (versions 5.1.0, 5.2.0, 5.3.0-SNAPSHOT)\n\n2. Edit $AMQ_HOME/examples/ProducerTool.java turn on transacted mode and persisting messages. \n(I have modified source code directly because I couldn't change this parameters through build.xml. Change is simple.)\nPatch:\n78,79d77\n<             transacted = true;\n< \n88,89d85\n<             persistent = true;\n< \n\n3. Start AMQ $AMQ_HOME/bin/activemq\n\n4. Start producer $AMQ_HOME/examples/ant producer -DmessageSize=200000\n\n5. Producer will block (on commit method) after approximately 27 messages (which is OK for selected message size and default max queues size 5Mb)\n\n6. Stop producer and AMQ in any order (CTRL-C in terminal)\n\n7. Start AMQ  $AMQ_HOME/bin/activemq\n\n8. Start producer $AMQ_HOME/examples/ant producer -DmessageSize=200000\nProducer will continue to queue messages infinitely.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172239","customfield_12312823":null,"summary":"flow control doesn't work after first restart (if producer works in transacted mode with persistent messages)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vmatic","name":"vmatic","key":"vmatic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Viktor Matic","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vmatic","name":"vmatic","key":"vmatic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Viktor Matic","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Intel MAC OSX Java (build 1.5.0_16-b06-284)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483314/comment/12940427","id":"12940427","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vmatic","name":"vmatic","key":"vmatic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Viktor Matic","active":true,"timeZone":"Etc/UTC"},"body":"The same BUG can be reproduced if AMQ is configured without journal and with JDBCPersistenceAdaptor. I've reproduced it with postgres JDBC.\n\nIf  JDBCPersistenceAdaptor is used in combination with journal, AMQ allows queuing of new 28 messages after every restart. Which is also wrong because messages are accumulated with each AMQ restart. This behavior is different then previously described case in which flow control allows infinite queuing after first restart.  Also I have checked table activemq_msgs in postgres and found that messages are really persisted and accumulated after first restart.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vmatic","name":"vmatic","key":"vmatic","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Viktor Matic","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-02T11:29:59.249+0000","updated":"2008-11-02T11:29:59.249+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483314/comment/12940406","id":"12940406","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgracin","name":"jgracin","key":"jgracin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Josip Gracin","active":true,"timeZone":"Etc/UTC"},"body":"Adding a bit to this report... The problem seems to be related to the fact that we're using persistent messages.  Furthermore, with persistent messages, we're getting (easily reproducible) lock-ups of producers.  When a producer gets throttled back by flow control, it ends up in waitForSpace() and it never returns (despite of consuming all the messages in its queue).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgracin","name":"jgracin","key":"jgracin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Josip Gracin","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-03T10:04:58.175+0000","updated":"2008-11-03T10:04:58.175+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483314/comment/12940496","id":"12940496","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deansher","name":"deansher","key":"deansher","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dean Thompson","active":true,"timeZone":"Etc/UTC"},"body":"We ran into a different problem, but came across information that may shed light on the present problem.\n\nWe at mSpoke had a problem (with version 5.2.0, using topics and durable subscriptions) where all producers would lock up when we used producer flow control.  What's strange is that the producers were *not* explicitly waiting in ActiveMQMessageProducer in the call to producerWindow.waitForSpace().  Instead, the producers were blocked waiting for acks.  But the problem went away when we disabled producer flow control.  \n\nAs I traced through the ActiveMQ code to try to understand what might be happening, I found myself with two concerns:\n\n(1) Possibly pertinent to Josip Gracin's observation above (11/3/08), I am concerned that the calculation of available flow-control-window is based on totalling the message sizes as measured by the producer and subtracting the message sizes as measured by the consumer (or at least by whatever ends up producing the ack).  But the code in org.apache.activemq.command.Message#getSize() is a bit complex; how sure are we that the same size will be reported across marshalling/unmarshalling operations and in different contexts?\n\n(2) In trying to understand how enabling producer flow-control might have left the producer waiting forever for an ack that never came, I see fairly complex code in org.apache.activemq.broker.region.Topic#send that schedules a deferred ack when the topic is full.  I believe our consumers are functioning correctly (and indeed our whole system works once we disable producer flow-control), so I don't see how any topic remained full forever -- yet, our producers wound up waiting for acks forever.  So I am suspicious that the acks deferred by                   messagesWaitingForSpace.add(new Runnable() {...} may, under some circumstances, never get sent.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=deansher","name":"deansher","key":"deansher","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dean Thompson","active":true,"timeZone":"Etc/UTC"},"created":"2008-11-25T17:03:30.475+0000","updated":"2008-11-25T17:03:30.475+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483314/comment/12942233","id":"12942233","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=francesco.degrassi%40emaze.net","name":"francesco.degrassi@emaze.net","key":"francesco.degrassi@emaze.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francesco Degrassi","active":true,"timeZone":"Etc/UTC"},"body":"We experienced this problem with ActiveMQ 5.3.0.\nToday it seems to be fixed in 5.3.1-SNAPSHOT.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=francesco.degrassi%40emaze.net","name":"francesco.degrassi@emaze.net","key":"francesco.degrassi@emaze.net","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Francesco Degrassi","active":true,"timeZone":"Etc/UTC"},"created":"2010-02-17T14:00:50.380+0000","updated":"2010-02-17T14:01:04.125+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483314/comment/13115922","id":"13115922","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"No test case given to reproduce and commenter report issue is not seen in later build.  Should test against a new release and see if you still see the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-09-27T21:06:25.999+0000","updated":"2011-09-27T21:06:25.999+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1992/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tufj:"}}