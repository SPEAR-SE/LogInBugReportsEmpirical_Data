{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12750379","self":"https://issues.apache.org/jira/rest/api/2/issue/12750379","key":"AMQ-5410","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2014-11-01T13:04:13.041+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Nov 03 17:39:50 UTC 2014","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_870465734_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-11-03T17:39:50.923+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5410/watchers","watchCount":3,"isWatching":false},"created":"2014-10-24T15:52:05.231+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-11-03T17:39:50.960+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12318701","id":"12318701","name":"MQTT","description":"MQTT Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"broker network setup with mqtt enabled.\n\nscenario:\n\nClient (C1) connects to MQ1\nC1 publishes message M1 to topic T1\nC1 receives the message M1 by doing receive using mqtt client. \nC1 publishes message M2,M3 to topic T1 and disconnects.\n\nC1 connects back to MQ2\nC1 does a receive. Now M3 is received first instead of M2.\n\n The following testcase shows the issues. The testcase is part of activemq-unit-tests/src/test/java/org/apache/activemq/network/MQTTNetworkOfBrokersFailoverTest.java \n\n{code:title=MQTTNetworkOfBrokersFailoverTest.java|borderStyle=solid}\n    @Test\n    public void testOutOfOrderMessageScenario() throws Exception{\n        // A Consumer subscribing to an topic and Publishing to the same topic receives the messages out of order\n        //  and some messages lost\n        // after failing over and connecting to other broker\n        CountDownLatch consumerNetworked = listenForConsumersOn(broker);\n\n        MQTT localMqtt = createMQTTTcpConnection(\"foo\", false, localBrokerMQTTPort);\n        BlockingConnection localConn = localMqtt.blockingConnection();\n        localConn.connect();\n        localConn.subscribe(new Topic[]{new Topic(\"foo/bar\", QoS.EXACTLY_ONCE)});\n        String msg = \"Hello, World!\";\n        localConn.publish(\"foo/bar\", msg.getBytes(), QoS.EXACTLY_ONCE, false);\n        localConn.publish(\"foo/bar\", \"2\".getBytes(), QoS.EXACTLY_ONCE, false);\n        localConn.publish(\"foo/bar\", \"3\".getBytes(), QoS.EXACTLY_ONCE, false);\n        localConn.publish(\"foo/bar\", \"4\".getBytes(), QoS.EXACTLY_ONCE, false);\n        localConn.publish(\"foo/bar\", \"5\".getBytes(), QoS.EXACTLY_ONCE, false);\n        org.fusesource.mqtt.client.Message receiveMsg = localConn.receive(100, TimeUnit.SECONDS);\n        assertNotNull(receiveMsg);\n        receiveMsg.ack();\n        String response = new String(receiveMsg.getPayload());\n        assertEquals(msg, response);\n\n        MQTT remoteMqtt = createMQTTTcpConnection(\"foo\", false, remoteBrokerMQTTPort);\n        BlockingConnection remoteConn = remoteMqtt.blockingConnection();\n        remoteConn.connect();\n        receiveMsg = remoteConn.receive(100, TimeUnit.SECONDS);\n        assertNotNull(receiveMsg);\n        receiveMsg.ack();\n        response = new String(receiveMsg.getPayload());\n        assertEquals(\"2\", response);\n    }\n\n{code}\n\nresults in\n\njunit.framework.ComparisonFailure: \nExpected :2\nActual   :3","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Out of order messages received in MQTT network of brokers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=netlancermobi","name":"netlancermobi","key":"netlancermobi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Netlancer","active":true,"timeZone":"Asia/Kolkata"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=netlancermobi","name":"netlancermobi","key":"netlancermobi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Netlancer","active":true,"timeZone":"Asia/Kolkata"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750379/comment/14193139","id":"14193139","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"From a quick glance my assumption is that message 2 is sitting in the prefetch buffer of the subscription for the first client as you did not close that prior to creating a new client connection to the broker.  This is normal behavior when dealing with multiple clients across networks of brokers.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-11-01T13:04:13.041+0000","updated":"2014-11-01T13:04:13.041+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750379/comment/14193333","id":"14193333","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=netlancermobi","name":"netlancermobi","key":"netlancermobi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Netlancer","active":true,"timeZone":"Asia/Kolkata"},"body":"Thanks for your input. Setting the prefetch limit to 1 and only doing a proper disconnect results in message order. \n\nRegarding disconnects:\nconsidering an mobile usecase, Proper disconnects may not come. Is there a way to prevent this ? Also, setting a low keepalive timeout will not be feasible always.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=netlancermobi","name":"netlancermobi","key":"netlancermobi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Netlancer","active":true,"timeZone":"Asia/Kolkata"},"created":"2014-11-01T18:31:28.858+0000","updated":"2014-11-01T18:31:28.858+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12750379/comment/14194776","id":"14194776","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This is not an issue with the broker, for architecture questions please ask on the users mailing list.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-11-03T17:39:50.953+0000","updated":"2014-11-03T17:39:50.953+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5410/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i21jsf:"}}