{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483543","self":"https://issues.apache.org/jira/rest/api/2/issue/12483543","key":"AMQ-2918","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2010-09-15T10:02:46.363+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jun 29 22:24:47 UTC 2011","customfield_12310420":"69673","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_24890910484_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-06-29T22:24:47.458+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2918/watchers","watchCount":0,"isWatching":false},"created":"2010-09-14T20:16:17.265+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-06-29T22:24:47.479+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I am running embedded broker in a spring container. During a volume test, I forward messages to a  dead letter queue. ActiveMQMapMessage that are being redirected to dead letter queue stay in memory. So, if I forward 15000 messages to dead letter queue, all 15000 messages will be in memory. These are persistent messages. \nI want to have a smaller memory footprint. Why are the activemqmapmessages staying in memory. the ones that were successfully processed get deleted just fine. \n\nThis is jmap -histo output\n  14:         19826        3647984  org.apache.activemq.command.ActiveMQMapMessage\n  28:         19791         791640  org.apache.activemq.command.ActiveMQQueue\n\ntotal of 19K+ activeMqMapMessages and  ActiveMQQueue instances...\n\nSince these are dead letter messages, why does ActiveMQ need to hold references to these messages in memory??\n\n----------------------------------\n\nI tried using the filequeuecursor: after a while the broker stopped responding because of the following error. \n\norg.apache.activemq.broker.TransportConnection.Service.serviceException() 294 : Async error occurred: java.lang.RuntimeException: java.lang.NullPointerException\njava.lang.RuntimeException: java.lang.NullPointerException\n\tat org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:228)\n\tat org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:192)\n\tat org.apache.activemq.broker.region.Queue.sendMessage(Queue.java:1601)\n\tat org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:707)\n\tat org.apache.activemq.broker.region.Queue.send(Queue.java:646)\n\tat org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:365)\n\tat org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:494)\n\tat org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129)\n\tat org.apache.activemq.broker.scheduler.SchedulerBroker.send(SchedulerBroker.java:136)\n\tat org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129)\n\tat org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96)\n\tat org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:230)\n\tat org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135)\n\tat org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:460)\n\tat org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:663)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:309)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185)\n\tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116)\n\tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69)\n\tat org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:218)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: java.lang.NullPointerException\n\tat org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:176)\n\tat org.apache.activemq.store.kahadb.plist.PList$2.execute(PList.java:163)\n\tat org.apache.kahadb.page.Transaction.execute(Transaction.java:728)\n\tat org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:161)\n\tat org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:221)\n\t... 24 more\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172271","customfield_12312823":null,"summary":"ActiveMQMapMessage stay in memory causing leaks","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows XP","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483543/comment/12942910","id":"12942910","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"body":"As this test continued to run, I see that the consumer stopped pulling messages off the queue\nI see the producer is hammering messages into the queue but the \n\nName ↑ \t     Number Of Pending Messages   \tNumber Of Consumers   \tMessages Enqueued   \tMessages \n\nDLQ.incoming.queue \t23150 \t0 \t23150 \t0 \t\n\t\nincoming.queue \t4945 \t1 \t28094 \t23150 \t\n\nNow, please see that #messages enqueued and yet to be dequeued are 4945 while DLQ has all the 23150 messages that errorred out.\n\nThis is not a good situation to have the broker getting stalled. \n\n---- configuration info ----\n\n<systemUsage>\n            <systemUsage sendFailIfNoSpace=\"true\">\n                <memoryUsage>\n                    <memoryUsage limit=\"256 mb\"/>\n                </memoryUsage>\n                <storeUsage>\n                    <storeUsage limit=\"1 gb\"/>\n                </storeUsage>\n                <tempUsage>\n                    <tempUsage limit=\"100 mb\"/>\n                </tempUsage>\n            </systemUsage>\n        </systemUsage>\n\n------\n\nusing fileQueueCursor.\n\n\n\n\n\t","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"created":"2010-09-14T20:28:11.385+0000","updated":"2010-09-14T20:28:11.385+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483543/comment/12942914","id":"12942914","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"can you provide your test case or some code or xml configuration that can reproduce?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-15T10:02:46.363+0000","updated":"2010-09-15T10:02:46.363+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483543/comment/12942896","id":"12942896","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"body":"Gary,\n\nThis is a very simple test. I created a Map<String,String> with large 8KB persistent messages. \nI used ActiveMQ 5.4.0 broker. I use JMSTemplate to send messages to a queue. (I have used VM/TCP transports). Important thing to note is that there is no consumer associated with the queue. So, messages are flooding the queue at a fast rate. (only producer)\n(This is like a DLQ where messages are flooding into because of consistent error by consumer causing session rollback. Here no consumer dequeues messages from DLQ automatically. Its handled manually)\n\nThe  following shows destination policy and system  memory configuration.\n\n\n <destinationPolicy>\n            <policyMap>\n              <policyEntries>\n                <policyEntry topic=\">\" producerFlowControl=\"false\" >\n                  <pendingSubscriberPolicy>\n                    <vmCursor />\n                  </pendingSubscriberPolicy>\n                </policyEntry>\n                \n                <policyEntry queue=\">\" producerFlowControl=\"false\">\n                \t\n                \t<deadLetterStrategy>\n\t\t\t        \t<individualDeadLetterStrategy queuePrefix=\"DLQ.\" useQueueForQueueMessages=\"true\" />\n          \t\t\t</deadLetterStrategy>\n          \t\t\t\n                \t<dispatchPolicy>\n             \t\t            <strictOrderDispatchPolicy />\n           \t        </dispatchPolicy>\n           \t\t\n                  <pendingQueuePolicy>\n                    <fileQueueCursor/>\n                  </pendingQueuePolicy>\n                  \n                </policyEntry>\n              </policyEntries>\n            </policyMap>\n        </destinationPolicy> \n\n\n       <systemUsage>\n            <systemUsage  sendFailIfNoSpace=\"true\">\n                <memoryUsage>\n                    <memoryUsage limit=\"256 mb\"/>\n                </memoryUsage>\n                <storeUsage>\n                    <storeUsage limit=\"1 gb\"/>\n                </storeUsage>\n                <tempUsage>\n                    <tempUsage limit=\"100 mb\"/>\n                </tempUsage>\n            </systemUsage>\n        </systemUsage>\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=akuntamukkala","name":"akuntamukkala","key":"akuntamukkala","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ashwini kuntamukkala","active":true,"timeZone":"America/Chicago"},"created":"2010-09-15T14:09:16.339+0000","updated":"2010-09-15T14:09:16.339+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483543/comment/12943020","id":"12943020","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"do you have a test case for the use of the file cursor, would be great if there was a reproducible junit test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-08T16:36:08.988+0000","updated":"2010-10-08T16:36:08.988+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483543/comment/13057519","id":"13057519","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"No test case provided and I can't reproduce any leaks using the information given.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-06-29T22:24:47.467+0000","updated":"2011-06-29T22:24:47.467+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2918/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tumn:"}}