{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482601","self":"https://issues.apache.org/jira/rest/api/2/issue/12482601","key":"AMQ-2283","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-06-12T11:12:07.177+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jul 08 13:01:10 UTC 2009","customfield_12310420":"74997","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2678488649_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-07-08T13:01:10.607+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2283/watchers","watchCount":2,"isWatching":false},"created":"2009-06-07T12:59:41.958+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-08T13:01:10.580+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I found out that a new thread is started for each message I send, but that thread is staying alive for the whole program lifetime.\nThe number of live \"multicast discovery agent notifier\" threads scales up linearly.\nEventually I ended up with 10000 threads of the above type running\nIt doesn't seems to be a camel issue since when I try with tcp://localhost:61616 everything works fine.\nI'm suspecting a bug. and I wanted to share it with you before I open a ticket.\nEric\n\n=============\npackage com.mycompany.CamelExample;\nimport javax.jms.ConnectionFactory;\nimport org.apache.activemq.ActiveMQConnectionFactory;\nimport org.apache.camel.CamelContext;\nimport org.apache.camel.ProducerTemplate;\nimport org.apache.camel.builder.RouteBuilder;\nimport org.apache.camel.component.jms.JmsComponent;\nimport org.apache.camel.impl.DefaultCamelContext;\nimport org.apache.log4j.Logger;\npublic final class App {\n   private static Logger log = Logger.getLogger(\"CamelTestApp\");\n   public static void main(String args[]) throws Exception {\n        CamelContext context = new DefaultCamelContext();\n        ConnectionFactory connectionFactory =\n                    new ActiveMQConnectionFactory(\"failover:(discovery:(multicast://224.1.2.3:6255?group=default),tcp://localhost:61616)\");\n        final String JMSTOPID = \"test-jms\";\n        final String DEST_TOPIC = \"test-jms:topic:TCommandRequest\";\n        final String SRC_TOPIC = \"test-jms:topic:TCommandRequest\";\n        context.addComponent(\"test-jms\", JmsComponent.jmsComponentAutoAcknowledge(connectionFactory));\n        context.addRoutes(new RouteBuilder() {\n            public void configure() {from(SRC_TOPIC).to(\"mock:test\");}});\n        ProducerTemplate template = context.createProducerTemplate();\n        context.start();\n           while (true) {\n                template.sendBody(DEST_TOPIC, \"TEST_TEXT\");\n               Thread.sleep(5000);\n            }\n    }\n}\n======================\nMy log shows:\n\n12:02:06,212  INFO DefaultCamelContext:729 - Apache Camel 2.0-M1 (CamelContext:camel-1) is starting\n12:02:06,582  WARN ObjectHelper:523 - Cannot find class: org.apache.xalan.xsltc.trax.DOM2SAX\n12:02:07,137  INFO DiscoveryTransport:73 - Adding new broker connection URL: tcp://192.168.0.1:61616\n12:02:07,220  INFO FailoverTransport:714 - Successfully connected to tcp://192.168.0.1:61616\n12:02:07,222  INFO FailoverTransport:714 - Successfully connected to discovery:(multicast://224.1.2.3:6255?group=default)\n12:02:07,247  INFO DefaultCamelContext:771 - Apache Camel 2.0-M1 (CamelContext:camel-1) started\n12:02:07,640  INFO DiscoveryTransport:73 - Adding new broker connection URL: tcp://192.168.0.1:61616\n12:02:07,715  INFO FailoverTransport:714 - Successfully connected to tcp://192.168.0.1:61616\n12:02:07,716  INFO FailoverTransport:714 - Successfully connected to discovery:(multicast://224.1.2.3:6255?group=default)\n12:02:13,181  INFO DiscoveryTransport:73 - Adding new broker connection URL: tcp://192.168.64.1:61616\n12:02:13,220  INFO FailoverTransport:714 - Successfully connected to tcp://192.168.0.1:61616\n12:02:13,222  INFO FailoverTransport:714 - Successfully connected to discovery:(multicast://224.1.2.3:6255?group=default)\n12:02:18,731  INFO DiscoveryTransport:73 - Adding new broker connection URL: tcp://192.168.0.1:61616\n12:02:18,961  INFO FailoverTransport:714 - Successfully connected to tcp://192.168.0.1:61616\n12:02:18,963  INFO FailoverTransport:714 - Successfully connected to discovery:(multicast://224.1.2.3:6255?group=default)\n.\n.\n. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161805","customfield_12312823":null,"summary":"New Multicast discovery agent thread is created for each message","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ericbouer","name":"ericbouer","key":"ericbouer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Bouer","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ericbouer","name":"ericbouer","key":"ericbouer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Eric Bouer","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux, jdk6u13, jdk6u14","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482601/comment/12941472","id":"12941472","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ee7arh","name":"ee7arh","key":"ee7arh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Hurst","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n\nI have exactly the same problem and it eventually  leads to my application running out of memory. I have had to disable multicast now for stability reasons but would like to use it again so hopefully this can be fixed.\n\n  <!-- configure the Camel JMS consumer to use the ActiveMQ broker declared above -->\n    <bean id=\"jmsExternal\" class=\"org.apache.camel.component.jms.JmsComponent\">\n        <property name=\"connectionFactory\">\n            <bean class=\"org.apache.activemq.ActiveMQConnectionFactory\">\n                <!-- use multicast to detect other broker - group=groupName of network to look for -->\n                <property name=\"brokerURL\" value=\"discovery:(multicast://default?group=testbroker)?initialReconnectDelay=100\"/>\n            </bean>\n        </property>\n    </bean>\n\nTo send a message to the external queue \"jmsExternal\" I call the method in POJO object:\n\ncamelTemplate.sendBody(x,y);\n\nI am using activeMQ 5.2.0 but the brokers which are being discovered are using the FUSE 5.3 version.\n\nIf select one of the thousands of Multicast threads displayed in Jconsole, they all have the same stack trace as this:\n\nName: Multicast Discovery Agent Notifier\nState: WAITING on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@1ce7f98\nTotal blocked: 0  Total waited: 1\n\nStack trace:\nsun.misc.Unsafe.park(Native Method)\njava.util.concurrent.locks.LockSupport.park(LockSupport.java:158)\njava.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:1925)\njava.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:358)\njava.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:947)\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)\njava.lang.Thread.run(Thread.java:619) \n\nBRegards\nAndrew","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ee7arh","name":"ee7arh","key":"ee7arh","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Andrew Hurst","active":true,"timeZone":"Etc/UTC"},"created":"2009-06-12T11:12:07.177+0000","updated":"2009-06-12T11:12:07.177+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482601/comment/12941704","id":"12941704","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"fixed in r792127","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-07-08T13:01:10.477+0000","updated":"2009-07-08T13:01:10.477+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2283/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s213:"}}