{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12496720","self":"https://issues.apache.org/jira/rest/api/2/issue/12496720","key":"AMQ-3157","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-07-06T18:46:14.175+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Nov 22 08:30:44 UTC 2011","customfield_12310420":"60092","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_18410367679_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-08-26T22:25:51.573+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3157/watchers","watchCount":1,"isWatching":false},"created":"2011-01-25T20:26:23.956+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315625","id":"12315625","description":"","name":"5.4.2","archived":false,"released":true,"releaseDate":"2010-12-02"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-11-22T08:30:44.168+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When using the garbage collection feature of inactive queues, the queues are not collected if queue mirroring is turned on.  The following snippet shows a basic configuration for reproducing the problem:\n\n{code:xml}\n<broker xmlns=\"http://activemq.apache.org/schema/core\"\n          brokerName=\"localhost\"\n          dataDirectory=\"${activemq.base}/data\"\n          destroyApplicationContextOnStop=\"true\"\n          schedulePeriodForDestinationPurge=\"10000\">\n\n        <destinationInterceptors>\n            <mirroredQueue copyMessage=\"true\" postfix=\"\" prefix=\"Monitor.\"/>\n        </destinationInterceptors>\n\n        <destinationPolicy>\n            <policyMap>\n                <policyEntries>\n                    <!-- Set auto-cleanup of inactive topics and queues -->\n                    <policyEntry queue=\">\" producerFlowControl=\"true\" memoryLimit=\"50mb\" gcInactiveDestinations=\"true\" inactiveTimoutBeforeGC=\"30000\">\n                        <pendingQueuePolicy>\n                            <vmQueueCursor/>\n                        </pendingQueuePolicy>\n                    </policyEntry>\n                    <policyEntry topic=\">\" producerFlowControl=\"true\" memoryLimit=\"50mb\" gcInactiveDestinations=\"true\" inactiveTimoutBeforeGC=\"30000\">\n                        <pendingSubscriberPolicy>\n                            <vmCursor />\n                        </pendingSubscriberPolicy>\n                    </policyEntry>\n                </policyEntries>\n            </policyMap>\n        </destinationPolicy>\n</broker>\n{code}\n\nWith this configuration, the topics will be collected, but the queues will not be collected.  In order to get the queues to be collected, the {{<destinationInterceptors>}} section needs to be commented out.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12491842","id":"12491842","filename":"AMQ3157Test.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-08-26T22:15:12.398+0000","size":6712,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12491842/AMQ3157Test.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12489881","id":"12489881","filename":"AMQ3157Test.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-08-09T20:20:00.137+0000","size":6463,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12489881/AMQ3157Test.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59508","customfield_12312823":null,"summary":"Garbage collecting inactive destinations does not work with queue mirroring","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgomes","name":"jgomes","key":"jgomes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jgomes&avatarId=17131","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jgomes&avatarId=17131","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jgomes&avatarId=17131","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jgomes&avatarId=17131"},"displayName":"Jim Gomes","active":true,"timeZone":"America/Vancouver"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgomes","name":"jgomes","key":"jgomes","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=jgomes&avatarId=17131","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=jgomes&avatarId=17131","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=jgomes&avatarId=17131","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=jgomes&avatarId=17131"},"displayName":"Jim Gomes","active":true,"timeZone":"America/Vancouver"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows 2003 Server, Java JDK 1.6","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12496720/comment/13060755","id":"13060755","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Would be great if you could throw together a JUnit test for this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-07-06T18:46:14.175+0000","updated":"2011-07-06T18:46:14.175+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12496720/comment/13081886","id":"13081886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Created a little test case to demonstrate the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-08-09T20:20:00.179+0000","updated":"2011-08-09T20:20:00.179+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12496720/comment/13092092","id":"13092092","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Updated test, old version wasn't quite right.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-08-26T22:15:12.503+0000","updated":"2011-08-26T22:15:12.503+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12496720/comment/13092096","id":"13092096","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"fix applied in trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-08-26T22:25:51.615+0000","updated":"2011-08-26T22:25:51.615+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12496720/comment/13154948","id":"13154948","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=darius.schier","name":"darius.schier","key":"darius.schier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=darius.schier&avatarId=12630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=darius.schier&avatarId=12630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=darius.schier&avatarId=12630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=darius.schier&avatarId=12630"},"displayName":"Darius Schier","active":true,"timeZone":"Etc/UTC"},"body":"Not sure if we have exactly the same problem but it looks pretty familiar.\nWe gave the snapshot a try, unfortunately we still have very similar problems as described by Jim.\nSame as above: GC seems to work fine with destinations that are available after restart but not with dynamically created ones.\nAlso queues that were created before restart dynamically and still have some load work fine (as the server creates them on startup).\n\nHere is our configuration.\n\n{code:xml}\n<destinationInterceptors>\n  <mirroredQueue copyMessage = \"true\" postfix=\".qmirror\" prefix=\"\"/>\n</destinationInterceptors>\n<destinationPolicy>\n  <policyMap>\n    <policyEntries>\n      <policyEntry topic=\"testQueue.>\" producerFlowControl=\"false\" memoryLimit=\"1 mb\" optimizedDispatch=\"true\"></policyEntry>\n      <policyEntry queue=\"testQueue.>\" producerFlowControl=\"false\" memoryLimit=\"1 mb\" optimizedDispatch=\"true\"></policyEntry>\n    </policyEntries>\n  </policyMap>\n</destinationPolicy>\n\n<persistenceAdapter>\n  <kahaDB directory=\"${activemq.base}/data/kahadb\"/>\n</persistenceAdapter>\n\n<systemUsage>\n  <systemUsage>\n    <memoryUsage>\n      <memoryUsage limit=\"10 mb\"/>\n    </memoryUsage>\n    <storeUsage>\n      <storeUsage limit=\"10 gb\"/>\n    </storeUsage>\n    <tempUsage>\n      <tempUsage limit=\"10 mb\"/>\n    </tempUsage>\n  </systemUsage>\n</systemUsage>\n{code} \n\nWould you mind to reopen this issue? \nWe use mirrors a lot. From our point of view this could lead to OOM, so we think the priority could/should be increased.\n\nRegards\nDarius","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=darius.schier","name":"darius.schier","key":"darius.schier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=darius.schier&avatarId=12630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=darius.schier&avatarId=12630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=darius.schier&avatarId=12630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=darius.schier&avatarId=12630"},"displayName":"Darius Schier","active":true,"timeZone":"Etc/UTC"},"created":"2011-11-22T08:30:44.116+0000","updated":"2011-11-22T08:30:44.116+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3157/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ajyv:"}}