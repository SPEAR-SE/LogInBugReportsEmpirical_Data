{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482503","self":"https://issues.apache.org/jira/rest/api/2/issue/12482503","key":"AMQ-1845","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2008-07-17T12:03:40.361+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Aug 15 14:49:13 UTC 2008","customfield_12310420":"95925","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_3287733137_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-08-15T14:49:13.301+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1845/watchers","watchCount":2,"isWatching":false},"created":"2008-07-08T13:33:40.164+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2008-08-15T14:49:13.300+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Producer on broker A send 2500 message on the distributed queue at broker A.\nProducer B starts to receive message from distributed queue on broker B.\nDuring the receiving process, the network between these two brokers down and later brought up again.\n\nIn this senario, we found that some messages are lost. \nIt seems the broker A are sending message to broker B when the network is down and these messages are removed from queue in broker A but never received by broker B which causing message loss.\n\nIs this a bug or a configuration problem? \nI thought the configuration like this is the store/forward pattern which should ensure the message reliability in an unstable network.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"255150","customfield_12312823":null,"summary":"Message loss in network of brokers when network connection break","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Two brokers connected via TCP with one persistent distributed queue and a producer and a consumer on each broker.","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12939948","id":"12939948","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"body":"In this senario broker B have dynamic IP address while broker A have fixed IP address.\nSo the duplex network connector are used to connenct from broker B to broker A.\n\nI have tested with a different topology. Two brokers connecting each other using none duplex connection on both side.\nThe message loss situation does not change.\n\nThis means activemq can't provide reliable message delivery when doing store and forward style message transfer. It is huge!\nPlease resolve this issue ASAP.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-11T01:39:18.094+0000","updated":"2008-07-18T03:19:52.933+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12940000","id":"12940000","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Just a thought but this sounds like the message delivery mode is not persistent. For reliable message delivery in the event of network failures, the message producers need to set deliveryMode to javax.jms.DeliveryMode.PERSISTENT.\n{code}\n                Session session = connection.createSession(...);\n                MessageProducer producer = session.createProducer(...);\n                producer.setDeliveryMode(javax.jms.DeliveryMode.PERSISTENT);\n                ....\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-17T12:03:40.361+0000","updated":"2008-07-17T12:03:40.361+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12939982","id":"12939982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"body":"Nop, we didn't set the delivery mode attibute on the producer which means according to the JMS API it is default to DeliveryMode.PERSISTENT.\nEvery message is successfullly persistented in the local broker on the producer side if the network is down before producer sending activity begins.\nBut if network is down when message is transfering between two brokers, there is always message loss. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-18T03:10:55.807+0000","updated":"2008-07-18T03:10:55.807+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12939961","id":"12939961","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"ok, we need some help to reproduce this, my efforts so far have not succeeded. In my test scenario I use a simple socket software proxy to control the network connection between both brokers and have it drop the connection during the test. I cannot reproduce message loss however.\nCan you describe your setup in some detail or submit a test case?\nOne other thing, have you verified this with trunk?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-18T14:03:17.739+0000","updated":"2008-07-18T14:03:17.739+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12939994","id":"12939994","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"body":"This test can reproduce the message loss using ActiveMQ 5.0 and 5.1.\n\nThe producer side have its own broker and have a fixed IP address.\nOn the producer side, the spring configuration is like follows:\n{code:xml}\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n\txmlns:jee=\"http://www.springframework.org/schema/jee\" xmlns:amq=\"http://activemq.apache.org/schema/core\"\n\txsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n\thttp://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.0.xsd\n\thttp://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd\">\n\n\t<amq:broker brokerName=\"producer\" useJmx=\"true\" persistent=\"true\">\n\t\t<amq:transportConnectors>\n\t\t\t<amq:transportConnector uri=\"tcp://localhost:61616\" />\n\t\t</amq:transportConnectors>\n\t</amq:broker>\n\n\t<!-- Jms ConnectionFactory -->\n\t<bean id=\"jmsFactory\" class=\"org.apache.activemq.ActiveMQConnectionFactory\">\n\t\t<property name=\"brokerURL\" value=\"vm://localhost:61616\" />\n\t</bean>\n\n\n\t<!-- Spring JMS SimpleConverter -->\n\t<bean id=\"simpleConverter\" class=\"org.springframework.jms.support.converter.SimpleMessageConverter\" />\n\n\t<!-- JMS Queue Template -->\n\t<bean id=\"jmsTemplate\" class=\"org.springframework.jms.core.JmsTemplate\">\n\t\t<property name=\"connectionFactory\" ref=\"jmsFactory\" />\n\t\t<property name=\"messageConverter\" ref=\"converter\" />\n\t</bean>\n\n\t<!-- Message Converter -->\n\t<bean id=\"converter\" class=\"com.al.SimpleConverter\">\n\t\t<property name=\"converter\">\n\t\t\t<ref local=\"simpleConverter\" />\n\t\t</property>\n\t</bean>\n\n\t<!-- Message porducer -->\n\t<bean id=\"sender\" class=\"com.al.DefaultSender\">\n\t\t<property name=\"template\" ref=\"jmsTemplate\" />\n\t\t<property name=\"destinationName\" value=\"test-out\" />\n\t</bean>\n\n</beans>\n{code}\n\nThe test app at producer side:\n{code:title=TestApp.java|borderStyle=solid}\npackage com.al;\n\nimport org.apache.log4j.Logger;\n\npublic class TestApp {\n\t/**\n\t * Logger for this class\n\t */\n\tprivate static final Logger logger = Logger.getLogger(TestApp.class);\n\n\tpublic static void main(String[] args) {\n\n\t\tlogger.debug(\"start test...\");\n\t\t//Initializing spring context\n\t\tContext.init();\n\t\t// uncomment to send messages\n\n\t\tDefaultSender sender = Context.getBean(\"sender\");\n\t\tint idx = 1;\n\t\tint count = 3000;\n\t\twhile (idx <= count) {\n\t\t\tsender.sendMessage(SimpleMessageHelper.genSimpleMessage(idx));\n\t\t\tlogger.debug(\"send out message : payload is \" + idx);\n\t\t\tidx++;\n\t\t}\n\n\t\t/* Infinitely hold main thread  to keep the spring context running\n\t\t*/\n\t\tObject lock = new Object();\n\t\tsynchronized (lock) {\n\t\t\ttry {\n\t\t\t\tlock.wait();\n\t\t\t} catch (InterruptedException e) {\n\t\t\t\te.printStackTrace();\n\t\t\t}\n\t\t}\n\n\t}\n}\n{code}\n\nThe test client is very simple which send 3000 messages to the queue \"test-out\" on the producer side broker.\n\n============================================================================================\n\nThe consumer side using dynamic IP address and deployed on another machine.\nWe have a broker on one separate machine using a duplex = \"true\" network connector\nConsumer side Spring configuration file is as follows:\n{code:xml}\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n\txmlns:jee=\"http://www.springframework.org/schema/jee\" xmlns:amq=\"http://activemq.apache.org/schema/core\"\n\txsi:schemaLocation=\"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n\thttp://www.springframework.org/schema/jee http://www.springframework.org/schema/jee/spring-jee-2.0.xsd\n\thttp://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd\">\n\n\t<amq:broker brokerName=\"brokerA\" useJmx=\"true\" persistent=\"true\">\n\n\t\t<amq:networkConnectors>\n\t\t\t<amq:networkConnector uri=\"static://(tcp://【ip-for-producer-machine】:61616)\" duplex=\"true\"/>\n\t\t</amq:networkConnectors>\n\n\t\t<amq:transportConnectors>\n\t\t\t<amq:transportConnector uri=\"tcp://localhost:61616\" />\n\t\t</amq:transportConnectors>\n\n\t</amq:broker>\n\n\t<!-- Jms ConnectionFactory -->\n\n\t<bean id=\"jmsFactory\" class=\"org.apache.activemq.ActiveMQConnectionFactory\">\n\t\t<property name=\"brokerURL\" value=\"vm://localhost:61616\" />\n\t</bean>\n\n\t<!-- Spring JMS SimpleConverter -->\n\t<bean id=\"simpleConverter\" class=\"org.springframework.jms.support.converter.SimpleMessageConverter\" />\n\n\n\t<!-- Message Converter -->\n\t<bean id=\"converter\" class=\"com.al.SimpleConverter\">\n\t\t<property name=\"converter\">\n\t\t\t<ref local=\"simpleConverter\" />\n\t\t</property>\n\t</bean>\n\n\t<!-- MDP -->\n\t<!-- consumer 1 -->\n\t<bean id=\"listener\" class=\"org.springframework.jms.listener.adapter.MessageListenerAdapter\">\n\t\t<constructor-arg>\n\t\t\t<bean class=\"com.al.DefaultListener\" />\n\t\t</constructor-arg>\n\t\t<property name=\"defaultListenerMethod\" value=\"onMessage\" />\n\t\t<property name=\"messageConverter\" ref=\"converter\" />\n\t</bean>\n\n\t<bean id=\"listenerContainer\" class=\"org.springframework.jms.listener.DefaultMessageListenerContainer\">\n\t\t<property name=\"connectionFactory\" ref=\"jmsFactory\" />\n\t\t<property name=\"destinationName\" value=\"test-out\" />\n\t\t<property name=\"messageListener\" ref=\"listener\" />\n\t\t<property name=\"sessionTransacted\" value=\"true\" />\n\t</bean>\n</beans>\n{code}\n\nDefault Listener code:\n{code:title=DefaultListener.java|borderStyle=solid}\npackage com.al;\n\nimport org.apache.commons.logging.Log;\nimport org.apache.commons.logging.LogFactory;\n\npublic class DefaultListener {\n\n\tprivate static Log logger = LogFactory.getLog(DefaultListener.class);\n\n\tstatic int i = 1;\n\n\tpublic void onMessage(SimpleMessage message) {\n\t\tint j = Integer.valueOf(message.getPayLoad());\n\t\tlogger.debug(\"receive : j = \" + j);\n\t\tif (i != j) {\n\t\t\tlogger.debug(\"warn : i=\" + i + \",j=\" + j);\n\t\t}\n\t\ti++;\n\t}\n}\n{code}\n\nThe default listener print out the message and compare the index in the message with the number of message received (It should match if no message loss occurs).\n\n\n===========================================================================================\nAnd this is how to reproduce message loss in this environment.\n1. Start producer application and consumer application\n2. Producer application starts to send 3000 messages to the queue \"test-out\"\n3. Consumer application starts to receive messages from the local distributed queue.\n4. During the message sending process, disconnect the network cable on consumer machine.\n5. You will find that the producer machine still sending messages to the queue \"test-out\", which is normal because these messages should be persistent in producer broker's \"test-out\" queue. And the mean time the consumer side stopped getting messages from the \"test-out\" queue, which is also normal.\n6. When you connect the network cable again on the consumer machine(during the message sending or after the producer node finished sending message) , the consumer broker receives message from the \"test-out\" queue again. But logger displays the message count miss match with the message index in the message payload, which indicates message loss happened.\n\n\nAnd by the way, this also reproduced when we trying to avoid duplex connection by define network connector on both side. This is archived by fixed IP node connecting to a dynamic IP node using a domain name (simulated by using hosts file to provide routing information)\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-21T07:18:15.095+0000","updated":"2008-07-21T07:27:43.815+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12939998","id":"12939998","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"great, thanks for the detail. From looking at the consumer, my guess is that you are getting duplicate messages. If you change your test to use a map and verify map.size matches what was produced I think your test will pass. Duplicates are expected in this failure case, any message that was dispatched but not fully acknowledged when the network dies will eventually be redispatched as a duplicate. It is seen as in-flight by the broker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-21T16:23:06.737+0000","updated":"2008-07-21T16:23:06.737+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12939983","id":"12939983","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"body":"Unfotunately, the message idx and message receiving count missmatch indicates message loss but not duplication.\n\nThe evidence is message count < message idx in the payload which means, some message lost.\nAnd after all, the final message count < 3000.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-22T02:01:08.094+0000","updated":"2008-07-22T02:01:08.094+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12939992","id":"12939992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsigelnik","name":"tsigelnik","key":"tsigelnik","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dima","active":true,"timeZone":"Australia/Sydney"},"body":"2Bryan Shaw \n\nYour code has problem. It works in your case beacuse DefaultMessageListenerContainer by default creates 1 consumer.  In common, you have to change \n\nstatic int i = 1; to static AtomicInteger i = new AtomicInteger(1);\nand i++; to i.incrementAndGet();\n\ni++ isn't atomic operation in java, it is translated to i = i + 1. \nThere are 2 operations: + and =","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tsigelnik","name":"tsigelnik","key":"tsigelnik","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dima","active":true,"timeZone":"Australia/Sydney"},"created":"2008-07-22T12:04:53.056+0000","updated":"2008-07-22T12:18:19.928+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12939981","id":"12939981","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"body":"To Dima:\nThis is not a production code.   And we are only meant to use only one Listener instance.\nThis is only a test to reveal the problem of message loss. \nBy the way, thanks for your comment.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=silverhoof","name":"silverhoof","key":"silverhoof","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Bryan Shaw","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-23T02:56:57.141+0000","updated":"2008-07-23T02:56:57.141+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12940011","id":"12940011","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The problem is that the consumer uses a transacted session but does not commit the transaction. If you examine the consumer broker using the jmx/jconsole, you will see that the queue has all its messages inflight, delivered but not acked. They won't be committed till the transaction associated with the cached consumer session is committed.\n\nSpring jms template does quite a bit of work under the hood, it may may make sense to strip your test application down to pure jms api calls. \nIn any event, to proceed further with your testing, for your test consumer DefaultMessageListenerContainer configuration use the following:\n{code}\n<bean id=\"listenerContainer\" class=\"org.springframework.jms.listener.DefaultMessageListenerContainer\">\n\t\t<property name=\"connectionFactory\" ref=\"jmsFactory\" />\n\t\t<property name=\"destinationName\" value=\"test-out\" />\n\t\t<property name=\"messageListener\" ref=\"listener\" />\n\t\t<property name=\"sessionTransacted\" value=\"false\" />\n\t</bean>\n{code}\nThat is, do not use a transacted session. (Or stick with a transacted session but commit the transaction in your listener via session.commit or via the springjms prescribed way.)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-29T13:29:09.314+0000","updated":"2008-07-29T13:29:09.314+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482503/comment/12940029","id":"12940029","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolving this as the issue seems to be related to spring jms template usage. Repoen if this is not the case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-15T14:49:13.289+0000","updated":"2008-08-15T14:49:13.289+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1845/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1825b:"}}