{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13079131","self":"https://issues.apache.org/jira/rest/api/2/issue/13079131","key":"AMQ-6700","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12340366","id":"12340366","name":"5.14.6","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2017-06-12T08:09:55.294+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jun 12 08:14:59 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2699882_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-06-12T08:14:59.719+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6700/watchers","watchCount":3,"isWatching":false},"created":"2017-06-12T07:29:59.880+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["jca"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12339772","id":"12339772","name":"5.14.5","archived":false,"released":true,"releaseDate":"2017-04-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-06-12T08:14:59.756+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313898","id":"12313898","name":"JCA Container"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12324517","id":"12324517","name":"RAR"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The ActiveMQ JCA layer may leak threads of name {{\"ActiveMQ Connection Executor\"}} and instances of {{org.apache.activemq.ActiveMQConnection}} when there are problems with establishing the connection. \nIf the initial openwire connection cannot be established, it may run an \"ActiveMQ Connection Executor\" thread to deal with the error leading to a code path that does not close the connection and does not clear up the \"ActiveMQ Connection Executor\" thread.\nLow level details in further comments.\n \nThis problem can be reproduced by running {{ActiveMQResourceAdapter.TransactionContext.recover()}} but potentially other code paths in the resource adapter are effected as well.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Leak of \"ActiveMQ Connection Executor\" threads and ActiveMQConnection objects in JCA","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"JCA","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10430","value":"Patch","id":"10430"}],"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079131/comment/16046282","id":"16046282","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"body":"Here are the low level details that will lead to leaking ActiveMQConnection objects and threads:\n\nThe Arjuna transaction manager of JBoss EAP runs a periodic recovery and calls {{ActiveMQResourceAdapter.TransactionContext.recover()}}\n{code}\ntry {\n  original = setConnection(newConnection());\n  ...\n{code}\n\nNote around the same code path would be executed when Arjuna calls {{commit()}} or {{rollback()}} on the resource adapter.\nThe call to {{ActiveMQResourceAdapter.newConnection()}} is implemented as\n\n{code}\n                        private ActiveMQConnection newConnection() throws JMSException {\n                            ActiveMQConnection connection = makeConnection();\n                            connection.start();\n                            return connection;\n                        }\n{code}\n\nMethod {{makeConnection()}} calls into {{ActiveMQConnectionFacotry.createActiveMQConnection()}} which contains\n\n{code}\n        try {\n            connection = createActiveMQConnection(transport, factoryStats);\n...\n            transport.start();\n\n...\n            return connection;\n        } catch (JMSException e) {\n            // Clean up!\n            try {\n                connection.close();\n            } catch (Throwable ignore) {\n            }\n            throw e;\n        } catch (Exception e) {\n            // Clean up!\n            try {\n                connection.close();\n            } catch (Throwable ignore) {\n            }\n            throw JMSExceptionSupport.create(\"Could not connect to broker URL: \" + brokerURL + \". Reason: \" + e, e);\n        }\n{code}\n\nNow if transport.start() raises an errror, this may not result in an exception in this method. Instead the \"ActiveMQ Connection Executor\" thread is used to call {{ActiveMQConnection.transportFailed()}}. So the handling of the error happens in a different thread. Meanwhile above method {{ActiveMQConnectionFacotry.createActiveMQConnection()}} finishes (without exceptions) and we are back in {{ActiveMQResourceAdapter.$2.newConnection()}} where we call {{connection.start()}} (See code sample above). \n\nIn the meantime the \"ActiveMQ Connection Executor\" thread has most likely finished and marked the connection as failed (ActiveMQConnection.transportFailed = true).\n{{ActiveMQConnection.start()}} calls method {{ActiveMQConnectioncheckClosedOrFailed()}} which checks for the value of property {{transportFailed}}, which will be true by now and an exception will be raised.\n\nThat exception is only caught in {{ActiveMQResourceAdapter.recover()}} which in its {{finally}} clause calls \n\n{code}\n                            } finally {\n                                closeConnection(original);\n                            }\n{code}\n\nbut original is null at this stage, so the ActiveMQConnection instance does not get closed and the \"ActiveMQ Connection Executor\" thread is not shut down! Both, the thread and the instance are leaked!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"created":"2017-06-12T07:30:50.905+0000","updated":"2017-06-12T07:30:50.905+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079131/comment/16046283","id":"16046283","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"body":"A fix for this bug is to catch and deal with these Exceptions in method {{ActiveMQResourceAdapter.$2.newConnection()}}\n\n{code:java}\n                        private ActiveMQConnection newConnection() throws JMSException {\n                            ActiveMQConnection connection = null;\n                            try {\n                                connection = makeConnection();\n                                connection.start();\n                            } catch (JMSException ex) {\n                                if (connection != null) {\n                                    try {\n                                        connection.close();\n                                    } catch (JMSException ignore) { }\n                                }\n                                throw ex;\n                            }\n                            return connection;\n                        }\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"created":"2017-06-12T07:31:37.708+0000","updated":"2017-06-12T07:31:37.708+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079131/comment/16046308","id":"16046308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit a1e595c18fbfb8a21e632b665f180005f1daf053 in activemq's branch refs/heads/AMQ-6700 from [~tmielke]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a1e595c ]\n\n[AMQ-6700] Leak of ActiveMQ Connection Executor threads and ActiveMQConnection objects in JCA layer\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-12T08:09:55.294+0000","updated":"2017-06-12T08:09:55.294+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079131/comment/16046309","id":"16046309","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit a1e595c18fbfb8a21e632b665f180005f1daf053 in activemq's branch refs/heads/master from [~tmielke]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a1e595c ]\n\n[AMQ-6700] Leak of ActiveMQ Connection Executor threads and ActiveMQConnection objects in JCA layer\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2017-06-12T08:10:21.775+0000","updated":"2017-06-12T08:10:21.775+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13079131/comment/16046316","id":"16046316","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"body":"Fixed with commit [a1e595c18fbfb8a21e632b665f180005f1daf053|https://git-wip-us.apache.org/repos/asf?p=activemq.git;a=blobdiff;f=activemq-ra/src/main/java/org/apache/activemq/ra/ActiveMQResourceAdapter.java;h=b17674e88a9cec7ea5c95dd229dad5c143215833;hp=fd16603865d90c8f2ded3cfaa268056bca1a3731;hb=a1e595c18fbfb8a21e632b665f180005f1daf053;hpb=a6782443c1695f54176afecfda6c5c423bc18a84].","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"created":"2017-06-12T08:14:59.750+0000","updated":"2017-06-12T08:14:59.750+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6700/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3g5k7:"}}