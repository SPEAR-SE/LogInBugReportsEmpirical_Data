{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12503032","self":"https://issues.apache.org/jira/rest/api/2/issue/12503032","key":"AMQ-3256","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2011-04-01T06:59:30.787+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Nov 02 14:00:14 UTC 2012","customfield_12310420":"74708","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_50279059809_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-11-02T14:00:14.725+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3256/watchers","watchCount":3,"isWatching":false},"created":"2011-03-31T15:35:54.958+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["failover"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315625","id":"12315625","description":"","name":"5.4.2","archived":false,"released":true,"releaseDate":"2010-12-02"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-11-02T14:00:14.765+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"Start a Master & Slave broker.\nConnect to them with failover=true and randomize=false\nMessage Sending - ok.\nKill the Master broker.\nMessage Sending - ok.\nKill the Slave broker.\nMessage Sending - paused (both brokers are down)\nRestart both brokers. \nMessage Sending - fail.\n\nThe above WORKS in ActiveMQ 5.3.1 but fails in 5.4.2\n\nI wonder if this is related to: https://issues.apache.org/jira/browse/AMQ-3213\n\nSteps to reproduce the problem:\n* Run Broker, BrokerSlave, Client, Server,\n* Note messages being sent from Server to Client\n* Kill Broker\n* Note messages being sent from Server to Client\n* Kill BrokerSlave\n* Restart Broker & BrokerSlave,\n* Messages no longer being sent.\n\n{code:title=Broker.java|borderStyle=solid}\npublic class Broker {\n    public static void main(String[] args) throws Exception {\n        BrokerService broker;\n        broker = BrokerFactory.createBroker(\"xbean:master.xml\");\n        broker.start();\n\n        while(true) {\n            Thread.sleep(10*1000);\n        }\n    }\n}\n{code}\n{code:title=BrokerSlave.java|borderStyle=solid}\npublic class BrokerSlave {\n    public static void main(String[] args) throws Exception {\n        BrokerService broker;\n        broker = BrokerFactory.createBroker(\"xbean:slave.xml\");\n        broker.start();\n\n        while(true) {\n            Thread.sleep(10*1000);\n        }\n    }\n}\n{code}\n\n{code:title=Client.java|borderStyle=solid}\npublic class Client {\n    static String url = \"failover://(tcp://localhost:61616,tcp://localhost:61617)?randomize=false\";\n    static String user = null;\n    static String password = null;\n\n    public static void main(String[] args) throws JMSException, InterruptedException {\n        ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(user, password, url);\n        final Connection connection = connectionFactory.createConnection();\n        final Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);\n        final Queue orderQueue = session.createQueue(\"VendorOrderQueue\");\n        final MessageConsumer consumer = session.createConsumer(orderQueue);\n        consumer.setMessageListener(new MsgL() );\n\n        session.run();\n        connection.start();\n\n        while(true) {\n            Thread.sleep(5000);\n        }\n    }\n\n    private static class MsgL implements MessageListener {\n        public void onMessage(final Message message) {\n            System.out.println(\"Got message: \"+message);\n        }\n    }\n}\n{code}\n{code:title=Server.java|borderStyle=solid}\npublic class Server {\n    static String url = \"failover://(tcp://localhost:61616,tcp://localhost:61617)?randomize=false\";\n    static String user = null;\n    static String password = null;\n\n    public static void main(String[] args) throws JMSException, InterruptedException {\n        ActiveMQConnectionFactory connectionFactory = new ActiveMQConnectionFactory(user, password, url);\n        final Connection connection = connectionFactory.createConnection();\n        final Session session = connection.createSession(false, Session.AUTO_ACKNOWLEDGE);\n        final Queue orderQueue = session.createQueue(\"VendorOrderQueue\");\n        final MessageProducer producer = session.createProducer(orderQueue);\n        session.run();\n        connection.start();\n\n        for (int i = 0; i < 100; i++) {\n            MapMessage message = session.createMapMessage();\n            message.setString(\"Item\", \"hello \"+i);\n\n            System.out.println(\"Sending: \"+message);\n            producer.send(message);\n\n            System.out.println(\"Wait for 5s\");\n            Thread.sleep(5000);\n        }\n    }\n}\n{code}\n\n{code:title=master.xml|borderStyle=solid}\n<beans\n    xmlns=\"http://www.springframework.org/schema/beans\"\n    xmlns:amq=\"http://activemq.apache.org/schema/core\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://www.springframework.org/schema/beans \n    http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n    http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd\">\n\n  <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"/>\n\n  <broker xmlns=\"http://activemq.apache.org/schema/core\"\n          persistent=\"false\"\n          waitForSlave=\"true\"\n          useJmx=\"true\">\n\n      <transportConnectors>\n        <transportConnector uri=\"tcp://localhost:61616\"/>\n      </transportConnectors>\n\n  </broker>\n</beans>\n{code}\n\n{code:title=slave.xml|borderStyle=solid}\n<beans\n    xmlns=\"http://www.springframework.org/schema/beans\"\n    xmlns:amq=\"http://activemq.apache.org/schema/core\"\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n    xsi:schemaLocation=\"http://www.springframework.org/schema/beans \n    http://www.springframework.org/schema/beans/spring-beans-2.0.xsd\n    http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core.xsd\">\n\n  <bean class=\"org.springframework.beans.factory.config.PropertyPlaceholderConfigurer\"/>\n\n  <broker xmlns=\"http://activemq.apache.org/schema/core\"\n        persistent=\"false\"\n        useJmx=\"false\"\n        shutdownOnMasterFailure=\"false\">\n\n    <services>\n      <masterConnector remoteURI=\"tcp://localhost:61616\"/>\n    </services>\n\n    <transportConnectors>\n\t    <transportConnector uri=\"tcp://localhost:61617\"/>\n    </transportConnectors>\n</broker>\n</beans>\n{code}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"81485","customfield_12312823":null,"summary":"For a Master Slave failover broker setup. The system does not reconnect to the broker if the brokers are restarted","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bootandy","name":"bootandy","key":"bootandy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"andy boot","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bootandy","name":"bootandy","key":"bootandy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"andy boot","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows XP","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503032/comment/13014442","id":"13014442","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amit.bohra","name":"amit.bohra","key":"amit.bohra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amit Bohra","active":true,"timeZone":"Etc/UTC"},"body":"I also faced the similar problem. Here are the steps for the same:\n1. Failover setup using JDBC MySQL\n2. Start master and slave\n3. Send messages - (success)\n4. Stop master\n5. Send messages - (success, as slave has picked them up)\n6. Restart master and stop slave\n7. Send messages - (hung, clients waiting for connection)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amit.bohra","name":"amit.bohra","key":"amit.bohra","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amit Bohra","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-01T06:59:30.787+0000","updated":"2011-04-01T06:59:30.787+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503032/comment/13014506","id":"13014506","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bootandy","name":"bootandy","key":"bootandy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"andy boot","active":true,"timeZone":"Etc/UTC"},"body":"I realise this is a dirty hack and I haven't thought thru the implications but opening class FailoverTransport and commenting out line 1044 \" this.uris.remove(uri);\" in method \"updateURIs()\" appears to make it work.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bootandy","name":"bootandy","key":"bootandy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"andy boot","active":true,"timeZone":"Etc/UTC"},"created":"2011-04-01T10:27:56.193+0000","updated":"2011-04-01T10:27:56.193+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12503032/comment/13489429","id":"13489429","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"We have numerous test cases covering scenarios like this which are all working without issue.  Recommend you upgrade to a newer release such as v5.7.0.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-11-02T14:00:14.739+0000","updated":"2012-11-02T14:00:14.739+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3256/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0eamv:"}}