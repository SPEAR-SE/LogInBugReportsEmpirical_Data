{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483860","self":"https://issues.apache.org/jira/rest/api/2/issue/12483860","key":"AMQ-2929","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-09-22T18:47:52.663+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Feb 25 22:34:17 UTC 2011","customfield_12310420":"14692","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_13558225672_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-02-25T22:34:17.656+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2929/watchers","watchCount":1,"isWatching":false},"created":"2010-09-22T00:23:52.011+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"4.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315622","id":"12315622","description":"","name":"5.3.2","archived":false,"released":true,"releaseDate":"2010-05-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-02-25T22:34:17.678+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I have a queue setup to send and consume compressed text messages.  This is done via Spring setting ActiveMQConnectionFactory.useCompression to true.  If the consumer connects to this queue before the first message is arrives, everything works great.\n\nIf the messages are sent to this queue before the consumer connects, those early messages will cause ZipException \"unknown compression method\" when consumed by the belated consumer. Debugger shows that the ActiveMQTextMessage.content already contains the uncompressed text (with 4 leading length bytes) when ActiveMQTextMessage.getText() is called.\n\nIf I set useCompression to false, early messages are consumed with no problems.  Please look into this.\n\nI notice that after ActiveMQTextMessage.getText() decompress the message, it does not set compressed to false. Not sure if that is the cause.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461870","id":"12461870","filename":"ActiveMQConsumerTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-23T00:17:30.982+0000","size":499,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461870/ActiveMQConsumerTest.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461871","id":"12461871","filename":"ActiveMQConsumerTest.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-23T00:17:31.055+0000","size":2631,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12461871/ActiveMQConsumerTest.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461869","id":"12461869","filename":"ActiveMQProducerTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-14T22:19:00.425+0000","size":876,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461869/ActiveMQProducerTest.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461821","id":"12461821","filename":"ActiveMQProducerTest.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-14T22:19:00.487+0000","size":2450,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12461821/ActiveMQProducerTest.xml"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59573","customfield_12312823":null,"summary":"Compressed text message received by consumer uncompressed","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"ActiveMQ 5.3.2 / Camel 2.2.0","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12942949","id":"12942949","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"body":"Here is how the connection factory defined:\n\n    <bean id=\"jmsXmlFactory\" class=\"org.apache.activemq.pool.PooledConnectionFactory\"\n          destroy-method=\"stop\">\n        <property name=\"connectionFactory\">\n            <bean class=\"org.apache.activemq.ActiveMQConnectionFactory\">\n                <property name=\"brokerURL\" value=\"${brokerConnectionURL}\"/>\n                <property name=\"userName\" value=\"${activemq.username}\"/>\n                <property name=\"password\" value=\"${activemq.password}\"/>\n                <property name=\"clientIDPrefix\" value=\"${processUniqueName}Xml-${serverId}-${pid}\"/>\n                <property name=\"transformer\">\n                    <bean class=\"org.apache.activemq.util.xstream.XStreamMessageTransformer\"/>\n                </property>\n                <property name=\"useCompression\" value=\"true\"/>\n            </bean>\n        </property>\n    </bean>\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-22T10:13:38.037+0000","updated":"2010-09-22T10:13:38.037+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12942950","id":"12942950","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"body":"Another observation is that while the message is enqueued with no consumer, using JConsole [browseMessages] button on that queue shows the decompressed message text. I would expect it to be unreadable compressed binary.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-22T10:20:32.560+0000","updated":"2010-09-22T10:20:32.560+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12942956","id":"12942956","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"body":"Debugger shows the mistake came off the wire. When the client reads the message from the wire, ActiveMQTextMessageMarshaller created the ActiveMQTextMessage with command.Message.compressed == true and Message.content contains decompressed text.\n\nTherefore, there two ActiveMQ broker bugs:\n\n1) The message queued with no consumer should not be decompressed.\n\n2) When the message is decompressed, the compressed flag should be set to false before sending the message to the belated consumer.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-22T16:51:28.543+0000","updated":"2010-09-22T17:02:00.919+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12942944","id":"12942944","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"body":"Indeed adding the following line between line 88 and 89 of ActiveMQTextMessage.java fixed the second bug and offer a temporary workaround for the problem as a whole:\n\ndiff ActiveMQTextMessage.java patch/ActiveMQTextMessage.java \n88a89\n>                     setCompressed(false);\n\nThe first bug mentioned above needs to be fixed, i.e. the broker must not call ActiveMQTextMessage.getText() to avoid decompressing the message when no consumer is available when the message is enqueued.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-22T18:42:41.498+0000","updated":"2010-09-22T18:42:41.498+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12942943","id":"12942943","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Can you provide a unit test or sample that demonstrates the issue, it would help to ensure the problem gets fixed and stays fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2010-09-22T18:47:52.663+0000","updated":"2010-09-22T18:47:52.663+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12942941","id":"12942941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"body":"Attached the test source program and its Spring xml. A producer is needed that uses the same jmsFactory defined in this XML to pump some messages (compressed) to the \"test.registration\" queue before running the test program. No message will be retrieved due to the ZipException.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-23T00:17:31.103+0000","updated":"2010-09-23T00:17:31.103+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12942964","id":"12942964","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Perhaps you could create a JUnit test case that reproduces this?  Or at least provide the source for  your producer?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2010-09-24T19:30:41.335+0000","updated":"2010-09-24T19:30:41.335+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12943052","id":"12943052","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"body":"The producer code you asked for. Please fix the broker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-10-14T22:19:00.529+0000","updated":"2010-10-14T22:19:00.529+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12943181","id":"12943181","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"body":"Latest findings\n============\nAn unconsumed message in a queue is decompressed when a JMX client code calls \"browse()\" on that Queue's MBean. Below is a stack trace captured by Eclipse (sorry about not having full class names).\n\n\"ActiveMQMonitorModule ... line: 86\" is where our code calls the \"browse\" method of the Queue's MBean. This led to \"ActiveMQTextMessage.getText() line: 83\", which decompressed the message, allocating large amount of memory, and possibly killing the broker altogether.\n\nAnother side effect is that the message is permanently decompressed in the queue, and due to the other bug mentioned in my 9/22 comment, the consumer receives a message that is decompressed but with the wrong (isCompressed() == true) result.\n\nOur work-around is to call the MBean's \"browseMessages()\" with the patch for AMQ-3023. However, if you use JConsole to browse the unconsumed messages, it too will trigger the decompression of messages (possibly killing the broker due to out of memory). A nasty booby trap.\n\nOne possible fix is for OpenTypeSupport.TextMessageOpenTypeFactory.getFields(Object) to check for m.isCompressed(), and if true not to call m.getText().  See line 367 of OpenTypeSupport.java.\n\n{code}\nThread [SelfMonitor] (Evaluating)\t\n\tInflaterInputStream(InputStream) line: 91 [local variables unavailable]\n\tActiveMQTextMessage.getText() line: 83 [local variables unavailable]\t\n\tOpenTypeSupport$TextMessageOpenTypeFactory.getFields(Object) line: 367\t\n\tOpenTypeSupport.convert(Message) line: 397\t\n\tQueueView(DestinationView).browse(String) line: 151\t\n\tQueueView(DestinationView).browse() line: 132\t\n\tGeneratedMethodAccessor43.invoke(Object, Object[]) line: not available\t\n\tDelegatingMethodAccessorImpl.invoke(Object, Object[]) line: 25\t\n\tMethod.invoke(Object, Object...) line: 597\t\n\tStandardMBeanIntrospector.invokeM2(Method, Object, Object[], Object) line: 93\t\n\tStandardMBeanIntrospector.invokeM2(Object, Object, Object[], Object) line: 27\t\n\tStandardMBeanIntrospector(MBeanIntrospector<M>).invokeM(M, Object, Object[], Object) line: 208\t\n\tPerInterface<M>.invoke(Object, String, Object[], String[], Object) line: 120\t\n\tStandardMBeanSupport(MBeanSupport<M>).invoke(String, Object[], String[]) line: 262\t\n\tAnnotatedMBean(StandardMBean).invoke(String, Object[], String[]) line: 391\t\n\tDefaultMBeanServerInterceptor.invoke(ObjectName, String, Object[], String[]) line: 836\t\n\tJmxMBeanServer.invoke(ObjectName, String, Object[], String[]) line: 761\t\n\tActiveMQMonitorModule$1QueueValueAccessor.getValue() line: 86\t\n\tActiveMQMonitorModule$1QueueValueAccessor.getValue() line: 67\t\n\tBaseModuleAttribute<D>.getCurrentValue() line: 106\t\n\tActiveMQMonitorModule(BaseMonitorModule).getCurrentModuleData() line: 105\t\n\tMonitorData.populateModuleData(MonitorModule) line: 195\t\n\tMonitorGenerator.process() line: 135\t\n\tBaseRouteBuilder$1.run() line: 81\t\n\tBaseRouteBuilder$2.run() line: 176\t\n\tTimerThread.mainLoop() line: 512\t\n\tTimerThread.run() line: 462\t\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mwc_tonesoft","name":"mwc_tonesoft","key":"mwc_tonesoft","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Michael Chen","active":true,"timeZone":"Etc/UTC"},"created":"2010-11-09T01:56:04.751+0000","updated":"2010-11-09T01:56:04.751+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483860/comment/12999610","id":"12999610","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"TextMessage class now clears the compressed flag when its body is uncompressed to avoid receiving a message in an invalid state.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-02-25T22:34:17.666+0000","updated":"2011-02-25T22:34:17.666+0000"}],"maxResults":10,"total":10,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2929/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0akdb:"}}