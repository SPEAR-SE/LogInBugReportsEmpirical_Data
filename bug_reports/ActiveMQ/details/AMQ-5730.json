{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12821191","self":"https://issues.apache.org/jira/rest/api/2/issue/12821191","key":"AMQ-5730","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2015-04-21T15:30:51.782+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Aug 23 17:19:04 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5730/watchers","watchCount":7,"isWatching":false},"created":"2015-04-15T14:54:42.905+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12341947","id":"12341947","name":"5.15.3","archived":false,"released":true,"releaseDate":"2018-02-01"}],"issuelinks":[{"id":"12541404","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12541404","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12991071","key":"AMQ-6368","self":"https://issues.apache.org/jira/rest/api/2/issue/12991071","fields":{"summary":"Non-blocking redelivery does not calculate exponential delivery properly","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofré","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-08-23T17:19:04.881+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"If nonBlockingRedivery is set to true and several message transactional deliveries are rollbacked by the same message consumer, their redelivery delay will interfer with each other. \n\nEx: \n1) A first message delivery is rollbacked. \n\n2) A second message is consumed by the same message consumer and delivery of second message is also rollbacked.\n\n3) First message is redelivered after initial delay and is rollbacked. \n\n4) Second message is delivered after initial delay and is rollbacked.\n\n5) First message is redelivered after delay according to values of parameters useExponentialBackOff, backOffMultiplier, maximumRedeliveryDelay and useCollisionAvoidance.\n\n6) Second message is redelivered after delay according to values of parameters *but also according the value of the delay consumer of the previous message*, stored in message consumer. For example, if last first message redelivery delay was x (computed at step 5), the current delay of step 6 will be at backoffmultiplier * x (if used).\n\n7) Again, next first message redelivery delay will be impacted by last second message redelivery delay, etc.\n\nA message redelivery should not impacted by other messages redelivery delay and should only be computed by the number of redeliveries.\n\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12729484","id":"12729484","filename":"ActiveMQRedelivery.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=iguanito","name":"iguanito","key":"iguanito","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"arnaud hoareau","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-30T14:09:36.099+0000","size":4986,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12729484/ActiveMQRedelivery.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"When nonBlockingRedelivery is set to true, redelivery delays can be incorrect","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=iguanito","name":"iguanito","key":"iguanito","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"arnaud hoareau","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=iguanito","name":"iguanito","key":"iguanito","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"arnaud hoareau","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821191/comment/14505116","id":"14505116","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Recommend you try and capture the issue in a unit test to show what's going on and protect any fixes into the future.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-04-21T15:30:51.782+0000","updated":"2015-04-21T15:30:51.782+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821191/comment/14521540","id":"14521540","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=iguanito","name":"iguanito","key":"iguanito","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"arnaud hoareau","active":true,"timeZone":"Etc/UTC"},"body":"Attached test reproducing the issue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=iguanito","name":"iguanito","key":"iguanito","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"arnaud hoareau","active":true,"timeZone":"Etc/UTC"},"created":"2015-04-30T14:09:36.107+0000","updated":"2015-04-30T14:09:36.107+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821191/comment/14532803","id":"14532803","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=iguanito","name":"iguanito","key":"iguanito","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"arnaud hoareau","active":true,"timeZone":"Etc/UTC"},"body":"I may explain a bit more the submitted test:\n\nTwo messages are sent at nearly the same instant. There is only consumer rollbacking the session at each message consumption. According to the values of initial delivery and the backoff multplier, the message are expected to be redelivered 1s later and 6s later their emission. This is the case for first message. Yet, the second message second redelivery is not done after 6s but after 26s (ie, 1sec + 5*6sec). IMHO, the second message should have been redelivered the 2nd time after 6s.\n\nDo you agree with this?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=iguanito","name":"iguanito","key":"iguanito","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"arnaud hoareau","active":true,"timeZone":"Etc/UTC"},"created":"2015-05-07T14:59:32.169+0000","updated":"2015-05-07T14:59:32.169+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821191/comment/16468478","id":"16468478","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"body":"The same behavior was described by another user on the mailing list: http://activemq.2283324.n4.nabble.com/Redelivery-schedule-is-messed-up-when-there-are-multiple-messages-on-the-queue-td4739313.html\r\n\r\nA quick look at the code indicates that ActiveMQMessageConsumer.rollback() appears to increment redeliveryDelay (a consumer-wide member variable) each time any message is redelivered, rather than keying it to the number of redelivery attempts for the message in question. It might be possible to instead use the same approach used in ActiveMQSession.afterRollback(), where we compute the redelivery delay's exponent based on the number of redelivery attempts for the message itself.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"created":"2018-05-09T06:41:31.565+0000","updated":"2018-05-09T06:41:31.565+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821191/comment/16549197","id":"16549197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofré","active":true,"timeZone":"Europe/Berlin"},"body":"I gonna test if it's still the case in 5.15.x (it seems so but a little bit different).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofré","active":true,"timeZone":"Europe/Berlin"},"created":"2018-07-19T12:18:42.079+0000","updated":"2018-07-19T12:18:42.079+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12821191/comment/16590560","id":"16590560","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jonenst","name":"jonenst","key":"jonenst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jon Harper","active":true,"timeZone":"Etc/UTC"},"body":"This is a problem because with this, if exponential backoff is used and for some reason all jms transactions are rolled back for a few seconds, all the messages are redelivered but after 10-20 messages your are pretty much guaranteed to have a very long delay because of the exponential (the only limit is maximumRedeliveryDelay).\r\n\r\nSo this means very high delays can be reached in a very short time (in contrast to the normal mode where it takes a long time to get to a long delay).\r\n The messages are scheduled on this consumer in a very long time and the only way to process them again is to stop the consumer so that another consumer can process them.\r\n\r\nFixing this is important because the only workaround is to have a very low maxRedeliveryDelay which defeats the purpose of using exponential backoff.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jonenst","name":"jonenst","key":"jonenst","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jon Harper","active":true,"timeZone":"Etc/UTC"},"created":"2018-08-23T17:19:04.881+0000","updated":"2018-08-23T17:19:04.881+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5730/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2daf3:"}}