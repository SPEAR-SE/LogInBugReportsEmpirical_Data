{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13086807","self":"https://issues.apache.org/jira/rest/api/2/issue/13086807","key":"AMQ-6770","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2017-07-13 05:09:33.474","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6770/watchers","watchCount":1,"isWatching":false},"created":"2017-07-13T05:09:33.474+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12339772","id":"12339772","name":"5.14.5","archived":false,"released":true,"releaseDate":"2017-04-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-07-13T06:17:37.602+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12324803","id":"12324803","name":"JDBC"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When ActiveMQ is configured with JDBC persistence storage (postgres) and there is many pending events (more than 5 000 000) consumers receive events in a bulk only every several seconds even if a queue contains a lot of events.\n\nTo get such state of AMQ I've used activemq-perf-maven-plugin with below settings:\n{code}\nmvn org.apache.activemq.tooling:activemq-perf-maven-plugin:consumer -Dconsumer.destName=queue://TEST.FOO -Dconsumer.recvDuration=300000 -Dconsumer.sessAckMode=tran\nsacted -DsysTest.reportType=verbose -DsysTest.numClients=3 -Dfactory.asyncSession=false -Dfactory.prefetchQueue=1 -Dconsumer.sessTransacted=true -Dfactory.prefetchPolicy.queuePrefetch=1\n{code}\n\nOutput and result of execution attached.\n\nOn database side there are information that execution of query is slow:\n{code}\n2017-07-13 04:37:38 UTC;activemq;11184;5966f908.2bb0;7/2253014;0;1;LOG:  duration: 7706.308 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:37:38 UTC;activemq;11184;5966f908.2bb0;7/2253014;0;2;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5583825'\n2017-07-13 04:37:47 UTC;activemq;11184;5966f908.2bb0;7/2255501;0;3;LOG:  duration: 7921.731 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:37:47 UTC;activemq;11184;5966f908.2bb0;7/2255501;0;4;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5586325'\n2017-07-13 04:37:56 UTC;activemq;6556;5966f907.199c;6/1900865;0;1;LOG:  duration: 8110.328 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:37:56 UTC;activemq;6556;5966f907.199c;6/1900865;0;2;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5588825'\n2017-07-13 04:38:03 UTC;activemq;6556;5966f907.199c;6/1901366;0;3;LOG:  duration: 7711.928 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:38:03 UTC;activemq;6556;5966f907.199c;6/1901366;0;4;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5589325'\n2017-07-13 04:38:11 UTC;activemq;2148;5966f359.864;2/2670600;0;3;LOG:  duration: 7737.924 ms  execute S_5: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:38:11 UTC;activemq;2148;5966f359.864;2/2670600;0;4;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5589825'\n2017-07-13 04:38:20 UTC;activemq;2148;5966f359.864;2/2671104;0;5;LOG:  duration: 7750.932 ms  execute S_5: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:38:20 UTC;activemq;2148;5966f359.864;2/2671104;0;6;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5590325'\n2017-07-13 04:38:28 UTC;activemq;6556;5966f907.199c;6/1902887;0;5;LOG:  duration: 7718.725 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:38:28 UTC;activemq;6556;5966f907.199c;6/1902887;0;6;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5590825'\n2017-07-13 04:38:35 UTC;activemq;11184;5966f908.2bb0;7/2259004;0;5;LOG:  duration: 7685.510 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:38:35 UTC;activemq;11184;5966f908.2bb0;7/2259004;0;6;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5591325'\n2017-07-13 04:38:43 UTC;activemq;2148;5966f359.864;2/2672124;0;7;LOG:  duration: 7717.112 ms  execute S_5: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:38:43 UTC;activemq;2148;5966f359.864;2/2672124;0;8;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5591825'\n2017-07-13 04:38:51 UTC;activemq;11184;5966f908.2bb0;7/2259996;0;7;LOG:  duration: 7717.112 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:38:51 UTC;activemq;11184;5966f908.2bb0;7/2259996;0;8;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5592325'\n2017-07-13 04:38:59 UTC;activemq;11184;5966f908.2bb0;7/2260488;0;9;LOG:  duration: 7682.116 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:38:59 UTC;activemq;11184;5966f908.2bb0;7/2260488;0;10;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5592825'\n2017-07-13 04:39:07 UTC;activemq;11184;5966f908.2bb0;7/2260989;0;11;LOG:  duration: 7718.309 ms  execute S_3: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:39:07 UTC;activemq;11184;5966f908.2bb0;7/2260989;0;12;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5593325'\n2017-07-13 04:39:15 UTC;activemq;7472;5966e588.1d30;5/1987914;0;3;LOG:  duration: 7779.711 ms  execute S_5: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:39:15 UTC;activemq;7472;5966e588.1d30;5/1987914;0;4;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5594325'\n2017-07-13 04:39:23 UTC;activemq;7472;5966e588.1d30;5/1988403;0;5;LOG:  duration: 7789.711 ms  execute S_5: SELECT ID, MSG FROM ACTIVEMQ_MSGS WHERE CONTAINER=$1 AND ID < $2 AND ID > $3 AND XID IS NULL ORDER BY ID\n2017-07-13 04:39:23 UTC;activemq;7472;5966e588.1d30;5/1988403;0;6;DETAIL:  parameters: $1 = 'queue://TEST.FOO', $2 = '11786094', $3 = '5594825'\n{code}\n\nI've tried to improve performance on database side by creating new indexes but it hasn't helped. The problem is in number of rows that the query returns (in may case more than 5 000 000).\nAfter analyzing AMQ code a fix for it seams easy. Only first _maxPageSize_ rows (in my case 500) are used so rest of rows can be skipped and even not processed by database.\nI think that the _findNextMessagesStatement_ should be changed to:\n{code}\n         findNextMessagesStatement = \"SELECT ID, MSG FROM \" + getFullMessageTableName()\n                                        + \" WHERE CONTAINER=? AND ID < ? AND ID > ? AND XID IS NULL ORDER BY ID LIMIT ?\";\n{code}\nwhere the LIMIT is set to _maxPageSize_.\n\nWhat do you think about such change? Is it safe in context of data consistency and events processing in ActiveMQ? I know that LIMIT may not be a solution for everybody \nas it isn't supported by [all databases|https://stackoverflow.com/questions/1528604/how-universal-is-the-limit-statement-in-sql].\nThere is _org.apache.activemq.store.jdbc.JDBCAdapter.limitQuery_ method that should modify query to limit amount of rows but it has valuable implementation only in _OracleJDBCAdapter_, for other databases the method doesn't modify a query so limit isn't added.\n\nI also wonder why the range in query ID < $2 AND ID > $3 is so wide? \n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12877024","id":"12877024","filename":"activemq-jdbc-store-limit.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ragnor84","name":"ragnor84","key":"ragnor84","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jakub","active":true,"timeZone":"Europe/Warsaw"},"created":"2017-07-13T06:17:23.501+0000","size":5713,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12877024/activemq-jdbc-store-limit.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12877015","id":"12877015","filename":"consumer-output.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ragnor84","name":"ragnor84","key":"ragnor84","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jakub","active":true,"timeZone":"Europe/Warsaw"},"created":"2017-07-13T05:09:53.255+0000","size":60799,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12877015/consumer-output.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Slow events processing","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ragnor84","name":"ragnor84","key":"ragnor84","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jakub","active":true,"timeZone":"Europe/Warsaw"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ragnor84","name":"ragnor84","key":"ragnor84","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jakub","active":true,"timeZone":"Europe/Warsaw"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10430","value":"Patch","id":"10430"}],"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6770/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3hgsf:"}}