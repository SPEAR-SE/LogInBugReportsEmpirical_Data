{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483330","self":"https://issues.apache.org/jira/rest/api/2/issue/12483330","key":"AMQ-1617","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315630","id":"12315630","description":"Issues that need to be reviewed - do we keep 'em or do we kick 'em? ","name":"NEEDS_REVIEW","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2008-06-24T05:52:07.176+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Oct 07 15:33:58 UTC 2011","customfield_12310420":"50314","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2328515755_*|*_6_*:*_2_*:*_6640112376_*|*_5_*:*_1_*:*_23248_*|*_4_*:*_1_*:*_103714911662","customfield_12312321":null,"resolutiondate":"2011-10-07T15:33:58.757+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1617/watchers","watchCount":2,"isWatching":false},"created":"2008-03-12T10:34:35.813+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315615","id":"12315615","description":"","name":"4.1.2","archived":false,"released":true,"releaseDate":"2008-04-14"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-10-07T15:33:58.850+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313898","id":"12313898","name":"JCA Container"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"I am trying to do a database update and send a message to ActiveMQ via JMS in a single XA transaction. When tha JTA transaction manager tries to prepare the commit I get the following in the ActiveMQ log and the transaction is rolled back.\n\n2008-03-12 11:09:01,713 [/127.0.0.1:2399] DEBUG TransportConnection            - Setting up new connection: /127.0.0.1:2399\n2008-03-12 11:09:01,713 [/127.0.0.1:2399] DEBUG AbstractRegion                 - Adding consumer: ID:FE-Z2965-2033-1205312064755-0:30:-1:1\n2008-03-12 11:09:01,728 [/127.0.0.1:2399] DEBUG AMQMessageStore                - Journalled transacted message add for: ID:FE-Z2965-2033-1205312064755-0:30:1:1:1, at: offset = 3213, file = 1, size = 557, type = 1\n2008-03-12 11:09:01,728 [/127.0.0.1:2399] DEBUG AbstractRegion                 - Removing consumer: ID:FE-Z2965-2033-1205312064755-0:30:-1:1\n2008-03-12 11:09:01,728 [/127.0.0.1:2399] DEBUG Service                        - Error occured while processing sync command: java.lang.NullPointerException: Context is null\njava.lang.NullPointerException: Context is null\n\tat org.apache.activemq.broker.TransportConnection.processPrepareTransaction(TransportConnection.java:375)\n\tat org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:98)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:291)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:181)\n\tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n\tat org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:134)\n\tat org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:204)\n\tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n\tat org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:196)\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:183)\n\tat java.lang.Thread.run(Thread.java:595)\n2008-03-12 11:09:01,744 [/127.0.0.1:2399] DEBUG TransportConnection            - Setting up new connection: /127.0.0.1:2399\n2008-03-12 11:09:01,744 [/127.0.0.1:2399] DEBUG AbstractRegion                 - Adding consumer: ID:FE-Z2965-2033-1205312064755-0:30:-1:2\n2008-03-12 11:09:01,760 [/127.0.0.1:2399] DEBUG XATransaction                  - XA Transaction rollback: XID:4871251:0f000000549135a246452d5a323936352c7365727665722c5033373030:46452d5a323936352c7365727665722c50333730302c01\n2008-03-12 11:09:01,760 [/127.0.0.1:2399] DEBUG AMQMessageStore                - Transacted message add rollback for: ID:FE-Z2965-2033-1205312064755-0:30:1:1:1, at: offset = 3213, file = 1, size = 557, type = 1\n\nThe problem seems to be that the current connection is unregistered from the org.apache.activemq.broker.TransportConnectionStateRegister once the message is written to the journal and no new connection is registered before the processPrepareTransaction invocation. However, I have no idea where to look in the code to fix this.\n\nRegards,\nKai","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59843","customfield_12312823":null,"summary":"XA transaction fails to prepare commit","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudalla","name":"hudalla","key":"hudalla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kai Hudalla","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudalla","name":"hudalla","key":"hudalla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kai Hudalla","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows XP, glassfish v2 UR1","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483330/comment/12939471","id":"12939471","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudalla","name":"hudalla","key":"hudalla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kai Hudalla","active":true,"timeZone":"Etc/UTC"},"body":"The problem is that the application server (glassfish) triggers the ManagedConnection's cleanup() method after XA.end and BEFORE XA.prepare (and not AFTER the XA.commit  as mandated by the JCA spec). Thus the broker does not have any transactional context anymore when the XA.prepare is issued ...\n\nKai","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudalla","name":"hudalla","key":"hudalla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kai Hudalla","active":true,"timeZone":"Etc/UTC"},"created":"2008-04-08T09:23:11.533+0000","updated":"2008-04-08T09:23:11.533+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483330/comment/12939462","id":"12939462","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudalla","name":"hudalla","key":"hudalla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kai Hudalla","active":true,"timeZone":"Etc/UTC"},"body":"Not a bug in ActiveMQ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hudalla","name":"hudalla","key":"hudalla","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Kai Hudalla","active":true,"timeZone":"Etc/UTC"},"created":"2008-04-08T09:23:34.815+0000","updated":"2008-04-08T09:23:34.815+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483330/comment/12939886","id":"12939886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=a.a.akimov","name":"a.a.akimov","key":"a.a.akimov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexei Akimov","active":true,"timeZone":"Etc/UTC"},"body":"I do think this is an ActiveMQ bug. The mentioned behaviour violates Java Connector Architecture (JCA) and Java Transaction Architecture (JTA) specifications. XAResource must have opportunity to commit one transaction being already used in another one. In a typical scenario described in specs managed connection is cleaned up before the transaction commits. Being cleaned the connection is returned to pool and can be supplied to another client. In the current ActiveMQ implementation this leads to invalid connection context when the first transaction commits. XAResource implementatiom must not depend on the connection client specific data which is cleaned before returning the connection to pool.\n\nHera are the references to specs:\n1. Scenario: Connection Close and JTA Transactional Cleanup (JCA 7.6.5)\n2. Scenario: Connection Event Notifications and Connection Close (JCA 6.8.3)\n3. Resource Sharing (JTA 3.6.4)\n\nBest regards\nAlexei Akimov","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=a.a.akimov","name":"a.a.akimov","key":"a.a.akimov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Alexei Akimov","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-24T05:52:07.176+0000","updated":"2008-06-24T05:52:07.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483330/comment/12941618","id":"12941618","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"A test case would help make this concrete. There have been some mods the the JCA connector to defer connection close till a transaction completes, allowing a connection to be pooled when a transaction is still in need of completion. \nWith a test case we could verify the expected behavior against trunk. If the test still fails with trunk or a 5.3-SNAPSHOT we will have something to work on.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-06-25T09:57:30.678+0000","updated":"2009-06-25T09:57:30.678+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483330/comment/13122874","id":"13122874","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"No test case present and no information given on how to reproduce this.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-10-07T15:33:58.830+0000","updated":"2011-10-07T15:33:58.830+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1617/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0am1b:"}}