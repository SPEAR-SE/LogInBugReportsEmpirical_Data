{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483894","self":"https://issues.apache.org/jira/rest/api/2/issue/12483894","key":"AMQ-2618","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316331","id":"12316331","description":"Next unplanned v5 maintenance release","name":"5.x","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2010-03-03T12:48:44.528+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 21 16:40:14 UTC 2012","customfield_12310420":"44157","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_65823342204_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-03-21T16:40:14.200+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2618/watchers","watchCount":3,"isWatching":false},"created":"2010-02-18T20:24:32.185+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-03-21T16:40:14.382+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"It is possible to hang the broker when setting a systemUsage tempUsage limit with permanent queues and persistent messages.\n\nI have attached a test class that demonstrates the problem. I got the test case from AMQ-2610 and have essentially only added the line:\n{code}\nbrokerService.getSystemUsage().getTempUsage().setLimit(10 * 1024 * 1024);\n{code}\n\nWhen that line is in the code the test case hangs after 995 messages, when the line is commented out it runs probably until it runs out of disk space.\n\nWhen the broker hangs a ctrl+C is not enough to shut it down, when connecting over JMX with JConsole the queue being used in the test will not render its attributes, you can't connect with another consumer or producer etc.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461623","id":"12461623","filename":"UnlimitedEnqueueTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zakalwe","name":"zakalwe","key":"zakalwe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mats Henrikson","active":true,"timeZone":"Etc/UTC"},"created":"2010-02-18T20:25:04.666+0000","size":5150,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461623/UnlimitedEnqueueTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172366","customfield_12312823":null,"summary":"systemUsage tempUsage limit causes broker to lock up when using permanent queue with persistent messages","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zakalwe","name":"zakalwe","key":"zakalwe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mats Henrikson","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=zakalwe","name":"zakalwe","key":"zakalwe","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mats Henrikson","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483894/comment/12942308","id":"12942308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"To make this not hang, the blocking on usage needs an overhaul such that it can be aware of the connection context or the shutdown needs to interrupt waiting threads.\nOne issue is that the pendingmessage cursors use the temp store and these are per subscription or durable topic subscription. The messages are present in the store so it is too late for sendFailIfNoSpace to kick in and throw an exception. \nGating each send on available usage up front may be the simplest approach but that will have lots of side effects like not being aware of flushing to disk when a cache is exhausted. Not sure how to proceed with this at the moment. Needs more thought.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-03T12:48:44.528+0000","updated":"2010-03-03T12:48:44.528+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483894/comment/12942414","id":"12942414","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simoncox","name":"simoncox","key":"simoncox","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Cox","active":true,"timeZone":"Asia/Shanghai"},"body":"We've noticed a similar issue to this, but without persistent messages.  Persistence is enabled in the broker, but all messages are sent specifying NON_PERSISTENT.  The hanging thread in the broker looks like:\n\n  \"ActiveMQ Transport: tcp:///10.66.1.23:8385\" daemon prio=10 tid=0x00000000516aec00 nid=0x7f97 in Object.wait() [0x000000004d263000..0x000000004d263b10]\n     java.lang.Thread.State: TIMED_WAITING (on object monitor)\n          at java.lang.Object.wait(Native Method)\n          at org.apache.activemq.usage.Usage.waitForSpace(Usage.java:99)\n          - locked <0x00002aaab3912640> (a java.lang.Object)\n          at org.apache.activemq.usage.Usage.waitForSpace(Usage.java:77)\n          at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:194)\n          - locked <0x00002aaab41ac8f8> (a org.apache.activemq.broker.region.cursors.FilePendingMessageCursor)\n          at org.apache.activemq.broker.region.cursors.StoreDurableSubscriberCursor.addMessageLast(StoreDurableSubscriberCursor.java:169)\n          - locked <0x00002aaab41ac3e8> (a org.apache.activemq.broker.region.cursors.StoreDurableSubscriberCursor)\n          at org.apache.activemq.broker.region.PrefetchSubscription.add(PrefetchSubscription.java:156)\n          - locked <0x00002aaab41acb80> (a java.lang.Object)\n          at org.apache.activemq.broker.region.DurableTopicSubscription.add(DurableTopicSubscription.java:199)\n          at org.apache.activemq.broker.region.policy.SimpleDispatchPolicy.dispatch(SimpleDispatchPolicy.java:49)\n          - locked <0x00002aaab41abe80> (a java.util.concurrent.CopyOnWriteArrayList)\n          at org.apache.activemq.broker.region.Topic.dispatch(Topic.java:588)\n          at org.apache.activemq.broker.region.Topic.doMessageSend(Topic.java:442)\n          - locked <0x00002aaab41aae18> (a org.apache.activemq.broker.region.Topic)\n          at org.apache.activemq.broker.region.Topic.send(Topic.java:376)\n          at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:354)\n          at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:445)\n          at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:224)\n          at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:126)\n          at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:95)\n          at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:133)\n          at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:443)\n          at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:631)\n          at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:297)\n          at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:175)\n          at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n          at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n          at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:210)\n          - locked <0x00002aaab41e21d0> (a org.apache.activemq.transport.InactivityMonitor$1)\n          at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n          at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)\n          at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)\n          at java.lang.Thread.run(Thread.java:619)\n\nIn this state, no new connections to the broker can be established, and no messages can be sent on existing connections.\n\nWe're on 5.3.0.  For the time being we've disabled persistence (setting adding persistent=\"false\" to the broker element in the broker config).  We're not sure if this has stopped the hanging yet.\n\nThanks,\nSimon","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=simoncox","name":"simoncox","key":"simoncox","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Simon Cox","active":true,"timeZone":"Asia/Shanghai"},"created":"2010-04-16T12:51:26.356+0000","updated":"2010-04-16T12:51:26.356+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483894/comment/12943250","id":"12943250","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lizkeddy","name":"lizkeddy","key":"lizkeddy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Elizabeth Keddy","active":true,"timeZone":"Etc/UTC"},"body":"Hello,\nI'm looking for some suggestions for a workaround.\nWe are experiencing this problem in 5.4.0 with non-persistent messages.  We see the same stack trace reported by Simon.\n\nI was experimenting with a solution whereby the temp store usage would be monitored.  Producers would be blocked before the temp store is filled.\nI'm seeing, however, that the temp store usage doesn't drop after the consumer connects and consumes all messages.  I have left the system running over 12 hours with no new messages and the temp store usage is remains at  16%.\n\nAny suggests appreciated.\nThanks,\nElizabeth","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lizkeddy","name":"lizkeddy","key":"lizkeddy","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Elizabeth Keddy","active":true,"timeZone":"Etc/UTC"},"created":"2010-11-23T14:54:45.799+0000","updated":"2010-11-23T14:54:45.799+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483894/comment/12943254","id":"12943254","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The temp store will only be reclaimed in journal data file size blocks which by default are 32MB. So if you have not filled a journal file and moved on to the next, there can be no reduction in size.\nTo configure a smaller journal file size you would need to configure an PListStore as the temp store for the broker using xbean xml configuration. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-11-24T12:25:12.111+0000","updated":"2010-11-24T12:25:12.111+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483894/comment/13234473","id":"13234473","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This is a configuration issue, and can be resolved by using something like: \n\n{noformat}\n        brokerService.getTempDataStore().setJournalMaxFileLength(10 * 1024);\n\n{noformat}\n\nto configure a temp store journal file length less than the configured limit.  The current trunk brroker will warn you when you make this configuration error.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-03-21T16:40:14.347+0000","updated":"2012-03-21T16:40:14.347+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2618/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tv7r:"}}