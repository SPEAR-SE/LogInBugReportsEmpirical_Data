{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483373","self":"https://issues.apache.org/jira/rest/api/2/issue/12483373","key":"AMQ-1529","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-03-10T14:17:02.180+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Nov 13 09:39:10 UTC 2012","customfield_12310420":"84666","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_150871189232_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-10-07T12:36:59.061+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1529/watchers","watchCount":4,"isWatching":false},"created":"2007-12-27T07:57:09.851+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-11-13T09:39:10.241+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"In a blob-message you can specify that the broker can delete the blob if the message is delivered or outdated.\nBut actual onle the message with the reference to the blob is deletet, the use-data in the repository not. The problem is the separation of the blob from the message itself.\n\nMy idea is to extend the persistence store to check at delete if it is a blob message and then delete the blob from the repository. I have done this in the jdbc- and kaha message store (see patch).\n\nJDBC message store:\n- created a new table with all blob url`s which must be delete if the message is deleted\n| ID (primary Key) | MSGID (reference to ID in MESSAGE table) | URL |\n- on message add check if it is a blob-message and if the broker must delete the message add the information to the new table\n- in cleanup a query on that table finds all urls with no existing reference in the MESSAGE table (becaus the message is deleted) and then deletes this blobs\n\nKAHA message store:\n- TopicSubAck has a new attribute remotBlobUrl\n- on message add check if it is a blob-message and if the broker must delete the message add the url to the TopicSubAck\n- on acknowledge at delete check if the attribute is set an if it is set delete the blob\n\nTHINGS TO DO\n- add a similar mechanism to the other message stores\n- only the first delete is successfull, every other delete request ends in an 500 errorcode from the server","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460908","id":"12460908","filename":"ASF.LICENSE.NOT.GRANTED--patch.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcobuss","name":"marcobuss","key":"marcobuss","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Buss","active":true,"timeZone":"Etc/UTC"},"created":"2007-12-27T07:57:09.902+0000","size":17904,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460908/ASF.LICENSE.NOT.GRANTED--patch.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"32452","customfield_12312823":null,"summary":"The blob of a blob-message will never be deleted","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcobuss","name":"marcobuss","key":"marcobuss","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Buss","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcobuss","name":"marcobuss","key":"marcobuss","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Buss","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows vista, java 6","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483373/comment/12939293","id":"12939293","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcobuss","name":"marcobuss","key":"marcobuss","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Buss","active":true,"timeZone":"Etc/UTC"},"body":"The error 500 occours due to the fact that is an lock on the file.\nI think this happens on jetty becaus the server holds the connection for a time. And so when the message is consumed and a GET is invoked for this file the lock ois set until the connection will be closed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcobuss","name":"marcobuss","key":"marcobuss","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco Buss","active":true,"timeZone":"Etc/UTC"},"created":"2007-12-27T14:55:38.093+0000","updated":"2007-12-27T14:55:38.093+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483373/comment/12942338","id":"12942338","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vekili","name":"vekili","key":"vekili","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vesna Djurdjevic","active":true,"timeZone":"Etc/UTC"},"body":"I have checked the error 500 in the activemq-fileserver. \nThe problem is that streams are not closed when the file is uploaded on the server.\n\nthis would fix the problem\n{code:title=org.apache.activemq.util.RestFilter.java}\n    protected void doPut(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {\n\n        // some code missing here...\n\n        FileOutputStream out = new FileOutputStream(file);\n        try {\n            IO.copy(request.getInputStream(), out);\n        } catch (IOException e) {\n            Log.warn(Log.EXCEPTION, e); // is this obsolete?\n            throw e;\n        }finally{\n            out.close();\n        }\n\n        response.setStatus(HttpURLConnection.HTTP_NO_CONTENT); // we return no\n                                                                // content\n    }\n{code}\n\nAlso in KahaMessageStore.java should be added removing the blob files when the message is removed.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vekili","name":"vekili","key":"vekili","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Vesna Djurdjevic","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-10T14:17:02.180+0000","updated":"2010-03-10T14:17:02.180+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483373/comment/13471212","id":"13471212","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"AMQ-2430 fixed this.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2012-10-07T12:36:59.076+0000","updated":"2012-10-07T12:36:59.076+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483373/comment/13496062","id":"13496062","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pnidl","name":"pnidl","key":"pnidl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=pnidl&avatarId=16139","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pnidl&avatarId=16139","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pnidl&avatarId=16139","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pnidl&avatarId=16139"},"displayName":"Petr Nídl","active":true,"timeZone":"Europe/Berlin"},"body":"This issue is not fixed in 5.7.0.\norg.apache.activemq.command.ActiveMQBlobMessage.deleteFile() method is the only (and I suppose that advisable) way to delete the actual BLOB but it is never called from ActiveMQ classes (not even for messages marked as \"deletedByBroker\").\nFor acknowledged messages you can use simple workaround and define custom acknowledge callback that calls the delete method. But for expired messages I see no elegant way to force ActiveMQ to delete the BLOB. Marco's patch could work but it is not used in 5.7.0 release.\nIs there some other way that broker deletes BLOB messages or am I right that this feature doesn't work?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pnidl","name":"pnidl","key":"pnidl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=pnidl&avatarId=16139","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=pnidl&avatarId=16139","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=pnidl&avatarId=16139","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=pnidl&avatarId=16139"},"displayName":"Petr Nídl","active":true,"timeZone":"Europe/Berlin"},"created":"2012-11-13T09:39:10.241+0000","updated":"2012-11-13T09:39:10.241+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1529/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i05x1z:"}}