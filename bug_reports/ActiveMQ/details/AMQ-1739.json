{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482579","self":"https://issues.apache.org/jira/rest/api/2/issue/12482579","key":"AMQ-1739","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2008-05-21T11:52:59.385+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 04 18:27:51 UTC 2008","customfield_12310420":"84784","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_8971087587_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-09-02T06:57:36.059+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1739/watchers","watchCount":6,"isWatching":false},"created":"2008-05-21T10:59:28.472+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-07-28T13:44:56.376+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We have no idea why or when, but within a few days after start-up, ActiveMQ suddenly runs out of file descriptors (we've raised the limit to 10240). According to lsof it has lots of sockets which are in CLOSE_WAIT when that happens. As soon as that happened once, it would re-occur within a few hours. This behavior did not happen with ActiveMQ 5.0.\n\nWe have five queues, all with only one consumer. All consumption and production is via the Stomp-interface using PHP-clients. Three of those queues get up to 50-100 messages/second in peak moments, while the consumers adjust their own consumption rate to the systems load (normally its maxed to about 50-150/sec). So in high-load moments on the consumers, the queues can grow to a few thousand messages, normally the queues are emptied as soon as a message occurs. Those five consumers stay connected indefinitely.\n\nThe messages are all quite small (at most 1 KB or so) and come from 5 web servers. For each web page-request (about 2-3M/day) a connection is made to ActiveMQ via Stomp and at least one message is sent to ActiveMQ, for most requests two are sent to the two most active queues. For all request a new connection is made and at most 4 stomp-messages are sent to ActiveMQ (connect, two messages, disconnect), since apache+php does not allow useful reuse of sockets and similar resources.So \nSo the connection-rate is about the same as the highest message rate on any of the queues (so 50-100connects/second).\n\nWhen the high amount of sockets in CLOSE_WAIT occurs, we manually disable the producers and the sockets disappear gradually. After that the amount of sockets stays around 180-190 (mostly opened jars), but seams to re-increase more easily than when ActiveMQ is restarted. I have not checked if anything special happens on the web servers or databases, since their producer and consumer implementation has not changed since 5.0.\n\nWhat I did notice is that the memory-consumption increases heavily prior to running out of descriptors, and the consumption re-increases way to fast compared to before 11:45u:\nhttp://achelois.tweakers.net/~acm/tnet/activemq-5.1-memory-consumption.png","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461088","id":"12461088","filename":"stomp-overload-producer.tgz","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"created":"2008-05-27T11:41:41.903+0000","size":4400,"mimeType":"application/x-gzip","content":"https://issues.apache.org/jira/secure/attachment/12461088/stomp-overload-producer.tgz"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161416","customfield_12312823":null,"summary":"ActiveMQ 5.1.0 runs out of file descriptors with lots of 'CLOSE_WAIT' sockets","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"We have a single broker with no special network-stuff. Our broker-system has two single core Opterons, 8GB of memory, plenty of I/O and runs a recent 64bit debian with 2.6.21 kernel.\n\nJava(TM) SE Runtime Environment (build 1.6.0_06-b02)\nJava HotSpot(TM) 64-Bit Server VM (build 10.0-b22, mixed mode)\n\nWe left most of the activemq.xml-configuration as-is and adjusted the start-up script to run with 2GB heap size and parallel garbage collector, which was more or less needed for 5.0 and left for 5.1 in the start-up script.","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939718","id":"12939718","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"SVN revision 658637 makes closing a socket in a separate thread optional.\nThe property to set is closeAsync which is true by default.\n\nTo disable this in a broker add it as a transport option to the transport connector address \ne.g.  \n\n<transportConnectors>\n            <transportConnector name=\"openwire\" uri=\"tcp://localhost:61616?transport.closeAsync=false\"/>\n</transportConnectors>\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-21T11:52:59.385+0000","updated":"2008-05-21T11:52:59.385+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939687","id":"12939687","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ammulder","name":"ammulder","key":"ammulder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Mulder","active":true,"timeZone":"Etc/UTC"},"body":"For what it's worth, we saw this (problems with lots of CLOSE_WAIT sockets) only when testing with client with a tight loop that opened and closed lots of connections (instead of pooling), and only on Windows (where it would fail unable to get an available port after 4000-5000 connections).\n\nAnother solution seemed to be to alter the Transport to set SO_LINGER to any positive value.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ammulder","name":"ammulder","key":"ammulder","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Mulder","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-21T12:22:53.141+0000","updated":"2008-05-21T12:22:53.141+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939712","id":"12939712","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fhanik","name":"fhanik","key":"fhanik","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Filip Hanik","active":true,"timeZone":"Etc/UTC"},"body":"CLOSE_WAIT is a kernel tuning parameter, how long the connection stays there depends on your OS.\nOn linux I don't even know if you can control it, but I know you can on windows and solaris.\nproblem with it being a kernel parameter, is that it then affects all the system, any program using TCP connections","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fhanik","name":"fhanik","key":"fhanik","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Filip Hanik","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-21T21:39:17.842+0000","updated":"2008-05-21T21:39:17.842+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939724","id":"12939724","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fhanik","name":"fhanik","key":"fhanik","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Filip Hanik","active":true,"timeZone":"Etc/UTC"},"body":"I stand corrected, it is just that solaris used to misname the parameter :)\n\nhttp://www.sean.de/Solaris/soltune.html#tcp_close_wait_interval\n\nclose_Wait on a busy system can stick around if the application hasn't called close (server too busy, or a bug)\n\nhere is a good summary\nhttp://www.sunmanagers.org/pipermail/sunmanagers/2006-January/039225.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fhanik","name":"fhanik","key":"fhanik","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Filip Hanik","active":true,"timeZone":"Etc/UTC"},"created":"2008-05-22T14:17:37.885+0000","updated":"2008-05-22T14:17:37.885+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939716","id":"12939716","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"body":"The transport.closeAsync=false seems to work. We haven't had ActiveMQ running out of file descriptors for a few days now.\n\nI did see the systemload spike to 3+ a few times though, so the original issue which started the whole running-out-of-descriptors thingy still seem to exist. With a maximum heap of 512MB it ran out of memory and started doing full GC's every few seconds. With 1024MB heap it had less trouble with the increased load, but ran to gc's where it ran had 900MB consumed and reduced it to only 500MB rather than 300MB -> 30MB.\n\nI guess that's a different issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"created":"2008-05-26T07:57:35.315+0000","updated":"2008-05-26T07:57:35.315+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939731","id":"12939731","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"body":"The issue - or a similar one - reoccured yesterday.\n\nIt appears ActiveMQ 5.1/5.2-snapshot copes much worse with queues that are filled faster than consumed (or not consumed at all) than 5.0.\n\nWith 5.0 I could fill up two queues to over 80k small messages, but 5.2-snapshot refused to accept connections after about 5120 message on one queue and 3690 on the other.\n\nThe attached tgz is a set of two php5 scripts. Just extract it somewhere and adjust the $brokerUri in 'producerserver.php' to fit your needs. Then you should be able to run it and get an overloaded activemq within a minute or so.\n\nRunning is simple, make sure you have a CLI-version of php 5 (in debian that is 'apt-get install php5-cli') and run: 'php producerserver.php'\n\nThat script will then include the default Stomp-implementation for php and connect to ActiveMQ using Stomp. It forks off $max child-processes, until you stop the script, which send two messages to two seperate queues.  If you need any special connection-parameters, have a look at the Stomp.php StompConnection's 'getInstance'-method, but the above should work with a default ActiveMQ-install.\n\nOur ActiveMQ is started with a slightly adjusted activemq.xml (ssl and xmmp connections are not started, camel-section is empty, resource management is commented out) but mostly left to the defaults. Our ACTIVEMQ_OPTS = \"-XX:+UseParallelOldGC -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -Xms1024M -Xmx1024M -Dorg.apache.activemq.UseDedicatedTaskRunner=true\"\n\nAlthough normally you'd have at least one consumer for those queue's, its easier and faster to reproduce the issue without one. That way you should get 'ERROR TransportConnector             - Could not accept connection : Too many open files' pretty fast.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"created":"2008-05-27T11:41:41.969+0000","updated":"2008-05-27T11:41:41.969+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939750","id":"12939750","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=comdivisionys","name":"comdivisionys","key":"comdivisionys","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yves Sandfort","active":true,"timeZone":"Etc/UTC"},"body":"I can only support what Arien said, we moved from 5.0 to 5.1 because of several smaller issues which are fixed, however there is something completly problematic going on...\n\nWe have data collectors for network traffic/disk/cpu usage spread cross the datacenter which will all report into an ActiveMQ instance, each collector has its own queue, so being it approx. 15K queus and on each queue about 3-10 messages per minute coming in. that sounds not much, but in certain scenarios the Apps/DB Server picking up the data is not fast enough to pick them in a timely fashion, so they might queue up for up to 2 days. \n\nWe had issues with 5.0 that it died from time to time (approx. once a week), but with 5.1 it does not even stand for 12 hours. \n\nAs it is run in a VM, we extend the original setup of 1 GB Memory already to 4 GB, but even that didn't help, we always run either out of File Descriptors or out of memory.\n\nThis is really a serious issue, because we need to decide whether we switch back to 5.0 or even back to a BEA or IBM tool, as the instabilities are going on for a few months now...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=comdivisionys","name":"comdivisionys","key":"comdivisionys","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yves Sandfort","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-03T07:21:19.216+0000","updated":"2008-06-03T07:21:19.216+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939764","id":"12939764","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vikdhawan","name":"vikdhawan","key":"vikdhawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"vik dhawan","active":true,"timeZone":"Etc/UTC"},"body":"Guys, \n\ni had the similar issue with 5.0 and 5.0 to resolve the File Descriptors and CLOSE_WAIT sockets. i tuned the JVM parameters and Solaris parmeter. \n\n1. i changed the ulimit -n to 1024 for the separate activemq user account we created to run AMQ. that basically changes the maximum file handles allowed per user. \n\n2. we are using these JVM parameters  -Xmx2048M -XX:SurvivorRatio=4 -XX:+UseParallelGC -Xms2048M -Xss512k. This configuration works and we don't get any out of File Descriptors problem any more. \n\nThere are reasons behind why we chose this route, if you want to know the details let me know. \n\nBTW: Out-of-Memory is because a major bug in AMQ versions related to how they remove the old messages. The Old Gen memory pool keeps on growing because AMQ does not release the memory for the messages when the life cycle is complete for those messages (produced /consumed and removed from the queue). \n\nHope this helps.\n\nThanks!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=vikdhawan","name":"vikdhawan","key":"vikdhawan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"vik dhawan","active":true,"timeZone":"Etc/UTC"},"created":"2008-06-03T14:42:14.198+0000","updated":"2008-06-03T14:42:14.198+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12939872","id":"12939872","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"body":"I figured out why the CLOSE_WAIT's reoccured.\n\nIt is caused by the default memory limit of 5MB per queue, which is configured in the default activemq.xml. As soon as the limit is hit, activemq just has the producers wait untill space frees up.\nBut if there is no consumption, or the consumption isn't fast enough, ActiveMQ will eventually have more producers than available file descriptors. In my case I got 930 CLOSE_WAIT's for 1024 available descriptors in total. I also had 930 stacks ending like this:\n\n - java.lang.Object.wait(long) @bci=0 (Compiled frame; information may be imprecise)\n - org.apache.activemq.usage.MemoryUsage.waitForSpace(long) @bci=44, line=85 (Compiled frame)\n - org.apache.activemq.broker.region.Queue.send(org.apache.activemq.broker.ProducerBrokerExchange, org.apache.activemq.command.Message) @bci=259, line=395 (Interpreted frame)\n - org.apache.activemq.broker.region.AbstractRegion.send(org.apache.activemq.broker.ProducerBrokerExchange, org.apache.activemq.command.Message) @bci=42, line=350 (Compiled frame)\n - org.apache.activemq.broker.region.RegionBroker.send(org.apache.activemq.broker.ProducerBrokerExchange, org.apache.activemq.command.Message) @bci=142, line=437 (Compiled frame)\n\n\nSo each of the 930 threads is waiting for someone to make some room, but since they prevent any other connection from entering the system, the memory will never be freed again. Possibly, even if there is a consumer which picks up consumption after a while, the fact that it ran out of file descriptors might cause it to a unpredictable and dangerous situation.\n\nAfter removing the memory limit for seperate queues, I reran my \"overload producer\" and was able to produce several tens of thousands of messages. But it wasn't really gone after that. Similar behaviour seems to occur as soon as you run out of the systemUsage's memoryUsage and/or when the disk or temporary spaces fill up, even though it by no means had reached the disk limit yet, but possibly the temporary limit.\n\nThe problem here is of course that there might not be a solution to it. But it may help if the logfile gets error messages about hitting memory limits, rather than just leaving the user in the dark?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"created":"2008-06-29T12:11:25.510+0000","updated":"2008-06-29T12:11:25.510+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12940016","id":"12940016","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpoloney","name":"jpoloney","key":"jpoloney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joel Poloney","active":true,"timeZone":"Etc/UTC"},"body":"Arjen,\n\nI have also been experiencing the same problems. I am running a near identical setup to yours with ActiveMQ 5.0.0. I switched to 5.1.0 temporarily, but it had so many more problems, that I had to revert back.\n\nI believe the problem is actually within the Stomp client itself. I've been searching around about the CLOSE_WAIT socket issue (in general) and it appears to be a problem caused by the code, not the server. Basically, some where in your code, the socket never gets closed. It can theoretically remain in a CLOSE_WAIT state forever if this happens.\n\nWe monitor our ActiveMQ sockets every minute (using lsof) and about once every few hours, we see it spike from around 220 open connections to numbers like 7,000 or 8,000. It doesn't build up or anything, just spikes to extremely high numbers.\n\nIn some cases, the queue actually dies (overloaded from too many sockets) and in some cases it actually recovers and flushes everything out. \n\nSo, I think the problem lies somewhere inside the Stomp client rather than in ActiveMQ itself. Have you gotten anywhere else with this lately?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpoloney","name":"jpoloney","key":"jpoloney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joel Poloney","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-31T20:12:43.401+0000","updated":"2008-07-31T20:12:43.401+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12940020","id":"12940020","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"body":"Joel,\n\nThe clients close their connection, as they should. If not, the sockets would not be in 'CLOSE_WAIT' but in some other state (TIME_WAIT?).\n\nSwitching to the 5.2 development build with the non-asynchronously closing sockets works fine once I had removed the limits on memory usage.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=acm","name":"acm","key":"acm","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Arjen","active":true,"timeZone":"Europe/Berlin"},"created":"2008-08-04T11:20:22.485+0000","updated":"2008-08-04T11:20:22.485+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12940027","id":"12940027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpoloney","name":"jpoloney","key":"jpoloney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joel Poloney","active":true,"timeZone":"Etc/UTC"},"body":"Arjen,\n\nI rewrote my activemq.xml from scratch and modified a lot of the memory usage parameters (like you said) and I'm no longer having these issues. \n\nI don't really want to switch to a dev build of 5.2, I'll wait for it come out out officially (unless you strongly feel it's much better :D)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jpoloney","name":"jpoloney","key":"jpoloney","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Joel Poloney","active":true,"timeZone":"Etc/UTC"},"created":"2008-08-04T19:50:51.294+0000","updated":"2008-08-04T19:50:51.294+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12940154","id":"12940154","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Going to mark this issue as resolved","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-02T06:57:35.976+0000","updated":"2008-09-02T06:57:35.976+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482579/comment/12940155","id":"12940155","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linusl","name":"linusl","key":"linusl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Linus Larsen","active":true,"timeZone":"Etc/UTC"},"body":"Calling PHP 'socket_shutdown' and 'socket_close' functions to disconnect rather than using 'fclose' which might leaving linger sockets on the ActiveMQ server. Try an older version of http://stomp.codehaus.org/Stomp+JMS using fclose.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=linusl","name":"linusl","key":"linusl","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Linus Larsen","active":true,"timeZone":"Etc/UTC"},"created":"2008-09-04T18:27:51.895+0000","updated":"2008-09-04T18:27:51.895+0000"}],"maxResults":14,"total":14,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1739/votes","votes":6,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rzmn:"}}