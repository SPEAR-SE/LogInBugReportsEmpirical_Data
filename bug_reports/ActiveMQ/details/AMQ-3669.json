{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12539109","self":"https://issues.apache.org/jira/rest/api/2/issue/12539109","key":"AMQ-3669","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-02-15T09:21:24.925+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed May 23 20:27:50 UTC 2012","customfield_12310420":"224611","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_10752634026_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-05-23T20:27:50.308+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3669/watchers","watchCount":2,"isWatching":false},"created":"2012-01-20T09:37:16.357+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318549","id":"12318549","name":"5.5.1","archived":false,"released":true,"releaseDate":"2011-10-16"}],"issuelinks":[{"id":"12505393","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12505393","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"13076754","key":"AMQ-6695","self":"https://issues.apache.org/jira/rest/api/2/issue/13076754","fields":{"summary":"MirrorQueue - send a copy to the mirror topic instead of original message","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-06-02T09:35:40.255+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We fill a queue that is backed by a qmirror with data (persistent) that exceeds the configured memory limit.\nThe producer (producerFlowControl=\"true\" at queue and qmirror) will be throttled when the the limit is reached, no messages are spooled to disk.\nAs an overall result, we are not able to write a lot of messages into amq.\n\n*Configuration:*\n\n{code:xml} \n\t<destinationInterceptors>\n\t\t<mirroredQueue copyMessage = \"true\" postfix=\".qmirror\" prefix=\"\"/>\n\t</destinationInterceptors>\n\n\t<destinationPolicy>\n\t\t<policyMap>\n\t\t  <policyEntries>\n\t\t\t<policyEntry topic=\">\" producerFlowControl=\"true\" memoryLimit=\"2mb\" />\n\t\t\t<policyEntry queue=\"created.static.for.persistent\" producerFlowControl=\"true\" memoryLimit=\"1mb\" />\n\t\t  </policyEntries>\n\t\t</policyMap>\n\t</destinationPolicy> \n\n\t<destinations>\n\t\t<queue physicalName=\"created.static.for.persistent\" />\n\t</destinations>\n\n\t<persistenceAdapter>\n\t\t<kahaDB directory=\"${activemq.base}/data/kahadb\"/>\n\t</persistenceAdapter>\n\t\n\t<systemUsage>\n\t\t<systemUsage>\n\t\t\t<memoryUsage><memoryUsage limit=\"10 mb\" /></memoryUsage>\n\t\t\t<storeUsage><storeUsage limit=\"100 mb\"/></storeUsage>\n\t\t\t<tempUsage><tempUsage limit=\"100 mb\"/></tempUsage>\n\t\t</systemUsage>\n\t</systemUsage>\n\t\n\t<transportConnectors>\n\t\t<transportConnector name=\"openwire\" uri=\"tcp://0.0.0.0:61616\"/>\n\t</transportConnectors>\n {code}\n\n*Java test code:*\n\n{code} \n    ActiveMQConnectionFactory factory = new ActiveMQConnectionFactory(\"tcp://localhost:61616\");\n    Connection connection = factory.createConnection(\"user\", \"pwd\");\n    connection.start();\n    Session session = connection.createSession(false, Session.CLIENT_ACKNOWLEDGE);\n    Destination destination = session.createQueue(\"created.static.for.persistent\");\n    MessageProducer producer = session.createProducer(destination);\n    producer.setDeliveryMode(DeliveryMode.PERSISTENT);\n    char[] m = new char[1024];\n    Arrays.fill(m, 'x');\n    // create some messages that have 1k each\n    for (int i = 0; i < 12000; i++) {\n      ActiveMQTextMessage message = new ActiveMQTextMessage();\n      message.setText(new String(m));\n      producer.send(message);\n    }\n    connection.stop();\n    connection.close();\n  }\n\n{code} \n\n*Expectation:*\n\nMessages should be written to disk when the memory limit exceeds, all messages should be available within the queue/topic.\n\n*Result:*\n\n INFO | Usage Manager memory limit (2097152) reached for topic://created.static.for.persistent.qmirror. Producers will be throttled to the rate at which messages are removed from this destination to prevent flooding it. See http://activemq.apache.org/producer-flow-control.html for more info\n\nStore percent used  : 10 \nMemory percent used : 20\nTemp percent used   : 0\n\nInteresting: The smaller flow control for the queue (1mb) does not seem to catch but the qmirror does (2mb).\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12528300","id":"12528300","filename":"mirroredqueue.diffs","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ccorsi","name":"ccorsi","key":"ccorsi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Corsi","active":true,"timeZone":"America/Montreal"},"created":"2012-05-20T05:21:20.957+0000","size":8479,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12528300/mirroredqueue.diffs"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59243","customfield_12312823":null,"summary":"Pending producer with qMirror, messages are not spooled to disk","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=darius.schier","name":"darius.schier","key":"darius.schier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=darius.schier&avatarId=12630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=darius.schier&avatarId=12630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=darius.schier&avatarId=12630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=darius.schier&avatarId=12630"},"displayName":"Darius Schier","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=darius.schier","name":"darius.schier","key":"darius.schier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=darius.schier&avatarId=12630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=darius.schier&avatarId=12630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=darius.schier&avatarId=12630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=darius.schier&avatarId=12630"},"displayName":"Darius Schier","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"local test on windows, happens also on linux remotely","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539109/comment/13189863","id":"13189863","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=darius.schier","name":"darius.schier","key":"darius.schier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=darius.schier&avatarId=12630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=darius.schier&avatarId=12630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=darius.schier&avatarId=12630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=darius.schier&avatarId=12630"},"displayName":"Darius Schier","active":true,"timeZone":"Etc/UTC"},"body":"One more information: If we set \n{noformat}<policyEntry topic=\">\" producerFlowControl=\"false\" memoryLimit=\"2mb\" />{noformat}\nwe get \n\nMemory percent used: 100\n\nafter inserting 5111 messages. Console tells\n\n INFO | Started SelectChannelConnector@0.0.0.0:8161\n INFO | Usage Manager Memory Limit (1048576) reached on queue://created.static.for.persistent. Producers will be throttled to the rate at which messages are removed from this destination to prevent flooding it. See http://activemq.apache.org/producer-flow-control.html for more info\n\nAnother indication that no messages are spooled to disk?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=darius.schier","name":"darius.schier","key":"darius.schier","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=darius.schier&avatarId=12630","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=darius.schier&avatarId=12630","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=darius.schier&avatarId=12630","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=darius.schier&avatarId=12630"},"displayName":"Darius Schier","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-20T16:06:48.535+0000","updated":"2012-01-20T16:07:41.959+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539109/comment/13208297","id":"13208297","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pse","name":"pse","key":"pse","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Etc/UTC"},"body":"We ran into a similar problem. Disabling flow control for the mirror topics helped.\n\nI'm still not exactly sure what happens -- AMQ-3671 suggest that the mirrored Messages are cached in the mirrored Topic, even if no subscribers are present. I'm not sure about that, since I did not observe an increase in memomry usage in the same amount as I piped messagues through my mirrored queues. Anyway, it DOES seem like a bug to me that flow control is applied in this case.\n\n{code}\n  <destinationPolicy>\n    <policyMap>\n      <policyEntries>\n        ...\n        <policyEntry topic=\"*.qmirror\" producerFlowControl=\"false\"/>\n      </policyEntries>\n    </policyMap>\n  </destinationPolicy>\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pse","name":"pse","key":"pse","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Peter Eisenlohr","active":true,"timeZone":"Etc/UTC"},"created":"2012-02-15T09:21:24.925+0000","updated":"2012-02-15T09:21:24.925+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539109/comment/13279665","id":"13279665","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ccorsi","name":"ccorsi","key":"ccorsi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Corsi","active":true,"timeZone":"America/Montreal"},"body":"I was able to determine what the problem was with this issue.\n\nIt is that when we initially forward the message to the mirrored topic.  The message memory usage instance is set to the topic.\n\nWhen the message is sent to the queue, the memory usage instance is not set to the queue memory usage but it still uses the topic memory usage.\n\nThe message setRegionDestination method is used to set the message memory usage but this is only performed if and only if the current message memory usage instance is null.  This is not the case when forwarding the message to the queue and that is why the memory usage of the topic gets affected causing the producer flow control to throttle the topic/queue when that is not the case.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ccorsi","name":"ccorsi","key":"ccorsi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Corsi","active":true,"timeZone":"America/Montreal"},"created":"2012-05-20T05:19:49.653+0000","updated":"2012-05-20T05:19:49.653+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539109/comment/13279666","id":"13279666","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ccorsi","name":"ccorsi","key":"ccorsi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Corsi","active":true,"timeZone":"America/Montreal"},"body":"This patch contains a test and the fix to this issue.\n\nbtw, this patch was applied against trunk and I have not tried to apply this on an earlier version.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=ccorsi","name":"ccorsi","key":"ccorsi","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Claudio Corsi","active":true,"timeZone":"America/Montreal"},"created":"2012-05-20T05:21:21.066+0000","updated":"2012-05-20T05:22:20.008+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12539109/comment/13281879","id":"13281879","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Patch applied with thanks. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-05-23T20:27:50.349+0000","updated":"2012-05-23T20:27:50.349+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3669/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0aibz:"}}