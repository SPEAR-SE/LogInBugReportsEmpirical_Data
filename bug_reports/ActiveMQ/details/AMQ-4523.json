{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12646604","self":"https://issues.apache.org/jira/rest/api/2/issue/12646604","key":"AMQ-4523","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2013-05-08T13:14:35.227+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu May 09 01:20:52 UTC 2013","customfield_12310420":"326962","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_5908928_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-05-08T13:41:37.624+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4523/watchers","watchCount":3,"isWatching":false},"created":"2013-05-08T12:03:08.720+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-05-09T01:20:52.707+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12315705","id":"12315705","name":"activemq-camel","description":"camel activemq component"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"With camel route, forward messages from a topic to a queue.\nJust start a topic producer, such as:\n{code}\nant -Durl=tcp://ip:port  -Dtopic=true -Dsubject=test_topic -Ddurable=true -Dmax=10000 -DmessageSize=100 -DparallelThread=10 -Dverbose=false producer\n{code}\nAfter a while, in web console: /admin/subscribers.jsp ,can see \"Pending Queue Size\" not 0. \nThen stop the topic producer, will found that the \"Pending Queue Size\" still not 0!\nSome messages lost, pending in the durable subscriber.\nNo matter restart the activemq server, or consume all the messages from the queue, can not get \"The Pending Queue Messages'.\ncamel.xml:\n{code}\n<beans\n   xmlns=\"http://www.springframework.org/schema/beans\"  \n   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n   xsi:schemaLocation=\"\n     http://camel.apache.org/schema/spring http://camel.apache.org/schema/spring/camel-spring.xsd\n     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd\">\n  \n    <camelContext id=\"camel\" xmlns=\"http://camel.apache.org/schema/spring\">\n\n        <!-- You can use Spring XML syntax to define the routes here using the <route> element -->\n        <route id=\"testRoute\">\n            <description>test Route</description>\n            <from uri=\"jms1:topic:test_topic?clientId=1&amp;durableSubscriptionName=bar1\"/>\n            <to uri=\"jms1:queue:test_queue\"/>\n        </route>\n\n    </camelContext>\n\n\t<bean id=\"jms1\" class=\"org.apache.camel.component.jms.JmsComponent\">\n\t  <property name=\"configuration\" ref=\"jmsConfig1\" />\n\t</bean>\n\t\t      \n\t<bean id=\"jmsConfig1\" class=\"org.apache.camel.component.jms.JmsConfiguration\" >\n\t  <property name=\"connectionFactory\" ref=\"jmsPooledConnectionFactory1\" />\n\t  <property name=\"transacted\" value=\"true\" />\n\t  <property name=\"transactionManager\" ref=\"jmsTransactionManager1\" />\n\t  <property name=\"cacheLevelName\" value=\"CACHE_CONNECTION\" />\n\t  <property name=\"cacheLevel\" value=\"1\" />\n\t</bean>\n\t<bean id=\"jmsTransactionManager1\" class=\"org.springframework.jms.connection.JmsTransactionManager\">\n\t  <property name=\"connectionFactory\" ref=\"jmsPooledConnectionFactory1\" />\n\t </bean>        \n\t<bean id=\"jmsPooledConnectionFactory1\" class=\"org.apache.activemq.pool.PooledConnectionFactory\"\n\t      init-method=\"start\" destroy-method=\"stop\" >\n\t  <property name=\"maxConnections\" value=\"1\" />\n\t  <property name=\"connectionFactory\" ref=\"jmsConnectionFactory1\" />\n\t</bean>\n\t<bean id=\"jmsConnectionFactory1\" class=\"org.apache.activemq.ActiveMQConnectionFactory\">\n\t  <property name=\"brokerURL\" value=\"vm://localhost?create=false&amp;jms.prefetchPolicy.all=1\" />\n\t  <property name=\"watchTopicAdvisories\" value=\"false\" />\n\t</bean>\n\n</beans>\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"327306","customfield_12312823":null,"summary":"The durable subscriber will lose some pending queue message ","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hengyunabc","name":"hengyunabc","key":"hengyunabc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"hengyunabc","active":true,"timeZone":"Asia/Shanghai"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hengyunabc","name":"hengyunabc","key":"hengyunabc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"hengyunabc","active":true,"timeZone":"Asia/Shanghai"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12646604/comment/13651870","id":"13651870","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"This is a expected behavior.\nSince Topic will not save persistent messages before durable subscriber registers.\nIn other words, when there are no durable subscribers on Topic persistent messages will be discarded or only dispatched to the non-durable subscribers.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-05-08T13:14:35.227+0000","updated":"2013-05-08T13:14:35.227+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12646604/comment/13651893","id":"13651893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"As far as I can tell this is working as expected.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-05-08T13:41:37.642+0000","updated":"2013-05-08T13:41:37.642+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12646604/comment/13652019","id":"13652019","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hengyunabc","name":"hengyunabc","key":"hengyunabc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"hengyunabc","active":true,"timeZone":"Asia/Shanghai"},"body":"Maybe I did not show the problem clear.\nI know that topic will not save persistent messages before durable subscriber registers.\n1. I register a durable subscriber(\"bar1\") on the topic(,\n2. Send 1000 persistent messages to the topic(\"test_topic\"),\n3. Use camel route to transport message from \"bar1\" to a queue(\"test_queue\")\n\nThe result:\nThe topic \"test_topic\" :\nMessages Enqueued : 1000\n\nThe durable subscriber \"bar1\" :\nPending Queue Size : 7\nEnqueue Counter : 1000\nDequeue Counter : 993\n\nThe queue \"test_queue\":\nNumber Of Pending Messages : 993\n\nThe 7 messages lost, they will alaways \"pending in the durable subscriber\". \nThere are no way to get them, although they are still in the kahadb data files.(db-1.log)\n\nI have try these ways:\n1. restart the activemq server, the camel route working , but the pending message still pending in \"bar1\".\n2. stop the camel route. start a client with clientID:1, name:\"bar1\", to get message from the durable subscriber \"bar1\". It do not work, get nothing.\n\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hengyunabc","name":"hengyunabc","key":"hengyunabc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"hengyunabc","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-05-08T16:11:06.242+0000","updated":"2013-05-08T16:11:06.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12646604/comment/13652046","id":"13652046","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hengyunabc","name":"hengyunabc","key":"hengyunabc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"hengyunabc","active":true,"timeZone":"Asia/Shanghai"},"body":"I uploaded the data files here:\nhttp://activemq.2283324.n4.nabble.com/The-durable-subscriber-will-lose-some-pending-queue-message-td4666780.html\n\nI think that maybe this issue relate to AMQ-4413.\nBeacuse I found the in ActiveMQ5.8, the TransactionManager will active/offline the durable subscriber very frequently. Just with jconsole watch the consumer of a topic, it alaways changeing.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=hengyunabc","name":"hengyunabc","key":"hengyunabc","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"hengyunabc","active":true,"timeZone":"Asia/Shanghai"},"created":"2013-05-08T16:44:27.657+0000","updated":"2013-05-08T16:44:27.657+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12646604/comment/13652634","id":"13652634","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"Well, to be honest,I faced the same issue(durable subscriber lose messages) when I switched a virtual topic to be the real topic in production.\nI had no time to reproduce and investigate the problem and eventually rolled back the upgrade.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2013-05-09T01:20:52.707+0000","updated":"2013-05-09T01:20:52.707+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4523/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1kenb:"}}