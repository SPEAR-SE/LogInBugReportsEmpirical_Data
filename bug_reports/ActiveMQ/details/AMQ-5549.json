{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12770925","self":"https://issues.apache.org/jira/rest/api/2/issue/12770925","key":"AMQ-5549","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329258","id":"12329258","name":"5.12.0","archived":false,"released":true,"releaseDate":"2015-08-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-01-29T13:56:58.485+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 03 11:47:16 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_13408420016_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-07-03T11:47:16.858+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5549/watchers","watchCount":7,"isWatching":false},"created":"2015-01-29T07:13:36.883+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326456","id":"12326456","name":"5.10.1","archived":false,"released":true,"releaseDate":"2015-01-20"}],"issuelinks":[{"id":"12407432","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12407432","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12772996","key":"AMQ-5568","self":"https://issues.apache.org/jira/rest/api/2/issue/12772996","fields":{"summary":"Deleting lock file on broker shut down can take a master broker down","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12429626","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12429626","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"outwardIssue":{"id":"12666328","key":"AMQ-4705","self":"https://issues.apache.org/jira/rest/api/2/issue/12666328","fields":{"summary":"Add keep alive support to shared file locker","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-07-03T11:48:17.138+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Identical ActiveMQ master and slave brokers are installed on CentOS Linux 6 virtual machines. There is a third virtual machine (also CentOS 6) providing an NFSv4 share for the brokers KahaDB.\n\nBoth brokers are started and the master broker acquires file lock on the lock file and the slave broker sits in a loop and waits for a lock as expected. Also changing brokers work as expected.\n\nOnce the network connection of the NFS server is disconnected both master and slave NFS mounts block and slave broker stops logging file lock re-tries. After a short while after bringing the network connection back the mounts come back and the slave broker is able to acquire the lock simultaneously. Both brokers accept client connections.\n\nIn this situation it is also possible to stop and start both individual brokers many times and they are always able to acquire the lock even if the other one is already running. Only after stopping both brokers and starting them again is the situation back to normal.\n\n* NFS server:\n** CentOS Linux 6\n** NFS v4 export options: rw,sync\n** NFS v4 grace time 45 seconds\n** NFS v4 lease time 10 seconds\n\n* NFS client:\n** CentOS Linux 6\n** NFS mount options: nfsvers=4,proto=tcp,hard,wsize=65536,rsize=65536\n\n* ActiveMQ configuration (otherwise default):\n\n{code:xml}\n        <persistenceAdapter>\n            <kahaDB directory=\"${activemq.data}/kahadb\">\n              <locker>\n                <shared-file-locker lockAcquireSleepInterval=\"1000\"/>\n              </locker>\n            </kahaDB>\n        </persistenceAdapter>\n{code}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Shared Filesystem Master/Slave using NFSv4 allows both brokers become active at the same time","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"- CentOS Linux 6\n- OpenJDK 1.7\n- ActiveMQ 5.10.1","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14296517","id":"14296517","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"body":"This seems to be related: https://issues.apache.org/jira/browse/AMQ-4705\n\nTested with the following configurations:\n\n- Grace Time 45s, Lease Time 10s\n- lockKeepAlivePeriod=15000\n- lockAcquireSleepInterval=5000\n\n- Grace Time 45s, Lease Time 10s\n- lockKeepAlivePeriod=15000\n- lockAcquireSleepInterval=5000\n\n- Grace Time 60s, Lease Time 30s\n- lockKeepAlivePeriod=15000\n- lockAcquireSleepInterval=5000\n\n- Grace Time 60s, Lease Time 30s\n- lockKeepAlivePeriod=5000\n- lockAcquireSleepInterval=15000\n\nAll tests came out with the same results as the original.\n\nConfiguration:\n\n{code:xml}\n        <persistenceAdapter>\n            <kahaDB directory=\"${activemq.data}/kahadb\" lockKeepAlivePeriod=\"15000\">\n              <locker>\n                <shared-file-locker lockAcquireSleepInterval=\"5000\"/>\n              </locker>\n            </kahaDB>\n        </persistenceAdapter>\n{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"created":"2015-01-29T07:33:26.971+0000","updated":"2015-01-29T09:24:29.220+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14296709","id":"14296709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"body":"The following combination seems to work IF the network outage between the NFS client(s) and the NFS server is short (a couple of seconds):\n\n* Grace Time 90s, Lease Time 60s\n* lockKeepAlivePeriod=5000\n* lockAcquireSleepInterval=15000\n\nIn this case the master broker is able to renew the lock and continue operating and the slave broker fails to get the lock.\n\nHowever if the network outage is significantly longer (tested with various durations between 30 and 300 seconds), both brokers are able to get lock on the file and start working simutaneously. Even though the master brokers dmesg shows the following message after the outage:\n\n\"NFS: nfs4_reclaim_open_state: Lock reclaim failed!\"\n\nIt seems that this happens if the lock reclaiming (keepAlive?) operation on the master broker gets blocked for long enough time for the NFS server lease timeout to pass. In this case the slave is able to claim the lock (if it's NFS filesystem stops blocking earlier) and after the master stops blocking it continues to operate even though NFS client reports \"Lock reclaim failed!\".\n\nSeems also that the time it takes for the individual NFS client to recover from blocking I/O varies between clients.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"created":"2015-01-29T11:19:23.904+0000","updated":"2015-01-29T12:30:17.839+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14296863","id":"14296863","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"body":"Hi, the config\n\n{code:xml}\n<kahaDB directory=\"${activemq.data}/kahadb\" lockKeepAlivePeriod=\"15000\">\n  <locker>\n    <shared-file-locker lockAcquireSleepInterval=\"5000\"/>\n  </locker>\n</kahaDB>\n{code}\nhas an error. lockKeepAlivePeriod should be much lower than lockAcquireSleepInterval (at max half of lockAcquireSleepInterval, perhaps even below that).\n\n{code:xml}\n<levelDB directory=\"/nfs-import/leveldb\" lockKeepAlivePeriod=\"5000\">\n  <locker>\n    <shared-file-locker lockAcquireSleepInterval=\"10000\"/>\n  </locker>\n</levelDB>\n{code}\n\nYou also want to explicitly configure for restartAllowed=\"false\" on the broker config.\n\nFinally, what are your mount options? We have learned the mount options used play a significant role.\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-29T13:56:58.485+0000","updated":"2015-01-29T14:42:11.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14297151","id":"14297151","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"body":"Hi, thanks for the comments.\n\nIn later testing, different configurations were tested and finally the settings were:\n\n{code:xml}\n<kahaDB directory=\"${activemq.data}/kahadb\" lockKeepAlivePeriod=\"5000\">\n  <locker>\n    <shared-file-locker lockAcquireSleepInterval=\"15000\"/>\n  </locker>\n</kahaDB>\n{code}\n\nas mentioned in the last comment. This setup combined with NFSv4 lease timeout of 60 seconds yielded the best results although still failing when the network outage was long enough for the NFS filesystem to block for a long time (even after the connection was restored).\n\nMount options are there in the issue description but I re-visited them for further testing and finally used these (trying to increase the timeout value to maximum):\n\nrw,nfsvers=4,proto=tcp,timeo=6000,retrans=3,hard,wsize=65536,rsize=65536\n\nAlthough this didn't make much difference compared to the default timeout of 600 deciseconds.\n\nI will give restartAllowed a try.\n\nFurthermore I tested the exact same setup with a NetApp filer NFSv4 server with the exact same settings and brokers behaved as they should have. Master was able to continue operating and slave did not get the lock after 5, 30, 45 or 180 second outages.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"created":"2015-01-29T17:15:15.848+0000","updated":"2015-01-29T17:16:51.635+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14298361","id":"14298361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"body":"Some of the NFS mount options may not support a quick broker failover from master to slave. \nThe options we finally got best results with where\n\n{code}\ntimeo=100,retrans=1,soft,noac\n{code}\n\nWe reduced the timeout to 10 seconds and also reduced the retry to just 1. \nIn addition a hard mount seems to retry NFS operations forever (according to man page) and using soft operations will fail after retrans transmission attempts. Most likely what you want to ensure a quick failover.\nAnd finally the noac option seemed to had a big effect as well on the speed at which the master broker detects the NFS failure as it also caused a sync write to NFS, which seems to propagate exceptions more quickly. It most likely has a negative impact on performance though.\n\nI can't provide a scientific support for these arguments other than above but with these settings the master broker would should down much quicker upon an NFS failure. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-30T08:27:34.392+0000","updated":"2015-01-30T08:29:21.011+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14298410","id":"14298410","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"body":"I'm a bit hesitant on using soft mounts unless ActiveMQ explicitly requires them. NetApp and others always advice against using soft mounts with NFSv4. Problem we're having is not with the broker failover but with what happens if the shared storage fails (both brokers lose the connection) and how the brokers recover from it after the NFSv4 lock lease has expired.\n\nHave you tested your setup with failing the NFS server connection or killing the server ungracefully? For me soft mounts only made the situation worse (which kind of makes sense).\n\nHere's some other issues around the subject (for those with RHN access):\n\nhttps://access.redhat.com/solutions/1195703\nhttps://access.redhat.com/solutions/478053\nhttps://access.redhat.com/solutions/382283\n\nhttps://issues.jboss.org/browse/ENTMQ-391","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"created":"2015-01-30T09:34:07.416+0000","updated":"2015-01-30T09:36:17.992+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14298603","id":"14298603","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"body":"I am not suggesting ActiveMQ requires a soft NFS mount. Just noticed we got NFS errors propagated much quicker using soft mounts. \n\nYes, the fix for ENTMQ-391 will be needed and its contained in 5.9.0. See AMQ-4705.\n\nIn my tests I shut down the nic of the nfs client machine that runs the broker and tested how quickly this resulted in an error on the master broker and how quickly a slave broker running on a different machine takes over. \n\nWith the NFS options \n\n{code}\ntimeo=50,retrans=1,soft,noac\n{code}\n\nand the previously suggested broker configuration the master broker would raise an exception within 15 secs after loosing access to the NFS share and would shutdown within another 1-2 minutes. During the shutdown the broker tries to close all file pointing to the persistence store and that close() call hangs too and needs to timeout as well.\nIt took about 60 - 80 seconds for the slave broker to take over. \n\nPreviously testing with default NFS mount options the master broker would some times not shut down within 10+ minutes. \n\nI took various thread dumps along the way and the broker was always hung in a Java I/O operation that took a long time to finally raise an exception. \nWas able to reproduce the same behavior using a very simple Java application that only tries the same Java I/O. So IMHO the entire issue is really down to configuring NFS in a way that it quickly raises errors to the application stack.\n \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-30T13:07:38.381+0000","updated":"2015-01-30T13:07:38.381+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14298610","id":"14298610","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"body":"Yes that is the case when you break the connection between one of the brokers and the NFS storage. What I'm after and testing is the situation when you break the connection to the NFS storage altogether so that _both_ brokers lose the connectivity simultaneously and what happens _after_ the connection to the NFS share comes back. This is when both brokers are able to grab the lock.\n\nMaybe I wasn't clear enough in the original issue description but this is about NFS server failures (crash, network outage, ungraceful shutdown, ...) affecting all the NFS clients.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=heikki_m","name":"heikki_m","key":"heikki_m","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Heikki Manninen","active":true,"timeZone":"Europe/Helsinki"},"created":"2015-01-30T13:19:02.173+0000","updated":"2015-01-30T13:19:02.173+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14298725","id":"14298725","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sburkard","name":"sburkard","key":"sburkard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Burkard","active":true,"timeZone":"Etc/UTC"},"body":"Hi \n\nThe two cases are different, but I'm not sure if this makes a difference. \n\nWhen, for whatever reason, the shared storage lock is released by the shared storage provider (after the grace period), the slave can grab the lock, becomes master and works as expected. This works fine in all cases I have seen.\n\nThe key question is how the former master behaves. In all descriptions about two active master brokers, the problem arises because the former master continues to do so. So the real problem is that the master does not recognize that he has lost the lock. This can happen in all shared storage configurations. \n\nJean-Baptiste Onofré describes the same problem with a shared JDBC datastore here: http://blog.nanthrax.net/2013/10/apache-activemq-5-7-5-9-and-master-slave. \n\nIn my tests with shared LevelDB-Store over NFS4 and hard mounts, the former master broker NEVER realized that another broker has taken the lock. With a soft mount it was realizing the new situation after a massive delay (about 5 minutes). With the NFS options Torsten mentioned the master broker realizes the new situation after 15 to 30 seconds. I am not saying that these settings are save for production, I just observed that changes to NFS settings lead to completely different results. \n\nSo my guess is that the whole problem is just a matter of NFS settings. But this part is never mentioned in example setups etc. Is anybody out there who has a working and tested shared-filesystem architecture with NFS? It would be very helpful to have a \"reference configuration\" that works. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sburkard","name":"sburkard","key":"sburkard","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan Burkard","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-30T15:06:00.367+0000","updated":"2015-01-30T15:06:00.367+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14298738","id":"14298738","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"body":"{quote}\nMaybe I wasn't clear enough in the original issue description but this is about NFS server failures (crash, network outage, ungraceful shutdown, ...) affecting all the NFS clients.\n{quote}\nGot you. Have not tested that. With restartAllowed=false the master should shut down at the least and stop its transport connectors.\n\nAlso did some more reading on sync mount option. It is discouraged in some posts but I would hope that by also using noac or sync mount option, it should be okay as writes are sync now. So data should not get corrupted. This however comes at the expense of a performance degradation.\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-30T15:16:19.620+0000","updated":"2015-01-30T15:16:19.620+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14299692","id":"14299692","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"One thing to make clear here (it seemed unclear from the title and original bug description).  There's a choice that must be made here - either allow for the possibility of neither broker being active (NFS v3 approach) or allow for the possibility of both being active (NFS v4) -- for some period of time.\n\nIt will be possible to reduce the amount of time the two brokers in an H/A pair are simultaneously active through NFS options - if the broker can detect the condition.  But it's not possible to eliminate the possibility of both being active for some time with NFS v4.\n\nWith that said, if the original active broker does not stop once it realizes that it lost the lock, or it cannot reliably detect a lost lock, a fix is welcome.  Just be aware that even with such a fix, there's a possibility of corruption to the KahaDB.  Documentation of various NFS settings and their outcomes would also be welcome.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2015-01-31T06:31:21.861+0000","updated":"2015-01-31T06:31:21.861+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14309119","id":"14309119","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"body":"Also see AMQ-5568.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tmielke","name":"tmielke","key":"tmielke","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Torsten Mielke","active":true,"timeZone":"Europe/Berlin"},"created":"2015-02-06T13:32:53.004+0000","updated":"2015-02-06T13:32:53.004+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770925/comment/14613142","id":"14613142","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The window if closed via https://git1-us-west.apache.org/repos/asf?p=activemq.git;a=commit;h=9bc602be\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-07-03T11:47:16.884+0000","updated":"2015-07-03T11:47:16.884+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5549/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i24xun:"}}