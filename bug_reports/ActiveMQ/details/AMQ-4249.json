{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12627290","self":"https://issues.apache.org/jira/rest/api/2/issue/12627290","key":"AMQ-4249","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-01-14T15:54:18.994+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jan 14 21:52:14 UTC 2013","customfield_12310420":"304061","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_248433777_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-01-14T21:52:14.657+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4249/watchers","watchCount":3,"isWatching":false},"created":"2013-01-12T00:51:40.934+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":["Authentication","JAAS","Security"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318549","id":"12318549","name":"5.5.1","archived":false,"released":true,"releaseDate":"2011-10-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-01-14T21:52:14.695+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"h1. Problem\n\nWhile setting up a connection pool towards ActiveMq 5.5.1 using Bitronix 2.1.3 I've been having some issues related to authentication and authorization of the JMS connections.\n\nWhen doing a clean restart of the JMS-clients JVM the connection pool has been unable to connect successfully with one or more of the 14 connections it's been set up to use.\n\nThe error messages I've been getting has usually been one of the following two:\n\n# User system is not authorized to read from: ActiveMQ.Advisory.TempQueue,ActiveMQ.Advisory.TempTopic\n# User name or password is invalid.\n\nThe broker has been set up using a very simplistic configuration:\n{code:xml}\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<beans xmlns=\"http://www.springframework.org/schema/beans\"\n\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:context=\"http://www.springframework.org/schema/context\"\n\n\txsi:schemaLocation=\"http://activemq.apache.org/schema/core http://activemq.apache.org/schema/core/activemq-core-5.5.0.xsd\n\t\thttp://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd\n\t\thttp://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd\">\n\t<context:property-placeholder />\n\n\t<broker brokerId=\"localhost\" xmlns=\"http://activemq.apache.org/schema/core\"\n\t\tdataDirectory=\"${datadir}\" start=\"false\">\n\t\t<managementContext>\n\t\t\t<managementContext connectorHost=\"0.0.0.0\"\n\t\t\t\tconnectorPort=\"14522\" createConnector=\"true\" />\n\t\t</managementContext>\n\t\t<plugins>\n\t\t\t<jaasAuthenticationPlugin configuration=\"activemq-domain\"\n\t\t\t\tdiscoverLoginConfig=\"true\" />\n\t\t\t<authorizationPlugin>\n\t\t\t\t<map>\n\t\t\t\t\t<authorizationMap>\n\t\t\t\t\t\t<authorizationEntries>\n\t\t\t\t\t\t\t<authorizationEntry queue=\">\" read=\"admins\"\n\t\t\t\t\t\t\t\twrite=\"admins\" admin=\"admins\" />\n\n\t\t\t\t\t\t\t<authorizationEntry topic=\">\" read=\"admins\"\n\t\t\t\t\t\t\t\twrite=\"admins\" admin=\"admins\" />\n\n\t\t\t\t\t\t\t<authorizationEntry topic=\"ActiveMQ.Advisory.>\"\n\t\t\t\t\t\t\t\tread=\"guests,users\" write=\"guests,users\" admin=\"guests,users\" />\n\t\t\t\t\t\t</authorizationEntries>\n\t\t\t\t\t</authorizationMap>\n\t\t\t\t</map>\n\t\t\t</authorizationPlugin>\n\t\t</plugins>\n\t\t<transportConnectors>\n\t\t\t<transportConnector id=\"openwire\" uri=\"tcp://0.0.0.0:61616?trace=true\" />\n\t\t</transportConnectors>\n\t</broker>\n</beans>\n{code}\n\nThe JAAS-configuration has been verified to match username and password used by the client when connecting (username = system):\n\nh4. login.config\n\n{code}\nactivemq-domain {\n    org.apache.activemq.jaas.PropertiesLoginModule required\n        debug=false\n        org.apache.activemq.jaas.properties.user=\"users.properties\"\n        org.apache.activemq.jaas.properties.group=\"groups.properties\";\n};\n{code}\n\nh4.users.properties\n\n{code}\nsystem=manager\nuser=password\nguest=password\n{code}\n\nh4. groups.properties\n{code}\nadmins=system\nusers=user\nguests=guest\n{code}\n\nh1. Cause\n\nAfter debugging the problem it seems as if the problem is caused by a race condition introduced in PropertiesLoginModule in revision [1086219|https://fisheye6.atlassian.com/changelog/activemq?showid=1086219] (AMQ-3244). When the reload-support was added the users- and groups-fields were changed into static fields. But no additional synchronization was introduced, thereby introducing a race condition when several threads are entering the initialize- and commit-methods are the same time.\n\nThe following section of the initialize-method in PropertiesLoginModule contains the first part of the race condition. Please note the unsynchronized modification of both the users- and groups static fields:\n\n{code:java}\n        if (reload || users == null || uf.lastModified() > usersReloadTime) {\n            if (debug) {\n                LOG.debug(\"Reloading users from \" + uf.getAbsolutePath());\n            }\n            try {\n                users = new Properties(); // XXX Here be dragons\n                java.io.FileInputStream in = new java.io.FileInputStream(uf);\n                users.load(in);\n                in.close();\n                usersReloadTime = System.currentTimeMillis();\n            } catch (IOException ioe) {\n                LOG.warn(\"Unable to load user properties file \" + uf);\n            }\n        }\n\n        groupsFile = (String) options.get(GROUP_FILE) + \"\";\n        File gf = baseDir != null ? new File(baseDir, groupsFile) : new File(groupsFile);\n        if (reload || groups == null || gf.lastModified() > groupsReloadTime) {\n            if (debug) {\n                LOG.debug(\"Reloading groups from \" + gf.getAbsolutePath());\n            }\n            try {\n                groups = new Properties(); // XXX Here be dragons\n                java.io.FileInputStream in = new java.io.FileInputStream(gf);\n                groups.load(in);\n                in.close();\n                groupsReloadTime = System.currentTimeMillis();\n            } catch (IOException ioe) {\n                LOG.warn(\"Unable to load group properties file \" + gf);\n            }\n        }\n{code}\n\nThe next part comes in the login-method when the users password is retrieved:\n\n{code:java}\n        String password = users.getProperty(user); \n{code}\n\nThe final part of the puzzle occurs in the commit-method:\n{code:java}\n            for (Enumeration<?> enumeration = groups.keys(); enumeration.hasMoreElements();) {\n                String name = (String)enumeration.nextElement();\n                String[] userList = ((String)groups.getProperty(name) + \"\").split(\",\");\n                for (int i = 0; i < userList.length; i++) {\n                    if (user.equals(userList[i])) {\n                        principals.add(new GroupPrincipal(name));\n                        break;\n                    }\n                }\n            }\n{code}\n\nThe retrieval of the user password will fail if invoked by a thread immediately after a different thread has assigned an empty Properties-object to the users field in the initialize-method.\n\nSimilarly population of the GroupPrincipals into the Subject in the commit-method will silently fail if executed by a thread immediately after a different thread has assigned an empty Properties-object to the groups-field in the initialize-method.\n\nh1. Proposed solution\n\nI've created a testcase that reproduces the problem and an additional patch that introduces a wrapper around the Properties-objects for the users- and groups-fields.\n\nThe testcase and the proposed solution is available via https://github.com/lothor/activemq.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12564744","id":"12564744","filename":"AMQ-4249-proposed-fix.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-14T18:01:53.896+0000","size":6676,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12564744/AMQ-4249-proposed-fix.diff"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12564743","id":"12564743","filename":"AMQ-4249-testcase.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-14T18:01:53.892+0000","size":7350,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12564743/AMQ-4249-testcase.diff"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"251872","customfield_12312823":null,"summary":"Race condition in PropertiesLoginModule","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"ActiveMQ 5.5.1 with JAAS authentication via PropertiesLoginModule configured, Spring JMS 3.0.5, 64-bit, Intel quad core CPU (i7 950), Windows 7\n","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12627290/comment/13551713","id":"13551713","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"body":"I've verified that the problem seems to be present both in 5.5.1 and the current trunk (5.8-SNAPSHOT). Based on the SVN history I'm fairly certain it's present in 5.6 and 5.7 as well.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-12T01:00:00.407+0000","updated":"2013-01-12T01:00:00.407+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12627290/comment/13551896","id":"13551896","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"body":"Simplified the proposed solution a bit by removing the read-write lock and readded the reloadtime-check that was missing in the last changeset.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-12T12:16:43.152+0000","updated":"2013-01-12T12:16:43.152+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12627290/comment/13552813","id":"13552813","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"You should create and attach patch files for your test case and proposed fix for review. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-01-14T15:54:18.994+0000","updated":"2013-01-14T15:54:18.994+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12627290/comment/13552934","id":"13552934","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"body":"Coming right up. I've attached two patches, one containing the testcase and one containing the proposed fix.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lothor","name":"lothor","key":"lothor","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tarjei Skorgenes","active":true,"timeZone":"Europe/Berlin"},"created":"2013-01-14T18:01:53.900+0000","updated":"2013-01-14T18:01:53.900+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12627290/comment/13553168","id":"13553168","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Nice investigation, patch applied to trunk.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-01-14T21:52:14.682+0000","updated":"2013-01-14T21:52:14.682+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4249/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i17hx3:"}}