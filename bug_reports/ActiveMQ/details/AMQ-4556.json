{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12649475","self":"https://issues.apache.org/jira/rest/api/2/issue/12649475","key":"AMQ-4556","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315630","id":"12315630","description":"Issues that need to be reviewed - do we keep 'em or do we kick 'em? ","name":"NEEDS_REVIEW","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-01-11T03:04:42.860+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jan 16 16:16:01 UTC 2014","customfield_12310420":"329802","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4556/watchers","watchCount":5,"isWatching":false},"created":"2013-05-26T14:06:00.518+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[{"id":"12369498","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12369498","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"outwardIssue":{"id":"12483280","key":"AMQ-2009","self":"https://issues.apache.org/jira/rest/api/2/issue/12483280","fields":{"summary":"Problem with message dispatch after a while","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/4","description":"This issue was once resolved, but the resolution was deemed incorrect. From here issues are either marked assigned or resolved.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/reopened.png","name":"Reopened","id":"4","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-12-07T20:10:16.177+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"This issue seems to relate to AMQ-2009 and the referenced articles there.\n\nh3. The issue:\nAfter a give period of time, the broker seems to \"forget\" about received messages on a queue.\nReceiving of new messages and delivering them is unaffected. Just some are lost in the store.\nChecking the DB tables, the missing messages do exists there.\nActiveMQ statistics counters are also aware of them and count those messages as \"pending\" in the ActiveMQ console (first colummn). But open the details of a queue in ActiveMQ console do not show them at all.\n\nh3. Analysis so far\nWe tried several settings for the queues which had no impact on the issue:\n* Activating/Deactivating useCache\n* Setting different prefetch values from 0, 1, 100 (at least 1 seems to relax the issue a little bit)\n* KahaDB and JDBC persistent (Oracle and MSSQL(jTDS)) are affected\n\nAlso some characteristics about affected/not affected queues might help to analyse this further:\n* We have one queue with just one producer and many consumers whereas the message is quite small (just headers): No problem on that queue even after thousend of messages\n* Queues with multiple producers and consumers and payloaded text-messages seem to be unaffected - Maybe the JDBC persistent store trottels the processing enough to \"solve\" the issue\n* Queues with multiple producers and consumers and small messages (just headers) seem to \"enable\" the issue. Even with few messages the issue appears\n\nh3. \"Recovering\" lost messages\nShutdown the (master) broker and restart it. With failover transport this happens transparent for the clients.\nOn master startup, all messages from the store (DB) are scanned and \"rediscovered\"\n\nh3. Workaround\nUse another cursor - VM seems to be fine. Additional settings might be required to handle shotcommings of the VM cursor (max memory, queue memory etc.)\n{code:xml}\n                <policyEntry queue=\">\" ...>\n                  <pendingQueuePolicy>\n                    <vmQueueCursor/>\n                  </pendingQueuePolicy>\n                </policyEntry>\n{code}\n\nh3. Test code\nI was not able to create a self-contained unit test.\nBut the attached code can be used to reproduce the issue quite reliable.\nIt sends 3000 messages. WIth the following settings it will fail/will work correctly:\n|| Message Size || ActiveMQ cursor || Result ||\n| 1 MB (leave line 20 as it is) | vmQueueCursor | (/) - All messages delivered|\n| 1 MB (leave line 20 as it is) | store based Cursor| (/) - All messages delivered|\n| remove comment from line 20 | vmQueueCursor| (/) - All messages delivered|\n| remove comment from line 20 | store based Cursor| (x) - Some (~0,5% messages lost)|\n\nFor completness also the used activemq-broker.xml was attached - This is the default one with the JDBC persistent store added.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12584870","id":"12584870","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cs.fra.community%40sungard.com","name":"cs.fra.community@sungard.com","key":"cs.fra.community@sungard.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"SunGard Global Services Germany","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-26T14:07:21.645+0000","size":7290,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12584870/activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12584869","id":"12584869","filename":"ActiveMQClient.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cs.fra.community%40sungard.com","name":"cs.fra.community@sungard.com","key":"cs.fra.community@sungard.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"SunGard Global Services Germany","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-26T14:07:21.643+0000","size":4553,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12584869/ActiveMQClient.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12622489","id":"12622489","filename":"ActiveMQClient2.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-11T03:38:24.678+0000","size":5042,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12622489/ActiveMQClient2.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"330137","customfield_12312823":null,"summary":"Store based cursor \"forgets\" messages","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cs.fra.community%40sungard.com","name":"cs.fra.community@sungard.com","key":"cs.fra.community@sungard.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"SunGard Global Services Germany","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cs.fra.community%40sungard.com","name":"cs.fra.community@sungard.com","key":"cs.fra.community@sungard.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"SunGard Global Services Germany","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Durable queues with JDBC persistent store in a master/slave configuration with NIO transport","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649475/comment/13868631","id":"13868631","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"The test code attached is very helpful, thank you.\n\nIn the code, sessions, consumers, and producers are being created in a message loop, so that every message gets a new session.  This is very bad, although it shouldn't lead to missing messages as described.\n\nRunning this program on my system, the client and broker both ramped up to about 30-40% cpu usage.  And message flow was terribly slow.\n\nAnother concern - there is no comparison of messages sent and received.  To detect missing messages, are you only looking at counts?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-11T03:04:42.860+0000","updated":"2014-01-11T03:04:42.860+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649475/comment/13868642","id":"13868642","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Attaching modified version of the client that takes the session, producer, and consumer creation outside the message-processing loop.  It also limits consumption on each client to it's portion of the produced messages and allows the program to terminate properly once all consumption and production is complete.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-11T03:38:24.684+0000","updated":"2014-01-11T03:38:24.684+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649475/comment/13868643","id":"13868643","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"Please give the ActiveMQClient2.java a try in your environment.  Note that I replaced JNDI with inline instantiation of objects as I'm not using JNDI.\n\nIf this does not work for you, we'll have to look at other factors that may be involved.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2014-01-11T03:39:56.807+0000","updated":"2014-01-11T03:39:56.807+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649475/comment/13869941","id":"13869941","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"and if you get something that reproduces, please validate against a 5.10-SNAPSHOT to see if the issue exists on trunk. thx","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2014-01-13T20:35:51.046+0000","updated":"2014-01-13T20:35:51.046+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649475/comment/13873555","id":"13873555","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Reducing this to 'major' since its against an older broker release and we have no test case to check against the latest release or SNAPSHOT builds. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-01-16T16:16:01.727+0000","updated":"2014-01-16T16:16:01.727+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4556/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1kwdr:"}}