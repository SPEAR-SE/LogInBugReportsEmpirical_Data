{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482864","self":"https://issues.apache.org/jira/rest/api/2/issue/12482864","key":"AMQ-2346","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-08-31T14:42:06.602+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 03 15:56:04 UTC 2009","customfield_12310420":"74974","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2504539797_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-09-03T15:56:04.533+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2346/watchers","watchCount":1,"isWatching":false},"created":"2009-08-05T16:13:44.736+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-09-03T15:56:04.532+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313898","id":"12313898","name":"JCA Container"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"In geronimo we're seeing an intermittent tck problem that seems to relate to a situation where there are:\n-- a BMT stateless session ejb\n-- two connections (I think these get shared to the same ManagedConnection)\n-- two sessions\n-- tx control through UT\n-- send a message in one tx\n-- receive message in a tx that is rolled back\n-- receive message in a tx that is committed\n\nIn a public test case I'm seeing that the session proxies get confused about whether there is an active transaction.  This doesn't happen all the time but with a few repititions it happens consistently.\n\nSee GERONIMO-4784","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161842","customfield_12312823":null,"summary":"in managed environment, 2 connections/session, UserTransaction, transaction management gets confused","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482864/comment/12941308","id":"12941308","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"body":"I've found a way to reproduce the problem in activemq.  See activemq-ra/src/test/java/org/apache/activemq/ra/JmsXARollback2CxTransactionTest.java\n\nThe test testRepeatReceiveTwoThenRollback is currently renamed so it doesnt run.\n\nrev 805881","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-08-19T17:10:25.989+0000","updated":"2009-08-19T17:10:25.989+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482864/comment/12940999","id":"12940999","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"David, not sure what the best plan of action is here.\n\nI worked through the test case and the problem is that there are two sessions and two XAResources and only one of those sessions is associated with the active connection so only one of those sessions will behave as expected when a transaction is rolled back.\nThe test holds two connections and two XAResources and alternates the commit/rollback between them. I find that the second iteration of the test always fails.\n\nThere is an additional problem in that  the second session/connection has an outstanding transaction when it is closed, as a result of the outstanding transaction, the close is deferred till the transaction commits, which never happens, thus we see the problems with \"javax.jms.InvalidClientIDException: Broker: localhost - Client: org.apache.activemq.test.JmsResourceProvider already connected from vm://localhost#4 on subsequent tests. \n\nMy first though was that these connections should be presenting the same XAResource (somethng with isSameRM == true), Essentially an XAResoruce for the Broker. But it looks like the intention is that an XAResource maps to a session. Maybe this is the crux of the problem.\n\nWhen dealing with the two sessions and XAResources, my thinking was that the test should be driving 2PC, but this does not work because the broker only sees one transaction branch and fails on a second prepare.\n\nSo I am thinking that the correct solution is to have a shared XAResource for the ResourceAdapter and have sessions just track the association. Not sure yet what all the ramifications are. What do you think?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-08-31T14:42:06.602+0000","updated":"2009-08-31T14:42:06.602+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482864/comment/12941009","id":"12941009","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"looks like http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/TransactionContext.java?view=log#rev581242 is relevant. That static could be the shared state we need.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-08-31T16:35:05.056+0000","updated":"2009-08-31T16:35:05.056+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482864/comment/12941010","id":"12941010","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"body":"Making ENDED_XA_TRANSACTION_CONTEXTS static in TransactionContext makes the test pass for me.  This variable doesn't make any sense unless it's static, as otherwise the only possible TransactionContext in the list is \"this\".\n\nI'm not thrilled with introducing a static, in an osgi environment it would be better to have a service, but it seems like the best solution in a non-osgi environment.\n\nUnfortunately I'm seeing a new problem, apparently a race condition between closing a connection and starting a new connection and setting clientId.  Adding a Thread.sleep(10) to JmsTransactionTestSupport reconnect sidesteps this problem...\n\nTests run: 17, Failures: 0, Errors: 15, Skipped: 0, Time elapsed: 2.022 sec <<< FAILURE!\ntestReceiveTwoThenCloseConnection(org.apache.activemq.ra.JmsXARollback2CxTransactionTest)  Time elapsed: 1.124 sec  <<< ERROR!\njavax.jms.InvalidClientIDException: Broker: localhost - Client: org.apache.activemq.test.JmsResourceProvider already connected from vm://localhost#8\n\tat org.apache.activemq.broker.region.RegionBroker.addConnection(RegionBroker.java:216)\n\tat org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:82)\n\tat org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:82)\n\tat org.apache.activemq.advisory.AdvisoryBroker.addConnection(AdvisoryBroker.java:77)\n\tat org.apache.activemq.broker.BrokerFilter.addConnection(BrokerFilter.java:82)\n\tat org.apache.activemq.broker.MutableBrokerFilter.addConnection(MutableBrokerFilter.java:89)\n\tat org.apache.activemq.broker.TransportConnection.processAddConnection(TransportConnection.java:686)\n\tat org.apache.activemq.command.ConnectionInfo.visit(ConnectionInfo.java:134)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:308)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:182)\n\tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:109)\n\tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n\tat org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:205)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:651)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:676)\n\tat java.lang.Thread.run(Thread.java:613)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-08-31T17:02:04.588+0000","updated":"2009-08-31T17:02:04.588+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482864/comment/12941669","id":"12941669","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"static back in place and made the removeCommand sync in transport connection to kill race condition with starting a new connection with the same clientId.\n\nrevision: r811003","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-09-03T15:56:04.498+0000","updated":"2009-09-03T15:56:04.498+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2346/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s29b:"}}