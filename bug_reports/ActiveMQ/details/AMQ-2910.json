{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483544","self":"https://issues.apache.org/jira/rest/api/2/issue/12483544","key":"AMQ-2910","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315624","id":"12315624","description":"Maintenance release for 5.4.0","name":"5.4.1","archived":false,"released":true,"releaseDate":"2010-09-21"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-09-13T12:33:45.851+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Sep 01 15:55:16 UTC 2016","customfield_12310420":"14826","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_277312185_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-09-16T17:10:29.346+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2910/watchers","watchCount":2,"isWatching":false},"created":"2010-09-13T12:08:37.161+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-09-01T15:55:16.663+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We got the following NullPointerException in kahadb.\n\n13 Sep 2010 05:53:30 (JMS) [] Caught an Exception adding a message: ActiveMQObjectMessage {commandId = 111839609, responseRequired = false, messageId = ID:statler.ndgf.org-42286-1282568899957-0:0:2:1:43748846, originalDestination = null, originalTransactionId = null, producerId = ID:statler.ndgf.org-42286-1282568899957-0:0:2:1, destination = queue://cells.domain.dCacheDomain, transactionId = null, expiration = 0, timestamp = 0, arrival = 0, brokerInTime = 1284350009950, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = false, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = org.apache.activemq.util.ByteSequence@1bada5d, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = false, readOnlyBody = false, droppable = false} first to FilePendingMessageCursor \njava.lang.NullPointerException: null\n        at org.apache.kahadb.util.LinkedNode.unlink(LinkedNode.java:231) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.util.SequenceSet.removeFirstSequence(SequenceSet.java:203) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.PageFile.allocate(PageFile.java:753) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.allocate(Transaction.java:137) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.allocate(Transaction.java:121) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.createEntry(PList.java:425) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:170) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList$2.execute(PList.java:163) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.execute(Transaction.java:728) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:161) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:221) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:192) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.addMessageLast(StoreQueueCursor.java:96) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.sendMessage(Queue.java:1601) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:707) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.send(Queue.java:646) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:365) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:494) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.scheduler.SchedulerBroker.send(SchedulerBroker.java:136) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:230) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:460) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:663) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:309) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:217) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:219) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:201) [activemq-all-5.4.0.jar:5.4.0]\n        at java.lang.Thread.run(Thread.java:619) [na:1.6.0_20]\n13 Sep 2010 05:53:30 (JMS) [] Async error occurred: java.lang.RuntimeException: java.lang.NullPointerException\njava.lang.RuntimeException: java.lang.NullPointerException\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:228) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:192) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.addMessageLast(StoreQueueCursor.java:96) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.sendMessage(Queue.java:1601) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:707) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.send(Queue.java:646) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:365) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:494) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.scheduler.SchedulerBroker.send(SchedulerBroker.java:136) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:230) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:460) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:663) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:309) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:217) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:219) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:201) [activemq-all-5.4.0.jar:5.4.0]\n        at java.lang.Thread.run(Thread.java:619) [na:1.6.0_20]\nCaused by: java.lang.NullPointerException: null\n        at org.apache.kahadb.util.LinkedNode.unlink(LinkedNode.java:231) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.util.SequenceSet.removeFirstSequence(SequenceSet.java:203) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.PageFile.allocate(PageFile.java:753) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.allocate(Transaction.java:137) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.allocate(Transaction.java:121) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.createEntry(PList.java:425) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:170) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList$2.execute(PList.java:163) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.execute(Transaction.java:728) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:161) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:221) ~[activemq-all-5.4.0.jar:5.4.0]\n        ... 24 common frames omitted\n\nLooking at the code, it appears to me that the only way an NPE can be thrown at that place is if list is null. Since the same method however tests for that exact case, I suspect there is unsynchronized concurrent access to the LinkedNode.\n\nA few hours later we got more failures:\n\n13 Sep 2010 08:38:19 (JMS) [] Caught an Exception adding a message: ActiveMQObjectMessage {commandId = 29114496, responseRequired = false, messageId = ID:arctic01.csc.fi-39780-1280232016428-0:0:2:1:333447, originalDestination = null, originalTransactionId = null, producerId = ID:arctic01.csc.fi-39780-1280232016428-0:0:2:1, destination = queue://cells.domain.dCacheDomain, transactionId = null, expiration = 0, timestamp = 0, arrival = 0, brokerInTime = 1284359899636, brokerOutTime = 0, correlationId = null, replyTo = null, persistent = false, type = null, priority = 4, groupID = null, groupSequence = 0, targetConsumerId = null, compressed = false, userID = null, content = org.apache.activemq.util.ByteSequence@6f28b428, marshalledProperties = null, dataStructure = null, redeliveryCounter = 0, size = 0, properties = null, readOnlyProperties = false, readOnlyBody = false, droppable = false} first to FilePendingMessageCursor \njava.lang.NullPointerException: null\n        at org.apache.kahadb.util.LinkedNode.isHeadNode(LinkedNode.java:64) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.util.LinkedNode.unlink(LinkedNode.java:230) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.util.SequenceSet.removeFirstSequence(SequenceSet.java:203) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.PageFile.allocate(PageFile.java:753) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.allocate(Transaction.java:137) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.allocate(Transaction.java:121) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.createEntry(PList.java:425) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:170) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList$2.execute(PList.java:163) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.execute(Transaction.java:728) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:161) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:221) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:192) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.addMessageLast(StoreQueueCursor.java:96) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.sendMessage(Queue.java:1601) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:707) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.send(Queue.java:646) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:365) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:494) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.scheduler.SchedulerBroker.send(SchedulerBroker.java:136) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:230) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:460) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:663) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:309) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:217) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:219) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:201) [activemq-all-5.4.0.jar:5.4.0]\n        at java.lang.Thread.run(Thread.java:619) [na:1.6.0_20]\n13 Sep 2010 08:38:19 (JMS) [] Async error occurred: java.lang.RuntimeException: java.lang.NullPointerException\njava.lang.RuntimeException: java.lang.NullPointerException\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:228) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.addMessageLast(FilePendingMessageCursor.java:192) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.addMessageLast(StoreQueueCursor.java:96) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.sendMessage(Queue.java:1601) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:707) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.Queue.send(Queue.java:646) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:365) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:494) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.scheduler.SchedulerBroker.send(SchedulerBroker.java:136) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:129) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:96) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:230) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:135) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:460) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:663) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:309) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:217) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:219) [activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:201) [activemq-all-5.4.0.jar:5.4.0]\n        at java.lang.Thread.run(Thread.java:619) [na:1.6.0_20]\nCaused by: java.lang.NullPointerException: null\n        at org.apache.kahadb.util.LinkedNode.isHeadNode(LinkedNode.java:64) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.util.LinkedNode.unlink(LinkedNode.java:230) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.util.SequenceSet.removeFirstSequence(SequenceSet.java:203) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.PageFile.allocate(PageFile.java:753) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.allocate(Transaction.java:137) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.allocate(Transaction.java:121) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.createEntry(PList.java:425) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:170) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList$2.execute(PList.java:163) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.kahadb.page.Transaction.execute(Transaction.java:728) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.store.kahadb.plist.PList.addLast(PList.java:161) ~[activemq-all-5.4.0.jar:5.4.0]\n        at org.apache.activemq.broker.region.cursors.FilePendingMessageCursor.tryAddMessageLast(FilePendingMessageCursor.java:221) ~[activemq-all-5.4.0.jar:5.4.0]\n        ... 24 common frames omitted\n\nWe got a number of those exceptions with the same stack trace and then followed by tons of other NullPointerExceptions, likely because the list was corrupted at that point.\n\n\nNot long after these stack traces message delivery began to hang. A restart of the broker only helped temporarily as message delivery would hang again after half a minute or so. To our big suprise moving the db directory to let ActiveMQ create a new database didn't solve the problem either. I am unable to tell to what extend that was caused by the above exceptions or not.\n\nWe are happy to provide any other information you may need to debug this problem.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461868","id":"12461868","filename":"AMQ2910Test.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-16T09:41:13.829+0000","size":4159,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461868/AMQ2910Test.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"63740","customfield_12312823":null,"summary":"NullPointerException in kahadb linked list","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=behrmann","name":"behrmann","key":"behrmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gerd Behrmann","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=behrmann","name":"behrmann","key":"behrmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gerd Behrmann","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"java version \"1.6.0_20\"\nJava(TM) SE Runtime Environment (build 1.6.0_20-b02)\nClients connection to the broker use Active MQ 5.3.0 or 5.3.2.","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483544/comment/12942904","id":"12942904","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"That NPE is coming from the cursor so it is using the temp store. If it occurs after a restart you may have a test case in the making because the temp store does not persist through restarts. it is recreated as needed.\nIt would be great of you could wrangle up a test app that can reproduce.\n\nAs a workaround, consider using the default store cursor rather than the file pending message cursor.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-13T12:33:45.851+0000","updated":"2010-09-13T12:33:45.851+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483544/comment/12942898","id":"12942898","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=behrmann","name":"behrmann","key":"behrmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gerd Behrmann","active":true,"timeZone":"Etc/UTC"},"body":"Unfortunately the exceptions did *not* occur again after a restart.\n\nWhat did happen after a restart was that message delivery was very shaky. Message delivery worked to some clients and not to others. I have absolutely no idea why. I suspect that those NPEs corrupted some state (possibly in the clients) that survived the broker restart.  It was not possible for us to restart all clients at once, as they are not under our direct control.\n\nAs this happened on a large production system that we could not afford to keep down for debugging we have temporarily switched back to our old (non-JMS) messaging system.\n\nThanks for the tip about a possible workaround. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=behrmann","name":"behrmann","key":"behrmann","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gerd Behrmann","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-13T12:50:29.351+0000","updated":"2010-09-13T12:50:29.351+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483544/comment/12942918","id":"12942918","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Attaching a test case that can reproduce this exception. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-16T09:41:13.907+0000","updated":"2010-09-16T09:41:13.907+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483544/comment/12942920","id":"12942920","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolve in r997849\n\nwould  be great if you could validate tonight's 5.5-SNAPSHOT or build trunk yourself to validate.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-16T17:10:29.309+0000","updated":"2010-09-16T17:10:29.309+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483544/comment/15455839","id":"15455839","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit a0d05f8ea3e883a16d86b4a6755f7fc1a503f55b in activemq's branch refs/heads/master from [~gtully]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=a0d05f8 ]\n\nAMQ-2910 fix timing on test timeout - ensure consumer connection is started\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-01T15:55:16.663+0000","updated":"2016-09-01T15:55:16.663+0000"}],"maxResults":5,"total":5,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2910/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ba1r:"}}