{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12616950","self":"https://issues.apache.org/jira/rest/api/2/issue/12616950","key":"AMQ-4182","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-11-26T16:17:18.867+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Apr 23 10:59:31 UTC 2014","customfield_12310420":"258841","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_520467440_*|*_5_*:*_2_*:*_215121109_*|*_4_*:*_1_*:*_44089011155","customfield_12312321":null,"resolutiondate":"2014-04-23T10:59:31.094+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4182/watchers","watchCount":4,"isWatching":false},"created":"2012-11-20T15:42:51.431+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318549","id":"12318549","name":"5.5.1","archived":false,"released":true,"releaseDate":"2011-10-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-04-23T10:59:31.130+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313896","id":"12313896","name":"JMS client"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"InflaterInputStream is supposed to close explicitly to release resource allocated by its JNI methods. In ActiveMQBytesMessage, dataIn property is disposed simply without closing it, which results in some weird memory leak that can't be detected from heap size. It can't be controlled by -Xmx or -XX:MaxDirectMemorySize.\n\nPlease run the following test program to verify the issue:\n\nimport java.util.concurrent.TimeUnit;\n\nimport javax.jms.BytesMessage;\nimport javax.jms.Connection;\nimport javax.jms.Session;\n\nimport org.apache.activemq.ActiveMQConnectionFactory;\nimport org.apache.activemq.command.ActiveMQBytesMessage;\n\n/**\n * A simple test to verify memory leak in ActiveMQBytesMessage.\n */\npublic class Main\n{\n    public static void main(String[] args) throws Exception \n    {\n        ActiveMQConnectionFactory connFactory = new ActiveMQConnectionFactory(\"vm://localhost\");\n        connFactory.setUseCompression(true);\n        Connection conn = connFactory.createConnection();\n        Session session = conn.createSession(false, Session.AUTO_ACKNOWLEDGE);\n        BytesMessage message = session.createBytesMessage();\n        \n        message.writeBytes(new byte[1024]);\n\n        ActiveMQBytesMessage m = (ActiveMQBytesMessage)message;\n        if(!m.isCompressed())\n        {\n            throw new RuntimeException();\n        }\n        \n        \n        while (true)\n        {\n            for (int k = 0; k < 1024; ++k)\n            {\n                message.reset();\n                byte[] data = new byte[1024];\n                message.readBytes(data);\n            }\n            TimeUnit.MILLISECONDS.sleep(10);\n        }\n    }\n\n}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"121427","customfield_12312823":null,"summary":"Memory Leak for ActiveMQBytesMessage with Compression as true","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux(Redhat 5.5), Windows 7","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12616950/comment/13503864","id":"13503864","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Added some additional logic to attempt to close the dataIn stream when possible.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-11-26T16:17:18.867+0000","updated":"2012-11-26T16:17:18.867+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12616950/comment/13506175","id":"13506175","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"body":"I read the changes. Fix in reset() is good I believe. But I am worried about the finalize() method because I don't think it would work as good as we would expect. Please take a look at how Sun's JDK 1.6 implemented java.util.zip.Inflater\n\n336     /**\n337      * Closes the decompressor and discards any unprocessed input.\n338      * This method should be called when the decompressor is no longer\n339      * being used, but will also be called automatically by the finalize()\n340      * method. Once this method is called, the behavior of the Inflater\n341      * object is undefined.\n342      */\n343     public void end() {\n344         synchronized (zsRef) {\n345             long addr = zsRef.address();\n346             zsRef.clear();\n347             if (addr != 0) {\n348                 end(addr);\n349                 buf = null;\n350             }\n351         }\n352     }\n353\n354     /**\n355      * Closes the decompressor when garbage is collected.\n356      */\n357     protected void finalize() {\n358         end();\n359     }\n\nThey have already done finalize() with end(). So if finalize() works well, the problem wouldn't exist in the first place. And since those memory is allocated out of JVM heap, the GC could have problem to sense the necessity to clean something even the system blows out.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"created":"2012-11-29T02:57:51.070+0000","updated":"2012-11-29T02:57:51.070+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12616950/comment/13506194","id":"13506194","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"body":"Please try to run the test program with -Xmx10M, -X128M, and -X2G, and monitor the JVM memory usage. Here are the results in my own test system with 8G memory when it was stable:\n\n-Xmx10M\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND\n15070 root      17   0  429m 123m 9856 S 80.2  1.5   0:48.49 java   \n\n-Xmx128M\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND\n15115 root      17   0 2808m 2.0g 9856 S 78.6 26.0   0:22.70 java\n\n-X2G\nNever stable and the whole system just ran out of memory.\n\nThat means when -Xmx is big enough for holding NORMAL objects the GC just won't see the memory problem at all, which results in the finalize() method won't be executed ever.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"created":"2012-11-29T03:58:52.865+0000","updated":"2012-11-29T03:58:52.865+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12616950/comment/13506197","id":"13506197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"body":"The change on finalize() won't fix the problem because java.util.zip.Inflater tries that already. The memory problem happens out of the normal heap and GC won't detect the memory shortage, in turn objects won't be wiped out at all.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"created":"2012-11-29T04:02:39.977+0000","updated":"2012-11-29T04:02:39.977+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12616950/comment/13506793","id":"13506793","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"You're welcome to submit a patch if you can see a reasonable solution to the issue you are seeing. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2012-11-29T21:11:32.650+0000","updated":"2012-11-29T21:11:32.650+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12616950/comment/13506880","id":"13506880","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"body":"Unfortunately, I don't have a solution for that. I would tend to say that there is not a valid solution for that. \n\nWe could try to add a close() or release() method to ActiveMQBytesMessage, but I don't think the users are going to call it because it is not part of the JMS API. \n\nOr we can try to find another pure Java compression library to avoid the need to release the resource explicitly. But that may probably mean we need to sacrifice some performance when doing compression.\n\nOr we may want to decompress the whole buffer, instead of remaining a stream for it. The memory footprint would be bigger, but comparing to blowing out the whole system, this is acceptable.\n\nOr we can call off this feature. Tell the users not to use BytesMessage in ActiveMQ when they try to use compression.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jeff.huang","name":"jeff.huang","key":"jeff.huang","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jeff Huang","active":true,"timeZone":"America/New_York"},"created":"2012-11-29T22:19:36.981+0000","updated":"2012-11-29T22:19:36.981+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12616950/comment/13978065","id":"13978065","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"I implemented explicit compression/decompression of the payload when we initialise writing and reading operations.\n\nhttp://git-wip-us.apache.org/repos/asf/activemq/commit/44bb9fbe\n\nWith this we can avoid using finalize() to close the streams, which can cause memory leaks. The trade-off is that we keep uncompressed messages in memory, but IMHO that's not an issue as compression is meant to be used on the wire and the similar approach is used for other kind of messages.\n\nThere's still couple of more places where we should remove finalize()","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2014-04-23T10:59:31.125+0000","updated":"2014-04-23T10:59:31.125+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4182/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0l4sn:"}}