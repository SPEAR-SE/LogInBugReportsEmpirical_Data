{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12717022","self":"https://issues.apache.org/jira/rest/api/2/issue/12717022","key":"AMQ-5201","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jun 02 11:18:54 UTC 2014","customfield_12310420":"395230","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5201/watchers","watchCount":1,"isWatching":false},"created":"2014-05-28T11:04:52.832+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-06-02T11:18:54.361+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We had a Perl script using STOMP to consume messages off an AMQ 5.8 broker. The broker would suddenly block all producers with no mention of producer flow control in the logs. This turned out to be caused by zombie threads created by the Perl script holding open TCP connections.\n\nThe consumers have a {{prefetchLimit}} of {{Short.MAX_VALUE}}. When the broker dispatches messages to the consumers, it starts filling up memory immediately (this only happens when using STOMP). All producers are blocked when the topic uses about 70-90% of {{memoryUsage}}. I would've expect the broker to not keep dispatched messages around until the prefetchLimit is reached; the same behaviour as it has when using OpenWire. At least I would have expected a log entry explaining why everything stops.\n\nAttached is a test case that demonstrates the bug. Set {{memoryUsage}} to {{64mb}} or below to reproduce:\n{code:xml|title=activemq.xml}\n        <systemUsage>\n            <systemUsage>\n                <memoryUsage>\n                    <memoryUsage limit=\"64 mb\"/>\n                </memoryUsage>\n...\n{code}\n\nThe only workaround I know of is to kill consumers that doesn't ACK using {{AbortSlowAckConsumerStrategy}}. I can't find it in the official AMQ docs, but it is well described [here|http://planet.jboss.org/post/coming_in_activemq_5_9_a_new_way_to_abort_slow_consumers] and [here|https://access.redhat.com/site/documentation/en-US/Red_Hat_JBoss_A-MQ/6.0/html/Tuning_Guide/files/TuningSlowConsumers.html]. This solves my problem. A log line hinting to why AMQ stops would be much appriciated though. It also seems wierd that STOMP caches messages not ACK'ed when OpenWire doesnt.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12647107","id":"12647107","filename":"activemq-bug.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgogstad","name":"jgogstad","key":"jgogstad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jostein Gogstad","active":true,"timeZone":"Europe/Berlin"},"created":"2014-05-28T11:05:39.960+0000","size":6543,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12647107/activemq-bug.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"395361","customfield_12312823":null,"summary":"STOMP consumers that doesn't ACK cause broker memory to fill up before prefetchLimit is reached","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgogstad","name":"jgogstad","key":"jgogstad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jostein Gogstad","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgogstad","name":"jgogstad","key":"jgogstad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jostein Gogstad","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12717022/comment/14015318","id":"14015318","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgogstad","name":"jgogstad","key":"jgogstad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jostein Gogstad","active":true,"timeZone":"Europe/Berlin"},"body":"RedHat support concludes that the underlying STOMP-library doesn't support prefetch, so the client will only accept a certain number of messages until the underlying buffers fills up. That explains why this only happens when using STOMP.\n\nThe pending limit strategies discussed in the [docs|http://activemq.apache.org/slow-consumer-handling.html] is not applicable to this scenario since the prefetchLimit isn't reached. The solution for the problem is either to use {{AbortSlowAckConsumerStrategy}} or set an explicit prefetch on the destination in question.\n\nI guess this task boils down to *\"Better error handling for consumers that doesn't support prefetch and cause broker memory to fill up*. I can't see that the messages are persisted to temporaryStore or persistentStore either, but that needs confirmation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jgogstad","name":"jgogstad","key":"jgogstad","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jostein Gogstad","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-02T11:18:54.361+0000","updated":"2014-06-02T11:18:54.361+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5201/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1w1qn:"}}