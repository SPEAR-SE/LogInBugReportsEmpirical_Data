{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482875","self":"https://issues.apache.org/jira/rest/api/2/issue/12482875","key":"AMQ-2102","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-02-19T19:50:59.770+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Mar 13 13:25:01 UTC 2009","customfield_12310420":"75074","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2668370767_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-03-13T12:05:27.204+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2102/watchers","watchCount":4,"isWatching":false},"created":"2009-02-10T14:52:36.437+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"7.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-03-13T13:25:02.231+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I'm seeing exceptions like this in a simple master/slave setup:\n\nERROR Service                        - Async error occurred: javax.jms.JMSException: Slave broker out of sync with master: Dispatched message (ID:DUL1SJAMES-L2-1231-1233929569359-0:4:1:1:207) was not in the pending list for MasterSlaveBug\njavax.jms.JMSException: Slave broker out of sync with master: Dispatched message (ID:DUL1SJAMES-L2-1231-1233929569359-0:4:1:1:207) was not in the pending list for MasterSlaveBug\n\nThe problem only happens when there are multiple consumers listening to the queue, and is more likely to occur as there are more consumers listening.  I've written a test program that demonstrates the problem.\n\nI start the master and slave with an empty data directory and let them both startup and settle.  Then start the test program.  The test program creates a specified number of consumers, and then starts queuing 256 messages.  The consumers process the message by sending a reply.  The producer counts the replies.  Both consumers and the producer see all the messages, but with multiple consumers it is very likely that the error above will occur and several of the messages will still be queued on the slave.\n\nWhile debugging through the activemq code, I noticed that both the master and the slave dispatch the message to a consumer's pending list independently.  In other words, it is possible that the master will add the message to consumer A's pending list and the slave will add the message to consumer B's pending list.  Once the message has been processed by consumer A, the master sends a message to the slaving which specifies consumer A so that the slave can remove the message.  The slave looks on its copy of consumer A's pending list and cannot find the message.  As a result, it throws this exception and the message stays stuck on consumer B's pending list on the slave.\n\nMaster and slave configurations along with MasterSlaveBug.java are attached to this issue.\n\nStart master and slave brokers:\nactivemq xbean:master.xml\nactivemq xbean:slave.xml\n\nRun with (only one consumer, the bug does not appear):\n   java -classpath .:activemq-all-5.2.0.jar MasterSlaveBug 1\nRun with (sixteen consumers, the bug does appear):\n   java -classpath .:activemq-all-5.2.0.jar MasterSlaveBug 16\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461395","id":"12461395","filename":"AMQ2102.12-03.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-12T15:03:00.291+0000","size":28427,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461395/AMQ2102.12-03.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461387","id":"12461387","filename":"AMQ-2102-03102009.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-10T15:17:31.478+0000","size":23644,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461387/AMQ-2102-03102009.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461352","id":"12461352","filename":"master.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=danjames","name":"danjames","key":"danjames","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan James","active":true,"timeZone":"America/New_York"},"created":"2009-02-10T14:57:06.693+0000","size":2190,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12461352/master.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461317","id":"12461317","filename":"MasterSlaveBug.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=danjames","name":"danjames","key":"danjames","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan James","active":true,"timeZone":"America/New_York"},"created":"2009-02-10T14:56:31.283+0000","size":13674,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461317/MasterSlaveBug.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461367","id":"12461367","filename":"MasterSlavePatch.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-04T23:14:47.158+0000","size":1524,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461367/MasterSlavePatch.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461210","id":"12461210","filename":"slave.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=danjames","name":"danjames","key":"danjames","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan James","active":true,"timeZone":"America/New_York"},"created":"2009-02-10T14:57:14.904+0000","size":2307,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12461210/slave.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461358","id":"12461358","filename":"slaveDispatchOnNotification.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-05T13:43:03.057+0000","size":16072,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461358/slaveDispatchOnNotification.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161844","customfield_12312823":null,"summary":"Master/slave out of sync with multiple consumers","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=danjames","name":"danjames","key":"danjames","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan James","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=danjames","name":"danjames","key":"danjames","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan James","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940823","id":"12940823","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dougnewton","name":"dougnewton","key":"dougnewton","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Newton","active":true,"timeZone":"Etc/UTC"},"body":"I just ran into this exact issue as well in pre-production testing where we are running just two consumers on a queue.  This is a major issue for our production deploy.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dougnewton","name":"dougnewton","key":"dougnewton","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Doug Newton","active":true,"timeZone":"Etc/UTC"},"created":"2009-02-19T19:50:59.770+0000","updated":"2009-02-19T19:50:59.770+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940877","id":"12940877","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"Definitely a major issue. I just run into this pre-production and this needs to be fixed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-02T21:41:06.985+0000","updated":"2009-03-02T21:41:06.985+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940886","id":"12940886","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"public Subscription addConsumer(ConnectionContext context, ConsumerInfo info) throws Exception {\n    \tsynchronized (addConsumerObj) {\n    \t\tsendSyncToSlave(info);\n            Subscription answer = super.addConsumer(context, info);\n            return answer;\n    \t}\n    }\n\nin MasterBroker.java\n\nthis will help but does not completely fix it. it makes sure all consumers are added in the same order to the master and slave. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-04T17:47:46.871+0000","updated":"2009-03-04T17:47:46.871+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940854","id":"12940854","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"let slave and master dispatch message is really a problem. When master sends MessageAck, how does it know the slave have finished the dispatch? If slave haven't finished, it will fail for \"Unmatched acknowledege\".","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-04T18:12:06.813+0000","updated":"2009-03-04T18:12:06.813+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940893","id":"12940893","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The master cannot know when the slave is done, as the slave does less work, it should be able to keep up, but it the slave machine or JVM is going slow, then this is a problem.\n\nI wonder if ensuring the order of consmer creation in the same on the master and slave is generally sufficient? I am working on having the slave dispatch when it gets a notification of dispatch from the master, the messageDispatchNotification, at which point it can dispatch to the subscription chosen by the master. This seems to work but it won't deal with a slow master.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-04T21:26:23.529+0000","updated":"2009-03-04T21:26:23.529+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940866","id":"12940866","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"thanks for the comment. \n\nfrom my approach, the attached patch seems work and I haven't seen a failure using 5000 msg and 16 consumers and i will do more load test maybe. and my master/slave are on the same machine. \n\nThe thing that seems strange to me is the block in preProcessDispatch to sendAsyncToSlave if temporary queue and sendSyncToSlave if persistent queue makes a difference. do you see an explanation? because if no code change for this, i will only see the same error for temporary queue messages and persistent queue with the addConsumer fix is fine.\n\nyour approach seems better, if you can have more control on the slave side. please share what you have and i may dig in that route.\n\nying\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-04T23:22:22.024+0000","updated":"2009-03-04T23:22:22.024+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940861","id":"12940861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Ying, I have applied your patch. It is simple and it works. Thanks. I guess remove consumers need a similar lock, just need another test to verify. For the moment, I will shelve the refactor to defer slave dispatch till the notification as it does not seem necessary.\nDan, thanks for the test case, that is included also, although it does not always fail, it always produced the 'slave out of sync' errors on the console.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-05T13:40:20.408+0000","updated":"2009-03-05T13:40:20.408+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940884","id":"12940884","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"This patch defers dispatch on a slave til the dispatch notification so that the slave can honor the dispatch decision made on the master. However, if the master and slave are kept in sync wrt. consumer additions it is not needed. Adding it here as a place holder in case we still need to refactor in this manner.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-05T13:43:03.131+0000","updated":"2009-03-05T13:43:03.131+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940865","id":"12940865","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"hi, Gary\nunfortunately the patch I did yesterday does not fix this issue completely. i did more load test and it failed for the same exception. \n\ni then used your patch and get the following with 5000 msg 16 consumers. I will try to troubleshoot this but i will appreciate your help. Thanks\n\nERROR MasterBroker                   - Slave Failed\njava.lang.ClassCastException: org.apache.activemq.command.ActiveMQTextMessage cannot be cast to org.apache.activemq.broker.region.QueueMessageReference\n\tat org.apache.activemq.broker.region.QueueSubscription.acknowledge(QueueSubscription.java:49)\n\tat org.apache.activemq.broker.region.PrefetchSubscription.acknowledge(PrefetchSubscription.java:242)\n\tat org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:373)\n\tat org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:462)\n\tat org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)\n\tat org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n\tat org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:74)\n\tat org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:85)\n\tat org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:456)\n\tat org.apache.activemq.command.MessageAck.visit(MessageAck.java:205)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)\n\tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:104)\n\tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n\tat org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:205)\n\tat org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n\tat org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)\nERROR MasterBroker                   - Slave Failed\njavax.jms.JMSException: Slave broker out of sync with master - Message: ID:yhe-1337-1236273055924-0:16:1:1:738 on queue://MasterSlaveBug does not exist among pending(200) for subscription: ID:yhe-3603-1236271682179-0:13:1:1\n\tat org.apache.activemq.broker.region.Queue.getMatchingMessage(Queue.java:1411)\n\tat org.apache.activemq.broker.region.Queue.processDispatchNotification(Queue.java:1357)\n\tat org.apache.activemq.broker.region.AbstractRegion.processDispatchNotificationViaDestination(AbstractRegion.java:433)\n\tat org.apache.activemq.broker.region.QueueRegion.processDispatchNotification(QueueRegion.java:77)\n\tat org.apache.activemq.broker.region.RegionBroker.processDispatchNotification(RegionBroker.java:585)\n\tat org.apache.activemq.broker.BrokerFilter.processDispatchNotification(BrokerFilter.java:202)\n\tat org.apache.activemq.broker.BrokerFilter.processDispatchNotification(BrokerFilter.java:202)\n\tat org.apache.activemq.broker.BrokerFilter.processDispatchNotification(BrokerFilter.java:202)\n\tat org.apache.activemq.broker.MutableBrokerFilter.processDispatchNotification(MutableBrokerFilter.java:209)\n\tat org.apache.activemq.broker.TransportConnection.processMessageDispatchNotification(TransportConnection.java:466)\n\tat org.apache.activemq.command.MessageDispatchNotification.visit(MessageDispatchNotification.java:77)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:305)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)\n\tat org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:104)\n\tat org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n\tat org.apache.activemq.transport.vm.VMTransport.iterate(VMTransport.java:205)\n\tat org.apache.activemq.thread.DedicatedTaskRunner.runTask(DedicatedTaskRunner.java:98)\n\tat org.apache.activemq.thread.DedicatedTaskRunner$1.run(DedicatedTaskRunner.java:36)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-05T17:14:33.822+0000","updated":"2009-03-05T17:14:33.822+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940868","id":"12940868","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"sorry, my patch is still a bit of a work in progress. I was using this jira as a shared holder. For the cce,{code} private QueueMessageReference getMatchingMessage(MessageDispatchNotification messageDispatchNotification) throws Exception {code} needs to return a QueueMessageReference. \nAdd the following to get it to work better. I still need to validate that the dispatch that that happens here is correct w.r.t a normal dispatch. I have run it by applying the patch to trunk, so only with your changes to MasterBroker, ignoring the MasterBroker changes in the patch. With 30000 messages I still get errors, but of a different kind. More work needed. \n{code}\n            if (message == null) {            \n                synchronized (messages) {\n                    try {\n                        messages.reset();\n                        while (messages.hasNext()) {\n                            MessageReference node = messages.next();\n+                            node.incrementReferenceCount();\n+                            messages.remove();\n                            if (messageId.equals(node.getMessageId())) {\n+                                message = this.createMessageReference(node.getMessage());\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-05T19:15:10.552+0000","updated":"2009-03-05T19:15:10.552+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940908","id":"12940908","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"this update helps. did another test and it still has the slave out of sync with broker and another bad thing is consumer now can see duplicate messages. more work needed.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-05T23:29:09.814+0000","updated":"2009-03-05T23:29:09.814+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940873","id":"12940873","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"ying, could you possibly codify your test in Junit and attach it. The broker setup from this test may be useful:  http://svn.apache.org/viewvc/activemq/trunk/activemq-core/src/test/java/org/apache/activemq/bugs/AMQ2102Test.java?view=markup\nthen I can run your test case in tandem against my changes. thanks.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-06T10:53:31.893+0000","updated":"2009-03-06T10:53:31.893+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940872","id":"12940872","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"Gary, i am using the same MasterSlaveBug test to see whether it is still having slave broker out of sync.\n\nAs to duplicates, i just simply have a consumer and in it I have a \n{{{\nprivate static HashSet<String> dupCheck = new HashSet<String>();\n                   if(!dupCheck.add (textMessage.getText()))\n        \t    {\n        \t      System.out.println(\"### Message already received [\" + textMessage.getText() + \"]\");\n        \t    }\n}}}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-06T18:39:19.876+0000","updated":"2009-03-06T18:39:19.876+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940928","id":"12940928","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"defer the message dispatch on slave is right I think. but the issue is when multiple consumer is involved, message dispatch notification and message ack are not coming in order in teams of command id. \n\nis there a way on the slave side to say, when I get a messagedispatchNotification, page in that message and dispatch it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-09T16:47:22.651+0000","updated":"2009-03-09T16:47:22.651+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940945","id":"12940945","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"Attached AMQ-2102-03102009.patch seems fix all the slave broker out of synch issue. This is patch is created on activemq 5.2.0 official release tagged source. sorry that I run a tight schedule and don't have time to patch on trunk. \n\nOne thing missed in this patch is:\n{{{\n public MessageReference getMessage(MessageId id) throws IOException{\n    \tMessage msg = this.store.getMessage(id);\n    \treturn msg;\n    }\n}}}\n\nin org.apache.activemq.broker.region.cursors.QueueStorePrefetch.java\n\nHere is some explaination:\n\n1. MasterBroker.java changes make sure that each command will arrive on the slave side in the same order. This is necessary because for each specific message, message itself, dispatch notification and message ack has to come in the exact order, otherwise, slave out of sync\n\n2. Queue.java if dispatch notification comes and the messages still not in pending list or pagedIn, it goes to the store to grab the message and add to the pending then do processMessageDispatchNotification. This is necessary because that multiple consumers are involved (eg. dispatch notification for message 201 could come first while only 200 messages on slave side is pagedin or in the pending list)\n\nPlease review it. I urgently need a review of this to make sure the changes are fine.\n\nA remaining issue which might or might related to this fix:\n\nI see \"consumer stop consuming message\" when large number of messages is produced and consumed and I have to restart the broker pair. otherwise, the brokers seems hanging. do you have any insight what might go wrong?\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-10T15:17:31.673+0000","updated":"2009-03-10T15:17:31.673+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940949","id":"12940949","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Yea Ying, I came to the same conclusion.  The message needs to be pulled directly from the store when the pageSize is full and all subscriptions are full also.\nThis patch is a tidier version of the original. Can you validate on your side. It does not need as many changes to MasterBroker async sends are they will impede performance.\nAlso, there is a suppression of dispatchNotifications when a subscription is removed.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-12T15:03:00.370+0000","updated":"2009-03-12T15:03:00.370+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940978","id":"12940978","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"fix committed, Ying, thanks for your input. r753214\n\nslave dispatch now occurs on processDispatchNotification when master has chosen the subscriber. With large volumes and prefetch sizes and short lived consumers messages on the slave may not be in memory and need to be pulled directly from the store. Normally this is not the case though.\n\nHaving the master and slave do separate dispatch does not work due to re deliveries and consumer add/remove order and load effects on thread scheduling. with the stricter enforcement of ack delivery to subscriptions this behavior unfolded.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T12:05:27.088+0000","updated":"2009-03-13T12:05:27.088+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482875/comment/12940982","id":"12940982","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"body":"thank you too. just finished a testing of 2 million messages with this new patch test. it works fine with no mismatch. the consumer stop consuming is due to systemUsage config, also heap needs to bump up otherwise it will get JVM java.lang.OutOfMemoryError: GC overhead limit exceeded.\n\nI am currently observing heap. I have 4 pair of master/slave, looks like the one pair which the consumer is connecting to, after 2 million msgs, has higher used heap, about >10mb higher than the rest of the broker, even after killing all producers and consumers. is there a possible leak? i will continue watch out and have more tests.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=yinghe0101","name":"yinghe0101","key":"yinghe0101","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ying","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T13:25:01.813+0000","updated":"2009-03-13T13:25:01.813+0000"}],"maxResults":18,"total":18,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2102/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s29r:"}}