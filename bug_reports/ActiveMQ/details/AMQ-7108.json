{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13199948","self":"https://issues.apache.org/jira/rest/api/2/issue/13199948","key":"AMQ-7108","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2018-11-22T01:11:13.997+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 22 01:11:13 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-7108/watchers","watchCount":2,"isWatching":false},"created":"2018-11-21T22:41:48.965+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/4","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/minor.svg","name":"Minor","id":"4"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329382","id":"12329382","name":"5.11.1","archived":false,"released":true,"releaseDate":"2015-02-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-11-22T01:11:13.997+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12321929","id":"12321929","name":"Job Scheduler","description":"Store used to persist scheduled messages"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12325017","id":"12325017","name":"KahaDB"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"*Issue*\r\n\r\nWe have been running the stack with the same stated versions mentioned in this ticket's environment details for over a year.  Recently we have experienced ActiveMQ outages as a result of the exception below.  There has been a increase in load but not significant.\r\n\r\nScheduled messages are being used as a polling mechanism in a workflow system.  A workflow will execute a step then schedule a small object message, containing just an identifier, to check for a result in a number of seconds.  The consumer of the message will schedule another message if the task is not complete yet.  We also have a batch process that can start a number of workflows concurrently.  Usually in the order of 100's which means 100's of scheduled messages can be created concurrently.\r\n\r\nThe most recent failure occurred with a batch of only 64.\r\n\r\nWe haven't noticed any data loss as a result of this but it doesn't cause a complete outage of our production system.\r\n\r\n*Recovery*\r\n\r\nThe only way we have been able to recover from this error is to restart the broker.  kahadb is configured to check for corrupt journal which would recover the journal on startup.  It is unclear if the journal is corrupted though.\r\n\r\n*Reproduction*\r\n\r\nWe have tried to reproduce this issue using the ActiveMQ performance maven plugin but was unable to.  We had 10000 producers concurrently schedule 500 messages each.  \r\n\r\n \r\nNote there are two stack traces here.  The second one is possibly a side-effect of the first one.\r\n{code:java}\r\n2018-Nov-21 15:16:48 JobScheduler:JMS [org.apache.activemq.store.kahadb.scheduler.JobSchedulerImpl] ERROR: JMS Failed to schedule job\r\njava.lang.ClassCastException: org.apache.activemq.store.kahadb.data.KahaTraceCommand cannot be cast to org.apache.activemq.store.kahadb.data.KahaAddScheduledJobCommand\r\n        at org.apache.activemq.store.kahadb.scheduler.JobSchedulerStoreImpl.getPayload(JobSchedulerStoreImpl.java:529)\r\n        at org.apache.activemq.store.kahadb.scheduler.JobSchedulerImpl.fireJob(JobSchedulerImpl.java:789)\r\n        at org.apache.activemq.store.kahadb.scheduler.JobSchedulerImpl.mainLoop(JobSchedulerImpl.java:720)\r\n        at org.apache.activemq.store.kahadb.scheduler.JobSchedulerImpl.run(JobSchedulerImpl.java:673)\r\n        at java.lang.Thread.run(Thread.java:748)\r\n\r\n2018-Nov-21 15:24:45 ActiveMQ Transport: tcp:///10.88.2.113:54256@61616 [org.apache.activemq.transaction.LocalTransaction] WARN: POST COMMIT FAILED:\r\njava.lang.NullPointerException\r\n        at org.apache.activemq.store.kahadb.AbstractKahaDBStore.store(AbstractKahaDBStore.java:482)\r\n        at org.apache.activemq.store.kahadb.AbstractKahaDBStore.store(AbstractKahaDBStore.java:394)\r\n        at org.apache.activemq.store.kahadb.scheduler.JobSchedulerImpl.doSchedule(JobSchedulerImpl.java:264)\r\n        at org.apache.activemq.store.kahadb.scheduler.JobSchedulerImpl.schedule(JobSchedulerImpl.java:99)\r\n        at org.apache.activemq.broker.scheduler.SchedulerBroker.doSchedule(SchedulerBroker.java:197)\r\n        at org.apache.activemq.broker.scheduler.SchedulerBroker.access$000(SchedulerBroker.java:48)\r\n        at org.apache.activemq.broker.scheduler.SchedulerBroker$1.afterCommit(SchedulerBroker.java:162)\r\n        at org.apache.activemq.transaction.Transaction.fireAfterCommit(Transaction.java:126)\r\n        at org.apache.activemq.transaction.Transaction.doPostCommit(Transaction.java:195)\r\n        at org.apache.activemq.transaction.Transaction$2.call(Transaction.java:55)\r\n        at java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n        at org.apache.activemq.store.kahadb.MessageDatabase.store(MessageDatabase.java:990)\r\n        at org.apache.activemq.store.kahadb.MessageDatabase.store(MessageDatabase.java:957)\r\n        at org.apache.activemq.store.kahadb.KahaDBTransactionStore.commit(KahaDBTransactionStore.java:298)\r\n        at org.apache.activemq.transaction.LocalTransaction.commit(LocalTransaction.java:70)\r\n        at org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:253){code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12949125","id":"12949125","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bendherville","name":"bendherville","key":"bendherville","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben D'Herville","active":true,"timeZone":"Australia/Melbourne"},"created":"2018-11-21T22:47:01.324+0000","size":6008,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12949125/activemq.xml"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Scheduled job scheduling occasionally fails with java.lang.ClassCastException: org.apache.activemq.store.kahadb.data.KahaTraceCommand cannot be cast to org.apache.activemq.store.kahadb.data.KahaAddScheduledJobCommand","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bendherville","name":"bendherville","key":"bendherville","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben D'Herville","active":true,"timeZone":"Australia/Melbourne"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bendherville","name":"bendherville","key":"bendherville","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben D'Herville","active":true,"timeZone":"Australia/Melbourne"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"*OS*: Linux ip-10-88-2-47 3.13.0-125-generic #174-Ubuntu SMP Mon Jul 10 18:51:24 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n*AMQ*: 5.11.1\r\n\r\n*glusterfs*: 3.8.15\r\n\r\n*java*: 1.8.0_144-b01\r\n\r\n ","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13199948/comment/16695334","id":"16695334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bendherville","name":"bendherville","key":"bendherville","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben D'Herville","active":true,"timeZone":"Australia/Melbourne"},"body":"I've attached our broker configuration.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bendherville","name":"bendherville","key":"bendherville","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben D'Herville","active":true,"timeZone":"Australia/Melbourne"},"created":"2018-11-21T22:47:18.580+0000","updated":"2018-11-21T22:47:18.580+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13199948/comment/16695340","id":"16695340","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bendherville","name":"bendherville","key":"bendherville","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben D'Herville","active":true,"timeZone":"Australia/Melbourne"},"body":"Just a thought and I haven't looked into the activemq code in detail but it seems like the data kahadb is reading in is incorrect which may indicate that a race condition occurred writing the data to disk.  i.e. is it possible that a KahaAddScheduledJobCommand and a KahaTraceCommand were stored at the same time and were given the same primary key?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bendherville","name":"bendherville","key":"bendherville","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ben D'Herville","active":true,"timeZone":"Australia/Melbourne"},"created":"2018-11-21T23:01:50.263+0000","updated":"2018-11-21T23:01:50.263+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13199948/comment/16695443","id":"16695443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"You need to test using the latest release (5.15.8) as your version is quite old and is not supported.  It's rather likely this issue has already been fixed in a newer release. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2018-11-22T01:11:13.997+0000","updated":"2018-11-22T01:11:13.997+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-7108/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|s00r9c:"}}