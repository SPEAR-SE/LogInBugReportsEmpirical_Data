{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12653240","self":"https://issues.apache.org/jira/rest/api/2/issue/12653240","key":"AMQ-4585","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-06-17T18:26:46.303+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Oct 14 17:15:42 UTC 2014","customfield_12310420":"333563","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_32134355284_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-06-24T16:29:00.755+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4585/watchers","watchCount":3,"isWatching":false},"created":"2013-06-17T18:16:25.503+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-10-14T17:15:42.811+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"The system throws at least three different types of exceptions when a subscriber receives the first pending message without cleaning the session. The test case corresponds to receiving several messages from a publisher then closing the subscriber connection and finally reconnecting with setCleanSession(false) and attempt to read the messages published while the subscriber was disconnected.\nThe exceptions thrown:\n{code}\njava.net.ProtocolException: Command from server contained an invalid message id: 1\n\tat org.fusesource.mqtt.client.CallbackConnection.completeRequest(CallbackConnection.java:723)\n\tat org.fusesource.mqtt.client.CallbackConnection.processFrame(CallbackConnection.java:762)\n\tat org.fusesource.mqtt.client.CallbackConnection.access$1500(CallbackConnection.java:51)\n\tat org.fusesource.mqtt.client.CallbackConnection$6.onTransportCommand(CallbackConnection.java:392)\n\tat org.fusesource.hawtdispatch.transport.TcpTransport.drainInbound(TcpTransport.java:659)\n\tat org.fusesource.hawtdispatch.transport.SslTransport.drainInbound(SslTransport.java:264)\n\tat org.fusesource.hawtdispatch.transport.TcpTransport$6.run(TcpTransport.java:538)\n\tat org.fusesource.hawtdispatch.internal.NioDispatchSource$3.run(NioDispatchSource.java:209)\n\tat org.fusesource.hawtdispatch.internal.SerialDispatchQueue.run(SerialDispatchQueue.java:100)\n\tat org.fusesource.hawtdispatch.internal.pool.SimpleThread.run(SimpleThread.java:77)\n{code}\n{code}\njava.lang.ArrayIndexOutOfBoundsException: 0\n\tat org.fusesource.mqtt.codec.MessageSupport$AckBase.decode(MessageSupport.java:81)\n\tat org.fusesource.mqtt.codec.PUBREC.decode(PUBREC.java:40)\n\tat org.fusesource.mqtt.client.CallbackConnection.processFrame(CallbackConnection.java:749)\n\tat org.fusesource.mqtt.client.CallbackConnection.access$1500(CallbackConnection.java:51)\n\tat org.fusesource.mqtt.client.CallbackConnection$6.onTransportCommand(CallbackConnection.java:392)\n\tat org.fusesource.hawtdispatch.transport.TcpTransport.drainInbound(TcpTransport.java:659)\n\tat org.fusesource.hawtdispatch.transport.SslTransport.drainInbound(SslTransport.java:264)\n\tat org.fusesource.hawtdispatch.transport.TcpTransport$6.run(TcpTransport.java:538)\n\tat org.fusesource.hawtdispatch.internal.NioDispatchSource$3.run(NioDispatchSource.java:209)\n\tat org.fusesource.hawtdispatch.internal.SerialDispatchQueue.run(SerialDispatchQueue.java:100)\n\tat org.fusesource.hawtdispatch.internal.pool.SimpleThread.run(SimpleThread.java:77)\n{code}\n{code}\njava.net.ProtocolException: Unexpected MQTT command type: 0\n\tat org.fusesource.mqtt.client.CallbackConnection.processFrame(CallbackConnection.java:775)\n\tat org.fusesource.mqtt.client.CallbackConnection.access$1500(CallbackConnection.java:51)\n\tat org.fusesource.mqtt.client.CallbackConnection$6.onTransportCommand(CallbackConnection.java:392)\n\tat org.fusesource.hawtdispatch.transport.TcpTransport.drainInbound(TcpTransport.java:659)\n\tat org.fusesource.hawtdispatch.transport.SslTransport.drainInbound(SslTransport.java:264)\n\tat org.fusesource.hawtdispatch.transport.TcpTransport$6.run(TcpTransport.java:538)\n\tat org.fusesource.hawtdispatch.internal.NioDispatchSource$3.run(NioDispatchSource.java:209)\n\tat org.fusesource.hawtdispatch.internal.SerialDispatchQueue.run(SerialDispatchQueue.java:100)\n\tat org.fusesource.hawtdispatch.internal.pool.SimpleThread.run(SimpleThread.java:77)\n{code}\nNo message is shown in the server. The problem doesn't occur always but most of the times the first reconnection attempt is made. With setCleanSession(true) the system works fine.\nCode sample (publisher, permanently running):\n{code}\nMQTT mqtt = new MQTT();\nmqtt.setHost(url);\nmqtt.setUserName(user);\nmqtt.setPassword(password);\nmqtt.setClientId(\"test_id\");\n\nint i = 0;\nwhile (true) {\n\tBlockingConnection connection = mqtt.blockingConnection();\n\tconnection.connect();\n\tString message = \"TestMessage: \" + i;\n\tconnection.publish(\"TopicA\", message.getBytes(), QoS.AT_LEAST_ONCE, false);\n\tSystem.out.println(\"Vendor: Sent message.\");\n\n\tThread.sleep(2500);\n\tconnection.disconnect();\n\tThread.sleep(2500);\n\ti++;\n}\n{code}\nCode sample (subscriber, fails multiple times when restarting after the connection is closed):\n{code}\nBlockingConnection connection = null;\ntry {\n    MQTT = new MQTT();\n    mqtt.setHost(url);\n    mqtt.setClientId(clientId);\n    mqtt.setUserName(user);\n    mqtt.setPassword(password);\n    mqtt.setCleanSession(false);\n\n    connection = mqtt.blockingConnection();\n    connection.connect();\n    Topic[] topics = {new Topic(\"TopicA\", QoS.EXACTLY_ONCE)};\n    byte[] qoses = connection.subscribe(topics);\n    int numMessages = 1;\n    while (numMessages % 10 != 0) {\n        Message message = connection.receive();\n        byte[] payload = message.getPayload();\n        String messageContent = new String(payload);\n        System.out.println(\"Received message from topic: \" + message.getTopic() + \" Message content: \" + messageContent);\n        message.ack();\n        numMessages++;\n    }\n} finally {\n    if(connection != null) {\n        try {\n            connection.disconnect();\n        } catch (Exception e) {\n            // TODO Auto-generated catch block\n            e.printStackTrace();\n        }\n    }\n}\n{code}\nThe test failed when using the current fusesource client (1.5) on ActiveMQ 5.9, on Mosquitto mqtt the code works correctly","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12588422","id":"12588422","filename":"MQTTTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"created":"2013-06-18T17:58:18.913+0000","size":9633,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12588422/MQTTTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"333891","customfield_12312823":null,"summary":"MQTT BlockingConnection.receive fails when receiving pending messages after reconnect without cleaning session","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/13685808","id":"13685808","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Not fully following the code to reproduce, best bet is to create a unit test similar to those in the activemq-mqtt module so we can run it and see the issue and ensure that the fix is preserved into the future. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-06-17T18:26:46.303+0000","updated":"2013-06-17T18:26:46.303+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/13685840","id":"13685840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"body":"Yes, well the code is not simple because I used two classes running simultaneously... The publisher always sending messages, the subscriber receiving 10 messages on each \"run\". The problem occurs when restarting the subscriber after the first run (leaving some time between runs in order to allow the publisher to publish some messages). Theoretically it would be simple to use only one class publish some messages, receive them on the subscriber, close the subscriber, publish more messages, and attempt to reconnect and receive those messages but I haven't tested this method. I should stress that the problem, although it fails frequently, doesn't occur every time, I had multiple \"runs\" of the subscriber that processed the pending messages correctly.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"created":"2013-06-17T18:50:39.587+0000","updated":"2013-06-17T18:50:39.587+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/13685855","id":"13685855","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"The test code is easy to work from so I'd try and create a unit test, I won't have time to do that before I leave for vacation but if you can create a test case the fix could be simple and I might get it in quickly. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-06-17T19:00:34.681+0000","updated":"2013-06-17T19:00:34.681+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/13686995","id":"13686995","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Was able to recreate the issue in a test, added test to trunk.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-06-18T17:37:21.543+0000","updated":"2013-06-18T17:37:21.543+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/13687012","id":"13687012","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"body":"Tentative test code disconnecting several times.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"created":"2013-06-18T17:58:18.916+0000","updated":"2013-06-18T17:58:18.916+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/13687013","id":"13687013","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"body":"I was actually trying to replicate the problem on a test but I was having some problems making the test fail consistently... I attached the code I was trying (testReceivePendingMessages), even with high values on \"numberOfRuns\" and \"messagesPerRun\" the system only fails some times. I also had problems with the tests never stopping... I don't know if it's because I am using windows or if it's something on my test code but the tests easily ended up not stopping, especially when I changed the setCleanSession to true.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"created":"2013-06-18T17:58:36.252+0000","updated":"2013-06-18T17:59:58.374+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/13687882","id":"13687882","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"body":"Forget about the locking problem when setCleanSession(true)... It was just a distraction on my part, obviously, if I clean the session there are no messages pending and the receive blocks...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pmarques","name":"pmarques","key":"pmarques","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pedro Marques","active":true,"timeZone":"Etc/UTC"},"created":"2013-06-19T11:13:21.940+0000","updated":"2013-06-19T11:13:21.940+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/13688443","id":"13688443","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"The problem is a tricky one, it looks like there might be an issue in the MQTT client.  The issue happens on subscribe when for some reason the client receives two SUBACK frames when there appears to only have been one sent.  You can see it in this trace log where the SUBSCRIBE followed by a PUBLISH results in two SUBACK frames and the second one causes the client to bail.  \n\n{noformat}\n2013-06-19 16:50:40,556 | DEBUG | MQTTProtocolConverter          | MQTT Client MQTT-Sub-Client connected.\n2013-06-19 16:50:40,557 | INFO  | MQTTTest                       | Client Received:\nMQTTFrame { type: CONNACK, qos: AT_MOST_ONCE, dup:false }\n2013-06-19 16:50:40,557 | INFO  | MQTTTest                       | MQTT login accepted\n2013-06-19 16:50:40,557 | INFO  | MQTTTest                       | Client Sent:\nMQTTFrame { type: SUBSCRIBE, qos: AT_LEAST_ONCE, dup:false }\n2013-06-19 16:50:40,559 | TRACE | MQTTIO                         | Received: \nMQTTFrame { type: SUBSCRIBE, qos: AT_LEAST_ONCE, dup:false }\n2013-06-19 16:50:40,562 | TRACE | MQTTIO                         | Sending: \nMQTTFrame { type: SUBACK, qos: AT_MOST_ONCE, dup:false }\n2013-06-19 16:50:40,562 | TRACE | MQTTIO                         | Sending: \nMQTTFrame { type: PUBLISH, qos: AT_LEAST_ONCE, dup:false }\n2013-06-19 16:50:40,562 | INFO  | MQTTTest                       | Client Received:\nMQTTFrame { type: SUBACK, qos: AT_MOST_ONCE, dup:false }\n2013-06-19 16:50:40,562 | INFO  | MQTTTest                       | Client Received:\nMQTTFrame { type: SUBACK, qos: AT_MOST_ONCE, dup:false }\n2013-06-19 16:50:40,562 | INFO  | MQTTTest                       | Fatal connection failure: %s\njava.net.ProtocolException: Command from server contained an invalid message id: 1\n\tat org.fusesource.mqtt.client.CallbackConnection.completeRequest(CallbackConnection.java:723)\n\tat org.fusesource.mqtt.client.CallbackConnection.processFrame(CallbackConnection.java:762)\n\tat org.fusesource.mqtt.client.CallbackConnection.access$1500(CallbackConnection.java:51)\n\tat org.fusesource.mqtt.client.CallbackConnection$6.onTransportCommand(CallbackConnection.java:392)\n\tat org.fusesource.hawtdispatch.transport.TcpTransport.drainInbound(TcpTransport.java:659)\n\tat org.fusesource.hawtdispatch.transport.TcpTransport$6.run(TcpTransport.java:538)\n\tat org.fusesource.hawtdispatch.internal.NioDispatchSource$3.run(NioDispatchSource.java:209)\n\tat org.fusesource.hawtdispatch.internal.SerialDispatchQueue.run(SerialDispatchQueue.java:100)\n\tat org.fusesource.hawtdispatch.internal.pool.SimpleThread.run(SimpleThread.java:77)\n2013-06-19 16:50:40,563 | INFO  | MQTTTest                       | Client Received:\nMQTTFrame { type: PUBLISH, qos: AT_LEAST_ONCE, dup:false }\n2013-06-19 16:50:40,564 | INFO  | BrokerService                  | Apache ActiveMQ 5.9-SNAPSHOT (localhost, ID:OfficePC-37216-1371675037999-0:1) is shutting down\n{noformat}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-06-19T20:53:57.506+0000","updated":"2013-06-19T20:53:57.506+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/14042322","id":"14042322","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This appears to have been fixed in the MQTT hardening that went into the 5.10.0 release.  If any new issues like this emerge please create a new issue to track with tests. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-06-24T16:29:00.777+0000","updated":"2014-06-24T16:29:00.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/14170566","id":"14170566","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davydewaele","name":"davydewaele","key":"davydewaele","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Davy De Waele","active":true,"timeZone":"Etc/UTC"},"body":"[~tabish121] Can you confirm that work was done on AcitveMQ for this ? I also feel like this is an issue on the MQTT Client (FuseSource) \n\nWe're seeing the exact same issue on our stack:\n\n- Apache Active MQ 5.10.0\n- Camel 2.14\n- MQTT Client 1.10.0 (FuseSource)\n\nThere appears to be a github issue for it as well : https://github.com/fusesource/mqtt-client/issues/26","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davydewaele","name":"davydewaele","key":"davydewaele","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Davy De Waele","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-14T06:22:48.054+0000","updated":"2014-10-14T06:22:48.054+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/14170740","id":"14170740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"There are fixes to both the client and the MQTT support on the broker.  You should run with the latest release of both.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-10-14T10:10:08.689+0000","updated":"2014-10-14T10:10:08.689+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/14171220","id":"14171220","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davydewaele","name":"davydewaele","key":"davydewaele","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Davy De Waele","active":true,"timeZone":"Etc/UTC"},"body":"I think there is still an issue with the FuseSource client (Even the latest version). It's easy to reproduce the timing issue. See the Github issue for more details. The issue in the latest FuseSource client is that a PUBACK can be processed before the PUB was completed.\n\nWhen the client sends a PUB over the wire it can happen that it immediately starts processing the PUBACK before it finished its internal bookkeeping on the PUB. (FuseSource thinks the PUBACK is an invalid message id because it hasn't fully registered the PUB yet).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davydewaele","name":"davydewaele","key":"davydewaele","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Davy De Waele","active":true,"timeZone":"Etc/UTC"},"created":"2014-10-14T17:05:22.294+0000","updated":"2014-10-14T17:05:22.294+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12653240/comment/14171232","id":"14171232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"You'll need to try and raise the priority of that with the Fuse client project.  I beleive the broker side troubles have been resolved in this area.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-10-14T17:15:42.811+0000","updated":"2014-10-14T17:15:42.811+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4585/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1ljif:"}}