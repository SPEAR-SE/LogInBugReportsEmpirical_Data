{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12694932","self":"https://issues.apache.org/jira/rest/api/2/issue/12694932","key":"AMQ-5048","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2014-02-13T11:12:50.815+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 13 11:12:50 UTC 2014","customfield_12310420":"373440","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_14587349_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-02-13T11:13:41.773+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5048/watchers","watchCount":3,"isWatching":false},"created":"2014-02-13T07:10:34.474+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["newbie"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323282","id":"12323282","description":"Maintenance release with new AMQP support and smaller modules","name":"5.8.0","archived":false,"released":true,"releaseDate":"2013-02-11"}],"issuelinks":[{"id":"12382971","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12382971","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"outwardIssue":{"id":"12482705","key":"AMQ-2832","self":"https://issues.apache.org/jira/rest/api/2/issue/12482705","fields":{"summary":"Possible replay of old messages post index recovery from journal - data files containing acks reclaimed/cleaned up in error","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-02-13T11:13:41.797+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"},{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"It was an accident when our system ran out of free disk space. ActiveMQ broker was shut down but after disk clean it failed to start with throwing an exception:\n\n2014-01-31 07:59:46,297 | ERROR | Failed to page in more queue messages  | org.apache.activemq.broker.region.Queue | ActiveMQ BrokerService[CORE_FuseMQ] Task-149\njava.lang.RuntimeException: java.lang.RuntimeException: java.io.IOException: Could not locate data file /opt/broker/data/kahadb/db-97203.log\n        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.reset(AbstractStoreCursor.java:113)\n        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.reset(StoreQueueCursor.java:157)\n        at org.apache.activemq.broker.region.Queue.doPageInForDispatch(Queue.java:1775)\n        at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:2003)\n        at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1491)\n        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)\n        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)\n        at java.lang.Thread.run(Thread.java:662)st\nCaused by: java.lang.RuntimeException: java.io.IOException: Could not locate data file /opt/broker/data/kahadb/db-97203.log\n        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:277)\n        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.reset(AbstractStoreCursor.java:110)\n        ... 9 more\nCaused by: java.io.IOException: Could not locate data file /opt/broker/data/kahadb/db-97203.log\n        at org.apache.activemq.store.kahadb.disk.journal.Journal.getDataFile(Journal.java:353)\n        at org.apache.activemq.store.kahadb.disk.journal.Journal.read(Journal.java:600)\n        at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:939)\n        at org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:1029)\n        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore$4.execute(KahaDBStore.java:557)\n        at org.apache.activemq.store.kahadb.disk.page.Transaction.execute(Transaction.java:779)\n        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.recoverNextMessages(KahaDBStore.java:546)\n        at org.apache.activemq.store.ProxyMessageStore.recoverNextMessages(ProxyMessageStore.java:106)\n        at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:97)\n        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:274)\n        ... 10 more\n2014-01-31 07:59:47,305 | ERROR | Looking for key 97203 but not found in fileMap: {55354=db-55354.log number = 55354 , length = 33563112, 93728=db-93728.log number = 93728 , length = 33554796, 9373\n2014-01-31 07:59:47,307 | ERROR | org.apache.activemq.broker.region.cursors.QueueStorePrefetch@3a252a17:mdm.kis,batchResetNeeded=false,storeHasMessages=true,size=157,cacheEnabled=false,maxBatchSize\njava.io.IOException: Could not locate data file /opt/broker/data/kahadb/db-97203.log\n        at org.apache.activemq.store.kahadb.disk.journal.Journal.getDataFile(Journal.java:353)\n        at org.apache.activemq.store.kahadb.disk.journal.Journal.read(Journal.java:600)\n        at org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:939)\n        at org.apache.activemq.store.kahadb.KahaDBStore.loadMessage(KahaDBStore.java:1029)\n        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore$4.execute(KahaDBStore.java:557)\n        at org.apache.activemq.store.kahadb.disk.page.Transaction.execute(Transaction.java:779)\n        at org.apache.activemq.store.kahadb.KahaDBStore$KahaDBMessageStore.recoverNextMessages(KahaDBStore.java:546)\n        at org.apache.activemq.store.ProxyMessageStore.recoverNextMessages(ProxyMessageStore.java:106)\n        at org.apache.activemq.broker.region.cursors.QueueStorePrefetch.doFillBatch(QueueStorePrefetch.java:97)\n        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.fillBatch(AbstractStoreCursor.java:274)\n        at org.apache.activemq.broker.region.cursors.AbstractStoreCursor.reset(AbstractStoreCursor.java:110)\n        at org.apache.activemq.broker.region.cursors.StoreQueueCursor.reset(StoreQueueCursor.java:157)\n        at org.apache.activemq.broker.region.Queue.doPageInForDispatch(Queue.java:1775)\n        at org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:2003)\n        at org.apache.activemq.broker.region.Queue.iterate(Queue.java:1491)\n        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:129)\n        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:47)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)\n[...]\n\nWe rebuilt metadata as described here: https://access.redhat.com/site/documentation/en-US/Fuse_MQ_Enterprise/7.1/html/Configuring_Broker_Persistence/files/KahaDB-Recovery.html \n\nPerformed steps to rebuild:\n1. Stop broker\n2. Delete db.data\n3. Start broker\n\nAfterwards broker started correctly without exceptions. Problem is that some new messages appeared in queues. Those queues had zero messages before metadata recovery. Appeared messages were quite outdated and already delivered several months ago. This is dangerous behaviour because unexpected redelivery in some cases may bring harm to consumers. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"373740","customfield_12312823":null,"summary":"Unexpected message redelivery after KahaDB metadata recovery","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=AntonGoncharov","name":"AntonGoncharov","key":"antongoncharov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anton Goncharov","active":true,"timeZone":"Europe/Moscow"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=AntonGoncharov","name":"AntonGoncharov","key":"antongoncharov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10442","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10442","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10442","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10442"},"displayName":"Anton Goncharov","active":true,"timeZone":"Europe/Moscow"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux version 2.6.18-274.7.1.el5 (mockbuild@builder10.centos.org) (gcc version 4.1.2 20080704 (Red Hat 4.1.2-51)) #1 SMP Thu Oct 20 16:21:01 EDT 2011\n\nJava(TM) SE Runtime Environment (build 1.6.0_45-b06)\nJava HotSpot(TM) 64-Bit Server VM (build 20.45-b01, mixed mode)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12694932/comment/13900221","id":"13900221","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"this looks like a duplicate of https://issues.apache.org/jira/browse/AMQ-2832 which was fully resolved in 5.9 with the work on https://issues.apache.org/jira/browse/AMQ-4212","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2014-02-13T11:12:50.815+0000","updated":"2014-02-13T11:12:50.815+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5048/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1scsn:"}}