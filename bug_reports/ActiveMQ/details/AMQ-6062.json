{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12916122","self":"https://issues.apache.org/jira/rest/api/2/issue/12916122","key":"AMQ-6062","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12333874","id":"12333874","name":"5.12.2","archived":false,"released":true,"releaseDate":"2016-01-11"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334251","id":"12334251","name":"5.13.1","archived":false,"released":true,"releaseDate":"2016-02-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334188","id":"12334188","name":"5.14.0","archived":false,"released":true,"releaseDate":"2016-08-05"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-11-25T18:43:13.605+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Dec 02 17:51:35 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_621410533_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-12-02T15:59:18.402+0000","workratio":0,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6062/watchers","watchCount":5,"isWatching":false},"created":"2015-11-25T11:22:27.906+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"6.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":86400,"aggregatetimeoriginalestimate":86400,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329258","id":"12329258","name":"5.12.0","archived":false,"released":true,"releaseDate":"2015-08-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-12-02T17:51:35.019+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":86400,"customfield_12310080":null,"description":"Hello,\nThe Broker may enter a state of high CPU consumption (100% or 200% if 2 browse enter the infinite loop in the same time on a multi-core) when a command line browse on multiple queues is issued. When that arrives the only way we found to restore the situation was to kill the broker and restart because he was not responding anymore to clients. Killing the clients and the browse process does not lower the CPU usage of the broker.\nI assume the infinite loop based on successive thread dumps that show the browse thread remaines in the same code zone:\n\nHere is an example of the Browse thread call stack trace, when Broker is in high CPU usage state:\n{quote}\nat java/util/HashMap.rehash(HashMap.java:782(Compiled Code))\nat java/util/HashMap.rehash(HashMap.java:819(Compiled Code))\nat java/util/HashMap.putImpl(HashMap.java:702(Compiled Code))\nat java/util/HashMap.put(HashMap.java:680(Compiled Code))\nat org/apache/activemq/broker/region/*QueueBrowserSubscription.isDuplicate(QueueBrowserSubscription.java:72*(Compiled Code))\nat org/apache/activemq/broker/region/*Queue.iterate(Queue.java:1688*(Compiled Code))\nat org/apache/activemq/thread/PooledTaskRunner.runTask(PooledTaskRunner.java:133(Compiled Code)).\n{quote}\n\nTested ActiveMQ versions: 5.9.1 and the last, 5.12.0, but of course I suppose all in beetwen are affected.\n\nThe cause seems to be the non-threadsafe usage of the *audit HashMap* member of *QueueBrowserSubscription.java* class.\nHere are some facts on non thread-safe HashMap use problems:\n*High CPU / Hang on java.util.HashMap.findNonNullKeyEntry() due to non-thread-safe usage of HashMap*\nhttp://www-01.ibm.com/support/docview.wss?uid=swg21597581\n*IZ73767: INFINITE LOOP CAN OCCUR IN HASHMAP*\nhttp://www-01.ibm.com/support/docview.wss?uid=swg1IZ73767\n\nI must underline that *this is not an IBM JDK specific problem as the IBM JDK is based on Oracle JDK* and changing the JDK or JRE is not a solution.\n\nThe scenario may be produced with a fresh non modified install (default config) of ActiveMQ broker:\n1. set ACTIVEMQ_HOME, JAVA_HOME and PATH to point accordingly to the right activemq, and Java version.\n2. cd $ACTIVEMQ_HOME/bin; ./activemq start\n3. inject at least 2000 messages in each of two ques, say QA.ONE and QA.TWO\n4. $ $ACTIVEMQ_HOME/bin/activemq browse --view JMSDestination,JMSMessageID --amqurl tcp://localhost:61616 QA.*\n\nThe simplest fix that I suggest is to change in the *QueueBrowserSubscription.java* class the type of *audit* member to *ConcurrentHashMap*.","customfield_10010":null,"timetracking":{"originalEstimate":"24h","remainingEstimate":"24h","originalEstimateSeconds":86400,"remainingEstimateSeconds":86400},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12774337","id":"12774337","filename":"ActiveMQ_BrowseInfiniteLoopUseCase.jmx","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-11-25T13:11:06.857+0000","size":14524,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12774337/ActiveMQ_BrowseInfiniteLoopUseCase.jmx"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12775308","id":"12775308","filename":"activemq-test.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T14:56:11.802+0000","size":10543,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12775308/activemq-test.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12775318","id":"12775318","filename":"AMQ6062Test.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T15:31:37.751+0000","size":9071,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12775318/AMQ6062Test.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12775319","id":"12775319","filename":"HotSpotThreadDump.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T15:31:37.755+0000","size":48304,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12775319/HotSpotThreadDump.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12775321","id":"12775321","filename":"IBMjava7AndAMQMaster.javacore.20151202.161643.18441.0001.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T15:35:44.980+0000","size":442745,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12775321/IBMjava7AndAMQMaster.javacore.20151202.161643.18441.0001.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12774338","id":"12774338","filename":"ThreadStatusAnalysis_2015-11-25_14h13m33s.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-11-25T13:19:34.911+0000","size":270562,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12774338/ThreadStatusAnalysis_2015-11-25_14h13m33s.png"}],"aggregatetimeestimate":86400,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Broker goes 100% CPU on multi-queue command line browse","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":86400,"percent":0},"customfield_12311024":null,"environment":"Linux Ubuntu, Aix, with both Java 6 and Java 7 (either IBM or Oracle)","customfield_12313520":null,"customfield_12311020":"http://www-01.ibm.com/support/docview.wss?uid=swg1IZ73767","duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":86400,"percent":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15026733","id":"15026733","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"JMeter test plan to produce the bug","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-11-25T13:11:06.861+0000","updated":"2015-11-25T13:11:06.861+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15026744","id":"15026744","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"Thread dump analysis screenshot","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-11-25T13:19:34.917+0000","updated":"2015-11-25T13:19:34.917+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15027349","id":"15027349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Have you tried reproducing this with a JMS client in a Unit test, would be a useful validation of any fixes.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-11-25T18:43:13.605+0000","updated":"2015-11-25T18:43:13.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15028380","id":"15028380","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"I already attached a JMeter test plan that injects messages in 2 queues and after that starts calling browse in 2 threads.\nYou just have to adapt the paths to your ActiveMQ.\n\nIf you meant a JUnit test, no I have none. I tried first but I found it was complicated to create the QueueBrowseSubscription with all the right parameters, contexts etc. embeded Broker etc. etc.\n\nWith JMeter it was pretty easy to reproduce.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-11-26T08:59:41.348+0000","updated":"2015-11-26T09:04:17.962+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15035801","id":"15035801","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"I attached the JUnit test that produces the bug and a thread dump when it occurs.\nJust put it in /activemq-parent-5.9.1/activemq-unit-tests/src/test/java/org/apache/activemq/console/command/\nand test it.\nIt works for me with 5.9.1 tag sources and IBM java6 on Ubuntu 12.04 LTS.\nThe test is a bit complicated because I tried to make it fail() and fail fast, do a thread dump and not block or kill the JVM without a JUnit failure.\n\nI run the test from Eclipse. I just came to realise you might test from command line or other ways (in Jenkins, etc) and I did a test on command line and JUnit does not fail because the kill is faster and maven test is in success in spite of the bug detection.\nAnyway the thread dump is generated to prove the bug.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T13:41:34.655+0000","updated":"2015-12-02T14:09:51.760+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15035831","id":"15035831","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"The log is captured in /activemq-parent-5.9.1/activemq-unit-tests/target/activemq-test.log","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T14:08:06.283+0000","updated":"2015-12-02T14:08:06.283+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15035833","id":"15035833","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Have you tested it against the code on master, there is no support for 5.9.x releases so if you are looking for a fix there you will be disappointed.  Would be good for you to confirm that you see the same problem when you checkout the master branch code and run your test there.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-12-02T14:08:50.910+0000","updated":"2015-12-02T14:08:50.910+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15035840","id":"15035840","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"I'll try and I'll keep you informed.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T14:11:08.722+0000","updated":"2015-12-02T14:11:33.741+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15035906","id":"15035906","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"I attached a fixed version of the test that produces the bug on the current master sources with IBM java 7. Also the test log and a thread dump made with Java 7.\nCopy the new test in the same place in activemq-unit-tests and give it a try.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T14:56:11.810+0000","updated":"2015-12-02T14:56:11.810+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15035917","id":"15035917","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Did you also try it using the Oracle JDK or OpenJDK ?  most of use don't have a system with IBM JDK installed","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-12-02T15:00:45.795+0000","updated":"2015-12-02T15:00:45.795+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15035968","id":"15035968","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"I modified again the test to increase the number of browse tasks and the timeout because on command line it is faster.\nAnd yes I reproduced the bug wit HotSpot java and I attached the thread dump. \n\n{code}\n$ java -version\njava version \"1.7.0_51\"\nJava(TM) SE Runtime Environment (build 1.7.0_51-b13)\nJava HotSpot(TM) 64-Bit Server VM (build 24.51-b03, mixed mode)\n\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T15:31:37.759+0000","updated":"2015-12-02T15:52:47.112+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15036003","id":"15036003","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit d346a765e3064a951c5d55119b80b8432a45bcb6 in activemq's branch refs/heads/master from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=d346a76 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6062\n\nUpdated QueueBrowserSubscription to use a ConcurrentMap to avoid a\npotential race condition when multiple queue browsers browse\nmultiple queues.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-02T15:53:35.192+0000","updated":"2015-12-02T15:53:35.192+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15036006","id":"15036006","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 819e512138f55d70197949a4fae208a81ea86502 in activemq's branch refs/heads/activemq-5.13.x from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=819e512 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6062\n\nUpdated QueueBrowserSubscription to use a ConcurrentMap to avoid a\npotential race condition when multiple queue browsers browse\nmultiple queues.\n\n(cherry picked from commit d346a765e3064a951c5d55119b80b8432a45bcb6)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-02T15:55:29.525+0000","updated":"2015-12-02T15:55:29.525+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15036010","id":"15036010","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 58359a85d86f1d578fd706c06763ca6b0cec0a2d in activemq's branch refs/heads/activemq-5.12.x from [~cshannon]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=58359a8 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6062\n\nUpdated QueueBrowserSubscription to use a ConcurrentMap to avoid a\npotential race condition when multiple queue browsers browse\nmultiple queues.\n\n(cherry picked from commit d346a765e3064a951c5d55119b80b8432a45bcb6)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-02T15:56:28.670+0000","updated":"2015-12-02T15:56:28.670+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15036017","id":"15036017","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~doomytroo], Thanks for the test case and suggested fix.  I was able to see with the test case and your description that there is indeed a race condition so I went ahead and updated to use a ConcurrentMap to avoid the issue going forward.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2015-12-02T15:59:18.425+0000","updated":"2015-12-02T15:59:18.425+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15036224","id":"15036224","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"body":"Thank you very much. I tested your fix with HotSpot and IBM and it's OK.\nIn case you want to add the test on Git repo you'll have to work on it because it is not deterministic depending on timeout and browse task count parameters when the timeout arrives before all browse finish. It needs to be fixed to be fast enough but nut so fast :) (to produce the bug), and deterministic.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=doomytroo","name":"doomytroo","key":"doomytroo","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dumitru HUSLEAG","active":true,"timeZone":"Europe/Paris"},"created":"2015-12-02T17:40:15.496+0000","updated":"2015-12-02T17:40:15.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12916122/comment/15036248","id":"15036248","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Yeah, since the test wasn't completely reliable I left it out for now.  If I get time I can go back and look at it but there are already a bunch of other queue browser tests that exist which should catch any problems with this commit.  It was a pretty straight forward fix so it should be fine.\n\n5.12.2 should hopefully be released pretty soon (maybe a week or 2) and it will have the fix.  5.13.1 will also have it and that will go out in probably 1-2 months.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2015-12-02T17:51:35.019+0000","updated":"2015-12-02T17:51:35.019+0000"}],"maxResults":17,"total":17,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6062/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2ox8f:"}}