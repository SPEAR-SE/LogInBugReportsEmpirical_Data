{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12770461","self":"https://issues.apache.org/jira/rest/api/2/issue/12770461","key":"AMQ-5542","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329382","id":"12329382","name":"5.11.1","archived":false,"released":true,"releaseDate":"2015-02-17"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329258","id":"12329258","name":"5.12.0","archived":false,"released":true,"releaseDate":"2015-08-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-01-27T21:35:24.683+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Feb 02 13:07:37 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_491223524_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-02-02T13:07:37.075+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5542/watchers","watchCount":6,"isWatching":false},"created":"2015-01-27T20:40:33.648+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326456","id":"12326456","name":"5.10.1","archived":false,"released":true,"releaseDate":"2015-01-20"}],"issuelinks":[{"id":"12428254","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12428254","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12786968","key":"AMQ-5695","self":"https://issues.apache.org/jira/rest/api/2/issue/12786968","fields":{"summary":"KahaDB not cleaning up log files","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}},{"id":"12406946","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12406946","type":{"id":"12310050","name":"Regression","inward":"is broken by","outward":"breaks","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310050"},"inwardIssue":{"id":"12483957","key":"AMQ-2736","self":"https://issues.apache.org/jira/rest/api/2/issue/12483957","fields":{"summary":"KahaDB doesn't clean up old files","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-06-18T17:50:58.659+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"AMQ-2832 was not fixed cleanly.\nThe commit dd68c61e65f24b7dc498b36e34960a4bc46ded4b by Gary from 8.10.2010 introduced a problem by deleting too many files.\n\nScenarios we are facing currently in production:\nData file #1 contains unconsumed messages sitting in a DLQ. So this file is not a cleanup candidate.\nThe next file #2 contains acks of some messages from file #1. This file is not a cleanup candidate (because of ackMessageFileMap logic).\nThe next file #3 contains acks of some messages from file #2. And this file is deleted during the cleanup procedure. So on Broker restart all messages from #2, whose acks were from the deleted file #3, are replayed!\nThe reason is gcCandidates variable, which is a copy of gcCandidateSet (see MessageDatabase#checkpointUpdate at the end of the method - org/apache/activemq/store/kahadb/MessageDatabase.java:1659 on 5.10.0 tag). So when a candidate is deleted from gcCandidateSet (org/apache/activemq/store/kahadb/MessageDatabase.java:1668 on 5.10.0 tag), gcCandidates still contains that candidate and the comparison on org/apache/activemq/store/kahadb/MessageDatabase.java:1666 works wrong!\nI will try to adjust AMQ2832Test.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12694864","id":"12694864","filename":"AdjustedAMQ2832Test.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-27T22:38:12.652+0000","size":3474,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12694864/AdjustedAMQ2832Test.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12694867","id":"12694867","filename":"AMQ-5542.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-27T22:39:44.549+0000","size":1554,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12694867/AMQ-5542.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"KahaDB data files containing acknowledgements are deleted during cleanup","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14294232","id":"14294232","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"body":"Doesn't the logic described here imply that we're almost never going to be able to delete data files that follow the first unconsumed message?  Won't it usually be true that there's at least one ack in file N+1 of a message in file N, for all values of N, so file N+1 will always need to stick around for as long as N does?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"created":"2015-01-27T21:35:24.683+0000","updated":"2015-01-27T21:35:24.683+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14294326","id":"14294326","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"body":"This is an adjustment test for AMQ2832Test.java which fails currently on trunk, 5.10.1, and 5.10.0.\nThe adjustment is relative to the trunk version of AMQ2832Test.java.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-27T22:38:12.662+0000","updated":"2015-01-27T22:38:12.662+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14294329","id":"14294329","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"body":"This is the possible patch.\nJust removed the copy of gcCandidateSet. It is unclear to me what was the purpose of this copy.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-27T22:39:44.557+0000","updated":"2015-01-27T22:39:44.557+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14294333","id":"14294333","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"body":"The consequence of the fix is that if you are really unlucky you will get all files blocked beginning from the one with unconsumed message/messages through all next files containing acks pointing to the files before them.\nSo having some unconsumed messages for a long term (like messages in a DLQ) in such an unlucky case will eat quite a lot of space.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-27T22:42:36.794+0000","updated":"2015-01-27T22:42:36.794+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14294349","id":"14294349","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"body":"AMQ-2736 actually introduced the problem. See the comment of Gary https://issues.apache.org/jira/browse/AMQ-2736#comment-12942986.\nIt was thought to be a logical error, but it was not. It is not possible just to drop the files, when they contain acks pointing to other files, which are blocked.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-27T22:48:45.818+0000","updated":"2015-01-27T22:49:01.899+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14294463","id":"14294463","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"body":"Tim, I think, you are right. Otherwise KahaDB will loose acks and replay messages.\nIf this is true, than the current cleanup mechanism have to be reconsidered. It will not work well for scenarios, where messages may stay unconsumed for some time. Some sort of compaction has to be done.\nIn the current project we have nearly always some messages in DLQs sitting there for maximum 2 days. This means that we would always have nearly all data files for the last two days.\nCurrently it is ok, we have enough of place on the SAN. But what if that would be 2 weeks instead of 2 days?\nI think in this case we would use JDBC storage.\nAnother possibility would be to use mKahaDB and put DLQs to a separate storage. That storage would not grow fast since there would not be much traffic.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-28T00:18:20.739+0000","updated":"2015-01-28T00:19:01.005+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14295309","id":"14295309","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"mKahaDB is the current answer to the need for compaction/rewrite problem. that is why it emerged. Partition based on the average length of time a message spends in a queue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-28T15:45:09.549+0000","updated":"2015-01-28T15:45:09.549+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14295399","id":"14295399","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"To Tim's point -- if there is *any* content in the data file that means it is needed, then the file must not be removed.  That problem exists even for messages - one, small message can hold an entire data file.\n\nTherefore, if there is an acknowledgement in the data file that still needs to be processed, the data file must not be removed.\n\nAs Gary mentioned, multi-kahadb can be used to better prevent the scenario of large holes in data files.\n\nKeep in mind - it's in the JMS specification that consumers are expected to be \"timely\" (I forget the exact wording).  ActiveMQ (and other JMS solutions) are not \"message stores\" - using them as such leads to many issues.  If messages need to be stored for a length of time, I generally recommend adding a store to the architecture and moving those messages out of ActiveMQ and into the store as-needed.\n\nWith that said, a solution to the compaction problem would be quite welcome.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2015-01-28T17:04:52.343+0000","updated":"2015-01-28T17:04:52.343+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14295447","id":"14295447","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"body":"Consumers can be timely but unsuccessful, leading to messages going to the DLQ, where they can cause exactly this kind of behavior.  So as ActiveMQ is currently implemented the expectation Art referenced (that consumers be timely) needs to be applied to the DLQ as well, which isn't how I'd expect to need to interact with a DLQ.  I would assume that I could come in the next morning, see that there were messages in the DLQ that failed for some reason, and decide what to do about them.  But even if we simply fix this bug by not deleting the KahaDB files that are still needed (potentially all of them), then the consequence of that is going to be potentially large KahaDB disk usage for just a few messages, which I think most developers/admins won't be expecting.\n\nThe way I just described interacting with the DLQ does in fact use it as a message store, and I think that's a valid use case.\n\nI think that fixing this specific bug is better than not (high disk usage is better than invalid message redelivery, IMO), but I think another solution (which could be mKahaDB, or something else such as having a separate KahaDB for the DLQ) is still needed (in a separate JIRA enhancement).  I submitted AMQ-5547 to capture that need.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"created":"2015-01-28T17:34:09.877+0000","updated":"2015-01-28T17:34:09.877+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14296173","id":"14296173","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"body":"This is correct. This is what we have in production. We have some messages in DLQs. They stay there for max 2 days. After that a special job removes messages older than 2 days from the DLQs.\nNow we expect that ActiveMQ will always retain nearly all data files for the last two days because of those messages in the DLQs. So this would take quite a lot of space I think and we did not expect that when we set up the servers - may be we will have to get a larger SAN volume for that.\n\nAnother consideration is that this is not only the space which will be eaten by KahaDB but also the time ActiveMQ needs to recover after the crash. ActiveMQ will need quite a lot of time to replay all the data files which are sitting there just because of several DLQ messages.\nAnd the periodic cleanup may take more time to check all the data files (and KahaDB cleanup is a single threaded storage blocking operation).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=barlabanov","name":"barlabanov","key":"barlabanov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sergiy Barlabanov","active":true,"timeZone":"Europe/Berlin"},"created":"2015-01-29T00:52:44.087+0000","updated":"2015-01-29T00:52:44.087+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14296281","id":"14296281","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"body":"One option to work around this problem might be to have a job that periodically consumes all DLQ messages and re-sends them to the DLQ as a new message.  That way the dead messages are always near the newest messages in KahaDB and it can delete the old files.  You'll lose metadata about when the original message was sent/received/etc., but that may be better than what you have now.  (And you could always wrap the original message, with all its metadata, in a wrapper message if you wanted to keep that info.)  This should still get fixed and the improvement I submitted should still get implemented, but that workaround might get you by until the improvement gets implemented.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tbain98","name":"tbain98","key":"tbain98","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tim Bain","active":true,"timeZone":"America/Denver"},"created":"2015-01-29T02:28:34.988+0000","updated":"2015-01-29T02:28:34.988+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14296330","id":"14296330","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"body":"DLQs are a common cause of this problem.  My recommendation when using DLQs is *always* have a plan for handling them and consume them in a timely manner.\n\nAgain, if the messages need to be stored for a period of time (like 2 days), the best approach is to get them out of ActiveMQ and put them in some type of message store.  Another consideration of this use-case: keeping the messages for this period means some manual action is expected.  ActiveMQ is not designed to give \"random access\" to messages, which would typically be needed for manual intervention, but instead to produce and consume as a queue.  This use-case would be better served with a database in which individual messages could be referenced.\n\nRegardless, this is how ActiveMQ currently functions.  Until something better is implemented, these data files must not be deleted until they are no longer used.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artnaseef","name":"artnaseef","key":"artnaseef","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10443","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10443","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10443","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10443"},"displayName":"Arthur Naseef","active":true,"timeZone":"America/Phoenix"},"created":"2015-01-29T03:31:07.248+0000","updated":"2015-01-29T03:31:07.248+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14296645","id":"14296645","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"i will review and try and recall the need for the copy. great find. patch with test case is always much appreciated :-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-01-29T09:49:54.926+0000","updated":"2015-01-29T09:49:54.926+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12770461/comment/14301245","id":"14301245","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"test and fix applied (reverted the change from AMQ-2736) with thanks. all tests look good. The copy looks plain wrong to me.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-02-02T13:07:37.115+0000","updated":"2015-02-02T13:07:37.115+0000"}],"maxResults":14,"total":14,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5542/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i24v0f:"}}