{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12521829","self":"https://issues.apache.org/jira/rest/api/2/issue/12521829","key":"AMQ-3488","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2011-09-11T19:56:39.823+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Apr 23 17:48:36 UTC 2012","customfield_12310420":"60089","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_336541213_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-09-11T19:56:39.800+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3488/watchers","watchCount":0,"isWatching":false},"created":"2011-09-07T22:27:38.634+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315626","id":"12315626","description":"","name":"5.5.0","archived":false,"released":true,"releaseDate":"2011-04-01"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-04-23T17:48:36.244+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"ActiveMQTempDestinations hold onto the source connection that created them. When the source connection is closed, its temporary destinations are deleted. Unfortunately, DestinationInfo commands convey the destination object with its source connection to all other connections on the same VMTransportServer. Hence when these other connections are closed, they attempt to delete the source connection's temporary destination.\n\nNote that enabling marshaling on the VM transport works around this bug because destination serialization and deserialization does not maintain the source connection reference.\n\nThis bug was not present in 5.4.2.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12493522","id":"12493522","filename":"TempQueueDeleteOnCloseTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dretzlaff","name":"dretzlaff","key":"dretzlaff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Retzlaff","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-07T22:28:34.674+0000","size":994,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12493522/TempQueueDeleteOnCloseTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59343","customfield_12312823":null,"summary":"Temporary destinations' DestinationInfo commands over VM transport prevent connection closure","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dretzlaff","name":"dretzlaff","key":"dretzlaff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Retzlaff","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dretzlaff","name":"dretzlaff","key":"dretzlaff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Retzlaff","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521829/comment/13099616","id":"13099616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dretzlaff","name":"dretzlaff","key":"dretzlaff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Retzlaff","active":true,"timeZone":"America/Los_Angeles"},"body":"The attached test case demonstrates this bug by having a consumer active on the source connection, which causes a \"Consumer is consuming from the temporary destination\" exception when a separate connection is created and closed.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dretzlaff","name":"dretzlaff","key":"dretzlaff","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dan Retzlaff","active":true,"timeZone":"America/Los_Angeles"},"created":"2011-09-07T22:28:34.733+0000","updated":"2011-09-07T22:28:34.733+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521829/comment/13102334","id":"13102334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Fixed in trunk, thanks for the great test case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-09-11T19:56:39.823+0000","updated":"2011-09-11T19:56:39.823+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12521829/comment/13259771","id":"13259771","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"body":"I have some additional notes about some other side effects I've encountered that I can attribute to this same bug.  Just posting them here in case anyone else not running 5.6.0 yet is running into them and trying to figure out what is going on.\n\nI noticed that, when using a temporary destination and then closing a connection and subsequently receiving the \"Consumer is consuming...\" exception, the consumer for the queue I closed a connection to was left dangling.\n\nThat is, I start up my application with X amount of consumers and look at the queue via JMX under org.apache.activemq->myBrokerName->Queue->myQueuName->Attributes->Subscriptions\nand see X amount subscriptions to that queue as expected.  I then instruct my application to shut down Y amount of consumers, and the Subscriptions count remains at X instead of the expected value of X - Y = Z.\n\nIf I disable the portion of my application that uses the temporary queue, then no exceptions happen, and the above shutdown test does cause the Subscriptions count to drop to Z accordingly.\n\n\nWhat's worse is that it's not just excess JMX ObjectNames left behind, but the actual consumer subscriptions they relate to are also still there and registered with ActiveMQ / bound to that queue as MessageListeners.  That can be verified via JMX as well, under org.apache.activemq->myBrokerName->Subscription->Non-Durable->Queue->myQueueName.\n\nSo what happens next is...\n\nI then trigger my application to produce a bunch of messages into myQueueName.  Most of them are consumed by the remaining Z consumers, but a certain number of them just get stuck in the queue.  And not just any number, but precisely the number Y * prefetchSize.\n\nIf I restart my entire application the messages then get re-delivered to the fresh consumers and flushed out of myQueueName.  That is, unless I don't get to it in time, at which point they expire and end up in the DLQ instead.\n\nAgain, disabling the use of temporary qeueus avoids this issue.  The problem, of course, is that I need the temps for proper app functionality!\n\n\nI also tested this scenario with the current 5.6.0-SNAPSHOT and can confirm that it does indeed resolve the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djohle","name":"djohle","key":"djohle","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Johle","active":true,"timeZone":"America/Chicago"},"created":"2012-04-23T17:48:36.143+0000","updated":"2012-04-23T17:48:36.143+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3488/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0aiy7:"}}