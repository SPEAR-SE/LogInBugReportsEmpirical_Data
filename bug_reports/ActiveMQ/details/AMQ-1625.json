{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482617","self":"https://issues.apache.org/jira/rest/api/2/issue/12482617","key":"AMQ-1625","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2008-12-22T13:22:29.414+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jul 08 13:49:46 UTC 2009","customfield_12310420":"84807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_41331413650_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-07-08T13:49:46.904+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1625/watchers","watchCount":1,"isWatching":false},"created":"2008-03-17T04:52:53.254+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-07-08T13:49:46.903+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"see attached log.\n\nin a nutshell,\n\nTransport.request(Object command) is dangerous, and shouldn't be used.\n\nTransport.request(Object command, int timeout) should be used instead.\n\nsomething happened to my broker (don't know what yet), and it caused the producer to hang as seen. then since the session is shared, a bunch of other threads blocked as well. if the request on the transport had a timeout (this is to catch failure scenarios, so something that's not expected to reasonably happen), things would have errored out rather than building waiting threads.\n\nif it is amiable, i can produce a patch that will remove the non-timeout'd version of Transport.request() and use the version with a timeout everywhere.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460941","id":"12460941","filename":"ASF.LICENSE.NOT.GRANTED--hung producers.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=proyal","name":"proyal","key":"proyal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"peter royal","active":true,"timeZone":"America/Chicago"},"created":"2008-03-17T04:52:53.327+0000","size":2018,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460941/ASF.LICENSE.NOT.GRANTED--hung+producers.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"160048","customfield_12312823":null,"summary":"Producers hang when broker is fubar","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=proyal","name":"proyal","key":"proyal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"peter royal","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=proyal","name":"proyal","key":"proyal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"peter royal","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"SNAPSHOT build from 1/16/08","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482617/comment/12939420","id":"12939420","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=proyal","name":"proyal","key":"proyal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"peter royal","active":true,"timeZone":"America/Chicago"},"body":"i was able to reproduce this by having 10 threads share a session, all sending messages to the same queue 0..100ms between sends. it failed after a few thousand messages. restarting the broker fixes the problem. the producer and broker were separate VM's.\n\ni then tried the trunk snapshot from 3/18, and the same test program worked fine.\n\ni can modify my test to see if it can happen with everything in the same VM, so a unit test can be created (if there is interest from the AMQ developers).\n\ni did a cursory review of the changes between 1/16 and 3/18 and nothing jumped out. are there any notable concurrency related bugs that were fixed in this time?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=proyal","name":"proyal","key":"proyal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"peter royal","active":true,"timeZone":"America/Chicago"},"created":"2008-03-22T18:26:07.479+0000","updated":"2008-03-22T18:26:07.479+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482617/comment/12940610","id":"12940610","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"This looks like a case of  'slow consumer' and producer flowcontrol. You can fail producers, block them or spool to disk. The default out of the box 5.2 behavior is to use producer flow control and stall/block the producer. The SystemUsage.setSendFailIfNoSpace attribute can force a failure and configuring a memory limit for message spooling can ensure memory limits are not exceeded.\n\nIn your test case, it is 10 threads sharing a connection rather than a session, correct?. A session should be reserved for a single thread.\n\nI am wondering if this issue can be closed or if you want an additional facility to enable fail with timeout when producer flow control is configured.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-22T13:22:29.414+0000","updated":"2008-12-22T13:22:29.414+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482617/comment/12940618","id":"12940618","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=proyal","name":"proyal","key":"proyal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"peter royal","active":true,"timeZone":"America/Chicago"},"body":"Thanks for the followup, Gary.\n\nI believe they were all sharing a session, but I don't recall anymore (this was at a project with a past employer, and I don't have access to the test code anymore).\n\niirc, the test was to a persistent queue, so a slow consumer shouldn't block producers. If the consumer is slow the messages would spool to disk.\n\nYou can probably close this for now.. but my thought at the time was using the method that took a timeout would help prevent blocking forever for unsuspecting users. Even if the default was several minutes, if its blocked for that long, things are likely fubar.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=proyal","name":"proyal","key":"proyal","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"peter royal","active":true,"timeZone":"America/Chicago"},"created":"2008-12-22T17:21:15.188+0000","updated":"2008-12-22T17:21:15.188+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482617/comment/12941701","id":"12941701","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"closing this following comments from reporter. no test code available","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-07-08T13:49:46.866+0000","updated":"2009-07-08T13:49:46.866+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1625/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rr6n:"}}