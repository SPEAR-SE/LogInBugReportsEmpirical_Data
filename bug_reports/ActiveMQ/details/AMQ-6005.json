{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12903653","self":"https://issues.apache.org/jira/rest/api/2/issue/12903653","key":"AMQ-6005","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12334251","id":"12334251","name":"5.13.1","archived":false,"released":true,"releaseDate":"2016-02-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334188","id":"12334188","name":"5.14.0","archived":false,"released":true,"releaseDate":"2016-08-05"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2015-10-12T13:27:18.533+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Dec 10 15:52:52 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_5379837368_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-12-10T14:26:43.703+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6005/watchers","watchCount":5,"isWatching":false},"created":"2015-10-09T08:02:46.373+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-12-10T15:52:52.992+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325017","id":"12325017","name":"KahaDB"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"h4. Background\n\nWhen multiple JVMs run AMQ in a master/slave configuration with the broker directory in a shared filesystem location (as is required e.g. for kahaPersistence), and when due to high message volume or slow producers the broker's memory needs exceed the configured memory usage limit, AMQ will overflow asynchronous messages to a PList store inside the \"tmp_storage\" subdirectory of said shared broker directory.\n\nh4. Issue\n\nWe frequently observed this tmpDB store getting corrupted with \"stale NFS filehandle\" errors for tmpDB.data, tmpDB.redo, and some journal files, all of which suddenly went missing from the tmp_storage folder. This puts the entire broker into a bad state from which it cannot recover. Only restarting the service (which causes a broker slave to take over and loses the yet-undelivered messages) gets a working state back.\n\nh4. Symptoms\n\nStack trace:\n{noformat}\n...\nCaused by: java.io.IOException: Stale file handle\n\tat java.io.RandomAccessFile.readBytes0(Native Method)\n\tat java.io.RandomAccessFile.readBytes(RandomAccessFile.java:350)\n\tat java.io.RandomAccessFile.read(RandomAccessFile.java:385)\n\tat java.io.RandomAccessFile.readFully(RandomAccessFile.java:444)\n\tat java.io.RandomAccessFile.readFully(RandomAccessFile.java:424)\n\tat org.apache.kahadb.page.PageFile.readPage(PageFile.java:876)\n\tat org.apache.kahadb.page.Transaction$2.readPage(Transaction.java:446)\n\tat org.apache.kahadb.page.Transaction$2.<init>(Transaction.java:437)\n\tat org.apache.kahadb.page.Transaction.openInputStream(Transaction.java:434)\n\tat org.apache.kahadb.page.Transaction.load(Transaction.java:410)\n\tat org.apache.kahadb.page.Transaction.load(Transaction.java:367)\n\tat org.apache.kahadb.index.ListIndex.loadNode(ListIndex.java:306)\n\tat org.apache.kahadb.index.ListIndex.getHead(ListIndex.java:99)\n\tat org.apache.kahadb.index.ListIndex.iterator(ListIndex.java:284)\n\tat org.apache.activemq.store.kahadb.plist.PList$PListIterator.<init>(PList.java:199)\n\tat org.apache.activemq.store.kahadb.plist.PList.iterator(PList.java:189)\n\tat org.apache.activemq.broker.region.cursors.FilePendingMessageCursor$DiskIterator.<init>(FilePendingMessageCursor.java:496)\n{noformat}\n\nh4. Cause\n\nDuring BrokerThread startup, the BrokerService.startPersistenceAdapter() method is called, which  via doStartPersistenceAdapter() and getProducerSystemUsage() invokes getSystemUsage(), that calls getTempDataStore(), and that method summarily cleans out the existing contents of the tmp_storage directory.\nAll of this happens *before* the broker lock is obtained in the PersistenceAdapter.start() method at the end of doStartPersistenceAdapter().\n\nSo a JVM that doesn't get to be the broker (because there already is one) and runs in slave mode (waiting to obtain the broker lock) interferes with and corrupts the running broker's tmp_storage and thus breaks the broker. That's a critical bug. The slave has no business starting up the persistence adapter and cleaning out data as it hasn't gotten the lock yet, so isn't allowed to do any work, period. \n\nh4. Workaround\n\nAs workaround, an unshared local directory needs to be specified as tempDirectory for the broker, even if the main broker directory is shared. Also, since broker startup will clear the tmp_storage out anyway, there really is no advantage to having this in a shared location - since the next broker that starts up after a broker failure will never re-use that data anyway.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Slave broker startup corrupts shared PList storage","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"RHLinux6","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12903653/comment/14953113","id":"14953113","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Have you tested against the latest release, 5.10 is relatively old at this point.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-10-12T13:27:18.533+0000","updated":"2015-10-12T13:27:18.533+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12903653/comment/14954334","id":"14954334","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"body":"Not yet - we have an AMQ 5.12 upgrade in the pipeline, but not in production use yet, and this problem is only reproduced in production use, since you need to create quite a few asynchronous topic messages to even get to use tmp_storage - while there's few messages they all stay in memory and this issue doesn't arise. Plus you need a multi-server environment. So this isn't easily reproduced in the lab.\n\nHowever the relevant code has not changed in 5.12, I've verified that. It's all in one class and should be easy enough to follow the outline in the ticket description. I've added some additional detail to make it easier to follow.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"created":"2015-10-13T04:01:09.327+0000","updated":"2015-10-13T04:15:12.919+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12903653/comment/14967709","id":"14967709","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"body":"Also, to replicate the source of the problem, you can simply hand-create empty tmpDB.data, tmpDB.redo, and db-1.log files in the shared tmp_storage folder, then restart one of the slave nodes while the master broker is still running - you will see that those files get deleted by the slave startup, which would corrupt the master broker's tmpDB if it were currently using it. So for issue replication it's not necessary to actually create enough asynchronous message load to be using tmp_storage - it's the tmpDB deletion by a *slave* that is the problem.\n\nI should also note that we'd originally been seeing this in action only when using JDBC persistence (where there's technically no need for a shared dataDirectory at all anymore). With kahaPersistence things used to go south before ever reaching this point, due to unreliable file locking over NFS, so we've moved away from that.\n(Update: it does happen with kahaPersistence too, seen it just recently, with 160 GB of error logging as a result)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"created":"2015-10-21T19:20:54.315+0000","updated":"2015-12-10T15:51:57.365+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12903653/comment/15051027","id":"15051027","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 768fa17085ac938441915a82987c99b37ac52515 in activemq's branch refs/heads/master from [~gtully]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=768fa17 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6005 - have plist whack it existing state on start. Start the temp store after the primary persistence adapter which does the locking\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-10T14:25:51.507+0000","updated":"2015-12-10T14:25:51.507+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12903653/comment/15051030","id":"15051030","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"clearing out temp store is deferred till temp store start which is now done after locking by primary store","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-10T14:26:43.728+0000","updated":"2015-12-10T14:26:43.728+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12903653/comment/15051052","id":"15051052","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"body":"Commit 9e8f0203015dd842ecc0804231da9a62ed3b02ec in activemq's branch refs/heads/activemq-5.13.x from [~gtully]\n[ https://git-wip-us.apache.org/repos/asf?p=activemq.git;h=9e8f020 ]\n\nhttps://issues.apache.org/jira/browse/AMQ-6005 - have plist whack it existing state on start. Start the temp store after the primary persistence adapter which does the locking\n\n(cherry picked from commit 768fa17085ac938441915a82987c99b37ac52515)\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jira-bot","name":"jira-bot","key":"jira-bot","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"ASF subversion and git services","active":true,"timeZone":"Etc/UTC"},"created":"2015-12-10T14:49:00.001+0000","updated":"2015-12-10T14:49:00.001+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12903653/comment/15051137","id":"15051137","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"body":"Thanks for the fix, much appreciated!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=volkerk","name":"volkerk","key":"volkerk","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Volker Kleinschmidt","active":true,"timeZone":"America/Chicago"},"created":"2015-12-10T15:52:52.992+0000","updated":"2015-12-10T15:52:52.992+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6005/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2mswf:"}}