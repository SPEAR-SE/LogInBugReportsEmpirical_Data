{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12777677","self":"https://issues.apache.org/jira/rest/api/2/issue/12777677","key":"AMQ-5618","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2015-03-06T18:06:13.715+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Feb 06 17:35:47 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_61489938152_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-02-06T14:26:13.080+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5618/watchers","watchCount":10,"isWatching":false},"created":"2015-02-25T21:53:54.996+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12329382","id":"12329382","name":"5.11.1","archived":false,"released":true,"releaseDate":"2015-02-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-02-06T17:35:47.886+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"This is very similar to AMQ-5300 except that I use replicatedLevelDB persistence adapter and in order to reproduce I don't have to delete any index files.\n\nSetup: 1 ZK instance, 3 AMQ nodes.\nOne of the AMQ configs:\n{code}\n<replicatedLevelDB directory=\"${activemq.data}/replicatedLevelDB\"\n                                replicas=\"3\"\n                                bind=\"tcp://0.0.0.0:61619\"\n                                zkAddress=\"instance-6:2181\"\n                                zkPath=\"/activemq/leveldb-stores\"\n                                hostname=\"instance-7\" />\n{code}\nDifference between nodes is only in hostname attribute.\n\nThe way to reproduce is almost the same as in AMQ-5300: \n# Produce lots of messages to generate several log files in leveldb data directory.\n# Consume _some_ messages until you see \"Deleting log\" in activemq.log.\n# Restart master. Wait for system to rebalance itself. Everything's fine at this point.\n# Restart the second master.\n# Observe the massive (infinite?) logging on slave and relatively calm but still possibly infinite logging on master.\n\nThis is what the first master logs after it's restarted:\n{code}\n2015-02-25 21:37:08,338 | DEBUG | Download session connected... | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:08,582 | INFO  | Slave skipping download of: log/00000000190be289.log | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,099 | INFO  | Slave skipping download of: log/000000000642f848.log | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,411 | INFO  | Slave skipping download of: log/000000000c85f06d.log | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,838 | INFO  | Slave skipping download of: log/0000000012c8e921.log | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,842 | INFO  | Slave requested: 000000001c9373b4.index/CURRENT | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,846 | INFO  | Slave requested: 000000001c9373b4.index/MANIFEST-000002 | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,850 | INFO  | Slave requested: 000000001c9373b4.index/000003.log | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,857 | INFO  | Attaching... Downloaded 0.02/95.65 kb and 1/3 files | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,859 | INFO  | Attaching... Downloaded 0.06/95.65 kb and 2/3 files | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,861 | INFO  | Attaching... Downloaded 95.65/95.65 kb and 3/3 files | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,862 | INFO  | Attached | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:37:09,878 | DEBUG | Taking a snapshot of the current index: /usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/000000001c9373b4.index | org.apache.activemq.leveldb.LevelDBClient | Thread-2\n2015-02-25 21:37:10,352 | DEBUG | Recovering from last index snapshot at: /usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/dirty.index | org.apache.activemq.leveldb.LevelDBClient | Thread-2\n{code}\n\nRight after that everything seems fine. But as soon as I stop the new master, the another new master (that would be the third one) logs\n\n{code}\n2015-02-25 21:38:43,876 | INFO  | Promoted to master | org.apache.activemq.leveldb.replicated.MasterElector | main-EventThread\n2015-02-25 21:38:43,894 | INFO  | Using the pure java LevelDB implementation. | org.apache.activemq.leveldb.LevelDBClient | ActiveMQ BrokerService[localhost] Task-5\n2015-02-25 21:38:45,954 | WARN  | Invalid log position: 44 | org.apache.activemq.leveldb.LevelDBClient | ActiveMQ BrokerService[localhost] Task-5\n2015-02-25 21:38:45,955 | WARN  | Invalid log position: 325280 | org.apache.activemq.leveldb.LevelDBClient | ActiveMQ BrokerService[localhost] Task-5\n...\n2015-02-25 21:38:46,696 | WARN  | Invalid log position: 104726993 | org.apache.activemq.leveldb.LevelDBClient | ActiveMQ BrokerService[localhost] Task-5\n2015-02-25 21:38:46,902 | INFO  | Master started: tcp://instance-8:61619 | org.apache.activemq.leveldb.replicated.MasterElector | ActiveMQ BrokerService[localhost] Task-6\n...\n2015-02-25 21:38:52,127 | INFO  | Initializing Spring FrameworkServlet 'dispatcher' | /admin | main\n2015-02-25 21:38:53,181 | INFO  | jolokia-agent: No access restrictor found at classpath:/jolokia-access.xml, access to all MBeans is allowed | /api | main\n2015-02-25 21:38:56,881 | WARN  | Invalid log position: 0 | org.apache.activemq.leveldb.LevelDBClient | Thread-4\n2015-02-25 21:39:06,884 | WARN  | Invalid log position: 0 | org.apache.activemq.leveldb.LevelDBClient | Thread-4\n2015-02-25 21:39:16,887 | WARN  | Invalid log position: 0 | org.apache.activemq.leveldb.LevelDBClient | Thread-4\n...\n{code}\nthe last message starts repeating every 10 seconds without hint of stopping.\nAt the same time the one left slave (that was the 1st master) logs\n{code}\n2015-02-25 21:38:50,124 | INFO  | Attached | org.apache.activemq.leveldb.replicated.SlaveLevelDBStore | hawtdispatch-DEFAULT-1\n2015-02-25 21:38:50,134 | DEBUG | Taking a snapshot of the current index: /usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/000000001c9373b4.index | org.apache.activemq.leveldb.LevelDBClient | Thread-3\n2015-02-25 21:38:50,149 | DEBUG | Recovering from last index snapshot at: /usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/dirty.index | org.apache.activemq.leveldb.LevelDBClient | Thread-3\n2015-02-25 21:38:50,189 | DEBUG | Replay of journal from: 0 to 479425460. | org.apache.activemq.leveldb.LevelDBClient | Thread-3\n2015-02-25 21:38:50,328 | WARN  | No reader available for position: 0, log_infos: {105052232=LogInfo(/usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/000000000642f848.log,105052232,105052197), 210104429=LogInfo(/usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/000000000c85f06d.log,210104429,105052340), 315156769=LogInfo(/usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/0000000012c8e921.log,315156769,105052520), 420209289=LogInfo(/usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/00000000190be289.log,420209289,0)} | org.apache.activemq.leveldb.RecordLog | Thread-3\n2015-02-25 21:38:50,332 | WARN  | No reader available for position: 0, log_infos: {105052232=LogInfo(/usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/000000000642f848.log,105052232,105052197), 210104429=LogInfo(/usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/000000000c85f06d.log,210104429,105052340), 315156769=LogInfo(/usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/0000000012c8e921.log,315156769,105052520), 420209289=LogInfo(/usr/local/apache-activemq-5.11.1/data/replicatedLevelDB/00000000190be289.log,420209289,0)} | org.apache.activemq.leveldb.RecordLog | Thread-3\n...\n{code}\nthe last message repeats infinitely and every ~1ms, with activemq process taking 100% CPU.\n\nIf I would now start the stopped node (that was the 2d master) it would log exactly the same message with the same intensity.\n\nIt should also be noted that while I can observe correct diminished (relatively to initial, due to some consumption) count of messages in a queue via console after the first restart, the second restart changes that and queue size becomes bigger (although I'm not sure if it is equal to the size of queue before any consumption).","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Infinite loop in log replay with Replicated LevelDB","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem.karpenko","name":"artem.karpenko","key":"artem.karpenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Artem Karpenko","active":true,"timeZone":"Europe/Kiev"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem.karpenko","name":"artem.karpenko","key":"artem.karpenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Artem Karpenko","active":true,"timeZone":"Europe/Kiev"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux, Google Compute Engine","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/14347030","id":"14347030","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem.karpenko","name":"artem.karpenko","key":"artem.karpenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Artem Karpenko","active":true,"timeZone":"Europe/Kiev"},"body":"For some reason these steps did not reproduce the problem on our working servers (I've setup this one separate environment). Additional step \"helped\": restart any slave between steps 2 and 3 (before restarting masters). Additionally, if you restart 2 slaves one at a time instead of one between steps 2 and 3 then it's enough to restart only one master to reproduce a problem (i.e. step 3 was not required).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem.karpenko","name":"artem.karpenko","key":"artem.karpenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Artem Karpenko","active":true,"timeZone":"Europe/Kiev"},"created":"2015-03-04T15:34:56.134+0000","updated":"2015-03-04T15:34:56.134+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/14350649","id":"14350649","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"body":"I have reported something very similar or exactly the same on issue AMQ-5553 .\nOn that ticket I have attached my levelDb data and configuration which might help get information about this issue.\n\nThis issue leaves my replicas all entering the infinite loop as when each of them becomes the master each enters the infinite loop. I have replicated this issue on 5.10 and 5.11. Artem, you say you have steps that can easily replicate this issue? I have been able to replicate them but seems mostly random.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"created":"2015-03-06T18:06:13.715+0000","updated":"2015-03-06T18:06:13.715+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/14352843","id":"14352843","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem.karpenko","name":"artem.karpenko","key":"artem.karpenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Artem Karpenko","active":true,"timeZone":"Europe/Kiev"},"body":"Hello Pablo.\nThe steps outlined above _always_ reproduce the problem for me. The steps in description alone always do it on a separate environment I've setup in Google Compute Engine. And the steps with corrrections in the first comment do the same in testing environment of our internal project. Not sure why the first variant does not \"work\" there though.\n\n<offtopic>The number and severity of bugs we've encountered when using Replicated LevelDB (f.e. see AMQ-5619, AMQ-5612, AMQ-5611) made us switch to the old solution with JDBC and HA MySQL (Google provides that). Previously we changed to Replicated LevelDB because change of master occurred rather regularly (like once a day) with JDBC and made queue counters reset. But now we'll see that as an improvement upon the current situation - at least there were no cases when store was corrupted beyond repair.</offtopic>","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=artem.karpenko","name":"artem.karpenko","key":"artem.karpenko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Artem Karpenko","active":true,"timeZone":"Europe/Kiev"},"created":"2015-03-09T11:42:22.518+0000","updated":"2015-03-09T11:42:22.518+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/14353339","id":"14353339","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"body":"Thanks Artem, I will try to reproduce it again and try to find if there exists a work around or a way to recover. \n\nSadly Replicated LevelDB currently is in a completely unusable state as this types of issues are very common and could greatly impact production systems as right now the only way to fix this is to delete all storage data from the cluster and support staff would not be able to handle this situation on time.\n\nI will check if I can get clearer information about this issue and see what I can find out, but my Scala skills are pitiful.\n\nLet me investigate too the alternative you proposed, sounds it could be useful for the moment.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"created":"2015-03-09T18:27:02.816+0000","updated":"2015-03-09T18:27:02.816+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15490395","id":"15490395","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jonatiao","name":"jonatiao","key":"jonatiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jonathan G","active":true,"timeZone":"Etc/UTC"},"body":"Hello Pablo,\n\nHave you had to chance to come up with a work around?\n\n\nThx!","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jonatiao","name":"jonatiao","key":"jonatiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jonathan G","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-14T13:06:58.689+0000","updated":"2016-09-14T13:06:58.689+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15508175","id":"15508175","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"body":"Actually no, and my team discarded the usage of Replicated Level DB\nBut on a certain hope, another team from my company started using Replicated Level DB and until now they haven't seen this issue occur.\nThey are running 5.13.3  and Java version of LevelDB. I think they have stumbled with other issues related to Zookeeper but not this one.\n\nImportant question, is this issue still occurring to you?\n\nThanks,\nPablo ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"created":"2016-09-20T23:52:07.765+0000","updated":"2016-09-20T23:52:07.765+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15513715","id":"15513715","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jonatiao","name":"jonatiao","key":"jonatiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jonathan G","active":true,"timeZone":"Etc/UTC"},"body":"Hello Pablo,\n\nYes, we have amq 5.14 and zook 3.4.8. 3 - 3 instances of each with master/slave.\nWe found the very same repl. leveldb corruption that the ticket reporter had. Our db was corrupted beyond repair.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jonatiao","name":"jonatiao","key":"jonatiao","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jonathan G","active":true,"timeZone":"Etc/UTC"},"created":"2016-09-22T16:12:42.283+0000","updated":"2016-09-22T16:12:42.283+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15513740","id":"15513740","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wbrendel","name":"wbrendel","key":"wbrendel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"William Brendel","active":true,"timeZone":"America/New_York"},"body":"Another data point: My team also encountered this issue recently, in June 2016, while evaluating replicated LevelDB storage for our application. We were using AMQ 5.13.3 and ZK 3.4.8 with 3 instances. Like Jonathan G, our database seemed to be corrupted beyond repair, causing us to eliminate replicated LevelDB as an option.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wbrendel","name":"wbrendel","key":"wbrendel","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"William Brendel","active":true,"timeZone":"America/New_York"},"created":"2016-09-22T16:26:48.602+0000","updated":"2016-09-22T16:26:48.602+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15514423","id":"15514423","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"body":"I have done some digging around.. and it seems that it will sooner or later will stop the loop.. eventually at least.\nI dont have the setup of Replicated LevelDB at hand right now but from I can see is that is basically lost track about the last position on the records of LevelDB.\n\nFrom the logs in my case it would try to iterate from 0 to the last position it knows exists. So in my case it would iterate until 32610993430.\nThe fix from AMQ-5300 seems not to be executed as this replay of the logs of LevelDB is being triggered by a call which bypasses its fix. The fix basically is not to start replaying from 0 but from the last record registered.\n\n{noformat}\n2015-01-29 19:42:55,740 -0600 WARN  56426 [ActiveMQ BrokerService[mailsystemBroker] Task-2] LevelDBClient  - Could not load message seq: 162542 from DataLocator(11e952fc, 1754)\n2015-01-29 19:42:55,740 -0600 WARN  56426 [ActiveMQ BrokerService[mailsystemBroker] Task-2] RecordLog  - No reader available for position: 11e999ce, log_infos: {32610993430=LogInfo(/m2/tomcat7.0/work/navigator-mail-mq/6009/work/repDB/0000000797c44516.log,32610993430,0)}\n2015-01-29 19:42:55,740 -0600 WARN  56426 [ActiveMQ BrokerService[mailsystemBroker] Task-2] LevelDBClient  - Could not load message seq: 162552 from DataLocator(11e999ce, 1754)\n2015-01-29 19:42:55,740 -0600 WARN  56426 [ActiveMQ BrokerService[mailsystemBroker] Task-2] RecordLog  - No reader available for position: 11e9a7f8, log_infos: {32610993430=LogInfo(/m2/tomcat7.0/work/navigator-mail-mq/6009/work/repDB/0000000797c44516.log,32610993430,0)}\n2015-01-29 19:42:55,740 -0600 WARN  56426 [ActiveMQ BrokerService[mailsystemBroker] Task-2] LevelDBClient  - Could not load message seq: 162554 from DataLocator(11e9a7f8, 1754)\n2015-01-29 19:42:55,740 -0600 WARN  56426 [ActiveMQ BrokerService[mailsystemBroker] Task-2] RecordLog  - No reader available for position: 11e9b622, log_infos: {32610993430=LogInfo(/m2/tomcat7.0/work/navigator-mail-mq/6009/work/repDB/0000000797c44516.log,32610993430,0)}\n2015-01-29 19:42:55,741 -0600 WARN  56427 [ActiveMQ BrokerService[mailsystemBroker] Task-2] LevelDBClient  - Could not load message seq: 162556 from DataLocator(11e9b622, 1754)\n{noformat}\n\nI lost most of my log files from this issue but if someone can attach then if possible at Trace level and if possible with a LevelDB included I may be able to take a look deeper. My Scala is not the best but I think I can help track the root of the issue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"created":"2016-09-22T20:39:17.257+0000","updated":"2016-09-22T20:39:17.257+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15663702","id":"15663702","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiangz","name":"xiangz","key":"xiangz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xiang Zhao","active":true,"timeZone":"Etc/UTC"},"body":"We're using version 5.13.4, and have the same issues. We have a three node cluster  using replicatedLevelDB persistence, and sometimes we shutdown one of the nodes to do failover testing, and from time to time, we got the error \"  WARN  | No reader available for position: 0\" on the master, and then we had to delete all the LevelDB folders on the three nodes to make it work again.\n\nI think it's a critical bug, hopefully someone can look further into it.\n\nThanks in advance.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=xiangz","name":"xiangz","key":"xiangz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Xiang Zhao","active":true,"timeZone":"Etc/UTC"},"created":"2016-11-14T11:39:19.729+0000","updated":"2016-11-14T11:39:19.729+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15854083","id":"15854083","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"LevelDB has been deprecated and is no longer supported.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-02-06T14:26:13.127+0000","updated":"2017-02-06T14:26:13.127+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15854412","id":"15854412","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"body":"Hey [~cshannon] could you do me a favor and point me to a place where I can find the discussion in which LevelDB was decided to be deprecated? Mailing List archive or something similar would be great.\n\nThanks","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Altaflux","name":"Altaflux","key":"altaflux","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Pablo Lozano","active":true,"timeZone":"America/Monterrey"},"created":"2017-02-06T17:27:48.903+0000","updated":"2017-02-06T17:27:48.903+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12777677/comment/15854424","id":"15854424","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"The thread is here http://activemq.2283324.n4.nabble.com/DISCUSS-LevelDB-deprecation-tp4719227.html\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2017-02-06T17:35:47.886+0000","updated":"2017-02-06T17:35:47.886+0000"}],"maxResults":13,"total":13,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5618/votes","votes":9,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2624n:"}}