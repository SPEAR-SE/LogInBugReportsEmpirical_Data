{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12721273","self":"https://issues.apache.org/jira/rest/api/2/issue/12721273","key":"AMQ-5228","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2015-09-21T09:47:03.896+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Feb 03 23:05:55 UTC 2017","customfield_12310420":"399469","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_83363525027_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-02-03T23:05:55.424+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5228/watchers","watchCount":3,"isWatching":false},"created":"2014-06-15T02:33:50.445+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-02-03T23:05:55.468+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12320200","id":"12320200","name":"activemq-leveldb-store","description":"LevelDB based message store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"In our production environment, our storage folder runs out of disk space every few days (75 Gb).  Restarting the container addresses the issue, it cleans it up.  I noticed a stack trace coming on system.err in the wrapper.log (Karaf starts with a wrapper service).  It may or may not be related to our disk space issue:\n\nINFO   | jvm 1    | 2014/06/13 03:22:36 | Exception in thread \"Thread-117\" java.lang.NoClassDefFoundError: org/fusesource/leveldbjni/internal/JniDB\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at org.apache.activemq.leveldb.LevelDBClient$RichDB.compact(LevelDBClient.scala:377)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at org.apache.activemq.leveldb.LevelDBClient.gc(LevelDBClient.scala:1647)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at org.apache.activemq.leveldb.DBManager$$anonfun$pollGc$1$$anonfun$apply$mcV$sp$2.apply$mcV$sp(DBManager.scala:648)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at org.fusesource.hawtdispatch.package$$anon$4.run(hawtdispatch.scala:357)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at java.lang.Thread.run(Thread.java:744)\nINFO   | jvm 1    | 2014/06/13 03:22:36 | Caused by: java.lang.ClassNotFoundException: org.fusesource.leveldbjni.internal.JniDB not found by org.apache.activemq.activemq-osgi [105]\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at org.apache.felix.framework.BundleWiringImpl.findClassOrResourceByDelegation(BundleWiringImpl.java:1460)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at org.apache.felix.framework.BundleWiringImpl.access$400(BundleWiringImpl.java:72)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:1843)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       at java.lang.ClassLoader.loadClass(ClassLoader.java:358)\nINFO   | jvm 1    | 2014/06/13 03:22:36 |       ... 7 more\n\n\nI see the same problem in our dev environment but could not replicate it.  I was finally able to replicate by using the hawtio console to execute the compact operation.  Everytime I do this, the same stack trace outputs and the operation cycles endlessly (well as long as I've waited anyhow).  The 5.10.0 stack trace when I execute the operation is:\n\nINFO   | jvm 2    | 2014/06/14 21:00:44 | Exception in thread \"Thread-106\" java.lang.NoClassDefFoundError: org/fusesource/leveldbjni/internal/JniDB\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at org.apache.activemq.leveldb.LevelDBClient$RichDB.compact(LevelDBClient.scala:378)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at org.apache.activemq.leveldb.LevelDBClient.gc(LevelDBClient.scala:1654)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at org.apache.activemq.leveldb.LevelDBStoreView$$anonfun$compact$1.apply$mcV$sp(LevelDBStore.scala:126)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at org.fusesource.hawtdispatch.package$$anon$4.run(hawtdispatch.scala:330)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at java.lang.Thread.run(Thread.java:744)\nINFO   | jvm 2    | 2014/06/14 21:00:44 | Caused by: java.lang.ClassNotFoundException: org.fusesource.leveldbjni.internal.JniDB not found by org.apache.activemq.activemq-osgi [390]\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at org.apache.felix.framework.BundleWiringImpl.findClassOrResourceByDelegation(BundleWiringImpl.java:1460)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at org.apache.felix.framework.BundleWiringImpl.access$400(BundleWiringImpl.java:72)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at org.apache.felix.framework.BundleWiringImpl$BundleClassLoader.loadClass(BundleWiringImpl.java:1843)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       at java.lang.ClassLoader.loadClass(ClassLoader.java:358)\nINFO   | jvm 2    | 2014/06/14 21:00:44 |       ... 7 more\n\n\nI started looking at the activemq-osgi and activemq-leveldb project poms, and noticed that the leveldbjni projects are commented out with a note that we want to focus on hardening the pure java version.  With that in mind, I switched the indexFactory on my leveldb config to indexFactory=\"org.iq80.leveldb.impl.Iq80DBFactory\".  I restarted, and tried the compact operation again, but got the same stacktrace.\n\nMy leveldb config now looks like:\n\n<amq:persistenceAdapter>\n            <amq:levelDB directory=\"[[karaf.storage]]/activemq/default/leveldb\" logSize=\"107374182\" logCompression=\"snappy\" indexFactory=\"org.iq80.leveldb.impl.Iq80DBFactory\" />\n        </amq:persistenceAdapter>\n\nThe logCompression and the indexFactory were both added as an attempt to mitigate the problem, but the issue exists either way.  I also saw a note on the replicated levedb store about scheduled jobs, which are used a lot, but when I looked at those folders in our storage folder it seems to use a completely different kahadb store, so I threw that out as a reason.\n\nI did attempt to add leveldbjni-linux64 or leveldbjni-all to the osgi deployment, but it does not export the internal package which activemq-osgi wants to import.  I could build a new package of these, or rebuild activemq-osgi with the commented dependencies removed.. perhaps that will work, but it seems that as it is with the dependencies commented out that there is something broken within the compact routine.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"399578","customfield_12312823":null,"summary":"java.lang.NoClassDefFoundError: org/fusesource/leveldbjni/internal/JniDB error during cleanup","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timgstewart","name":"timgstewart","key":"timgstewart","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Stewart","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=timgstewart","name":"timgstewart","key":"timgstewart","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Timothy Stewart","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux  2.6.32-279.5.2.el6.x86_64 #1 SMP Thu Aug 23 12:05:59 EDT 2012 x86_64 x86_64 x86_64 GNU/Linux\n\nJDK 1.7.0_51\n\nApache Karaf 2.3.5 with activemq-osgi, activemq-blueprint, activemq-client, activemq-webconsole, activemq-camel, activemq features installed.  Using version 5.9.1 (and tried 5.10.0)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12721273/comment/14900454","id":"14900454","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steff33344","name":"steff33344","key":"steff33344","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan","active":true,"timeZone":"Etc/UTC"},"body":"Any news here? Right now our LevelDB is growing as well and the only way to circumvent is to wait until all queues are empty, shut-down ActiveMQ and delete the files manually. Without the compact, its not usable so we switched back to kahaDB","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=steff33344","name":"steff33344","key":"steff33344","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Stefan","active":true,"timeZone":"Etc/UTC"},"created":"2015-09-21T09:47:03.896+0000","updated":"2015-09-21T09:47:03.896+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12721273/comment/15852289","id":"15852289","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"LevelDB has been deprecated and is no longer supported.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-02-03T23:05:55.455+0000","updated":"2017-02-03T23:05:55.455+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5228/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1wrnz:"}}