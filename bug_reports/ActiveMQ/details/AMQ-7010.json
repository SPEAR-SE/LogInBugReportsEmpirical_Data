{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13171677","self":"https://issues.apache.org/jira/rest/api/2/issue/13171677","key":"AMQ-7010","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2018-07-27T11:11:33.889+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Fri Jul 27 12:54:22 UTC 2018","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1310152190_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2018-07-27T12:34:43.895+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-7010/watchers","watchCount":3,"isWatching":false},"created":"2018-07-12T08:38:51.730+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338054","id":"12338054","name":"5.15.0","archived":false,"released":true,"releaseDate":"2017-07-05"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341031","id":"12341031","name":"5.15.1","archived":false,"released":true,"releaseDate":"2017-10-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341669","id":"12341669","name":"5.15.2","archived":false,"released":true,"releaseDate":"2017-10-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12341947","id":"12341947","name":"5.15.3","archived":false,"released":true,"releaseDate":"2018-02-01"}],"issuelinks":[{"id":"12539782","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12539782","type":{"id":"12310560","name":"Problem/Incident","inward":"is caused by","outward":"causes","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310560"},"inwardIssue":{"id":"13050564","key":"AMQ-6625","self":"https://issues.apache.org/jira/rest/api/2/issue/13050564","fields":{"summary":"IOException in kahaDB needs to pause pending IOExceptionHandler intervention","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2018-07-27T12:54:22.043+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12325017","id":"12325017","name":"KahaDB"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Recently, we upgraded our ActiveMQ instance from {{5.13.2}} to {{5.15.3}}. We basically use an almost default broker setup with KahaDB. Due to our setup, we occasionally run into {{java.io.IOException: No space left on device}}, which until now was fine since the broker would properly ignore them using the {{DefaultIOExceptionHandler}}, and resume its work once space is available again.\r\n\r\nAfter upgrading to {{5.15.3}}, however, we noticed that the broker would actually stop itself following a _no space left_ exception. Digging a little bit, it seems that the change in behavior can be linked to a fix introduced in the {{5.15.0}} release, see AMQ-6625. With this fix, KahaDB would sometimes throw the following exception: {{java.io.IOException: Async Writer Thread Shutdown}} from its {{DataFileAppender}}, which, unfortunately, is not handled by the {{DefaultIOExceptionHandler}} unless {{ignoreAllErrors}} is set to true.\r\n\r\nThis would basically mean that the {{DefaultIOExceptionHandler}} has become useless in catching only _no space left_ exceptions, which I do not think is the intended behavior. \r\nh3. How to reproduce\r\n # Start a broker with default config on a small partition\r\n # Send a persistent message with web console to any queue\r\n # Fill the partition by any mean\r\n # Send more messages with web console, broker is eventually shut down\r\n\r\nSee the attached broker logs.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12931290","id":"12931290","filename":"activemq_logs.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lchdev","name":"lchdev","key":"lchdev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laurent Chiarello","active":true,"timeZone":"Europe/Luxembourg"},"created":"2018-07-12T08:37:12.234+0000","size":31881,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12931290/activemq_logs.txt"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"No space left on device leading to broker shutdown even if ignored","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lchdev","name":"lchdev","key":"lchdev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laurent Chiarello","active":true,"timeZone":"Europe/Luxembourg"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lchdev","name":"lchdev","key":"lchdev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laurent Chiarello","active":true,"timeZone":"Europe/Luxembourg"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171677/comment/16559577","id":"16559577","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"In my opinion I think it's better if the broker stops itself following a no space exception.  That is not a normal condition so I think the broker should stop to prevent data corruption.  [~gtully] since you worked on the Jira referenced here, what do you think?\r\n\r\nTo avoid this issue you can configure your broker to limit the amount of disk space it can use.  There are configuration options to set a fixed disk space size and also a percentage of the partition it can use.  If you do this then you won't ever run out of disk space and the broker won't shut down.  \r\n\r\nAlso, if for some reason you have other processes writing to the data partition you can also set the broker to periodically re-check available disk space so it will adjust the settings: [http://activemq.apache.org/periodically-checking-disk-limits.html|http://activemq.apache.org/periodically-checking-disk-limits.html.]  However, the best thing to do would be to assign KahaDB to its own partition so that's not an issue","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2018-07-27T11:11:33.889+0000","updated":"2018-07-27T11:11:33.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171677/comment/16559646","id":"16559646","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I agree. It is best to stop. The latest update to this feature introduced \"systemExitOnShutdown\" to force a quick termination.\r\n\r\nIt turns out that is is not safe to continue to write on a \"no space\" error, some smaller write may succeed and async writes will succeed and lead to invalid locations in the index. It gets messy quickly.\r\n\r\nThe intent is that the appender stops, the IOExceptionHandler can suspend connections till a checkpoint succeeds, then enable the appender again; that is reasonably safe.\r\n\r\nBut simply ignoring all errors is no longer a flyer.\r\n\r\nThe safest approach from a consistency point of view is to shutdown and let recovery deal with any partial writes.\r\n\r\nFrom a client perspective, shutdown is not unlike stopStartClientConnections, but it does require something to restart the broker.\r\n\r\n \r\n\r\n \r\n\r\nThis does point to the need to update the documentation to reflect how this has evolved.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-27T12:03:00.923+0000","updated":"2018-07-27T12:03:00.923+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171677/comment/16559684","id":"16559684","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"updated the documentation for the ignoreNoSpaceErrors attribute with: \r\n\r\nFrom 5.15.0 ignoreAllErrors needs to be used because the appender stops on the first error leading to secondary exceptions from concurrent operations.\r\n\r\n ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2018-07-27T12:34:43.916+0000","updated":"2018-07-27T12:34:43.916+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13171677/comment/16559706","id":"16559706","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lchdev","name":"lchdev","key":"lchdev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laurent Chiarello","active":true,"timeZone":"Europe/Luxembourg"},"body":"[~gtully], [~cshannon], thanks for the clarification. Since then we moved KahaDB on a dedicated partition, so it should indeed be preferable to shutdown the broker on error since it is clearly not an expected situation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=lchdev","name":"lchdev","key":"lchdev","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Laurent Chiarello","active":true,"timeZone":"Europe/Luxembourg"},"created":"2018-07-27T12:54:22.043+0000","updated":"2018-07-27T12:54:22.043+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-7010/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3vtd3:"}}