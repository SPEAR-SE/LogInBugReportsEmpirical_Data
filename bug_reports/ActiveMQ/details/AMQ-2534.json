{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483595","self":"https://issues.apache.org/jira/rest/api/2/issue/12483595","key":"AMQ-2534","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12316331","id":"12316331","description":"Next unplanned v5 maintenance release","name":"5.x","archived":false,"released":false}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/5","id":"5","description":"All attempts at reproducing this issue failed, or not enough information was available to reproduce the issue. Reading the code produces no clues as to why this behavior would occur. If more information appears later, please reopen the issue.","name":"Cannot Reproduce"},"customfield_12312322":null,"customfield_12310220":"2010-03-14T18:01:59.176+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Dec 22 17:46:53 UTC 2015","customfield_12310420":"44169","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_189886561238_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-12-22T17:46:53.349+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2534/watchers","watchCount":8,"isWatching":false},"created":"2009-12-15T23:30:52.144+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-12-22T17:46:53.379+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"This seems to happen after a period of several hours of inactivity. One symptom of the problem is that in the web UI you can see that a queue has a non-zero message count, but clicking on the queue to see the actual messages shows nothing.\n\nConfig:\n        <persistenceAdapter>\n            <jdbcPersistenceAdapter dataSource=\"#mysql-ds\"/>\n        </persistenceAdapter>\n\n    <bean id=\"mysql-ds\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n        <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n        <property name=\"url\" value=\"jdbc:mysql://dbserver/activeMQ?relaxAutoCommit=true&amp;autoReconnect=true\"/>\n        <property name=\"username\" value=\"user\"/>\n        <property name=\"password\" value=\"pass\"/>\n        <property name=\"maxActive\" value=\"200\"/>\n        <property name=\"poolPreparedStatements\" value=\"true\"/>\n    </bean>\n\n\n\nLog:\n2009-11-27 07:40:25,026 | WARN  | Close failed: Already closed. | org.apache.activemq.store.jdbc.TransactionContext | QueueThread:queue://(queue name)\njava.sql.SQLException: Already closed.\n\tat org.apache.commons.dbcp.PoolableConnection.close(PoolableConnection.java:84)\n\tat org.apache.commons.dbcp.PoolingDataSource$PoolGuardConnectionWrapper.close(PoolingDataSource.java:181)\n\tat org.apache.activemq.store.jdbc.TransactionContext.close(TransactionContext.java:135)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:198)\n\tat org.apache.activemq.store.ProxyMessageStore.getMessageCount(ProxyMessageStore.java:83)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.getStoreSize(QueueStorePrefetch.java:63)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.remove(AbstractStoreCursor.java:185)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.remove(StoreQueueCursor.java:141)\n\tat org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1367)\n\tat org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1503)\n\tat org.apache.activemq.broker.region.Queue.iterate(Queue.java:1178)\n\tat org.apache.activemq.thread.DeterministicTaskRunner.runTask(DeterministicTaskRunner.java:84)\n\tat org.apache.activemq.thread.DeterministicTaskRunner$1.run(DeterministicTaskRunner.java:41)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\n2009-11-27 07:40:25,027 | ERROR | Failed to get message count | org.apache.activemq.broker.region.cursors.QueueStorePrefetch | QueueThread:queue://(queue name)\njava.io.IOException: Failed to get Message Count: queue://(queue name). Reason: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:33)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:196)\n\tat org.apache.activemq.store.ProxyMessageStore.getMessageCount(ProxyMessageStore.java:83)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.getStoreSize(QueueStorePrefetch.java:63)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.remove(AbstractStoreCursor.java:185)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.remove(StoreQueueCursor.java:141)\n\tat org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1367)\n\tat org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1503)\n\tat org.apache.activemq.broker.region.Queue.iterate(Queue.java:1178)\n\tat org.apache.activemq.thread.DeterministicTaskRunner.runTask(DeterministicTaskRunner.java:84)\n\tat org.apache.activemq.thread.DeterministicTaskRunner$1.run(DeterministicTaskRunner.java:41)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:888)\n\tat com.mysql.jdbc.Statement.checkClosed(Statement.java:380)\n\tat com.mysql.jdbc.PreparedStatement.setString(PreparedStatement.java:3374)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n\tat org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.doGetMessageCount(DefaultJDBCAdapter.java:700)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:192)\n\t... 12 more\n2009-11-27 07:40:25,028 | ERROR | Failed to page in more queue messages  | org.apache.activemq.broker.region.Queue | QueueThread:queue://(queue name)\njava.lang.RuntimeException: java.io.IOException: Failed to get Message Count: queue://(queue name). Reason: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.getStoreSize(QueueStorePrefetch.java:66)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.remove(AbstractStoreCursor.java:185)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.remove(StoreQueueCursor.java:141)\n\tat org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1367)\n\tat org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1503)\n\tat org.apache.activemq.broker.region.Queue.iterate(Queue.java:1178)\n\tat org.apache.activemq.thread.DeterministicTaskRunner.runTask(DeterministicTaskRunner.java:84)\n\tat org.apache.activemq.thread.DeterministicTaskRunner$1.run(DeterministicTaskRunner.java:41)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: java.io.IOException: Failed to get Message Count: queue://(queue name). Reason: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:33)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:196)\n\tat org.apache.activemq.store.ProxyMessageStore.getMessageCount(ProxyMessageStore.java:83)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.getStoreSize(QueueStorePrefetch.java:63)\n\t... 10 more\nCaused by: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:888)\n\tat com.mysql.jdbc.Statement.checkClosed(Statement.java:380)\n\tat com.mysql.jdbc.PreparedStatement.setString(PreparedStatement.java:3374)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n\tat org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.doGetMessageCount(DefaultJDBCAdapter.java:700)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:192)\n\t... 12 more\n2009-11-27 07:40:25,086 | WARN  | Close failed: Already closed. | org.apache.activemq.store.jdbc.TransactionContext | QueueThread:queue://(queue name)\njava.sql.SQLException: Already closed.\n\tat org.apache.commons.dbcp.PoolableConnection.close(PoolableConnection.java:84)\n\tat org.apache.commons.dbcp.PoolingDataSource$PoolGuardConnectionWrapper.close(PoolingDataSource.java:181)\n\tat org.apache.activemq.store.jdbc.TransactionContext.close(TransactionContext.java:135)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:198)\n\tat org.apache.activemq.store.ProxyMessageStore.getMessageCount(ProxyMessageStore.java:83)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.getStoreSize(QueueStorePrefetch.java:63)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.remove(AbstractStoreCursor.java:185)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.remove(StoreQueueCursor.java:141)\n\tat org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1367)\n\tat org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1503)\n\tat org.apache.activemq.broker.region.Queue.iterate(Queue.java:1178)\n\tat org.apache.activemq.thread.DeterministicTaskRunner.runTask(DeterministicTaskRunner.java:84)\n\tat org.apache.activemq.thread.DeterministicTaskRunner$1.run(DeterministicTaskRunner.java:41)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\n2009-11-27 07:40:25,088 | ERROR | Failed to get message count | org.apache.activemq.broker.region.cursors.QueueStorePrefetch | QueueThread:queue://(queue name)\njava.io.IOException: Failed to get Message Count: queue://(queue name). Reason: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:33)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:196)\n\tat org.apache.activemq.store.ProxyMessageStore.getMessageCount(ProxyMessageStore.java:83)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.getStoreSize(QueueStorePrefetch.java:63)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.remove(AbstractStoreCursor.java:185)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.remove(StoreQueueCursor.java:141)\n\tat org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1367)\n\tat org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1503)\n\tat org.apache.activemq.broker.region.Queue.iterate(Queue.java:1178)\n\tat org.apache.activemq.thread.DeterministicTaskRunner.runTask(DeterministicTaskRunner.java:84)\n\tat org.apache.activemq.thread.DeterministicTaskRunner$1.run(DeterministicTaskRunner.java:41)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:888)\n\tat com.mysql.jdbc.Statement.checkClosed(Statement.java:380)\n\tat com.mysql.jdbc.PreparedStatement.setString(PreparedStatement.java:3374)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n\tat org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.doGetMessageCount(DefaultJDBCAdapter.java:700)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:192)\n\t... 12 more\n2009-11-27 07:40:25,088 | ERROR | Failed to page in more queue messages  | org.apache.activemq.broker.region.Queue | QueueThread:queue://(queue name)\njava.lang.RuntimeException: java.io.IOException: Failed to get Message Count: queue://(queue name). Reason: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.getStoreSize(QueueStorePrefetch.java:66)\n\tat org.apache.activemq.broker.region.cursors.AbstractStoreCursor.remove(AbstractStoreCursor.java:185)\n\tat org.apache.activemq.broker.region.cursors.StoreQueueCursor.remove(StoreQueueCursor.java:141)\n\tat org.apache.activemq.broker.region.Queue.doPageIn(Queue.java:1367)\n\tat org.apache.activemq.broker.region.Queue.pageInMessages(Queue.java:1503)\n\tat org.apache.activemq.broker.region.Queue.iterate(Queue.java:1178)\n\tat org.apache.activemq.thread.DeterministicTaskRunner.runTask(DeterministicTaskRunner.java:84)\n\tat org.apache.activemq.thread.DeterministicTaskRunner$1.run(DeterministicTaskRunner.java:41)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(Unknown Source)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n\tat java.lang.Thread.run(Unknown Source)\nCaused by: java.io.IOException: Failed to get Message Count: queue://(queue name). Reason: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:33)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:196)\n\tat org.apache.activemq.store.ProxyMessageStore.getMessageCount(ProxyMessageStore.java:83)\n\tat org.apache.activemq.broker.region.cursors.QueueStorePrefetch.getStoreSize(QueueStorePrefetch.java:63)\n\t... 10 more\nCaused by: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:888)\n\tat com.mysql.jdbc.Statement.checkClosed(Statement.java:380)\n\tat com.mysql.jdbc.PreparedStatement.setString(PreparedStatement.java:3374)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n\tat org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.doGetMessageCount(DefaultJDBCAdapter.java:700)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.getMessageCount(JDBCMessageStore.java:192)\n\t... 12 more\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59762","customfield_12312823":null,"summary":"Broker gets stuck with an error about using a closed JDBC statement","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpierce","name":"mpierce","key":"mpierce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall Pierce","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mpierce","name":"mpierce","key":"mpierce","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marshall Pierce","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux\nSun JDK 6, several different update versions\nMysql","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483595/comment/12942346","id":"12942346","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mettini","name":"mettini","key":"mettini","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Emiliano Mettini","active":true,"timeZone":"Etc/UTC"},"body":"Exactly the same problem with same configuration.\n\nI also figured that if I increase maxActive connections the problems rarely appear .. but that's not an scalable workaround ..","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mettini","name":"mettini","key":"mettini","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Emiliano Mettini","active":true,"timeZone":"Etc/UTC"},"created":"2010-03-14T18:01:59.176+0000","updated":"2010-03-14T18:01:59.176+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483595/comment/13178819","id":"13178819","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dianlight","name":"dianlight","key":"dianlight","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lucio Tarantino","active":true,"timeZone":"Etc/UTC"},"body":"Hi,\n I'have the same error? Any news or workaround?\nIt append sometimes on hight workload and the problem is that the processed message is duplicated.\n\nMy environment is:\n1. ActiveMQ (apache-activemq-5.4.3) with mysql 5.0.77 as storage.\n\nThis is my error trace:\n\n[12-29 23:28:14] ERROR org.mule.exception.DefaultSystemExceptionStrategy [ActiveMQ Session Task-6864]:\n********************************************************************************\nMessage               : Transaction commit failed\nType                  : org.mule.api.transaction.TransactionException\nCode                  : MULE_ERROR-90097\nJavaDoc               : http://www.mulesoft.org/docs/site/current3/apidocs/org/mule/api/transaction/TransactionException.html\nJMS Code              : null\n********************************************************************************\nException stack is:\n1. com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed. (java.lang.Throwable)\n  com.mysql.jdbc.SQLError:888 (null)\n2. Failed to get store sequenceId for messageId: ID:cordoba.jakala.com-52552-1324648464349-0:1:8306:1:1, on: queue://enel.sap.esiti. Reason: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed. (java.io.IOException)\n  org.apache.activemq.util.IOExceptionSupport:33 (null)\n3. STORE COMMIT FAILED: Transaction rolled back. (javax.transaction.xa.XAException)\n  org.apache.activemq.transaction.LocalTransaction:77 (http://java.sun.com/j2ee/sdk_1.3/techdocs/api/javax/transaction/xa/XAException.html)\n4. STORE COMMIT FAILED: Transaction rolled back.(JMS Code: null) (javax.jms.JMSException)\n  org.apache.activemq.util.JMSExceptionSupport:49 (http://java.sun.com/j2ee/sdk_1.3/techdocs/api/javax/jms/JMSException.html)\n5. Transaction commit failed (org.mule.api.transaction.TransactionException)\n  org.mule.transport.jms.JmsTransaction:80 (http://www.mulesoft.org/docs/site/current3/apidocs/org/mule/api/transaction/TransactionException.html)\n********************************************************************************\nRoot Exception stack trace:\njava.lang.Throwable: com.mysql.jdbc.exceptions.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n        at com.mysql.jdbc.SQLError.createSQLException(SQLError.java:888)\n        at com.mysql.jdbc.Statement.checkClosed(Statement.java:385)\n        at com.mysql.jdbc.PreparedStatement.setString(PreparedStatement.java:3455)\n        at org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n        at org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:132)\n        at org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.getStoreSequenceId(DefaultJDBCAdapter.java:272)\n        at org.apache.activemq.store.jdbc.JDBCMessageStore.getStoreSequenceIdForMessageId(JDBCMessageStore.java:293)\n        at org.apache.activemq.store.jdbc.JDBCMessageStore.removeMessage(JDBCMessageStore.java:148)\n        at org.apache.activemq.store.memory.MemoryTransactionStore$4.run(MemoryTransactionStore.java:302)\n        at org.apache.activemq.store.memory.MemoryTransactionStore$Tx.commit(MemoryTransactionStore.java:102)\n        at org.apache.activemq.store.memory.MemoryTransactionStore.commit(MemoryTransactionStore.java:222)\n        at org.apache.activemq.transaction.LocalTransaction.commit(LocalTransaction.java:72)\n        at org.apache.activemq.broker.TransactionBroker.commitTransaction(TransactionBroker.java:173)\n        at org.apache.activemq.broker.MutableBrokerFilter.commitTransaction(MutableBrokerFilter.java:103)\n        at org.apache.activemq.broker.TransportConnection.processCommitTransactionOnePhase(TransportConnection.java:424)\n        at org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:100)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:311)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:185)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:69)\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:228)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:220)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:202)\n        at java.lang.Thread.run(Thread.java:662)\n\n********************************************************************************\n\n[12-29 23:28:14] ERROR org.mule.transport.jms.MultiConsumerJmsMessageReceiver [ActiveMQ Session Task-6864]: javax.jms.IllegalStateException: This session is transacted\n\t","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dianlight","name":"dianlight","key":"dianlight","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Lucio Tarantino","active":true,"timeZone":"Etc/UTC"},"created":"2012-01-03T17:00:13.322+0000","updated":"2012-01-03T17:00:13.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483595/comment/13179326","id":"13179326","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"body":"You can disable poolPreparedStatements to avoid caching statements.\nAlternatively you can try the following configuration.\n\n\t<bean id=\"mysql-ds\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n\t\t<property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n\t\t<property name=\"url\" value=\"jdbc:mysql://dbserver/activeMQ?relaxAutoCommit=true&autoReconnect=true\"/>\n\t\t<property name=\"username\" value=\"user\"/>\n\t\t<property name=\"password\" value=\"pass\"/>\n\t\t<property name=\"maxActive\" value=\"250\"/>\n\t\t<property name=\"maxIdle\" value=\"10\"/>\n\t\t<property name=\"minIdle\" value=\"5\"/>\n\t\t<property name=\"testOnBorrow\" value=\"true\"/>\n\t\t<property name=\"validationQuery\" value=\"select 1\"/>\n\t\t<property name=\"poolPreparedStatements\" value=\"true\"/>\n\t\t<property name=\"maxOpenPreparedStatements\" value=\"20\"/>\n\t</bean>\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wangyin","name":"wangyin","key":"wangyin","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10448","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10448","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10448","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10448"},"displayName":"SuoNayi","active":true,"timeZone":"Asia/Hong_Kong"},"created":"2012-01-04T07:34:21.098+0000","updated":"2012-01-04T07:34:21.098+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483595/comment/13458661","id":"13458661","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"Connection pools or JDBC drivers sometime have functionality to re-connect and test connections to ensure they are valid before they are handed out to the client (= amq in this case).\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2012-09-19T13:01:31.908+0000","updated":"2012-09-19T13:01:31.908+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483595/comment/13889722","id":"13889722","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelomax","name":"marcelomax","key":"marcelomax","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcelo Flores","active":true,"timeZone":"Etc/UTC"},"body":"So, this was a non resolved issue for activemq version 5.3, but fixed since 5.4, is that it?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=marcelomax","name":"marcelomax","key":"marcelomax","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marcelo Flores","active":true,"timeZone":"Etc/UTC"},"created":"2014-02-03T18:30:32.119+0000","updated":"2014-02-03T18:30:32.119+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483595/comment/13908460","id":"13908460","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=edcolon","name":"edcolon","key":"edcolon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ed","active":true,"timeZone":"America/Mexico_City"},"body":"Hello,\n\nMy environment:\nActivemq 5.9\nDebian 7.2\nJava 1.7_045\nProtocol openwire\n\nactivemq.xml (part of it)\n....\n<persistenceAdapter>\n   <jdbcPersistenceAdapter dataDirectory=\"${activemq.base}/activemq-data\" dataSource=\"#mysql-ds\"/>\n</persistenceAdapter>\n......\n\n  <transportConnectors>\n            <!-- DOS protection, limit concurrent connections to 1000 and frame size to 100MB -->\n            <transportConnector name=\"openwire\" uri=\"tcp://0.0.0.0:61616?maximumConnections=1000&amp;wireFormat.maxFrameSize=104857600\"/>\n\n        </transportConnectors>\n......\n\n<bean id=\"mysql-ds\" class=\"org.apache.commons.dbcp.BasicDataSource\" destroy-method=\"close\">\n    <property name=\"driverClassName\" value=\"com.mysql.jdbc.Driver\"/>\n    <property name=\"url\" value=\"jdbc:mysql://localhost:3306/activemq?relaxAutoCommit=true\"/>\n    <property name=\"username\" value=\"activemq\"/>\n    <property name=\"password\" value=\"xyz\"/>\n    <property name=\"poolPreparedStatements\" value=\"true\"/>\n</bean>\n......\n\n\nWe work fine during the day, but when we start working next morning, we realize that the first message gets stuck with the following error (same as above post):\n\n2014-02-21 08:50:03,045 | WARN  | JDBC Failure: No operations allowed after statement closed. | org.apache.activemq.store.jdbc.JDBCPersistenceAdapter | ActiveMQ Transport: tcp:///<IP ADDRESS>:60004@61616\ncom.mysql.jdbc.exceptions.jdbc4.MySQLNonTransientConnectionException: No operations allowed after statement closed.\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n\tat java.lang.reflect.Constructor.newInstance(Constructor.java:526)\n\tat com.mysql.jdbc.Util.handleNewInstance(Util.java:411)\n\tat com.mysql.jdbc.Util.getInstance(Util.java:386)\n\tat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:1015)\n\tat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:989)\n\tat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:975)\n\tat com.mysql.jdbc.SQLError.createSQLException(SQLError.java:920)\n\tat com.mysql.jdbc.StatementImpl.checkClosed(StatementImpl.java:461)\n\tat com.mysql.jdbc.PreparedStatement.setString(PreparedStatement.java:4453)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:135)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:135)\n\tat org.apache.commons.dbcp.DelegatingPreparedStatement.setString(DelegatingPreparedStatement.java:135)\n\tat org.apache.activemq.store.jdbc.adapter.DefaultJDBCAdapter.getStoreSequenceId(DefaultJDBCAdapter.java:291)\n\tat org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.getStoreSequenceIdForMessageId(JDBCPersistenceAdapter.java:840)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.removeMessage(JDBCMessageStore.java:194)\n\tat org.apache.activemq.store.memory.MemoryTransactionStore$4.run(MemoryTransactionStore.java:348)\n\tat org.apache.activemq.store.jdbc.JdbcMemoryTransactionStore.prepare(JdbcMemoryTransactionStore.java:77)\n\tat org.apache.activemq.transaction.XATransaction.prepare(XATransaction.java:192)\n\tat org.apache.activemq.broker.TransactionBroker.prepareTransaction(TransactionBroker.java:248)\n\tat org.apache.activemq.broker.MutableBrokerFilter.prepareTransaction(MutableBrokerFilter.java:127)\n\tat org.apache.activemq.broker.TransportConnection.processPrepareTransaction(TransportConnection.java:405)\n\tat org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:98)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:292)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:149)\n\tat org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\n\tat org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)\n\tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n\tat org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)\n\tat java.lang.Thread.run(Thread.java:744)\n2014-02-21 08:50:03,047 | WARN  | Close failed: Already closed. | org.apache.activemq.store.jdbc.TransactionContext | ActiveMQ Transport: tcp:///<IP ADDRESS>:60004@61616\njava.sql.SQLException: Already closed.\n\tat org.apache.commons.dbcp.PoolableConnection.close(PoolableConnection.java:114)\n\tat org.apache.commons.dbcp.PoolingDataSource$PoolGuardConnectionWrapper.close(PoolingDataSource.java:191)\n\tat org.apache.activemq.store.jdbc.TransactionContext.close(TransactionContext.java:147)\n\tat org.apache.activemq.store.jdbc.JDBCPersistenceAdapter.getStoreSequenceIdForMessageId(JDBCPersistenceAdapter.java:845)\n\tat org.apache.activemq.store.jdbc.JDBCMessageStore.removeMessage(JDBCMessageStore.java:194)\n\tat org.apache.activemq.store.memory.MemoryTransactionStore$4.run(MemoryTransactionStore.java:348)\n\tat org.apache.activemq.store.jdbc.JdbcMemoryTransactionStore.prepare(JdbcMemoryTransactionStore.java:77)\n\tat org.apache.activemq.transaction.XATransaction.prepare(XATransaction.java:192)\n\tat org.apache.activemq.broker.TransactionBroker.prepareTransaction(TransactionBroker.java:248)\n\tat org.apache.activemq.broker.MutableBrokerFilter.prepareTransaction(MutableBrokerFilter.java:127)\n\tat org.apache.activemq.broker.TransportConnection.processPrepareTransaction(TransportConnection.java:405)\n\tat org.apache.activemq.command.TransactionInfo.visit(TransactionInfo.java:98)\n\tat org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:292)\n\tat org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:149)\n\tat org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50)\n\tat org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n\tat org.apache.activemq.transport.AbstractInactivityMonitor.onCommand(AbstractInactivityMonitor.java:270)\n\tat org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:83)\n\tat org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:214)\n\tat org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:196)\n\tat java.lang.Thread.run(Thread.java:744)\n\nAny workaround/resolution would be appreciated.\n\nThanks in advance.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=edcolon","name":"edcolon","key":"edcolon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ed","active":true,"timeZone":"America/Mexico_City"},"created":"2014-02-21T16:09:38.258+0000","updated":"2014-02-21T16:13:33.714+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483595/comment/15068456","id":"15068456","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This looks to be an issue with the JDBC driver configuration.  If there's still an issue it looks like a good topic to first take the the users list to get insight from other JDBC users.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-12-22T17:46:53.370+0000","updated":"2015-12-22T17:46:53.370+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2534/votes","votes":3,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0aljb:"}}