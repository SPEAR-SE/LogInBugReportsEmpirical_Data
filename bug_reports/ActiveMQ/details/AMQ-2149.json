{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482954","self":"https://issues.apache.org/jira/rest/api/2/issue/12482954","key":"AMQ-2149","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"parent":{"id":"12482550","key":"AMQ-2210","self":"https://issues.apache.org/jira/rest/api/2/issue/12482550","fields":{"summary":"Infinite loop: WARN  PrefetchSubscription           - Ack before disaptch, waiting for recovery dispatch: MessageAck","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/1","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/blocker.svg","name":"Blocker","id":"1"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-03-09T20:49:30.068+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sat May 23 08:48:14 UTC 2009","customfield_12310420":"75053","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_1720787226_*|*_5_*:*_2_*:*_858871407_*|*_4_*:*_1_*:*_4126189825","customfield_12312321":null,"resolutiondate":"2009-05-23T08:48:15.004+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2149/watchers","watchCount":5,"isWatching":false},"created":"2009-03-06T18:04:06.546+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"10.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-05-23T08:48:15.003+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I'm finding occasionally messages are not delivered in order in a shared filesystem master slave setup when the master fails and the slave takes over.  I'm running a simple test on one physical machine where the shared filesystem is on a single disk (no SAN currently involved).\n\nI'm attaching a shell script (run_master_slave_brokers.sh) that starts a master and slave broker in the same directory, sleeps 20 seconds, kills the master, sleeps 20 seconds, starts a new slave, sleeps 20 seconds, kills the master, etc.\n\nAlso attached is a small java test program (MasterSlaveTest.java)  The program starts 10 JMS senders that send 75kb text messages every 25 ms to unique queues.  These messages contain a sequence number header (a long).  The program also starts 10 receivers (1 for each queue) that keep track of the next expected sequence number and validate each incoming sequence number.  If a receiver gets an unexpected sequence number, the test program exits (System.exit(1)).  Both the senders and receivers use the failover transport to connect to the broker.  Messages being sent are persistent, so in theory there should be no message loss when the master fails and slave takes over.\n\nI run the script to start the brokers, then run my test program.  Most times when the script kills the master and the slave is promoted, things work fine - the test program reconnects, and messages continue to be delivered in order.  If I run this long enough though, eventually my test program fails just after a slave broker is promoted to master with output similar to this:\n\n\nMar 6, 2009 11:58:12 AM org.apache.activemq.transport.failover.FailoverTransport doReconnect\nINFO: Successfully reconnected to tcp://localhost:61616\nMar 6, 2009 11:58:12 AM org.aaron.MasterSlaveTest$Receiver onMessage\nWARNING: test.queue.3 received 630 expected 629\n\n\nThis indicates the receiver for test.queue.3 received message 630 after the slave broker took over and missed message 629.\n\nThis seems to happen more often when more senders and receivers are running and more queues are in use.  If I run a single sender/receiver pair on 1 queue, it is very difficult to make this happen.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461384","id":"12461384","filename":"activemq.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-07T21:16:19.517+0000","size":50130,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461384/activemq.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461397","id":"12461397","filename":"activemq.log.2009_03_12_1","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-12T23:16:34.638+0000","size":8269,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12461397/activemq.log.2009_03_12_1"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461398","id":"12461398","filename":"activemq.log.2009_03_12_2","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-12T23:16:34.675+0000","size":8422,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12461398/activemq.log.2009_03_12_2"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461466","id":"12461466","filename":"activemq.log.2009_04_05","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-05T14:38:14.681+0000","size":185412,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12461466/activemq.log.2009_04_05"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461382","id":"12461382","filename":"activemq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-06T18:05:28.671+0000","size":6971,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12461382/activemq.xml"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461440","id":"12461440","filename":"amq2149.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-26T15:10:24.213+0000","size":36418,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461440/amq2149.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461399","id":"12461399","filename":"AMQ-2149.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-03-13T08:58:22.105+0000","size":3314,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461399/AMQ-2149.zip"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461341","id":"12461341","filename":"MasterSlaveTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-06T18:05:08.679+0000","size":3890,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461341/MasterSlaveTest.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461383","id":"12461383","filename":"MasterSlaveTestWithTransactions.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-07T13:53:49.876+0000","size":4773,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12461383/MasterSlaveTestWithTransactions.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461300","id":"12461300","filename":"run_master_slave_brokers.sh","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-06T18:04:52.916+0000","size":846,"mimeType":"application/x-sh","content":"https://issues.apache.org/jira/secure/attachment/12461300/run_master_slave_brokers.sh"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161685","customfield_12312823":null,"summary":"Shared Filesystem Master Slave: missing messages","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Ubuntu Linux 8.10 AMD64, Sun JDK 1.6.0.10","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940919","id":"12940919","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"body":"I tried several more tests using the script and test program above, with similarly bad results.  So far I am unable to find a completly reliable way to implement master/slave failover with a shared filesystem.\n\nI have tried all tests so far on both Apache ActiveMQ 5.2.0 and the new FUSE message broker 5.3.0.0 with identical results.\n\n\n1. In my original test, the syncOnWrite parameter for the amqPersistenceAdapter was set to the default value \"false\".  I thought this might be part of my problem, so I changed it to syncOnWrite=\"true\".  I am certain changing syncOnWrite had an effect, because it reduced the rate of messages being sent and received to 20 per second.  The test program still used AUTO_ACKNOWLEDGE in the sender and receiver.  This failed after 3 master/slave failovers:\n\nMar 7, 2009 7:35:42 AM org.aaron.MasterSlaveTest$Receiver onMessage\nWARNING: test.queue.9 received 1904 expected 1903\n\n\n2. Next I set syncOnWrite=\"false\" and enabled transactions in both Sender and Receiver.  To do this I changed the call to createSession to have parameters \"true\" and \"Session.SESSION_TRANSACTED\".  I called session.commit after each send and receive.  See MasterSlaveTestWithTransactions.java.\n\nThis failed after 4 master/slave failovers:\n\nMar 7, 2009 7:12:55 AM org.aaron.MasterSlaveTest$Receiver onMessage\nWARNING: test.queue.8 received 1530 expected 3703\n\n\n3. Finally I set syncOnWrite=\"true\" and ran again with transactions enabled in both Sender and Receiver (MasterSlaveTestWithTransactions.java).\n\nThis failed after 6 master/slave failovers:\n\nMar 7, 2009 7:32:19 AM org.aaron.MasterSlaveTest$Receiver onMessage\nWARNING: test.queue.3 received 1734 expected 1725\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-07T13:53:22.079+0000","updated":"2009-03-07T13:53:22.079+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940922","id":"12940922","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"body":"One more piece of information that is hopefully useful: I often see a number of exceptions in the activemq log when a message is delivered out of order just after a master broker fails and the slave takes over.\n\nHere's an example - in this case I was running the non-transacted test program (MasterSlaveTest.java) and syncOnWrite=false.  run_master_slave_brokers.sh does the following:\n\nSat Mar  7 15:06:09 CST 2009 killing master broker pid 24470, new master pid 24678\nSat Mar  7 15:06:29 CST 2009 started slave broker pid 24883\nSat Mar  7 15:06:49 CST 2009 killing master broker pid 24678, new master pid 24883\n\nThe last master failure and slave promotion at 15:06:49 causes test.queue.3 to miss messages 6620 and 6621:\n\nMar 7, 2009 3:06:51 PM org.aaron.MasterSlaveTest$Receiver onMessage\nWARNING: test.queue.3 received 6622 expected 6620\n\nAt the same time (15:06:51), there are a number of exceptions in the activemq log complaining about messages not being able to be recovered from the data store - already dispatched.  I've attached the log as \"activemq.log\" if its helpful.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-07T21:16:02.809+0000","updated":"2009-03-07T21:16:02.809+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940927","id":"12940927","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dave_stanley","name":"dave_stanley","key":"dave_stanley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Stanley","active":true,"timeZone":"America/New_York"},"body":"It seems whats happening is that the default prefetch of 1000 is being used. When the active master is killed, there are unack'd inflight messages on the broker->consumer connection. At that  point all bets are off in terms of the message order, as order will not be guaranteed when the messages are put back on the queue.\n\nIf you set the prefetch to 1, everything looks like it works correctly, for example: \nfailover:(tcp://localhost:61616)?maxReconnectDelay=1000&jms.prefetchPolicy.queuePrefetch=1&useExponentialBackOff=false\n\nI think if you added some buffering (vs the System.exit()) to the test to handle out of order messages, the consumer will get the messages - albeit out of order.\n\nRegards\n/Dave\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dave_stanley","name":"dave_stanley","key":"dave_stanley","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dave Stanley","active":true,"timeZone":"America/New_York"},"created":"2009-03-09T20:49:30.068+0000","updated":"2009-03-09T20:49:30.068+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940946","id":"12940946","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"I did some more testing today and it turns out this can be reproduced even in a single broker environment. Try starting/stopping a single broker until it happens. So IMHO this has to be related to the store recovery. It's also indicative that it usually happens when there is more active data files (4 or 5). Hope to have more info tomorrow. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-03-10T15:55:40.534+0000","updated":"2009-03-10T15:55:40.534+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940969","id":"12940969","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Just some heads up.\n\nIt turns out that with <systemUsage> on you can reproduce this problem even without restarting the broker, so the first step would be turn it off in this case, until we find the cause of this problem.\nIn this configuration it will not be lost messages for a fair number of consumers (like 10 in your original test case). Though you may experience some duplicate messages. Duplicates are normal in the failover situations and they are usually handled by the connection audit itself. The problem is that in this case the duplicate messages are not in the default 2k audit window so they reach the consumer. I filled the issue to make this window size configurable (https://issues.apache.org/activemq/browse/AMQ-2160), but until then you can add a bit of logic in your consumer to skip these messages.\nFor a large number of consumers this will still fail for the default broker shutdown rate of 20 secs, but increasing it to 60 secs or more makes this test runs fine for a quite a while. We'll keep investigating it further, but maybe this could help you get started. Can you post back your test results with these workarounds?\n\nThanks\nDejan","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-03-12T16:26:05.828+0000","updated":"2009-03-12T16:26:05.828+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940970","id":"12940970","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"body":"Dejan -\n\nBased on your comments, I tried a couple of tests.  In these tests I was running FUSE message broker 5.3.0.0.  I did not set the prefetch size, so it had the default value.  I did comment out the entire <systemUsage> stanza of the broker's configuration.\n\n1. I tried running with the default broker shutdown rate of 20 seconds as in my original test, to test the effect of removing <systemUsage> only.  This failed after 3 broker failovers.  The activemq log for this run is attached as activemq.log.2009_03_12_1\n\n{{Thu Mar 12 17:59:15 CDT 2009 started master broker pid 28845}}\n{{Thu Mar 12 17:59:25 CDT 2009 started slave broker pid 29069}}\n{{Thu Mar 12 17:59:35 CDT 2009 killing master broker pid 28845, new master pid 29069}}\n{{Thu Mar 12 17:59:55 CDT 2009 started slave broker pid 29285}}\n{{Thu Mar 12 18:00:15 CDT 2009 killing master broker pid 29069, new master pid 29285}}\n{{Thu Mar 12 18:00:35 CDT 2009 started slave broker pid 29515}}\n{{Thu Mar 12 18:00:55 CDT 2009 killing master broker pid 29285, new master pid 29515}}\n\n{{Mar 12, 2009 6:00:56 PM org.apache.activemq.transport.failover.FailoverTransport doReconnect}}\n{{INFO: Successfully reconnected to tcp://localhost:61616}}\n{{Mar 12, 2009 6:00:56 PM org.aaron.MasterSlaveTest$Receiver onMessage}}\n{{WARNING: test.queue.8 received 520 expected 2712}}\n\n\n2. Then I modified the script so it kills brokers every 60 seconds.  This also failed after 3 broker failovers.  The activemq log for this run is attached as activemq.log.2009_03_12_2\n\n{{Thu Mar 12 18:03:34 CDT 2009 started master broker pid 29871}}\n{{Thu Mar 12 18:03:44 CDT 2009 started slave broker pid 30090}}\n{{Thu Mar 12 18:04:44 CDT 2009 killing master broker pid 29871, new master pid 30090}}\n{{Thu Mar 12 18:05:44 CDT 2009 started slave broker pid 30402}}\n{{Thu Mar 12 18:06:44 CDT 2009 killing master broker pid 30090, new master pid 30402}}\n{{Thu Mar 12 18:07:44 CDT 2009 started slave broker pid 30725}}\n{{Thu Mar 12 18:08:44 CDT 2009 killing master broker pid 30402, new master pid 30725}}\n\n{{Mar 12, 2009 6:08:46 PM org.apache.activemq.transport.failover.FailoverTransport doReconnect}}\n{{INFO: Successfully reconnected to tcp://localhost:61616}}\n{{Mar 12, 2009 6:08:46 PM org.aaron.MasterSlaveTest$Receiver onMessage}}\n{{WARNING: test.queue.5 received 1049 expected 3205}}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-12T23:16:16.900+0000","updated":"2009-03-12T23:16:16.900+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940962","id":"12940962","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Aaron,\n\nwhat you are seeing now are duplicates that are out of default 2048 audit window size (see sequence numbers). I attached a modified MasterSlave test that skips these kind of messages (along with the activemq.xml used for testing). This should help a bit, but it's not a final solution to your problem. I'll implement now a fix for AMQ-2160 which will allow you to set window size to a larger value and avoid dealing with duplicates in your consumer. We'll also try to make this more stable afterwards, so stay tuned.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-03-13T08:58:22.157+0000","updated":"2009-03-13T08:58:22.157+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940984","id":"12940984","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"body":"Dejan -\n\nThanks for the information.  I'm not sure I understand the audit window size.  How large would the window need to be in my test for clients not to receive duplicates on failover?  Why does the broker still have messages that were delivered and acknowledged thousands of messages ago (ie 1049 when 3205 is expected)?  Why are these old, already delivered and acknowledged messages being processed on failover?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-13T11:38:27.937+0000","updated":"2009-03-13T11:38:27.937+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940992","id":"12940992","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"body":"Hi Aaron,\n\nI'm not sure why it happens in this case and it definitely should not send messages processed long time ago. All I can recommend at the moment is that if you receive duplicates in your real-world application, you should deal with them in your consumer. Shutting down the master every 20 sec or so, after all, isn't something you'll have in your production environment. We'll of course try get to the root of the problem and make it work even in this use case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=dejanb","name":"dejanb","key":"dejanb","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Dejan Bosanac","active":true,"timeZone":"Europe/Berlin"},"created":"2009-03-13T14:09:13.378+0000","updated":"2009-03-13T14:09:13.378+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12940985","id":"12940985","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"body":"Dejan -\n\nThanks for your comments.\n\nI agree a production system would probably not kill a broker every 20 seconds.  I developed this test case after observing occasional problems in testing broker failover in our application.  In our application, causing individual failovers sometimes causes old messages to be redelivered or new messages to be delivered out of order.\n\nBased on testing I have done, I believe there is currently some chance of redelivery of old messages or out of order delivery of new messages on *any* failover, not just after several rapid failovers.  I have observed the test case sometimes causes these problems on the *first* failover.\n\nThe reason for the rapid 20-second failovers is just to increase the probability of showing the problem in a short amount of time.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-14T22:27:58.998+0000","updated":"2009-03-14T22:27:58.998+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941058","id":"12941058","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Here is a patch for this issue. \nThere were a bunch of related problems originating from replayed messages from the failover transport. The failover transport replays any message that is in the process of being sent when the connection to the broker is goes down and is resumed. This is fine and expected. The message can be a duplicate and should be suppressed either on the broker side or on the consumer side.\n\nOne problem with the persisted hashindex that backs the reference store could result in a spurious message reference and \"could not be recovered, already dispatched message\". This ocurred when the duplicate reference caused an index to be changed and te original freed. The original can still be reference in the recoverNext() from the kahaReferenceStore. DataContainerImplTest shows this. \n\nIn addition, if the duplicate message is received before the existing message is dispatched and acked, the duplicate reference remains and will eventually get dispatched on restart or when the duplicate checker exceeds its range.\nEliminating the duplicate reference at source in the reference store resolves both these issues.\nWhen memory limits are reached, it was possible for a stores messages to be exhausted (cursor gets to the end) causing dispatch to halt until a restart. Dealing with recovery failure due to no space resolves this.\nA consumer ack of a duplicate message could be replaced with a delivery ack and get lost, thus leaving the duplicate to be redsipatched on restart and delivered to the consumer when the client side message audit is exceeded. This explains redelivery of old messages. Ensuring each duplicate is acked in turn resolves this.\nFinally, an unmatched ack can occur if recovery dispatch has not yet happened after a restart and an ack is received from a consumer as it was outstanding. In this case, the subscription can wait for recovery and a dispatch to kick in such that it will have a record of the target message. \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-26T15:10:24.382+0000","updated":"2009-03-26T16:07:10.854+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941064","id":"12941064","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolved in r758678","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-26T16:03:53.633+0000","updated":"2009-03-26T16:03:53.633+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941087","id":"12941087","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"committed some additional changes for this to deal with reaching the cache memory limits. r760075","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-30T18:30:39.502+0000","updated":"2009-03-30T18:30:39.502+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941111","id":"12941111","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"added some additional tests variants to exercise topics and queues in a large transaction. main change is in the way acks were delivered post failover. The failover transport state tracker no longer replays acks and the consumer acks duplcates in a transaction as deliveries to ensure the prefetch extension on the broker is extended. deliverAcks on transport resume has also been replaced with ack related state being reset so that normal acking of the redeliveries can ensue. (deliverAcks on resume lead to acks being received before they were dispatched by the recovering broker)\nr761597","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-03T10:23:16.528+0000","updated":"2009-04-03T10:23:16.528+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941122","id":"12941122","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"body":"I checked out the current activemq 5.3-SNAPSHOT from trunk (r762095) and built it.  This should have all of Gary's fixes in it, correct?\n\nI used the attached activemq.xml configuration file and ran my MasterSlaveTest and run_master_slave_brokers.sh to cause failovers.  This version of the test does not use transactions, and syncOnWrite was set to false.\n\nAfter 3 master/slave failovers one of the queues redelivered message 705 when the client expected 3570.\n\nFrom my perspective, it appears the problem is not solved by the changes listed so far.  Therefore I am reopening this issue.\n\n\nOutput from MasterSlaveTest:\n\n{{INFO: Successfully reconnected to tcp://localhost:61616}}\n{{Apr 5, 2009 7:31:55 AM org.apache.activemq.transport.failover.FailoverTransport doReconnect}}\n{{INFO: Successfully reconnected to tcp://localhost:61616}}\n{{Apr 5, 2009 7:31:56 AM org.aaron.MasterSlaveTest$Receiver onMessage}}\n{{WARNING: test.queue.2 received 705 expected 3570}}\n\n\nOutput from run_master_slave_brokers.sh:\n\n{{Sun Apr  5 07:30:13 CDT 2009 started master broker pid 5691}}\n{{Sun Apr  5 07:30:23 CDT 2009 started slave broker pid 5901}}\n{{Sun Apr  5 07:30:33 CDT 2009 killing master broker pid 5691, new master pid 5901}}\n{{Sun Apr  5 07:30:53 CDT 2009 started slave broker pid 6112}}\n{{Sun Apr  5 07:31:13 CDT 2009 killing master broker pid 5901, new master pid 6112}}\n{{Sun Apr  5 07:31:33 CDT 2009 started slave broker pid 6336}}\n{{Sun Apr  5 07:31:53 CDT 2009 killing master broker pid 6112, new master pid 6336}}\n\n\nLog file is attached as activemq.log.2009_04_05.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-05T14:37:04.434+0000","updated":"2009-04-05T14:37:04.434+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941129","id":"12941129","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Hi Aaron, thanks for the fast feedback. I have been able to reproduce the failure/duplicate with the junit test case by changing the sleep send time from 3 to the 25ms, which is what you are using. will work to resolve this today. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-06T10:03:15.052+0000","updated":"2009-04-06T10:03:15.052+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941137","id":"12941137","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"Aaron, if you refresh and pick up r762464, that should nail it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-06T19:52:49.643+0000","updated":"2009-04-06T19:52:49.643+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941133","id":"12941133","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"body":"Hi Gary -\n\nSo far I am unable to break your latest fix.  Will let you know if I run into issues.  Thanks for the fast turnaround.\n\nWill the r762464 piece of the fix be included with the fix for FUSE issue MB-456?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=aaronriekenberg","name":"aaronriekenberg","key":"aaronriekenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Aaron Riekenberg","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-06T23:55:36.862+0000","updated":"2009-04-06T23:55:36.862+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482954/comment/12941361","id":"12941361","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"this looks resolved to me","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2009-05-23T08:48:14.985+0000","updated":"2009-05-23T08:48:14.985+0000"}],"maxResults":19,"total":19,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2149/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s1af:"}}