{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482106","self":"https://issues.apache.org/jira/rest/api/2/issue/12482106","key":"AMQ-1148","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-03-01T22:32:23.773+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Nov 22 07:05:25 UTC 2007","customfield_12310420":"84716","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_25298075730_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2007-11-22T07:02:52.741+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1148/watchers","watchCount":0,"isWatching":false},"created":"2007-02-02T11:48:17.011+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315617","id":"12315617","description":"","name":"5.0.0","archived":false,"released":true,"releaseDate":"2007-12-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-11-22T07:05:25.471+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Following from this discussion:\n\nhttp://www.nabble.com/Fast-producer%2C-slow-consumer-with-spooling-to-disk--tf3123868.html\n\nRob Davies implemented VMPendingSubscriberMessageStoragePolicy which, if I understand correctly, should cause a fast producer to block if a slow consumer can't keep up.\n\nHowever, when running the attached test case, the system seems to hang before the consumers have received much more than 5 messages. When it hangs probably depends on the heap size.\n\nI get this:\n\n2007-02-02 13:44:23,281 [main           ] INFO  BrokerService                  - ActiveMQ null JMS Message Broker (localhost) is starting\n2007-02-02 13:44:23,281 [main           ] INFO  BrokerService                  - For help or more information please see: http://incubator.apache.org/activemq/\n2007-02-02 13:44:25,312 [main           ] INFO  JDBCPersistenceAdapter         - Database driver recognized: [apache_derby_embedded_jdbc_driver]\n2007-02-02 13:44:26,500 [main           ] INFO  DefaultDatabaseLocker          - Attempting to acquire the exclusive lock to become the Master broker\n2007-02-02 13:44:26,531 [main           ] INFO  DefaultDatabaseLocker          - Becoming the master on dataSource: org.apache.derby.jdbc.EmbeddedDataSource@1372656\n2007-02-02 13:44:26,593 [main           ] INFO  JournalPersistenceAdapter      - Journal Recovery Started from: Active Journal: using 2 x 20.0 Megs at: C:\\home\\albert\\work5\\activemq\\activemq-core\\activemq-data\\localhost\\journal\n2007-02-02 13:44:26,671 [main           ] INFO  JournalPersistenceAdapter      - Journal Recovered: 0 message(s) in transactions recovered.\n2007-02-02 13:44:26,859 [main           ] INFO  BrokerService                  - Using Persistence Adapter: JournalPersistenceAdapator(JDBCPersistenceAdaptor(org.apache.derby.jdbc.EmbeddedDataSource@1372656))\n2007-02-02 13:44:26,906 [main           ] INFO  JournalPersistenceAdapter      - Journal deleted: \n2007-02-02 13:44:29,296 [main           ] WARN  DefaultJDBCAdapter             - Could not create JDBC tables; they could already exist. Failure was: CREATE TABLE ACTIVEMQ_LOCK( ID BIGINT NOT NULL, TIME BIGINT, BROKER_NAME VARCHAR(250), PRIMARY KEY (ID) ) Message: Table/View 'ACTIVEMQ_LOCK' already exists in Schema 'APP'. SQLState: X0Y32 Vendor code: 30000\n2007-02-02 13:44:29,343 [main           ] WARN  DefaultJDBCAdapter             - Could not create JDBC tables; they could already exist. Failure was: INSERT INTO ACTIVEMQ_LOCK(ID) VALUES (1) Message: The statement was aborted because it would have caused a duplicate key value in a unique or primary key constraint or unique index identified by 'SQL070130113001540' defined on 'ACTIVEMQ_LOCK'. SQLState: 23505 Vendor code: 30000\n2007-02-02 13:44:29,484 [main           ] INFO  TransportServerThreadSupport   - Listening for connections at: tcp://ratbert:60706\n2007-02-02 13:44:29,515 [main           ] INFO  TransportConnector             - Connector tcp://ratbert:60706 Started\n2007-02-02 13:44:29,515 [main           ] INFO  BrokerService                  - ActiveMQ JMS Message Broker (localhost, ID:ratbert-2177-1170416663296-1:0) started\n2007-02-02 13:44:29,578 [JMX connector  ] INFO  ManagementContext              - JMX consoles can connect to service:jmx:rmi:///jndi/rmi://localhost:1099/jmxrmi\n2007-02-02 13:44:29,625 [/127.0.0.1:2181] INFO  KahaStore                      - Kaha Store successfully deleted data directory activemq-data\\localhost\\tmp_storage\nGOT A MESSAGE BEING SLOW\nGOT A MESSAGE BEING SLOW\nGOT A MESSAGE BEING SLOW\nGOT A MESSAGE BEING SLOW\nGOT A MESSAGE BEING SLOW\nGOT A MESSAGE BEING SLOW\nGOT A MESSAGE BEING SLOW\nGOT A MESSAGE BEING SLOW\nGOT A MESSAGE BEING SLOW\n\nbefore it hangs.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460604","id":"12460604","filename":"ASF.LICENSE.NOT.GRANTED--SlowConsumerTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-02-02T11:48:17.115+0000","size":4678,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460604/ASF.LICENSE.NOT.GRANTED--SlowConsumerTest.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460836","id":"12460836","filename":"SlowConsumerTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-03-02T01:12:31.147+0000","size":4799,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460836/SlowConsumerTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161715","customfield_12312823":null,"summary":"Fast producer, slow consumer hangs after a few messages when using VMPendingSubscriberMessageStoragePolicy","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[{"id":"12482019","key":"AMQ-1136","self":"https://issues.apache.org/jira/rest/api/2/issue/12482019","fields":{"summary":"Slow consumer causes producer to block on UsageManager.waitForSpace indefinately","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Sun JDK 1.6.0 on Windows XP SP2 with VM arguments -Xms384m -Xmx512m","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12938826","id":"12938826","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"body":"It seems the ActiveMQ transport thread is getting stuck on UsageManager.waitForSpace:\n\nName: ActiveMQ Transport: tcp:///127.0.0.1:2694\nState: WAITING on java.lang.Object@c98b07\nTotal blocked: 3  Total waited: 3\n\nStack trace: \njava.lang.Object.wait(Native Method)\njava.lang.Object.wait(Object.java:485)\norg.apache.activemq.memory.UsageManager.waitForSpace(UsageManager.java:91)\norg.apache.activemq.memory.UsageManager.waitForSpace(UsageManager.java:88)\norg.apache.activemq.broker.region.Topic.send(Topic.java:248)\norg.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:305)\norg.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:381)\norg.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:197)\norg.apache.activemq.broker.BrokerFilter.send(BrokerFilter.java:126)\norg.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:98)\norg.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:136)\norg.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:449)\norg.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:604)\norg.apache.activemq.broker.TransportConnection.service(TransportConnection.java:258)\norg.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:164)\norg.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:65)\norg.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:133)\norg.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:122)\norg.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\norg.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:137)\njava.lang.Thread.run(Thread.java:619)\n\nMeanwhile, all the ActiveMQ Session tasks are blocked:\n\nName: ActiveMQ Session Task\nState: BLOCKED on java.lang.Object@94cbe2 owned by: Thread-3\nTotal blocked: 4  Total waited: 10\n\nStack trace: \norg.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:43)\norg.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)\norg.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1165)\norg.apache.activemq.ActiveMQSession.asyncSendPacket(ActiveMQSession.java:1648)\norg.apache.activemq.ActiveMQMessageConsumer.afterMessageIsConsumed(ActiveMQMessageConsumer.java:700)\norg.apache.activemq.ActiveMQMessageConsumer.dispatch(ActiveMQMessageConsumer.java:871)\n   - locked java.lang.Object@8978c7\norg.apache.activemq.ActiveMQSessionExecutor.dispatch(ActiveMQSessionExecutor.java:99)\norg.apache.activemq.ActiveMQSessionExecutor.iterate(ActiveMQSessionExecutor.java:166)\norg.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:111)\norg.apache.activemq.thread.PooledTaskRunner.access$1(PooledTaskRunner.java:95)\norg.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:44)\njava.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:885)\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:907)\njava.lang.Thread.run(Thread.java:619)\n\nThread-3 seems to blocking on a write to the socket:\n\nName: Thread-3\nState: RUNNABLE\nTotal blocked: 327  Total waited: 0\n\nStack trace: \njava.net.SocketOutputStream.socketWrite0(Native Method)\njava.net.SocketOutputStream.socketWrite(SocketOutputStream.java:92)\njava.net.SocketOutputStream.write(SocketOutputStream.java:136)\norg.apache.activemq.transport.tcp.TcpBufferedOutputStream.flush(TcpBufferedOutputStream.java:109)\njava.io.DataOutputStream.flush(DataOutputStream.java:106)\norg.apache.activemq.transport.tcp.TcpTransport.oneway(TcpTransport.java:119)\norg.apache.activemq.transport.InactivityMonitor.oneway(InactivityMonitor.java:141)\norg.apache.activemq.transport.TransportFilter.oneway(TransportFilter.java:80)\norg.apache.activemq.transport.WireFormatNegotiator.oneway(WireFormatNegotiator.java:93)\norg.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:44)\n   - locked java.lang.Object@94cbe2\norg.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60)\norg.apache.activemq.ActiveMQConnection.asyncSendPacket(ActiveMQConnection.java:1165)\norg.apache.activemq.ActiveMQSession.send(ActiveMQSession.java:1546)\n   - locked java.lang.Object@d4f13a\norg.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:473)\norg.apache.activemq.ActiveMQMessageProducer.send(ActiveMQMessageProducer.java:358)\norg.apache.activemq.broker.region.cursors.SlowConsumerTest$1.run(SlowConsumerTest.java:87)\njava.lang.Thread.run(Thread.java:619)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-02-02T13:26:37.218+0000","updated":"2007-02-02T13:26:37.218+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12938704","id":"12938704","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"body":"Still having exactly the same problem as described in the original description. Tested with revision 509457.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-02-20T08:33:24.699+0000","updated":"2007-02-20T08:33:24.699+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12938829","id":"12938829","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Using a seperate connection for producer(s) and consumer(s) alleviates this - the consumer is blocked trying to acknowledge on the same connection the publisher is blocked awaiting space. As the test case is using non-persistent messages, the socket buffer fills, rather than the connection blocking awaiting a response from the broker.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-01T22:32:23.773+0000","updated":"2007-03-01T22:32:23.773+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12938797","id":"12938797","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"body":"Just to make sure I understand correctly: to avoid this problem, we should have connections that only deal with producers and connections that only deal with consumers. However, having a bunch of consumers (or producers, but only one of the two) on a connection should work?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-03-02T00:40:41.772+0000","updated":"2007-03-02T00:40:41.772+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12938862","id":"12938862","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"body":"Patching this workaround into an existing application is tricky. After reading the JMS spec, we assumed that we could pass Sessions around, allowing each component to create the consumers and producers it needs. Now I guess we'll have to send around ConnectionFactories. And if we forget to do this anywhere, we still get \"deadlocks\" that are very hard to debug.\n\nDo you anticipate that this issue could be fixed in a way that won't require a proliferation of extra connections?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-03-02T01:11:15.821+0000","updated":"2007-03-02T01:11:15.821+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12938867","id":"12938867","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"body":"Slow consumer test with multiple connections. Seems to work.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-03-02T01:12:31.233+0000","updated":"2007-03-02T01:12:31.233+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12936463","id":"12936463","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"body":"Just tested this again with the latest trunk. It seems to hang after 9 messages. Might be related to AMQ-1136.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=fullung","name":"fullung","key":"fullung","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Albert Strasheim","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-12T11:06:59.224+0000","updated":"2007-06-12T11:06:59.224+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12939248","id":"12939248","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Just test this again - and it does hang. However - the default prefetch size is about 32k for a topic - and given the size of the messages is 2k results in 65mb of messages being passed to the consumer before the broker will wait to dispatch more.  This results in out of memory errors and causes the InactivityMonitor in the consumer thread to barf, and the transport thinks its lost connection to the broker. The fix is to set the pretech limit lower for topics  and then it works -e.g.\n\n        ActiveMQConnectionFactory cf=new ActiveMQConnectionFactory(bindAddress);\n        Properties props=new Properties();\n        props.setProperty(\"prefetchPolicy.topicPrefetch\",\"\"+100);\n        cf.setProperties(props);\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-11-22T07:02:52.685+0000","updated":"2007-11-22T07:02:52.685+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482106/comment/12939191","id":"12939191","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"What I will do is add a policy to the broker to set the maximum memory size for messages outstanding for a consumer which can be used in conjunction with the pretetch size.\nIdeally this should be configurable on a consumer basis - but that would require a change to the wire format - which I don't want to do.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2007-11-22T07:05:25.392+0000","updated":"2007-11-22T07:05:25.392+0000"}],"maxResults":9,"total":9,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1148/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s1h3:"}}