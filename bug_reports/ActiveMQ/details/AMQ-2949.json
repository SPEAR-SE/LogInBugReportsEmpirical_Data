{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483842","self":"https://issues.apache.org/jira/rest/api/2/issue/12483842","key":"AMQ-2949","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2011-02-17T22:37:07.848+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Feb 17 22:37:07 UTC 2011","customfield_12310420":"43666","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_12218546313_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2011-02-17T22:37:07.840+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2949/watchers","watchCount":1,"isWatching":false},"created":"2010-09-29T12:34:41.550+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315624","id":"12315624","description":"Maintenance release for 5.4.0","name":"5.4.1","archived":false,"released":true,"releaseDate":"2010-09-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2011-02-17T22:37:07.859+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Hi, \n\nI'm trying to use ActiveMQ version 5.4.1 with priority. \n\nThe new features seems to work well when I left the prefetch size of my consumer equal to the default value (1000) but is not working as I'm expecting when I set the prefetch size to 1. \n\nHere is the output of the attached unint test when the prefetch size equal to 1000: \n\n2010-09-21 09:37:06,937 - JMS broker started \n2010-09-21 09:37:10,087 - Sent 1(P=3) \n2010-09-21 09:37:11,111 - Sent 2(P=9) \n2010-09-21 09:37:12,140 - Sent 3(P=3) \n2010-09-21 09:37:13,162 - Sent 4(P=3) \n2010-09-21 09:37:14,189 - Sent 5(P=9) \n2010-09-21 09:37:14,194 - Creating message consumer. \n2010-09-21 09:37:14,241 - *Consumer's pefetch size=1000*\n2010-09-21 09:37:14,289 - Received 2(P=9) \n2010-09-21 09:37:15,276 - Sent 6(P=3) \n2010-09-21 09:37:16,326 - Received 5(P=9) \n2010-09-21 09:37:16,333 - Sent 7(P=9) \n2010-09-21 09:37:17,354 - Sent 8(P=3) \n2010-09-21 09:37:18,332 - Received 7(P=9) \n2010-09-21 09:37:18,374 - Sent 9(P=3) \n2010-09-21 09:37:19,396 - Sent 10(P=9) \n2010-09-21 09:37:20,338 - Received 10(P=9) \n2010-09-21 09:37:22,345 - Received 1(P=3) \n2010-09-21 09:37:24,351 - Received 3(P=3) \n2010-09-21 09:37:26,358 - Received 4(P=3) \n2010-09-21 09:37:28,365 - Received 6(P=3) \n2010-09-21 09:37:30,371 - Received 8(P=3) \n2010-09-21 09:37:32,380 - Received 9(P=3) \n2010-09-21 09:37:34,387 - Expected result : [2(P=9), 5(P=9), 7(P=9), 10(P=9), 1(P=3), 3(P=3), 4(P=3), 6(P=3), 8(P=3), 9(P=3)] \n2010-09-21 09:37:34,387 - Result : [2(P=9), 5(P=9), 7(P=9), 10(P=9), 1(P=3), 3(P=3), 4(P=3), 6(P=3), 8(P=3), 9(P=3)] \nTests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 33.851 sec \n\n\nRunning the same test with a prefetch value of 1 give me a different result: \n\n2010-09-21 09:39:13,096 - JMS broker started \n2010-09-21 09:39:16,293 - Sent 1(P=3) \n2010-09-21 09:39:17,338 - Sent 2(P=9) \n2010-09-21 09:39:18,368 - Sent 3(P=3) \n2010-09-21 09:39:19,413 - Sent 4(P=3) \n2010-09-21 09:39:20,443 - Sent 5(P=9) \n2010-09-21 09:39:20,443 - Creating message consumer. \n2010-09-21 09:39:20,489 - *Consumer's pefetch size=1*\n2010-09-21 09:39:20,536 - Received 2(P=9) \n2010-09-21 09:39:21,511 - Sent 6(P=3) \n2010-09-21 09:39:22,550 - Received 5(P=9) \n2010-09-21 09:39:22,559 - *Sent 7(P=9)*\n2010-09-21 09:39:23,620 - Sent 8(P=3) \n2010-09-21 09:39:24,587 - *Received 1(P=3)*\n2010-09-21 09:39:24,650 - Sent 9(P=3) \n2010-09-21 09:39:25,640 - Sent 10(P=9) \n2010-09-21 09:39:26,590 - *Received 3(P=3) *\n2010-09-21 09:39:28,567 - *Received 4(P=3) *\n2010-09-21 09:39:30,574 - Received 7(P=9) \n2010-09-21 09:39:32,610 - Received 10(P=9) \n2010-09-21 09:39:34,622 - Received 6(P=3) \n2010-09-21 09:39:36,634 - Received 8(P=3) \n2010-09-21 09:39:38,616 - Received 9(P=3) \n2010-09-21 09:39:40,660 - Expected result : [2(P=9), 5(P=9), 7(P=9), 10(P=9), 1(P=3), 3(P=3), 4(P=3), 6(P=3), 8(P=3), 9(P=3)] \n2010-09-21 09:39:40,660 - Result : [2(P=9), 5(P=9), 1(P=3), 3(P=3), 4(P=3), 7(P=9), 10(P=9), 6(P=3), 8(P=3), 9(P=3)] \nTests run: 1, Failures: 1, Errors: 0, Skipped: 0, Time elapsed: 32.08 sec <<< FAILURE! \n\nAs you can see, depending of the prefetch value, the message delivery order is not the same. When the prefetch is 1, the message delivery order is not correct (messages 1,3 and 4 are received before message 7). If you look the timestamp, the message 7 is received by the JMS broker before message 1 is sent to the consumer. \n\nTo run the attached unit test, you need to have maven installed and run the following command: \nmvn test -DargLine=\"-DprefetchSize=<prefetch_size_value> -Dactivemq.port=61616\" \n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461875","id":"12461875","filename":"activemq-priority-testing.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbaril","name":"mbaril","key":"mbaril","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mathieu Baril","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-29T12:38:11.815+0000","size":5262,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461875/activemq-priority-testing.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"172443","customfield_12312823":null,"summary":"Message priority is not always handled correctly","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbaril","name":"mbaril","key":"mbaril","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mathieu Baril","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbaril","name":"mbaril","key":"mbaril","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mathieu Baril","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483842/comment/12943002","id":"12943002","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbaril","name":"mbaril","key":"mbaril","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mathieu Baril","active":true,"timeZone":"Etc/UTC"},"body":"A unit test that demonstrates the behavior describe in the issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mbaril","name":"mbaril","key":"mbaril","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Mathieu Baril","active":true,"timeZone":"Etc/UTC"},"created":"2010-09-29T12:38:11.884+0000","updated":"2010-09-29T12:38:11.884+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483842/comment/12996129","id":"12996129","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Code is working as designed.\n\nWith a prefetch of one the consumer has no ability to reorder messages that have arrived with respect to priority.  Since the test case create a consumer while still producing messages the broker can dispatch a lower priority message to the consumer before the next produced higher priority message arrives in the queue.  \n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2011-02-17T22:37:07.848+0000","updated":"2011-02-17T22:37:07.848+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2949/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0tvov:"}}