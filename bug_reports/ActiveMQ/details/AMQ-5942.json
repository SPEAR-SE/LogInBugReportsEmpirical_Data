{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12858082","self":"https://issues.apache.org/jira/rest/api/2/issue/12858082","key":"AMQ-5942","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2015-09-15T20:35:09.775+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Sep 22 16:06:28 UTC 2015","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2658892623_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2015-09-22T12:36:26.051+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5942/watchers","watchCount":4,"isWatching":false},"created":"2015-08-22T18:01:33.463+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12329382","id":"12329382","name":"5.11.1","archived":false,"released":true,"releaseDate":"2015-02-17"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2015-09-22T16:06:28.079+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"the current default factory is the CachedMessageGroupMapFactory which uses an LRUMap with a maxSize of 1024 keys.  If you use this with more than 1024 keys and fail to explicitly increase the maxSize, then the message groups fails to ensure ordering by group, same thread processing by group and overlapping execution.  \n\nI have reproduced this behavior in the attached unit test (using Camel routes as consumers)...if you switch to the SimpleMessageGroupMapFactory or increase the max size of the cache above the number of keys...the issues go away\n\ntwo suggestions\n-throw an error when the maxSize is exceeded if using the CachedMessageGroupMapFactory\n-make the SimpleMessageGroupMapFactory the default (unlimited)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12756030","id":"12756030","filename":"MessageGroupFactoryRouteTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boday","name":"boday","key":"boday","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boday&avatarId=17138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boday&avatarId=17138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boday&avatarId=17138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boday&avatarId=17138"},"displayName":"Ben O'Day","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-09-15T16:00:57.049+0000","size":5332,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12756030/MessageGroupFactoryRouteTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"CachedMessageGroupMapFactory fails with large key sets","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boday","name":"boday","key":"boday","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boday&avatarId=17138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boday&avatarId=17138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boday&avatarId=17138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boday&avatarId=17138"},"displayName":"Ben O'Day","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boday","name":"boday","key":"boday","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boday&avatarId=17138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boday&avatarId=17138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boday&avatarId=17138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boday&avatarId=17138"},"displayName":"Ben O'Day","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12858082/comment/14746115","id":"14746115","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"This doesn't really seem like a bug...it just seems like the documentation needs to be improved so that it is clear that the default is 1024 entries before eviction starts if nothing is specified.  A policy can easily be configured to increase the size if more entries are needed or to use the SimpleMessageGroupMapFactory for unlimited entries. \n\nAlso, I don't think it would be a good idea to throw an error if more than 1024 entries are added.  The LRU cache is designed to evict the oldest ones so it's not supposed to be an error condition to put more entries in there...the old ones just go away as intended.  However, a log statement could be added on eviction to warn that an entry is being evicted so it is at least clear what is happening.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2015-09-15T20:35:09.775+0000","updated":"2015-09-15T20:35:09.775+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12858082/comment/14746425","id":"14746425","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boday","name":"boday","key":"boday","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boday&avatarId=17138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boday&avatarId=17138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boday&avatarId=17138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boday&avatarId=17138"},"displayName":"Ben O'Day","active":true,"timeZone":"America/Los_Angeles"},"body":"[~cshannon] - if these were simply performance issues, then I'd agree...improve the docs and recommend alternate configs.  but, this factory completely breaks the message group algorithm under common scenarios w/o any indication...even the stock quote example on the message group feature page would exceed 1024 groups and break.\n\noverall, this is a bug because the factory does NOT guarantee single threaded processing or dispatch ordering by JMSXGroupId...the primary reasons to use message groups.  the fact that workarounds exist doesn't excuse the implementation...the runtime should prevent using a feature that simply won't do what its designed to under higher volume scenarios.  \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boday","name":"boday","key":"boday","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boday&avatarId=17138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boday&avatarId=17138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boday&avatarId=17138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boday&avatarId=17138"},"displayName":"Ben O'Day","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-09-15T22:49:36.453+0000","updated":"2015-09-15T22:49:36.453+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12858082/comment/14746444","id":"14746444","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"[~boday], Seems like maybe the best thing to do here is to just switch the default implementation to SimpleMessageGroupMapFactory instead of an LRU cache (as you mentioned in the original description) to prevent confusion and then document the ability to use an LRU cache through configuration if desired.\n\n[~tabish121], any reason you can think of not to switch out the default LRU implementation?  My main concern would be breaking existing users who are expecting an LRUCache to be used by default but I'm not sure how much of an issue that really is. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2015-09-15T23:02:46.851+0000","updated":"2015-09-15T23:02:46.851+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12858082/comment/14900861","id":"14900861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"[~cshannon] My guess would be the current configuration was chosen to produce a predictable memory footprint instead of the unbounded growth potential of the SimpleMessageGroupMapFactory.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2015-09-21T15:47:34.474+0000","updated":"2015-09-21T15:47:34.474+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12858082/comment/14901058","id":"14901058","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Yeah I figured the LRU cache was chosen for a reason which was my initial hesitation to change it.  So do you think this is something worth changing or do you just want to leave it as is and document it?  I suppose the default size of 1024 could also be increased as another option but not sure what a good default size would be.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2015-09-21T17:43:52.242+0000","updated":"2015-09-21T17:43:52.242+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12858082/comment/14902508","id":"14902508","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"body":"Based on my initial thoughts on this and after discussing this issue with [~tabish121], I don't think we should change this.  We don't want to leave a potential for unbounded memory usage in the broker. Plus, the current expectation is that the LRU implementation is the default.  We should update the documentation to describe this so that if someone needs more than 1024 groups they can change the policy configuration to increase the number of groups or to use a different implementation such as SimpleMessageGroupMapFactory.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cshannon","name":"cshannon","key":"christopher.l.shannon","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=christopher.l.shannon&avatarId=24614","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=christopher.l.shannon&avatarId=24614","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=christopher.l.shannon&avatarId=24614","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=christopher.l.shannon&avatarId=24614"},"displayName":"Christopher L. Shannon","active":true,"timeZone":"America/New_York"},"created":"2015-09-22T12:36:26.076+0000","updated":"2015-09-22T12:36:26.076+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12858082/comment/14902871","id":"14902871","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boday","name":"boday","key":"boday","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boday&avatarId=17138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boday&avatarId=17138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boday&avatarId=17138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boday&avatarId=17138"},"displayName":"Ben O'Day","active":true,"timeZone":"America/Los_Angeles"},"body":"I'd don't buy the memory usage argument...many default configs are unbounded (destination memoryLimit comes to mind)...and a memory issue would be preferable/easier to diagnose than silently causing concurrent/out of order processing...the whole reason to use message groups in the first place...\n\nat the very least, it should throw an error in the logs when the max LRU cache size is exceeded stating just that...\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=boday","name":"boday","key":"boday","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=boday&avatarId=17138","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=boday&avatarId=17138","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=boday&avatarId=17138","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=boday&avatarId=17138"},"displayName":"Ben O'Day","active":true,"timeZone":"America/Los_Angeles"},"created":"2015-09-22T16:06:28.079+0000","updated":"2015-09-22T16:06:28.079+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5942/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2j90n:"}}