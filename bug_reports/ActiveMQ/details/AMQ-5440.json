{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12755842","self":"https://issues.apache.org/jira/rest/api/2/issue/12755842","key":"AMQ-5440","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335045","id":"12335045","name":"5.13.3","archived":false,"released":true,"releaseDate":"2016-05-02"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12334188","id":"12334188","name":"5.14.0","archived":false,"released":true,"releaseDate":"2016-08-05"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2016-04-12T21:45:27.713+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Apr 12 21:45:27 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_44252615239_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2016-04-12T21:45:27.640+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5440/watchers","watchCount":3,"isWatching":false},"created":"2014-11-17T17:21:52.791+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"3.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"issuelinks":[{"id":"12463455","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12463455","type":{"id":"12310000","name":"Duplicate","inward":"is duplicated by","outward":"duplicates","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/12310000"},"inwardIssue":{"id":"12948950","key":"AMQ-6207","self":"https://issues.apache.org/jira/rest/api/2/issue/12948950","fields":{"summary":"KahaDB: corruption of the index possible on sudden stop of the broker","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-04-12T21:45:27.907+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"After being shutdown uncleanly, KahaDB can hit a startup error at times that causes the broker to fail to start up and potentially causes messages to be re-assigned that are not marked as redelivered.\n\nThe log message at startup is:\n2014-11-17 11:10:36,826 | ERROR | Looking for key 275 but not found in fileMap: {305=db-305.log number = 305 , length = 8217, 304=db-304.log number = 304 , length = 8217, 307=db-307.log number = 307 , length = 8217, 306=db-306.log number = 306 , length = 8217, 309=db-309.log number = 309 , length = 8217, 308=db-308.log number = 308 , length = 8217, 311=db-311.log number = 311 , length = 8217, 310=db-310.log number = 310 , length = 8217, 313=db-313.log number = 313 , length = 8217, 312=db-312.log number = 312 , length = 8217, 314=db-314.log number = 314 , length = 317, 303=db-303.log number = 303 , length = 8433} | org.apache.activemq.store.kahadb.disk.journal.Journal | main\n\nand the stack trace is:\nStarting TestApp...\n INFO | KahaDB is version 5\nERROR | Looking for key 275 but not found in fileMap: {305=db-305.log number = 305 , length = 8217, 304=db-304.log number = 304 , length = 8217, 307=db-307.log number = 307 , length = 8217, 306=db-306.log number = 306 , length = 8217, 309=db-309.log number = 309 , length = 8217, 308=db-308.log number = 308 , length = 8217, 311=db-311.log number = 311 , length = 8217, 310=db-310.log number = 310 , length = 8217, 313=db-313.log number = 313 , length = 8217, 312=db-312.log number = 312 , length = 8217, 314=db-314.log number = 314 , length = 317, 303=db-303.log number = 303 , length = 8433}\nException in thread \"main\" java.io.IOException: Could not locate data file KahaDB\\db-275.log\n\tat org.apache.activemq.store.kahadb.disk.journal.Journal.getDataFile(Journal.java:353)\n\tat org.apache.activemq.store.kahadb.disk.journal.Journal.read(Journal.java:600)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:1014)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.recoverProducerAudit(MessageDatabase.java:687)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.recover(MessageDatabase.java:595)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.open(MessageDatabase.java:400)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.load(MessageDatabase.java:418)\n\tat org.apache.activemq.store.kahadb.MessageDatabase.doStart(MessageDatabase.java:262)\n\tat org.apache.activemq.store.kahadb.KahaDBStore.doStart(KahaDBStore.java:194)\n\tat org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55)\n\tat org.apache.activemq.store.kahadb.KahaDBPersistenceAdapter.doStart(KahaDBPersistenceAdapter.java:215)\n\tat org.apache.activemq.util.ServiceSupport.start(ServiceSupport.java:55)\n\tat kahadbtest.TestApp.run(TestApp.java:29)\n\tat kahadbtest.TestApp.main(TestApp.java:21)\n\n\nThis was fairly hard to reproduce without unclean shutdown but the attached log and \"broken\" KahaDB folder should help debug the problem.  Also, I will attach the small test app that exercises the KahaDB APIs that I was using to cause the invalid state (I normally start and stop the app a few times until the problem appears at startup at which point it will no longer start).\n\nSome initial debugging looks like it might be related to the way that message acks are stored via the metadata serialization and how that interacts with the GC timer but I didn't see anything obvious.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12681928","id":"12681928","filename":"KahaDB.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-11-17T17:25:17.976+0000","size":8057,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12681928/KahaDB.zip"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12681927","id":"12681927","filename":"kahadbtest.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-11-17T17:25:17.969+0000","size":554841,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12681927/kahadbtest.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12681930","id":"12681930","filename":"TestApp.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-11-17T17:26:38.843+0000","size":1787,"mimeType":"text/x-java-source","content":"https://issues.apache.org/jira/secure/attachment/12681930/TestApp.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"KahaDB error at startup \"Looking for key N but not found in fileMap\"","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12755842/comment/14214868","id":"14214868","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"body":"Broker KahaDB folder that causes startup error and TRACE level log showing the GC records that caused it.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-11-17T17:25:17.982+0000","updated":"2014-11-17T17:25:17.982+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12755842/comment/14214872","id":"14214872","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"body":"Test app used to hit KahaDB error by causing many add/update/remove APIs while db-log files are being deleted.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-11-17T17:26:38.852+0000","updated":"2014-11-17T17:26:38.852+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12755842/comment/14220075","id":"14220075","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"body":"Debugged this a little more but the root cause isn't obvious even after adding more trace debugging.  Basically, the metadata that is written to disk at the time the checkpoint cleanup was done looks correct and would not cause a startup error because it is not referencing the files that are being cleaned and deleted from disk.  However, upon restart, a different set of metadata is loaded from disk which is old and still references a file that was deleted during the last checkpoint cleanup which causes the exception during open/recover as shown in the stack trace.  One workaround I tried was to force a rebuild of the index through journal replay for any exception thrown by the recover method (as shown below) but it doesn't feel like this is really getting to the root of the problem.\n\n//inside the open method:\npublic void open() throws IOException {\n...\n           startCheckpoint();\n           //recover //instead try to catch exceptions and rebuild the index\n            try {\n                recover();\n            } catch (IOException ex) {\n                LOG.warn(\"Recovery failure during open. Recovering the index through journal replay.\", ex);\n                // try to recover index\n                try {\n                    pageFile.unload();\n                } catch (Exception ignore) {}\n                if (archiveCorruptedIndex) {\n                    pageFile.archive();\n                } else {\n                    pageFile.delete();\n                }\n                metadata = createMetadata();\n                pageFile = null;\n                loadPageFile();\n                recover();\n            }","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jfugitt","name":"jfugitt","key":"jfugitt","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jesse Fugitt","active":true,"timeZone":"America/Chicago"},"created":"2014-11-20T21:50:44.444+0000","updated":"2014-11-20T21:50:44.444+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12755842/comment/15238054","id":"15238054","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"This appears to be the same as AMQ-6207.  The writes in the recovery file and the index could get out of sync.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2016-04-12T21:45:27.713+0000","updated":"2016-04-12T21:45:27.713+0000"}],"maxResults":4,"total":4,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5440/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i22gof:"}}