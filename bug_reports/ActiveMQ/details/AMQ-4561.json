{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12649865","self":"https://issues.apache.org/jira/rest/api/2/issue/12649865","key":"AMQ-4561","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/4","id":"4","description":"The problem is not completely described.","name":"Incomplete"},"customfield_12312322":null,"customfield_12310220":"2013-05-29T14:39:42.839+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Jul 08 20:01:23 UTC 2013","customfield_12310420":"330192","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_3493909687_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2013-07-08T20:01:23.287+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4561/watchers","watchCount":3,"isWatching":false},"created":"2013-05-29T09:29:33.623+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["broker","deadlock"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"}],"issuelinks":[{"id":"12372027","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12372027","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12657712","key":"AMQ-4632","self":"https://issues.apache.org/jira/rest/api/2/issue/12657712","fields":{"summary":"Fix of AMQ-4328 causes deadlocks during set up of the bridge","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2013-07-15T12:30:59.159+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"To establish a connection a spoke broker sends some special messages to the hub:\n•\tBrokerInfo\n•\tConnectionInfo\n•\tSessionInfo\n•\tProducerInfo\n•\tConsumerInfo\nIn return hub gsends exactly the same set of messages:\n•\tBrokerInfo\n•\tConnectionInfo\n•\tSessionInfo\n•\tProducerInfo\n•\tConsumerInfo\n \nAll messages are sent asynchronously so message order is not guaranteed. \n \nHowever BrokerInfo message has to be delivered BEFORE ConsumerInfo message to the spoke broker because:\n1. ConsumerInfo processing logic is depended on some information provided in BrokerInfo message so spoke broker side has lock on it.\n2.  All incoming messages are processed in the same thread including reading from tcp/nio stream.\nShort excerpt from DemandForwardingBridgeSupport class:\nprivate void startLocalBridge() throws Throwable {   BrokerInfo message processing\n…..\n    localStartedLatch.countDown();\n            }\nAnd ConsumerInfo message processing part has the lock:\ncase ConsumerInfo.DATA_STRUCTURE_TYPE:\n                                localStartedLatch.await();\nSo if ConsumerInfo message has been received before BrokerInfo message the consuming thread will be in dead lock: \nName: ActiveMQ NIO Worker 13\nState: WAITING on java.util.concurrent.CountDownLatch$Sync@150b06b\nTotal blocked: 1  Total waited: 3\nStack trace: \n sun.misc.Unsafe.park(Native Method)\njava.util.concurrent.locks.LockSupport.park(LockSupport.java:156)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:811)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:969)\njava.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1281)\njava.util.concurrent.CountDownLatch.await(CountDownLatch.java:207)\norg.apache.activemq.network.DemandForwardingBridgeSupport.serviceRemoteCommand(DemandForwardingBridgeSupport.java:534)\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12585591","id":"12585591","filename":"patch.diff","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-31T11:26:12.958+0000","size":3156,"mimeType":"application/octet-stream","content":"https://issues.apache.org/jira/secure/attachment/12585591/patch.diff"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"330526","customfield_12312823":null,"summary":"Deadlock in DemandForwardingBridgeSupport class if ConsumerInfo message has arrived before BrokerInfo message.","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649865/comment/13669136","id":"13669136","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"body":"This issue can be fixed for version 5.7.0 by the patch:\n--- DemandForwardingBridgeSupport.java\t\n+++ DemandForwardingBridgeSupport.java\t\n@@ -137,6 +137,7 @@\n     private TransportConnection duplexInitiatingConnection;\n     private BrokerService brokerService = null;\n     private ObjectName mbeanObjectName;\n+    private long BROKER_INFO_DELIVERING_TIMEOUT = 10;\n \n     public DemandForwardingBridgeSupport(NetworkBridgeConfiguration configuration, Transport localBroker, Transport remoteBroker) {\n         this.configuration = configuration;\n@@ -487,7 +488,10 @@\n                                 }\n                                 break;\n                             case ConsumerInfo.DATA_STRUCTURE_TYPE:\n--                                localStartedLatch.await();\n+                                if ( !localStartedLatch.await(BROKER_INFO_DELIVERING_TIMEOUT,TimeUnit.SECONDS)  )  \n+                                        {\n+                                 throw new Exception(\"ConsumerInfo message from a remote broker has been arrived before BrokerInfo message. Transport will be reconnected\");\n+                                        }\n                                 if (started.get()) {\n                                     if (!addConsumerInfo((ConsumerInfo) command)) {\n                                         if (LOG.isDebugEnabled()) {\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-29T10:23:04.885+0000","updated":"2013-05-29T10:24:37.095+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649865/comment/13669307","id":"13669307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Would recommend you test your code against a later release, much work has been done on the network bridge code. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-05-29T14:39:42.839+0000","updated":"2013-05-29T14:39:42.839+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649865/comment/13671354","id":"13671354","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"body":"Patch for 5.7.0","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-31T11:26:12.961+0000","updated":"2013-05-31T11:26:12.961+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649865/comment/13671357","id":"13671357","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"body":"The patch for 5.7.0 has been attached.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"created":"2013-05-31T11:27:02.363+0000","updated":"2013-05-31T11:27:02.363+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649865/comment/13671471","id":"13671471","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"The next release is going to be 5.9.0 so you need to have a look at trunk and see if you still have an issue, if so you can create a test case to reproduce and update your patch since the code has changed a good bit since 5.7","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-05-31T13:52:49.552+0000","updated":"2013-05-31T13:52:49.552+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12649865/comment/13702354","id":"13702354","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"No test case to validate on current version.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2013-07-08T20:01:23.305+0000","updated":"2013-07-08T20:01:23.305+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4561/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1kys7:"}}