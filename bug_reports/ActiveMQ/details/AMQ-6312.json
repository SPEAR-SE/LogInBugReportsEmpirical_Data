{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12976059","self":"https://issues.apache.org/jira/rest/api/2/issue/12976059","key":"AMQ-6312","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2016-07-17T00:47:31.852+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun Jul 17 00:47:31 UTC 2016","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6312/watchers","watchCount":3,"isWatching":false},"created":"2016-06-06T12:58:46.088+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12335045","id":"12335045","name":"5.13.3","archived":false,"released":true,"releaseDate":"2016-05-02"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2016-07-17T00:48:16.624+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We're using ActiveMQ via resource adapter, and with upgrading post 5.12.0 we want to handle the trusted packages configuration via resource adapter rather than via system properties.\n\nThis approach is not supported at all, because:\n\n# {{ActiveMQResourceAdapter}} does not expose {{setTrustedPackages}}\n# {{ActiveMQManagedConnectionFactory}} does not expose {{setTrustedPackages}}\n# Neither {{ServerSessionImpl}}, {{ActiveMQSession}} or {{MessageEndpointProxy}} set trusted packages on received {{ActiveMQObjectMessage}}\n\nThe first two could be solved by adding the support into {{ActiveMQConnectionSupport}} by adding a property and applying trustedPackages in {{createConnectionFactory(ActiveMQConnectionRequestInfo, MessageActiveationSpec}}.\n\nHowever, for the third one I'm not sure on which level the change should be applied - either session should be enforcing connection's trusted packages, or {{ServerSessionImpl}} could do it in its {{beforeDelivery}} method. But I cannot think of use case where session should not be handling this in first place. \n\nAlternatively, {{ActiveMQObjectMessage}} could get the trusted packages list from its connection, which guarantees that deserialization rules of the connection are always applied, not only when {{ActiveMQConnectionConsumer}} is used.\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ObjectMessage's setTrustedPackages can only be applied via system property in resource adappter setting","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976059/comment/15316524","id":"15316524","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"body":"Stack trace for receiving MDBs for reference:\n\nI've overriden RA's {{createConnectionFactory}} to set trusted packages.\n\n{code}\njavax.jms.JMSException: Failed to build body from content. Serializable class not available to broker. Reason: java.lang.ClassNotFoundException: Forbidden class <applicationClass>! This class is not trusted to be serialized as ObjectMessage payload. Please take a look at http://activemq.apache.org/objectmessage.html for more information on how to configure trusted classes.\n\tat org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:36)\n\tat org.apache.activemq.command.ActiveMQObjectMessage.getObject(ActiveMQObjectMessage.java:208)  // ActiveMQObjectMessage has default trusted packages\n\tat <applicationMDB>.onMessage(<applicationMDB>)\n\n        at .... Payara EJB container, RAR adapter ....\n\n\tat org.apache.activemq.ra.MessageEndpointProxy$MessageEndpointAlive.onMessage(MessageEndpointProxy.java:123)\n\tat org.apache.activemq.ra.MessageEndpointProxy.onMessage(MessageEndpointProxy.java:64)\n\tat org.apache.activemq.ActiveMQSession.run(ActiveMQSession.java:1041) // session.connection has configured trusted packages\n\tat org.apache.activemq.ra.ServerSessionImpl.run(ServerSessionImpl.java:169)\n\tat com.sun.enterprise.connectors.work.OneWork.doWork(OneWork.java:107)\n\tat com.sun.corba.ee.impl.threadpool.ThreadPoolImpl$WorkerThread.performWork(ThreadPoolImpl.java:497)\n\tat com.sun.corba.ee.impl.threadpool.ThreadPoolImpl$WorkerThread.run(ThreadPoolImpl.java:540)\nCaused by: java.lang.ClassNotFoundException: Forbidden class <application class>! This class is not trusted to be serialized as ObjectMessage payload. Please take a look at http://activemq.apache.org/objectmessage.html for more information on how to configure trusted classes.\n\tat org.apache.activemq.util.ClassLoadingAwareObjectInputStream.checkSecurity(ClassLoadingAwareObjectInputStream.java:112)\n\tat org.apache.activemq.util.ClassLoadingAwareObjectInputStream.resolveClass(ClassLoadingAwareObjectInputStream.java:57)\n\tat java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:1613)\n\tat java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1518)\n\tat java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:1774)\n\tat java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1351)\n\tat java.io.ObjectInputStream.readObject(ObjectInputStream.java:371)\n\tat org.apache.activemq.command.ActiveMQObjectMessage.getObject(ActiveMQObjectMessage.java:206)\n\t... 40 common frames omitted\n\n{code}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pdudits","name":"pdudits","key":"pdudits","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Patrik Dudits","active":true,"timeZone":"Europe/Berlin"},"created":"2016-06-06T14:02:40.047+0000","updated":"2016-06-06T14:02:53.561+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12976059/comment/15381007","id":"15381007","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Marco+de+Abreu","name":"Marco de Abreu","key":"marco de abreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco de Abreu","active":true,"timeZone":"Etc/UTC"},"body":"You're able to use the following code in your onMessage as a *workaround* until this feature is implemented:\n\n{code}\n\tprivate void addTrustedPackages(Message jmsMessage) throws IllegalAccessException {\n\t\tfinal List<String> defaultTrustedPackages = (List<String>) FieldUtils.readField(jmsMessage, \"trustedPackages\", true);\n\t\t\n\t\tArrayList<String> newTrustedPackages = new ArrayList<>(defaultTrustedPackages);\n\t\tnewTrustedPackages.addAll(TRUSTED_PACKAGES);\n\t\t\n\t\tFieldUtils.writeField(jmsMessage, \"trustedPackages\", newTrustedPackages, true);\n\t}\n{code}\n\nThis code takes advantage of the fact that the trusted packages are stored in the _ActiveMQObjectMessage_. An alternative would be to modify _ClassLoadingAwareObjectInputStream.trustedPackages_ but this could result in reduced security for your whole application so rather stick to the first method.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=Marco+de+Abreu","name":"Marco de Abreu","key":"marco de abreu","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Marco de Abreu","active":true,"timeZone":"Etc/UTC"},"created":"2016-07-17T00:47:31.852+0000","updated":"2016-07-17T00:48:16.571+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6312/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2z0tr:"}}