{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12677617","self":"https://issues.apache.org/jira/rest/api/2/issue/12677617","key":"AMQ-4850","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324950","id":"12324950","name":"5.10.0","archived":false,"released":true,"releaseDate":"2014-06-10"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2013-12-03T05:35:19.698+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jun 26 08:53:18 UTC 2014","customfield_12310420":"356992","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_20096990005_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-06-26T08:53:32.323+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4850/watchers","watchCount":5,"isWatching":false},"created":"2013-11-05T18:23:42.352+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofr√©","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-06-26T08:53:32.354+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12321013","id":"12321013","name":"OSGi/Karaf","description":"activemq-osgi / karaf and anyhow OSGi related"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I couldn't find a way to recreate this consistently, but after repeating several times the following steps reproduce it:\n\n1. Install custom Karaf 2.3.3 from scratch. Customizations include installing the activemq-broker feature using the featuresBoot configuration (along with a couple other unrelated features), and a dozen or so of my application's bundles in the deploy folder.\n\n2. Start Karaf - everything works fine.\n\n3. Shut down Karaf.\n\n4. Touch my application's 'common' bundle (in deploy folder). The other application bundles depend on this one. This is *not* the bundle that uses ActiveMQ.\n\n5. Start Karaf - it first starts all the app bundles (the old version I think), then it picks up the modified bundle timestamp and restarts the app bundles in what appears to be arbitrary order. This usually works, but once in a while the app's 'bus' bundle (which connects to ActiveMQ) fails to start with this exception showing up in the logs.\n\n6. Interestingly, restarting the app or activemq bundles, or even restarting Karaf itself, doesn't fix things - once it enters this invalid state, it seems to stay stuck in it and continues with the same exception and with the app unable to connect to ActiveMQ. However, if I shut down Karaf and once again touch my app's 'common' bundle in the deploy folder and then start up Karaf again, it restarts the app bundles and this time everything goes back to normal, with a successful connection to ActiveMQ. So it looks like while the first occurrence is not recreated consistently, this state is not just a runtime thing but remains persisted somehow for as long as the app bundle files aren't modified.\n\nHere is the stack trace:\n\njava.lang.NoClassDefFoundError: javax/net/ssl/SSLServerSocket\n        at org.apache.activemq.util.IntrospectionSupport.setProperty(IntrospectionSupport.java:163)\n        at org.apache.activemq.util.IntrospectionSupport.setProperties(IntrospectionSupport.java:151)\n        at org.apache.activemq.transport.failover.FailoverTransportFactory.createTransport(FailoverTransportFactory.java:74)\n        at org.apache.activemq.transport.failover.FailoverTransportFactory.createTransport(FailoverTransportFactory.java:63)\n        at org.apache.activemq.transport.failover.FailoverTransportFactory.doConnect(FailoverTransportFactory.java:38)\n        at org.apache.activemq.transport.TransportFactory.connect(TransportFactory.java:64)\n        at org.apache.activemq.ActiveMQConnectionFactory.createTransport(ActiveMQConnectionFactory.java:258)\n        at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:273)\n        at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:246)\n        at org.apache.activemq.ActiveMQConnectionFactory.createConnection(ActiveMQConnectionFactory.java:186)\n...\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"357282","customfield_12312823":null,"summary":"NoClassDefFoundError: javax/net/ssl/SSLServerSocket (in Karaf)","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Oracle JDK 7u45, Karaf 2.3.3 with activemq-broker installed from 5.9.0 feature","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13837356","id":"13837356","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"body":"Hello Amichai\n\nI have done several iterations of your scenario without success (I mean without {{NoClassDefFoundError}} :)). Tell me:\n* what are your dependencies ({{Import-Package}} or {{Require-Bundle}})?\n* does your {{common}} or {{bus}} bundle import ({{Import-Package}}) {{javax.net.ssl}} package?\n* what is your ActiveMQ connection URL (I've tested {{failover:(vm://localhost)}}).\n* (_optional_) how did you manage to install {{activemq-broker}} feature without patching {{KARAF/system/org/ops4j/pax/url/pax-url-mvn/1.3.6/pax-url-mvn-1.3.6.jar}} (see: https://ops4j1.jira.com/browse/BASE-48)\n\nregards\nGrzegorz Grzybek","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-03T05:35:19.698+0000","updated":"2013-12-03T05:35:19.698+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13837469","id":"13837469","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"body":"The imports/exports are below. Nothing imports or uses javax.net.ssl directly (the string \"javax.net\" doesn't appear anywhere in the project, actually), that's only in the ActiveMQ bundle.\n\nThe url is \"failover://(tcp://localhost:61616)?startupMaxReconnectAttempts=10\", though iirc it's the same error with only \"tcp://localhost:61616\" (in 5.8.0 the exception was masked when using failover url and could only be seen with a debug breakpoint in the ActiveMQ code, and only when using the tcp url directly was this exception printed to the logs. In 5.9.0 it is no longer being swallowed so the full exception is logged with either url).\n\nI don't know about that pax url bug - I just install the feature and it works. Maybe, as the related bug (KARAF-2536) suggests, I already had the library in the local maven repo, or maybe it's because I'm creating an offline custom karaf distribution and the maven plugin manages to get the problematic library at build time and it would only fail if karaf tried fetching it at runtime.\n\n\nThe imports/exports (copied form manifests and manually edited to be more readable here):\n\ncommon bundle:\n{quote}\nImport-Package:\n javax.xml.bind.annotation,org.osgi.framework;version=\"[1.6,2)\",\n org.osgi.service.blueprint.container;version=\"[1.0,2)\",\n org.slf4j;version=\"[1.7,2)\"\nExport-Package:\n com.myproject.common.core;version=\"0.1.0.SNAPSHOT\";uses:=\"javax.xml.bind.annotation\",\n com.myproject.common.framework;version=\"0.1.0.SNAPSHOT\";uses:=\"com.myproject.common.util,org.osgi.framework\",\n com.myproject.common.util;version=\"0.1.0.SNAPSHOT\"\n{quote}\n\nbus bundle:\n{quote}\nImport-Package:\n com.myproject.bus.api;version=\"[0.1,1)\",\n com.myproject.common.core;version=\"[0.1,1)\",\n com.myproject.common.framework;version=\"[0.1,1)\",\n com.myproject.common.util;version=\"[0.1,1)\",\n com.myproject.messaging.api;version=\"[0.1,1)\",\n com.myproject.messaging.jms;version=\"[0.1,1)\",\n javax.jms;version=\"[1.1,2)\",\n org.apache.activemq,org.osgi.service.blueprint;version=\"[1.0.0,2.0.0)\",\n org.slf4j;version=\"[1.7,2)\"\nExport-Package:\n com.myproject.bus.api;version=\"0.1.0.SNAPSHOT\";uses:=\"com.myproject.common.core\"\n{quote}\n\nmessaging bundle:\n{quote}\nImport-Package:\n com.myproject.common.core;version=\"[0.1,1)\",\n com.myproject.common.util;version=\"[0.1,1)\",\n javax.jms;version=\"[1.1,2)\",\n org.slf4j;version=\"[1.7,2)\"\nExport-Package:\n com.myproject.messaging.api;version=\"0.1.0.SNAPSHOT\";uses:=\"com.myproject.common.core\",\n com.myproject.messaging.jms;version=\"0.1.0.SNAPSHOT\";uses:=\"com.myproject.common.core,javax.jms\"\n{quote}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"created":"2013-12-03T09:01:32.435+0000","updated":"2013-12-03T09:01:32.435+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13837562","id":"13837562","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"body":"Still no {{NoClassDefFoundError}}.\nTry adding:\n{noformat}\nfelix.log.level=4\n{noformat}\nat the bottom of {{KARAF/etc/system.properties}} - there should be nice result of {{org.apache.felix.framework.BundleWiringImpl.diagnoseClassLoadError()}} invocation.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-03T10:43:43.746+0000","updated":"2013-12-03T10:43:43.746+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13837668","id":"13837668","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"body":"I added the log level config, and everything looks the same. I did notice that the first time the exception is printed there is an additional 'caused by' trace, though this may have been there before the log change (subsequent stack traces don't show it). Is there anything in particular I should be looking for?\n\njava.lang.NoClassDefFoundError: javax/net/ssl/SSLServerSocket\n        at org.apache.activemq.util.IntrospectionSupport.setProperty(IntrospectionSupport.java:163)\n        at org.apache.activemq.util.IntrospectionSupport.setProperties(IntrospectionSupport.java:151)\n        at org.apache.activemq.transport.failover.FailoverTransportFactory.createTransport(FailoverTransportFactory.java:74)\n        at org.apache.activemq.transport.failover.FailoverTransportFactory.createTransport(FailoverTransportFactory.java:63)\n        at org.apache.activemq.transport.failover.FailoverTransportFactory.doConnect(FailoverTransportFactory.java:38)\n        at org.apache.activemq.transport.TransportFactory.connect(TransportFactory.java:64)\n        at org.apache.activemq.ActiveMQConnectionFactory.createTransport(ActiveMQConnectionFactory.java:258)\n        at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:273)\n        at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:246)\n        at org.apache.activemq.ActiveMQConnectionFactory.createConnection(ActiveMQConnectionFactory.java:186)\n        at com.myproject.bus.activemq.ActiveMQSession.createConnection(ActiveMQSession.java:33)\n        at com.myproject.messaging.jms.Session.open(Session.java:71)[239:com.myproject.messaging:0.1.0.SNAPSHOT]\n        at com.myproject.messaging.jms.Session$1.run(Session.java:109)[239:com.myproject.messaging:0.1.0.SNAPSHOT]\n        at java.lang.Thread.run(Thread.java:744)[:1.7.0_45]\nCaused by: java.lang.ClassNotFoundException: javax.net.ssl.SSLServerSocket\n        at org.eclipse.osgi.internal.loader.BundleLoader.findClassInternal(BundleLoader.java:501)[osgi-3.8.0.v20120529-1548.jar:]\n        at org.eclipse.osgi.internal.loader.BundleLoader.findClass(BundleLoader.java:421)[osgi-3.8.0.v20120529-1548.jar:]\n        at org.eclipse.osgi.internal.loader.BundleLoader.findClass(BundleLoader.java:412)[osgi-3.8.0.v20120529-1548.jar:]\n        at org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader.loadClass(DefaultClassLoader.java:107)[osgi-3.8.0.v20120529-1548\n.jar:]\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:358)[:1.7.0_45]\n        ... 14 more","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"created":"2013-12-03T13:27:25.934+0000","updated":"2013-12-03T13:27:25.934+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13838633","id":"13838633","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"body":"The stack trace is different than mine, because I've tested creating connection in the Bundle-Activator thread and {{javax.net.ssl.SSLServerSocket}} is correctly loaded by {{org.apache.felix.framework.ExtensionManager.ExtensionManagerWiring.getClassByDelegation(String)}} related to system bundle. Eventually this class is loaded using {{sun.misc.Launcher$AppClassLoader}}.\n\nWhat you have is an attempt to connect to AMQ from custom thread, so my questions are:\n* how do you create the thread?\n* is this thread properly managed between bundle restarts?\n* have you set thread's context class loader?\n* where do you start the thread? (inside BundleActivator or in some bundle/service listener?)\n* what bundle starts the thread (bus? messaging?)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-04T05:57:07.855+0000","updated":"2013-12-04T05:58:47.010+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13838677","id":"13838677","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"body":"The same situation (no NCDFE) with the {{new Thread().start()}} case... So could you share your thread-related code?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-04T07:14:56.159+0000","updated":"2013-12-04T07:14:56.159+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13838708","id":"13838708","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"body":"And something else is different from my default configuration. In your case there's {{org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader}} involved - for me it is {{org.apache.felix.framework.BundleWiringImpl.BundleClassLoaderJava5}}. {{DefaultClassLoader}} seem to be used in special circumstances..","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-04T08:05:15.233+0000","updated":"2013-12-04T08:05:15.233+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13838742","id":"13838742","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"body":"I'm running with Equinox rather than Felix as the OSGi engine in Karaf, which might explain the different classloaders, and maybe the issue only happens with one and not the other. I'm using Equinox since I've hit some other unrelated issues using Felix, and in any case ActiveMQ should work with both.\n\nAs for the threading:\n- The messaging bundle has an abstract Session class that does a simple new Thread(...) in it's init() method.\n- The thread's ContextClassLoader is not modified.\n- It has a corresponding destroy() method which interrupts and joins the thread, so I believe it is properly closed across bundle restarts.\n- The whole Session implementation (and messaging bundle) uses clean JMS APIs, nothing AMQ-specific.\n- The bus bundle has an ActiveMQSession subclass of Session.\n- The ActiveMQSession is created in a blueprint configuration, which binds init-method to init() and destroy-method to destroy(). So that's basically the root of the thread's lifecycle.\n- The subclass only overrides a createConnection() method for creating an AMQ-specific connection using ActiveMQConnectionFactory. It doesn't change or add anything else on top of Session.\n- There is another bundle which similarly subclasses Session for creating Websphere MQ connections. It works properly, and is not running during these AMQ tests (I'm only mentioning it to explain the design which supports multiple MQ/JMS implementations via subclassing of Session in different bundles, and to show that it works ok with other provider implementations).\n\nI hope I answered all the questions :-)\n\nThanks for taking the time to look into this!\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"created":"2013-12-04T08:52:11.605+0000","updated":"2013-12-04T08:52:11.605+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13838771","id":"13838771","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"body":"One more thing. Add these lines at the bottom of {{KARAF/etc/system.properties}}:\n{noformat}\nosgi.debug=etc/system.properties\norg.eclipse.osgi/debug/loader=true\n{noformat}\n\nand run karaf with redirection to file (it will be HUGE), I got:\n{noformat}\nBundleClassLoader[org.apache.activemq.activemq-osgi_5.9.0].loadClass(javax.net.ssl.SSLServerSocket)\nBundleLoader[org.apache.activemq.activemq-osgi_5.9.0].loadBundleClass(javax.net.ssl.SSLServerSocket)\n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-04T09:39:13.236+0000","updated":"2013-12-04T09:39:13.236+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13842560","id":"13842560","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"body":"Ok, got some interesting output. It looks like activemq-osgi finds the class properly:\n{quote}\n{noformat}\nBundleClassLoader[org.apache.activemq.activemq-osgi_5.9.0].loadClass(javax.net.ssl.SSLServerSocket)\nBundleLoader[org.apache.activemq.activemq-osgi_5.9.0].loadBundleClass(javax.net.ssl.SSLServerSocket)\n{noformat}\n{quote}\nbut a little further down the activemq-web-console bundle fails to find it. So now there are two issues - why if fails to load the class, and why this causes the broker itself not to run rather than only the web console.\n{quote}\n{noformat}\nBundleClassLoader[org.apache.activemq.activemq-web-console_5.9.0].loadClass(javax.net.ssl.SSLServerSocket)\nBundleLoader[org.apache.activemq.activemq-web-console_5.9.0].loadBundleClass(javax.net.ssl.SSLServerSocket)\nBundleLoader[org.apache.activemq.activemq-web-console_5.9.0].findLocalClass(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/bundlefile].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/bundlefile].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/geronimo-jms_1.1_spec-1.1.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/geronimo-jta_1.0.1B_spec-1.0.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/geronimo-j2ee-management_1.1_spec-1.0.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/geronimo-jacc_1.1_spec-1.0.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-web-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-pool-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-jms-pool-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-client-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/rome-1.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/jdom-1.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/spring-webmvc-3.2.4.RELEASE.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/spring-beans-3.2.4.RELEASE.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/spring-context-3.2.4.RELEASE.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/spring-core-3.2.4.RELEASE.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/spring-expression-3.2.4.RELEASE.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/spring-web-3.2.4.RELEASE.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/aopalliance-1.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/spring-aop-3.2.4.RELEASE.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-console-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-kahadb-store-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-broker-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-openwire-legacy-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-protobuf-1.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/commons-net-3.3.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activeio-core-3.1.4.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/commons-pool-1.6.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/hawtbuf-proto-1.9.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/hawtbuf-1.9.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/jackson-core-asl-1.9.12.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/jackson-mapper-asl-1.9.12.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/velocity-1.7.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/commons-collections-3.2.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/commons-lang-2.6.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/org.apache.servicemix.bundles.josql-1.5_5.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/jasypt-1.9.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/commons-daemon-1.0.15.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/activemq-all-5.9.0.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/xbean-spring-3.14.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/commons-logging-1.1.3.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/core-3.1.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/slf4j-api-1.7.5.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/slf4j-log4j12-1.7.5.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/log4j-1.2.17.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/sitemesh-2.4.2.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/jstl-1.1.2.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/standard-1.1.2.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/xpp3-1.1.4c.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/xstream-1.4.4.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/xmlpull-1.1.3.1.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[/home/amichai/apps/itrade/apache-karaf-2.3.3/data/cache/org.eclipse.osgi/bundles/223/1/.cp/WEB-INF/lib/xpp3_min-1.1.4c.jar].findClassImpl(javax.net.ssl.SSLServerSocket)\nBundleClassLoader[org.apache.activemq.activemq-web-console_5.9.0].loadClass(javax.net.ssl.SSLServerSocket) failed.\njava.lang.ClassNotFoundException: javax.net.ssl.SSLServerSocket\n\tat org.eclipse.osgi.internal.loader.BundleLoader.findClassInternal(BundleLoader.java:501)\n\tat org.eclipse.osgi.internal.loader.BundleLoader.findClass(BundleLoader.java:421)\n\tat org.eclipse.osgi.internal.loader.BundleLoader.findClass(BundleLoader.java:412)\n\tat org.eclipse.osgi.internal.baseadaptor.DefaultClassLoader.loadClass(DefaultClassLoader.java:107)\n\tat java.lang.ClassLoader.loadClass(ClassLoader.java:358)\n\tat org.apache.activemq.util.IntrospectionSupport.setProperty(IntrospectionSupport.java:163)\n\tat org.apache.activemq.util.IntrospectionSupport.setProperties(IntrospectionSupport.java:151)\n\tat org.apache.activemq.transport.failover.FailoverTransportFactory.createTransport(FailoverTransportFactory.java:74)\n\tat org.apache.activemq.transport.failover.FailoverTransportFactory.createTransport(FailoverTransportFactory.java:63)\n\tat org.apache.activemq.transport.failover.FailoverTransportFactory.doConnect(FailoverTransportFactory.java:38)\n\tat org.apache.activemq.transport.TransportFactory.connect(TransportFactory.java:64)\n\tat org.apache.activemq.ActiveMQConnectionFactory.createTransport(ActiveMQConnectionFactory.java:258)\n\tat org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:273)\n\tat org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:246)\n\tat org.apache.activemq.ActiveMQConnectionFactory.createConnection(ActiveMQConnectionFactory.java:186)\n\tat com.myproject.bus.activemq.ActiveMQSession.createConnection(ActiveMQSession.java:33)\n\tat com.myproject.messaging.jms.Session.open(Session.java:71)\n\tat com.myproject.messaging.jms.Session$1.run(Session.java:109)\n\tat java.lang.Thread.run(Thread.java:744)\n{noformat}\n{quote}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"created":"2013-12-08T17:20:09.000+0000","updated":"2013-12-08T17:20:09.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13842947","id":"13842947","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"body":"I'd have hard work trying to mimic your configuration - your bundle 223 seem to be my bundle 120 which is the bundle with symbolic name {{org.apache.activemq.activemq-web-console}}.\n\nFrom the latest debug you've send I can see what I've confirmed with simple test - I've uninstalled bundle {{activemq-osgi}} so all imports from my app's bundles to activemq were resolved against imports from {{org.apache.activemq.activemq-web-console}}. This bundle have nested dependencies which are exported to the system.\n\nAnd after restart, I got nice and beautiful:\n{noformat}\nException in thread \"Thread-38\" java.lang.NoClassDefFoundError: javax/net/ssl/SSLServerSocket\n        at org.apache.activemq.util.IntrospectionSupport.setProperty(IntrospectionSupport.java:163)\n        at org.apache.activemq.util.IntrospectionSupport.setProperties(IntrospectionSupport.java:151)\n{noformat}\n\n:)\n\nI don't know why you're bundle seem to be resolved against web console bundle instead of proper activemq bundle. The web console's {{WEB-INF/lib}} dependencies are *not* OSGi bundles! So even if web console exports these dependencies' packages, the web console's bundle does \"not\" import {{javax.net.ssl}} (only {{javax.net}}) - and it's hardcoded in https://github.com/apache/activemq/blob/activemq-5.9.0/activemq-web-console/pom.xml#L142.\n\nCheck your bundles (use e.g., {{packages:exports}} gogo command). You can also add this code before connecting to ActiveMQ:\n{code:java}\nList<BundleWire> list = FrameworkUtil.getBundle(this.getClass()).adapt(BundleWiring.class).getRequiredWires(null);\nfor (BundleWire bw: list) {\n   System.out.println(bw.getRequirement() + \" -> \" + bw.getProvider());\n}\n{code}\n\nI got (after uninstalling {{activemq-osgi}}):\n{noformat}\n...\nosgi.wiring.package; resolution:=\"mandatory\"; filter:=\"(&(osgi.wiring.package=org.apache.activemq))\" -> org.apache.activemq.activemq-web-console_5.9.0\n...\n{noformat}\nand this wiring leads straight to NCDFE (because web console doesn't import {{javax.net.ssl}}\n\nSo your problem seem to be related with single thing - your bundle has been wired to {{org.apache.activemq.activemq-web-console_5.9.0}} instead of {{activemq-osgi}}...\n\nregards\nGrzegorz Grzybek","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-09T07:24:14.784+0000","updated":"2013-12-09T07:24:14.784+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13843112","id":"13843112","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"body":"I really appreciate you taking the time to try and resolve this issue, Grzegorz :-)\n\nSo what would you say the core issue is? The activemq-web-console bundle exporting activemq packages that it shouldn't be exporting?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"created":"2013-12-09T12:36:17.204+0000","updated":"2013-12-09T12:36:17.204+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13843117","id":"13843117","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"body":"Theoretically your {{Import-Package}} for {{org.apache.activemq}} should be satisfied by *any* relevant {{Export-Package}} - I don't know why Equinox chooses the export from the console and not the {{activemq-osgi}} - the spec says it chooses the export from the _first resolved bundle_ - what are the bundle ids of {{org.apache.activemq.activemq-web-console}} and {{activemq-osgi}}? (check {{osgi:list}}).\nWhat you said that after the problem occurs, it exists after the restarts - it exists, because Equinox caches the state of resolution (and bundle wiring through Import-Export connections).\n\nI think that cutting of all the exports from {{activemq-web-console}} should resolve the problem - also uninstallng the console. But I'm only a humble open source enthusiast and cannot decide what this bundle exports...\n\ntry stopping the {{activemq-web-console}} bundle (you have id=223):\n{noformat}\nosgi:stop 223\nosgi:update 223\n{noformat}\nfirst command changes its state to {{resolved}}, second - to {{installed}}. Then try restarting your bundles.\n\nI think that eventually web console should *not* export its internal JARs' packages...\n\nregards\nGrzegorz Grzybek","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gzres","name":"gzres","key":"gzres","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=gzres&avatarId=16612","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=gzres&avatarId=16612","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=gzres&avatarId=16612","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=gzres&avatarId=16612"},"displayName":"Grzegorz Grzybek","active":true,"timeZone":"Europe/Berlin"},"created":"2013-12-09T12:45:48.751+0000","updated":"2013-12-09T12:45:48.751+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/13843197","id":"13843197","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"body":"I tried it out - stopping and updating the web console bundle does fix the issue (until the next app bundle deploy, that is), but only after a Karaf restart. It seems that during runtime the existing wirings remain intact even when the bundle is in Installed state. To see this, I used the dev:show-tree command (on my bus bundle) before stopping the web console bundle:\n{quote}\n{noformat}\n+- org.apache.activemq.activemq-web-console [223]\n|  +- org.apache.geronimo.specs.geronimo-servlet_2.5_spec [78]\n|  +- org.ops4j.pax.logging.pax-logging-api [4]\n|  +- org.ops4j.pax.web.pax-web-jsp [219]\n|  |  +- org.ops4j.pax.logging.pax-logging-api [4]\n|  |  +- org.apache.geronimo.specs.geronimo-servlet_2.5_spec [78]\n|  +- org.apache.felix.configadmin [5]\n|  +- org.eclipse.jetty.continuation [85]\n|     +- org.apache.geronimo.specs.geronimo-servlet_2.5_spec [78]\n|     +- org.mortbay.jetty.util [157]\n|        +- org.ops4j.pax.logging.pax-logging-api [4]\n|        +- org.apache.geronimo.specs.geronimo-servlet_2.5_spec [78]\n...\n{noformat}\n{quote}\nand after osgi:stop and osgi:update (in Intalled state):\n{quote}\n{noformat}\n+- org.apache.activemq.activemq-web-console [223]\n...\n{noformat}\n{quote}\ni.e. the bundle itself is still there, even though the entire subtree under it is gone (I don't know what that means).\nJust for completeness, after the Karaf restart (the web console bundle now shows up back as Resolved) it is indeed wired properly to the activemq-osgi bundle instead:\n{quote}\n{noformat}\n+- org.apache.activemq.activemq-osgi [200]\n...\n{noformat}\n{quote}\n\nSo now there are a few open questions:\n- Is this the correct behavior when stopping a bundle, or a bug in Equinox/Karaf? (I was expecting the console bundle to no longer be used, and a new wiring to activemq-osgi to happen at runtime when the console bundle was stopped without requiring a restart, but my assumption may be wrong.)\n- Why was it wiring to the web console bundle (223) rather than activemq-osgi (200) in the first place? Is this just a race condition during startup? Do the bundle ids have anything to do with it?\n- I too think the original problem is with the web console bundle export configuration. It should probably only be exporting the packages under org.apache.activemq.web*, if at all. Btw the org.apache.activemq.web.config package seems to be split between this bundle and one of the embedded jars in WEB-INF/lib, which is probably not so good for osgi either. Can a developer familiar with the activemq-web-console bundle confirm which exports are really needed there?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=amichai","name":"amichai","key":"amichai","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Amichai Rothman","active":true,"timeZone":"Asia/Jerusalem"},"created":"2013-12-09T14:27:41.337+0000","updated":"2013-12-09T14:27:41.337+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12677617/comment/14044481","id":"14044481","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofr√©","active":true,"timeZone":"Europe/Berlin"},"body":"It's fixed in ActiveMQ 5.10.0 and 5.9.2-SNAPSHOT.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbonofre","name":"jbonofre","key":"jbonofre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jean-Baptiste Onofr√©","active":true,"timeZone":"Europe/Berlin"},"created":"2014-06-26T08:53:18.917+0000","updated":"2014-06-26T08:53:18.917+0000"}],"maxResults":15,"total":15,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4850/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1pjjr:"}}