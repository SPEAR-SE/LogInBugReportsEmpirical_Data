{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482962","self":"https://issues.apache.org/jira/rest/api/2/issue/12482962","key":"AMQ-1837","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/3","id":"3","description":"The problem is a duplicate of an existing issue.","name":"Duplicate"},"customfield_12312322":null,"customfield_12310220":"2008-07-03T15:38:11.707+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Apr 15 15:56:22 UTC 2009","customfield_12310420":"88619","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_24726908558_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2009-04-15T15:56:22.097+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1837/watchers","watchCount":6,"isWatching":false},"created":"2008-07-03T11:21:13.539+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-04-15T15:56:22.096+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We experienced that some messages (send in persistent mode) were lost after the message broker was killed and restarted.\nThe attached little test simulates the situation:\nThere are 10 queues, 10 sender and 10 receiver threads each sending / receiving quite frequently to / from one queue for a quite long time.\nThe receiver for each queue expects the messages exactly in the order the sender has send the messages.\nAfter restarting (killing) the broker the order of the received messages gets disturbed or messages get lost. \n\n* Start the broker as configures by default in the distribution (only switch on JMX support). \n* Start the main method of the attached class\n* Wait until some messages are received\n* kill or shutdown the broker\n* restart the broker\n* have a look at the output of the test class\n{code:title=Output}\nException in ReceiverThread: java.lang.RuntimeException: Received unexpected message! Expected: QUEUE-4: #3197, Received: QUEUE-4: #3267\n{code}\n\n{code:title=Broker Output}\n...\nINFO  BrokerService                  - Using Persistence Adapter: AMQPersistenceAdapter(D:\\sandbox\\Experimental\\Activemq\\apache-activemq-5.2-SNAPSHOT\\bin\\..\\data)\nINFO  AMQPersistenceAdapter          - AMQStore starting using directory: D:\\sandbox\\Experimental\\Activemq\\apache-activemq-5.2-SNAPSHOT\\bin\\..\\data\nINFO  KahaStore                      - Kaha Store using data directory D:\\sandbox\\Experimental\\Activemq\\apache-activemq-5.2-SNAPSHOT\\bin\\..\\data\\kr-store\\state\nINFO  AMQPersistenceAdapter          - Active data files: []\nWARN  AMQPersistenceAdapter          - The ReferenceStore is not valid - recovering ...\nINFO  KahaStore                      - Kaha Store successfully deleted data directory D:\\sandbox\\Experimental\\Activemq\\apache-activemq-5.2-SNAPSHOT\\bin\\..\\data\\kr-store\\data\nINFO  AMQPersistenceAdapter          - Journal Recovery Started from: DataManager:(data-)\nINFO  KahaStore                      - Kaha Store using data directory D:\\sandbox\\Experimental\\Activemq\\apache-activemq-5.2-SNAPSHOT\\bin\\..\\data\\kr-store\\data\nINFO  AMQPersistenceAdapter          - Recovered 198261 operations from redo log in 18.028 seconds.\nINFO  AMQPersistenceAdapter          - Finished recovering the ReferenceStore\nINFO  BrokerService                  - ActiveMQ 5.2-SNAPSHOT JMS Message Broker (localhost) is starting\n...\n{code}\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461146","id":"12461146","filename":"ASF.LICENSE.NOT.GRANTED--src.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wiemer","name":"wiemer","key":"wiemer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jan Wiemer","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-03T11:21:13.542+0000","size":2097,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461146/ASF.LICENSE.NOT.GRANTED--src.zip"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12461093","id":"12461093","filename":"MultithreadedQueueTest2.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janknecht","name":"janknecht","key":"janknecht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Helmut Janknecht","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-03T15:38:11.578+0000","size":3710,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12461093/MultithreadedQueueTest2.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"255151","customfield_12312823":null,"summary":"Lost messages after broker recovery","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wiemer","name":"wiemer","key":"wiemer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jan Wiemer","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wiemer","name":"wiemer","key":"wiemer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jan Wiemer","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482962/comment/12939915","id":"12939915","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wiemer","name":"wiemer","key":"wiemer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jan Wiemer","active":true,"timeZone":"Etc/UTC"},"body":"By the way I used: {{apache-activemq-5.2-20080619.135742-2-bin.zip}}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wiemer","name":"wiemer","key":"wiemer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jan Wiemer","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-03T11:31:07.181+0000","updated":"2008-07-03T11:31:07.181+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482962/comment/12939916","id":"12939916","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wiemer","name":"wiemer","key":"wiemer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jan Wiemer","active":true,"timeZone":"Etc/UTC"},"body":"Note that the problem seems not to occur when working with a single queue (and one sender thread and one receiver thread).","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wiemer","name":"wiemer","key":"wiemer","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jan Wiemer","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-03T12:21:46.793+0000","updated":"2008-07-03T12:21:46.793+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482962/comment/12939909","id":"12939909","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janknecht","name":"janknecht","key":"janknecht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Helmut Janknecht","active":true,"timeZone":"Etc/UTC"},"body":"I changed code a little bit and do the receive with a 120s timeout in order to avoid race conditions there.\nAddtionally I now sent object messages with approx. 2K size. With prefetch size set to default it fails often after Kaha recovery. With low prefetch size 5 or 10 failure rate is lower but not 0...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janknecht","name":"janknecht","key":"janknecht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Helmut Janknecht","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-03T15:38:11.707+0000","updated":"2008-07-03T15:38:11.707+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482962/comment/12939920","id":"12939920","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janknecht","name":"janknecht","key":"janknecht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Helmut Janknecht","active":true,"timeZone":"Etc/UTC"},"body":"One example log of a failure, here actually without a restart:\n\n{noformat}\nQUEUE-2 currently sent message #10000\nQUEUE-8 currently received message #9000\nQUEUE-4 currently sent message #10000\nQUEUE-5 currently sent message #10000\nQUEUE-9 currently sent message #10000\nQUEUE-0 currently received message #10000\nQUEUE-3 currently sent message #10000\nQUEUE-4 currently received message #10000\nQUEUE-2 currently received message #10000\nUnexpected message from QUEUE-8! Expected: QUEUE-8: #9342, Received: QUEUE-8: #9343\n{noformat}\n\nIt skipped one message #9342.\nBrowsing QUEUE-8 with JMX showed:\n\n{noformat}\n----------------------------------------------------------------------\nID:dono-janknecht-4560-1215150766850-0:6:1:1:9344: QUEUE-8: #9344\nID:dono-janknecht-4560-1215150766850-0:6:1:1:9345: QUEUE-8: #9345\nID:dono-janknecht-4560-1215150766850-0:6:1:1:9346: QUEUE-8: #9346\nID:dono-janknecht-4560-1215150766850-0:6:1:1:9347: QUEUE-8: #9347\nID:dono-janknecht-4560-1215150766850-0:6:1:1:9348: QUEUE-8: #9348\nID:dono-janknecht-4560-1215150766850-0:6:1:1:9350: QUEUE-8: #9350\n...\nID:dono-janknecht-4560-1215150766850-0:6:1:1:9474: QUEUE-8: #9474\nID:dono-janknecht-4560-1215150766850-0:6:1:1:9475: QUEUE-8: #9475\n----------------------------------------------------------------------\n{noformat}\n\nSo QUEUE-8 does not contain this element.\n\nThen I restarted the broker and now surprisingly the missing \"QUEUE-8: #9342\" appears, the \"JMSRedelivered\" is set to false.\n\nSo it seems that under heavy load in multi threaded scenarios persistent messages somtimes stuck.\nWith {{DeliveryMode.NON_PERSISTENT}} it seems to work.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janknecht","name":"janknecht","key":"janknecht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Helmut Janknecht","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-04T06:21:50.343+0000","updated":"2008-07-04T06:51:46.496+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482962/comment/12939962","id":"12939962","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janknecht","name":"janknecht","key":"janknecht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Helmut Janknecht","active":true,"timeZone":"Etc/UTC"},"body":"Any news here about this issue?\nI retried with latest apache-activemq-5.2-20080713.231541-8 and same problem: after a few seconds one of receiver thread skips a message:\n\n{noformat}\n...\nQ2 currently received: Q2: #2000\nQ0 currently received: Q0: #2000\nUnexpected message from Q4! Expected: Q4: #2155, Received: Q4: #2156 (JMSRedelivered=false)\nUnexpected message from Q3! Expected: Q3: #2177, Received: Q3: #2178 (JMSRedelivered=false)\n----------------------------------------------------------------------\nID:dono-janknecht-3517-1216026084546-0:0:1:1:2158: Q4: #2158\nID:dono-janknecht-3517-1216026084546-0:0:1:1:2160: Q4: #2160\nID:dono-janknecht-3517-1216026084546-0:0:1:1:2161: Q4: #2161\nID:dono-janknecht-3517-1216026084546-0:0:1:1:2164: Q4: #2164\nID:dono-janknecht-3517-1216026084546-0:0:1:1:2166: Q4: #2166\n...\n{noformat}\n\nAnd this again without any restart or so but with PERSISTENT messages.\nHere it skipped #2155 in Q4 and JMX browsing shows that also #2159 is missing.\nIf you then stop broker normally and restart these two messages are there again!?\n\nI tried same scenario for example with Sun's OpenMQ 4.2 and there it works. \nFor us this is a real show stopper because we rely on strict queue message ordering...","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=janknecht","name":"janknecht","key":"janknecht","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Helmut Janknecht","active":true,"timeZone":"Etc/UTC"},"created":"2008-07-14T09:32:53.889+0000","updated":"2008-07-14T09:32:53.889+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482962/comment/12941174","id":"12941174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"this should be resolved on trunk by: http://svn.apache.org/viewvc?rev=758678&view=rev\n\nRelated issue: https://issues.apache.org/activemq/browse/AMQ-2149\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-04-15T15:56:22.034+0000","updated":"2009-04-15T15:56:22.034+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1837/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1825j:"}}