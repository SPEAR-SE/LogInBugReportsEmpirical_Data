{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481993","self":"https://issues.apache.org/jira/rest/api/2/issue/12481993","key":"AMQ-1187","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/2","id":"2","description":"The problem described is an issue which will never be fixed.","name":"Won't Fix"},"customfield_12312322":null,"customfield_12310220":"2007-06-27T08:51:34.443+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jun 28 11:11:54 UTC 2007","customfield_12310420":"84417","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_9941091272_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2007-06-28T11:11:54.890+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1187/watchers","watchCount":1,"isWatching":false},"created":"2007-03-05T09:47:03.618+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315612","id":"12315612","description":"","name":"4.0.2","archived":false,"released":true,"releaseDate":"2006-07-25"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12315613","id":"12315613","description":"","name":"4.1.0","archived":false,"released":true,"releaseDate":"2006-11-13"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2007-06-28T11:11:54.887+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"I sent 1000 messages in own threads but monitoring the queue with jconsole sometimes only 999 are in the queue. \nThis happens more likely if you raise the number of sent messages 10.000 or 100.000 but can also happen if set to 100.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460615","id":"12460615","filename":"ASF.LICENSE.NOT.GRANTED--console.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-05T09:47:03.732+0000","size":24,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460615/ASF.LICENSE.NOT.GRANTED--console.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460942","id":"12460942","filename":"ASF.LICENSE.NOT.GRANTED--jconsole.png","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-05T09:47:03.702+0000","size":8544,"mimeType":"image/png","content":"https://issues.apache.org/jira/secure/attachment/12460942/ASF.LICENSE.NOT.GRANTED--jconsole.png"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460623","id":"12460623","filename":"ASF.LICENSE.NOT.GRANTED--TestMqBroker.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-05T09:47:03.741+0000","size":1917,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460623/ASF.LICENSE.NOT.GRANTED--TestMqBroker.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460887","id":"12460887","filename":"TestMqBroker2.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-28T10:24:18.097+0000","size":2784,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460887/TestMqBroker2.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460950","id":"12460950","filename":"TestMqBroker3.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-28T11:09:55.228+0000","size":2922,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460950/TestMqBroker3.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"254975","customfield_12312823":null,"summary":"Messages sent in parallel threads may not be enqueued","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux ","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481993/comment/12936159","id":"12936159","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"You sure this isn't just that the jconsole stats go a bit wonky sometimes? We've seen folks report negative queue sizes, so there could be an issue with the stats not always being totally accurrate.\n\ni.e. are you sure there really are messages missing?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-27T08:51:34.443+0000","updated":"2007-06-27T08:51:34.443+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481993/comment/12936179","id":"12936179","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tom%40samplonius.org","name":"tom@samplonius.org","key":"tom@samplonius.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tom Samplonius","active":true,"timeZone":"America/Los_Angeles"},"body":"The negative queue size bug is 100% reproducible, and affects JMX and the Web Console counters.  Just put a 100 persistent messages into a queue, stop ActiveMQ, and then start ActiveMQ, and tell a consumer to read all of the messages.  The queue size will be \"-100\".  ActiveMQ does not ask its persistence engine to return the number of messages already in the queue, so it always starts with all counters at zero.\n\nNow, JConsole may lag.  I don't know how often it refreshes.  But it doesn't not sound like you are having the negative queue size problem, unless the OP started and stopped ActiveMQ with messages in the queue.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tom%40samplonius.org","name":"tom@samplonius.org","key":"tom@samplonius.org","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Tom Samplonius","active":true,"timeZone":"America/Los_Angeles"},"created":"2007-06-28T01:34:14.369+0000","updated":"2007-06-28T01:34:14.369+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481993/comment/12936195","id":"12936195","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"body":"Hello, first thank you for your comments. \n\nI re-tested the issue by also receiving all the sent messages with TestMqBroker2.java and it turned out that the number of messages received were exactly matching the information of the JConsole.\n\nI sent 10000 messages with no errors or exceptions thrown, the JConsole showed 9998 messages enqueued and I received exactly this 9998 Messages.\n\n\nConsole output:\n\nstart sending\nend sending\nMsgs sent: 10000\nMsgs received: 9998\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-28T10:24:18.219+0000","updated":"2007-06-28T10:24:18.219+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481993/comment/12936251","id":"12936251","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"I just mentioned this on IRC but figured I'd repeat here for anyone watching JIRA. IT could just be you're using multiple threads, but not using thread safe counters.\n\nTry refactor the 'int count*\" variables to use AtomicInteger instead and see if its still an issue?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-28T10:43:13.322+0000","updated":"2007-06-28T10:43:13.322+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481993/comment/12936209","id":"12936209","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mteira","name":"mteira","key":"mteira","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manuel Teira","active":true,"timeZone":"Etc/UTC"},"body":"Hello.\nI think the problem is that you're using the same Session object from different threads. This is not the intended usage, if you read the JMS API Specification, it says:\n\nA Session object is a single-threaded context for producing and consuming messages. Although it may allocate provider resources outside the Java virtual machine (JVM), it is considered a lightweight JMS object.\n\nand also:\n\nOnce a connection has been started, any session with one or more registered message listeners is dedicated to the thread of control that delivers messages to it. It is erroneous for client code to use this session or any of its constituent objects from another thread of control. The only exception to this rule is the use of the session or connection close method.\n\nWhat I deduce from this, is that you need a different session for any of your producer and consumer threads.\n\n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=mteira","name":"mteira","key":"mteira","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Manuel Teira","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-28T10:44:12.655+0000","updated":"2007-06-28T10:44:12.655+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481993/comment/12936237","id":"12936237","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"body":"Thanks Manuel Teira, this was the problem.\n\nIf one QueueSession is used for each Thread it works perfectly.\n\nThanks again, both of you.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=pgoellnitz","name":"pgoellnitz","key":"pgoellnitz","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Philippe Göllnitz","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-28T11:09:55.487+0000","updated":"2007-06-28T11:09:55.487+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481993/comment/12936174","id":"12936174","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"Many thanks guys for helping resolve this. So its clear that using the same session/producer to send concurrently has issues; but then via the JMS specification you are not meant to do this. So the workaround is either\n\n* synchronise on the send method\n* use a separate session/producer per thread\n* use Camel as a facade over JMS to avoid these kinds of issues\n* use Spring's JmsTemplate with the PoolingConnectionFactory\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2007-06-28T11:11:54.870+0000","updated":"2007-06-28T11:11:54.870+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1187/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1812f:"}}