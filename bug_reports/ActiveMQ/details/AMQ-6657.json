{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"13064360","self":"https://issues.apache.org/jira/rest/api/2/issue/13064360","key":"AMQ-6657","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/10004","id":"10004","description":"Not A Bug","name":"Not A Bug"},"customfield_12312322":null,"customfield_12310220":"2017-04-17T15:31:04.609+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Apr 19 18:23:56 UTC 2017","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_208249443_*|*_6_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2017-04-19T18:23:56.581+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6657/watchers","watchCount":3,"isWatching":false},"created":"2017-04-17T08:33:07.189+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12338909","id":"12338909","name":"5.14.4","archived":false,"released":true,"releaseDate":"2017-03-02"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2017-04-19T18:23:56.629+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Here is the long story\nhttp://activemq.2283324.n4.nabble.com/How-to-setup-policy-for-client-side-message-acceptance-td4724961.html\n\nUse case\n# setup policy for\n#* sender setter mode 'unsettled'\n#* receiver settle mode 'second'\n# connect to brocker\n\nExpected result\n* broker respects requested policy\n\nActual result\n* broker resets\n** sender settle mode - 'settle'\n** receiver settle mode - 'first'\n\nLog\n{code}\n  amqp10:framing sending frame:  @attach(18) [name='test_d5c61642-99b0-4315-bef5-7bffdf0f8d64' handle=0 role=false senderSettleMode=0 receiverSettleMode=1 source=@source(40) [address='localhost' durable=0 expiryPolicy='session-end' timeout=0 dynamic=false dynamicNodeProperties={} distributionMode=null filter={} defaultOutcome=null outcomes=null capabilities=null] target=@target(41) [address='test' durable=0 expiryPolicy='session-end' timeout=0 dynamic=false dynamicNodeProperties={} capabilities=null] unsettled={} incompleteUnsettled=false initialDeliveryCount=1 maxMessageSize=0 offeredCapabilities=null desiredCapabilities=null properties={}] +1ms\n  amqp10:trace raw: [0000009602000001005312c0890ea129746573745f64356336313634322d393962302d343331352d626566352d376266666466306638643634434250005001005328c0260ba1096c6f63616c686f737443a30b73657373696f6e2d656e644342c1010040c10100404040005329c01b07a1047465737443a30b73657373696f6e2d656e644342c1010040c10100425201444040c10100] +0ms\n  amqp10:connection Rx: 0000008602000000005312c07907a129746573745f64356336313634322d393962302d343331352d626566352d376266666466306638643634434150025000005328c02308a1096c6f63616c686f737443a30b73657373696f6e2d656e644342c1010040c10100005329c01a06a1047465737443a30b73657373696f6e2d656e644342c101000000002402000000005313c017075201707fffffff5201707fffffff43520170000003e8 +1ms\n  amqp10:framing received frame:  @attach(18) [name='test_d5c61642-99b0-4315-bef5-7bffdf0f8d64' handle=0 role=true senderSettleMode=2 receiverSettleMode=0 source=@source(40) [address='localhost' durable=0 expiryPolicy='session-end' timeout=0 dynamic=false dynamicNodeProperties={} distributionMode=null filter={} defaultOutcome=null outcomes=null capabilities=null] target=@target(41) [address='test' durable=0 expiryPolicy='session-end' timeout=0 dynamic=false dynamicNodeProperties={} capabilities=null] unsettled={} incompleteUnsettled=false initialDeliveryCount=null maxMessageSize=0 offeredCapabilities=null desiredCapabilities=null properties={}] +2ms \n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"ActiveMQ does not respect sender and receiver link settle mode","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wingedfox","name":"wingedfox","key":"wingedfox","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ilya Lebedev","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wingedfox","name":"wingedfox","key":"wingedfox","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ilya Lebedev","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/13064360/comment/15971149","id":"15971149","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gemmellr","name":"gemmellr","key":"gemmellr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Robbie Gemmell","active":true,"timeZone":"Europe/London"},"body":"Your logs actually show the broker setting the sender-settle-mode to 'mixed', and not 'settled' as you mentioned. This is an entirely legal thing for the broker to do, essentially saying each message transfers settled value will define behaviour, though admittedly could be unexpected if the client requested something more specific.\n\nFrom your mailing list post, you said:\n{quote}\nIt is not clear, how to achieve message acceptance on client.\n\nFollowing OASIS AMQP1.0 docs, I assume that I have to setup\nsender-settle-mode - unsettled (0)\nreceiver-settle-mode - second (1)\nin order to use accept/modify/reject methods, but it does not work as expected. \n{quote}\n\nTo allow the client to accept messages you'd need sender-settle-mode of 'unsettled' or 'mixed' (where messages are actually sent unsettled in the latter case), and 'first' or 'second' receiver receiver-settle-modes, i.e. what you are getting allows accepting messages. Using 'second' for the receiver-settle-mode is only needed for the 'two-ack' exactly-once delivery process, which ActiveMQ doesn't currently support, only at-least-once or at-most-once, hence the broker is properly indicating what it is actually supporting/doing by setting 'first'.\n\n{quote}\nIt shows that despite the fact that there's no consumer connected to the queue I receive 'settled=true state=accepted' for the message sent\n{quote}\nAs you should have: you sent the message to a queue, unsettled, and the broker put it in the queue and then accepted+settled the message, i.e. it got queued as you asked.\n\nIn this case I think its all actually doing exactly what you've said you want, until the point you try to 'modify' the message to indicate 'undeliverable-here' (but oddly, not delivery-failed). The ActiveMQ 5 broker currently takes that as a reason to DLQ the message, as you noticed, meaning it wont be available to another consumer except via the DLQ.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gemmellr","name":"gemmellr","key":"gemmellr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Robbie Gemmell","active":true,"timeZone":"Europe/London"},"created":"2017-04-17T15:31:04.609+0000","updated":"2017-04-17T15:31:04.609+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13064360/comment/15974363","id":"15974363","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wingedfox","name":"wingedfox","key":"wingedfox","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ilya Lebedev","active":true,"timeZone":"Etc/UTC"},"body":"bq. Your logs actually show the broker setting the sender-settle-mode to 'mixed', and not 'settled' as you mentioned.\nSorry, you're right. It sets 'mixed' mode.\n\nbq. This is an entirely legal thing for the broker to do, essentially saying each message transfers settled value will define behaviour, though admittedly could be unexpected if the client requested something more specific.\nYou're right. As long as driver obey settings received from broker, I can't track errors caused by wrong message settlement mode.\n\nbq. As you should have: you sent the message to a queue, unsettled, and the broker put it in the queue and then accepted+settled the message, i.e. it got queued as you asked.\nThis is exactly the problem I talk about, I need to be sure that the message has been processed, not only enqueued.\n\nbq. In this case I think its all actually doing exactly what you've said you want, until the point you try to 'modify' the message to indicate 'undeliverable-here' (but oddly, not delivery-failed).\nThis is exactly what I need. Product evolution plan defines experimental features  to be turned on for a certain period of time and if experimental consumer prefers not to process message, it returns latter one to a queue marked 'undeliverableHere' to prevent re-delivery to itself; 'release' is not an option here because ActiveMQ immediately returns message back to consumer.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wingedfox","name":"wingedfox","key":"wingedfox","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ilya Lebedev","active":true,"timeZone":"Etc/UTC"},"created":"2017-04-19T09:15:05.996+0000","updated":"2017-04-19T09:15:05.996+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13064360/comment/15974678","id":"15974678","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"{quote}\nThis is exactly the problem I talk about, I need to be sure that the message has been processed, not only enqueued.\n{quote}\n\nThe broker doesn't inform you of message processing, nor should it.  The nature of a decoupled message broker is that you queue a message and at some point later in time some other process dequeues it.  If you need to know that the message was processed than the standard practice of request / response would be an option. \n\n{quote}\nThis is exactly what I need. Product evolution plan defines experimental features to be turned on for a certain period of time and if experimental consumer prefers not to process message, it returns latter one to a queue marked 'undeliverableHere' to prevent re-delivery to itself; 'release' is not an option here because ActiveMQ immediately returns message back to consumer.\n{quote}\n\nThere are some limitations to what the broker can do based on the legacy nature of it being primarily a JMS broker.  For messages that are tagged as undeliverable here, the only option it has is to send them off to the DLQ as the broker has no mechanism do directly release a message back to the queue.   You can work around this using broker configuration for [Broker Redelivery|http://activemq.apache.org/message-redelivery-and-dlq-handling.html] but that does not guarantee that the broker won't send the message back to the same consumer if it's still connected.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-04-19T13:37:57.513+0000","updated":"2017-04-19T13:37:57.513+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13064360/comment/15974688","id":"15974688","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gemmellr","name":"gemmellr","key":"gemmellr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Robbie Gemmell","active":true,"timeZone":"Europe/London"},"body":"{quote}\nThis is exactly the problem I talk about, I need to be sure that the message has been processed, not only enqueued.\n{quote}\nOk, so what you want is end-to-end acknowledgement between producer and consumer (or a searate response message)? If so thats entirely unclear from your description. The broker cant do that, and it isnt how brokered queuing works in general: you send messages to the queue, they store and forward messages, acknowledgments are between the clients and the broker both for producing or consuming, not between the clients.\n\nActiveMQ doesnt support the behaviour you want from 'undeliverableHere', so at best thats a feature request to make it, in which case you may have mroe luck with new features requests for Artemis. At worst, it still wouldnt do what you want since the producer would not have any knowledge of the action by the consumer or the messge being requeued for delivery only to other consumers, so again youd need to look at doing something like request-response based messaging, or if you really want end-to-end acknoweldgement, perhaps look an entirely different solution. One example would be Qpid Dispatch router, which can support end-to-end acknowledgement because it is a router rather than a broker and never takes ownership of a message.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gemmellr","name":"gemmellr","key":"gemmellr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10441","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10441","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10441","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10441"},"displayName":"Robbie Gemmell","active":true,"timeZone":"Europe/London"},"created":"2017-04-19T13:44:57.005+0000","updated":"2017-04-19T13:46:14.556+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13064360/comment/15975217","id":"15975217","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wingedfox","name":"wingedfox","key":"wingedfox","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ilya Lebedev","active":true,"timeZone":"Etc/UTC"},"body":"[OASIS spec |http://docs.oasis-open.org/amqp/core/v1.0/csd02/amqp-core-messaging-v1.0-csd02.html#type-modified] tells us:\n\n{quote}\nAt the source the modified outcome means that the message is no longer acquired by the receiver, and has been made available for (re-)delivery to the same or other targets receiving from the node. ...\n.\n.\n.\n undeliverable-here\tprevent redelivery\toptional boolean\n    If the undeliverable-here is set, then any messages released MUST NOT be redelivered to the modifying link endpoint. \n{quote}\n\nI understand this as follows: {{modify(undeliverableHere)}} equals to {{release}} with the exception that modified link is excluded from the list of available targets.\n\nOk, I got it that this feature is not supported, but it would be great to learn these from docs, rather than from code.\n\nbq.  At worst, it still wouldnt do what you want since the producer would not have any knowledge of the action by the consumer or the messge being requeued for delivery only to other consumers, so again youd need to look at doing something like request-response based messaging, or if you really want end-to-end acknoweldgement, perhaps look an entirely different solution.\n\nEnd-to-end confirmation is not required, of course, but there was a chance that I'm doing something wrong there. I've found a workaround with {{redeliveryPlugin}}, but it is exactly workaround because it sometimes tries to send message back to consumer which asks not to deliver that message.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=wingedfox","name":"wingedfox","key":"wingedfox","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Ilya Lebedev","active":true,"timeZone":"Etc/UTC"},"created":"2017-04-19T18:16:52.437+0000","updated":"2017-04-19T18:16:52.437+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/13064360/comment/15975234","id":"15975234","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Code is working as originally designed.  \n\nEnhancement requests can be opened for items in this JIRA if desired but the broker is working as designed at present.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2017-04-19T18:23:56.620+0000","updated":"2017-04-19T18:23:56.620+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-6657/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i3dopj:"}}