{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12703233","self":"https://issues.apache.org/jira/rest/api/2/issue/12703233","key":"AMQ-5118","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":"2014-03-25T17:37:07.062+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 26 16:15:43 UTC 2014","customfield_12310420":"381571","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5118/watchers","watchCount":3,"isWatching":false},"created":"2014-03-24T16:09:56.962+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"issuelinks":[{"id":"12387829","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12387829","type":{"id":"10030","name":"Reference","inward":"is related to","outward":"relates to","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10030"},"inwardIssue":{"id":"12710404","key":"AMQ-5161","self":"https://issues.apache.org/jira/rest/api/2/issue/12710404","fields":{"summary":"NullPointerException during async startup","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-05-11T13:34:26.993+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"We run activemq as an embedded broker using the asynchronous startup option.  After the start async call returns, we create a vm connector with the extra options \"?create=false&waitForStart=60000\".  There is a timing hole where the BrokerService has been registered with the BrokerRegistry (and is found by the connection factory), but the BrokerServer.broker member variable has not yet been assigned (in fact, there may be some memory visibility issues here).  The VMTransportFactory eventually generates a call to BrokerService.getBroker(), which (since broker == null) attempts to create a broker instance.  This ultimately results in a JMX exception due to multiple instances being registered (assuming you have jmx enabled).\n\n{noformat}\njavax.jms.JMSException: Could not create Transport. Reason: java.io.IOException: Status MBean could not be registe\nred in JMX: org.apache.activemq:type=Broker,brokerName=internal,service=Health\n  at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:36)\n  at org.apache.activemq.ActiveMQConnectionFactory.createTransport(ActiveMQConnectionFactory.java:260)\n  at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:273)\n  at org.apache.activemq.ActiveMQConnectionFactory.createActiveMQConnection(ActiveMQConnectionFactory.java:246)\n  at org.apache.activemq.ActiveMQConnectionFactory.createConnection(ActiveMQConnectionFactory.java:186)\n  at <internal stacktrace ommitted>\n  at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:895)\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:918)\n  at java.lang.Thread.run(Thread.java:662)\nCaused by: java.io.IOException: Status MBean could not be registered in JMX: org.apache.activemq:type=Broker,brokerName=internal,service=Health\n  at org.apache.activemq.util.IOExceptionSupport.create(IOExceptionSupport.java:27)\n  at org.apache.activemq.broker.BrokerService.addInterceptors(BrokerService.java:2242)\n  at org.apache.activemq.broker.BrokerService.createBroker(BrokerService.java:2123)\n  at org.apache.activemq.broker.BrokerService.getBroker(BrokerService.java:906)\n  at org.apache.activemq.broker.TransportConnector.start(TransportConnector.java:201)\n  at org.apache.activemq.transport.vm.VMTransportFactory.doCompositeConnect(VMTransportFactory.java:140)\n  at org.apache.activemq.transport.vm.VMTransportFactory.doConnect(VMTransportFactory.java:54)\n  at org.apache.activemq.transport.TransportFactory.connect(TransportFactory.java:64)\n  at org.apache.activemq.ActiveMQConnectionFactory.createTransport(ActiveMQConnectionFactory.java:258)\n  ... 37 more\nCaused by: javax.management.InstanceAlreadyExistsException: org.apache.activemq:type=Broker,brokerName=internal,service=Health\n  at com.sun.jmx.mbeanserver.Repository.addMBean(Repository.java:453)\n  at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.internal_addObject(DefaultMBeanServerInterceptor.java:1484)\n  at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerDynamicMBean(DefaultMBeanServerInterceptor.java:963)\n  at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerObject(DefaultMBeanServerInterceptor.java:917)\n  at com.sun.jmx.interceptor.DefaultMBeanServerInterceptor.registerMBean(DefaultMBeanServerInterceptor.java:312)\n  at com.sun.jmx.mbeanserver.JmxMBeanServer.registerMBean(JmxMBeanServer.java:483)\n  at org.apache.activemq.broker.jmx.ManagementContext.registerMBean(ManagementContext.java:380)\n  at org.apache.activemq.broker.jmx.AnnotatedMBean.registerMBean(AnnotatedMBean.java:72)\n  at org.apache.activemq.broker.BrokerService.addInterceptors(BrokerService.java:2240)\n  ... 44 more\n{noformat}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12636941","id":"12636941","filename":"QueueServiceTest.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"created":"2014-03-26T16:15:43.633+0000","size":1924,"mimeType":"text/x-java","content":"https://issues.apache.org/jira/secure/attachment/12636941/QueueServiceTest.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"381846","customfield_12312823":null,"summary":"Race condition with embedded broker asynchronous startup","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12703233/comment/13945617","id":"13945617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"body":"Note that i've found a workaround for now.  If i call BrokerService.getBroker() before calling BrokerService.start(), the internal broker instance is created and assigned before the rest of startup proceeds and there is no longer a race condition with the connection factory startup.  During a normal BrokerService (asynchronous) startup, the Broker instance is not created until after the persistence adapters are started.  I'm not sure what the implications of my workaround are (creating the broker instance before the persistence adapters are started) but everything seems to be working fine with this change in place.\n\nAssuming that creating the broker instance earlier in the startup process is legitimate, maybe the BrokerService could be changed to do that in the start() method before breaking off for the rest of the asynchronous startup process.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"created":"2014-03-24T19:56:00.566+0000","updated":"2014-03-24T19:56:00.566+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12703233/comment/13946827","id":"13946827","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Can you create a unit test to reproduce this?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-03-25T17:37:07.062+0000","updated":"2014-03-25T17:37:07.062+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12703233/comment/13948049","id":"13948049","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"body":"It's a race condition, so obviously difficult to test.  however, i've introduced some delays into the broker startup in the test code and they seem to reliably cause the problem on my box.  without the artificial delays, the test would fail about 1 out of 3 times on my box.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jahlborn","name":"jahlborn","key":"jahlborn","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james","active":true,"timeZone":"America/New_York"},"created":"2014-03-26T16:15:43.637+0000","updated":"2014-03-26T16:15:43.637+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5118/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1tqof:"}}