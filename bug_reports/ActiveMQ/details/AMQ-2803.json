{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12483932","self":"https://issues.apache.org/jira/rest/api/2/issue/12483932","key":"AMQ-2803","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315623","id":"12315623","description":"version 5 feature complete","name":"5.4.0","archived":false,"released":true,"releaseDate":"2010-08-17"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2010-06-28T11:14:13.073+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Thu Jul 08 14:38:26 UTC 2010","customfield_12310420":"74794","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_877070957_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2010-07-08T14:38:26.082+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2803/watchers","watchCount":0,"isWatching":false},"created":"2010-06-28T11:00:35.125+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315622","id":"12315622","description":"","name":"5.3.2","archived":false,"released":true,"releaseDate":"2010-05-11"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2010-07-08T14:38:26.060+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313895","id":"12313895","name":"Message Store"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Am doing some failover testing of ActiveMQ, sending 10,000 messages to the broker with a live consumer; the producer and consumer are transactional, and the broker is configured to use KahaDB. On failover of the broker, I see log warnings like this: \n\n{code}\n WARN | Duplicate message add attempt rejected. Message id: ID:Ade's-54024-1277715585703-0:29:1:1:240\n WARN | Duplicate message add attempt rejected. Message id: ID:Ade's-54024-1277715585703-0:24:1:1:241\n WARN | Duplicate message add attempt rejected. Message id: ID:Ade's-54024-1277715585703-0:23:1:1:242\n WARN | Duplicate message add attempt rejected. Message id: ID:Ade's-54024-1277715585703-0:0:1:1:237\n{code}\n\nWhen the test has run its course, I discover that there are no messages lost - all my messages have gone through successfully. However, I notice that there are in fact a number of 'zombie' messages on the queue: by 'zombie' I mean that the messages are in the store, and the JMX queueSize says they're there. However, if you browse the queue you don't see them, and, if you have a consumer on the queue, you won't receive them either. \n\nLooking into the code, in {{org.apache.activemq.store.kahadb.MessageDatabase}} you can see the following very interesting comments concerning the log warning:\n\n{code}\n               // If the message ID as indexed, then the broker asked us to store a DUP\n                // message.  Bad BOY!  Don't do it, and log a warning.\n                LOG.warn(\"Duplicate message add attempt rejected. Message id: \"+command.getMessageId());\n                // TODO: consider just rolling back the tx.\n                sd.messageIdIndex.put(tx, command.getMessageId(), previous);\n{code} \n\nSo. It seems to me that while we're detecting the condition of the broker trying to reinsert a message that's already in the KahaDB correctly, we're not handling this case very well. The outcome is that while we do not get any message loss, we do get worrying warning messages *and* we get erroneous reporting of the queueSize in JMX which will mislead and create the perception of undelivered messages.\n\n\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"159944","customfield_12312823":null,"summary":"'Zombie' messages created in KahaDB after failover, with warning 'Duplicate message add attempt rejected.'","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.trenaman","name":"adrian.trenaman","key":"adrian.trenaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Trenaman","active":true,"timeZone":"Etc/UTC"},"subtasks":[{"id":"12482853","key":"AMQ-2542","self":"https://issues.apache.org/jira/rest/api/2/issue/12482853","fields":{"summary":"Tidy up store duplicate suppression from failover recovery - consistent store implementation with help from transportConnection","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/4","id":"4","description":"An improvement or enhancement to an existing feature or task.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21140&avatarType=issuetype","name":"Improvement","subtask":false,"avatarId":21140}}}],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.trenaman","name":"adrian.trenaman","key":"adrian.trenaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Trenaman","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483932/comment/12942512","id":"12942512","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"https://issues.apache.org/activemq/browse/AMQ-2542 will address this by implementing duplicate suppression at the transport when a failover occurs. This will ensure that the store does not get duplicates in the normal failover case.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-28T11:14:13.073+0000","updated":"2010-06-28T11:14:13.073+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483932/comment/12943309","id":"12943309","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.trenaman","name":"adrian.trenaman","key":"adrian.trenaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Trenaman","active":true,"timeZone":"Etc/UTC"},"body":"As an alternative, I've tried the same test using the {{<amqPersistenceAdapter>}} instead, with the configuration below. \n\n{code:xml}\n\t\t<persistenceAdapter>\n\t\t\t<!-- <kahaDB directory=\"${activemq-broker.dataDirectory}\" /> -->\n\t\t\t<amqPersistenceAdapter directory=\"${activemq-broker.dataDirectory}\" syncOnWrite=\"true\" maxFileLength=\"32mb\"/>\n\t\t</persistenceAdapter>\n{code}\n\nUsing this adapter instead of KahaDB, I find that I don't get the warning message. However, I *do* get the same 'zombie' messages in JMX: the queueSize suggests that there are messages to be delivered (for example, in two failover tests I ended up with a JMX {{QueueSize}} of '3' and '1' respectively after failover), when in fact all messages were delivered successfully. Nicely, the {{<amqPersistenceAdapter>}} is better behaved in that if I restart the broker then the {{QueueSize}} is reported correctly again. ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.trenaman","name":"adrian.trenaman","key":"adrian.trenaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Trenaman","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-28T11:30:00.511+0000","updated":"2010-06-28T11:30:00.511+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483932/comment/12943310","id":"12943310","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.trenaman","name":"adrian.trenaman","key":"adrian.trenaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Trenaman","active":true,"timeZone":"Etc/UTC"},"body":"Thanks Gary for the note. \n\nAny idea when the fix for AMQ-2542 will go live? Is it currently on trunk at Apache? ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.trenaman","name":"adrian.trenaman","key":"adrian.trenaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Trenaman","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-28T11:46:59.751+0000","updated":"2010-06-28T11:46:59.751+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483932/comment/12942465","id":"12942465","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"I am working on it atm, so should have some completion by the end of the week. Any tests you can provide to validate will be appreciated... there a a bunch of tests that assert duplicate suppression and ordering but non that tie it together with the queue sizes  and jmx.\nYou can access the brokerview and pull out the relevant stats from junit test if u want to verify them.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-28T11:56:15.202+0000","updated":"2010-06-28T11:56:15.202+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483932/comment/12943301","id":"12943301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.trenaman","name":"adrian.trenaman","key":"adrian.trenaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Trenaman","active":true,"timeZone":"Etc/UTC"},"body":"Cool. I'll see if I can put together a unit test for this - alternatively, get in touch with me off-line and I can give you a non-Junit test-case.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=adrian.trenaman","name":"adrian.trenaman","key":"adrian.trenaman","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adrian Trenaman","active":true,"timeZone":"Etc/UTC"},"created":"2010-06-28T13:36:00.592+0000","updated":"2010-06-28T13:36:00.592+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12483932/comment/12941307","id":"12941307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"resolved in r961783","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2010-07-08T14:38:26.040+0000","updated":"2010-07-08T14:38:26.040+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2803/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rqjj:"}}