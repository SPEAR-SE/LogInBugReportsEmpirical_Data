{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12740042","self":"https://issues.apache.org/jira/rest/api/2/issue/12740042","key":"AMQ-5348","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":null,"customfield_12312322":null,"customfield_12310220":null,"customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"2014-09-09 02:17:21.045","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":null,"customfield_12312321":null,"resolutiondate":null,"workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5348/watchers","watchCount":1,"isWatching":false},"created":"2014-09-09T02:17:21.045+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/2","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/critical.svg","name":"Critical","id":"2"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12326455","id":"12326455","name":"5.9.1","archived":false,"released":true,"releaseDate":"2014-04-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-09-09T02:17:21.045+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/1","description":"The issue is open and ready for the assignee to start work on it.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[],"timeoriginalestimate":null,"customfield_12310080":null,"description":"  We have two activeMQ servers , called A and B. A config network connector to B, and A is one way to B. We have a topic which is always sending to A, and a durable subscriber connecting to B. The problem is the \"Memory percent used\" in the web console do not decrease as the topic has successfully been consumed. \n\n     Our messages are not persistence,when we use only one activeMQ server ,this problem is not an issue. \n\n     I had read the source code and debuged with adding some log info.I print the stack trace info at the org.apache.activemq.command.Message.incrementReferenceCount method and org.apache.activemq.command.Message.decrementReferenceCount method. \nAnd I found the difference between network connectors and standalone server. \n\nWhen using network connectors there will be another incrementReferenceCount call at: \n\nat org.apache.activemq.command.Message.incrementReferenceCount(Message.java:659) \n        at org.apache.activemq.filter.MessageEvaluationContext.getMessage(MessageEvaluationContext.java:53) \n        at org.apache.activemq.command.NetworkBridgeFilter.matches(NetworkBridgeFilter.java:67) \n        at org.apache.activemq.network.DemandForwardingBridgeSupport.suppressMessageDispatch(DemandForwardingBridgeSupport.java:1035) \n        at org.apache.activemq.network.DemandForwardingBridgeSupport.serviceLocalCommand(DemandForwardingBridgeSupport.java:935) \n        at org.apache.activemq.network.DemandForwardingBridgeSupport$2.onCommand(DemandForwardingBridgeSupport.java:177) \n        at org.apache.activemq.transport.ResponseCorrelator.onCommand(ResponseCorrelator.java:116) \n        at org.apache.activemq.transport.MutexTransport.onCommand(MutexTransport.java:50) \n        at org.apache.activemq.transport.vm.VMTransport.doDispatch(VMTransport.java:138) \n        at org.apache.activemq.transport.vm.VMTransport.dispatch(VMTransport.java:127) \n        at org.apache.activemq.transport.vm.VMTransport.oneway(VMTransport.java:104) \n        at org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:68) \n        at org.apache.activemq.transport.ResponseCorrelator.oneway(ResponseCorrelator.java:60) \n        at org.apache.activemq.broker.TransportConnection.dispatch(TransportConnection.java:1365) \n        at org.apache.activemq.broker.TransportConnection.processDispatch(TransportConnection.java:884) \n        at org.apache.activemq.broker.TransportConnection.iterate(TransportConnection.java:930) \n        at org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:133) \n        at org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:48) \n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) \n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) \n        at java.lang.Thread.run(Thread.java:744) \n\n\nand I see the source code in class org.apache.activemq.network.DemandForwardingBridgeSupport : \n\n private boolean suppressMessageDispatch(MessageDispatch md, DemandSubscription sub) throws Exception { \n        boolean suppress = false; \n        // for durable subs, suppression via filter leaves dangling acks so we \n        // need to check here and allow the ack irrespective \n        if (sub.getLocalInfo().isDurable()) { \n            MessageEvaluationContext messageEvalContext = new MessageEvaluationContext(); \n            messageEvalContext.setMessageReference(md.getMessage()); \n            messageEvalContext.setDestination(md.getDestination()); \n            suppress = !sub.getNetworkBridgeFilter().matches(messageEvalContext); \n        } \n        return suppress; \n    } \n\nthis method create a MessageEvaluationContext() , and in the  \"!sub.getNetworkBridgeFilter().matches(messageEvalContext);\"  the MessageEvaluationContext's getMessage() method will be invoked and the incrementReferenceCount method there will be called. \nAnd the newly created messageEvalContext will be gc after the  suppressMessageDispatch method is invoked over. But messageEvalContext.clear method is not called so the decrementReferenceCount is not called. \n\nI don't know whether it is a bug or just a nice design. \n\nBTW,we use activeMQ 5.9 and tried 5.9.1 ,5.10.0. ","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Network connector cause memory usage not count down","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jjiag22222","name":"jjiag22222","key":"jjiag22222","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jiang Yunjun","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jjiag22222","name":"jjiag22222","key":"jjiag22222","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jiang Yunjun","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[],"maxResults":0,"total":0,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5348/votes","votes":1,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1zthr:"}}