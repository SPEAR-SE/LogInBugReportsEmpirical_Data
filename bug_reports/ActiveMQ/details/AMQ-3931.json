{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12599007","self":"https://issues.apache.org/jira/rest/api/2/issue/12599007","key":"AMQ-3931","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12321258","id":"12321258","description":"Next v5 maintenance release","name":"5.7.0","archived":false,"released":true,"releaseDate":"2012-10-08"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2012-07-16T20:24:45.826+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Sep 19 12:13:12 UTC 2012","customfield_12310420":"296456","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_5594990913_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-09-19T12:05:13.658+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3931/watchers","watchCount":3,"isWatching":false},"created":"2012-07-16T17:55:22.757+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-09-19T12:13:12.938+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"When running a single transaction that produces 300,000 text messages, ActiveMQ runs into all sorts of memory problems.  The log output is attached.  We were using a simple Java JMS client class to produce the 300,000 messages in a single transaction.  Each message's text payload was a random string of 10,000 bytes.\n\nThis is a production scenario that we have that's killing our broker.  We isolated it down to its most basic pieces to try to test where the breakdown was occuring, which led us to this.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12536672","id":"12536672","filename":"activemq_log_output.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rvoliva","name":"rvoliva","key":"rvoliva","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Voliva","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-16T17:56:03.198+0000","size":8216,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12536672/activemq_log_output.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12536679","id":"12536679","filename":"gbsmq.xml","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rvoliva","name":"rvoliva","key":"rvoliva","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Voliva","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-16T18:01:29.746+0000","size":20380,"mimeType":"text/xml","content":"https://issues.apache.org/jira/secure/attachment/12536679/gbsmq.xml"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"233004","customfield_12312823":null,"summary":"Memory problems with large transactions","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rvoliva","name":"rvoliva","key":"rvoliva","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Voliva","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rvoliva","name":"rvoliva","key":"rvoliva","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Voliva","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"OS: RHEL 5.5\nStartup options: -Xmx2G -Xms2G -XX:MaxPermSize=512M -Dorg.apache.activemq.UseDedicatedTaskRunner=true -Djava.util.logging.config.file=logging.properties -Dcom.sun.management.jmxremote -Dactivemq.classpath=/opt/activemq/conf; -Dactivemq.home=/opt/activemq -Dactivemq.base=/opt/activemq -Dactivemq.conf=/opt/activemq/conf -Dactivemq.data=/opt/activemq/data -Djava.io.tmpdir=/opt/activemq/tmp\nConfig file: activemq.xml attached","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599007/comment/13415602","id":"13415602","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=flou","name":"flou","key":"flou","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fengming Lou","active":true,"timeZone":"Etc/UTC"},"body":"you have in single transaction of 300,000 text messages with average size of ~10,000 bytes. If they are all in memory at the same time, it would require 300,000 x 10,000 = 3G. You have only 1 g allocated for the broker?\n<memoryUsage>                                                                                                    \n     <memoryUsage limit=\"1 gb\"/>                                                                                 \n</memoryUsage>                    ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=flou","name":"flou","key":"flou","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fengming Lou","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-16T20:24:45.826+0000","updated":"2012-07-16T20:24:45.826+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599007/comment/13415624","id":"13415624","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rvoliva","name":"rvoliva","key":"rvoliva","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Voliva","active":true,"timeZone":"Etc/UTC"},"body":"Do you know if this is a configuration option of ActiveMQ, where it can be told to serialize messages participating in a transaction to disk while more messages for that transaction are coming in?  This would allow it to free up memory for the rest of the incoming messages.  Or is this just a feature/limitation in how ActiveMQ works?","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rvoliva","name":"rvoliva","key":"rvoliva","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Voliva","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-16T20:57:31.827+0000","updated":"2012-07-16T20:57:31.827+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599007/comment/13415654","id":"13415654","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=flou","name":"flou","key":"flou","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fengming Lou","active":true,"timeZone":"Etc/UTC"},"body":"Following links should give shine some light on your issue. I see a lot of queues in your configurations, but not memoryLimit imposed on any queues.\n\nhttp://activemq.apache.org/javalangoutofmemory.html\nhttp://activemq.apache.org/per-destination-policies.html\nhttp://activemq.apache.org/message-cursors.html","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=flou","name":"flou","key":"flou","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Fengming Lou","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-16T21:22:57.623+0000","updated":"2012-07-16T21:22:57.623+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599007/comment/13416568","id":"13416568","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rvoliva","name":"rvoliva","key":"rvoliva","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Voliva","active":true,"timeZone":"Etc/UTC"},"body":"Thanks Fengming, I went through all that documentation and did make some changes.  What we're still seeing is that when producing even 100,000 messages in a single transaction, they all seem to be kept in memory until (presumably) the transaction is committed.  I have verified that producing the same number of messages in multiple transactions, it behaves as expected, and doesn't kill the broker.  It is able to GC periodically and things hum along great.\n\nThis seems to all be related to producing that many messages in one transaction.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rvoliva","name":"rvoliva","key":"rvoliva","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Robert Voliva","active":true,"timeZone":"Etc/UTC"},"created":"2012-07-17T20:29:23.742+0000","updated":"2012-07-17T20:29:23.742+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599007/comment/13458614","id":"13458614","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"This is working as designed. pending messages in a TX is kept in memory. \n\nAs you have excessive number of messages, make sure your broker have sufficient memory to deal with this requirement.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2012-09-19T12:05:13.666+0000","updated":"2012-09-19T12:05:13.666+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12599007/comment/13458617","id":"13458617","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"body":"See also this ticket. KahaDB has a special option for overflow to disk for TX\nhttps://issues.apache.org/jira/browse/AMQ-3374","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=davsclaus","name":"davsclaus","key":"davsclaus","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=davsclaus&avatarId=15835","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=davsclaus&avatarId=15835","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=davsclaus&avatarId=15835","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=davsclaus&avatarId=15835"},"displayName":"Claus Ibsen","active":true,"timeZone":"Europe/Berlin"},"created":"2012-09-19T12:13:12.938+0000","updated":"2012-09-19T12:13:12.938+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3931/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i149if:"}}