{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482777","self":"https://issues.apache.org/jira/rest/api/2/issue/12482777","key":"AMQ-2034","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315620","id":"12315620","description":"","name":"5.3.0","archived":false,"released":true,"releaseDate":"2009-10-13"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2009-01-07T20:48:34.734+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Jan 14 13:46:27 UTC 2009","customfield_12310420":"75113","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_8783429_*|*_6_*:*_2_*:*_1986411292_*|*_4_*:*_1_*:*_693660","customfield_12312321":null,"resolutiondate":"2009-01-07T21:00:08.425+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2034/watchers","watchCount":1,"isWatching":false},"created":"2008-12-15T18:35:20.044+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"0.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315619","id":"12315619","description":"","name":"5.2.0","archived":false,"released":true,"releaseDate":"2008-11-20"}],"issuelinks":[{"id":"12335011","self":"https://issues.apache.org/jira/rest/api/2/issueLink/12335011","type":{"id":"10001","name":"dependent","inward":"is depended upon by","outward":"depends upon","self":"https://issues.apache.org/jira/rest/api/2/issueLinkType/10001"},"inwardIssue":{"id":"12483038","key":"AMQ-2233","self":"https://issues.apache.org/jira/rest/api/2/issue/12483038","fields":{"summary":"After rollback received messages not re-presented","status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133}}}}],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-04-28T16:46:45.604+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/6","description":"The issue is considered finished, the resolution is correct. Issues which are not closed can be reopened.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/closed.png","name":"Closed","id":"6","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"consumer.close removes consumer from broker, later xa transaction commit results in exception as beforeEnd ack of messages fails with IllegalState:\n{code}\njavax.jms.JMSException: The subscription does not exist: ID:XXXX.dd-52108-1229084857402-0:37:13:1\n        at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:49)\n        at org.apache.activemq.ActiveMQConnection.onAsyncException(ActiveMQConnection.java:1692)\n        at org.apache.activemq.ActiveMQConnection$2$1.run(ActiveMQConnection.java:1637)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)\n        at java.lang.Thread.run(Thread.java:595)\nCaused by: java.lang.IllegalArgumentException: The subscription does not exist: ID:XXXX.dd-52108-1229084857402-0:37:13:1\n        at org.apache.activemq.broker.region.AbstractRegion.acknowledge(AbstractRegion.java:364)\n        at org.apache.activemq.broker.region.RegionBroker.acknowledge(RegionBroker.java:470)\n        at org.apache.activemq.broker.TransactionBroker.acknowledge(TransactionBroker.java:194)\n        at org.apache.activemq.broker.BrokerFilter.acknowledge(BrokerFilter.java:73)\n        at org.apache.activemq.broker.MutableBrokerFilter.acknowledge(MutableBrokerFilter.java:84)\n        at org.apache.activemq.broker.TransportConnection.processMessageAck(TransportConnection.java:442)\n        at org.apache.activemq.command.MessageAck.visit(MessageAck.java:196)\n        at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:291)\n        at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:179)\n        at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n        at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:143)\n        at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:206)\n        at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n        at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:196)\n        at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:183)\n{code}","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"160137","customfield_12312823":null,"summary":"consumer close with active XA transaction results in java.lang.IllegalArgumentException: The subscription does not exist: ...","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"XA spring-jms consumer.close before XA transaction completion","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482777/comment/12940587","id":"12940587","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"The close should be deferred till the transaction completes. \nSame for session.close, it is ok to close the session while XA is still looking after the transaction but a local transaction will be automatically rolled back.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-15T18:36:55.589+0000","updated":"2008-12-15T18:36:55.589+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482777/comment/12940586","id":"12940586","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"see svn commit details","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-15T21:01:43.458+0000","updated":"2008-12-15T21:01:43.458+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482777/comment/12940645","id":"12940645","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"body":"To work in managed environments the \"delay session close\" code has to be in Session, not XASession.  Also I think it needs to check for the sync already having been added so you don't get more than one :-)","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-01-07T20:48:34.734+0000","updated":"2009-01-07T20:48:34.734+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482777/comment/12940597","id":"12940597","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"body":"fixed in rev 732489.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-01-07T21:00:08.334+0000","updated":"2009-01-07T21:00:08.334+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482777/comment/12940622","id":"12940622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"body":"BTW the problem in the managed environment showed up running the tck in geronimo.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=djencks","name":"djencks","key":"djencks","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"David Jencks","active":true,"timeZone":"America/Los_Angeles"},"created":"2009-01-07T21:01:00.057+0000","updated":"2009-01-07T21:01:00.057+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482777/comment/12940667","id":"12940667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"moving the close to session breaks a few unit tests, The TopicTransacted tests. I get 6 failures & 3 errors on a activemq-core test run.\neg: JmsTopicTransactionTest.testSendSessionClose() verifies that session.close rollbacks the un committed local transaction, but with the change, the transaction is never committed.\nOnly registering the sync on close if the transaction is XA resolved the issue. As in, the transaction is externally controlled so the transaction completion is out of the control of the session.\nIt is correct unmanaged JMS behavior so I think the unit tests are correct.\nWill this break the tck? \n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-14T12:14:53.249+0000","updated":"2009-01-14T12:14:53.249+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482777/comment/12940648","id":"12940648","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"r734393. Modified the code a little to only use the synchronization if in an XA tx, possibly this could be if not in localTx such that this will allow the managed case to work,\nwe need a test case that shows the managed usage from the tck if this change breaks the tck.\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2009-01-14T13:46:27.601+0000","updated":"2009-01-14T13:46:27.601+0000"}],"maxResults":7,"total":7,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-2034/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0rrqf:"}}