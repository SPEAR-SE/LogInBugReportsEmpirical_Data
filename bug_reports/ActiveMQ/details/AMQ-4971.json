{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12689176","self":"https://issues.apache.org/jira/rest/api/2/issue/12689176","key":"AMQ-4971","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/8","id":"8","description":"The described issue is not actually a problem - it is as designed.","name":"Not A Problem"},"customfield_12312322":null,"customfield_12310220":"2014-01-16T10:42:38.222+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Wed Mar 26 13:37:03 UTC 2014","customfield_12310420":"368143","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_5985118184_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-03-26T14:06:01.917+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4971/watchers","watchCount":4,"isWatching":false},"created":"2014-01-16T07:34:03.759+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":["features"],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12323932","id":"12323932","name":"5.9.0","archived":false,"released":true,"releaseDate":"2013-10-21"}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-03-26T14:06:01.940+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10091","value":"Regression","id":"10091"}],"description":"DemandForwardingBridge sends messages to the other broker and asynchronously waits for ACKs keeping message bodies in heap. Amount of un-ACK-ed messages kept in heap is not limited. If local producer is fast then whole heap will be consumed by messages waiting to be ACK-ed by other broker.\nPossible option to fix the issue:\nDon't wait for ACK from other broker when forwarding the message if some threshold of un-ACK-ed messages is reached.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12623351","id":"12623351","filename":"AMQ-4971.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"created":"2014-01-16T10:49:28.427+0000","size":3221,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12623351/AMQ-4971.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"368448","customfield_12312823":null,"summary":"OOM in DemandForwardingBridge","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sdcf","name":"sdcf","key":"sdcf","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Yuriy Sidelnikov","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12689176/comment/13873247","id":"13873247","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"body":"The issue can be easily reproduced in the following scenario:\n1. Start 3 brokers. Let it be 0, 1, 2\n2. In brokers 1 and 2 enable conduit duplex network connector to 0\n3. Connect tcp:// producer for topic A to 0 (jmeter)\n4. Connect vm:// consumer for topic A to 1 (simple jms message forwarder in camel: from jms, to jms)\n5. Connect vm:// producer for topic B to 1 (simple jms message forwarder in camel: from jms, to jms)\n6. Connect vm:// consumer for topic B to 2 (simple jms message forwarder in camel: from jms, to jms)\n7. Connect vm:// producer for topic C to 2 (simple jms message forwarder in camel: from jms, to jms)\n8. Connect tcp:// consumer for topic C to 0 (jmeter)\nIn summary, we just put bi-directional load to each of network bridges where each bridge has to both send and receive messages and acks.\nSince vm:// and camel embedded in the same JVM are faster than tcp:// and peer broker, bridge very quickly fills heap with responseCallback's used to handle ack and reference message body. This isnt controlled by broker memory limits or producer flow control and bridges die on OOM.\n\nAdditionally, VMTransport will also keep references to asynchronously handled messages. Since vm:// is faster than tcp://, this is another source of quick OOM where producer flow control and memory limits have no any effect. While queue is bounded, default size is 2000 and with 1MB messages you quickly run out of heap (doc doesnt seem to explain if and how it could be adjusted). Wouldnt be a problem if it could be controlled by broker memory limits and producer flow control.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"created":"2014-01-16T10:42:38.222+0000","updated":"2014-01-16T10:51:00.485+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12689176/comment/13873255","id":"13873255","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"body":"Attached patch with workaround for those who face OOM in network bridge. This is hardly a solution (might be lower vm performance on small messages, might be less delivery guarantees over bridges) but at least it allows JVM not to crash with OOM.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"created":"2014-01-16T10:49:28.432+0000","updated":"2014-01-16T10:49:28.432+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12689176/comment/13873301","id":"13873301","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"the prefetch should limit the number of messages pending an ack at one time. \n\ntry{code}<networkConnector .... prefetchSize=\"1\" .../>{code}\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2014-01-16T11:50:06.337+0000","updated":"2014-01-16T11:50:06.337+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12689176/comment/13874616","id":"13874616","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"body":"Prefetch was already set to 1 for all destinations via per-destination policy. However, at appears that this has no effect over bridge. Reducing prefetchSize from default 1000 to 1 directly on networkConnector fixes the problem with heap exhaustion. However, one may assume that amount of prefetched data should also be limited by resource usage constraints while it doesn't seem to be so.\n\n{noformat}\n    <amq:destinationPolicy>\n        <amq:policyMap>\n            <amq:policyEntries>\n                <amq:policyEntry topic=\">\" producerFlowControl=\"true\" memoryLimit=\"30mb\" topicPrefetch=\"1\" blockedProducerWarningInterval=\"30\">\n                    <amq:pendingMessageLimitStrategy>\n                        <amq:constantPendingMessageLimitStrategy limit=\"-1\"/>\n                    </amq:pendingMessageLimitStrategy>\n                </amq:policyEntry>                    \n                <amq:policyEntry queue=\">\" producerFlowControl=\"true\" memoryLimit=\"30mb\" queuePrefetch=\"1\" blockedProducerWarningInterval=\"30\">\n                    <amq:pendingQueuePolicy>\n                        <amq:vmQueueCursor/>\n                    </amq:pendingQueuePolicy>\n                </amq:policyEntry>\n            </amq:policyEntries>\n        </amq:policyMap>\n    </amq:destinationPolicy>\n    \n    <amq:systemUsage>\n        <amq:systemUsage sendFailIfNoSpaceAfterTimeout=\"60000\">\n            <amq:memoryUsage>\n                <amq:memoryUsage limit=\"350 mb\" />\n            </amq:memoryUsage>\n            <amq:tempUsage>\n                <amq:tempUsage limit=\"300 mb\" />\n            </amq:tempUsage>\n        </amq:systemUsage>\n    </amq:systemUsage>    \n{noformat}","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"created":"2014-01-17T10:10:44.525+0000","updated":"2014-01-17T10:10:44.525+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12689176/comment/13874691","id":"13874691","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"glad that the networkConnector prefetch value is working as expected.\n\nDispatch or prefetch of messages can exceed the limits by max pageSize num messages.\nNote however, that paging in for dispatch (for persistent messages, default store cursor) is limited by the value of systemUsage.memoryLimit - not the per destination limits.\nThis is to ensure we can dispatch messages when destination resources are maxed out and producers are blocked.\nWhat value do you use for the -Xmx jvm argument in your scenario?\nI think their is a case to be made for limiting the prefetch base on resource usage, the difficulty is that can lead to starved consumers b/c the limits are shared across all destinations. If they are not shared, then a single destination can get starved.\n\nIt is not a trivial problem to solve but I think it warrants a jira issue. If you have some unit tests that can simply demonstrate the issue that would be a great help.\n\nAlso, out of curiosity, why do you use the vmQueueCursor? In most cases, I find the default store cursor works great.\n\n \n\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2014-01-17T11:31:00.223+0000","updated":"2014-01-17T11:31:00.223+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12689176/comment/13947909","id":"13947909","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"body":"We use 1,5G by default for Xmx but not all of this is for broker. Broker is just one of the subsystems. I'm not sure that broker can reliably deduct preferable prefetch in non-standalone mode as you dont know how increased usage will impact other heap users.\n\nRegarding, cursor we just follow example in http://activemq.apache.org/message-cursors.html. Not really using queues so can't tell much how it affected things.\n\nAfter we had set prefetch explicitly on the bridge we have no problems anymore with memory usage growth. It was surprise that prefetch on destinations and memory usage limit on broker did not work that forced us to get code modified and to create this issue. Since there is a safer and more convenient way to prevent memory usage growth i would like to ask you to close the issue. Thanks for clarification and all the trouble.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=nickolay_martinov","name":"nickolay_martinov","key":"nickolay_martinov","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=nickolay_martinov&avatarId=17284","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=nickolay_martinov&avatarId=17284","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=nickolay_martinov&avatarId=17284","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=nickolay_martinov&avatarId=17284"},"displayName":"Nikolay Martynov","active":true,"timeZone":"Europe/Moscow"},"created":"2014-03-26T13:37:03.613+0000","updated":"2014-03-26T13:37:03.613+0000"}],"maxResults":6,"total":6,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-4971/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i1rgcn:"}}