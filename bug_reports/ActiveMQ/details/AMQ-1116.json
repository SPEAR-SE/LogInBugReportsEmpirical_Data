{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12482172","self":"https://issues.apache.org/jira/rest/api/2/issue/12482172","key":"AMQ-1116","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315618","id":"12315618","description":"","name":"5.1.0","archived":false,"released":true,"releaseDate":"2008-05-06"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2007-03-28T10:41:10.044+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun Mar 29 01:08:50 UTC 2009","customfield_12310420":"84418","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_34450275033_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2008-02-07T10:03:43.645+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1116/watchers","watchCount":5,"isWatching":false},"created":"2007-01-04T16:32:28.612+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"5.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315612","id":"12315612","description":"","name":"4.0.2","archived":false,"released":true,"releaseDate":"2006-07-25"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2009-03-29T01:08:50.822+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313903","id":"12313903","name":"Transport"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Sounds like a great idea to me :) Please go ahead and submit a jira with the patch and we'll get it integrated ASAP\n\nOn 1/4/07, Chris Hofstaedter <chrish@nmwco.com> wrote:\n> I ran into this issue as well on <= 4.0.2.  I never tested it against\n> 4.1.    The FailoverTransport doesn't shutdown if it is disconnected at\n> the time of the shutdown.\n>\n> I believe that the root cause is in the \n> FailoverTransport.oneway(Command\n> command) function which will hold onto the command and keep trying to\n> reconnect until the message is sent or the transport is disposed.\n>\n> I applied a local patch that seems to solve the problem.  Note that \n> I've only tested the patch against 4.0.2.\n>\n> Specifically, I early return from the oneway function if the command \n> is ShutdownInfo and the connectedTransport is null.  This seems to \n> solve the problem in that I get clean shutdowns on the client when \n> failover is true and the client is presently disconnected.\n>\n> Does this seem like a reasonable patch?  Should I create a JIRA with \n> this info?\n>\n>\n>\n> -----Original Message-----\n> From: James Strachan [mailto:james.strachan@gmail.com]\n> Sent: Tuesday, December 12, 2006 4:46 AM\n> To: activemq-users@geronimo.apache.org\n> Subject: Re: failover mode and client shutdown\n>\n> There could be a bug relating to closes with the failover transport \n> possibly, but the ActiveMQConnection does wait up to the closeTimeout \n> for a close to succeed before shutting down - so you could try reduce \n> the timeout.\n>\n> http://incubator.apache.org/activemq/maven/activemq-core/apidocs/org/a\n> pa\n> che/activemq/ActiveMQConnection.html#setCloseTimeout(int)\n>\n>\n> On 12/12/06, Keith Irwin <keith.irwin@gmail.com> wrote:\n> > Folks--\n> >\n> > When we have clients running and we take down AMQ (<= 4.1.0), then \n> > attempt to shutdown the clients with Control-C (rather than kill the \n> > JVM with a -9), the clients won't shut down.  It's as if a \"close\" \n> > on the failover connection never reaches the amq client classes.\n> >\n> > I note that in the 4.1.0 release notes, this issue is referenced, \n> > and the advice is to set the maxReconnectAttempts (or similar) \n> > property to something non-zero.\n> >\n> > The problem is that we don't want there to be a max number of \n> > attempts.  Unless we specifically want to take down the client (say, \n> > for an apt-get package upgrade), we want it to keep on trying \n> > forever.\n> >\n> > SO, my question: Is there an architectural reason for not being able \n> > to close a failover connection if AMQ is down?\n> >\n> > If it isn't impossible due to tradeoffs elsewhere in the code base, \n> > we might be willing to submit a patch to fix the issue.\n> >\n> > Our only other recourse is to attempt to close the connections in \n> > separate threads, then timeout those threads after a while and fall \n> > out the end of the java process.\n> >\n> > For instance:\n> >\n> >   Thread th = new Thread(new Runnable() {\n> >       public void run() {\n> >          connection.close();\n> >       }\n> >    });\n> >    th.start();\n> >\n> >    // give up after 2 seconds\n> >    Thread.currentThread().join(2000);\n> >\n> > I guess this is do-able, but it seems, you know, some how, well,\n> wrong.\n> >\n> > So, is it worth investigating a patch to AMQ?\n> >\n> > Keith\n> >\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460920","id":"12460920","filename":"ConnectionPool.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-07T05:47:41.499+0000","size":8147,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460920/ConnectionPool.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460952","id":"12460952","filename":"DemandForwardingBridgeSupport.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrish","name":"chrish","key":"chrish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Hofstaedter","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-28T13:25:45.971+0000","size":38630,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460952/DemandForwardingBridgeSupport.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460741","id":"12460741","filename":"FailoverTransport_AMQ-1116.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"created":"2007-05-17T13:45:01.453+0000","size":2781,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460741/FailoverTransport_AMQ-1116.patch"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460881","id":"12460881","filename":"FailoverTransport.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-07T05:47:41.326+0000","size":27425,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460881/FailoverTransport.java"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460892","id":"12460892","filename":"FailoverTransport.java","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrish","name":"chrish","key":"chrish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Hofstaedter","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-28T13:25:48.751+0000","size":20813,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12460892/FailoverTransport.java"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161728","customfield_12312823":null,"summary":"deadlock when shutting down client that is configured with failover=true and is presently disconnected from broker","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrish","name":"chrish","key":"chrish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Hofstaedter","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrish","name":"chrish","key":"chrish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Hofstaedter","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12938875","id":"12938875","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cameronbraid","name":"cameronbraid","key":"cameronbraid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Cameron Braid","active":true,"timeZone":"Australia/Melbourne"},"body":"Is there any chance that this could be fixed for 4.1.1 ?\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=cameronbraid","name":"cameronbraid","key":"cameronbraid","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Cameron Braid","active":true,"timeZone":"Australia/Melbourne"},"created":"2007-03-28T10:41:10.044+0000","updated":"2007-03-28T10:41:10.044+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12938853","id":"12938853","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrish","name":"chrish","key":"chrish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Hofstaedter","active":true,"timeZone":"Etc/UTC"},"body":"Cameron's recent comment made me realize that I never attached the files with my local patches in them for this issue.  So here they are.  These are 4.0.2 files.  Also there are patches for multiple issues in here.  You can find the blocks of code that patch this issue (for me anyway) by searching for \"AMQ-1116 fix\"","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=chrish","name":"chrish","key":"chrish","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Chris Hofstaedter","active":true,"timeZone":"Etc/UTC"},"created":"2007-03-28T13:25:52.169+0000","updated":"2007-03-28T13:25:52.169+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12938967","id":"12938967","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"body":"Patch to prevent ShutdownInfo or RemoveInfo commands from being sent when transport is not connected","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"created":"2007-05-17T13:45:01.543+0000","updated":"2007-05-17T13:45:01.543+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12938981","id":"12938981","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"body":"Just a confirmation that this is still an issue. I've submitted a patch that does basically the same thing that Chris's does, but only affects FailoverTransport. In addition to ignoring ShutdownInfo commands when not connected, it also short-circuits a reply to RemoveInfo, which was also causing a problem.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=alewando","name":"alewando","key":"alewando","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Adam Lewandowski","active":true,"timeZone":"America/New_York"},"created":"2007-05-17T13:48:01.187+0000","updated":"2007-05-17T13:48:01.187+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12937975","id":"12937975","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"body":"I can confirm that I am seeing this issue, under the latest 5.1-SNAPSHOT.....\n\nThe record shows the fixed version is 5.2.0....Is that being actively developed now, or is that just a placeholder to indicate this issue is being scheduled for work after the current 5.1 cycle?\n\nJason","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-05T08:56:44.837+0000","updated":"2008-02-05T08:56:44.837+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12938317","id":"12938317","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"body":"Wanted to add, I applied Adam's patch to the latest 5.1-SNAPSHOT version, and it appears to be working great.\n\nJason","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-05T18:20:47.777+0000","updated":"2008-02-05T18:20:47.777+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12939333","id":"12939333","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"body":"I've attached a patch that I created for several issues, against a recent 5.1-SNAPSHOT revision (svn rev 618082).\n\nThe file FailoverTransport.java, includes fixes for 4 issues, including Adam's fix for this issue.\n\nThe other issues that this patch includes fixes for are:\n\nAMQ-1116\nAMQ-1575\nAMQ-1577\nAMQ-1581\n\nThe file ConnectionPool.java is also needed for the fix for AMQ-1581\n\nI've added comments in the code that clearly indicate which sections apply to which issue, so you can easily take edit to include only the fixes you want specifically.\n\nJason","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jbrosenberg","name":"jbrosenberg","key":"jbrosenberg","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jason Rosenberg","active":true,"timeZone":"America/Los_Angeles"},"created":"2008-02-07T05:47:41.528+0000","updated":"2008-02-07T05:47:41.528+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12936820","id":"12936820","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"body":"Fixed by svn revision 619336","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=rajdavies","name":"rajdavies","key":"rajdavies","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=rajdavies&avatarId=13942","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=rajdavies&avatarId=13942","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=rajdavies&avatarId=13942","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=rajdavies&avatarId=13942"},"displayName":"Rob Davies","active":true,"timeZone":"Etc/UTC"},"created":"2008-02-07T10:03:43.610+0000","updated":"2008-02-07T10:03:43.610+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12940530","id":"12940530","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrepko","name":"jrepko","key":"jrepko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jay Repko","active":true,"timeZone":"Etc/UTC"},"body":"I'm not sure that this is actually fixed.   I am currently trying it out with a broker in one VM and a client in another.  If I kill the broker forcibly and then try to execute the close method of ActiveMQConnection, I get stuck in the failover transport until the reconnect tries expires after 10 minutes. \n\nIt gets stuck in the close when it calls doSyncSendPacket() \n<code>\n                    if (isConnectionInfoSentToBroker) {\n                        // If we announced ourselfs to the broker.. Try to let\n                        // the broker\n                        // know that the connection is being shutdown.\n                        doSyncSendPacket(info.createRemoveCommand(), closeTimeout);\n                        doAsyncSendPacket(new ShutdownInfo());\n                    }\n</code>\n\nThis is because another message ack is waiting for the transport to reconnect to be sent and so is holding the writerMutex in MutexTransport.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jrepko","name":"jrepko","key":"jrepko","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Jay Repko","active":true,"timeZone":"Etc/UTC"},"created":"2008-12-10T04:57:39.245+0000","updated":"2008-12-10T04:57:39.245+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12941074","id":"12941074","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bhumphre","name":"bhumphre","key":"bhumphre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Humphreys","active":true,"timeZone":"Etc/UTC"},"body":"I agree with Jay Repko.  I'm using AMQ 5.1.0, I've got the following JUnit test to try to reproduce what I'm experiencing:\n{noformat}\n  @Test(timeout=15000)\n  public void testRetryServerConnectionURLWithNoServer() throws Exception\n  {\n      final String url=\"tcp://localhost:61620\";\n      final String clientUrl = \"failover://(\" + url + \")?maxReconnectAttempts=0\";\n      ActiveMQConnectionFactory activeMQConnectionFactory = new ActiveMQConnectionFactory(clientUrl);\n      activeMQConnectionFactory.setTransportListener(new PrintingTransportListener());\n      final Connection conn = activeMQConnectionFactory.createConnection();\n      ((ActiveMQConnection)conn).setCloseTimeout(5);\n      Thread clientThread=new Thread(\"AMQTestClientThread\")\n      {\n          public void run()\n          {\n              try\n              {\n                  conn.start();\n                  Thread.sleep(2000);\n                  conn.stop();\n                  conn.close();\n              }\n              catch(Exception e)\n              {\n                  thrownException = e;\n              }\n          }\n      };\n\n      clientThread.start();\n      Thread.sleep(2000);\n      System.out.println(\"Attempting to shutdown\");\n      conn.close();\n      System.out.println(\"Shutdown, joining.\");\n      clientThread.join();\n      if(thrownException !=null)\n      {\n          throw thrownException;\n      }\n  }\n\n{noformat} \n\nThis test always times out after 15 seconds, setCloseTimeout doesn't seem to change any behavior.\n\nFurther, when I kill -3 this, I get the following three thread stack traces (The client thread, the reconnecting thread & the stopping thread:\n\n{noformat} \n\"AMQTestClientThread\" prio=1 tid=0x00002aaafc0069f0 nid=0x6f69 in Object.wait() [0x000000004101d000..0x000000004101dc80]\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00002aaadf2bc5f8> (a java.lang.Object)\n\tat org.apache.activemq.transport.failover.FailoverTransport.oneway(FailoverTransport.java:407)\n\t- locked <0x00002aaadf2bc5f8> (a java.lang.Object)\n\tat org.apache.activemq.transport.MutexTransport.oneway(MutexTransport.java:40)\n\t- locked <0x00002aaadf2bc158> (a java.lang.Object)\n\tat org.apache.activemq.transport.ResponseCorrelator.asyncRequest(ResponseCorrelator.java:74)\n\tat org.apache.activemq.transport.ResponseCorrelator.request(ResponseCorrelator.java:79)\n\tat org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1195)\n\tat org.apache.activemq.ActiveMQConnection.ensureConnectionInfoSent(ActiveMQConnection.java:1289)\n\t- locked <0x00002aaadf2ab250> (a org.apache.activemq.ActiveMQConnection)\n\tat org.apache.activemq.ActiveMQConnection.start(ActiveMQConnection.java:456)\n\tat com.kentrox.objectproxy.jms.test.JMSConnectionStateTesting$2.run(JMSConnectionStateTesting.java:235)\n\n\"ActiveMQ Task\" daemon prio=1 tid=0x00002aaafc02ab80 nid=0x6f68 in Object.wait() [0x0000000040f1c000..0x0000000040f1ce00]\n\tat java.lang.Object.wait(Native Method)\n\t- waiting on <0x00002aaadf2bc618> (a java.lang.Object)\n\tat org.apache.activemq.transport.failover.FailoverTransport.doReconnect(FailoverTransport.java:735)\n\t- locked <0x00002aaadf2bc618> (a java.lang.Object)\n\tat org.apache.activemq.transport.failover.FailoverTransport$2.iterate(FailoverTransport.java:114)\n\t- locked <0x00002aaadf2bc608> (a java.lang.Object)\n\tat org.apache.activemq.thread.PooledTaskRunner.runTask(PooledTaskRunner.java:122)\n\tat org.apache.activemq.thread.PooledTaskRunner$1.run(PooledTaskRunner.java:43)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)\n\tat java.lang.Thread.run(Thread.java:595)\n\n\"pool-1-thread-1\" prio=1 tid=0x00002aaafc001670 nid=0x6f67 waiting for monitor entry [0x0000000040e1b000..0x0000000040e1bd80]\n\tat org.apache.activemq.ActiveMQConnection.checkClosedOrFailed(ActiveMQConnection.java:1258)\n\t- waiting to lock <0x00002aaadf2ab250> (a org.apache.activemq.ActiveMQConnection)\n\tat org.apache.activemq.ActiveMQConnection.stop(ActiveMQConnection.java:497)\n\tat org.apache.activemq.ActiveMQConnection.close(ActiveMQConnection.java:552)\n\tat com.kentrox.objectproxy.jms.test.JMSConnectionStateTesting.testRetryServerConnectionURLWithNoServer(JMSConnectionStateTesting.java:250)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:39)\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:25)\n\tat java.lang.reflect.Method.invoke(Method.java:585)\n\tat org.junit.internal.runners.TestMethod.invoke(TestMethod.java:59)\n\tat org.junit.internal.runners.MethodRoadie.runTestMethod(MethodRoadie.java:98)\n\tat org.junit.internal.runners.MethodRoadie$1$1.call(MethodRoadie.java:55)\n\tat java.util.concurrent.FutureTask$Sync.innerRun(FutureTask.java:269)\n\tat java.util.concurrent.FutureTask.run(FutureTask.java:123)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:650)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:675)\n\tat java.lang.Thread.run(Thread.java:595)\n{noformat} \n\nThis may be updated in 5.2.0 but this issue suggests it is fixed in 5.1.0 and I don't believe that to be the case.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bhumphre","name":"bhumphre","key":"bhumphre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Humphreys","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-29T00:56:17.730+0000","updated":"2009-03-29T00:56:17.730+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12482172/comment/12941073","id":"12941073","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bhumphre","name":"bhumphre","key":"bhumphre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Humphreys","active":true,"timeZone":"Etc/UTC"},"body":"Running the same JUnit test as above, 5.2.0 seems to fix this deadlock issue.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=bhumphre","name":"bhumphre","key":"bhumphre","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Brett Humphreys","active":true,"timeZone":"Etc/UTC"},"created":"2009-03-29T01:08:50.811+0000","updated":"2009-03-29T01:08:50.811+0000"}],"maxResults":11,"total":11,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-1116/votes","votes":2,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s1jz:"}}