{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12748453","self":"https://issues.apache.org/jira/rest/api/2/issue/12748453","key":"AMQ-5396","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2014-10-17T22:50:32.968+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Mon Oct 20 23:08:02 UTC 2014","customfield_12310420":"9223372036854775807","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_430580126_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2014-10-20T23:08:02.086+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5396/watchers","watchCount":3,"isWatching":false},"created":"2014-10-15T23:31:42.014+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12324951","id":"12324951","name":"5.11.0","archived":false,"released":true,"releaseDate":"2015-02-04"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2014-10-20T23:08:02.132+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"During link stealing in progress if the old client(or connection) issues a disconnect can cause a deadlock due the order in which the locks are obtained on RegionBroker.addConnection and TransportConnection.processRemoveConneciton.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12675416","id":"12675416","filename":"jstack.txt","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sai.boorlagadda%40gmail.com","name":"sai.boorlagadda@gmail.com","key":"sai.boorlagadda@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sai","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-10-17T02:26:06.521+0000","size":5316,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12675416/jstack.txt"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12675396","id":"12675396","filename":"linkstealing-deadlock.patch","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sai.boorlagadda%40gmail.com","name":"sai.boorlagadda@gmail.com","key":"sai.boorlagadda@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sai","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-10-17T00:41:37.572+0000","size":2715,"mimeType":"text/plain","content":"https://issues.apache.org/jira/secure/attachment/12675396/linkstealing-deadlock.patch"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":[{"self":"https://issues.apache.org/jira/rest/api/2/customFieldOption/10042","value":"Patch Available","id":"10042"}],"customfield_12310921":null,"customfield_12310920":"9223372036854775807","customfield_12312823":null,"summary":"Linkstealing causes deadlock when old client disconnects before link stealing adds the connection","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sai.boorlagadda%40gmail.com","name":"sai.boorlagadda@gmail.com","key":"sai.boorlagadda@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sai","active":true,"timeZone":"America/Los_Angeles"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sai.boorlagadda%40gmail.com","name":"sai.boorlagadda@gmail.com","key":"sai.boorlagadda@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sai","active":true,"timeZone":"America/Los_Angeles"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":null,"customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12748453/comment/14174543","id":"14174543","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sai.boorlagadda%40gmail.com","name":"sai.boorlagadda@gmail.com","key":"sai.boorlagadda@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sai","active":true,"timeZone":"America/Los_Angeles"},"body":"attached the jstack which shows the deadlock","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=sai.boorlagadda%40gmail.com","name":"sai.boorlagadda@gmail.com","key":"sai.boorlagadda@gmail.com","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Sai","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-10-17T00:43:55.631+0000","updated":"2014-10-17T00:43:55.631+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12748453/comment/14175667","id":"14175667","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=workanandr","name":"workanandr","key":"workanandr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"AR","active":true,"timeZone":"America/Los_Angeles"},"body":"Test case to reproduce this (with Mqtt Paho client lib):\n\n* In the broker source, in activemq-broker/src/main/java/org/apache/activemq/broker/region/RegionBroker.java add sleep between the 2 lines in function addConnection() as shown below:\n{noformat}\n                            TransportConnection transportConnection = (TransportConnection) connection;\n                             Thread.sleep(30000);\n                             transportConnection.stopAsync();\n{noformat}\n\n* Run the broker\n* Run the following test case:\n{noformat}\n    @Test\n    public void testLinkStealingDeadlock2() throws MqttException, InterruptedException\n    {\n        MqttClient client1 = new MqttClient(\"tcp://localhost:1883\", \"client1\");\n\n        client1.connect();\n\n        Thread thread = new Thread(new Runnable() {\n            @Override\n            public void run() {\n                try {\n                    System.out.println(\"Connecting client 2....\");\n                    MqttClient client2 = new MqttClient(\"tcp://localhost:1883\", \"client1\"); // should be same client id\n                    client2.connect();\n                    System.out.println(\"Done connecting client2\");\n                } catch (MqttException e) {\n                    // TODO Auto-generated catch block\n                    e.printStackTrace();\n                }\n            }\n        });\n        thread.start(); \n        Thread.sleep(2000);\n        System.out.println(\"Disconnecting client1...\");\n        client1.disconnect();\n\n        System.out.println(\"Connecting client3...\");\n        MqttClient client3 = new MqttClient(\"tcp://localhost:1883\", \"client3\");\n        client3.connect();\n\n        System.out.println(\"Client3 connected\");\n\n        client3.disconnect();\n\n\n        Thread.sleep(120*1000);\n        Assert.assertTrue(true);\n    }\n{noformat}\n\n* Run jstack on the JVM\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=workanandr","name":"workanandr","key":"workanandr","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"AR","active":true,"timeZone":"America/Los_Angeles"},"created":"2014-10-17T22:50:32.968+0000","updated":"2014-10-17T22:50:32.968+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12748453/comment/14177622","id":"14177622","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"body":"Reviewed the patch a bit and it looks good.  The old context can be safely used outside the sync block as the stopAsync is thread safe and will only run once so if the owning connection closes first it will be fine.  I tweaked the patch a bit to avoid the log output when old context is null, as that would spam the logs.  ","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=tabish121","name":"tabish121","key":"tabish121","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249"},"displayName":"Timothy Bish","active":true,"timeZone":"America/Havana"},"created":"2014-10-20T23:08:02.126+0000","updated":"2014-10-20T23:08:02.126+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-5396/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i2182v:"}}