{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12556001","self":"https://issues.apache.org/jira/rest/api/2/issue/12556001","key":"AMQ-3844","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12317974","id":"12317974","description":"Next v5 maintenance release","name":"5.6.0","archived":false,"released":true,"releaseDate":"2012-05-07"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2012-05-17T14:36:47.977+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Sun May 20 14:19:50 UTC 2012","customfield_12310420":"249838","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_103326016_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2012-05-17T14:37:27.460+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3844/watchers","watchCount":2,"isWatching":false},"created":"2012-05-16T09:55:21.664+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"2.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12318548","id":"12318548","name":"5.4.3","archived":false,"released":true,"releaseDate":"2011-10-16"},{"self":"https://issues.apache.org/jira/rest/api/2/version/12318549","id":"12318549","name":"5.5.1","archived":false,"released":true,"releaseDate":"2011-10-16"}],"issuelinks":[],"customfield_12312339":null,"assignee":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"customfield_12312337":null,"customfield_12312338":null,"updated":"2012-05-20T14:19:50.965+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Sometimes off and on the ActiveMQ server, the KahaDB maintains some old transactions that try to recovery. So at start up these transactions are added to the {{xaTransactions}} map inside {{TransactionBroker}} with a null {{ConnectionId}}.\n\nThis is the stack trace of the recovery at startup:\n\n{code:none} \n\tTransactionBroker.beginTransaction(ConnectionContext, TransactionId) line: 152\t\n\tTransactionBroker$1.recover(XATransactionId, Message[], MessageAck[]) line: 92\t\n\tKahaDBTransactionStore.recover(TransactionRecoveryListener) line: 317\t\n\tTransactionBroker.start() line: 89\t\n\tBrokerService$3.start() line: 1781\t\n\tXBeanBrokerService(BrokerService).start() line: 489\t\n\tXBeanBrokerService.afterPropertiesSet() line: 60\t\n\tNativeMethodAccessorImpl.invoke0(Method, Object, Object[]) line: not available [native method]\t\n\tNativeMethodAccessorImpl.invoke(Object, Object[]) line: 39\t\n\tDelegatingMethodAccessorImpl.invoke(Object, Object[]) line: 25\t\n\tMethod.invoke(Object, Object...) line: 597\t\n\tDefaultListableBeanFactory(AbstractAutowireCapableBeanFactory).invokeCustomInitMethod(String, Object, RootBeanDefinition) line: 1536\t\n\tDefaultListableBeanFactory(AbstractAutowireCapableBeanFactory).invokeInitMethods(String, Object, RootBeanDefinition) line: 1477\t\n\tDefaultListableBeanFactory(AbstractAutowireCapableBeanFactory).initializeBean(String, Object, RootBeanDefinition) line: 1409\t\n\tDefaultListableBeanFactory(AbstractAutowireCapableBeanFactory).doCreateBean(String, RootBeanDefinition, Object[]) line: 519\t\n\tDefaultListableBeanFactory(AbstractAutowireCapableBeanFactory).createBean(String, RootBeanDefinition, Object[]) line: 456\t\n\tAbstractBeanFactory$1.getObject() line: 291\t\n\tDefaultListableBeanFactory(DefaultSingletonBeanRegistry).getSingleton(String, ObjectFactory) line: 222\t\n\tDefaultListableBeanFactory(AbstractBeanFactory).doGetBean(String, Class<T>, Object[], boolean) line: 288\t\n\tDefaultListableBeanFactory(AbstractBeanFactory).getBean(String) line: 190\t\n\tDefaultListableBeanFactory.preInstantiateSingletons() line: 574\t\n\tXBeanBrokerFactory$1(AbstractApplicationContext).finishBeanFactoryInitialization(ConfigurableListableBeanFactory) line: 895\t\n\tXBeanBrokerFactory$1(AbstractApplicationContext).refresh() line: 425\t\n\tXBeanBrokerFactory$1(ResourceXmlApplicationContext).<init>(Resource, List) line: 64\t\n\tXBeanBrokerFactory$1(ResourceXmlApplicationContext).<init>(Resource) line: 52\t\n\tXBeanBrokerFactory$1.<init>(XBeanBrokerFactory, Resource) line: 115\t\n\tXBeanBrokerFactory.createApplicationContext(String) line: 115\t\n\tXBeanBrokerFactory.createBroker(URI) line: 71\t\n\tBrokerFactory.createBroker(URI, boolean) line: 71\t\n\tBrokerFactory.createBroker(URI) line: 54\t\n\tStartCommand.startBroker(URI) line: 115\t\n\tStartCommand.runTask(List<String>) line: 74\t\n\tStartCommand(AbstractCommand).execute(List<String>) line: 57\t\n\tShellCommand.runTask(List<String>) line: 143\t\n\tShellCommand(AbstractCommand).execute(List<String>) line: 57\t\n\tShellCommand.main(String[], InputStream, PrintStream) line: 85\t\n\tNativeMethodAccessorImpl.invoke0(Method, Object, Object[]) line: not available [native method]\t\n\tNativeMethodAccessorImpl.invoke(Object, Object[]) line: 39\t\n\tDelegatingMethodAccessorImpl.invoke(Object, Object[]) line: 25\t\n\tMethod.invoke(Object, Object...) line: 597\t\n\tMain.runTaskClass(List<String>) line: 251\t\n\tMain.main(String[]) line: 107\t \n{code} \n\nDuring the  runtime the client tries to add and remove connections; sometimes the removeConnection throws a NPE due to these transactions without ConnectionID.\nTake a look to the code fragment from {{TransactionBroker}}:\n\n{code:java}\n    public void removeConnection(ConnectionContext context, ConnectionInfo info, Throwable error) throws Exception {\n        for (Iterator<Transaction> iter = context.getTransactions().values().iterator(); iter.hasNext();) {\n            try {\n                Transaction transaction = iter.next();\n                transaction.rollback();\n            } catch (Exception e) {\n                LOG.warn(\"ERROR Rolling back disconnected client's transactions: \", e);\n            }\n            iter.remove();\n        }\n\n        synchronized (xaTransactions) {\n            // first find all txs that belongs to the connection\n            ArrayList<XATransaction> txs = new ArrayList<XATransaction>();\n            for (XATransaction tx : xaTransactions.values()) {\n                if (tx.getConnectionId().equals(info.getConnectionId()) && !tx.isPrepared()) {\n                    txs.add(tx);\n                }\n            }\n\n            // then remove them\n            // two steps needed to avoid ConcurrentModificationException, from removeTransaction()\n            for (XATransaction tx : txs) {\n                try {\n                    tx.rollback();\n                } catch (Exception e) {\n                    LOG.warn(\"ERROR Rolling back disconnected client's xa transactions: \", e);\n                }\n            }\n\n        }\n        next.removeConnection(context, info, error);\n    }\n{code}\n\nas you can see inside the loop there is a check for {{tx.getConnectionId().equals(info.getConnectionId())}} that throws the NPE. When this occurs the connection isn't removed. This information isn't shared with the client that believes the opposite, so the next time that try to resend client information to server obtain (under jBoss) this error {{javax.transaction.xa.XAException: Broker: AMQ - Client: ID:srv001-47592-1336730655955-64:2 already connected from /127.0.0.1:49806}}\nthat can be bound to the former server fails.\nThis scenario can be found inside the attached logs.\n","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12527602","id":"12527602","filename":"ActiveMQ_server.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=antonioderrico","name":"antonioderrico","key":"antonioderrico","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antonio D'Errico","active":true,"timeZone":"Etc/UTC"},"created":"2012-05-16T10:18:14.200+0000","size":7163,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12527602/ActiveMQ_server.log"},{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12527603","id":"12527603","filename":"jBoss_server.log","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=antonioderrico","name":"antonioderrico","key":"antonioderrico","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antonio D'Errico","active":true,"timeZone":"Etc/UTC"},"created":"2012-05-16T10:18:14.240+0000","size":31078,"mimeType":"text/x-log","content":"https://issues.apache.org/jira/secure/attachment/12527603/jBoss_server.log"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"59159","customfield_12312823":null,"summary":"NullPointerException when removing connection info","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=antonioderrico","name":"antonioderrico","key":"antonioderrico","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antonio D'Errico","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=antonioderrico","name":"antonioderrico","key":"antonioderrico","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antonio D'Errico","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Linux 2.6.18-274.12.1.el5 #1 SMP Tue Nov 29 13:37:35 EST 2011 i686 athlon i386 GNU/Linux, Java(TM) SE Runtime Environment (build 1.6.0_29-b11)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12556001/comment/13277860","id":"13277860","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"This has been fixed for 5.6, there is a now a null check before: {code}tx.getConnectionId().equals(info.getConnectionId(){code} in TransactionBroker\nfix from https://issues.apache.org/jira/browse/AMQ-3305","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-05-17T14:36:47.977+0000","updated":"2012-05-17T14:36:47.977+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12556001/comment/13277861","id":"13277861","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"body":"fix related to https://issues.apache.org/jira/browse/AMQ-3305","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=gtully","name":"gtully","key":"gtully","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Gary Tully","active":true,"timeZone":"Etc/UTC"},"created":"2012-05-17T14:37:27.545+0000","updated":"2012-05-17T14:37:27.545+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12556001/comment/13279771","id":"13279771","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=antonioderrico","name":"antonioderrico","key":"antonioderrico","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antonio D'Errico","active":true,"timeZone":"Etc/UTC"},"body":"Thank you Gary, \n\nI look the code and I do some other test and all seems to be okay now.\n\n","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=antonioderrico","name":"antonioderrico","key":"antonioderrico","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Antonio D'Errico","active":true,"timeZone":"Etc/UTC"},"created":"2012-05-20T14:19:50.912+0000","updated":"2012-05-20T14:19:50.912+0000"}],"maxResults":3,"total":3,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-3844/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0ahtb:"}}