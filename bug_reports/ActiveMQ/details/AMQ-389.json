{"expand":"renderedFields,names,schema,operations,editmeta,changelog,versionedRepresentations","id":"12481616","self":"https://issues.apache.org/jira/rest/api/2/issue/12481616","key":"AMQ-389","fields":{"issuetype":{"self":"https://issues.apache.org/jira/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":21133},"timespent":null,"project":{"self":"https://issues.apache.org/jira/rest/api/2/project/12311210","id":"12311210","key":"AMQ","name":"ActiveMQ","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011","24x24":"https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011","16x16":"https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011","32x32":"https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011"},"projectCategory":{"self":"https://issues.apache.org/jira/rest/api/2/projectCategory/11160","id":"11160","description":"ActiveMQ","name":"ActiveMQ"}},"fixVersions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315607","id":"12315607","description":"Milestone 4","name":"4.0 M4","archived":false,"released":true,"releaseDate":"2006-01-20"}],"aggregatetimespent":null,"resolution":{"self":"https://issues.apache.org/jira/rest/api/2/resolution/1","id":"1","description":"A fix for this issue is checked into the tree and tested.","name":"Fixed"},"customfield_12312322":null,"customfield_12310220":"2005-11-15T18:57:57.000+0000","customfield_12312520":null,"customfield_12312323":null,"customfield_12312521":"Tue Nov 15 18:57:57 UTC 2005","customfield_12310420":"49081","customfield_12312320":null,"customfield_12310222":"1_*:*_1_*:*_2316209000_*|*_5_*:*_1_*:*_0","customfield_12312321":null,"resolutiondate":"2005-11-15T18:57:57.000+0000","workratio":-1,"customfield_12312328":null,"customfield_12312329":null,"customfield_12312923":null,"customfield_12312326":null,"customfield_12312920":null,"customfield_12310300":null,"customfield_12312327":null,"customfield_12312921":null,"customfield_12312324":null,"customfield_12312720":null,"customfield_12312325":null,"lastViewed":null,"watches":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-389/watchers","watchCount":1,"isWatching":false},"created":"2005-10-19T23:34:28.000+0000","priority":{"self":"https://issues.apache.org/jira/rest/api/2/priority/3","iconUrl":"https://issues.apache.org/jira/images/icons/priorities/major.svg","name":"Major","id":"3"},"labels":[],"customfield_12312333":null,"customfield_12312334":null,"customfield_12313422":"false","customfield_12310310":"1.0","customfield_12312331":null,"customfield_12312332":null,"timeestimate":null,"aggregatetimeoriginalestimate":null,"customfield_12311120":null,"customfield_12312330":null,"versions":[{"self":"https://issues.apache.org/jira/rest/api/2/version/12315601","id":"12315601","name":"3.1","archived":false,"released":true}],"issuelinks":[],"customfield_12312339":null,"assignee":null,"customfield_12312337":null,"customfield_12312338":null,"updated":"2006-02-16T11:30:47.000+0000","customfield_12312335":null,"customfield_12312336":null,"status":{"self":"https://issues.apache.org/jira/rest/api/2/status/5","description":"A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.","iconUrl":"https://issues.apache.org/jira/images/icons/statuses/resolved.png","name":"Resolved","id":"5","statusCategory":{"self":"https://issues.apache.org/jira/rest/api/2/statuscategory/3","id":3,"key":"done","colorName":"green","name":"Done"}},"components":[{"self":"https://issues.apache.org/jira/rest/api/2/component/12313892","id":"12313892","name":"Broker"}],"timeoriginalestimate":null,"customfield_12310080":null,"description":"Within a clustered environment, messages that have been sent to a Queue can end up stuck in the broker and are never delivered to the connected consumer.\n\nSuppose, we have a cluster of two JMS brokers, Node 0 and Node 1, and that there is an active producer and an active consumer connected to Node 0, that are producing and consuming from Queue, Q. i.e. \n\nProducer \n\n|\n\nNode 0 <-----> Node 1\n\n|\n\nConsumer\n\nAnd the following happens for a Message, M, sent to Queue, Q:\n\nI) Node 0 receives message M from the producer \nII) Node 1 consumes message M from Node 0\niii) Node 0 consumes message M back from Node 1\niv) Node 1 attempts to consume message M from Node 0 again.\n\nThen, the message will end up being undelivered. It will still be in the MessageStore for Node0, but will never be dispatched to any consumer, unless the broker is restarted.\n\nThe reason this happens, is that during step iv) the message wil be dispatched to the subscriber represented by Node 1, and thus Node 0 will believe the message has successfully been sent, but Node 1's subscriber will never actually send the message to Node 1, since the anti-cycle logic in the BrokerClientImpl::send() method will drop the packet silently.\n\nA simple possible fix is:\n\nAlter the method signature for BrokerClient::dispatch() to return a boolean iff only it can successfully dispatch the message to the actual consumer. The same change needs to be made to the DurableQueueSubscription::doDispatch() method, to propagate this information.\n\nThe DurableQueueBoundedMessageContainer::run() method can then be altered so it only considers a message dispatched if one of its subscribers doDispatch() methods returns true, otherwise it will retain the message.\n\nI have attached the modified source files in the patch.zip.","customfield_10010":null,"timetracking":{},"customfield_12312026":null,"customfield_12312023":null,"customfield_12312024":null,"customfield_12312340":null,"attachment":[{"self":"https://issues.apache.org/jira/rest/api/2/attachment/12460539","id":"12460539","filename":"ASF.LICENSE.NOT.GRANTED--patch.zip","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matthewv","name":"matthewv","key":"matthewv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Vincent","active":true,"timeZone":"Etc/UTC"},"created":"2005-10-19T23:34:29.000+0000","size":14420,"mimeType":"application/zip","content":"https://issues.apache.org/jira/secure/attachment/12460539/ASF.LICENSE.NOT.GRANTED--patch.zip"}],"aggregatetimeestimate":null,"customfield_12312341":null,"customfield_12312220":null,"customfield_12312022":null,"customfield_12310041":null,"customfield_12310921":null,"customfield_12310920":"161896","customfield_12312823":null,"summary":"Messages aren't delivered in a clustered environment","creator":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matthewv","name":"matthewv","key":"matthewv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Vincent","active":true,"timeZone":"Etc/UTC"},"subtasks":[],"customfield_12310291":null,"reporter":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matthewv","name":"matthewv","key":"matthewv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Vincent","active":true,"timeZone":"Etc/UTC"},"customfield_12310290":null,"aggregateprogress":{"progress":0,"total":0},"customfield_12311024":null,"environment":"Windows XP, Java  1.4.1_01 (Sun)","customfield_12313520":null,"customfield_12311020":null,"duedate":null,"customfield_12310250":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481616/comment/12937307","id":"12937307","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matthewv","name":"matthewv","key":"matthewv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Vincent","active":true,"timeZone":"Etc/UTC"},"body":"One problem with the fix, that I forgot to mention, is that the logic for checking the cycle is now replicated in the BrokerClientImpl::dispatch() method. This logic could be factored out to a common method if BrokerClientImpl::send() still needs to check this, or removed from BrokerClientImpl::send() altogether, if it doesn't need to check for this other than during a dispatch.","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=matthewv","name":"matthewv","key":"matthewv","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"Matthew Vincent","active":true,"timeZone":"Etc/UTC"},"created":"2005-10-19T23:39:59.000+0000","updated":"2005-10-19T23:39:59.000+0000"},{"self":"https://issues.apache.org/jira/rest/api/2/issue/12481616/comment/12937245","id":"12937245","author":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"body":"This is now resolved in ActiveMQ 4.0 as we have a DemandBasedForwardingBridge which only forwards messages to another broker when there is a consumer for it","updateAuthor":{"self":"https://issues.apache.org/jira/rest/api/2/user?username=jstrachan","name":"jstrachan","key":"jstrachan","avatarUrls":{"48x48":"https://issues.apache.org/jira/secure/useravatar?avatarId=10452","24x24":"https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452","16x16":"https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452","32x32":"https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452"},"displayName":"james strachan","active":true,"timeZone":"Etc/UTC"},"created":"2005-11-15T18:57:57.000+0000","updated":"2005-11-15T18:57:57.000+0000"}],"maxResults":2,"total":2,"startAt":0},"votes":{"self":"https://issues.apache.org/jira/rest/api/2/issue/AMQ-389/votes","votes":0,"hasVoted":false},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]},"customfield_12311820":"0|i0s2lb:"}}