{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&ownerId=tabish121&avatarId=25249",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&ownerId=tabish121&avatarId=25249",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&ownerId=tabish121&avatarId=25249",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?ownerId=tabish121&avatarId=25249"
            },
            "displayName": "Timothy Bish",
            "key": "tabish121",
            "name": "tabish121",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=tabish121",
            "timeZone": "America/Havana"
        },
        "components": [
            {
                "description": "MQTT Transport",
                "id": "12318701",
                "name": "MQTT",
                "self": "https://issues.apache.org/jira/rest/api/2/component/12318701"
            },
            {
                "id": "12313903",
                "name": "Transport",
                "self": "https://issues.apache.org/jira/rest/api/2/component/12313903"
            }
        ],
        "created": "2017-05-22T09:01:41.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Marco Geri",
            "key": "grayra",
            "name": "grayra",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=grayra",
            "timeZone": "Etc/UTC"
        },
        "customfield_10010": null,
        "customfield_12310041": [{
            "id": "10042",
            "self": "https://issues.apache.org/jira/rest/api/2/customFieldOption/10042",
            "value": "Patch Available"
        }],
        "customfield_12310080": null,
        "customfield_12310220": "2017-05-22T16:27:45.943+0000",
        "customfield_12310222": "1_*:*_1_*:*_26839503_*|*_5_*:*_1_*:*_0",
        "customfield_12310250": [{
            "id": "10430",
            "self": "https://issues.apache.org/jira/rest/api/2/customFieldOption/10430",
            "value": "Patch"
        }],
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "4.0",
        "customfield_12310420": "9223372036854775807",
        "customfield_12310920": "9223372036854775807",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i3fa93:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "Mon May 22 16:28:08 UTC 2017",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "I tried to use the MQTT.js library in a browser but it didn't connect to ActiveMQ using MQTT-WebSocket transport.\nDebugging MQTT.js and ActiveMQ I found that the org.apache.activemq.transport.ws.jetty9.MQTTSocket class (in activemq-http module) assumes that a single WebSocket data frame +always+ contains a single MQTT Control Packet.\nThis is the cause of MQTT.js failure because MQTT.js makes several send over WebSocket for a single MQTT Control Packet (header, length etc).\n\nAccordingly to MQTT OASIS specification ( http://docs.oasis-open.org/mqtt/mqtt/v3.1.1/os/mqtt-v3.1.1-os.html#_Toc398718127 ):\n\n??A single WebSocket data frame can contain multiple or partial MQTT Control Packets. The receiver MUST NOT assume that MQTT Control Packets are aligned on WebSocket frame boundaries.??\n\nAnd RFC 6455 ( https://www.ietf.org/rfc/rfc6455.txt ): \n\n??The WebSocket message does not necessarily correspond to a particular network layer framing, as a fragmented message may be coalesced or split by an intermediary.??\n\nSo I think that ActiveMQ should be fixed to be compliant to the WebSocket and MQTT specifications.\n\nI attached the diff patch file for MQTTSocket which fixes the problem and a new activemq-http module MQTT-WebSocket unit test for this issue (the same of MQTTWSTransportTest but which splits MQTT Frame Packet in multiple WebSocket frames):\n\nMQTTWSPartialFrameConnection.java\nMQTTWSPartialFrameTest.java\n\nWhen writing the unit test I found also a bug in the class org.apache.activemq.transport.ws.MQTTWSConnection.java. \nAll the occurrences of: \n\n{code:java}\nByteSequence payload = wireFormat.marshal(command.encode());\nconnection.getRemote().sendBytes(ByteBuffer.wrap(payload.data));\n{code}\n \nshould be replaced with:\n\n{code:java}\nByteSequence payload = wireFormat.marshal(command.encode());\nconnection.getRemote().sendBytes(ByteBuffer.wrap(payload.data, payload.offset, payload.length));\n{code}\n\nThat is because of the payload.data bytes array buffer in ByteSequenze is bigger than the real MQTT frame packed bytes size, so sending all the payload.data bytes array, ActiveMQ receives much more extra zero-extra bytes. With the current implementation, those extra zero-bytes are ignored and this makes wrongly passes the test (while it should fail because there are \"extra bytes\" which doesn't respect the MQTT protocol).\n\nI attached also the diff patch file for the MQTTWSConnection file.\n",
        "duedate": null,
        "environment": null,
        "fixVersions": [
            {
                "archived": false,
                "id": "12338054",
                "name": "5.15.0",
                "releaseDate": "2017-07-05",
                "released": true,
                "self": "https://issues.apache.org/jira/rest/api/2/version/12338054"
            },
            {
                "archived": false,
                "id": "12340366",
                "name": "5.14.6",
                "released": false,
                "self": "https://issues.apache.org/jira/rest/api/2/version/12340366"
            }
        ],
        "issuelinks": [],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [
            "mqtt",
            "patch",
            "websocket"
        ],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/critical.svg",
            "id": "2",
            "name": "Critical",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/2"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011"
            },
            "id": "12311210",
            "key": "AMQ",
            "name": "ActiveMQ",
            "projectCategory": {
                "description": "ActiveMQ",
                "id": "11160",
                "name": "ActiveMQ",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/11160"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12311210"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Marco Geri",
            "key": "grayra",
            "name": "grayra",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=grayra",
            "timeZone": "Etc/UTC"
        },
        "resolution": {
            "description": "A fix for this issue is checked into the tree and tested.",
            "id": "1",
            "name": "Fixed",
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1"
        },
        "resolutiondate": "2017-05-22T16:29:00.000+0000",
        "status": {
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "id": "5",
            "name": "Resolved",
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "statusCategory": {
                "colorName": "green",
                "id": 3,
                "key": "done",
                "name": "Done",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
            }
        },
        "subtasks": [],
        "summary": "MQTT over WebSocket doesn't work when WebSocket data frame contains partial or multiple MQTT control packets",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2017-05-22T16:29:00.000+0000",
        "versions": [{
            "archived": false,
            "id": "12339772",
            "name": "5.14.5",
            "releaseDate": "2017-04-16",
            "released": true,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12339772"
        }],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/AMQ-6680/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/AMQ-6680/watchers",
            "watchCount": 2
        },
        "workratio": -1
    },
    "id": "13073792",
    "key": "AMQ-6680",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/13073792"
}