{
    "expand": "operations,versionedRepresentations,editmeta,changelog,renderedFields",
    "fields": {
        "aggregateprogress": {
            "progress": 0,
            "total": 0
        },
        "aggregatetimeestimate": null,
        "aggregatetimeoriginalestimate": null,
        "aggregatetimespent": null,
        "assignee": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Gary Tully",
            "key": "gtully",
            "name": "gtully",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=gtully",
            "timeZone": "Etc/UTC"
        },
        "components": [{
            "id": "12313892",
            "name": "Broker",
            "self": "https://issues.apache.org/jira/rest/api/2/component/12313892"
        }],
        "created": "2009-11-05T13:51:00.000+0000",
        "creator": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Dominic Tootell",
            "key": "dominict",
            "name": "dominict",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=dominict",
            "timeZone": "Etc/UTC"
        },
        "customfield_10010": null,
        "customfield_12310041": [{
            "id": "10042",
            "self": "https://issues.apache.org/jira/rest/api/2/customFieldOption/10042",
            "value": "Patch Available"
        }],
        "customfield_12310080": null,
        "customfield_12310220": "2009-11-05T16:32:35.131+0000",
        "customfield_12310222": "1_*:*_1_*:*_9694300_*|*_5_*:*_1_*:*_0",
        "customfield_12310250": null,
        "customfield_12310290": null,
        "customfield_12310291": null,
        "customfield_12310300": null,
        "customfield_12310310": "3.0",
        "customfield_12310420": "38748",
        "customfield_12310920": "159962",
        "customfield_12310921": null,
        "customfield_12311020": null,
        "customfield_12311024": null,
        "customfield_12311120": null,
        "customfield_12311820": "0|i0rqnj:",
        "customfield_12312022": null,
        "customfield_12312023": null,
        "customfield_12312024": null,
        "customfield_12312026": null,
        "customfield_12312220": null,
        "customfield_12312320": null,
        "customfield_12312321": null,
        "customfield_12312322": null,
        "customfield_12312323": null,
        "customfield_12312324": null,
        "customfield_12312325": null,
        "customfield_12312326": null,
        "customfield_12312327": null,
        "customfield_12312328": null,
        "customfield_12312329": null,
        "customfield_12312330": null,
        "customfield_12312331": null,
        "customfield_12312332": null,
        "customfield_12312333": null,
        "customfield_12312334": null,
        "customfield_12312335": null,
        "customfield_12312336": null,
        "customfield_12312337": null,
        "customfield_12312338": null,
        "customfield_12312339": null,
        "customfield_12312340": null,
        "customfield_12312341": null,
        "customfield_12312520": null,
        "customfield_12312521": "Thu Nov 05 16:32:35 UTC 2009",
        "customfield_12312720": null,
        "customfield_12312823": null,
        "customfield_12312920": null,
        "customfield_12312921": null,
        "customfield_12312923": null,
        "customfield_12313422": "false",
        "customfield_12313520": null,
        "description": "The problem seem to be that open the persistence store (disk) has run out of space, if the producer keeps on sending messages to the broker the brokers end up eating up the file descriptors for the process (default 1024), and you get the error \"too many open files\".  The only way to fix this is a broker restart.\n\n1) Producer is sending to the broker\n2) Disk Space on the broker runs out\n3) The producer gets the error:\n\n[2009.11.02 23:05:30] [main] INFO  ProducerTool -  Sent Message:\n[18973 : ^@^@OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO...], took: 1ms\n[2009.11.02 23:05:30] [main] WARN  ProducerTool -  Error sending\nmessage:18974 : ^@^@OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO...\njavax.jms.JMSException: No space left on device\n      at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:49)\n      at org.apache.activemq.ActiveMQConnection.syncSendPacket(ActiveMQConnection.java:1255)\n\n4)  The broker gets the error:\n\n{code}\nDEBUG Service                        - Error occured while processing\nasync command: MessageAck {commandId = 53297, responseRequired =\nfalse, ackType = 2, consumerId =\nID:dominic-tootells-macbook-pro.local-57138-1257203010059-0:0:-1:2,\nfirstMessageId =\nID:dominic-tootells-macbook-pro.local-57143-1257203033952-0:0:1:1:17751,\nlastMessageId =\nID:dominic-tootells-macbook-pro.local-57143-1257203033952-0:0:1:1:17751,\ndestination = queue://iplayer, transactionId =\nTX:ID:dominic-tootells-macbook-pro.local-57138-1257203010059-0:0:17751,\nmessageCount = 1}, exception: java.io.IOException: No space left on\ndevice\njava.io.IOException: No space left on device\n       at java.io.RandomAccessFile.setLength(Native Method)\n{code}\n\n5) All is good if you spot this and go clear up some space quick\nsharp; both the broker and the producer recover and can carry one.\nHowever, if you don't notice and react quick enough, and the producer\nkeeps on sending messages to the broker, then broker ends up with the\nerror \"too many open files\":\n\n{code}\nId = ID:dominic-tootells-macbook-pro.local-57143-1257203033952-0:0:1:1:35920,\nlastMessageId =\nID:dominic-tootells-macbook-pro.local-57143-1257203033952-0:0:1:1:35920,\ndestination = queue://iplayer, transactionId =\nTX:ID:dominic-tootells-macbook-pro.local-57138-1257203010059-0:0:52674,\nmessageCount = 1}, exception: java.io.FileNotFoundException:\n/Volumes/SSD/data/journal/data-4 (Too many open files)\njava.io.FileNotFoundException: /Volumes/SSD/data/journal/data-4 (Too\nmany open files)\n       at java.io.RandomAccessFile.open(Native Method)\n       at java.io.RandomAccessFile.<init>(RandomAccessFile.java:212)\n       at org.apache.activemq.kaha.impl.async.DataFile.openRandomAccess\n{code}\n\n\nTrying the following combinations:\n\n- no failover protocol\n- no send sendFailIfNoSpace being sent to the producer\n- recreating the producer connection after the error\n- no consumer attached to the broker\n\nIn the end I attached JProfiler to the broker (via a small junit), and\nnoticed that upon the \"No space left on device\" error the number of\nFile objects and FileDescriptor objects would grow, and not shrink.\nUpon looking at the below stack trace:\n\n{code}\nCaused by: java.io.IOException: No space left on device\n       at java.io.RandomAccessFile.setLength(Native Method)\n       at org.apache.activemq.kaha.impl.async.DataFile.openRandomAccessFile(DataFile.java:96)\n       at org.apache.activemq.kaha.impl.async.AsyncDataManager.allocateLocation(AsyncDataManager.java:276)\n       at org.apache.activemq.kaha.impl.async.DataFileAppender.storeItem(DataFileAppender.java:169)\n       at org.apache.activemq.kaha.impl.async.AsyncDataManager.write(AsyncDataManager.java:647)\n       at org.apache.activemq.store.amq.AMQPersistenceAdapter.writeCommand(AMQPersistenceAdapter.java:697)\n       at org.apache.activemq.store.amq.AMQPersistenceAdapter.writeCommand(AMQPersistenceAdapter.java:693)\n       at org.apache.activemq.store.amq.AMQMessageStore.addMessage(AMQMessageStore.java:106)\n       at org.apache.activemq.broker.region.Queue.doMessageSend(Queue.java:503)\n       at org.apache.activemq.broker.region.Queue.send(Queue.java:480)\n       at org.apache.activemq.broker.region.AbstractRegion.send(AbstractRegion.java:354)\n       at org.apache.activemq.broker.region.RegionBroker.send(RegionBroker.java:443)\n       at org.apache.activemq.broker.TransactionBroker.send(TransactionBroker.java:224)\n       at org.apache.activemq.broker.CompositeDestinationBroker.send(CompositeDestinationBroker.java:95)\n       at org.apache.activemq.broker.MutableBrokerFilter.send(MutableBrokerFilter.java:133)\n       at org.apache.activemq.broker.TransportConnection.processMessage(TransportConnection.java:455)\n       at org.apache.activemq.command.ActiveMQMessage.visit(ActiveMQMessage.java:639)\n       at org.apache.activemq.broker.TransportConnection.service(TransportConnection.java:308)\n       at org.apache.activemq.broker.TransportConnection$1.onCommand(TransportConnection.java:182)\n       at org.apache.activemq.transport.TransportFilter.onCommand(TransportFilter.java:68)\n       at org.apache.activemq.transport.WireFormatNegotiator.onCommand(WireFormatNegotiator.java:113)\n       at org.apache.activemq.transport.InactivityMonitor.onCommand(InactivityMonitor.java:210)\n       at org.apache.activemq.transport.TransportSupport.doConsume(TransportSupport.java:84)\n       at org.apache.activemq.transport.tcp.TcpTransport.doRun(TcpTransport.java:203)\n       at org.apache.activemq.transport.tcp.TcpTransport.run(TcpTransport.java:185)\n       at java.lang.Thread.run(Thread.java:637)\n{code}\n\nI took a look at:\n\norg.apache.activemq.kaha.impl.async.DataFile.openRandomAccessFile(DataFile.java:96):\n\n{code}\n  public synchronized RandomAccessFile openRandomAccessFile(boolean\nappender) throws IOException {\n       RandomAccessFile rc = new RandomAccessFile(file, \"rw\");\n       // When we start to write files size them up so that the OS has a chance\n       // to allocate the file contigously.\n       if (appender) {\n           if (length < preferedSize) {\n                       rc.setLength(preferedSize);\n           }\n       }\n       return rc;\n   }\n{code}\n\n  The problem is the rc.setLength(preferedSize);  without a try/catch\nblock to close the opened file incase of a IOException, that can\nresult from the setLength on empty filesystem.\n\n  Changing the method to, contain a try/catch as follows, from my testing appears to fix the\nissue (have tried on my local broker, and this works).\n\n{code}\n  public synchronized RandomAccessFile openRandomAccessFile(boolean\nappender) throws IOException {\n       RandomAccessFile rc = new RandomAccessFile(file, \"rw\");\n       // When we start to write files size them up so that the OS has a chance\n       // to allocate the file contigously.\n       if (appender) {\n           if (length < preferedSize) {\n               try\n               {\n                       rc.setLength(preferedSize);\n               }\n               catch(IOException e)\n               {\n                       try\n                       {\n                               rc.close();\n                       }\n                       catch(Exception closeException){}\n                       throw e;\n               }\n\n           }\n       }\n       return rc;\n   }\n{code}\n\n\nI shall attach a junit for testing (it is hard coded to write to my small removal disk /Volumes/SSD/data), so this you will need to change.  I need somewhere where I could fill the disk up.  The Junit just does:\n\n- Producer writes to a persistent queue until the disk space fills up and keeps on going.  After a while you see the \"too many open files\" exception.\n\nI've looked at trunk\n\nhttps://svn.apache.org/repos/asf/activemq/trunk/activemq-core/src/main/java/org/apache/activemq/kaha/impl/async/DataFile.java\n\nAnd this has the same code as the 5.3.0.4 so I'm guessing that would have the same issue.\n\nI'll attach the junit, the patch diff and the patch file.\n/dom\n\n",
        "duedate": null,
        "environment": "MacOSX 10.6.1, fusesource broker 5.3.0.4.",
        "fixVersions": [
            {
                "archived": false,
                "description": "",
                "id": "12315621",
                "name": "5.3.1",
                "releaseDate": "2010-03-23",
                "released": true,
                "self": "https://issues.apache.org/jira/rest/api/2/version/12315621"
            },
            {
                "archived": false,
                "description": "version 5 feature complete",
                "id": "12315623",
                "name": "5.4.0",
                "releaseDate": "2010-08-17",
                "released": true,
                "self": "https://issues.apache.org/jira/rest/api/2/version/12315623"
            }
        ],
        "issuelinks": [],
        "issuetype": {
            "avatarId": 21133,
            "description": "A problem which impairs or prevents the functions of the product.",
            "iconUrl": "https://issues.apache.org/jira/secure/viewavatar?size=xsmall&avatarId=21133&avatarType=issuetype",
            "id": "1",
            "name": "Bug",
            "self": "https://issues.apache.org/jira/rest/api/2/issuetype/1",
            "subtask": false
        },
        "labels": [],
        "lastViewed": null,
        "priority": {
            "iconUrl": "https://issues.apache.org/jira/images/icons/priorities/major.svg",
            "id": "3",
            "name": "Major",
            "self": "https://issues.apache.org/jira/rest/api/2/priority/3"
        },
        "progress": {
            "progress": 0,
            "total": 0
        },
        "project": {
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/projectavatar?size=xsmall&pid=12311210&avatarId=10011",
                "24x24": "https://issues.apache.org/jira/secure/projectavatar?size=small&pid=12311210&avatarId=10011",
                "32x32": "https://issues.apache.org/jira/secure/projectavatar?size=medium&pid=12311210&avatarId=10011",
                "48x48": "https://issues.apache.org/jira/secure/projectavatar?pid=12311210&avatarId=10011"
            },
            "id": "12311210",
            "key": "AMQ",
            "name": "ActiveMQ",
            "projectCategory": {
                "description": "ActiveMQ",
                "id": "11160",
                "name": "ActiveMQ",
                "self": "https://issues.apache.org/jira/rest/api/2/projectCategory/11160"
            },
            "self": "https://issues.apache.org/jira/rest/api/2/project/12311210"
        },
        "reporter": {
            "active": true,
            "avatarUrls": {
                "16x16": "https://issues.apache.org/jira/secure/useravatar?size=xsmall&avatarId=10452",
                "24x24": "https://issues.apache.org/jira/secure/useravatar?size=small&avatarId=10452",
                "32x32": "https://issues.apache.org/jira/secure/useravatar?size=medium&avatarId=10452",
                "48x48": "https://issues.apache.org/jira/secure/useravatar?avatarId=10452"
            },
            "displayName": "Dominic Tootell",
            "key": "dominict",
            "name": "dominict",
            "self": "https://issues.apache.org/jira/rest/api/2/user?username=dominict",
            "timeZone": "Etc/UTC"
        },
        "resolution": {
            "description": "A fix for this issue is checked into the tree and tested.",
            "id": "1",
            "name": "Fixed",
            "self": "https://issues.apache.org/jira/rest/api/2/resolution/1"
        },
        "resolutiondate": "2009-11-05T16:32:35.000+0000",
        "status": {
            "description": "A resolution has been taken, and it is awaiting verification by reporter. From here issues are either reopened, or are closed.",
            "iconUrl": "https://issues.apache.org/jira/images/icons/statuses/resolved.png",
            "id": "5",
            "name": "Resolved",
            "self": "https://issues.apache.org/jira/rest/api/2/status/5",
            "statusCategory": {
                "colorName": "green",
                "id": 3,
                "key": "done",
                "name": "Done",
                "self": "https://issues.apache.org/jira/rest/api/2/statuscategory/3"
            }
        },
        "subtasks": [],
        "summary": "Too many files open error, after no space left on device occurs; if producer carries on sending messages.",
        "timeestimate": null,
        "timeoriginalestimate": null,
        "timespent": null,
        "updated": "2009-11-12T11:31:10.000+0000",
        "versions": [{
            "archived": false,
            "description": "",
            "id": "12315620",
            "name": "5.3.0",
            "releaseDate": "2009-10-13",
            "released": true,
            "self": "https://issues.apache.org/jira/rest/api/2/version/12315620"
        }],
        "votes": {
            "hasVoted": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/AMQ-2478/votes",
            "votes": 0
        },
        "watches": {
            "isWatching": false,
            "self": "https://issues.apache.org/jira/rest/api/2/issue/AMQ-2478/watchers",
            "watchCount": 0
        },
        "workratio": -1
    },
    "id": "12481607",
    "key": "AMQ-2478",
    "self": "https://issues.apache.org/jira/rest/api/2/issue/12481607"
}